# 市场观点美化 - 指标计算逻辑文档

## 1. 数据架构概览

### 1.1 文件关系
```
市场观点美化数据源-自动更新.xlsx (主数据源)
├── 近一月指数走势 sheet ──→ 导出为 → 近1月净值走势.xlsx
├── 指标值 sheet ──────────→ 导出为 → 指标值.xlsx
├── 所有指标 sheet (Wind原始数据)
├── 股票指标 sheet (计算衍生指标)
├── 债券指标 sheet (计算衍生指标)
├── 汇率指标 sheet (计算衍生指标)
└── 商品指标 sheet (计算衍生指标)
```

### 1.2 数据流向
```
Wind API 数据
    ↓
所有指标 sheet (原始数据存储)
    ↓
各类资产指标 sheet (公式计算衍生指标)
    ↓
指标值 sheet (汇总当前值、历史统计、分位数)
    ↓
导出为独立文件供前端使用
```

---

## 2. 近一月指数走势 (近1月净值走势.xlsx)

### 2.1 数据结构
- **行数**: 约25行 (最近1个月的交易日数据)
- **列数**: 13列

### 2.2 字段说明

| 列 | 字段名 | 数据源/公式 | 说明 |
|---|---|---|---|
| A | 日期 | 无 | 交易日期 |
| B | 上证指数 | `=[1]!i_dq_close("000001.SH", 日期)` | Wind行情收盘价 |
| C | 中证转债 | `=[1]!i_dq_close("000832.CSI", 日期)` | Wind行情收盘价 |
| D | 标普500 | `=[1]!i_dq_close("SPX.GI", 日期)` | Wind行情收盘价 |
| E | 7-10年国开 | `=[1]!i_dq_close("931472.CSI", 日期)` | Wind行情收盘价 |
| F | 1-3年高信用等级债券财富 | `=[1]!i_dq_close("CBA01921.CS", 日期)` | Wind行情收盘价 |
| G | 10年期美国国债收益率 | `=[1]!i_dq_close("10yrnote.gbm", 日期)` | Wind行情收盘价 |
| H | USDCNY | `=[1]!i_dq_close("USDCNY.IB", 日期)` | Wind行情收盘价 |
| I | 沪金 | `=[1]!i_dq_close("AU.SHF", 日期)` | Wind行情收盘价 |
| J | 螺纹钢 | `=[1]!i_dq_close("RB.SHF", 日期)` | Wind行情收盘价 |
| K | 原油 | `=[1]!i_dq_close("DINIW.IPE", 日期)` | Wind行情收盘价 |
| L | 豆粕 | `=[1]!i_dq_close("M.DCE", 日期)` | Wind行情收盘价 |
| M | 锁汇成本 | 计算值 | 基于汇率和利率的计算 |

### 2.3 日期生成逻辑
- 第2行: `=TODAY()-1` (昨天)
- 第3行开始: `=WORKDAY(上一行日期, -1)` (逐日往前推工作日)

### 2.4 数据获取方式
使用Excel的Wind插件函数 `=[1]!i_dq_close(代码, 日期)` 从Wind终端获取历史行情数据。

---

## 3. 指标值 (指标值.xlsx)

### 3.1 数据结构
- **行数**: 37行 (对应37个观察指标)
- **列数**: 8列

### 3.2 字段说明

| 列 | 字段名 | 说明 |
|---|---|---|
| A | 大类资产 | 权益、债券、汇率、商品 |
| B | 子类资产 | 具体资产名称(如上证指数、10年国开) |
| C | 观察指标 | 具体指标名称(如PE、PB、收益率) |
| D | 当前值 | 最新数据值 |
| E | 最大值 | 近三年最大值 |
| F | 最小值 | 近三年最小值 |
| G | 历史中位数 | 近三年中位数 |
| H | 当前分位点 | 当前值在历史分布中的分位数(0-1) |

### 3.3 计算逻辑

#### 3.3.1 当前值 (D列)
从各类资产指标sheet中引用最新一行(第3行)的数据：
- **股票指标**: `=股票指标!B3`, `=股票指标!C3` 等
- **债券指标**: `=债券指标!B3`, `=债券指标!C3` 等
- **汇率指标**: `=汇率指标!B3`, `=汇率指标!C3` 等
- **商品指标**: `=商品指标!B3`, `=商品指标!C3` 等

#### 3.3.2 历史统计 (E/F/G列)
通过INDIRECT函数动态引用对应列的所有历史数据：
- **最大值** (E列): `=MAX(INDIRECT(J列))`
- **最小值** (F列): `=MIN(INDIRECT(J列))`
- **中位数** (G列): `=MEDIAN(INDIRECT(J列))`

其中J列存储列引用(如"股票指标!B:B")，I列存储列名(如"股票指标!B")

#### 3.3.3 当前分位点 (H列)
使用PERCENTRANK.INC函数计算当前值在历史数据中的百分位：
```excel
=PERCENTRANK.INC(INDIRECT(J列), D列)
或
=1-PERCENTRANK.INC(INDIRECT(J列), D列)  # 对于逆向指标
```

**注意**:
- 对于股债性价比等"越低越好"的指标，使用 `1-PERCENTRANK` 进行反转
- 分位点范围: 0-1，数值越大表示当前值越高/越好

---

## 4. 各类资产指标Sheet的计算逻辑

### 4.1 股票指标 Sheet

#### 4.1.1 数据结构
- **维度**: 158行 × 10列 (近3年周度数据)
- **列分组**:
  - B-D列: 上证指数 (PE, PB, 股债性价比)
  - E-G列: 中证转债 (转股溢价率, 纯债溢价率, 隐含波动率)
  - H-J列: 标普500 (PE, PB, 股债性价比)

#### 4.1.2 计算公式

##### 上证指数指标
```excel
A列 (日期):  =所有指标!A7  # 从所有指标sheet引用日期
B列 (PE):    =所有指标!M7  # 从所有指标sheet引用上证PE
C列 (PB):    =所有指标!O7  # 从所有指标sheet引用上证PB
D列 (股债性价比): =1/B7 - 所有指标!B7/100  # PE倒数 - 10年国债收益率
```

**股债性价比计算说明**:
- 公式: `盈利收益率 - 无风险利率 = (1/PE) - (10年国债收益率/100)`
- 数值越大，表示股票相对债券越有吸引力

##### 中证转债指标
```excel
E列 (转股溢价率): 固定值 (来自Wind,未使用公式)
F列 (纯债溢价率): 固定值 (来自Wind)
G列 (隐含波动率): 固定值 (来自Wind)
```

##### 标普500指标
```excel
H列 (PE):    =所有指标!N7  # 从所有指标sheet引用SP500 PE
I列 (PB):    =所有指标!P7  # 从所有指标sheet引用SP500 PB
J列 (股债性价比): =1/H7 - 所有指标!E7/100  # PE倒数 - 10年美债收益率
```

---

### 4.2 债券指标 Sheet

#### 4.2.1 数据结构
- **维度**: 158行 × 10列
- **列分组**:
  - B-D列: 10年国开 (收益率, 信用利差, 期限利差)
  - E-G列: 2年AAA信用债 (收益率, 信用利差, 期限利差)
  - H-J列: 10年美债 (收益率, 期限利差, VIX)

#### 4.2.2 计算公式

##### 10年国开指标
```excel
A列 (日期):      =所有指标!A7
B列 (收益率):    =所有指标!C7  # 中债国开债10年收益率
C列 (信用利差):  =(所有指标!C7 - 所有指标!B7) * 100  # 国开债 - 国债
D列 (期限利差):  =(所有指标!C7 - 所有指标!F7) * 100  # 10年 - 1年
```

**利差计算说明**:
- **信用利差**: 反映信用风险溢价 (国开债收益率 - 国债收益率)
- **期限利差**: 反映期限风险溢价 (长期收益率 - 短期收益率)
- 单位: 基点(bp)，乘以100转换为bp

##### 2年AAA信用债指标
```excel
E列 (收益率):    =所有指标!D7  # 2年AAA信用债收益率
F列 (信用利差):  =(所有指标!D7 - 所有指标!I7) * 100  # AAA债 - 2年国债
G列 (期限利差):  =(所有指标!D7 - 所有指标!G7) * 100  # 2年 - 1年
```

##### 10年美债指标
```excel
H列 (收益率):    =所有指标!E7  # 10年美债收益率
I列 (期限利差):  =(所有指标!E7 - 所有指标!H7) * 100  # 10年 - 1年
J列 (VIX):       =所有指标!T7  # VIX恐慌指数
```

---

### 4.3 汇率指标 Sheet

#### 4.3.1 数据结构
- **维度**: 158行 × 4列
- **列**:
  - B列: USDCNY即期汇率
  - C列: 锁汇成本
  - D列: NDF-即期汇率(预期贬值幅度)

#### 4.3.2 计算公式

```excel
A列 (日期):     =所有指标!A7
B列 (即期汇率): =所有指标!U7  # USDCNY即期汇率
C列 (锁汇成本): =所有指标!H7/100 - 所有指标!B7/100 + 所有指标!U7
                # 美国1年期利率 - 中国1年期利率 + 即期汇率
D列 (预期贬值): =所有指标!V7 - 所有指标!U7  # 1年期NDF - 即期汇率
```

**锁汇成本说明**:
- 基于利率平价理论计算远期汇率
- 公式: `远期汇率 ≈ 即期汇率 + (外币利率 - 本币利率)`
- 用于判断当前锁汇是否划算

---

### 4.4 商品指标 Sheet

#### 4.4.1 数据结构
- **维度**: 158行 × 8列
- **列分组**:
  - B-C列: 沪金 (价格, 同比)
  - D-E列: 螺纹钢 (价格, 同比)
  - F-G列: 原油 (价格, 同比)
  - H-I列: 豆粕 (价格, 同比)

#### 4.4.2 计算公式

```excel
A列 (日期):        =所有指标!A7
B列 (沪金价格):    =所有指标!L7
C列 (沪金同比):    =所有指标!Q7
D列 (螺纹钢价格):  =所有指标!W7
E列 (螺纹钢同比):  =所有指标!X7
F列 (原油价格):    =所有指标!Y7
G列 (原油同比):    =所有指标!Z7
H列 (豆粕价格):    =所有指标!AA7
I列 (豆粕同比):    =所有指标!AB7
```

**同比计算说明**:
- 同比 = (当前价格 - 去年同期价格) / 去年同期价格
- 数据已在Wind端计算完成，直接引用

---

## 5. 所有指标 Sheet (Wind原始数据存储)

### 5.1 数据结构
- **维度**: 163行 × 34列
- **数据频率**: 周度数据
- **时间范围**: 近3年

### 5.2 列映射关系

| 列 | 指标ID | 指标名称 | Wind代码 |
|---|---|---|---|
| A | - | 日期 | - |
| B | s1 | 中债国债10年收益率 | - |
| C | s2 | 中债国开债10年收益率 | - |
| D | s3 | 中债AAA 2年收益率 | - |
| E | s4 | 美国10年国债收益率 | - |
| F | s7 | 中债国开债1年收益率 | - |
| G | s5 | 中债AAA 1年收益率 | - |
| H | s6 | 美国1年国债收益率 | - |
| I | s8 | 中债国债2年收益率 | - |
| J | s9 | 美国10年实际收益率 | - |
| K | s10 | 中国粗钢日均产量 | - |
| L | - | 沪金价格 | - |
| M | - | 上证指数PE | - |
| N | - | 标普500 PE | - |
| O | - | 上证指数PB | - |
| P | - | 标普500 PB | - |
| Q | - | 转股溢价率 | - |
| R | - | 平价溢价率 | - |
| S | - | 纯债溢价率 | - |
| T | - | VIX指数 | - |
| U | - | USDCNY即期汇率 | - |
| V | - | USDCNY 1年期NDF | - |
| W | - | 螺纹钢价格 | - |
| X | - | 螺纹钢同比 | - |
| Y | - | 原油价格 | - |
| Z | - | 原油同比 | - |
| AA | - | 豆粕价格 | - |
| AB | - | 豆粕同比 | - |

### 5.3 数据获取方式
- 第1行包含特殊函数: `=[1]!edb()` (Wind Excel插件的数据批量下载函数)
- 第7行开始为实际数据行
- 数据通过Wind Excel插件自动更新

---

## 6. 关键计算指标详解

### 6.1 估值指标

#### PE (市盈率)
- **来源**: Wind直接提供
- **含义**: 股价 / 每股收益
- **分位数**: 越高表示估值越贵

#### PB (市净率)
- **来源**: Wind直接提供
- **含义**: 股价 / 每股净资产
- **分位数**: 越高表示估值越贵

#### 股债性价比
- **公式**: `(1/PE) - (10年国债收益率/100)`
- **含义**: 股票盈利收益率与无风险利率的差值
- **分位数**: 越高表示股票相对债券越有吸引力
- **注意**: 指标值sheet中使用 `1-PERCENTRANK` 反转，使数值越大表示越好

### 6.2 债券指标

#### 收益率
- **来源**: Wind中债收益率曲线
- **分位数**: 越高表示债券越便宜/未来预期回报越高

#### 信用利差
- **公式**: `(信用债收益率 - 国债收益率) × 100`
- **单位**: 基点(bp)
- **含义**: 投资者要求的信用风险补偿
- **分位数**: 越高表示信用风险溢价越高，信用债相对更便宜

#### 期限利差
- **公式**: `(长期收益率 - 短期收益率) × 100`
- **单位**: 基点(bp)
- **含义**: 投资者要求的期限风险补偿
- **分位数**: 越高表示收益率曲线越陡峭，经济预期越好

### 6.3 转债指标

#### 转股溢价率
- **来源**: Wind直接提供
- **含义**: (转债价格 - 转股价值) / 转股价值
- **分位数**: 越高表示转债相对正股越贵

#### 纯债溢价率
- **来源**: Wind直接提供
- **含义**: (转债价格 - 纯债价值) / 纯债价值
- **分位数**: 越高表示转债的债券底部保护越弱

#### 隐含波动率
- **来源**: Wind直接提供
- **含义**: 从转债价格反推出的隐含波动率
- **分位数**: 越高表示市场预期波动越大

### 6.4 汇率指标

#### 即期汇率
- **来源**: Wind USDCNY汇率
- **分位数**: 越高表示人民币越贬值

#### 锁汇成本
- **公式**: `美国1年期利率 - 中国1年期利率 + 即期汇率`
- **含义**: 基于利率平价的远期汇率估计
- **用途**: 判断锁汇是否划算

#### NDF-即期汇率差
- **公式**: `1年期NDF - 即期汇率`
- **含义**: 市场预期的人民币贬值幅度
- **分位数**: 越高表示市场预期贬值越多

### 6.5 商品指标

#### 价格
- **来源**: Wind商品期货价格
- **分位数**: 越高表示商品越贵

#### 同比
- **来源**: Wind计算
- **公式**: `(当前价格 - 去年同期价格) / 去年同期价格`
- **分位数**: 越高表示价格涨幅越大

---

## 7. Python实现所需的Wind API

### 7.1 Wind Python API (WindPy)

#### 安装
```bash
pip install WindPy
```

#### 主要函数

##### 7.1.1 获取历史行情数据
```python
from WindPy import w

# 初始化
w.start()

# 获取单个指数的历史收盘价
data = w.wsd(
    codes="000001.SH",           # Wind代码
    fields="close",              # 字段: 收盘价
    beginTime="2025-12-01",      # 开始日期
    endTime="2026-01-22",        # 结束日期
    options="Period=D"           # 选项: 日频数据
)

# 返回格式
# data.Data: 二维列表 [[价格1, 价格2, ...]]
# data.Times: 日期列表 [datetime1, datetime2, ...]
# data.Codes: 代码列表 ['000001.SH']
# data.Fields: 字段列表 ['CLOSE']
```

##### 7.1.2 批量获取多个指标
```python
# 获取多个指数的多个字段
data = w.wsd(
    codes="000001.SH,000832.CSI,SPX.GI",  # 多个代码用逗号分隔
    fields="close,pe_ttm,pb_lf",          # 多个字段
    beginTime="2025-12-01",
    endTime="2026-01-22",
    options="Period=D"
)
```

##### 7.1.3 获取经济数据库(EDB)指标
```python
# 获取宏观经济指标
data = w.edb(
    codes="M0017142,M0017143",   # EDB指标代码
    beginTime="2025-12-01",
    endTime="2026-01-22",
    options="Fill=Previous"       # 缺失值处理
)
```

### 7.2 所需的Wind代码清单

#### 7.2.1 指数行情代码
```python
EQUITY_CODES = {
    "上证指数": "000001.SH",
    "中证转债": "000832.CSI",
    "标普500": "SPX.GI"
}

BOND_CODES = {
    "7-10年国开": "931472.CSI",
    "1-3年高信用等级债券财富": "CBA01921.CS",
    "10年期美国国债收益率": "10yrnote.gbm"
}

FX_CODES = {
    "USDCNY": "USDCNY.IB"
}

COMMODITY_CODES = {
    "沪金": "AU.SHF",
    "螺纹钢": "RB.SHF",
    "原油": "DINIW.IPE",
    "豆粕": "M.DCE"
}
```

#### 7.2.2 估值指标代码
```python
VALUATION_FIELDS = {
    "PE": "pe_ttm",      # 市盈率TTM
    "PB": "pb_lf",       # 市净率
}
```

#### 7.2.3 债券收益率代码(EDB经济数据库)
```python
# 这些需要使用 w.edb() 函数获取
BOND_YIELD_CODES = {
    "中债国债10年": "M1004263",  # 示例EDB代码,需替换为实际代码
    "中债国开债10年": "M1004264",
    "中债国开债1年": "M1004265",
    "中债AAA 2年": "M1004266",
    "中债AAA 1年": "M1004267",
    "中债国债2年": "M1004268",
    "美国10年国债": "G0000886",
    "美国1年国债": "G0000887",
    "美国10年实际收益率": "G0000888"
}
```

#### 7.2.4 其他指标代码
```python
OTHER_CODES = {
    "VIX指数": "VIX.GI",
    "USDCNY 1年期NDF": "USDCNYNDF1Y.IB",  # 需确认实际代码
    "中证转债转股溢价率": "000832.CSI的衍生指标",
    "中证转债纯债溢价率": "000832.CSI的衍生指标",
    "中证转债隐含波动率": "000832.CSI的衍生指标"
}
```

---

## 8. 数据更新频率

### 8.1 近一月指数走势
- **更新频率**: 每日
- **数据范围**: 最近1个月(约20-25个交易日)
- **更新时机**: 每日收盘后

### 8.2 指标值
- **更新频率**: 每周
- **数据范围**: 最新值 + 近3年历史数据
- **更新时机**: 每周末

### 8.3 所有指标 (原始数据)
- **更新频率**: 每周
- **数据范围**: 近3年周度数据
- **数据行数**: 约156行 (3年 × 52周)

---

## 9. 注意事项

### 9.1 Excel公式特性
1. **INDIRECT函数**: 动态引用单元格，用于灵活引用不同列的历史数据
2. **ArrayFormula**: Wind插件使用数组公式批量填充数据
3. **WORKDAY函数**: 自动跳过周末和节假日计算交易日

### 9.2 Wind Excel插件
1. **[1]!edb()**: Wind经济数据库批量下载函数
2. **[1]!i_dq_close()**: Wind行情数据获取函数
3. 需要Wind终端登录才能刷新数据

### 9.3 数据质量
1. 中证转债的转股溢价率、纯债溢价率、隐含波动率在股票指标sheet中为固定值
2. 部分商品同比数据直接从Wind获取，无需手动计算
3. 锁汇成本基于利率平价理论估算，与实际远期汇率可能有偏差

### 9.4 分位数计算
1. 使用 `PERCENTRANK.INC` 而非 `PERCENTRANK.EXC`
2. 对于"越低越好"的指标(如股债性价比)，使用 `1-PERCENTRANK` 反转
3. 分位数基于近3年历史数据计算

---

## 10. 文件导出逻辑

### 10.1 导出流程
1. **数据源文件**: 市场观点美化数据源-自动更新.xlsx (包含所有sheet和公式)
2. **导出sheet**:
   - "近一月指数走势" → 另存为 → 近1月净值走势.xlsx
   - "指标值" → 另存为 → 指标值.xlsx
3. **导出方式**: 复制数值(不复制公式)，作为独立文件供前端使用

### 10.2 导出目的
- 减小文件体积(不包含公式和其他sheet)
- 避免前端读取时加载Wind插件
- 提供纯数据文件便于JSON转换

---

## 附录: Wind代码对照表

### A.1 指数代码
| 资产名称 | Wind代码 | 市场 |
|---|---|---|
| 上证指数 | 000001.SH | 上海证券交易所 |
| 中证转债 | 000832.CSI | 中证指数 |
| 标普500 | SPX.GI | 全球指数 |
| 7-10年国开债 | 931472.CSI | 中证指数 |
| 1-3年高信用债 | CBA01921.CS | 中债指数 |
| 10年美债收益率 | 10yrnote.gbm | 全球债券 |
| USDCNY | USDCNY.IB | 银行间市场 |
| 沪金 | AU.SHF | 上海期货交易所 |
| 螺纹钢 | RB.SHF | 上海期货交易所 |
| 布伦特原油 | DINIW.IPE | 洲际交易所 |
| 豆粕 | M.DCE | 大连商品交易所 |
| VIX指数 | VIX.GI | 全球指数 |

### A.2 后缀说明
- `.SH`: 上海证券交易所
- `.CSI`: 中证指数
- `.GI`: Global Index (全球指数)
- `.CS`: 中债指数
- `.gbm`: Global Bond Market
- `.IB`: Interbank (银行间市场)
- `.SHF`: 上海期货交易所
- `.IPE`: 洲际交易所
- `.DCE`: 大连商品交易所

---

## 结语

本文档详细说明了市场观点美化项目中两个核心Excel文件的数据结构和计算逻辑。所有指标都基于Wind终端数据，通过Excel公式进行衍生计算。在Python实现时，需要使用WindPy库获取原始数据，并按照本文档中的公式进行计算。
