# Wind数据生成程序使用说明

## 程序特点

### ✅ 完全基于真实Excel公式
- 所有计算公式直接从Excel公式详细映射表转译
- 锁汇成本：`-掉期点/10000/离岸人民币汇率`
- 股债性价比：`1/PE - 国债收益率/100`
- 信用利差：`(信用债-国债)*100`
- 沪金内外盘价差：`沪金 - COMEX×汇率/31.1035`

### ✅ 无模拟数据
- 必须连接Wind终端才能运行
- 所有数据都从Wind实时获取
- 自动检查Wind连接状态

## 快速开始

### 1. 环境准备

```bash
# 安装依赖
pip install pandas numpy openpyxl WindPy

# 确保Wind终端已登录
# 在Wind终端中检查数据权限
```

### 2. 运行程序

```bash
cd /Users/fanshengxia/Desktop/市场观点美化
python generate_tables_from_wind.py
```

### 3. 预期输出

```
================================================================================
市场观点美化 - Wind数据生成程序 v2.0
================================================================================

[1/6] 初始化Wind连接...
✓ Wind连接成功

[2/6] 生成近1月净值走势...
  获取 13 个资产的日度数据...
  ✓ 获取成功: 21 个交易日
✓ 已生成: .../近1月净值走势.xlsx
  - 交易日数: 21
  - 资产数: 12

[3/6] 获取周度数据...
  获取估值数据（PE、PB）...
  ✓ 获取成功
  获取 9 个EDB指标...
  ✓ 获取成功: 156 条记录
  获取 15 个资产的周度数据...
  ✓ 获取成功: 156 周

[4/6] 计算衍生指标...

[5/6] 计算指标统计值和分位数...
✓ 已生成: .../指标值.xlsx
  - 指标数: 31

================================================================================
✓ 所有文件生成完成!
================================================================================

输出目录: /Users/fanshengxia/Desktop/市场观点美化/asset-analysis-real-data
  1. 近1月净值走势.xlsx
  2. 指标值.xlsx

[6/6] 关闭Wind连接...
✓ Wind连接已关闭
```

## 生成的文件

### 1. 近1月净值走势.xlsx

**包含列:**
| 列名 | Wind代码 | 说明 |
|---|---|---|
| 日期 | - | 交易日期 |
| 上证指数 | 000001.SH | 收盘价 |
| 中证转债 | 000832.CSI | 收盘价 |
| 标普500 | SPX.GI | 收盘价 |
| 7-10年国开 | 931472.CSI | 指数 |
| 1-3年高信用等级债券财富 | CBA01921.CS | 指数 |
| 10年期美国国债收益率 | 10yrnote.gbm | 收益率(%) |
| USDCNY | USDCNY.IB | 中间价 |
| 沪金 | AU.SHF | 主连价格 |
| 螺纹钢 | RB.SHF | 主连价格 |
| 原油 | SC.INE | 主连价格 |
| 豆粕 | M.DCE | 主连价格 |
| 锁汇成本 | 计算值 | -掉期点/10000/CNH |

**特点:**
- 自动获取最近30天的交易日数据
- 锁汇成本实时计算
- 格式美化：表头颜色、边框、冻结首行

### 2. 指标值.xlsx

**包含列:**
| 列名 | 说明 |
|---|---|
| 大类资产 | 权益/债券/汇率/商品 |
| 子类资产 | 具体资产名称 |
| 观察指标（近三年） | 指标名称 |
| 当前值 | 最新一期数据 |
| 最大值 | 近3年最大值 |
| 最小值 | 近3年最小值 |
| 历史中位数 | 近3年中位数 |
| 当前分位点 | 百分位数(0-1) |

**指标数量:** 约31-37个（取决于数据可用性）

**指标分类:**
- **权益类(6个):** 上证/标普的PE、PB、股债性价比
- **债券类(9个):** 三类债券的收益率、信用利差、期限利差
- **汇率类(6个):** 锁汇成本、掉期点、CNH、中间价、中美利差、美元指数
- **商品类(10-16个):** 沪金、螺纹钢、原油、豆粕的相关指标

## Wind代码清单

### 必需的EDB代码

⚠️ **重要:** 以下EDB代码为示例，需要在Wind终端中查询实际代码后替换

```python
EDB_CODES = {
    "M0017142": "中债国债10年",  # 需要替换为实际代码
    "M0017143": "中债国开债10年",
    "M0017144": "中债AAA 2年",
    "M0017145": "美国10年国债",
    "M0017146": "中债国开债1年",
    "M0017147": "中债AAA 1年",
    "M0017148": "美国1年国债",
    "M0017149": "中债国债2年",
    "M0017150": "美国10年实际收益率",
}
```

### 查询EDB代码的方法

**方法1：Wind Excel插件**
```excel
=EDB("中债国债到期收益率:10年", "2023-01-01", "2026-01-22")
```
在函数帮助中可以看到实际的EDB代码

**方法2：Wind终端**
1. 打开Wind终端
2. 搜索"中债国债10年收益率"
3. 查看指标代码

**方法3：Wind Python API**
```python
from WindPy import w
w.start()

# 搜索EDB代码
data = w.edb("M0017142", "2023-01-01", "2026-01-22")
print(data.Codes)  # 显示实际代码
```

## 配置修改

### 修改日期范围

```python
# 在程序中修改这两行
START_DATE_DAILY = END_DATE - timedelta(days=30)  # 改为60获取2个月
START_DATE_WEEKLY = END_DATE - timedelta(days=365 * 3)  # 改为365*5获取5年
```

### 添加新资产

在程序开头的`WIND_CODES`字典中添加：

```python
WIND_CODES = {
    "daily": {
        "000001.SH": "上证指数",
        # 添加新资产
        "000300.SH": "沪深300",
        ...
    }
}
```

### 修改输出路径

```python
OUTPUT_DIR = "/Users/fanshengxia/Desktop/市场观点美化/asset-analysis-real-data"
```

## 常见问题

### 1. Wind连接失败

**错误信息:**
```
❌ 错误: Wind未连接，请确保Wind终端已登录
```

**解决方法:**
1. 打开Wind终端
2. 输入用户名密码登录
3. 等待完全加载完成（右下角显示"连接成功"）
4. 重新运行程序

### 2. EDB代码错误

**错误信息:**
```
⚠️ 警告: Wind EDB返回错误码 40520001
```

**解决方法:**
1. 检查EDB代码是否正确
2. 确认账号有EDB数据权限
3. 在Wind终端中手动测试代码
4. 替换为正确的代码后重新运行

### 3. 某些指标缺失

**原因:**
- 部分Wind代码可能需要特定权限
- 某些商品指标需要额外的数据源
- 转债指标在原Excel中为手动输入

**解决方法:**
- 检查数据权限
- 联系Wind客服开通权限
- 手动补充缺失数据

### 4. 数据异常或NaN值过多

**检查项:**
1. 日期范围是否合理（避免节假日、停牌期）
2. Wind代码是否正确
3. 数据频率是否匹配（日度vs周度）
4. 是否有数据延迟

**调试代码:**
```python
# 在fetch函数后添加
print(f"数据形状: {df.shape}")
print(f"缺失值: {df.isnull().sum().sum()}")
print(df.head())
```

## 数据质量说明

### ✅ 高质量数据（Wind直接提供）
- 股票指数价格
- PE、PB估值
- 债券收益率
- 外汇汇率
- 商品期货价格
- VIX指数

### ⚠️ 计算数据（需验证）
- 股债性价比（公式计算）
- 各类利差（公式计算）
- 锁汇成本（公式计算）
- 沪金内外盘价差（公式计算）

### ❌ 缺失数据（需手动补充）
- 中证转债转股溢价率（Wind有但需特殊字段）
- 中证转债纯债溢价率
- 中证转债隐含波动率
- 豆粕现货价格（可能需要额外数据源）

## 完整性检查清单

运行程序后，检查以下项：

- [ ] 近1月净值走势包含所有12列
- [ ] 日度数据无大量缺失（缺失<10%）
- [ ] 锁汇成本计算正常（数值合理）
- [ ] 指标值包含30+个指标
- [ ] PE、PB数据完整
- [ ] 债券收益率数据完整
- [ ] 所有分位数在0-1之间
- [ ] Excel格式美观（表头、边框、列宽）

## 后续改进建议

### 1. 添加数据验证
```python
def validate_data(df, name):
    """验证数据质量"""
    missing_pct = df.isnull().sum().sum() / (df.shape[0] * df.shape[1])
    if missing_pct > 0.2:
        print(f"⚠️ 警告: {name} 缺失值超过20%")
    return missing_pct < 0.5
```

### 2. 添加日志记录
```python
import logging
logging.basicConfig(
    filename='wind_data.log',
    level=logging.INFO,
    format='%(asctime)s - %(message)s'
)
```

### 3. 添加缓存机制
```python
# 避免重复获取相同数据
import pickle
from pathlib import Path

cache_dir = Path("cache")
cache_file = cache_dir / f"data_{date}.pkl"
```

### 4. 添加邮件通知
```python
# 数据生成完成后发送邮件
import smtplib
from email.mime.text import MIMEText

def send_notification(success=True):
    msg = MIMEText("数据生成完成" if success else "数据生成失败")
    # ... SMTP配置
```

## 技术支持

### Wind API文档
- https://www.wind.com.cn/API/Python.html

### 常用Wind函数
- `w.wsd()`: 获取日/周/月度序列数据
- `w.wss()`: 获取截面数据
- `w.edb()`: 获取经济数据库指标
- `w.wsi()`: 获取分钟级数据

### 联系方式
- Wind客服: 400-820-9463
- 项目GitHub: https://github.com/yourusername/project

---

**版本:** v2.0
**更新日期:** 2026-01-22
**状态:** 生产就绪
