# 基金分类系统 v1.1.0 升级指南

## 版本信息
- **当前版本**: v1.1.0
- **发布日期**: 2026-01-13
- **主要更新**: 修复基金匹配逻辑，适配最新持仓数据格式

## 升级原因

如果您在使用最新的持仓表时遇到以下问题，说明需要升级：
- ✗ 已分类的基金仍然提示需要重新分类
- ✗ 基金名称发生变化后无法识别
- ✗ 新的资产小类（如"混合债券型二级基金"、"偏股混合型基金"等）无法自动识别

## 升级步骤

### 方法一：清空浏览器数据（推荐 - 最简单）

**适用场景**: 您没有添加自定义基金，或者愿意重新添加

1. 打开修改后的 `fund_analysis.html`
2. 点击"数据管理"区域的 **"🔄 恢复默认"** 按钮
3. 确认恢复操作
4. 重新上传最新的持仓表进行测试

**优点**: 操作简单，一键完成
**缺点**: 会丢失您之前添加的自定义基金分类

---

### 方法二：导入更新后的数据库（推荐 - 保留兼容）

**适用场景**: 您添加了自定义基金，但愿意手动重新添加

1. 打开修改后的 `fund_analysis.html`
2. 点击"数据管理"区域的 **"📥 导入基金分类"** 按钮
3. 选择文件: `基金分类数据_v1.1.0_updated.json`
4. 确认导入操作（这会替换当前所有分类数据）
5. 重新上传最新的持仓表进行测试

**优点**: 使用官方更新的数据库，确保兼容性
**缺点**: 会丢失您之前添加的自定义基金分类

---

### 方法三：手动迁移现有数据（高级 - 保留自定义）

**适用场景**: 您添加了很多自定义基金，希望保留它们

#### 步骤 1: 导出现有数据
1. 打开**旧版** `fund_analysis.html`
2. 点击 **"📤 导出基金分类"** 按钮
3. 保存导出的 JSON 文件（例如: `my_custom_funds.json`）

#### 步骤 2: 手动更新匹配键
使用文本编辑器打开导出的 JSON 文件，根据以下规则更新基金的键：

**公募基金**（新版资产大类 = "公募基金"）:
- 旧键格式: `"易方达稳健收益B（110008.OF）"`
- 新键格式: `"110008.OF"` （使用外部代码）

**委外投资**（新版资产大类 = "委外投资"）:
- 旧键格式: `"景顺长城鼎安1号集合资产管理计划"`
- 新键格式: `"80PF210158"` （使用资产代码）

**其他资产**:
- 保持原样（继续使用资产简称）

**示例转换**:
```json
// 修改前
{
  "fundClassifications": {
    "易方达稳健收益B（110008.OF）": {
      "assetClass": "二级公募债券基金",
      "style": "均衡",
      "equityPosition": 20
    }
  }
}

// 修改后
{
  "fundClassifications": {
    "110008.OF": {
      "assetClass": "二级公募债券基金",
      "style": "均衡",
      "equityPosition": 20
    }
  }
}
```

#### 步骤 3: 合并数据
1. 打开 `基金分类数据_v1.1.0_updated.json`
2. 将您修改后的自定义基金添加到 `fundClassifications` 对象中
3. 更新 `totalFunds` 数量
4. 保存文件

#### 步骤 4: 导入合并后的数据
1. 打开修改后的 `fund_analysis.html`
2. 点击 **"📥 导入基金分类"** 按钮
3. 选择合并后的 JSON 文件
4. 确认导入

---

## 如何查找外部代码和资产代码

如果您不确定某个基金的外部代码或资产代码，可以：

1. 打开最新的持仓 Excel 文件
2. 找到对应的基金行
3. 查看以下列：
   - **公募基金**: 查看"外部代码"列（格式如: `110008.OF`, `515100.SH`）
   - **委外投资**: 查看"资产代码"列（格式如: `80PF210158`, `11PF252802`）

## 验证升级成功

升级完成后，请进行以下测试：

1. ✓ 上传最新的持仓表 `持仓盈亏明细列表_1765074404831.xlsx`
2. ✓ 检查之前提示"未分类"的基金（如"易方达稳健收益B"、"景顺长城中证红利低波动100"）是否现在能正确识别
3. ✓ 验证权益暴露计算结果是否准确
4. ✓ 确认新的资产小类（如"混合债券型二级基金"）能被正确识别

## 新功能和改进

### 1. 智能匹配键选择
系统现在会根据资产类型自动选择最佳匹配键：
- 公募基金 → 使用外部代码
- 委外投资 → 使用资产代码
- 其他资产 → 使用资产简称

### 2. 扩展资产小类支持
新增支持以下资产小类：
- 混合债券型二级基金（默认权益仓位: 20%）
- 普通股票型基金（默认权益仓位: 100%）
- 偏股混合型基金（默认权益仓位: 80%）
- 灵活配置型基金（默认权益仓位: 80%）
- 被动指数型基金（默认权益仓位: 100%）
- 国际(QDII)被动指数型股票基金（默认权益仓位: 100%）

### 3. 改进的基金检测
未分类基金检测功能现在能：
- 准确识别使用新分类体系的基金
- 自动提供默认权益仓位建议
- 支持批量添加功能

## 常见问题

### Q: 升级后为什么我之前添加的自定义基金消失了？
**A**: 如果使用"恢复默认"或"导入基金分类"功能，会替换所有现有数据。请使用"方法三：手动迁移现有数据"来保留自定义基金。

### Q: 如何知道某个基金应该用什么作为匹配键？
**A**: 查看持仓 Excel 文件中的"新版资产大类"列：
- 如果是"公募基金" → 使用"外部代码"列的值
- 如果是"委外投资" → 使用"资产代码"列的值
- 其他情况 → 使用"资产简称"列的值

### Q: 升级后系统会自动转换旧的localStorage数据吗？
**A**: 不会。系统需要手动升级（使用上述三种方法之一）。旧数据会继续存在，但可能无法正确匹配新格式的持仓数据。

### Q: 我可以同时使用新旧两个版本的持仓表吗？
**A**: 可以。新的匹配逻辑向后兼容，对于找不到外部代码的基金会自动降级使用资产简称匹配。

## 技术支持

如果在升级过程中遇到问题，请：
1. 查看浏览器控制台（F12）的错误信息
2. 检查导入的 JSON 文件格式是否正确
3. 参考 `修改说明.md` 了解详细的技术变更

## 回滚方案

如果升级后出现问题，可以：
1. 恢复旧版的 `fund_analysis.html` 文件
2. 使用之前导出的 JSON 文件恢复数据
3. 清除浏览器 localStorage 后重新开始

**localStorage 清除方法**:
1. 打开浏览器开发者工具（F12）
2. 进入 Application/存储 标签
3. 展开 Local Storage
4. 找到对应网站的条目
5. 删除 `fund_classifications_data` 键
