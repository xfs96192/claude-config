# 基金分类系统修改说明

## 修改日期
2026-01-13

## 问题描述

用户使用最新的持仓表(`持仓盈亏明细列表_1765074404831.xlsx`)时，发现很多已经分类好的基金仍然提示需要重新分类，而使用历史持仓表(`持仓盈亏明细列表_1768184986461.xlsx`)则没有问题。

## 问题根源分析

经过详细分析，发现了两个主要问题：

### 1. 资产小类分类体系变化
最新的Excel文件使用了更细化的资产小类分类：
- 原来的"二级公募债券基金" → 现在的"混合债券型二级基金"
- 原来的"公募股票基金" → 现在的"被动指数型基金"、"普通股票型基金"等
- 原来的"一级公募债券基金" → 现在的"短期纯债型基金"、"中长期纯债型基金"等

### 2. 基金名称匹配方式不准确
原系统使用`资产简称`作为匹配键，但这存在问题：
- **公募基金**：Excel中的资产简称是完整名称（如"易方达稳健收益B（110008.OF）"），但实际应该用**外部代码**（如"110008.OF"）来匹配更准确
- **委外投资**：应该使用**资产代码**（如"80PF210158"）而不是资产简称来匹配

## 解决方案

### 1. 新增智能匹配键函数
创建了`getFundMatchKey(row)`函数，根据资产类型自动选择合适的匹配键：

```javascript
function getFundMatchKey(row) {
    const assetClass = normalizeText(row['新版资产大类']);
    const externalCode = normalizeText(row['外部代码']);
    const assetCode = normalizeText(row['资产代码']);
    const assetName = normalizeText(row['资产简称']);

    // 对于公募基金,优先使用外部代码
    if (assetClass === '公募基金' && externalCode) {
        return externalCode;
    }

    // 对于委外投资,使用资产代码
    if (assetClass === '委外投资' && assetCode) {
        return assetCode;
    }

    // 其他情况使用资产简称
    return assetName;
}
```

### 2. 更新资产小类识别规则
扩展了`FUND_EQUITY_SUBCLASS_RULES`，新增支持的资产小类：

```javascript
const FUND_EQUITY_SUBCLASS_RULES = {
    '二级公募债券基金': { defaultEquity: 20 },
    '混合债券型二级基金': { defaultEquity: 20 },      // 新增
    '公募股票基金': { defaultEquity: 100 },
    '普通股票型基金': { defaultEquity: 100 },          // 新增
    '公募混合基金': { defaultEquity: 100 },
    '偏股混合型基金': { defaultEquity: 80 },           // 新增
    '灵活配置型基金': { defaultEquity: 80 },           // 新增
    '其他公募基金': { defaultEquity: 100 },
    '被动指数型基金': { defaultEquity: 100 },          // 新增
    '国际(QDII)被动指数型股票基金': { defaultEquity: 100 }  // 新增
};
```

### 3. 更新基金分类数据库
将所有已分类基金的键从`资产简称`改为对应的`外部代码`或`资产代码`：

**示例更新：**
- ~~"易方达稳健收益B（110008.OF）"~~ → **"110008.OF"**
- ~~"景顺长城中证红利低波动100交易型开放式指数证券投资基金"~~ → **"515100.SH"**
- ~~"景顺长城鼎安1号集合资产管理计划"~~ → **"80PF210158"**

共更新了66个基金的分类键。

### 4. 修改未分类基金检测和添加逻辑
- 在检测未分类基金时，使用新的匹配键逻辑
- 在添加新基金时，保存匹配键（`matchKey`）而不是资产简称
- 在批量添加功能中同样使用匹配键

## 修改的代码文件

- `fund_analysis.html` - 主应用文件

## 修改的关键函数

1. **getFundMatchKey(row)** - 新增函数，智能选择匹配键
2. **processData()** - 修改使用新的匹配键逻辑
3. **calculateDetailData()** - 修改使用新的匹配键逻辑
4. **addSingleUnclassifiedFund(index)** - 修改使用matchKey保存
5. **batchAddUnclassifiedFunds()** - 修改使用matchKey保存

## 测试建议

1. 使用最新的持仓表`持仓盈亏明细列表_1765074404831.xlsx`测试
2. 确认已分类的基金不再显示为未分类
3. 确认新检测到的基金能正确添加
4. 确认权益暴露计算结果准确

## 兼容性说明

- 对于在最新持仓表中找不到的历史基金（如"华泰柏瑞红利ETF ( 510880.SH )"等），保持使用资产简称作为键
- 系统会自动处理新旧数据格式的兼容

## 注意事项

⚠️ **重要：** 如果用户之前已经在浏览器LocalStorage中保存了基金分类数据，建议：
1. 先导出现有的基金分类数据
2. 清除浏览器缓存或使用"恢复默认"功能
3. 重新加载页面，让新的默认分类生效
4. 根据需要重新添加自定义基金

或者用户可以手动使用"导入基金分类"功能，导入更新后的分类数据。
