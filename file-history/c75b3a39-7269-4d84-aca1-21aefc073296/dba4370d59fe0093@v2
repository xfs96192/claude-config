<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘åˆ†ç±»æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ</title>
    <script src="xlsx.full.min.js"></script>
    <script src="chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #5a67d8;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #5a67d8;
            background: #e6f3ff;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #5a67d8;
        }

        .fund-settings {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-top: 20px;
        }

        .fund-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .fund-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 60px;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            align-items: center;
        }

        .fund-item:hover {
            background: #f8f9ff;
        }

        .fund-item input,
        .fund-item select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .fund-item input:focus,
        .fund-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-fund-form {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .product-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .style-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .style-item:last-child {
            border-bottom: none;
        }

        .style-name {
            font-weight: 600;
            color: #374151;
        }

        .style-amount {
            color: #667eea;
            font-weight: 600;
        }

        .style-percentage {
            color: #16a34a;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: 700;
        }

        .matrix-section {
            margin-top: 30px;
        }

        .matrix-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-section {
            flex: 1;
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .filter-section h4 {
            margin-bottom: 10px;
            color: #374151;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .filter-btn:hover {
            background: #5a67d8;
        }

        .filter-btn.secondary {
            background: #6b7280;
        }

        .filter-btn.secondary:hover {
            background: #4b5563;
        }

        .filter-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-checkbox input {
            margin: 0;
        }

        .filter-checkbox label {
            font-size: 0.9em;
            color: #374151;
            cursor: pointer;
        }

        .toggle-section {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .toggle-section h4 {
            margin-bottom: 10px;
            color: #374151;
        }

        .toggle-buttons {
            display: flex;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #d1d5db;
        }

        .toggle-btn {
            flex: 1;
            padding: 8px 16px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .matrix-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
        }

        .matrix-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .matrix-table tr:hover {
            background: #f8f9ff;
        }

        .matrix-table .product-name {
            background: #f8f9ff;
            font-weight: 600;
            color: #374151;
            text-align: left;
            padding-left: 15px;
        }

        .matrix-table .amount-cell {
            color: #667eea;
            font-weight: 600;
        }

        .matrix-table .percentage-cell {
            color: #16a34a;
            font-weight: 600;
        }

        .matrix-table .zero-cell {
            color: #9ca3af;
            font-style: italic;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .error {
            color: #ef4444;
            background: #fef2f2;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .success {
            color: #16a34a;
            background: #f0fdf4;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .fund-settings {
                grid-template-columns: 1fr;
            }

            .fund-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        /* æœªåˆ†ç±»åŸºé‡‘æ ·å¼ */
        .unclassified-funds-container {
            background: #fff8f0;
            border: 2px solid #ff6b35;
            border-radius: 12px;
            padding: 20px;
        }

        .unclassified-fund-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 80px;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            align-items: center;
        }

        .unclassified-fund-item:hover {
            background: #f8f9ff;
            border-color: #667eea;
        }

        .unclassified-fund-item .fund-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .unclassified-fund-item .asset-type {
            background: #ff6b35;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            text-align: center;
        }

        .unclassified-fund-item select,
        .unclassified-fund-item input {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .unclassified-fund-item select:focus,
        .unclassified-fund-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .unclassified-fund-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 80px;
            gap: 15px;
            padding: 10px 15px;
            background: #f8f9ff;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #667eea;
            font-size: 0.9em;
        }

        .batch-add-individual {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .batch-add-individual:hover {
            background: #059669;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>åŸºé‡‘åˆ†ç±»æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ æŒä»“æ˜ç»†è¡¨ï¼Œè‡ªåŠ¨è®¡ç®—å„äº§å“ä¸åŒé£æ ¼çš„æƒç›Šæš´éœ²å æ¯”</p>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“ ä¸Šä¼ æŒä»“æ˜ç»†è¡¨</h2>
            <div class="upload-area" id="uploadArea">
                <p style="font-size: 1.2em; margin-bottom: 15px;">ğŸ“Š æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šä¼ </p>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
                <p style="margin-top: 10px; color: #666; font-size: 0.9em;">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
            </div>
            <div class="loading" id="loading">
                <p>ğŸ“Š æ­£åœ¨å¤„ç†æ•°æ®...</p>
            </div>
            <div id="uploadResult"></div>
        </div>

        <!-- åŸºé‡‘åˆ†ç±»è®¾ç½®åŒºåŸŸ -->
        <div class="section">
            <h2>âš™ï¸ åŸºé‡‘åˆ†ç±»è®¾ç½®</h2>
            <div class="fund-settings">
                <div>
                    <h3 style="margin-bottom: 15px;">å½“å‰åŸºé‡‘åˆ†ç±»</h3>
                    <div class="fund-list" id="fundList">
                        <!-- åŸºé‡‘åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="add-fund-form">
                    <h3 style="margin-bottom: 15px;">æ·»åŠ æ–°åŸºé‡‘</h3>
                    <div class="form-group">
                        <label>èµ„äº§å°ç±»</label>
                        <select id="newAssetClass">
                            <option value="äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘">äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘</option>
                            <option value="å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘">å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘</option>
                            <option value="å…¬å‹Ÿæ··åˆåŸºé‡‘">å…¬å‹Ÿæ··åˆåŸºé‡‘</option>
                            <option value="å…¶ä»–å…¬å‹ŸåŸºé‡‘">å…¶ä»–å…¬å‹ŸåŸºé‡‘</option>
                            <option value="å§”å¤–éç°å›ºå®šæ”¶ç›Šç±»èµ„äº§">å§”å¤–éç°å›ºå®šæ”¶ç›Šç±»èµ„äº§</option>
                            <option value="å§”å¤–æ··åˆç±»èµ„äº§">å§”å¤–æ··åˆç±»èµ„äº§</option>
                            <option value="å§”å¤–æƒç›Šç±»æŠ•èµ„">å§”å¤–æƒç›Šç±»æŠ•èµ„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>èµ„äº§ç®€ç§°</label>
                        <input type="text" id="newAssetName" placeholder="è¾“å…¥åŸºé‡‘åç§°" />
                    </div>
                    <div class="form-group">
                        <label>é£æ ¼</label>
                        <select id="newStyle">
                            <option value="å‡è¡¡">å‡è¡¡</option>
                            <option value="ç§‘æŠ€æˆé•¿">ç§‘æŠ€æˆé•¿</option>
                            <option value="å‘¨æœŸ">å‘¨æœŸ</option>
                            <option value="çº¢åˆ©">çº¢åˆ©</option>
                            <option value="ä»·å€¼">ä»·å€¼</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æƒç›Šä»“ä½</label>
                        <input type="number" id="newEquityPosition" placeholder="è¾“å…¥æƒç›Šä»“ä½ (0-100)" min="0" max="100" />
                    </div>
                    <button class="btn btn-primary" onclick="addFund()">æ·»åŠ åŸºé‡‘</button>

                    <!-- æ•°æ®ç®¡ç†åŠŸèƒ½ -->
                    <hr style="margin: 20px 0; border: 1px solid #e2e8f0;">
                    <h4 style="margin-bottom: 10px; color: #374151;">ğŸ’¾ æ•°æ®ç®¡ç†</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn" style="background: #0ea5e9; color: white;" onclick="exportFundData()">ğŸ“¤
                            å¯¼å‡ºåŸºé‡‘åˆ†ç±»</button>
                        <button class="btn" style="background: #8b5cf6; color: white;"
                            onclick="document.getElementById('importFile').click()">ğŸ“¥ å¯¼å…¥åŸºé‡‘åˆ†ç±»</button>
                        <button class="btn" style="background: #f59e0b; color: white;"
                            onclick="updateHtmlWithNewFunds()">ğŸ”„ æ›´æ–°HTMLä»£ç </button>
                        <button class="btn" style="background: #ef4444; color: white;" onclick="resetToDefaults()">ğŸ”„
                            æ¢å¤é»˜è®¤</button>
                    </div>
                    <input type="file" id="importFile" style="display: none;" accept=".json"
                        onchange="importFundData(event)" />
                    <p style="font-size: 0.8em; color: #6b7280; margin-top: 10px;">
                        ğŸ’¡ æç¤ºï¼šæ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨ï¼Œä¸‹æ¬¡æ‰“å¼€ä¼šè‡ªåŠ¨åŠ è½½
                    </p>
                </div>
            </div>
        </div>

        <!-- åŸºé‡‘æ£€æµ‹çŠ¶æ€æç¤ºåŒºåŸŸ -->
        <div class="section" id="fundDetectionStatusSection" style="display: none;">
            <div id="fundDetectionContent">
                <!-- æ£€æµ‹çŠ¶æ€å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æœªåˆ†ç±»åŸºé‡‘æç¤ºåŒºåŸŸ -->
        <div class="section" id="unclassifiedFundsSection" style="display: none;">
            <h2>âš ï¸ å‘ç°æœªåˆ†ç±»åŸºé‡‘</h2>
            <p style="color: #ff6b35; margin-bottom: 20px;">åœ¨æŒä»“è¡¨ä¸­æ£€æµ‹åˆ°ä»¥ä¸‹å«æƒç›ŠåŸºé‡‘å°šæœªåˆ†ç±»ï¼Œè¯·è®¾ç½®å…¶é£æ ¼å’Œæƒç›Šä»“ä½åæ‰¹é‡æ·»åŠ ï¼š</p>
            <div class="unclassified-funds-container">
                <div class="unclassified-funds-header">
                    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="batchAddUnclassifiedFunds()">ğŸ“¥ æ‰¹é‡æ·»åŠ æ‰€æœ‰åŸºé‡‘</button>
                        <button class="btn" style="background: #6b7280; color: white;"
                            onclick="hideUnclassifiedFunds()">âŒ æš‚æ—¶éšè—</button>
                    </div>
                </div>
                <div class="unclassified-funds-list" id="unclassifiedFundsList">
                    <!-- æœªåˆ†ç±»åŸºé‡‘åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- åˆ†æç»“æœåŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“Š åˆ†æç»“æœ</h2>
            <div class="summary-stats" id="summaryStats">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>

            <!-- çŸ©é˜µè¡¨æ ¼ -->
            <div class="matrix-section">
                <div class="matrix-controls">
                    <div class="filter-section">
                        <h4>äº§å“ç­›é€‰</h4>
                        <div class="filter-controls">
                            <button class="filter-btn" onclick="selectAllProducts()">å…¨é€‰</button>
                            <button class="filter-btn secondary" onclick="deselectAllProducts()">å…¨ä¸é€‰</button>
                        </div>
                        <div class="filter-checkboxes" id="productFilters">
                            <!-- äº§å“ç­›é€‰å¤é€‰æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="toggle-section">
                        <h4>æ˜¾ç¤ºç±»å‹</h4>
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" onclick="toggleMatrixDisplay('amount')">é‡‘é¢</button>
                            <button class="toggle-btn" onclick="toggleMatrixDisplay('percentage')">å æ¯”</button>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="matrix-table" id="matrixTable">
                        <!-- çŸ©é˜µè¡¨æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>

            <div class="results-grid" id="resultsGrid">
                <!-- åˆ†æç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
        <div class="section">
            <h2>ğŸ“‹ è¯¦ç»†æ•°æ®</h2>
            <div class="table-container">
                <table class="data-table" id="detailTable">
                    <thead>
                        <tr>
                            <th>äº§å“åç§°</th>
                            <th>åŸºé‡‘åç§°</th>
                            <th>èµ„äº§å°ç±»</th>
                            <th>é£æ ¼</th>
                            <th>æƒç›Šä»“ä½</th>
                            <th>æŒä»“é‡‘é¢</th>
                            <th>æƒç›Šæš´éœ²é‡‘é¢</th>
                            <th>æƒç›Šæš´éœ²å æ¯”</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                        <!-- è¯¦ç»†æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // é»˜è®¤åŸºé‡‘åˆ†ç±»è®¾ç½®ï¼ˆä½¿ç”¨å¤–éƒ¨ä»£ç /èµ„äº§ä»£ç ä½œä¸ºé”®ï¼‰
        const defaultFundClassifications = {
            "002361.OF": {
                "assetClass": "äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘",
                "style": "å‡è¡¡",
                "equityPosition": 20
            },
            "000385.OF": {
                "assetClass": "äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘",
                "style": "å‡è¡¡",
                "equityPosition": 20
            },
            "015805.OF": {
                "assetClass": "äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘",
                "style": "å‡è¡¡",
                "equityPosition": 20
            },
            "016869.OF": {
                "assetClass": "äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘",
                "style": "å‡è¡¡",
                "equityPosition": 20
            },
            "006466.OF": {
                "assetClass": "äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘",
                "style": "å‡è¡¡",
                "equityPosition": 20
            },
            "110008.OF": {
                "assetClass": "äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘",
                "style": "å‡è¡¡",
                "equityPosition": 20
            },
            "002351.OF": {
                "assetClass": "äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘",
                "style": "å‡è¡¡",
                "equityPosition": 20
            },
            "013642.OF": {
                "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘",
                "style": "ç§‘æŠ€æˆé•¿",
                "equityPosition": 100
            },
            "011426.OF": {
                "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘",
                "style": "å‘¨æœŸ",
                "equityPosition": 100
            },
            "159338.SZ": {
                "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘",
                "style": "å‡è¡¡",
                "equityPosition": 100
            },
            "åæ³°æŸç‘çº¢åˆ©ETF ( 510880.SH )": { "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘", "style": "çº¢åˆ©", "equityPosition": 100 },
            "563360.SH": { "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "588000.SH": { "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "159351.SZ": { "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "010003.OF": { "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "æ™¯é¡ºé•¿åŸç¯ä¿ä¼˜åŠ¿ï¼ˆ001975.OFï¼‰": { "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "520990.SH": { "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘", "style": "çº¢åˆ©", "equityPosition": 100 },
            "515100.SH": { "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘", "style": "çº¢åˆ©", "equityPosition": 100 },
            "ä¸­è¯800äº¤æ˜“å‹å¼€æ”¾å¼æŒ‡æ•°è¯åˆ¸æŠ•èµ„åŸºé‡‘": { "assetClass": "å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "å®ç›ˆå“è´¨ç”„é€‰æ··åˆå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ä»·å€¼", "equityPosition": 100 },
            "012125.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "018225.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ä»·å€¼", "equityPosition": 100 },
            "010372.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "001300.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‘¨æœŸ", "equityPosition": 100 },
            "001301.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‘¨æœŸ", "equityPosition": 100 },
            "010625.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "å¹¿å‘ä¸»é¢˜é¢†å…ˆçµæ´»é…ç½®æ··åˆå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ä»·å€¼", "equityPosition": 100 },
            "åå•†æ–°è¶‹åŠ¿ä¼˜é€‰ï¼ˆ166301.OFï¼‰": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "017043.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ä»·å€¼", "equityPosition": 100 },
            "260101.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "ä¸‡å®¶å®è§‚æ‹©æ—¶å¤šç­–ç•¥çµæ´»é…ç½®æ··åˆå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‘¨æœŸ", "equityPosition": 100 },
            "015566.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‘¨æœŸ", "equityPosition": 100 },
            "020199.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‘¨æœŸ", "equityPosition": 100 },
            "æ˜“æ–¹è¾¾è£•æƒ å›æŠ¥å®šæœŸå¼€æ”¾å¼æ··åˆå‹å‘èµ·å¼è¯åˆ¸æŠ•èµ„åŸºé‡‘": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "011691.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "023452.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "012778.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "006567.OF": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ä»·å€¼", "equityPosition": 100 },
            "ä¸­æ³°å…ƒå’Œä»·å€¼ç²¾é€‰æ··åˆå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘": { "assetClass": "å…¬å‹Ÿæ··åˆåŸºé‡‘", "style": "ä»·å€¼", "equityPosition": 100 },
            "513010.SH": { "assetClass": "å…¶ä»–å…¬å‹ŸåŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "009879.OF": { "assetClass": "åè‚¡æ··åˆå‹åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "011066.OF": { "assetClass": "æ™®é€šè‚¡ç¥¨å‹åŸºé‡‘", "style": "ä»·å€¼", "equityPosition": 100 },
            "016841.OF": { "assetClass": "åè‚¡æ··åˆå‹åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "017750.OF": { "assetClass": "åè‚¡æ··åˆå‹åŸºé‡‘", "style": "å‘¨æœŸ", "equityPosition": 100 },
            "515220.SH": { "assetClass": "è¢«åŠ¨æŒ‡æ•°å‹åŸºé‡‘", "style": "å‘¨æœŸ", "equityPosition": 100 },
            "018505.OF": { "assetClass": "åè‚¡æ··åˆå‹åŸºé‡‘", "style": "å‘¨æœŸ", "equityPosition": 100 },
            "009878.OF": { "assetClass": "åè‚¡æ··åˆå‹åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "018993.OF": { "assetClass": "åè‚¡æ··åˆå‹åŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "024919.OF": { "assetClass": "çµæ´»é…ç½®å‹åŸºé‡‘", "style": "çº¢åˆ©", "equityPosition": 100 },
            "001258.OF": { "assetClass": "æ··åˆå€ºåˆ¸å‹äºŒçº§åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 20 },
            "015364.OF": { "assetClass": "æ™®é€šè‚¡ç¥¨å‹åŸºé‡‘", "style": "ä»·å€¼", "equityPosition": 100 },
            "020521.OF": { "assetClass": "æ··åˆå€ºåˆ¸å‹äºŒçº§åŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 20 },
            "001955.OF": { "assetClass": "åè‚¡æ··åˆå‹åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "010388.OF": { "assetClass": "æ™®é€šè‚¡ç¥¨å‹åŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "014088.OF": { "assetClass": "æ··åˆå€ºåˆ¸å‹äºŒçº§åŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 20 },
            "017941.OF": { "assetClass": "çµæ´»é…ç½®å‹åŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "217023.OF": { "assetClass": "æ··åˆå€ºåˆ¸å‹äºŒçº§åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 20 },
            "014846.OF": { "assetClass": "æ··åˆå€ºåˆ¸å‹äºŒçº§åŸºé‡‘", "style": "å‘¨æœŸ", "equityPosition": 20 },
            "017475.OF": { "assetClass": "æ··åˆå€ºåˆ¸å‹äºŒçº§åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 20 },
            "012228.OF": { "assetClass": "åè‚¡æ··åˆå‹åŸºé‡‘", "style": "å‡è¡¡", "equityPosition": 100 },
            "80PF210158": { "assetClass": "å§”å¤–éç°å›ºå®šæ”¶ç›Šç±»èµ„äº§", "style": "å‡è¡¡", "equityPosition": 18 },
            "80PF200133": { "assetClass": "å§”å¤–éç°å›ºå®šæ”¶ç›Šç±»èµ„äº§", "style": "ä»·å€¼", "equityPosition": 19 },
            "11PF252714": { "assetClass": "å§”å¤–éç°å›ºå®šæ”¶ç›Šç±»èµ„äº§", "style": "å‡è¡¡", "equityPosition": 18 },
            "11PF252802": { "assetClass": "å§”å¤–æƒç›Šç±»æŠ•èµ„", "style": "çº¢åˆ©", "equityPosition": 100 },
            "11PF253412": { "assetClass": "å§”å¤–æƒç›Šç±»æŠ•èµ„", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 100 },
            "å¤§æˆç§‘æŠ€åˆ›æ–°æ··åˆå‹è¯åˆ¸æŠ•èµ„åŸºé‡‘": { "assetClass": "åè‚¡æ··åˆå‹åŸºé‡‘", "style": "ç§‘æŠ€æˆé•¿", "equityPosition": 80 }
        };

        // æ•°æ®æŒä¹…åŒ–ç®¡ç†
        const STORAGE_KEY = 'fund_classifications_data';
        const FUND_EQUITY_SUBCLASS_RULES = {
            'äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘': { defaultEquity: 20 },
            'æ··åˆå€ºåˆ¸å‹äºŒçº§åŸºé‡‘': { defaultEquity: 20 },
            'å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘': { defaultEquity: 100 },
            'æ™®é€šè‚¡ç¥¨å‹åŸºé‡‘': { defaultEquity: 100 },
            'å…¬å‹Ÿæ··åˆåŸºé‡‘': { defaultEquity: 100 },
            'åè‚¡æ··åˆå‹åŸºé‡‘': { defaultEquity: 80 },
            'çµæ´»é…ç½®å‹åŸºé‡‘': { defaultEquity: 80 },
            'å…¶ä»–å…¬å‹ŸåŸºé‡‘': { defaultEquity: 100 },
            'è¢«åŠ¨æŒ‡æ•°å‹åŸºé‡‘': { defaultEquity: 100 },
            'å›½é™…(QDII)è¢«åŠ¨æŒ‡æ•°å‹è‚¡ç¥¨åŸºé‡‘': { defaultEquity: 100 }
        };
        const FUND_EQUITY_SUBCLASS_NAMES = Object.keys(FUND_EQUITY_SUBCLASS_RULES);

        // åˆå§‹åŒ–åŸºé‡‘åˆ†ç±»æ•°æ®ï¼ˆä»localStorageåŠ è½½æˆ–ä½¿ç”¨é»˜è®¤æ•°æ®ï¼‰
        function loadFundClassifications() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½åŸºé‡‘åˆ†ç±»æ•°æ®ï¼Œæ•°é‡:', Object.keys(parsed).length);
                    return parsed;
                }
            } catch (error) {
                console.warn('åŠ è½½ä¿å­˜çš„åŸºé‡‘åˆ†ç±»æ•°æ®å¤±è´¥:', error);
            }
            console.log('ä½¿ç”¨é»˜è®¤åŸºé‡‘åˆ†ç±»æ•°æ®');
            return { ...defaultFundClassifications };
        }

        // ä¿å­˜åŸºé‡‘åˆ†ç±»æ•°æ®åˆ°localStorage
        function saveFundClassifications() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(fundClassifications));
                console.log('åŸºé‡‘åˆ†ç±»æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                return true;
            } catch (error) {
                console.error('ä¿å­˜åŸºé‡‘åˆ†ç±»æ•°æ®å¤±è´¥:', error);
                return false;
            }
        }

        // åˆå§‹åŒ–åŸºé‡‘åˆ†ç±»æ•°æ®
        let fundClassifications = loadFundClassifications();

        let holdingData = [];
        let analysisResults = {};
        let selectedProducts = new Set();
        let matrixDisplayType = 'amount';
        let unclassifiedFunds = []; // å­˜å‚¨æœªåˆ†ç±»çš„åŸºé‡‘

        function normalizeText(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'string') return value.trim();
            return String(value).trim();
        }

        // åˆ›å»ºåŸºé‡‘åŒ¹é…é”®çš„å‡½æ•°
        function getFundMatchKey(row) {
            const assetClass = normalizeText(row['æ–°ç‰ˆèµ„äº§å¤§ç±»']);
            const externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);
            const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
            const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);

            // å¯¹äºå…¬å‹ŸåŸºé‡‘,ä¼˜å…ˆä½¿ç”¨å¤–éƒ¨ä»£ç 
            if (assetClass === 'å…¬å‹ŸåŸºé‡‘' && externalCode) {
                return externalCode;
            }

            // å¯¹äºå§”å¤–æŠ•èµ„,ä½¿ç”¨èµ„äº§ä»£ç 
            if (assetClass === 'å§”å¤–æŠ•èµ„' && assetCode) {
                return assetCode;
            }

            // å…¶ä»–æƒ…å†µä½¿ç”¨èµ„äº§ç®€ç§°
            return assetName;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            renderFundList();
            setupFileUpload();
        });

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');

            fileInput.addEventListener('change', handleFileUpload);

            // æ‹–æ‹½åŠŸèƒ½
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload({ target: { files: files } });
                }
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const loading = document.getElementById('loading');
            const uploadResult = document.getElementById('uploadResult');

            loading.classList.add('show');
            uploadResult.innerHTML = '';

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    holdingData = jsonData;
                    processData();

                    loading.classList.remove('show');
                    uploadResult.innerHTML = `<div class="success">âœ… æˆåŠŸä¸Šä¼ å¹¶å¤„ç†äº† ${jsonData.length} æ¡æŒä»“æ•°æ®</div>`;
                } catch (error) {
                    loading.classList.remove('show');
                    uploadResult.innerHTML = `<div class="error">âŒ æ–‡ä»¶å¤„ç†å¤±è´¥: ${error.message}</div>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // å¤„ç†æ•°æ®
        function processData() {
            if (holdingData.length === 0) return;

            const productResults = {};
            const detailData = [];
            const productNetAssets = {}; // å­˜å‚¨å„äº§å“çš„å‡€èµ„äº§
            const detectedUnclassifiedFunds = new Set(); // ç”¨Setæ¥é¿å…é‡å¤

            // æ¸…ç©ºä¹‹å‰çš„æœªåˆ†ç±»åŸºé‡‘
            unclassifiedFunds = [];

            // è°ƒè¯•ï¼šæ£€æŸ¥Excelæ–‡ä»¶çš„åˆ—å
            if (holdingData.length > 0) {
                console.log('Excelæ–‡ä»¶åˆ—å:', Object.keys(holdingData[0]));
            }

            // é¦–å…ˆè®¡ç®—å„äº§å“çš„å‡€èµ„äº§
            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;

                if (!productName || holdingAmount === 0) return;

                if (!productNetAssets[productName]) {
                    productNetAssets[productName] = 0;
                }

                // æ£€æŸ¥æ˜¯å¦ä¸ºæ­£å›è´­
                const isRepo = assetName && assetName.includes('æ­£å›è´­');

                if (isRepo) {
                    // æ­£å›è´­ä»å‡€èµ„äº§ä¸­å‡å»
                    productNetAssets[productName] -= holdingAmount;
                } else {
                    // å…¶ä»–èµ„äº§åŠ å…¥å‡€èµ„äº§
                    productNetAssets[productName] += holdingAmount;
                }
            });

            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;
                const assetClass = normalizeText(row['æ–°ç‰ˆèµ„äº§å¤§ç±»']);
                const assetSubClass = normalizeText(row['æ–°ç‰ˆèµ„äº§å°ç±»']);

                if (!productName || !assetName || holdingAmount === 0) return;

                // ä½¿ç”¨æ–°çš„åŒ¹é…é”®é€»è¾‘
                const matchKey = getFundMatchKey(row);
                const classification = fundClassifications[matchKey];
                const equitySubclassRule = FUND_EQUITY_SUBCLASS_RULES[assetSubClass];

                // æ£€æµ‹æ–°çš„å«æƒç›ŠåŸºé‡‘
                // æ£€æŸ¥æ¡ä»¶ï¼šæ–°ç‰ˆèµ„äº§å¤§ç±»ä¸º"å…¬å‹ŸåŸºé‡‘"ï¼Œä¸”æ–°ç‰ˆèµ„äº§å°ç±»åœ¨æŒ‡å®šåˆ†ç±»ä¸­ï¼Œä¸”æœªåœ¨å½“å‰åŸºé‡‘åˆ†ç±»æ•°æ®åº“ä¸­
                if (!classification && assetClass === 'å…¬å‹ŸåŸºé‡‘' && equitySubclassRule) {
                    if (!detectedUnclassifiedFunds.has(matchKey)) {
                        detectedUnclassifiedFunds.add(matchKey);
                        unclassifiedFunds.push({
                            assetName: assetName,
                            matchKey: matchKey,  // ä¿å­˜åŒ¹é…é”®
                            externalCode: normalizeText(row['å¤–éƒ¨ä»£ç ']),
                            assetSubClass: assetSubClass,
                            style: '', // å¾…ç”¨æˆ·è®¾ç½®
                            equityPosition: equitySubclassRule.defaultEquity // é»˜è®¤å€¼
                        });
                        console.log('æ£€æµ‹åˆ°æœªåˆ†ç±»å«æƒåŸºé‡‘:', assetName, 'åŒ¹é…é”®:', matchKey, 'èµ„äº§å¤§ç±»:', assetClass, 'èµ„äº§å°ç±»:', assetSubClass);
                    }
                }

                // å¦‚æœæ²¡æœ‰åˆ†ç±»ä¿¡æ¯ï¼Œè·³è¿‡å¤„ç†
                if (!classification) return;

                const equityExposure = holdingAmount * (classification.equityPosition / 100);

                if (!productResults[productName]) {
                    productResults[productName] = {};
                }

                if (!productResults[productName][classification.style]) {
                    productResults[productName][classification.style] = 0;
                }

                productResults[productName][classification.style] += equityExposure;

                detailData.push({
                    productName,
                    assetName,
                    assetClass: classification.assetClass,
                    style: classification.style,
                    equityPosition: classification.equityPosition,
                    holdingAmount,
                    equityExposure,
                    productNetAsset: productNetAssets[productName] // æ·»åŠ äº§å“å‡€èµ„äº§ä¿¡æ¯
                });
            });

            // è®¡ç®—å æ¯”
            Object.keys(productResults).forEach(productName => {
                const totalEquity = Object.values(productResults[productName]).reduce((sum, value) => sum + value, 0);
                Object.keys(productResults[productName]).forEach(style => {
                    const amount = productResults[productName][style];
                    productResults[productName][style] = {
                        amount: amount,
                        percentage: totalEquity > 0 ? (amount / totalEquity) * 100 : 0
                    };
                });
            });

            analysisResults = productResults;

            // åˆå§‹åŒ–é€‰ä¸­æ‰€æœ‰äº§å“
            selectedProducts.clear();
            Object.keys(productResults).forEach(product => {
                selectedProducts.add(product);
            });

            renderResults();
            renderDetailTable(calculateDetailData());
            renderFundDetectionStatus(); // æ¸²æŸ“åŸºé‡‘æ£€æµ‹çŠ¶æ€
            renderUnclassifiedFunds(); // æ¸²æŸ“æœªåˆ†ç±»åŸºé‡‘æç¤º
        }

        // æ¸²æŸ“ç»“æœ
        function renderResults() {
            renderSummaryStats();
            renderProductFilters();
            renderMatrixTable();
            renderProductCards();
        }

        // æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
        function renderSummaryStats() {
            const summaryStats = document.getElementById('summaryStats');

            // ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
            const productCount = Object.keys(analysisResults).length;
            const totalStyles = new Set();
            let totalEquityExposure = 0;

            Object.values(analysisResults).forEach(product => {
                Object.keys(product).forEach(style => {
                    totalStyles.add(style);
                    totalEquityExposure += product[style].amount;
                });
            });

            summaryStats.innerHTML = `
                <div class="stat-card">
                    <h4>äº§å“æ•°é‡</h4>
                    <div class="value">${productCount}</div>
                </div>
                <div class="stat-card">
                    <h4>é£æ ¼æ•°é‡</h4>
                    <div class="value">${totalStyles.size}</div>
                </div>
                <div class="stat-card">
                    <h4>æ€»æƒç›Šæš´éœ²</h4>
                    <div class="value">${(totalEquityExposure / 100000000).toFixed(1)}äº¿</div>
                </div>
            `;
        }

        // æ¸²æŸ“äº§å“ç­›é€‰å™¨
        function renderProductFilters() {
            const productFilters = document.getElementById('productFilters');
            productFilters.innerHTML = '';

            Object.keys(analysisResults).forEach(productName => {
                const checkbox = document.createElement('div');
                checkbox.className = 'filter-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="filter-${productName.replace(/[^a-zA-Z0-9]/g, '')}" 
                           ${selectedProducts.has(productName) ? 'checked' : ''} 
                           onchange="toggleProductFilter('${productName}')" />
                    <label for="filter-${productName.replace(/[^a-zA-Z0-9]/g, '')}">${productName}</label>
                `;
                productFilters.appendChild(checkbox);
            });
        }

        // æ¸²æŸ“çŸ©é˜µè¡¨æ ¼
        function renderMatrixTable() {
            const matrixTable = document.getElementById('matrixTable');

            // è·å–æ‰€æœ‰é£æ ¼å¹¶è®¾ç½®æ’åºé¡ºåº
            const allStyles = new Set();
            Object.values(analysisResults).forEach(product => {
                Object.keys(product).forEach(style => {
                    allStyles.add(style);
                });
            });
            // è®¾ç½®é£æ ¼æ’åºé¡ºåºï¼Œçº¢åˆ©æ”¾åœ¨ç¬¬ä¸€ä½
            const styleOrder = ['çº¢åˆ©', 'å‡è¡¡', 'ç§‘æŠ€æˆé•¿', 'å‘¨æœŸ', 'ä»·å€¼'];
            const styles = Array.from(allStyles).sort((a, b) => {
                const indexA = styleOrder.indexOf(a);
                const indexB = styleOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });

            // åˆ›å»ºè¡¨å¤´
            let headerHtml = '<tr><th>äº§å“åç§°</th>';
            styles.forEach(style => {
                headerHtml += `<th>${style}</th>`;
            });
            headerHtml += '</tr>';

            // åˆ›å»ºè¡¨æ ¼è¡Œ
            let bodyHtml = '';
            Array.from(selectedProducts).forEach(productName => {
                const product = analysisResults[productName];
                let rowHtml = `<tr><td class="product-name">${productName}</td>`;

                styles.forEach(style => {
                    const data = product[style];
                    if (data) {
                        if (matrixDisplayType === 'amount') {
                            rowHtml += `<td class="amount-cell">${(data.amount / 10000).toFixed(0)}ä¸‡</td>`;
                        } else {
                            rowHtml += `<td class="percentage-cell">${Math.round(data.percentage)}%</td>`;
                        }
                    } else {
                        rowHtml += `<td class="zero-cell">-</td>`;
                    }
                });

                rowHtml += '</tr>';
                bodyHtml += rowHtml;
            });

            matrixTable.innerHTML = `
                <thead>${headerHtml}</thead>
                <tbody>${bodyHtml}</tbody>
            `;
        }

        // æ¸²æŸ“äº§å“å¡ç‰‡
        function renderProductCards() {
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            // åªæ˜¾ç¤ºé€‰ä¸­çš„äº§å“
            Array.from(selectedProducts).forEach(productName => {
                const product = analysisResults[productName];
                const productCard = document.createElement('div');
                productCard.className = 'product-card';

                // è®¾ç½®é£æ ¼æ’åºé¡ºåºï¼Œçº¢åˆ©æ”¾åœ¨ç¬¬ä¸€ä½
                const styleOrder = ['çº¢åˆ©', 'å‡è¡¡', 'ç§‘æŠ€æˆé•¿', 'å‘¨æœŸ', 'ä»·å€¼'];
                const sortedStyles = Object.keys(product).sort((a, b) => {
                    const indexA = styleOrder.indexOf(a);
                    const indexB = styleOrder.indexOf(b);
                    if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });

                let styleItemsHtml = '';
                sortedStyles.forEach(style => {
                    const data = product[style];
                    styleItemsHtml += `
                        <div class="style-item">
                            <span class="style-name">${style}</span>
                            <span class="style-amount">${(data.amount / 10000).toFixed(0)}ä¸‡</span>
                            <span class="style-percentage">${Math.round(data.percentage)}%</span>
                        </div>
                    `;
                });

                productCard.innerHTML = `
                    <h3>${productName}</h3>
                    ${styleItemsHtml}
                    <div class="chart-container">
                        <canvas id="chart-${productName.replace(/[^a-zA-Z0-9]/g, '')}"></canvas>
                    </div>
                `;

                resultsGrid.appendChild(productCard);

                // åˆ›å»ºå›¾è¡¨
                setTimeout(() => {
                    createChart(productName, product);
                }, 100);
            });
        }

        // åˆ‡æ¢äº§å“ç­›é€‰
        function toggleProductFilter(productName) {
            if (selectedProducts.has(productName)) {
                selectedProducts.delete(productName);
            } else {
                selectedProducts.add(productName);
            }

            renderMatrixTable();
            renderProductCards();
            // é‡æ–°æ¸²æŸ“è¯¦ç»†æ•°æ®è¡¨æ ¼ä»¥åæ˜ ç­›é€‰çŠ¶æ€
            if (holdingData.length > 0) {
                renderDetailTable(calculateDetailData());
            }
        }

        // åˆ‡æ¢çŸ©é˜µæ˜¾ç¤ºç±»å‹
        function toggleMatrixDisplay(type) {
            matrixDisplayType = type;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="toggleMatrixDisplay('${type}')"]`).classList.add('active');

            renderMatrixTable();
        }

        // å…¨é€‰äº§å“
        function selectAllProducts() {
            selectedProducts.clear();
            Object.keys(analysisResults).forEach(product => {
                selectedProducts.add(product);
            });

            renderProductFilters();
            renderMatrixTable();
            renderProductCards();
            // é‡æ–°æ¸²æŸ“è¯¦ç»†æ•°æ®è¡¨æ ¼ä»¥åæ˜ ç­›é€‰çŠ¶æ€
            if (holdingData.length > 0) {
                renderDetailTable(calculateDetailData());
            }
        }

        // å…¨ä¸é€‰äº§å“
        function deselectAllProducts() {
            selectedProducts.clear();

            renderProductFilters();
            renderMatrixTable();
            renderProductCards();
            // é‡æ–°æ¸²æŸ“è¯¦ç»†æ•°æ®è¡¨æ ¼ä»¥åæ˜ ç­›é€‰çŠ¶æ€
            if (holdingData.length > 0) {
                renderDetailTable(calculateDetailData());
            }
        }

        // åˆ›å»ºå›¾è¡¨
        function createChart(productName, data) {
            const canvasId = `chart-${productName.replace(/[^a-zA-Z0-9]/g, '')}`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const labels = Object.keys(data);
            const values = labels.map(label => data[label].percentage);
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#ff9a9e', '#a8edea'
            ];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // è®¡ç®—è¯¦ç»†æ•°æ®ï¼ˆåŒ…æ‹¬äº§å“å‡€èµ„äº§ï¼‰
        function calculateDetailData() {
            const detailData = [];
            const productNetAssets = {}; // å­˜å‚¨å„äº§å“çš„å‡€èµ„äº§

            // é¦–å…ˆè®¡ç®—å„äº§å“çš„å‡€èµ„äº§
            holdingData.forEach(row => {
                const productName = row['äº§å“ç®€ç§°'];
                const assetName = row['èµ„äº§ç®€ç§°'];
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;

                if (!productName || holdingAmount === 0) return;

                if (!productNetAssets[productName]) {
                    productNetAssets[productName] = 0;
                }

                // æ£€æŸ¥æ˜¯å¦ä¸ºæ­£å›è´­
                const isRepo = assetName && assetName.includes('æ­£å›è´­');

                if (isRepo) {
                    // æ­£å›è´­ä»å‡€èµ„äº§ä¸­å‡å»
                    productNetAssets[productName] -= holdingAmount;
                } else {
                    // å…¶ä»–èµ„äº§åŠ å…¥å‡€èµ„äº§
                    productNetAssets[productName] += holdingAmount;
                }
            });

            // ç„¶åç”Ÿæˆè¯¦ç»†æ•°æ®
            holdingData.forEach(row => {
                const productName = row['äº§å“ç®€ç§°'];
                const assetName = row['èµ„äº§ç®€ç§°'];
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;

                if (!productName || !assetName || holdingAmount === 0) return;

                // ä½¿ç”¨æ–°çš„åŒ¹é…é”®é€»è¾‘
                const matchKey = getFundMatchKey(row);
                const classification = fundClassifications[matchKey];
                if (!classification) return;

                const equityExposure = holdingAmount * (classification.equityPosition / 100);

                detailData.push({
                    productName,
                    assetName,
                    assetClass: classification.assetClass,
                    style: classification.style,
                    equityPosition: classification.equityPosition,
                    holdingAmount,
                    equityExposure,
                    productNetAsset: productNetAssets[productName]
                });
            });

            return detailData;
        }

        // æ¸²æŸ“è¯¦ç»†æ•°æ®è¡¨æ ¼
        function renderDetailTable(data) {
            const tbody = document.getElementById('detailTableBody');
            tbody.innerHTML = '';

            // ç­›é€‰æ•°æ®ï¼šåªæ˜¾ç¤ºé€‰ä¸­äº§å“çš„æ•°æ®
            const filteredData = data.filter(row => selectedProducts.has(row.productName));

            // ä¸ºç­›é€‰åçš„æ•°æ®è®¡ç®—æƒç›Šæš´éœ²å æ¯”
            filteredData.forEach(row => {
                // ä½¿ç”¨æƒç›Šæš´éœ²é‡‘é¢é™¤ä»¥äº§å“å‡€èµ„äº§è®¡ç®—å æ¯”
                row.equityExposureRatio = row.productNetAsset > 0 ? (row.equityExposure / row.productNetAsset * 100) : 0;
            });

            // æŒ‰ç…§äº§å“åç§°ã€é£æ ¼ã€æƒç›Šæš´éœ²å æ¯”æ’åº
            filteredData.sort((a, b) => {
                // é¦–å…ˆæŒ‰äº§å“åç§°æ’åº
                if (a.productName < b.productName) return -1;
                if (a.productName > b.productName) return 1;

                // å¦‚æœäº§å“åç§°ç›¸åŒï¼ŒæŒ‰é£æ ¼æ’åº
                if (a.style < b.style) return -1;
                if (a.style > b.style) return 1;

                // å¦‚æœäº§å“åç§°å’Œé£æ ¼éƒ½ç›¸åŒï¼ŒæŒ‰æƒç›Šæš´éœ²å æ¯”é™åºæ’åº
                return b.equityExposureRatio - a.equityExposureRatio;
            });

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.productName}</td>
                    <td>${row.assetName}</td>
                    <td>${row.assetClass}</td>
                    <td>${row.style}</td>
                    <td>${row.equityPosition}%</td>
                    <td>${(row.holdingAmount / 10000).toFixed(0)}ä¸‡</td>
                    <td>${(row.equityExposure / 10000).toFixed(0)}ä¸‡</td>
                    <td>${row.equityExposureRatio.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // æ¸²æŸ“åŸºé‡‘åˆ—è¡¨
        function renderFundList() {
            const fundList = document.getElementById('fundList');
            fundList.innerHTML = '';

            Object.keys(fundClassifications).forEach(fundName => {
                const fund = fundClassifications[fundName];
                const fundItem = document.createElement('div');
                fundItem.className = 'fund-item';

                fundItem.innerHTML = `
                    <input type="text" value="${fundName}" readonly style="background: #f9f9f9;" />
                    <select onchange="updateFund('${fundName}', 'assetClass', this.value)">
                        <option value="äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘" ${fund.assetClass === 'äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘' ? 'selected' : ''}>äºŒçº§å…¬å‹Ÿå€ºåˆ¸åŸºé‡‘</option>
                        <option value="å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘" ${fund.assetClass === 'å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘' ? 'selected' : ''}>å…¬å‹Ÿè‚¡ç¥¨åŸºé‡‘</option>
                        <option value="å…¬å‹Ÿæ··åˆåŸºé‡‘" ${fund.assetClass === 'å…¬å‹Ÿæ··åˆåŸºé‡‘' ? 'selected' : ''}>å…¬å‹Ÿæ··åˆåŸºé‡‘</option>
                        <option value="å…¶ä»–å…¬å‹ŸåŸºé‡‘" ${fund.assetClass === 'å…¶ä»–å…¬å‹ŸåŸºé‡‘' ? 'selected' : ''}>å…¶ä»–å…¬å‹ŸåŸºé‡‘</option>
                        <option value="å§”å¤–éç°å›ºå®šæ”¶ç›Šç±»èµ„äº§" ${fund.assetClass === 'å§”å¤–éç°å›ºå®šæ”¶ç›Šç±»èµ„äº§' ? 'selected' : ''}>å§”å¤–éç°å›ºå®šæ”¶ç›Šç±»èµ„äº§</option>
                        <option value="å§”å¤–æ··åˆç±»èµ„äº§" ${fund.assetClass === 'å§”å¤–æ··åˆç±»èµ„äº§' ? 'selected' : ''}>å§”å¤–æ··åˆç±»èµ„äº§</option>
                        <option value="å§”å¤–æƒç›Šç±»æŠ•èµ„" ${fund.assetClass === 'å§”å¤–æƒç›Šç±»æŠ•èµ„' ? 'selected' : ''}>å§”å¤–æƒç›Šç±»æŠ•èµ„</option>
                    </select>
                    <select onchange="updateFund('${fundName}', 'style', this.value)">
                        <option value="å‡è¡¡" ${fund.style === 'å‡è¡¡' ? 'selected' : ''}>å‡è¡¡</option>
                        <option value="ç§‘æŠ€æˆé•¿" ${fund.style === 'ç§‘æŠ€æˆé•¿' ? 'selected' : ''}>ç§‘æŠ€æˆé•¿</option>
                        <option value="å‘¨æœŸ" ${fund.style === 'å‘¨æœŸ' ? 'selected' : ''}>å‘¨æœŸ</option>
                        <option value="çº¢åˆ©" ${fund.style === 'çº¢åˆ©' ? 'selected' : ''}>çº¢åˆ©</option>
                        <option value="ä»·å€¼" ${fund.style === 'ä»·å€¼' ? 'selected' : ''}>ä»·å€¼</option>
                    </select>
                    <input type="number" value="${fund.equityPosition}" min="0" max="100" 
                           onchange="updateFund('${fundName}', 'equityPosition', parseFloat(this.value))" />
                    <button class="btn btn-danger" onclick="deleteFund('${fundName}')">åˆ é™¤</button>
                `;

                fundList.appendChild(fundItem);
            });
        }

        // æ›´æ–°åŸºé‡‘ä¿¡æ¯
        function updateFund(fundName, property, value) {
            if (fundClassifications[fundName]) {
                fundClassifications[fundName][property] = value;
                // è‡ªåŠ¨ä¿å­˜æ•°æ®
                saveFundClassifications();
                if (holdingData.length > 0) {
                    processData();
                }
            }
        }

        // åˆ é™¤åŸºé‡‘
        function deleteFund(fundName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ ${fundName} å—ï¼Ÿ`)) {
                delete fundClassifications[fundName];
                // è‡ªåŠ¨ä¿å­˜æ•°æ®
                saveFundClassifications();
                renderFundList();
                if (holdingData.length > 0) {
                    processData();
                }
            }
        }

        // æ·»åŠ åŸºé‡‘
        function addFund() {
            const assetClass = document.getElementById('newAssetClass').value;
            const assetName = document.getElementById('newAssetName').value.trim();
            const style = document.getElementById('newStyle').value;
            const equityPosition = parseFloat(document.getElementById('newEquityPosition').value);

            if (!assetName) {
                alert('è¯·è¾“å…¥åŸºé‡‘åç§°');
                return;
            }

            if (isNaN(equityPosition) || equityPosition < 0 || equityPosition > 100) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æƒç›Šä»“ä½ (0-100)');
                return;
            }

            if (fundClassifications[assetName]) {
                alert('è¯¥åŸºé‡‘å·²å­˜åœ¨');
                return;
            }

            fundClassifications[assetName] = {
                assetClass: assetClass,
                style: style,
                equityPosition: equityPosition
            };

            // è‡ªåŠ¨ä¿å­˜æ•°æ®
            saveFundClassifications();

            // æ¸…ç©ºè¡¨å•
            document.getElementById('newAssetName').value = '';
            document.getElementById('newEquityPosition').value = '';

            renderFundList();
            if (holdingData.length > 0) {
                processData();
            }
        }

        // æ¸²æŸ“åŸºé‡‘æ£€æµ‹çŠ¶æ€
        function renderFundDetectionStatus() {
            const statusSection = document.getElementById('fundDetectionStatusSection');
            const statusContent = document.getElementById('fundDetectionContent');

            if (!statusSection || !statusContent) return;

            const detectionClassesText = FUND_EQUITY_SUBCLASS_NAMES
                .map(name => `"${name}"`)
                .join('ã€');

            const totalFunds = holdingData.length;
            const classifiedFunds = holdingData.filter(row => {
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                return assetName && fundClassifications[assetName];
            }).length;

            if (unclassifiedFunds.length === 0) {
                // æ²¡æœ‰æ£€æµ‹åˆ°æœªåˆ†ç±»åŸºé‡‘
                statusContent.innerHTML = `
                    <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 20px;">
                        <h2 style="color: #059669; margin-bottom: 15px;">âœ… åŸºé‡‘åˆ†ç±»æ£€æµ‹å®Œæˆ</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #059669; font-size: 1.5em; font-weight: 600;">${totalFunds}</div>
                                <div style="color: #6b7280; font-size: 0.9em;">æ€»æŒä»“è®°å½•</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #059669; font-size: 1.5em; font-weight: 600;">${classifiedFunds}</div>
                                <div style="color: #6b7280; font-size: 0.9em;">å·²åˆ†ç±»åŸºé‡‘è®°å½•</div>
                            </div>
                            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                                <div style="color: #059669; font-size: 1.5em; font-weight: 600;">0</div>
                                <div style="color: #6b7280; font-size: 0.9em;">æœªåˆ†ç±»å«æƒåŸºé‡‘</div>
                            </div>
                        </div>
                        <p style="margin-top: 15px; color: #059669;">
                            ğŸ“Š æ£€æµ‹æ¡ä»¶ï¼šæ–°ç‰ˆèµ„äº§å¤§ç±»="å…¬å‹ŸåŸºé‡‘" ä¸” æ–°ç‰ˆèµ„äº§å°ç±»âˆˆ[${detectionClassesText}]
                        </p>
                        <p style="margin-top: 10px; color: #6b7280; font-size: 0.9em;">
                            æ‰€æœ‰å«æƒç›ŠåŸºé‡‘éƒ½å·²åœ¨åˆ†ç±»æ•°æ®åº“ä¸­ï¼Œå¯ä»¥æ­£å¸¸è¿›è¡Œåˆ†æè®¡ç®—ã€‚
                        </p>
                        <button class="btn" style="background: #6b7280; color: white; margin-top: 10px;" onclick="hideFundDetectionStatus()">éšè—æ­¤æç¤º</button>
                    </div>
                `;
                statusSection.style.display = 'block';
                console.log('åŸºé‡‘åˆ†ç±»æ£€æµ‹å®Œæˆï¼šæœªå‘ç°éœ€è¦åˆ†ç±»çš„æ–°åŸºé‡‘');
            } else {
                // éšè—çŠ¶æ€æç¤ºï¼Œæ˜¾ç¤ºæœªåˆ†ç±»åŸºé‡‘åŒºåŸŸ
                statusSection.style.display = 'none';
                console.log(`å‘ç° ${unclassifiedFunds.length} ä¸ªæœªåˆ†ç±»å«æƒåŸºé‡‘`);
            }
        }

        // æ¸²æŸ“æœªåˆ†ç±»åŸºé‡‘åˆ—è¡¨
        function renderUnclassifiedFunds() {
            const section = document.getElementById('unclassifiedFundsSection');
            const fundsList = document.getElementById('unclassifiedFundsList');

            if (!section || !fundsList) {
                console.error('æœªæ‰¾åˆ°æœªåˆ†ç±»åŸºé‡‘çš„HTMLå…ƒç´ ');
                return;
            }

            if (unclassifiedFunds.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // åˆ›å»ºè¡¨å¤´
            let headerHtml = `
                <div class="unclassified-fund-header">
                    <div>åŸºé‡‘åç§°</div>
                    <div>èµ„äº§ç±»å‹</div>
                    <div>é£æ ¼</div>
                    <div>æƒç›Šä»“ä½</div>
                    <div>æ“ä½œ</div>
                </div>
            `;

            // åˆ›å»ºåŸºé‡‘é¡¹
            let itemsHtml = '';
            unclassifiedFunds.forEach((fund, index) => {
                itemsHtml += `
                    <div class="unclassified-fund-item">
                        <div class="fund-name">${fund.assetName}</div>
                        <div class="asset-type">${fund.assetSubClass}</div>
                        <select id="unclassifiedStyle-${index}" onchange="updateUnclassifiedFund(${index}, 'style', this.value)">
                            <option value="">è¯·é€‰æ‹©é£æ ¼</option>
                            <option value="çº¢åˆ©" ${fund.style === 'çº¢åˆ©' ? 'selected' : ''}>çº¢åˆ©</option>
                            <option value="å‡è¡¡" ${fund.style === 'å‡è¡¡' ? 'selected' : ''}>å‡è¡¡</option>
                            <option value="ç§‘æŠ€æˆé•¿" ${fund.style === 'ç§‘æŠ€æˆé•¿' ? 'selected' : ''}>ç§‘æŠ€æˆé•¿</option>
                            <option value="å‘¨æœŸ" ${fund.style === 'å‘¨æœŸ' ? 'selected' : ''}>å‘¨æœŸ</option>
                            <option value="ä»·å€¼" ${fund.style === 'ä»·å€¼' ? 'selected' : ''}>ä»·å€¼</option>
                        </select>
                        <input type="number" id="unclassifiedEquity-${index}" value="${fund.equityPosition}" 
                               min="0" max="100" placeholder="æƒç›Šä»“ä½" 
                               onchange="updateUnclassifiedFund(${index}, 'equityPosition', parseFloat(this.value))" />
                        <button class="batch-add-individual" onclick="addSingleUnclassifiedFund(${index})" 
                                ${!fund.style ? 'disabled' : ''}>
                            æ·»åŠ 
                        </button>
                    </div>
                `;
            });

            fundsList.innerHTML = headerHtml + itemsHtml;
        }

        // æ›´æ–°æœªåˆ†ç±»åŸºé‡‘ä¿¡æ¯
        function updateUnclassifiedFund(index, property, value) {
            if (unclassifiedFunds[index]) {
                unclassifiedFunds[index][property] = value;

                // å¦‚æœè®¾ç½®äº†é£æ ¼ï¼Œå¯ç”¨æ·»åŠ æŒ‰é’®
                const addButton = document.querySelector(`[onclick="addSingleUnclassifiedFund(${index})"]`);
                if (addButton) {
                    addButton.disabled = !unclassifiedFunds[index].style;
                }
            }
        }

        // æ·»åŠ å•ä¸ªæœªåˆ†ç±»åŸºé‡‘
        function addSingleUnclassifiedFund(index) {
            const fund = unclassifiedFunds[index];

            if (!fund.style) {
                alert('è¯·å…ˆé€‰æ‹©åŸºé‡‘é£æ ¼');
                return;
            }

            if (isNaN(fund.equityPosition) || fund.equityPosition < 0 || fund.equityPosition > 100) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æƒç›Šä»“ä½ (0-100)');
                return;
            }

            // æ·»åŠ åˆ°åŸºé‡‘åˆ†ç±»æ•°æ®åº“ï¼Œä½¿ç”¨åŒ¹é…é”®è€Œä¸æ˜¯èµ„äº§ç®€ç§°
            fundClassifications[fund.matchKey] = {
                assetClass: fund.assetSubClass,
                style: fund.style,
                equityPosition: fund.equityPosition
            };

            // è‡ªåŠ¨ä¿å­˜æ•°æ®
            saveFundClassifications();

            // ä»æœªåˆ†ç±»åˆ—è¡¨ä¸­ç§»é™¤
            unclassifiedFunds.splice(index, 1);

            // é‡æ–°æ¸²æŸ“
            renderFundList();

            if (holdingData.length > 0) {
                processData();
            } else {
                renderFundDetectionStatus();
                renderUnclassifiedFunds();
            }

            alert(`åŸºé‡‘"${fund.assetName}"å·²æˆåŠŸæ·»åŠ åˆ°åˆ†ç±»æ•°æ®åº“`);
        }

        // æ‰¹é‡æ·»åŠ æ‰€æœ‰æœªåˆ†ç±»åŸºé‡‘
        function batchAddUnclassifiedFunds() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åŸºé‡‘éƒ½è®¾ç½®äº†é£æ ¼
            const unsetFunds = unclassifiedFunds.filter(fund => !fund.style);
            if (unsetFunds.length > 0) {
                alert(`è¿˜æœ‰${unsetFunds.length}ä¸ªåŸºé‡‘æœªè®¾ç½®é£æ ¼ï¼Œè¯·è®¾ç½®åå†æ‰¹é‡æ·»åŠ `);
                return;
            }

            // æ£€æŸ¥æƒç›Šä»“ä½æ˜¯å¦éƒ½æœ‰æ•ˆ
            const invalidFunds = unclassifiedFunds.filter(fund =>
                isNaN(fund.equityPosition) || fund.equityPosition < 0 || fund.equityPosition > 100
            );
            if (invalidFunds.length > 0) {
                alert('å­˜åœ¨æ— æ•ˆçš„æƒç›Šä»“ä½è®¾ç½®ï¼Œè¯·æ£€æŸ¥åå†æ‰¹é‡æ·»åŠ ');
                return;
            }

            if (!confirm(`ç¡®å®šè¦æ‰¹é‡æ·»åŠ ${unclassifiedFunds.length}ä¸ªåŸºé‡‘åˆ°åˆ†ç±»æ•°æ®åº“å—ï¼Ÿ`)) {
                return;
            }

            // æ‰¹é‡æ·»åŠ åˆ°åŸºé‡‘åˆ†ç±»æ•°æ®åº“ï¼Œä½¿ç”¨åŒ¹é…é”®è€Œä¸æ˜¯èµ„äº§ç®€ç§°
            let addedCount = 0;
            unclassifiedFunds.forEach(fund => {
                if (!fundClassifications[fund.matchKey]) {
                    fundClassifications[fund.matchKey] = {
                        assetClass: fund.assetSubClass,
                        style: fund.style,
                        equityPosition: fund.equityPosition
                    };
                    addedCount++;
                }
            });

            // è‡ªåŠ¨ä¿å­˜æ•°æ®
            if (addedCount > 0) {
                saveFundClassifications();
            }

            // æ¸…ç©ºæœªåˆ†ç±»åˆ—è¡¨
            unclassifiedFunds = [];

            // é‡æ–°æ¸²æŸ“
            renderFundList();

            if (holdingData.length > 0) {
                processData();
            } else {
                renderFundDetectionStatus();
                renderUnclassifiedFunds();
            }

            alert(`æˆåŠŸæ‰¹é‡æ·»åŠ äº†${addedCount}ä¸ªåŸºé‡‘åˆ°åˆ†ç±»æ•°æ®åº“`);
        }

        // éšè—æœªåˆ†ç±»åŸºé‡‘åŒºåŸŸ
        function hideUnclassifiedFunds() {
            document.getElementById('unclassifiedFundsSection').style.display = 'none';
        }

        // éšè—åŸºé‡‘æ£€æµ‹çŠ¶æ€åŒºåŸŸ
        function hideFundDetectionStatus() {
            document.getElementById('fundDetectionStatusSection').style.display = 'none';
        }

        // æ•°æ®å¯¼å‡ºåŠŸèƒ½
        function exportFundData() {
            try {
                const dataToExport = {
                    version: '1.1.0',
                    exportTime: new Date().toISOString(),
                    fundClassifications: fundClassifications,
                    totalFunds: Object.keys(fundClassifications).length
                };

                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `åŸºé‡‘åˆ†ç±»æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
                link.click();

                alert(`æˆåŠŸå¯¼å‡º${dataToExport.totalFunds}ä¸ªåŸºé‡‘çš„åˆ†ç±»æ•°æ®ï¼`);
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                alert('å¯¼å‡ºæ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯');
            }
        }

        // æ•°æ®å¯¼å…¥åŠŸèƒ½
        function importFundData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!importedData.fundClassifications) {
                        alert('å¯¼å…¥æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œç¼ºå°‘åŸºé‡‘åˆ†ç±»æ•°æ®');
                        return;
                    }

                    if (confirm(`ç¡®å®šè¦å¯¼å…¥${Object.keys(importedData.fundClassifications).length}ä¸ªåŸºé‡‘åˆ†ç±»æ•°æ®å—ï¼Ÿè¿™å°†æ›¿æ¢å½“å‰æ•°æ®ã€‚`)) {
                        fundClassifications = importedData.fundClassifications;
                        saveFundClassifications();
                        renderFundList();

                        if (holdingData.length > 0) {
                            processData();
                        }

                        alert(`æˆåŠŸå¯¼å…¥${Object.keys(fundClassifications).length}ä¸ªåŸºé‡‘åˆ†ç±»æ•°æ®ï¼`);
                    }
                } catch (error) {
                    console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                    alert('å¯¼å…¥æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
                }
            };
            reader.readAsText(file);

            // é‡ç½®æ–‡ä»¶è¾“å…¥
            event.target.value = '';
        }

        // æ›´æ–°HTMLä»£ç åŠŸèƒ½
        function updateHtmlWithNewFunds() {
            const newFunds = Object.keys(fundClassifications).filter(name =>
                !defaultFundClassifications.hasOwnProperty(name)
            );

            if (newFunds.length === 0) {
                alert('æ²¡æœ‰æ£€æµ‹åˆ°æ–°å¢çš„åŸºé‡‘åˆ†ç±»ï¼Œæ— éœ€æ›´æ–°HTMLä»£ç ');
                return;
            }

            let htmlCode = '\n        // æ–°å¢çš„åŸºé‡‘åˆ†ç±»\n';
            newFunds.forEach(fundName => {
                const fund = fundClassifications[fundName];
                htmlCode += `        '${fundName}': { assetClass: '${fund.assetClass}', style: '${fund.style}', equityPosition: ${fund.equityPosition} },\n`;
            });

            const fullCode = `
è¯·å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°HTMLæ–‡ä»¶ä¸­çš„defaultFundClassificationså¯¹è±¡ä¸­ï¼š
${htmlCode}
æˆ–è€…æ•´ä¸ªæ›¿æ¢fundClassificationså¯¹è±¡ä¸ºï¼š

let fundClassifications = ${JSON.stringify(fundClassifications, null, 4)};
            `;

            // å¤åˆ¶åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(fullCode).then(() => {
                alert(`æ£€æµ‹åˆ°${newFunds.length}ä¸ªæ–°å¢åŸºé‡‘ï¼Œæ›´æ–°ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\næ–°å¢åŸºé‡‘ï¼š\n${newFunds.join('\n')}`);
            }).catch(() => {
                alert(`æ£€æµ‹åˆ°${newFunds.length}ä¸ªæ–°å¢åŸºé‡‘ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹ä»£ç ï¼š\n${fullCode}`);
            });
        }

        // æ¢å¤é»˜è®¤æ•°æ®
        function resetToDefaults() {
            if (confirm('ç¡®å®šè¦æ¢å¤åˆ°é»˜è®¤çš„åŸºé‡‘åˆ†ç±»è®¾ç½®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è‡ªå®šä¹‰æ·»åŠ çš„åŸºé‡‘ã€‚')) {
                fundClassifications = { ...defaultFundClassifications };
                saveFundClassifications();
                renderFundList();

                if (holdingData.length > 0) {
                    processData();
                }

                alert('å·²æ¢å¤åˆ°é»˜è®¤åŸºé‡‘åˆ†ç±»è®¾ç½®');
            }
        }

    </script>
</body>

</html>