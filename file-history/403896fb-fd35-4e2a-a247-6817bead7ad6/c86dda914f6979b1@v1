# 含权基金分类检测功能说明

## 功能概述

系统会自动检测持仓明细表中需要分类的含权基金，如果发现未分类的基金，会提示用户在基金分类表中补充分类信息。

---

## 检测范围

系统只检测以下5类资产小类的基金：

| 资产小类 | 说明 |
|---------|------|
| 被动指数型基金 | 跟踪指数的被动型基金 |
| 混合债券型二级基金 | 可投资股票的二级债基 |
| 偏股混合型基金 | 股票仓位较高的混合型基金 |
| 普通股票型基金 | 标准股票型基金 |
| 灵活配置型基金 | 仓位灵活配置的混合型基金 |

**注意**：其他类型的资产（如纯债基金、货币基金等）不在检测范围内，即使未分类也不会提示。

---

## 检测逻辑

### 检测条件（同时满足）

1. **资产小类属于检测范围**
   - 持仓表中的"新版资产小类"字段值是上述5种之一

2. **有有效的匹配键**
   - 外部代码不为空，或资产代码不为空

3. **未在基金分类表中找到匹配**
   - 根据外部代码或资产代码在基金分类表中查找，未找到对应记录

### 检测流程

```
持仓表每条记录
    ↓
检查"新版资产小类"是否在检测范围内？
    ↓ 是
提取匹配键（外部代码 或 资产代码）
    ↓
在基金分类表中查找匹配键
    ↓
找到了？
    ↓ 否
加入未分类含权基金列表
```

---

## 提示信息

### 情况1：所有含权基金都已分类 ✅

显示绿色提示框：

```
✅ 含权基金均已导入和分类完成

已检测的含权资产类别：被动指数型基金、混合债券型二级基金、偏股混合型基金、普通股票型基金、灵活配置型基金

所有上述类别的基金都已在基金分类表中找到对应的分类信息，可以正常进行分析计算。

[隐藏此提示]
```

### 情况2：发现未分类的含权基金 ⚠️

显示橙色警告框：

```
⚠️ 发现未分类的含权基金

在持仓表中检测到 X 个含权基金尚未在基金分类表中分类，请在基金分类表中补充以下基金的分类信息：

┌─────────────────────────────────────────────────────────────┐
│ 基金名称              │ 资产小类        │ 外部代码   │ 资产代码 │
├─────────────────────────────────────────────────────────────┤
│ 国泰中证煤炭ETF      │ 被动指数型基金  │ 515220.SH │ -        │
│ 南方中证A500ETF      │ 被动指数型基金  │ 159352.SZ │ -        │
└─────────────────────────────────────────────────────────────┘

📝 操作建议：
1. 在基金分类表（Excel）中添加上述基金的分类信息（资产类别、风格、权益仓位）
2. 确保基金分类表中的外部代码或资产代码与上表中显示的代码一致
3. 保存基金分类表后，重新上传基金分类表和持仓明细表

[暂时隐藏]
```

---

## 使用示例

### 示例1：完整的分类流程

**步骤1：上传基金分类表**
- 包含72个基金的分类信息

**步骤2：上传持仓明细表**
- 包含100条持仓记录
- 其中15条是被动指数型基金
- 10条是混合债券型二级基金
- 5条是偏股混合型基金

**检测结果：**
- 如果这30个基金都在分类表中有分类 → 显示"✅ 含权基金均已导入和分类完成"
- 如果有3个基金未在分类表中 → 显示警告框，列出这3个基金的详细信息

### 示例2：部分匹配

**持仓表中的基金：**
```
1. 国泰中证煤炭ETF (515220.SH) - 被动指数型基金
2. 南方中证A500ETF (159352.SZ) - 被动指数型基金
3. 景顺景颐双利 (002351.OF) - 混合债券型二级基金
```

**基金分类表中的基金：**
```
1. 515220.SH - 已分类
2. 002351.OF - 已分类
```

**检测结果：**
```
⚠️ 发现未分类的含权基金

在持仓表中检测到 1 个含权基金尚未在基金分类表中分类：

基金名称: 南方中证A500ETF
资产小类: 被动指数型基金
外部代码: 159352.SZ
资产代码: -
```

---

## 匹配规则说明

### 外部代码匹配优先

基金分类表：
```
外部代码: 515220.SH
资产代码: ABC123
```

持仓表：
```
外部代码: 515220.SH
资产代码: XYZ789
```

**结果**：✅ 匹配成功（使用外部代码）

### 资产代码备用匹配

基金分类表：
```
外部代码: (空)
资产代码: 80PF210158
```

持仓表：
```
外部代码: (空)
资产代码: 80PF210158
```

**结果**：✅ 匹配成功（使用资产代码）

### 代码不一致

基金分类表：
```
外部代码: 515220.SH
```

持仓表：
```
外部代码: 515999.SH
```

**结果**：❌ 匹配失败，会被提示需要分类

---

## 常见问题

### Q1: 为什么某些基金明明在基金分类表中，但还是提示未分类？

**可能原因：**
1. **外部代码不一致**
   - 分类表：`515220.SH`
   - 持仓表：`515220.sh`（大小写不同）
   - 解决：确保代码完全一致

2. **使用了不同的匹配键**
   - 分类表：使用外部代码 `515220.SH`
   - 持仓表：外部代码为空，使用资产代码 `ABC123`
   - 解决：在分类表中也添加对应的资产代码

3. **有空格或特殊字符**
   - 分类表：`515220.SH `（末尾有空格）
   - 持仓表：`515220.SH`
   - 解决：去除多余的空格和特殊字符

### Q2: 我的持仓表中有货币基金，为什么没有提示未分类？

**答**：系统只检测上述5类含权资产。货币基金、纯债基金等不在检测范围内，即使未分类也不会提示。

### Q3: 如何快速找到未分类基金在分类表中的位置？

**答**：
1. 打开基金分类表Excel文件
2. 使用 Ctrl+F 查找功能
3. 搜索提示中显示的外部代码或资产代码
4. 如果找不到，说明需要添加新行

### Q4: 提示中的外部代码和资产代码都是"-"怎么办？

**答**：这表示持仓表中这两个字段都为空，无法进行匹配。需要：
1. 检查持仓表数据是否完整
2. 补充外部代码或资产代码字段
3. 或在基金分类表中使用其他字段进行匹配（但需要修改代码）

### Q5: 可以自定义检测的资产类别吗？

**答**：可以。在代码中修改 `EQUITY_ASSET_CLASSES` 数组：

```javascript
const EQUITY_ASSET_CLASSES = [
    '被动指数型基金',
    '混合债券型二级基金',
    '偏股混合型基金',
    '普通股票型基金',
    '灵活配置型基金',
    // 添加新的类别
    '你的新类别'
];
```

---

## 技术实现

### 数据结构

```javascript
// 未分类含权基金Map
unclassifiedEquityFunds = {
    "515220.SH": {
        matchKey: "515220.SH",
        assetName: "国泰中证煤炭ETF",
        assetSubClass: "被动指数型基金",
        externalCode: "515220.SH",
        assetCode: ""
    },
    "159352.SZ": {
        matchKey: "159352.SZ",
        assetName: "南方中证A500ETF",
        assetSubClass: "被动指数型基金",
        externalCode: "159352.SZ",
        assetCode: ""
    }
}
```

### 核心代码

```javascript
// 在processData()中
holdingData.forEach(row => {
    const assetSubClass = normalizeText(row['新版资产小类']);
    const matchKey = getFundMatchKey(row);
    const classification = fundClassifications[matchKey];

    // 检测含权资产是否已分类
    if (!classification && matchKey && EQUITY_ASSET_CLASSES.includes(assetSubClass)) {
        if (!unclassifiedEquityFunds.has(matchKey)) {
            unclassifiedEquityFunds.set(matchKey, {
                matchKey: matchKey,
                assetName: normalizeText(row['资产简称']),
                assetSubClass: assetSubClass,
                externalCode: normalizeText(row['外部代码']),
                assetCode: normalizeText(row['资产代码'])
            });
        }
    }
});

// 渲染提示
renderUnclassifiedEquityFunds(unclassifiedEquityFunds);
```

---

## 测试建议

### 测试用例1：所有含权基金已分类

**准备数据：**
- 基金分类表：包含所有持仓表中的含权基金
- 持仓表：包含被动指数型、混合债券型二级等基金

**预期结果：**
- 显示绿色成功提示
- 提示"含权基金均已导入和分类完成"

### 测试用例2：部分含权基金未分类

**准备数据：**
- 基金分类表：缺少3个被动指数型基金
- 持仓表：包含10个被动指数型基金

**预期结果：**
- 显示橙色警告提示
- 列出3个未分类基金的详细信息
- 显示外部代码和资产代码

### 测试用例3：混合场景

**准备数据：**
- 基金分类表：完整
- 持仓表：包含被动指数型、纯债基金、货币基金

**预期结果：**
- 只检测被动指数型基金
- 纯债基金和货币基金不在检测范围内，不影响提示

---

**更新日期**: 2026-01-20
**版本**: v2.1
