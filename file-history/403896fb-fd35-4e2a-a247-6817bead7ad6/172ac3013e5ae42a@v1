# 基金分类标签管理系统 - 使用说明 v2.0

## 版本更新说明

**版本**: v2.0
**更新日期**: 2026-01-20

### 主要变更

1. **移除了基金分类设置模块** - 不再在网页中存储和管理基金分类数据
2. **改为双文件导入模式** - 需要分别上传基金分类表和持仓明细表
3. **优化了匹配逻辑** - 使用外部代码/资产代码进行精确匹配，避免资产名称不规范导致的匹配失败
4. **新增结果导出功能** - 可将分析结果导出为Excel文件，包含多个工作表

---

## 使用步骤

### 第一步：准备基金分类表

确保您的基金分类表（Excel文件）包含以下列：

| 列名 | 说明 | 示例 |
|------|------|------|
| 基金名称(PAS) | 基金名称 | 国泰中证煤炭ETF 515220.SH |
| 资产类别（PAS) | 资产类别 | 被动指数型基金 |
| 风格 | 投资风格 | 周期 |
| 权益仓位 | 权益仓位百分比 | 100 |
| **外部代码** | 外部代码（优先匹配） | 515220.SH |
| **资产代码** | 资产代码（备用匹配） | 80PF210158 |

**重要提示**：
- 外部代码和资产代码至少要有一个有值
- 系统优先使用外部代码匹配，如果外部代码为空则使用资产代码
- 风格必须是以下5种之一：**红利、均衡、科技成长、周期、价值**
- 权益仓位范围：0-100

### 第二步：准备持仓明细表

确保您的持仓明细表（Excel文件）包含以下列：

| 列名 | 说明 |
|------|------|
| 产品简称 | 理财产品名称 |
| 资产简称 | 基金/资产名称 |
| **外部代码** | 外部代码 |
| **资产代码** | 资产代码 |
| 日终市值(元)-产品法估值 | 持仓金额 |

**重要提示**：
- 外部代码/资产代码会与基金分类表中的对应字段进行匹配
- 资产简称包含"正回购"的记录会自动从净资产中扣除

### 第三步：上传文件

1. **先上传基金分类表**
   - 点击"📋 1. 基金分类表"区域的"选择分类表"按钮
   - 选择您的基金分类Excel文件
   - 等待系统提示"✅ 成功加载 XX 个基金分类"

2. **再上传持仓明细表**
   - 点击"📊 2. 持仓明细表"区域的"选择持仓表"按钮
   - 选择您的持仓明细Excel文件
   - 系统会自动进行数据处理和分析

**注意**：必须先上传基金分类表，否则系统会提示错误。

### 第四步：查看分析结果

系统会自动显示以下内容：

1. **汇总统计**
   - 产品数量
   - 风格数量
   - 总权益暴露

2. **产品风格矩阵表**
   - 可切换显示金额或占比
   - 可筛选产品（全选/全不选/单选）
   - 风格按固定顺序排列：红利、均衡、科技成长、周期、价值

3. **产品卡片**
   - 每个产品的环形图
   - 各风格的金额和占比

4. **详细数据表格**
   - 每条持仓记录的详细信息
   - 按产品名称、风格、权益暴露占比排序

### 第五步：导出结果

点击"📥 导出分析结果到Excel"按钮，系统会生成包含3个工作表的Excel文件：

| 工作表名称 | 内容 |
|-----------|------|
| 产品风格汇总-金额 | 各产品在不同风格上的权益暴露金额（万元） |
| 产品风格汇总-占比 | 各产品在不同风格上的权益暴露占比（%） |
| 持仓明细 | 详细的持仓数据，包含基金名称、资产类别、风格、权益仓位、持仓金额、权益暴露金额、权益暴露占比 |

**导出说明**：
- 只导出当前筛选选中的产品数据
- 金额单位：万元，整数
- 占比单位：百分比（%）
- 文件名格式：`基金分析结果_YYYY-MM-DD.xlsx`

---

## 匹配逻辑说明

### 基金匹配规则

系统使用以下规则匹配持仓表和基金分类表：

```
匹配键 = 持仓表的外部代码 或 资产代码
```

**具体步骤**：
1. 从持仓表中提取每条记录的外部代码
2. 如果外部代码为空，则使用资产代码
3. 使用该匹配键在基金分类表中查找对应的分类信息
4. 如果找到匹配，则使用分类表中的风格和权益仓位进行计算
5. 如果未找到匹配，该条记录不参与权益暴露计算

**示例**：

持仓表中的记录：
```
外部代码: 515220.SH
资产代码: (空)
资产简称: 国泰中证煤炭ETF
```

基金分类表中的记录：
```
外部代码: 515220.SH
风格: 周期
权益仓位: 100
```

**匹配成功**：使用外部代码 `515220.SH` 成功匹配

---

## 计算公式

### 产品净资产
```
产品净资产 = Σ持仓金额 - 正回购金额
```

### 权益暴露金额
```
权益暴露金额 = 持仓金额 × (权益仓位 / 100)
```

### 风格权益暴露占比
```
风格占比 = (该风格权益暴露金额之和 / 该产品所有风格权益暴露金额之和) × 100%
```

### 详细表格权益暴露占比
```
权益暴露占比 = (该持仓权益暴露金额 / 产品净资产) × 100%
```

---

## 常见问题

### Q1: 为什么上传持仓表时提示"请先上传基金分类表"？
**A**: 系统需要先加载基金分类数据才能进行匹配和计算。请确保先上传基金分类表。

### Q2: 如何知道有多少持仓记录成功匹配？
**A**: 上传持仓表后，系统会显示类似"✅ 数据处理完成: 成功匹配 XX 条持仓, 未匹配 XX 条"的提示。您也可以在浏览器控制台查看详细的匹配日志。

### Q3: 为什么某些基金没有被计算到权益暴露中？
**A**: 可能的原因：
1. 该基金的外部代码和资产代码都为空
2. 基金分类表中没有对应的记录
3. 该基金的外部代码/资产代码与分类表中的不匹配

### Q4: 如何更新基金分类数据？
**A**: 直接修改您的基金分类Excel文件，然后重新上传即可。系统不会保存分类数据，每次都需要重新上传。

### Q5: 导出的Excel文件中为什么只有部分产品？
**A**: 导出功能只导出当前在产品筛选器中选中的产品。请检查产品筛选器的选择状态。

### Q6: 正回购是如何处理的？
**A**: 系统会自动检测资产简称中包含"正回购"的记录，并从产品净资产中减去这些金额。

---

## 技术支持

如有问题，请检查：
1. Excel文件格式是否正确
2. 列名是否完全匹配（区分大小写）
3. 浏览器控制台是否有错误信息

**系统要求**：
- 现代浏览器（Chrome 70+, Firefox 65+, Safari 12+, Edge 79+）
- 支持JavaScript
- 不需要网络连接（完全离线运行）

---

**版本历史**：
- v2.0 (2026-01-20): 改为双文件导入模式，优化匹配逻辑，新增导出功能
- v1.1.0: 智能基金检测与批量添加功能
- v1.0.0: 初始版本
