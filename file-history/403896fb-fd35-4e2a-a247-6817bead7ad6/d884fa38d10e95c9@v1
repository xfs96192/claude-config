# 基金分类标签管理系统 - 完整技术规格说明书

## 1. 项目概述

### 1.1 项目定位
本系统是一个专为银行理财资管机构设计的**基金分类与权益暴露分析系统**,用于计算和可视化多个理财产品的权益暴露情况。

### 1.2 核心功能
- 上传并解析Excel持仓明细表
- 自动识别未分类的含权益基金
- 管理基金的分类标签(风格、权益仓位)
- 计算各产品按不同风格的权益暴露金额和占比
- 多维度数据可视化(图表、矩阵、详细表格)

### 1.3 技术架构
- **类型**: 纯前端单页应用(Single Page Application)
- **离线能力**: 完全支持离线运行,无需联网(内网部署场景)
- **存储**: 使用浏览器LocalStorage持久化基金分类数据
- **文件结构**: 单一HTML文件包含所有功能
- **依赖库**:
  - `xlsx.full.min.js` (SheetJS) - Excel文件解析
  - `chart.js` (v4.5.0+) - 数据可视化

## 2. 数据结构规格

### 2.1 Excel输入文件格式

**必需列名**(列名必须精确匹配):
```
产品简称         - 产品名称
资产代码         - 资产的内部代码
外部代码         - 资产的外部标识码(如基金代码)
资产简称         - 资产名称
日终市值(元)-产品法估值  - 持仓金额(数值型)
新版资产大类      - 一级分类(如"公募基金"、"委外投资"等)
新版资产小类      - 二级分类(如"公募股票基金"、"公募混合基金"等)
```

**Excel文件示例数据**:
```
产品简称: 丰利逸动10个月最短持有期日开2号增强型
资产代码: 80PF2216281
外部代码: 011691.OF
资产简称: 招商品质发现混合型证券投资基金
日终市值(元)-产品法估值: 2760134.15
新版资产大类: 公募基金
新版资产小类: 公募混合基金
```

### 2.2 基金分类数据结构

基金分类数据使用JavaScript对象存储,键为**匹配键**,值为分类信息对象:

```javascript
const fundClassifications = {
    "011691.OF": {                    // 匹配键(外部代码或资产简称)
        "assetClass": "公募混合基金",   // 资产小类
        "style": "均衡",               // 投资风格
        "equityPosition": 100          // 权益仓位百分比(0-100)
    },
    "002361.OF": {
        "assetClass": "二级公募债券基金",
        "style": "均衡",
        "equityPosition": 20
    }
}
```

**投资风格枚举值**(共5种):
- `红利` - 红利/高股息策略
- `均衡` - 均衡配置策略
- `科技成长` - 科技成长策略
- `周期` - 周期行业策略
- `价值` - 价值投资策略

**资产小类枚举值**(含权益类):
- `公募股票基金`
- `普通股票型基金`
- `公募混合基金`
- `偏股混合型基金`
- `灵活配置型基金`
- `二级公募债券基金`
- `混合债券型二级基金`
- `其他公募基金`
- `被动指数型基金`
- `国际(QDII)被动指数型股票基金`
- `委外非现固定收益类资产`
- `委外混合类资产`
- `委外权益类投资`

### 2.3 未分类基金对象结构

```javascript
{
    assetName: "招商品质发现混合型证券投资基金",  // 基金名称
    matchKey: "011691.OF",                      // 匹配键
    externalCode: "011691.OF",                  // 外部代码
    assetSubClass: "公募混合基金",               // 资产小类
    style: "",                                  // 待设置的风格
    equityPosition: 100                         // 默认权益仓位
}
```

## 3. 核心计算逻辑(重点)

### 3.1 基金匹配逻辑

**匹配键生成规则**(getFundMatchKey函数):
```
IF 新版资产大类 == "公募基金" AND 外部代码不为空:
    匹配键 = 外部代码
ELSE IF 新版资产大类 == "委外投资" AND 资产代码不为空:
    匹配键 = 资产代码
ELSE:
    匹配键 = 资产简称
```

**示例**:
- 公募基金: 招商品质发现混合型证券投资基金 → 匹配键: `011691.OF` (外部代码)
- 委外投资: 兴业信托·兴享稳鑫12号 → 匹配键: `11PF242490` (资产代码)
- 其他: 华泰柏瑞红利ETF ( 510880.SH ) → 匹配键: `华泰柏瑞红利ETF ( 510880.SH )` (资产简称)

### 3.2 净资产计算公式

**产品净资产** = 总持仓金额 - 正回购金额

```javascript
// 伪代码
产品净资产 = 0
FOR EACH 持仓记录 IN 产品所有持仓:
    IF 资产简称包含"正回购":
        产品净资产 -= 持仓金额    // 正回购需要减去
    ELSE:
        产品净资产 += 持仓金额
END FOR
```

**示例计算**:
```
产品A持仓:
  - 招商品质发现混合基金: 2,760,134.15元
  - 博道盛彦混合基金: 2,804,248.70元
  - 正回购(银行间): -10,000,000.00元
  - 托管账户: 17,263,030.00元

产品净资产 = 2,760,134.15 + 2,804,248.70 - 10,000,000 + 17,263,030 = 12,827,412.85元
```

### 3.3 权益暴露计算公式

**权益暴露金额** = 持仓金额 × (权益仓位 / 100)

```javascript
// 示例
持仓金额 = 2,760,134.15元
权益仓位 = 100%
权益暴露金额 = 2,760,134.15 × (100/100) = 2,760,134.15元

持仓金额 = 5,080,751.37元
权益仓位 = 20%
权益暴露金额 = 5,080,751.37 × (20/100) = 1,016,150.27元
```

### 3.4 风格权益暴露占比计算

**单一产品的某风格权益暴露占比** = (该风格下所有基金的权益暴露金额之和 / 该产品所有风格权益暴露金额之和) × 100%

```javascript
// 计算步骤
步骤1: 计算每个基金的权益暴露金额
步骤2: 按风格分组累加权益暴露金额
步骤3: 计算总权益暴露金额
步骤4: 计算各风格占比

// 示例
产品A基金持仓:
  - 招商品质发现(均衡, 100%): 持仓276万 → 权益暴露276万
  - 博道盛彦(科技成长, 100%): 持仓280万 → 权益暴露280万
  - 景顺长城景颐双利(均衡, 20%): 持仓508万 → 权益暴露101.6万

按风格汇总:
  均衡风格总暴露 = 276 + 101.6 = 377.6万
  科技成长风格总暴露 = 280万

总权益暴露 = 377.6 + 280 = 657.6万

风格占比:
  均衡占比 = 377.6 / 657.6 × 100% = 57.4%
  科技成长占比 = 280 / 657.6 × 100% = 42.6%
```

### 3.5 权益暴露占比(详细表格中)

**详细表格中的权益暴露占比** = (该持仓的权益暴露金额 / 该产品净资产) × 100%

```javascript
// 示例
招商品质发现混合基金:
  持仓金额 = 2,760,134.15元
  权益仓位 = 100%
  权益暴露金额 = 2,760,134.15元
  产品净资产 = 12,827,412.85元
  权益暴露占比 = (2,760,134.15 / 12,827,412.85) × 100% = 21.51%
```

### 3.6 含权益基金自动检测规则

**检测条件**:
```
新版资产大类 == "公募基金"
AND
新版资产小类 IN [
    "公募股票基金", "普通股票型基金", "公募混合基金",
    "偏股混合型基金", "灵活配置型基金", "二级公募债券基金",
    "混合债券型二级基金", "其他公募基金", "被动指数型基金",
    "国际(QDII)被动指数型股票基金"
]
AND
该基金的匹配键不在fundClassifications中
```

**默认权益仓位规则**:
```javascript
const defaultEquityBySubClass = {
    "公募股票基金": 100,
    "普通股票型基金": 100,
    "公募混合基金": 100,
    "偏股混合型基金": 80,
    "灵活配置型基金": 80,
    "二级公募债券基金": 20,
    "混合债券型二级基金": 20,
    "其他公募基金": 100,
    "被动指数型基金": 100,
    "国际(QDII)被动指数型股票基金": 100
}
```

## 4. 功能模块详细说明

### 4.1 文件上传模块

**支持方式**:
1. 点击按钮选择文件
2. 拖拽文件到上传区域

**文件格式**: `.xlsx`, `.xls`

**处理流程**:
```
1. 用户选择/拖拽Excel文件
2. 使用FileReader读取文件为ArrayBuffer
3. 使用XLSX.read()解析文件
4. 使用XLSX.utils.sheet_to_json()转换为JSON数组
5. 存储到holdingData全局变量
6. 调用processData()处理数据
7. 显示成功提示信息
```

**错误处理**:
- 文件读取失败: 显示"文件处理失败"错误信息
- 数据格式错误: 在控制台输出错误详情

### 4.2 基金分类管理模块

#### 4.2.1 查看基金列表
- 显示所有已分类基金
- 每个基金显示: 匹配键(只读)、资产小类、风格、权益仓位
- 基金列表可滚动,最大高度600px

#### 4.2.2 添加新基金
**表单字段**:
- 资产小类(下拉选择)
- 资产简称(文本输入)
- 风格(下拉选择)
- 权益仓位(数字输入, 0-100)

**验证规则**:
- 资产简称不能为空
- 权益仓位必须在0-100之间
- 基金名称不能重复

**添加流程**:
1. 填写表单
2. 点击"添加基金"按钮
3. 验证输入数据
4. 添加到fundClassifications对象
5. 保存到LocalStorage
6. 刷新基金列表
7. 如果有持仓数据,重新处理数据

#### 4.2.3 修改基金信息
- 直接在列表中修改下拉框或输入框
- onChange事件触发updateFund()函数
- 自动保存到LocalStorage
- 自动重新计算分析结果

#### 4.2.4 删除基金
- 点击删除按钮
- 弹出确认对话框
- 确认后从fundClassifications删除
- 保存到LocalStorage
- 刷新界面

### 4.3 智能基金检测模块

#### 4.3.1 检测逻辑
在processData()函数中,遍历所有持仓记录:
```javascript
1. 获取匹配键
2. 检查是否已在fundClassifications中
3. 检查是否为公募基金
4. 检查资产小类是否在含权益类别中
5. 如果满足所有条件且未分类,添加到unclassifiedFunds数组
```

#### 4.3.2 检测状态显示
**已全部分类**:
- 显示绿色成功提示框
- 显示统计数据: 总持仓记录数、已分类基金记录数、未分类含权基金数
- 显示检测条件说明
- 提供隐藏按钮

**发现未分类基金**:
- 隐藏状态提示区域
- 显示未分类基金列表区域

#### 4.3.3 未分类基金批量处理
**列表显示**:
- 表头: 基金名称、资产类型、风格、权益仓位、操作
- 每行显示一个未分类基金
- 风格下拉框(默认为空,需要用户选择)
- 权益仓位输入框(自动填充默认值)
- 单个添加按钮

**批量添加功能**:
1. 检查所有基金是否都设置了风格
2. 检查权益仓位是否都有效
3. 弹出确认对话框
4. 批量添加到fundClassifications
5. 保存到LocalStorage
6. 清空未分类列表
7. 重新处理数据

**单个添加功能**:
1. 验证风格已选择
2. 验证权益仓位有效
3. 添加到fundClassifications(使用matchKey作为键)
4. 从未分类列表移除
5. 重新处理数据

### 4.4 数据分析与可视化模块

#### 4.4.1 汇总统计卡片
显示3个统计卡片:
- 产品数量
- 风格数量
- 总权益暴露(单位:亿元,保留1位小数)

#### 4.4.2 产品筛选器
- 每个产品一个复选框
- 默认全部选中
- 全选/全不选按钮
- 选择变化时更新矩阵表格、产品卡片、详细数据表格

#### 4.4.3 矩阵汇总表格
**表格结构**:
- 行: 产品名称(仅显示选中的产品)
- 列: 投资风格(按顺序: 红利、均衡、科技成长、周期、价值)
- 单元格: 金额或占比(可切换)

**风格列排序规则**:
```javascript
const styleOrder = ['红利', '均衡', '科技成长', '周期', '价值'];
// 红利固定在第一列(产品名称右边)
```

**显示模式切换**:
- 金额模式: 显示"XXX万"(四舍五入到整数)
- 占比模式: 显示"XX%"(四舍五入到整数,不保留小数)

**样式规则**:
- 产品名称列: 浅蓝色背景,加粗,左对齐
- 金额单元格: 蓝色文字,加粗,居中
- 占比单元格: 绿色文字,加粗,居中
- 空值单元格: 灰色"-",斜体

#### 4.4.4 产品卡片与图表
**每个产品显示**:
- 卡片标题: 产品名称
- 风格列表: 每个风格显示金额(万元,整数)和占比(整数%)
- 环形图(Doughnut Chart):
  - 显示各风格占比
  - 图例在底部
  - 使用渐变色彩方案

**风格排序**:
- 与矩阵表格一致,红利优先

**Chart.js配置**:
```javascript
{
    type: 'doughnut',
    data: {
        labels: [...styles],
        datasets: [{
            data: [...percentages],
            backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: { padding: 20, usePointStyle: true }
            }
        }
    }
}
```

#### 4.4.5 详细数据表格
**表格列**:
1. 产品名称
2. 基金名称
3. 资产小类
4. 风格
5. 权益仓位(百分比)
6. 持仓金额(万元,整数)
7. 权益暴露金额(万元,整数)
8. 权益暴露占比(百分比,保留2位小数)

**数据筛选**:
- 仅显示产品筛选器中选中的产品的数据
- 排除未分类的基金

**排序规则**:
```javascript
排序优先级:
1. 产品名称(字母升序)
2. 风格(字母升序)
3. 权益暴露占比(数值降序)
```

**权益暴露占比计算**:
```
权益暴露占比 = (权益暴露金额 / 产品净资产) × 100%
```

### 4.5 数据持久化模块

#### 4.5.1 LocalStorage存储
**存储键**: `fund_classifications_data`

**存储内容**: JSON字符串
```javascript
{
    "011691.OF": {
        "assetClass": "公募混合基金",
        "style": "均衡",
        "equityPosition": 100
    },
    ...
}
```

**自动保存时机**:
- 添加新基金
- 修改基金信息
- 删除基金
- 批量导入基金
- 恢复默认设置

#### 4.5.2 数据导出功能
**导出格式**: JSON文件

**文件名**: `基金分类数据_YYYY-MM-DD.json`

**导出内容**:
```javascript
{
    "version": "1.1.0",
    "exportTime": "2026-01-12T10:30:00.000Z",
    "fundClassifications": { ... },
    "totalFunds": 66
}
```

#### 4.5.3 数据导入功能
**导入流程**:
1. 用户选择JSON文件
2. 读取文件内容
3. 解析JSON
4. 验证数据格式(必须包含fundClassifications字段)
5. 弹出确认对话框(显示导入数量)
6. 替换当前数据
7. 保存到LocalStorage
8. 刷新界面

#### 4.5.4 更新HTML代码功能
**目的**: 将新增的基金分类代码化,便于更新HTML文件

**生成内容**:
1. 检测新增基金(不在defaultFundClassifications中)
2. 生成JavaScript代码片段
3. 复制到剪贴板
4. 弹出提示显示新增基金列表

#### 4.5.5 恢复默认功能
- 弹出确认对话框
- 重置fundClassifications为defaultFundClassifications
- 保存到LocalStorage
- 刷新界面

## 5. 用户界面规范

### 5.1 整体设计风格
- 现代化扁平设计
- 渐变紫色主题色(#667eea到#764ba2)
- 圆角边框(8-15px)
- 阴影效果营造层次感
- 响应式布局

### 5.2 颜色规范
- 主色调: `#667eea` (紫色)
- 次要色: `#764ba2` (深紫)
- 成功色: `#16a34a` (绿色)
- 错误色: `#ef4444` (红色)
- 警告色: `#ff6b35` (橙色)
- 信息色: `#0ea5e9` (蓝色)
- 背景色: `#f5f5f7` (浅灰)
- 卡片背景: `#ffffff` (白色)
- 边框色: `#e2e8f0` (灰色)

### 5.3 按钮样式
**主按钮** (.btn-primary):
- 背景: `#667eea`
- 文字: 白色
- Hover: `#5a67d8`

**危险按钮** (.btn-danger):
- 背景: `#ef4444`
- 文字: 白色
- Hover: `#dc2626`

### 5.4 表单元素
- 输入框/下拉框:
  - 边框: `1px solid #d1d5db`
  - 圆角: `6px`
  - Focus: 边框色`#667eea`, 蓝色阴影
- 内边距: `8-10px`

### 5.5 上传区域
- 虚线边框: `2px dashed #667eea`
- 背景: `#f8f9ff`
- Hover: 边框色`#5a67d8`, 背景`#f0f2ff`
- 拖拽时: 背景`#e6f3ff`

### 5.6 响应式设计
**断点**: 768px

**小屏幕调整** (max-width: 768px):
- 基金设置区域: 单列布局
- 基金列表项: 单列布局
- 结果网格: 单列布局

## 6. 技术实现细节

### 6.1 文件结构
```
fund_analysis.html
├── <head>
│   ├── 字符集、视口设置
│   ├── 标题
│   ├── 外部JS引用(xlsx.full.min.js, chart.js)
│   └── <style> 全部CSS样式
└── <body>
    ├── HTML结构
    └── <script> 全部JavaScript代码
```

### 6.2 全局变量
```javascript
// 默认基金分类(硬编码)
const defaultFundClassifications = { ... };

// 存储键
const STORAGE_KEY = 'fund_classifications_data';

// 含权益资产小类及其默认权益仓位
const FUND_EQUITY_SUBCLASS_RULES = { ... };
const FUND_EQUITY_SUBCLASS_NAMES = [...];

// 运行时变量
let fundClassifications = {};    // 当前基金分类数据
let holdingData = [];            // Excel解析后的持仓数据
let analysisResults = {};        // 分析结果{产品名: {风格: {amount, percentage}}}
let selectedProducts = new Set(); // 选中的产品集合
let matrixDisplayType = 'amount'; // 矩阵显示类型
let unclassifiedFunds = [];      // 未分类基金数组
```

### 6.3 核心函数清单

#### 数据处理函数
- `normalizeText(value)` - 文本标准化(去除前后空格)
- `getFundMatchKey(row)` - 生成基金匹配键
- `processData()` - 处理Excel数据,计算分析结果
- `calculateDetailData()` - 计算详细数据表格数据

#### UI渲染函数
- `renderFundList()` - 渲染基金列表
- `renderResults()` - 渲染分析结果(调用子函数)
- `renderSummaryStats()` - 渲染汇总统计
- `renderProductFilters()` - 渲染产品筛选器
- `renderMatrixTable()` - 渲染矩阵表格
- `renderProductCards()` - 渲染产品卡片
- `renderDetailTable(data)` - 渲染详细数据表格
- `renderFundDetectionStatus()` - 渲染检测状态
- `renderUnclassifiedFunds()` - 渲染未分类基金列表

#### 交互函数
- `handleFileUpload(event)` - 处理文件上传
- `toggleProductFilter(productName)` - 切换产品筛选
- `toggleMatrixDisplay(type)` - 切换矩阵显示类型
- `selectAllProducts()` - 全选产品
- `deselectAllProducts()` - 全不选产品
- `createChart(productName, data)` - 创建Chart.js图表

#### 基金管理函数
- `addFund()` - 添加新基金
- `updateFund(fundName, property, value)` - 更新基金信息
- `deleteFund(fundName)` - 删除基金
- `updateUnclassifiedFund(index, property, value)` - 更新未分类基金
- `addSingleUnclassifiedFund(index)` - 添加单个未分类基金
- `batchAddUnclassifiedFunds()` - 批量添加未分类基金

#### 数据持久化函数
- `loadFundClassifications()` - 从LocalStorage加载
- `saveFundClassifications()` - 保存到LocalStorage
- `exportFundData()` - 导出JSON文件
- `importFundData(event)` - 导入JSON文件
- `updateHtmlWithNewFunds()` - 生成代码片段
- `resetToDefaults()` - 恢复默认数据

#### 辅助函数
- `hideUnclassifiedFunds()` - 隐藏未分类基金区域
- `hideFundDetectionStatus()` - 隐藏检测状态区域
- `setupFileUpload()` - 设置文件上传功能

### 6.4 事件监听
```javascript
// DOM加载完成
document.addEventListener('DOMContentLoaded', function() {
    renderFundList();
    setupFileUpload();
});

// 文件输入
fileInput.addEventListener('change', handleFileUpload);

// 拖拽上传
uploadArea.addEventListener('dragover', ...);
uploadArea.addEventListener('dragleave', ...);
uploadArea.addEventListener('drop', ...);
```

### 6.5 数据流图
```
用户上传Excel
    ↓
FileReader读取 → XLSX解析 → JSON数组
    ↓
holdingData存储
    ↓
processData()处理
    ├→ 计算产品净资产(扣除正回购)
    ├→ 检测未分类基金
    ├→ 匹配基金分类
    ├→ 计算权益暴露金额
    ├→ 按产品和风格分组汇总
    └→ 计算占比
    ↓
analysisResults存储
    ↓
多维度渲染
    ├→ 汇总统计卡片
    ├→ 矩阵表格
    ├→ 产品卡片+图表
    └→ 详细数据表格
```

## 7. 边界情况与错误处理

### 7.1 数据缺失
- 产品简称为空: 跳过该记录
- 资产简称为空: 跳过该记录
- 日终市值为0或无效: 跳过该记录
- 外部代码为空: 使用资产简称作为匹配键

### 7.2 数据验证
- 权益仓位必须0-100: 输入框min/max限制,JavaScript验证
- 重复基金名: 添加前检查,弹出警告
- 空基金名: 添加前检查,弹出警告
- 无效JSON导入: try-catch捕获,弹出错误提示

### 7.3 除零保护
```javascript
// 计算占比时
percentage = totalEquity > 0 ? (amount / totalEquity) * 100 : 0

// 计算权益暴露占比时
equityExposureRatio = productNetAsset > 0 ?
    (equityExposure / productNetAsset * 100) : 0
```

### 7.4 LocalStorage异常
```javascript
try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
} catch (error) {
    console.error('保存失败:', error);
    // 继续运行,不中断
}
```

### 7.5 Chart.js渲染失败
- 使用setTimeout延迟100ms创建图表,确保DOM准备就绪
- 检查canvas元素存在性
- 图表创建失败不影响其他功能

## 8. 性能优化

### 8.1 数据处理
- 使用Set去重未分类基金
- 避免重复计算净资产(先计算一次存储)
- 按需计算详细数据(仅在渲染表格时)

### 8.2 UI渲染
- 仅渲染选中的产品(减少DOM操作)
- 图表延迟创建(setTimeout)
- 表格虚拟滚动(最大高度限制)

### 8.3 事件处理
- onChange直接绑定,避免事件委托复杂度
- 批量操作前弹窗确认

## 9. 浏览器兼容性

### 9.1 目标浏览器
- Chrome 70+
- Firefox 65+
- Safari 12+
- Edge 79+(Chromium内核)

### 9.2 核心API依赖
- FileReader API
- LocalStorage API
- ES6语法(箭头函数、模板字符串、解构赋值等)
- Fetch API(未使用)
- Clipboard API(navigator.clipboard.writeText)

### 9.3 兼容性处理
- 使用Blob生成下载链接(兼容旧浏览器)
- Clipboard API失败时使用alert显示文本

## 10. 测试用例

### 10.1 文件上传测试
- 上传有效xlsx文件 → 成功解析并显示数据
- 上传无效文件 → 显示错误提示
- 拖拽文件 → 正常处理
- 上传空文件 → 显示0条数据

### 10.2 计算逻辑测试
**测试案例1**: 正回购扣除
```
输入:
  - 基金A: 1000万
  - 正回购: -500万
  - 现金: 200万
预期净资产: 1000 - 500 + 200 = 700万
```

**测试案例2**: 权益暴露计算
```
输入:
  - 二级债基,权益仓位20%,持仓100万
预期权益暴露: 100 × 20% = 20万
```

**测试案例3**: 占比计算
```
输入:
  - 均衡风格: 300万
  - 成长风格: 200万
预期占比: 均衡60%, 成长40%
```

### 10.3 未分类基金检测测试
```
输入:
  - 新基金"测试基金A",外部代码"123456.OF",资产小类"公募股票基金"
  - fundClassifications中不存在"123456.OF"
预期: 检测到1个未分类基金,默认权益仓位100%
```

### 10.4 数据持久化测试
- 添加新基金 → LocalStorage更新
- 刷新页面 → 数据保留
- 导出JSON → 文件包含所有基金
- 导入JSON → 数据正确替换

## 11. 部署说明

### 11.1 文件准备
```
部署文件夹/
├── fund_analysis.html      (主文件)
├── xlsx.full.min.js        (必需,离线)
└── chart.js                (必需,离线,或使用chart.umd.js)
```

### 11.2 离线部署
1. 下载xlsx.full.min.js到本地
2. 下载chart.js (v4.5.0+) 到本地
3. 修改HTML中的引用路径:
```html
<script src="xlsx.full.min.js"></script>
<script src="chart.js"></script>
```
4. 将所有文件放在同一目录
5. 双击fund_analysis.html打开

### 11.3 服务器部署
1. 将所有文件上传到Web服务器
2. 配置MIME类型:
   - .html → text/html
   - .js → application/javascript
3. 访问: http://your-server/fund_analysis.html

### 11.4 内网部署注意事项
- 确保不引用外部CDN资源
- 所有JS库必须本地化
- 测试离线访问功能正常

## 12. 扩展性设计

### 12.1 新增投资风格
1. 更新风格下拉框选项
2. 更新styleOrder数组
3. 添加对应颜色到Chart.js配置

### 12.2 新增资产小类
1. 更新资产小类下拉框
2. 更新FUND_EQUITY_SUBCLASS_RULES(如果是含权益类)
3. 重新生成FUND_EQUITY_SUBCLASS_NAMES

### 12.3 自定义计算逻辑
- 修改calculateExposure相关代码段
- 修改processData函数

### 12.4 数据库后端集成
**可扩展点**:
- 替换LocalStorage为API调用
- 修改loadFundClassifications/saveFundClassifications函数
- 添加身份认证逻辑

## 13. 常见问题与解决方案

### 13.1 Excel文件无法解析
**原因**:
- 文件格式不兼容(如.csv)
- 文件损坏
- 列名不匹配

**解决**:
- 检查文件扩展名
- 用Excel重新保存
- 对照列名列表检查

### 13.2 基金无法匹配
**原因**:
- 匹配键生成逻辑不一致
- 基金名称有空格差异

**解决**:
- 检查控制台日志查看实际匹配键
- 使用完全相同的名称添加基金
- 检查外部代码/资产代码是否正确

### 13.3 数据丢失
**原因**:
- LocalStorage被清除
- 浏览器隐私模式

**解决**:
- 定期导出JSON备份
- 使用正常浏览器模式
- 恢复导出的JSON文件

### 13.4 图表不显示
**原因**:
- Chart.js未加载
- canvas元素未找到

**解决**:
- 检查chart.js文件路径
- 检查控制台错误
- 刷新页面重试

## 14. 完整HTML文件生成指南

### 14.1 文件头部模板
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>基金分类标签管理系统</title>
    <script src="xlsx.full.min.js"></script>
    <script src="chart.js"></script>
    <style>
        /* 所有CSS样式(参见第5章) */
    </style>
</head>
```

### 14.2 HTML主体结构模板
```html
<body>
    <div class="container">
        <!-- 1. 标题区域 -->
        <div class="header">...</div>

        <!-- 2. 文件上传区域 -->
        <div class="section">...</div>

        <!-- 3. 基金分类设置区域 -->
        <div class="section">...</div>

        <!-- 4. 基金检测状态区域 -->
        <div class="section" id="fundDetectionStatusSection" style="display: none;">...</div>

        <!-- 5. 未分类基金区域 -->
        <div class="section" id="unclassifiedFundsSection" style="display: none;">...</div>

        <!-- 6. 分析结果区域 -->
        <div class="section">...</div>

        <!-- 7. 详细数据表格区域 -->
        <div class="section">...</div>
    </div>

    <script>
        /* 所有JavaScript代码(参见第6章) */
    </script>
</body>
</html>
```

### 14.3 关键HTML元素ID清单
```
文件上传相关:
- fileInput: 文件输入框
- uploadArea: 上传区域
- loading: 加载提示
- uploadResult: 上传结果显示

基金管理相关:
- fundList: 基金列表容器
- newAssetClass: 新建资产小类下拉框
- newAssetName: 新建资产简称输入框
- newStyle: 新建风格下拉框
- newEquityPosition: 新建权益仓位输入框
- importFile: 导入文件输入框

检测相关:
- fundDetectionStatusSection: 检测状态区域
- fundDetectionContent: 检测状态内容
- unclassifiedFundsSection: 未分类基金区域
- unclassifiedFundsList: 未分类基金列表

结果展示相关:
- summaryStats: 汇总统计容器
- productFilters: 产品筛选器容器
- matrixTable: 矩阵表格
- resultsGrid: 产品卡片网格
- detailTable: 详细数据表格
- detailTableBody: 详细数据表格tbody
```

## 15. 验收标准

### 15.1 功能完整性
- ✓ 能上传并解析Excel文件
- ✓ 能添加/修改/删除基金分类
- ✓ 能自动检测未分类含权益基金
- ✓ 能批量添加未分类基金
- ✓ 能导出/导入JSON数据
- ✓ 数据自动保存到LocalStorage
- ✓ 能筛选产品显示
- ✓ 能切换金额/占比显示
- ✓ 能生成环形图
- ✓ 详细表格正确排序

### 15.2 计算准确性
- ✓ 净资产正确扣除正回购
- ✓ 权益暴露金额 = 持仓金额 × 权益仓位
- ✓ 风格占比 = 该风格暴露 / 总暴露
- ✓ 详细表格权益暴露占比 = 暴露金额 / 产品净资产
- ✓ 所有百分比计算正确

### 15.3 UI/UX要求
- ✓ 界面美观,符合设计规范
- ✓ 操作流畅,无卡顿
- ✓ 错误提示清晰
- ✓ 响应式布局(移动端适配)
- ✓ 拖拽上传功能正常

### 15.4 数据一致性
- ✓ 修改基金后结果自动更新
- ✓ 刷新页面数据保留
- ✓ 导出导入数据一致
- ✓ 筛选产品后详细表格同步更新

### 15.5 离线运行
- ✓ 无外部CDN依赖
- ✓ 所有JS库本地化
- ✓ 断网可正常使用

## 16. 版本历史与更新日志

### v1.0.0 (初始版本)
- 基础文件上传和解析
- 基金分类管理
- 权益暴露计算
- 矩阵表格和图表展示

### v1.1.0 (当前版本)
- 新增智能基金检测功能
- 新增批量添加未分类基金功能
- 新增基金检测状态提示
- 优化基金匹配逻辑(支持外部代码/资产代码)
- 新增未分类基金列表显示
- 新增默认权益仓位规则
- 完善数据导出导入功能

## 17. 附录

### 17.1 默认基金分类数据(66个基金)
```javascript
// 见HTML文件中的defaultFundClassifications对象
// 包含66个预设基金的分类信息
```

### 17.2 含权益资产小类及默认仓位对照表
```
公募股票基金: 100%
普通股票型基金: 100%
公募混合基金: 100%
偏股混合型基金: 80%
灵活配置型基金: 80%
二级公募债券基金: 20%
混合债券型二级基金: 20%
其他公募基金: 100%
被动指数型基金: 100%
国际(QDII)被动指数型股票基金: 100%
```

### 17.3 投资风格及颜色映射
```
红利: #667eea
均衡: #764ba2
科技成长: #f093fb
周期: #f5576c
价值: #4facfe
```

---

**文档版本**: v1.1.0
**最后更新**: 2026-01-20
**适用系统版本**: 基金分类标签管理系统 v1.1.0
**编写目的**: 供AI工具或开发人员完整复现系统所有功能

---

## 使用说明

将本文档提供给任何AI编程工具(如Claude、ChatGPT、GitHub Copilot等)时,请明确指示:

**指令模板**:
```
请根据以下技术规格说明书,完整实现一个基金分类标签管理系统。

要求:
1. 严格遵循文档中的所有计算公式和逻辑
2. 完全实现文档描述的所有功能模块
3. UI/UX必须符合第5章的设计规范
4. 生成单一HTML文件,包含所有CSS和JavaScript
5. 确保离线可运行,不依赖外部CDN
6. 所有数值计算必须与文档示例一致
7. 实现完整的错误处理和边界情况处理

【此处粘贴完整的技术规格说明书】
```

这样可以确保AI工具准确理解所有需求并生成符合规格的代码。
