# 基金分类标签管理系统 v2.1 - 更新说明

## 更新日期
2026-01-20

## 版本历史
- **v2.1**: 新增含权基金分类检测功能
- **v2.0**: 改为双文件导入模式，优化匹配逻辑，新增结果导出功能
- **v1.1.0**: 智能基金检测与批量添加功能
- **v1.0.0**: 初始版本

---

## v2.1 新增功能

### 含权基金分类检测 ✨

系统现在会自动检测持仓明细表中需要分类的含权基金，并提示用户补充未分类的基金。

#### 检测范围

系统会检测以下5类资产小类：

1. **被动指数型基金**
2. **混合债券型二级基金**
3. **偏股混合型基金**
4. **普通股票型基金**
5. **灵活配置型基金**

#### 功能说明

**场景1：所有含权基金都已分类** ✅

显示绿色成功提示框：
```
✅ 含权基金均已导入和分类完成

已检测的含权资产类别：被动指数型基金、混合债券型二级基金、
偏股混合型基金、普通股票型基金、灵活配置型基金

所有上述类别的基金都已在基金分类表中找到对应的分类信息，
可以正常进行分析计算。

[隐藏此提示]
```

**场景2：发现未分类的含权基金** ⚠️

显示橙色警告框，列出所有未分类基金：
```
⚠️ 发现未分类的含权基金

在持仓表中检测到 3 个含权基金尚未在基金分类表中分类，
请在基金分类表中补充以下基金的分类信息：

┌──────────────────────────────────────────────────────┐
│ 基金名称            │ 资产小类      │ 外部代码  │ 资产代码│
├──────────────────────────────────────────────────────┤
│ 国泰中证煤炭ETF    │ 被动指数型基金 │ 515220.SH │ -       │
│ 南方中证A500ETF    │ 被动指数型基金 │ 159352.SZ │ -       │
│ 博道成长智航股票   │ 普通股票型基金 │ 010388.OF │ -       │
└──────────────────────────────────────────────────────┘

📝 操作建议：
1. 在基金分类表（Excel）中添加上述基金的分类信息
2. 确保外部代码或资产代码与上表中显示的代码一致
3. 保存后重新上传基金分类表和持仓明细表

[暂时隐藏]
```

#### 技术实现

**新增常量**：
```javascript
const EQUITY_ASSET_CLASSES = [
    '被动指数型基金',
    '混合债券型二级基金',
    '偏股混合型基金',
    '普通股票型基金',
    '灵活配置型基金'
];
```

**新增函数**：
- `renderUnclassifiedEquityFunds(unclassifiedEquityFunds)` - 渲染未分类含权基金提示
- `hideUnclassifiedEquitySection()` - 隐藏提示区域

**修改的函数**：
- `processData()` - 添加含权基金检测逻辑

**新增HTML区域**：
```html
<div class="section" id="unclassifiedEquitySection" style="display: none;">
    <div id="unclassifiedEquityContent">
        <!-- 未分类含权基金提示内容 -->
    </div>
</div>
```

---

## v2.0 主要功能（回顾）

### 1. 双文件上传模式

**改变前（v1.1.0）**：
- 在网页中管理基金分类
- 数据存储在浏览器LocalStorage
- 上传持仓表进行分析

**改变后（v2.0+）**：
- 先上传基金分类表（Excel）
- 再上传持仓明细表（Excel）
- 不在浏览器中存储数据

### 2. 优化的匹配逻辑

**旧逻辑**：
```javascript
// 根据资产大类判断使用哪个字段
if (assetClass === '公募基金' && externalCode) {
    return externalCode;
}
if (assetClass === '委外投资' && assetCode) {
    return assetCode;
}
return assetName;
```

**新逻辑**：
```javascript
// 统一使用代码匹配，避免名称不规范问题
return externalCode || assetCode || '';
```

### 3. 结果导出功能

导出Excel文件，包含3个工作表：
- **产品风格汇总-金额**：各产品在不同风格上的权益暴露金额（万元）
- **产品风格汇总-占比**：各产品在不同风格上的权益暴露占比（%）
- **持仓明细**：详细的持仓数据

---

## 完整使用流程

### 步骤1：准备基金分类表

确保Excel文件包含以下列：

| 必需列 | 说明 |
|--------|------|
| 基金名称(PAS) | 基金名称 |
| 资产类别（PAS) | 资产类别 |
| 风格 | 红利/均衡/科技成长/周期/价值 |
| 权益仓位 | 0-100 |
| **外部代码** | 用于匹配（优先） |
| **资产代码** | 用于匹配（备用） |

### 步骤2：上传基金分类表

1. 点击"📋 1. 基金分类表"区域的"选择分类表"按钮
2. 选择基金分类Excel文件
3. 等待提示"✅ 成功加载 XX 个基金分类"

### 步骤3：上传持仓明细表

1. 点击"📊 2. 持仓明细表"区域的"选择持仓表"按钮
2. 选择持仓明细Excel文件
3. 系统自动处理数据

### 步骤4：查看检测结果

系统会自动检测含权基金分类情况：

- ✅ **全部已分类**：显示绿色成功提示
- ⚠️ **有未分类基金**：显示橙色警告，列出未分类基金详情

### 步骤5：补充未分类基金（如需要）

如果有未分类基金：

1. 打开基金分类表Excel文件
2. 根据提示添加缺失的基金分类信息
3. 保存基金分类表
4. 重新上传基金分类表和持仓明细表

### 步骤6：查看分析结果

- 汇总统计卡片
- 产品风格矩阵表（可切换金额/占比）
- 产品卡片与环形图
- 详细数据表格

### 步骤7：导出结果

点击"📥 导出分析结果到Excel"按钮，获得包含3个工作表的Excel文件。

---

## 数据要求

### 基金分类表

**文件名**：任意名称.xlsx

**必需列**：
```
基金名称(PAS)      - 基金名称
资产类别（PAS)     - 资产类别
风格              - 投资风格（红利/均衡/科技成长/周期/价值）
权益仓位          - 权益仓位百分比（0-100）
外部代码          - 外部代码（优先用于匹配）
资产代码          - 资产代码（外部代码为空时使用）
```

**数据示例**：
```
基金名称(PAS): 国泰中证煤炭ETF 515220.SH
资产类别（PAS): 被动指数型基金
风格: 周期
权益仓位: 100
外部代码: 515220.SH
资产代码: (空)
```

### 持仓明细表

**文件名**：任意名称.xlsx

**必需列**：
```
产品简称                    - 理财产品名称
资产简称                    - 基金/资产名称
外部代码                    - 外部代码
资产代码                    - 资产代码
日终市值(元)-产品法估值      - 持仓金额
新版资产小类                - 资产小类（用于检测含权基金）
```

**数据示例**：
```
产品简称: 丰利逸动1个月增强型
资产简称: 国泰中证煤炭ETF
外部代码: 515220.SH
资产代码: (空)
日终市值(元)-产品法估值: 35644094.60
新版资产小类: 被动指数型基金
```

---

## 常见问题

### Q1: 为什么提示某个基金未分类，但我明明在分类表中添加了？

**检查清单**：
1. ✅ 外部代码是否完全一致（包括大小写、空格）
2. ✅ 如果外部代码为空，资产代码是否一致
3. ✅ 是否重新上传了基金分类表
4. ✅ 分类表中的列名是否正确

### Q2: 系统只检测5类含权基金，其他类型的基金怎么办？

**答**：其他类型的基金（如纯债基金、货币基金等）不在检测范围内，即使未在分类表中也不会影响分析。如果需要将其他类型纳入检测，可以修改代码中的 `EQUITY_ASSET_CLASSES` 数组。

### Q3: 为什么有些持仓记录显示"未匹配"？

**可能原因**：
1. 外部代码和资产代码都为空
2. 代码在分类表中不存在
3. 代码有拼写错误或格式问题

**解决方法**：查看控制台日志，会显示具体的未匹配信息。

### Q4: 导出的Excel中为什么只有部分产品？

**答**：导出功能只导出当前在产品筛选器中选中的产品。请检查产品筛选器的选择状态。

### Q5: 如何批量添加多个未分类基金？

**答**：
1. 复制提示中显示的未分类基金信息
2. 在基金分类表中批量添加这些基金
3. 填写对应的风格和权益仓位
4. 保存后重新上传分类表

---

## 技术改进

### 代码优化

**v2.1 新增**：
- 增加约100行代码（含权基金检测功能）
- 新增1个常量定义
- 新增2个函数
- 新增1个HTML区域

**v2.0 改进**：
- 删除约600行代码（移除基金管理模块）
- 新增约200行代码（双文件上传和导出功能）
- 净减少约400行代码

### 性能优化

- 使用Map数据结构避免重复检测
- 简化匹配逻辑，提高匹配速度
- 减少不必要的DOM操作

### 用户体验优化

- 清晰的颜色提示（绿色=成功，橙色=警告）
- 详细的未分类基金列表
- 明确的操作建议
- 可隐藏的提示框

---

## 后续优化计划

### 短期（v2.2）
- [ ] 增加文件格式验证
- [ ] 提供示例文件下载
- [ ] 增加匹配详情查看功能

### 中期（v3.0）
- [ ] 支持拖拽上传
- [ ] 增加数据预览功能
- [ ] 支持批量导出多种格式

### 长期（v4.0）
- [ ] 增加历史数据对比
- [ ] 支持自定义检测规则
- [ ] 增加图表导出功能

---

## 相关文档

1. **使用说明_v2.0.md** - 用户使用指南
2. **修改说明_v2.0.md** - v2.0版本修改详情
3. **含权基金检测功能说明.md** - 含权基金检测功能详细说明（新增）

---

## 更新摘要

### 主要变更
✅ 新增含权基金分类检测功能
✅ 自动识别5类含权资产
✅ 智能提示未分类基金
✅ 详细的操作建议

### 文件修改
- `fund_analysis.html` - 新增约100行代码
- 新增文档：`含权基金检测功能说明.md`

### 兼容性
- ✅ 完全向下兼容v2.0
- ✅ 不影响现有功能
- ✅ 可选择性忽略检测提示

---

**更新日期**: 2026-01-20
**版本**: v2.1
**维护者**: Claude AI Assistant
