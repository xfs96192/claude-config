import pandas as pd
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side

file_0101 = '/Users/fanshengxia/Desktop/ä¼˜å…ˆè‚¡å’Œä¼˜å…ˆçº§æŒä»“/èµ„äº§äº¤æ˜“ä½™é¢å°è´¦20250101 æƒç›Šç±»èµ„äº§.xlsx'
file_1231 = '/Users/fanshengxia/Desktop/ä¼˜å…ˆè‚¡å’Œä¼˜å…ˆçº§æŒä»“/èµ„äº§äº¤æ˜“ä½™é¢å°è´¦20251231 æƒç›Šç±»èµ„äº§.xlsx'

df_0101 = pd.read_excel(file_0101)
df_1231 = pd.read_excel(file_1231)

# å®šä¹‰è¦æ’é™¤çš„èµ„äº§å­ç±»
exclude_subclass = [
    'æœªä¸Šå¸‚è‚¡æƒæŠ•èµ„-é¡¹ç›®',
    'è‚¡ç¥¨æŠ•èµ„',
    'éä¸Šå¸‚å…¬å¸è‚¡æƒæŠ•èµ„-å›è´­ä¸Šå±‚é‡‘èäº§å“',
    'éä¸Šå¸‚å…¬å¸è‚¡æƒæŠ•èµ„-çº¯è‚¡æƒæ— å›è´­'  # è¿™ä¸ªä¹Ÿæ˜¯çº¯è‚¡æƒï¼Œä¸æ˜¯ä¼˜å…ˆçº§
]

print('====== æ•°æ®è¿‡æ»¤å‰ ======')
print(f'2025å¹´1æœˆ1æ—¥æ€»è®°å½•: {len(df_0101)}æ¡')
print(f'2025å¹´12æœˆ31æ—¥æ€»è®°å½•: {len(df_1231)}æ¡')

# è¿‡æ»¤æ‰éä¼˜å…ˆçº§èµ„äº§
df_0101_filtered = df_0101[~df_0101['æ–°ç‰ˆèµ„äº§å­ç±»'].isin(exclude_subclass)].copy()
df_1231_filtered = df_1231[~df_1231['æ–°ç‰ˆèµ„äº§å­ç±»'].isin(exclude_subclass)].copy()

print(f'\n====== æ•°æ®è¿‡æ»¤åï¼ˆä»…ä¼˜å…ˆçº§èµ„äº§ï¼‰======')
print(f'2025å¹´1æœˆ1æ—¥: {len(df_0101_filtered)}æ¡è®°å½•')
print(f'  å¸‚å€¼: {df_0101_filtered["ç»“ç®—é‡‘é¢æŠ˜äººæ°‘å¸"].sum() / 100000000:.2f}äº¿')
print(f'\n2025å¹´12æœˆ31æ—¥: {len(df_1231_filtered)}æ¡è®°å½•')
print(f'  å¸‚å€¼: {df_1231_filtered["ç»“ç®—é‡‘é¢æŠ˜äººæ°‘å¸"].sum() / 100000000:.2f}äº¿')

print(f'\nä¿ç•™çš„èµ„äº§å­ç±»:')
for subclass in df_1231_filtered['æ–°ç‰ˆèµ„äº§å­ç±»'].unique():
    count = len(df_1231_filtered[df_1231_filtered['æ–°ç‰ˆèµ„äº§å­ç±»'] == subclass])
    value = df_1231_filtered[df_1231_filtered['æ–°ç‰ˆèµ„äº§å­ç±»'] == subclass]['ç»“ç®—é‡‘é¢æŠ˜äººæ°‘å¸'].sum() / 100000000
    print(f'  {subclass}: {count}æ¡, {value:.2f}äº¿')

# ä½¿ç”¨æ–°ç‰ˆèµ„äº§å­ç±»ï¼Œå¹¶æŒ‰èµ„äº§åç§°æ±‡æ€»ç»“ç®—é‡‘é¢
summary_0101 = df_0101_filtered.groupby(['æ–°ç‰ˆèµ„äº§å­ç±»', 'èµ„äº§åç§°']).agg({
    'ç»“ç®—é‡‘é¢æŠ˜äººæ°‘å¸': 'sum'
}).reset_index()
summary_0101.columns = ['æ–°ç‰ˆèµ„äº§å­ç±»', 'èµ„äº§åç§°', 'å¸‚å€¼_0101']

summary_1231 = df_1231_filtered.groupby(['æ–°ç‰ˆèµ„äº§å­ç±»', 'èµ„äº§åç§°']).agg({
    'ç»“ç®—é‡‘é¢æŠ˜äººæ°‘å¸': 'sum'
}).reset_index()
summary_1231.columns = ['æ–°ç‰ˆèµ„äº§å­ç±»', 'èµ„äº§åç§°', 'å¸‚å€¼_1231']

# è·å–æ‰€æœ‰èµ„äº§çš„å¹¶é›†
all_assets = pd.concat([
    summary_0101[['æ–°ç‰ˆèµ„äº§å­ç±»', 'èµ„äº§åç§°']],
    summary_1231[['æ–°ç‰ˆèµ„äº§å­ç±»', 'èµ„äº§åç§°']]
]).drop_duplicates(subset=['èµ„äº§åç§°']).reset_index(drop=True)

# åˆå¹¶æ•°æ®
df_merged = all_assets.copy()
df_merged = df_merged.merge(summary_1231[['èµ„äº§åç§°', 'å¸‚å€¼_1231']], on='èµ„äº§åç§°', how='left')
df_merged = df_merged.merge(summary_0101[['èµ„äº§åç§°', 'å¸‚å€¼_0101']], on='èµ„äº§åç§°', how='left')

df_merged['å¸‚å€¼_0101'] = df_merged['å¸‚å€¼_0101'].fillna(0)
df_merged['å¸‚å€¼_1231'] = df_merged['å¸‚å€¼_1231'].fillna(0)

# è½¬æ¢ä¸ºäº¿å…ƒ
df_merged['å¸‚å€¼_0101_äº¿'] = df_merged['å¸‚å€¼_0101'] / 100000000
df_merged['å¸‚å€¼_1231_äº¿'] = df_merged['å¸‚å€¼_1231'] / 100000000

# è®¡ç®—å˜åŒ–
df_merged['å˜åŒ–_äº¿'] = df_merged['å¸‚å€¼_1231_äº¿'] - df_merged['å¸‚å€¼_0101_äº¿']

def get_change_desc(row):
    if row['å¸‚å€¼_1231_äº¿'] == 0:
        return 'å‡æŒ'
    elif row['å¸‚å€¼_0101_äº¿'] == 0:
        return 'æ–°å¢'
    elif row['å˜åŒ–_äº¿'] > 0.01:
        return 'å¢æŒ'
    elif row['å˜åŒ–_äº¿'] < -0.01:
        return 'å‡æŒ'
    else:
        return 'æŒå¹³'

df_merged['æŒä»“å˜åŒ–è¯´æ˜'] = df_merged.apply(get_change_desc, axis=1)

# æ’åº
df_merged = df_merged.sort_values(['æ–°ç‰ˆèµ„äº§å­ç±»', 'èµ„äº§åç§°']).reset_index(drop=True)

# åˆ›å»ºExcel
wb = Workbook()

# ====== Sheet 1: èµ„äº§æ˜ç»† ======
ws1 = wb.active
ws1.title = 'ä¼˜å…ˆçº§èµ„äº§æ˜ç»†'

header_font = Font(bold=True, size=11)
header_fill = PatternFill(start_color='D3D3D3', end_color='D3D3D3', fill_type='solid')
header_align = Alignment(horizontal='center', vertical='center', wrap_text=True)
thin_border = Border(
    left=Side(style='thin'),
    right=Side(style='thin'),
    top=Side(style='thin'),
    bottom=Side(style='thin')
)

headers = ['æ–°ç‰ˆèµ„äº§å­ç±»', 'èµ„äº§åç§°', '2025å¹´12æœˆ31æ—¥å¸‚å€¼(äº¿)', '2025å¹´1æœˆ1æ—¥å¸‚å€¼(äº¿)', 'å˜åŒ–(äº¿)', 'æŒä»“å˜åŒ–è¯´æ˜']
for col_idx, header in enumerate(headers, 1):
    cell = ws1.cell(row=1, column=col_idx, value=header)
    cell.font = header_font
    cell.fill = header_fill
    cell.alignment = header_align
    cell.border = thin_border

row_idx = 2
for idx, row in df_merged.iterrows():
    ws1.cell(row=row_idx, column=1, value=row['æ–°ç‰ˆèµ„äº§å­ç±»']).border = thin_border
    ws1.cell(row=row_idx, column=2, value=row['èµ„äº§åç§°']).border = thin_border

    val_1231 = row['å¸‚å€¼_1231_äº¿']
    val_0101 = row['å¸‚å€¼_0101_äº¿']

    cell_1231 = ws1.cell(row=row_idx, column=3)
    if val_1231 > 0:
        cell_1231.value = val_1231
        cell_1231.number_format = '0.00'
    else:
        cell_1231.value = '-'
    cell_1231.border = thin_border

    cell_0101 = ws1.cell(row=row_idx, column=4)
    if val_0101 > 0:
        cell_0101.value = val_0101
        cell_0101.number_format = '0.00'
    else:
        cell_0101.value = '-'
    cell_0101.border = thin_border

    change_cell = ws1.cell(row=row_idx, column=5)
    change_val = row['å˜åŒ–_äº¿']
    if abs(change_val) < 0.01:
        change_cell.value = '-'
    else:
        change_cell.value = change_val
        change_cell.number_format = '0.00'
    change_cell.border = thin_border

    desc_cell = ws1.cell(row=row_idx, column=6, value=row['æŒä»“å˜åŒ–è¯´æ˜'])
    desc_cell.border = thin_border

    row_idx += 1

# åˆè®¡è¡Œ
total_row = row_idx
ws1.cell(row=total_row, column=1, value='åˆè®¡').font = Font(bold=True)
ws1.cell(row=total_row, column=1).border = thin_border
ws1.cell(row=total_row, column=2).border = thin_border

total_1231 = ws1.cell(row=total_row, column=3)
total_1231.value = df_merged['å¸‚å€¼_1231_äº¿'].sum()
total_1231.number_format = '0.00'
total_1231.font = Font(bold=True)
total_1231.border = thin_border

total_0101 = ws1.cell(row=total_row, column=4)
total_0101.value = df_merged['å¸‚å€¼_0101_äº¿'].sum()
total_0101.number_format = '0.00'
total_0101.font = Font(bold=True)
total_0101.border = thin_border

total_change = ws1.cell(row=total_row, column=5)
total_change.value = df_merged['å˜åŒ–_äº¿'].sum()
total_change.number_format = '0.00'
total_change.font = Font(bold=True)
total_change.border = thin_border

ws1.cell(row=total_row, column=6).border = thin_border

# è®¾ç½®åˆ—å®½
ws1.column_dimensions['A'].width = 35
ws1.column_dimensions['B'].width = 50
ws1.column_dimensions['C'].width = 22
ws1.column_dimensions['D'].width = 22
ws1.column_dimensions['E'].width = 15
ws1.column_dimensions['F'].width = 15

ws1.freeze_panes = 'A2'

# ====== Sheet 2: æŠ•èµ„å›¢é˜Ÿåˆ†å¸ƒ ======
ws2 = wb.create_sheet('æŠ•èµ„å›¢é˜Ÿåˆ†å¸ƒ')

# å°†æ— æŠ•èµ„å›¢é˜Ÿçš„èµ„äº§æ ‡æ³¨ä¸º"æœªåˆ†é…"
df_1231_copy = df_1231_filtered.copy()
df_1231_copy['æŠ•èµ„å›¢é˜Ÿ'] = df_1231_copy['æŠ•èµ„å›¢é˜Ÿ'].fillna('æœªåˆ†é…')

# æŒ‰æŠ•èµ„å›¢é˜Ÿå’Œæ–°ç‰ˆèµ„äº§å­ç±»æ±‡æ€»12æœˆ31æ—¥æ•°æ®
team_summary = df_1231_copy.groupby(['æŠ•èµ„å›¢é˜Ÿ', 'æ–°ç‰ˆèµ„äº§å­ç±»']).agg({
    'ç»“ç®—é‡‘é¢æŠ˜äººæ°‘å¸': 'sum'
}).reset_index()
team_summary['å¸‚å€¼_äº¿'] = team_summary['ç»“ç®—é‡‘é¢æŠ˜äººæ°‘å¸'] / 100000000
team_summary = team_summary.sort_values(['æŠ•èµ„å›¢é˜Ÿ', 'æ–°ç‰ˆèµ„äº§å­ç±»'])

# æŒ‰æŠ•èµ„å›¢é˜Ÿæ±‡æ€»
team_total = df_1231_copy.groupby('æŠ•èµ„å›¢é˜Ÿ').agg({
    'ç»“ç®—é‡‘é¢æŠ˜äººæ°‘å¸': 'sum'
}).reset_index()
team_total['å¸‚å€¼_äº¿'] = team_total['ç»“ç®—é‡‘é¢æŠ˜äººæ°‘å¸'] / 100000000
team_total = team_total.sort_values('å¸‚å€¼_äº¿', ascending=False)

# è¡¨å¤´
headers2 = ['æŠ•èµ„å›¢é˜Ÿ', 'æ–°ç‰ˆèµ„äº§å­ç±»', 'å¸‚å€¼(äº¿)', 'å æ¯”(%)']
for col_idx, header in enumerate(headers2, 1):
    cell = ws2.cell(row=1, column=col_idx, value=header)
    cell.font = header_font
    cell.fill = header_fill
    cell.alignment = header_align
    cell.border = thin_border

# å¡«å……æ•°æ®
row_idx = 2
grand_total = team_total['å¸‚å€¼_äº¿'].sum()

for team in team_total['æŠ•èµ„å›¢é˜Ÿ']:
    team_data = team_summary[team_summary['æŠ•èµ„å›¢é˜Ÿ'] == team]
    team_value = team_total[team_total['æŠ•èµ„å›¢é˜Ÿ'] == team]['å¸‚å€¼_äº¿'].values[0]

    # æŠ•èµ„å›¢é˜Ÿå°è®¡è¡Œ
    ws2.cell(row=row_idx, column=1, value=team).font = Font(bold=True)
    ws2.cell(row=row_idx, column=1).border = thin_border
    ws2.cell(row=row_idx, column=2, value='å°è®¡').font = Font(bold=True)
    ws2.cell(row=row_idx, column=2).border = thin_border

    cell_value = ws2.cell(row=row_idx, column=3, value=team_value)
    cell_value.number_format = '0.00'
    cell_value.font = Font(bold=True)
    cell_value.border = thin_border

    cell_pct = ws2.cell(row=row_idx, column=4, value=team_value/grand_total*100)
    cell_pct.number_format = '0.00'
    cell_pct.font = Font(bold=True)
    cell_pct.border = thin_border

    row_idx += 1

    # å„å­ç±»æ˜ç»†
    for _, subrow in team_data.iterrows():
        ws2.cell(row=row_idx, column=1, value='').border = thin_border
        ws2.cell(row=row_idx, column=2, value=subrow['æ–°ç‰ˆèµ„äº§å­ç±»']).border = thin_border

        cell_val = ws2.cell(row=row_idx, column=3, value=subrow['å¸‚å€¼_äº¿'])
        cell_val.number_format = '0.00'
        cell_val.border = thin_border

        cell_pct2 = ws2.cell(row=row_idx, column=4, value=subrow['å¸‚å€¼_äº¿']/team_value*100)
        cell_pct2.number_format = '0.00'
        cell_pct2.border = thin_border

        row_idx += 1

# æ€»è®¡è¡Œ
ws2.cell(row=row_idx, column=1, value='æ€»è®¡').font = Font(bold=True, size=12)
ws2.cell(row=row_idx, column=1).border = thin_border
ws2.cell(row=row_idx, column=2).border = thin_border

total_cell = ws2.cell(row=row_idx, column=3, value=grand_total)
total_cell.number_format = '0.00'
total_cell.font = Font(bold=True, size=12)
total_cell.border = thin_border

pct_cell = ws2.cell(row=row_idx, column=4, value=100)
pct_cell.number_format = '0.00'
pct_cell.font = Font(bold=True, size=12)
pct_cell.border = thin_border

# è®¾ç½®åˆ—å®½
ws2.column_dimensions['A'].width = 20
ws2.column_dimensions['B'].width = 35
ws2.column_dimensions['C'].width = 18
ws2.column_dimensions['D'].width = 15

ws2.freeze_panes = 'A2'

# ä¿å­˜æ–‡ä»¶
output_file = '/Users/fanshengxia/Desktop/data_api/å…¬å¸ä¼˜å…ˆçº§èµ„äº§æŒä»“å˜åŒ–å¯¹æ¯”ï¼ˆä»…ä¼˜å…ˆçº§ï¼‰.xlsx'
wb.save(output_file)

print(f'\n\nExcelæ–‡ä»¶å·²ç”Ÿæˆ: {output_file}')
print(f'\n====== Sheet1: ä¼˜å…ˆçº§èµ„äº§æ˜ç»† ======')
print(f'æ€»èµ„äº§æ•°: {len(df_merged)}')
print(f'2025å¹´1æœˆ1æ—¥æŒä»“æ•°: {(df_merged["å¸‚å€¼_0101_äº¿"] > 0).sum()}')
print(f'2025å¹´12æœˆ31æ—¥æŒä»“æ•°: {(df_merged["å¸‚å€¼_1231_äº¿"] > 0).sum()}')
print(f'æ–°å¢: {(df_merged["æŒä»“å˜åŒ–è¯´æ˜"] == "æ–°å¢").sum()}')
print(f'å‡æŒ: {(df_merged["æŒä»“å˜åŒ–è¯´æ˜"] == "å‡æŒ").sum()}')
print(f'å¢æŒ: {(df_merged["æŒä»“å˜åŒ–è¯´æ˜"] == "å¢æŒ").sum()}')
print(f'æŒå¹³: {(df_merged["æŒä»“å˜åŒ–è¯´æ˜"] == "æŒå¹³").sum()}')
print(f'\n2025å¹´1æœˆ1æ—¥æ€»å¸‚å€¼: {df_merged["å¸‚å€¼_0101_äº¿"].sum():.2f}äº¿')
print(f'2025å¹´12æœˆ31æ—¥æ€»å¸‚å€¼: {df_merged["å¸‚å€¼_1231_äº¿"].sum():.2f}äº¿')
print(f'æ€»å˜åŒ–: {df_merged["å˜åŒ–_äº¿"].sum():.2f}äº¿')

# è®¡ç®—æ–°å¢å’Œå¢æŒã€å‡æŒçš„é‡‘é¢
new_and_increase = df_merged[df_merged['å˜åŒ–_äº¿'] > 0.01]['å˜åŒ–_äº¿'].sum()
decrease = abs(df_merged[df_merged['å˜åŒ–_äº¿'] < -0.01]['å˜åŒ–_äº¿'].sum())
net_change = df_merged['å¸‚å€¼_1231_äº¿'].sum() - df_merged['å¸‚å€¼_0101_äº¿'].sum()

print(f'\næ–°å¢å’Œå¢æŒåˆè®¡: {new_and_increase:.2f}äº¿')
print(f'å‡æŒåˆè®¡: {decrease:.2f}äº¿')
print(f'å‡€å˜åŒ–: {net_change:.2f}äº¿')

print(f'\n====== Sheet2: æŠ•èµ„å›¢é˜Ÿåˆ†å¸ƒ ======')
print(f'æŠ•èµ„å›¢é˜Ÿæ•°: {len(team_total)}')
print(f'\nå„å›¢é˜ŸæŒä»“ï¼ˆ2025å¹´12æœˆ31æ—¥ï¼‰:')
for _, row in team_total.iterrows():
    print(f'  {row["æŠ•èµ„å›¢é˜Ÿ"]}: {row["å¸‚å€¼_äº¿"]:.2f}äº¿ ({row["å¸‚å€¼_äº¿"]/grand_total*100:.2f}%)')

print(f'\nğŸ“Š ä¸€å¥è¯æ€»ç»“:')
print(f'2025å¹´12æœˆ31æ—¥å…¬å¸ä¼˜å…ˆçº§èµ„äº§æŒä»“{df_merged["å¸‚å€¼_1231_äº¿"].sum():.2f}äº¿ï¼Œç›¸æ¯”2025å¹´1æœˆ1æ—¥å‡€{"å¢åŠ " if net_change > 0 else "å‡å°‘"}{abs(net_change):.2f}äº¿ï¼Œå…¶ä¸­æ–°å¢å’Œå¢æŒ{new_and_increase:.2f}äº¿ï¼Œå‡æŒ{decrease:.2f}äº¿ã€‚')
