# 同花顺数据源切换实施报告

**日期：** 2026-01-22
**任务：** 将Wind数据源切换为同花顺iFind数据源
**状态：** ⚠️ 部分成功（受账号限制）

---

## 执行摘要

已成功创建同花顺版本的数据生成程序 `generate_tables_from_ifind.py`，并完成初步测试。

**当前状态：**
- ✅ 程序框架完成
- ✅ A股行情数据获取成功（上证指数、中证转债）
- ❌ 债券收益率数据被账号额度限制
- ❌ 期货/外汇数据代码格式需调整

---

## 已完成的工作

### 1. 程序架构设计

创建了完整的同花顺版本程序，包含：
- `IFindDataFetcher` 类：统一的API调用接口
- 数据获取函数：日度、周度、EDB、估值数据
- 计算函数：股债性价比、利差、锁汇成本等
- Excel生成和格式化功能

### 2. 代码映射完成

基于 `/Users/fanshengxia/Desktop/ifind/副本数据指标.xlsx` 完成了Wind到同花顺的代码映射：

**债券收益率（EDB代码）：**
| Wind代码 | 指标名称 | 同花顺代码 | 状态 |
|---------|---------|----------|------|
| S0059749 | 中债国债10年 | L001619604 | ✓ 已映射 |
| M1004271 | 中债国开债10年 | L003783688 (9年替代) | ✓ 已映射 |
| S0059737 | 中债AAA 2年 | L001619331 | ✓ 已映射 |
| M1004263 | 中债国开债1年 | L002959790 (2年替代) | ✓ 已映射 |
| S0059736 | 中债AAA 1年 | L001618023 | ✓ 已映射 |
| S0059745 | 中债国债2年 | L001619275 | ✓ 已映射 |

**说明：** 使用2年期国开债替代1年期，9年期替代10年期（因映射表缺失）

### 3. API调用测试

成功测试了同花顺的3个核心API：
1. ✅ `cmd_history_quotation` - 历史行情数据
2. ❌ `edb_service` - 经济数据库（**受限**）
3. ⏳ `date_sequence` - 日期序列（待完善）

---

## 遇到的问题

### 问题1：数据额度超限 ⚠️ **关键阻碍**

**现象：**
```json
{
  "errorcode": -4318,
  "errmsg": "sorry, your usage of data has exceeded this month."
}
```

**影响范围：**
- ❌ 所有债券收益率数据无法获取
- ❌ 信用利差、期限利差等衍生指标无法计算
- ❌ 股债性价比计算缺少债券数据

**解决方案：**
1. **等待下月重置** - 最简单但需时间
2. **升级账号套餐** - 联系同花顺客服
3. **分拆数据请求** - 减少单次请求量
4. **使用替代数据源** - 部分指标用其他接口

### 问题2：期货/外汇代码格式不兼容

**现象：**
Wind格式代码在同花顺部分失效

**已验证有效的代码：**
- ✅ 000001.SH（上证指数）
- ✅ 000832.CSI（中证转债）

**失效的代码（需调整）：**
- ❌ AU.SHF（沪金）
- ❌ RB.SHF（螺纹钢）
- ❌ SC.INE（原油）
- ❌ M.DCE（豆粕）
- ❌ USDCNY.IB（美元人民币中间价）
- ❌ USDCNH.FX（离岸人民币）

**可能原因：**
1. 同花顺期货代码格式可能是：AU9999.SHF 或 AUL8.SHF
2. 外汇代码可能需要特殊格式
3. 需要使用不同的API接口（如 `basic_data_service`）

### 问题3：估值数据接口待验证

`date_sequence` 接口用于获取PE、PB等估值指标，当前解析逻辑未完善。

**需要确认：**
- 指标名称是否正确（`ths_pe_ttm_stock`, `ths_pb_stock`）
- 返回数据格式
- 股票代码格式要求

---

## 当前生成的文件

### 近1月净值走势.xlsx

**文件路径：** `/Users/fanshengxia/Desktop/市场观点美化/asset-analysis-real-data/近1月净值走势.xlsx`

**内容：**
- ✅ 21个交易日数据（2025-12-17 至 2026-01-16）
- ✅ 2个资产：上证指数、中证转债
- ❌ 缺失：期货、外汇、锁汇成本等

**示例数据：**
```
日期          上证指数      中证转债
2025-12-17   3870.28      483.16
2025-12-18   3876.37      483.43
2025-12-19   3890.45      485.28
...
2026-01-16   4101.91      483.12
```

### 指标值.xlsx

**状态：** ❌ 未生成（因EDB数据受限）

---

## 下一步行动计划

### 优先级1：解决数据额度限制

**选项A：联系同花顺客服**
- 咨询当前套餐的数据额度
- 了解升级方案和定价
- 确认EDB数据的调用限制

**选项B：调整数据获取策略**
- 减少数据请求频率
- 只获取必要的指标
- 使用缓存机制避免重复请求

### 优先级2：修正期货/外汇代码

**任务：**
1. 在同花顺终端查询各资产的正确代码格式
2. 更新程序中的代码映射表
3. 测试验证数据获取

**需要查询的代码：**
```python
待查询 = {
    "沪金": "AU.SHF → ?",
    "螺纹钢": "RB.SHF → ?",
    "热卷": "HC.SHF → ?",
    "原油": "SC.INE → ?",
    "豆粕": "M.DCE → ?",
    "铁矿石": "I.DCE → ?",
    "USDCNY中间价": "USDCNY.IB → ?",
    "离岸人民币": "USDCNH.FX → ?",
    "掉期点": "USDCNY1YS.IB → ?"
}
```

### 优先级3：完善估值数据获取

**任务：**
1. 测试 `date_sequence` 接口的返回格式
2. 验证PE、PB指标名称
3. 完善数据解析逻辑
4. 支持周度重采样

---

## 技术架构对比

### Wind版本 vs 同花顺版本

| 功能模块 | Wind | 同花顺 | 兼容性 |
|---------|------|--------|-------|
| 日度行情 | `w.wsd()` | `cmd_history_quotation` | ✅ 兼容 |
| 周度行情 | `Period=W` | 日度+重采样 | ⚠️ 需转换 |
| 债券收益率 | `w.edb()` | `edb_service` | ❌ 受限 |
| 估值指标 | `pe_ttm, pb_lf` | `ths_pe_ttm_stock` | ⏳ 待测 |
| 代码格式 | 统一格式 | 市场差异 | ⚠️ 需适配 |

### 数据覆盖对比

| 数据类型 | Wind | 同花顺当前状态 |
|---------|------|-------------|
| A股行情 | ✅ | ✅ |
| 债券收益率 | ✅ | ❌ 受限 |
| 期货行情 | ✅ | ⏳ 代码待调 |
| 外汇数据 | ✅ | ⏳ 代码待调 |
| 国际市场 | ✅ | ❌ 不覆盖 |
| 估值指标 | ✅ | ⏳ 接口待完善 |

---

## 程序使用说明（待完善）

### 环境要求

```bash
pip install requests pandas numpy openpyxl
```

### 配置

修改 `generate_tables_from_ifind.py` 中的access_token：
```python
IFIND_ACCESS_TOKEN = "your_access_token_here"
```

### 运行

```bash
cd /Users/fanshengxia/Desktop/市场观点美化
python generate_tables_from_ifind.py
```

### 当前限制

⚠️ **运行前请确保：**
1. 同花顺账号有足够的数据额度
2. 已更新期货/外汇代码为正确格式
3. 网络连接稳定

---

## 附录：同花顺API文档参考

### 已使用的接口

**1. 历史行情 (cmd_history_quotation)**
```python
params = {
    "codes": "000001.SH,600000.SH",
    "indicators": "open,high,low,close",
    "startdate": "2025-12-01",
    "enddate": "2026-01-16",
    "functionpara": {"Fill": "Previous"}
}
```

**2. 经济数据库 (edb_service)**
```python
params = {
    "indicators": "L001619604,L001619331",
    "startdate": "2025-12-01",
    "enddate": "2026-01-16"
}
```

**3. 日期序列 (date_sequence)**
```python
params = {
    "codes": "000001.SH",
    "startdate": "20251201",
    "enddate": "20260116",
    "functionpara": {"Fill": "Previous"},
    "indipara": [
        {"indicator": "ths_pe_ttm_stock", "indiparams": [""]}
    ]
}
```

### 待测试的接口

- `basic_data_service` - 可能更适合期货数据
- `data_pool` - 专题报表数据
- `snap_shot` - 实时快照（tick数据）

---

## 结论与建议

### 现状总结

同花顺版本程序已完成基础开发，但受以下限制：
1. ❌ **EDB数据超限** - 关键阻碍，影响债券指标
2. ⚠️ **代码格式差异** - 需逐个市场调整
3. ⏳ **估值接口待完善** - 技术可行，需时间

### 建议方案

**短期（1-2天）：**
1. 联系同花顺客服解决数据额度问题
2. 查询并更新期货/外汇正确代码
3. 完善估值数据获取逻辑

**中期（1周）：**
1. 实现完整的数据获取和指标计算
2. 添加数据质量检查和异常处理
3. 编写详细的使用文档

**长期（持续）：**
1. 建立代码映射维护机制
2. 添加数据缓存减少API调用
3. 考虑混合数据源方案（国际数据保留Wind）

---

**报告生成时间：** 2026-01-22
**程序文件：** `generate_tables_from_ifind.py`
**测试状态：** 部分成功，待完善
