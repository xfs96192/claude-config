# Wind程序指标差异分析报告

**分析日期：** 2026-01-22
**对比基准：** Excel原始指标值表 vs Wind程序生成结果
**程序文件：** generate_tables_from_wind.py

---

## 执行摘要

Wind程序当前生成 **26个指标**，Excel原始有 **36个指标**，**缺失11个指标**，覆盖率为 **72.2%**。

**缺失原因分类：**
1. ✅ **代码中已定义但数据为空** (7个) - 数据获取失败被过滤
2. ❌ **代码中完全未实现** (4个) - 需要添加数据源和计算逻辑

---

## 详细差异分析

### 1. 权益类指标（3个缺失）

| 子类资产 | 指标名称 | Excel值 | Wind程序 | 状态 | 原因 |
|---------|---------|---------|---------|------|------|
| 中证转债 | 转股溢价率 | 30.94% | ❌ 无 | **未实现** | 需要Wind特殊字段 |
| 中证转债 | 纯债溢价率 | 17.77% | ❌ 无 | **未实现** | 需要Wind特殊字段 |
| 中证转债 | 隐含波动率 | 35.45% | ❌ 无 | **未实现** | 需要Wind特殊字段 |

**问题说明：**
- 代码中完全没有中证转债的这3个指标
- 原Excel中注明这些为手动输入或需要特殊计算
- 需要查询Wind终端获取正确的字段名

**Wind字段参考：**
```python
# 可能的字段名（需验证）
"000832.CSI": {
    "转股溢价率": "convpremium",  # 或 ths_cv_premium_rate
    "纯债溢价率": "bondpremium",   # 或 ths_pure_bond_premium_rate
    "隐含波动率": "impliedvol"     # 或 ths_implied_volatility
}
```

**解决方案：**
1. 在Wind终端查询中证转债指数(000832.CSI)的可用字段
2. 添加到`fetch_valuation_data()`函数或创建新的获取函数
3. 在indicators列表中添加这3个指标

---

### 2. 债券类指标（1个差异）

| 子类资产 | 指标名称 | Excel | Wind程序 | 状态 | 原因 |
|---------|---------|-------|---------|------|------|
| 10年期美国国债收益率 | 期限利差(10减1）| 71.00bp | 期限利差(10减1) 71.00bp | ✓ 存在 | **仅符号差异** |

**问题说明：**
- Excel: `期限利差(10减1）` （全角括号）
- Wind: `期限利差(10减1)` （半角括号）
- 数值完全一致，只是文本格式问题

**解决方案：**
修改第525行代码中的指标名称以匹配Excel格式。

---

### 3. 汇率类指标（1个缺失）

| 子类资产 | 指标名称 | Excel值 | Wind程序 | 状态 | 原因 |
|---------|---------|---------|---------|------|------|
| USDCNY | 美元指数 | 97.5053 | ❌ 无 | **数据为空** | DXY.GI获取失败 |

**问题说明：**
- 代码第534行已定义此指标
- 使用 `weekly_data["DXY.GI"]`
- 但数据获取时为空，被第554行的`if len(series) == 0: continue`过滤

**数据源验证：**
```python
WEEKLY_INDEX_CODES = {
    "DXY.GI": "美元指数",  # ✓ 已配置
}
```

**解决方案：**
1. 检查Wind API对DXY.GI的返回数据
2. 可能需要调整代码格式或使用其他美元指数代码
3. 添加数据获取失败的日志输出以便调试

---

### 4. 商品类指标（6个缺失）

#### 4.1 沪金类（1个缺失）

| 子类资产 | 指标名称 | Excel值 | Wind程序 | 状态 | 原因 |
|---------|---------|---------|---------|------|------|
| 沪金 | 内外盘价差 | -0.0963 | ❌ 无 | **数据为空** | XAUUSD.IDC获取失败 |

**问题说明：**
- 代码第537行已定义此指标
- 计算公式：`AU.SHF - (XAUUSD.IDC * USDCNY / 31.1035)`
- 第488-491行有完整的计算逻辑
- 但COMEX黄金(XAUUSD.IDC)数据获取失败

**数据源验证：**
```python
WEEKLY_INDEX_CODES = {
    "XAUUSD.IDC": "COMEX黄金",  # ✓ 已配置
}

# 计算函数已定义
def calculate_gold_price_diff(shfe_gold, comex_gold, usdcny):
    """沪金内外盘价差 = 上期所黄金 - (COMEX黄金 × 美元人民币 / 31.1035)"""
    if pd.isna(shfe_gold) or pd.isna(comex_gold) or pd.isna(usdcny):
        return np.nan
    return shfe_gold - (comex_gold * usdcny / 31.1035)
```

**解决方案：**
1. 验证XAUUSD.IDC代码在Wind中是否正确
2. 可能需要使用其他COMEX黄金代码
3. 检查数据获取的日期范围和参数

#### 4.2 原油类（2个缺失）

| 子类资产 | 指标名称 | Excel值 | Wind程序 | 状态 | 原因 |
|---------|---------|---------|---------|------|------|
| 原油 | WIT与布油价差 | -4.16 | ❌ 无 | **数据为空** | CL.NYM或LCO.IPE获取失败 |
| 原油 | 美元指数 | 97.5053 | ❌ 无 | **数据为空** | 同汇率-美元指数问题 |

**问题说明：**
- 代码第543-544行已定义这2个指标
- WIT与布油价差计算公式：`CL.NYM - LCO.IPE`
- 第499-503行有完整的计算逻辑
- 但WTI原油(CL.NYM)或布伦特原油(LCO.IPE)数据获取失败

**数据源验证：**
```python
WEEKLY_INDEX_CODES = {
    "CL.NYM": "WTI原油",      # ✓ 已配置
    "LCO.IPE": "布伦特原油",   # ✓ 已配置
    "DXY.GI": "美元指数",      # ✓ 已配置（同汇率问题）
}

# 计算函数已定义
def calculate_wti_brent_spread(wti, brent):
    """WTI与布油价差 = WTI原油 - 布伦特原油"""
    if pd.isna(wti) or pd.isna(brent):
        return np.nan
    return wti - brent
```

**解决方案：**
1. 验证原油期货代码格式（可能需要使用连续合约代码）
2. 检查Wind数据权限是否覆盖国际商品
3. 考虑使用国内原油期货SC.INE作为替代

#### 4.3 豆粕类（3个缺失）

| 子类资产 | 指标名称 | Excel值 | Wind程序 | 状态 | 原因 |
|---------|---------|---------|---------|------|------|
| 豆粕 | 期货现货价差 | -443.29 | ❌ 无 | **未实现** | 需要现货价格数据源 |
| 豆粕 | 期货主连持仓量 | 2161911 | ❌ 无 | **未实现** | 需要使用`oi`字段 |
| 豆粕 | USDCNY中间价 | 6.9642 | ❌ 无 | **未实现** | 未添加到indicators |

**问题说明：**
- 代码第546行有注释：`# 注：豆粕期现价差、持仓量需要额外的数据源，这里省略`
- 豆粕期货(M.DCE)在周度数据中已配置
- 但缺少现货价格和持仓量的获取逻辑

**数据源分析：**
```python
WEEKLY_INDEX_CODES = {
    "M.DCE": "豆粕期货",  # ✓ 已配置（期货价格）
}

# 需要补充的数据
missing_data = {
    "豆粕现货价格": "需查询Wind代码",  # 用于计算期现价差
    "豆粕持仓量": "M.DCE + oi字段",   # 使用open_interest字段
}
```

**解决方案：**

1. **期货现货价差：**
   ```python
   # 在fetch_weekly_data中添加现货价格获取
   # 示例代码（需验证Wind代码）
   soybean_spot_code = "需查询"  # 豆粕现货价格代码

   # 计算函数
   def calculate_futures_spot_spread(futures, spot):
       """期现价差 = 期货价格 - 现货价格"""
       return futures - spot if not (pd.isna(futures) or pd.isna(spot)) else np.nan
   ```

2. **期货主连持仓量：**
   ```python
   # 修改fetch_weekly_data函数，添加oi字段
   data = w.wsd(
       codes="M.DCE",
       fields="close,oi",  # 添加持仓量字段
       beginTime=start_date.strftime("%Y-%m-%d"),
       endTime=end_date.strftime("%Y-%m-%d"),
       options="Period=W;Fill=Previous"
   )
   ```

3. **USDCNY中间价：**
   ```python
   # 在indicators列表中添加（数据已有）
   {"大类": "商品", "子类": "豆粕", "指标": "USDCNY中间价",
    "数据": weekly_data["USDCNY.IB"], "反转": False},
   ```

---

## 缺失指标汇总表

| 序号 | 大类 | 子类 | 指标 | 代码状态 | 数据状态 | 优先级 |
|-----|------|------|------|---------|---------|--------|
| 1 | 权益 | 中证转债 | 转股溢价率 | ❌ 未实现 | N/A | 🔴 高 |
| 2 | 权益 | 中证转债 | 纯债溢价率 | ❌ 未实现 | N/A | 🔴 高 |
| 3 | 权益 | 中证转债 | 隐含波动率 | ❌ 未实现 | N/A | 🔴 高 |
| 4 | 汇率 | USDCNY | 美元指数 | ✅ 已实现 | ❌ 数据为空 | 🟡 中 |
| 5 | 商品 | 沪金 | 内外盘价差 | ✅ 已实现 | ❌ 数据为空 | 🟡 中 |
| 6 | 商品 | 原油 | WIT与布油价差 | ✅ 已实现 | ❌ 数据为空 | 🟡 中 |
| 7 | 商品 | 原油 | 美元指数 | ✅ 已实现 | ❌ 数据为空 | 🟡 中 |
| 8 | 商品 | 豆粕 | 期货现货价差 | ❌ 未实现 | N/A | 🟢 低 |
| 9 | 商品 | 豆粕 | 期货主连持仓量 | ❌ 未实现 | N/A | 🟢 低 |
| 10 | 商品 | 豆粕 | USDCNY中间价 | ✅ 数据已有 | ✅ 仅需添加 | 🟢 低 |
| 11 | 债券 | 10年美债 | 期限利差符号 | ⚠️ 格式问题 | ✅ 数据正确 | 🟢 低 |

---

## 修复优先级建议

### 优先级1：中证转债指标（高）
**影响：** 权益类指标缺失33%（3/9）
**难度：** 中等 - 需要查询Wind字段
**工作量：** 4-6小时

**任务清单：**
- [ ] Wind终端查询000832.CSI可用字段
- [ ] 确认转股溢价率、纯债溢价率、隐含波动率的字段名
- [ ] 添加数据获取逻辑
- [ ] 测试并验证数据准确性

### 优先级2：国际市场数据（中）
**影响：** 汇率和商品类指标缺失
**难度：** 中等 - 数据源或代码格式问题
**工作量：** 2-4小时

**任务清单：**
- [ ] 验证DXY.GI、XAUUSD.IDC、CL.NYM、LCO.IPE代码
- [ ] 检查Wind数据权限是否覆盖这些品种
- [ ] 添加数据获取失败的调试日志
- [ ] 测试数据获取并记录结果

### 优先级3：豆粕相关指标（低）
**影响：** 商品类指标完整性
**难度：** 简单到中等
**工作量：** 1-2小时

**任务清单：**
- [ ] 查询豆粕现货价格Wind代码
- [ ] 修改fetch_weekly_data添加oi字段
- [ ] 在indicators列表添加豆粕USDCNY指标
- [ ] 计算期现价差和持仓量

### 优先级4：格式统一（低）
**影响：** 仅文本格式差异
**难度：** 简单
**工作量：** 5分钟

**任务清单：**
- [ ] 修改第525行的括号格式：`期限利差(10减1)` → `期限利差(10减1）`

---

## 数据获取失败的调试建议

### 问题诊断步骤

1. **添加详细日志**
   ```python
   def fetch_weekly_data(codes, start_date, end_date):
       print(f"  获取 {len(codes)} 个资产的周度数据...")

       # 添加调试信息
       for code in codes:
           print(f"    尝试获取: {code}")

       data = w.wsd(...)

       # 检查每个代码的数据
       for i, code in enumerate(data.Codes):
           data_count = len([x for x in data.Data[i] if not pd.isna(x)])
           print(f"    {code}: {data_count} 条有效数据")
   ```

2. **单独测试失败的代码**
   ```python
   # 测试脚本
   test_codes = ["DXY.GI", "XAUUSD.IDC", "CL.NYM", "LCO.IPE"]
   for code in test_codes:
       result = w.wsd(code, "close", "2023-01-01", "2026-01-16", "Period=W")
       print(f"{code}: ErrorCode={result.ErrorCode}, DataCount={len(result.Data[0])}")
   ```

3. **检查数据权限**
   - 确认Wind账号是否有国际市场数据权限
   - 某些数据可能需要额外订阅

---

## 修复后的预期结果

完成所有修复后，程序应生成 **36-37个指标**，与Excel完全一致：

| 类别 | 当前数量 | 目标数量 | 缺口 |
|------|---------|---------|------|
| 权益 | 6 | 9 | +3 |
| 债券 | 9 | 9 | 0 |
| 汇率 | 5 | 6 | +1 |
| 商品 | 6 | 12 | +6 |
| **总计** | **26** | **36** | **+10** |

---

## 附录：代码位置索引

| 功能 | 文件位置 | 行号 |
|------|---------|------|
| 周度代码配置 | generate_tables_from_wind.py | 95-112 |
| 估值数据获取 | generate_tables_from_wind.py | 165-191 |
| 周度数据获取 | generate_tables_from_wind.py | 194-222 |
| 黄金价差计算 | generate_tables_from_wind.py | 488-491 |
| 原油价差计算 | generate_tables_from_wind.py | 499-503 |
| 指标列表定义 | generate_tables_from_wind.py | 508-547 |
| 数据过滤逻辑 | generate_tables_from_wind.py | 554-556 |
| 豆粕注释 | generate_tables_from_wind.py | 546 |

---

**报告生成时间：** 2026-01-22
**下一步行动：** 按优先级逐项修复缺失指标
**预计完成时间：** 1-2个工作日（如有Wind终端访问权限）
