# 数据源映射与产品处理规则

## 数据源路径

### 主要数据源

1. **模版文件目录**: `/Users/fanshengxia/Desktop/重点业绩产品/`
   - 最新模版: `部门重点产品业绩v4_YYYYMMDD.xlsx`
   - 用途: 作为基础模版，保留所有格式和样式

2. **产品业绩指标数据**: `/Users/fanshengxia/Desktop/周报V2/数据/产品业绩指标数据/`
   - 文件格式: `内部产品业绩_YYYYMMDD.xlsx`
   - 包含字段: 产品代码、不同期间的年化收益率、最大回撤

3. **产品送审表**: `/Users/fanshengxia/Desktop/周报V2/数据/合享发行送审表/`
   - 文件格式: `*.pdf`
   - 用途: 提取未成立产品（如非标驱动系列）的业绩基准下限

4. **产品运作概览数据**: `/Users/fanshengxia/Desktop/周报V2/数据/产品运作概览数据-母子产品/`
   - 文件格式: `产品运作概览信息表增加指标变化_YYYYMMDD.xlsx`
   - 用途: 现金产品（如汇利现金宝1号）的累计年化收益率

## 产品特殊处理规则

### 1. 非标驱动系列

**产品特征**: 尚未成立的产品

**数据来源**: 产品送审表PDF（`/Users/fanshengxia/Desktop/周报V2/数据/合享发行送审表/`）

**处理步骤**:
1. 在送审表文件夹中找到最新的合享送审表PDF
2. 从PDF中提取不同份额的业绩基准下限
3. 格式化为: `A份额2.35%；B份额 2.38% ；C份额 2.21%；D 份额 2.40%；E份额2.36%`
4. 提取产品代码、成立日、到期日
5. 计算运行天数: `到期日 - 成立日 + 1`

**关键字段**:
- 业绩基准下限（多份额）
- 成立日
- 到期日
- 运行天数（计算得出）

### 2. 汇利现金宝1号

**产品特征**: 现金管理产品，最后1行

**产品代码**: `9MX00010`

**数据来源**: 产品运作概览表（`/Users/fanshengxia/Desktop/周报V2/数据/产品运作概览数据-母子产品/产品运作概览信息表增加指标变化_YYYYMMDD.xlsx`）

**处理步骤**:
1. 在产品运作概览表中查找产品代码 `9MX00010`
2. 提取该产品的"累计年化"字段
3. 将累计年化值填入所有不同区间的年化收益率单元格
4. 所有区间的最大回撤设置为 `0bp`

**重要说明**:
- 内部产品业绩表中该产品的业绩计算不正确，不使用
- 不同区间的年化收益率相同（都使用累计年化）
- 近1月最大回撤为 `0bp`

### 3. 常规产品

**数据来源**: 内部产品业绩表（`/Users/fanshengxia/Desktop/周报V2/数据/产品业绩指标数据/内部产品业绩_YYYYMMDD.xlsx`）

**处理步骤**:
1. 通过产品代码在内部产品业绩表中匹配产品
2. 提取不同期间的年化收益率和最大回撤
3. 更新到模版对应单元格

## 产品列表与行号映射

**截至20260129模板的产品行号映射表：**

| 行号 | 产品系列 | 产品名称 | 产品代码 |
|------|---------|---------|---------|
| 4 | 非标驱动 | 丰利合享169号 | 9K251690 |
| 5 | 低波固收系列 | 悦动稳享7天 | 9A28701A |
| 6 | 低波固收系列 | 悦动稳享2M | 9A28201A |
| 7 | 低波固收系列 | 悦动稳享3M | 9A28301A |
| 8 | 低波固收系列 | 悦动稳享6M | 9A28601A |
| 9 | 低波固收系列 | 富利兴成锦云1M5号 | 9S26265A |
| 10 | 中波类固收系列 | 悦动1M日开1号 | 9K73101A |
| 11 | 中波类固收系列 | 悦动6M日开1号 | 9T32001A |
| 12 | 中波类固收系列 | 悦动9M日开1号 | 9K21003A |
| 13 | 中波类固收系列 | 悦动9M日开2号 | 9T32003A |
| 14 | 中波类固收系列 | 悦动1年日开3号 | 9T32005A |
| 15 | 微量含权（5%以内） | 逸动日开 | 9K71741A |
| 16 | 微量含权（5%以内） | 逸动1M | 9K717810 |
| 17 | 微量含权（5%以内） | 逸动3M | 9K70701A |
| 18 | 微量含权（5%以内） | 逸动6M | 9K70601A |
| 19 | 微量含权（5%以内） | 逸动9M | 9K70801A |
| 20 | 少量含权（10%以内） | 灵动3M | 9S12809A |
| 21 | 少量含权（10%以内） | 灵动6M | 9S12801A |
| 22 | 少量含权（10%以内） | 灵动9M | 9S12803A |
| 23 | 少量含权（10%以内） | 灵动1Y | 9S12805A |
| 24 | 少量含权（10%以内） | 兴动合兴3M | 9S65044A |
| 25 | 少量含权（10%以内） | 兴动合兴6M | 9K23106A |
| 26 | 少量含权（10%以内） | 兴动合兴9M | 9S65012A |
| 27 | 少量含权（10%以内） | 兴动合兴1Y | 9K23103A |
| 28 | 适量含权（20%以内） | 兴动多策略1Y1号（沪深300指数增强） | 9S65018A |
| 29 | 适量含权（20%以内） | 兴动多策略1Y2号（中证转债指数增强） | 9S65019A |
| 30 | 适量含权（20%以内） | 兴动多策略1Y3号（中证800指数增强） | 9S65030A |
| 31 | 适量含权（20%以内） | 兴动多策略1Y4号（恒生指数增强） | 9S65054A |
| 32 | 适量含权（20%以内） | 兴动多策略红利轮动1年 | 9K71714A |
| 33 | 适量含权（20%以内） | 兴动科技成长3M | 9K71713A |
| 34 | 适量含权（20%以内） | 兴动资源优势3M | 9K71712A |
| 35 | 适量含权（20%以内） | 兴动价值回报1M | 9K71731A |
| 36 | 适量含权（20%以内） | ESG日开 | 9S23201A |
| 37 | 美元日开 | 汇利日盈 | 9W10006A |
| 38 | 美元日开 | 汇利现金宝1号 | 9MX00010 |

**注意**：当新增或删除产品时，需要更新此表格并调整后续产品的行号。

## 数据匹配规则

### 产品代码匹配

- **主键**: 产品代码
- **匹配逻辑**: 精确匹配
- **特殊处理**:
  - 非标驱动: 从送审表PDF提取
  - 汇利现金宝1号: 固定为 `9MX00010`

### 日期格式

- **输入格式**: `YYYYMMDD` (如: `20260115`)
- **文件命名**: `内部产品业绩_YYYYMMDD.xlsx`
- **输出文件命名**: `部门重点产品业绩v4_YYYYMMDD.xlsx`

## 字段更新清单

### 需要更新的字段

根据产品类型，需要更新以下字段：

**常规产品**:
- 近1月年化收益率
- 近3月年化收益率
- 近6月年化收益率
- 近1年年化收益率
- 成立以来年化收益率
- 近1月最大回撤
- 近3月最大回撤
- 近6月最大回撤
- 近1年最大回撤
- 成立以来最大回撤

**非标驱动系列**:
- 业绩基准下限（格式化字符串）
- 产品代码
- 成立日
- 到期日
- 运行天数

**汇利现金宝1号**:
- 所有期间的年化收益率（使用累计年化）
- 所有期间的最大回撤（固定为0bp）

## 数据格式化规则

### 最大回撤格式化

**CRITICAL**: 模版中最大回撤有两列显示：
- **列13**: 数值表示
- **列14**: 基点（bp）表示

**格式化规则**:

| 数据源值 | 列13 | 列14 | 适用产品示例 |
|---------|------|------|-------------|
| `0` 或 `NaN` | `"-"` (字符串) | `"0bp"` (字符串) | 9A28701A, 9A28201A, 9A28301A, 9A28601A, 9S26265A, 9W10006A, 9MX00010 |
| 非零负数 | 数值本身 | `"{bp}bp"` 其中 bp = abs(value) * 10000 四舍五入 | 9K73101A: `-0.000359` → "4bp" |

**错误示例**: 直接写入数字 `0` 而不是字符串 `"-"` 和 `"0bp"`

**正确实现**:
```python
if pd.isna(dd_value) or dd_value == 0:
    ws.cell(row, 13).value = "-"
    ws.cell(row, 14).value = "0bp"
else:
    ws.cell(row, 13).value = dd_value
    bp_value = int(round(abs(dd_value) * 10000))
    ws.cell(row, 14).value = f"{bp_value}bp"
```

## 格式保留要求

**关键原则**: 完全保留Excel原有格式

- 单元格颜色
- 字体样式
- 边框
- 合并单元格
- 列宽行高
- 条件格式
- 数据验证

**仅更新**: 单元格的数值内容，不修改任何格式
