"""
å¸‚åœºè§‚ç‚¹ç¾åŒ– - Windæ•°æ®ç”Ÿæˆç¨‹åºï¼ˆåŸºäºçœŸå®Excelå…¬å¼ï¼‰

å®Œå…¨åŸºäºExcelå…¬å¼è¯¦ç»†æ˜ å°„è¡¨å®ç°ï¼Œç”Ÿæˆï¼š
1. è¿‘1æœˆå‡€å€¼èµ°åŠ¿.xlsx - æœ€è¿‘1ä¸ªæœˆæ—¥åº¦è¡Œæƒ…
2. æŒ‡æ ‡å€¼.xlsx - 37ä¸ªæŒ‡æ ‡çš„å½“å‰å€¼ã€å†å²ç»Ÿè®¡å’Œåˆ†ä½æ•°

ä½œè€…: Claude
æ—¥æœŸ: 2026-01-22
ç‰ˆæœ¬: v2.0 (åŸºäºçœŸå®å…¬å¼)
"""

import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from WindPy import w
import sys

print("=" * 80)
print("å¸‚åœºè§‚ç‚¹ç¾åŒ– - Windæ•°æ®ç”Ÿæˆç¨‹åº v2.0")
print("=" * 80)

# ==================== Windåˆå§‹åŒ– ====================

print("\n[1/6] åˆå§‹åŒ–Windè¿æ¥...")
w.start()

if not w.isconnected():
    print("âŒ é”™è¯¯: Windæœªè¿æ¥ï¼Œè¯·ç¡®ä¿Windç»ˆç«¯å·²ç™»å½•")
    sys.exit(1)

print("âœ“ Windè¿æ¥æˆåŠŸ")

# ==================== é…ç½®åŒº ====================

# è¾“å‡ºè·¯å¾„
OUTPUT_DIR = "/Users/fanshengxia/Desktop/å¸‚åœºè§‚ç‚¹ç¾åŒ–/asset-analysis-real-data"

# æ—¥æœŸèŒƒå›´
END_DATE = datetime(2026, 1, 23)  # è®¾å®šä¸º2026å¹´1æœˆ16æ—¥
START_DATE_DAILY = END_DATE - timedelta(days=30)  # è¿‘1æœˆ
START_DATE_WEEKLY = END_DATE - timedelta(days=365 * 5)  # è¿‘5å¹´

# Windä»£ç æ˜ å°„ï¼ˆåŸºäºExcelå…¬å¼è¯¦ç»†æ˜ å°„è¡¨ï¼‰
WIND_CODES = {
    # è¿‘ä¸€æœˆæŒ‡æ•°èµ°åŠ¿éœ€è¦çš„ä»£ç 
    "daily": {
        "881001.WI": "ä¸‡å¾—å…¨A",
        "000832.CSI": "ä¸­è¯è½¬å€º",
        "SPX.GI": "æ ‡æ™®500",
        "931472.CSI": "7-10å¹´å›½å¼€",
        "CBA01921.CS": "1-3å¹´é«˜ä¿¡ç”¨ç­‰çº§å€ºåˆ¸è´¢å¯Œ",
        "10yrnote.gbm": "10å¹´æœŸç¾å›½å›½å€ºæ”¶ç›Šç‡",
        "USDCNY.IB": "USDCNY",
        "AU.SHF": "æ²ªé‡‘",
        "RB.SHF": "èºçº¹é’¢",
        "SC.INE": "åŸæ²¹",
        "M.DCE": "è±†ç²•",
        "USDCNY1YS.IB": "æ‰æœŸç‚¹1Y",  # ç”¨äºè®¡ç®—é”æ±‡æˆæœ¬
        "USDCNH.FX": "ç¦»å²¸äººæ°‘å¸"  # ç”¨äºè®¡ç®—é”æ±‡æˆæœ¬
    }
}

# æ‰€æœ‰æŒ‡æ ‡sheetéœ€è¦çš„å‘¨åº¦æ•°æ®Windä»£ç ï¼ˆEDBç»æµæ•°æ®åº“ï¼‰
# âœ“ å·²ä» /Users/fanshengxia/Desktop/data_api/data/æ•°æ®æŒ‡æ ‡.xlsx éªŒè¯å¹¶ä¿®æ­£
EDB_CODES = {
    # ä¸­å›½å€ºåˆ¸æ”¶ç›Šç‡ (âœ“ å·²éªŒè¯)
    "S0059749": "ä¸­å€ºå›½å€º10å¹´",       # s1 - ä¸­å€ºå›½å€ºåˆ°æœŸæ”¶ç›Šç‡:10å¹´
    "M1004271": "ä¸­å€ºå›½å¼€å€º10å¹´",     # s2 - ä¸­å€ºå›½å¼€å€ºåˆ°æœŸæ”¶ç›Šç‡:10å¹´
    "S0059737": "ä¸­å€ºAAA 2å¹´",       # s3 - ä¸­å€ºä¸­çŸ­æœŸç¥¨æ®åˆ°æœŸæ”¶ç›Šç‡(AAA):2å¹´
    "M1004263": "ä¸­å€ºå›½å¼€å€º1å¹´",     # s7 - ä¸­å€ºå›½å¼€å€ºåˆ°æœŸæ”¶ç›Šç‡:1å¹´
    "S0059736": "ä¸­å€ºAAA 1å¹´",       # s5 - ä¸­å€ºä¸­çŸ­æœŸç¥¨æ®åˆ°æœŸæ”¶ç›Šç‡(AAA):1å¹´
    "S0059745": "ä¸­å€ºå›½å€º2å¹´",       # s8 - ä¸­å€ºå›½å€ºåˆ°æœŸæ”¶ç›Šç‡:2å¹´

    # ç¾å›½å€ºåˆ¸æ”¶ç›Šç‡ (âœ“ å·²éªŒè¯)
    "G0000891": "ç¾å›½10å¹´å›½å€º",      # s4 - ç¾å›½:å›½å€ºæ”¶ç›Šç‡:10å¹´æœŸ

    # âš ï¸ ä»¥ä¸‹ä»£ç åœ¨æ•°æ®æŒ‡æ ‡.xlsxä¸­æœªæ‰¾åˆ°ï¼Œéœ€è¦åœ¨Windç»ˆç«¯ç¡®è®¤æ­£ç¡®ä»£ç 
    # ç¨‹åºéœ€è¦è¿™äº›æŒ‡æ ‡æ¥è®¡ç®—ï¼š
    # - ç¾å›½æœŸé™åˆ©å·® (ç¬¬442è¡Œ: 10å¹´-1å¹´)
    # - ç¾å›½å®é™…åˆ©ç‡ (ç¬¬513è¡Œ: å•†å“æŒ‡æ ‡)
    # ä¸´æ—¶ä½¿ç”¨å ä½ç¬¦ä»£ç ï¼Œè¿è¡Œå‰è¯·åœ¨Windç»ˆç«¯æœç´¢æ›¿æ¢ï¼š
    "G0000886": "ç¾å›½1å¹´å›½å€º",       # s6 - éœ€è¦æœç´¢ "US Treasury 1Y"
    "G1147401": "ç¾å›½10å¹´å®é™…æ”¶ç›Šç‡",  # s9 - éœ€è¦æœç´¢ "TIPS 10Y" æˆ– "ç¾å›½å®é™…æ”¶ç›Šç‡"

    # ğŸ’¡ å¦‚ä½•æŸ¥æ‰¾æ­£ç¡®ä»£ç ï¼š
    # 1. æ‰“å¼€Windç»ˆç«¯
    # 2. æœç´¢ "ç¾å›½å›½å€ºæ”¶ç›Šç‡" æˆ– "US Treasury Yield"
    # 3. æŸ¥æ‰¾1å¹´æœŸå’Œ10å¹´TIPSçš„EDBä»£ç 
    # 4. æ›¿æ¢ä¸Šé¢çš„PLACEHOLDERä»£ç 
}

# å‘¨åº¦æŒ‡æ•°æ•°æ®ï¼ˆç”¨äºPEã€PBç­‰ï¼‰
WEEKLY_INDEX_CODES = {
    "881001.WI": "ä¸‡å¾—å…¨A",
    "SPX.GI": "æ ‡æ™®500",
    "VIX.GI": "VIX",
    "USDCNY.IB": "USDCNY",
    "USDX.FX": "ç¾å…ƒæŒ‡æ•°",  # ä¿®æ­£ï¼šDXY.GI â†’ USDX.FX
    "AU.SHF": "æ²ªé‡‘",
    "GC.CMX": "COMEXé»„é‡‘",  # ä¿®æ­£ï¼šXAUUSD.IDC â†’ GC.CMX
    "CL.NYM": "WTIåŸæ²¹",
    "B.IPE": "å¸ƒä¼¦ç‰¹åŸæ²¹",  # ä¿®æ­£ï¼šLCO.IPE â†’ B.IPE
    "M.DCE": "è±†ç²•æœŸè´§",
    "W00003SPT.NM": "è±†ç²•ç°è´§",  # æ–°å¢ï¼šè±†ç²•ç°è´§
    "RB.SHF": "èºçº¹é’¢",
    "HC.SHF": "çƒ­å·",
    "I.DCE": "é“çŸ¿çŸ³",
    "USDCNY1YS.IB": "1å¹´æ‰æœŸç‚¹",
    "USDCNH.FX": "ç¦»å²¸äººæ°‘å¸"
}

# ==================== æ•°æ®è·å–å‡½æ•° ====================

def fetch_daily_data(codes, start_date, end_date):
    """è·å–æ—¥åº¦è¡Œæƒ…æ•°æ®"""
    print(f"  è·å– {len(codes)} ä¸ªèµ„äº§çš„æ—¥åº¦æ•°æ®...")

    data = w.wsd(
        codes=",".join(codes),
        fields="close",
        beginTime=start_date.strftime("%Y-%m-%d"),
        endTime=end_date.strftime("%Y-%m-%d"),
        options="Period=D;Fill=Previous"
    )

    if data.ErrorCode != 0:
        print(f"  âš ï¸ è­¦å‘Š: Windè¿”å›é”™è¯¯ç  {data.ErrorCode}")
        return None

    df = pd.DataFrame(
        data=np.array(data.Data).T,
        index=data.Times,
        columns=codes
    )

    print(f"  âœ“ è·å–æˆåŠŸ: {len(df)} ä¸ªäº¤æ˜“æ—¥")
    return df


def fetch_weekly_data(codes, start_date, end_date):
    """è·å–å‘¨åº¦è¡Œæƒ…æ•°æ®"""
    print(f"  è·å– {len(codes)} ä¸ªèµ„äº§çš„å‘¨åº¦æ•°æ®...")

    data = w.wsd(
        codes=",".join(codes),
        fields="close",
        beginTime=start_date.strftime("%Y-%m-%d"),
        endTime=end_date.strftime("%Y-%m-%d"),
        options="Period=W;Fill=Previous"
    )

    if data.ErrorCode != 0:
        print(f"  âš ï¸ è­¦å‘Š: Windè¿”å›é”™è¯¯ç  {data.ErrorCode}")
        return None

    df = pd.DataFrame(
        data=np.array(data.Data).T,
        index=data.Times,
        columns=codes
    )

    print(f"  âœ“ è·å–æˆåŠŸ: {len(df)} å‘¨")
    return df


def fetch_valuation_data(codes, start_date, end_date):
    """è·å–ä¼°å€¼æ•°æ®ï¼ˆPEã€PBï¼‰"""
    print(f"  è·å–ä¼°å€¼æ•°æ®ï¼ˆPEã€PBï¼‰...")

    result = {}

    # è·å–PE
    data = w.wsd(
        codes=",".join(codes),
        fields="pe_ttm",
        beginTime=start_date.strftime("%Y-%m-%d"),
        endTime=end_date.strftime("%Y-%m-%d"),
        options="Period=W;Fill=Previous"
    )

    if data.ErrorCode == 0:
        result['PE'] = pd.DataFrame(
            data=np.array(data.Data).T,
            index=data.Times,
            columns=codes
        )

    # è·å–PB
    data = w.wsd(
        codes=",".join(codes),
        fields="pb_lf",
        beginTime=start_date.strftime("%Y-%m-%d"),
        endTime=end_date.strftime("%Y-%m-%d"),
        options="Period=W;Fill=Previous"
    )

    if data.ErrorCode == 0:
        result['PB'] = pd.DataFrame(
            data=np.array(data.Data).T,
            index=data.Times,
            columns=codes
        )

    print(f"  âœ“ è·å–æˆåŠŸ")
    return result


def fetch_edb_data(edb_codes, start_date, end_date):
    """è·å–EDBç»æµæ•°æ®"""
    print(f"  è·å– {len(edb_codes)} ä¸ªEDBæŒ‡æ ‡...")

    data = w.edb(
        codes=",".join(edb_codes.keys()),
        beginTime=start_date.strftime("%Y-%m-%d"),
        endTime=end_date.strftime("%Y-%m-%d"),
        options="Fill=Previous"
    )

    if data.ErrorCode != 0:
        print(f"  âš ï¸ è­¦å‘Š: Wind EDBè¿”å›é”™è¯¯ç  {data.ErrorCode}")
        return None

    df = pd.DataFrame(
        data=np.array(data.Data).T,
        index=data.Times,
        columns=list(edb_codes.values())
    )

    print(f"  âœ“ è·å–æˆåŠŸ: {len(df)} æ¡è®°å½•")
    return df


def fetch_open_interest(code, start_date, end_date):
    """è·å–æœŸè´§æŒä»“é‡æ•°æ®"""
    print(f"  è·å–æŒä»“é‡æ•°æ®: {code}...")

    data = w.wsd(
        codes=code,
        fields="oi",
        beginTime=start_date.strftime("%Y-%m-%d"),
        endTime=end_date.strftime("%Y-%m-%d"),
        options="Period=W;Fill=Previous"
    )

    if data.ErrorCode != 0:
        print(f"  âš ï¸ è­¦å‘Š: æŒä»“é‡æ•°æ®è·å–å¤±è´¥ï¼Œé”™è¯¯ç  {data.ErrorCode}")
        return pd.Series()

    df = pd.Series(
        data=data.Data[0],
        index=data.Times,
        name="æŒä»“é‡"
    )

    print(f"  âœ“ è·å–æˆåŠŸ: {len(df)} å‘¨")
    return df


# ==================== è®¡ç®—å‡½æ•°ï¼ˆåŸºäºExcelå…¬å¼ï¼‰ ====================

def calculate_equity_bond_ratio(pe, bond_yield_pct):
    """
    è‚¡å€ºæ€§ä»·æ¯” = 1/PE - å›½å€ºæ”¶ç›Šç‡/100

    Excel: =1/B3-æ‰€æœ‰æŒ‡æ ‡!B7/100
    """
    if pd.isna(pe) or pe == 0 or pd.isna(bond_yield_pct):
        return np.nan
    return (1 / pe) - (bond_yield_pct / 100)


def calculate_credit_spread(credit_yield, treasury_yield):
    """
    ä¿¡ç”¨åˆ©å·®(bp) = (ä¿¡ç”¨å€ºæ”¶ç›Šç‡ - å›½å€ºæ”¶ç›Šç‡) * 100

    Excel: =(æ‰€æœ‰æŒ‡æ ‡!C7-æ‰€æœ‰æŒ‡æ ‡!B7)*100
    """
    if pd.isna(credit_yield) or pd.isna(treasury_yield):
        return np.nan
    return (credit_yield - treasury_yield) * 100


def calculate_term_spread(long_yield, short_yield):
    """
    æœŸé™åˆ©å·®(bp) = (é•¿æœŸæ”¶ç›Šç‡ - çŸ­æœŸæ”¶ç›Šç‡) * 100

    Excel: =(æ‰€æœ‰æŒ‡æ ‡!C7-æ‰€æœ‰æŒ‡æ ‡!F7)*100
    """
    if pd.isna(long_yield) or pd.isna(short_yield):
        return np.nan
    return (long_yield - short_yield) * 100


def calculate_fx_hedging_cost(swap_points, cnh_rate):
    """
    é”æ±‡æˆæœ¬ = -æ‰æœŸç‚¹/10000/ç¦»å²¸äººæ°‘å¸æ±‡ç‡

    Excel: =-æ‰€æœ‰æŒ‡æ ‡!AG7/10000/æ‰€æœ‰æŒ‡æ ‡!AH7
    """
    if pd.isna(swap_points) or pd.isna(cnh_rate) or cnh_rate == 0:
        return np.nan
    return -swap_points / 10000 / cnh_rate


def calculate_china_us_spread(cn_yield, us_yield):
    """
    ä¸­ç¾åˆ©å·®(bp) = (ä¸­å›½10å¹´å›½å€º - ç¾å›½10å¹´å›½å€º) * 100

    Excel: =(æ‰€æœ‰æŒ‡æ ‡!B7-æ‰€æœ‰æŒ‡æ ‡!E7)*100
    """
    if pd.isna(cn_yield) or pd.isna(us_yield):
        return np.nan
    return (cn_yield - us_yield) * 100


def calculate_gold_price_diff(shfe_gold, comex_gold, usdcny):
    """
    æ²ªé‡‘å†…å¤–ç›˜ä»·å·® = æ²ªé‡‘ - COMEXé»„é‡‘ * USDCNY / 31.1035

    Excel: =æ‰€æœ‰æŒ‡æ ‡!W7-æ‰€æœ‰æŒ‡æ ‡!X7*æ‰€æœ‰æŒ‡æ ‡!U7/31.1035
    """
    if pd.isna(shfe_gold) or pd.isna(comex_gold) or pd.isna(usdcny):
        return np.nan
    return shfe_gold - comex_gold * usdcny / 31.1035


def calculate_rebar_coil_spread(coil, rebar):
    """
    èºå·å·® = çƒ­å· - èºçº¹

    Excel: =æ‰€æœ‰æŒ‡æ ‡!AE7-æ‰€æœ‰æŒ‡æ ‡!AD7
    """
    if pd.isna(coil) or pd.isna(rebar):
        return np.nan
    return coil - rebar


def calculate_wti_brent_spread(wti, brent):
    """
    WTIä¸å¸ƒæ²¹ä»·å·® = WTI - å¸ƒä¼¦ç‰¹

    Excel: =æ‰€æœ‰æŒ‡æ ‡!Y7-æ‰€æœ‰æŒ‡æ ‡!Z7
    """
    if pd.isna(wti) or pd.isna(brent):
        return np.nan
    return wti - brent


def calculate_futures_spot_spread(futures, spot):
    """
    æœŸè´§ç°è´§ä»·å·® = æœŸè´§ä»·æ ¼ - ç°è´§ä»·æ ¼

    ç”¨äºè±†ç²•ç­‰å•†å“
    """
    if pd.isna(futures) or pd.isna(spot):
        return np.nan
    return futures - spot


def calculate_percentile(series, value, reverse=False):
    """
    è®¡ç®—åˆ†ä½æ•°

    Excel: =_xlfn.PERCENTRANK.INC(INDIRECT(Jåˆ—), Dåˆ—)
    æˆ–: =1-_xlfn.PERCENTRANK.INC(INDIRECT(Jåˆ—), Dåˆ—)  # åè½¬
    """
    if pd.isna(value):
        return np.nan

    valid_series = series.dropna()
    if len(valid_series) == 0:
        return np.nan

    # è®¡ç®—ç™¾åˆ†ä½
    percentile = (valid_series < value).sum() / len(valid_series)

    # åè½¬ï¼ˆå¯¹äºè¶Šä½è¶Šå¥½çš„æŒ‡æ ‡ï¼‰
    if reverse:
        percentile = 1 - percentile

    return percentile


# ==================== ç”Ÿæˆè¿‘1æœˆå‡€å€¼èµ°åŠ¿ ====================

def generate_recent_prices():
    """ç”Ÿæˆè¿‘1æœˆå‡€å€¼èµ°åŠ¿.xlsx"""
    print("\n[2/6] ç”Ÿæˆè¿‘1æœˆå‡€å€¼èµ°åŠ¿...")

    # è·å–æ—¥åº¦æ•°æ®
    codes = list(WIND_CODES["daily"].keys())
    df = fetch_daily_data(codes, START_DATE_DAILY, END_DATE)

    if df is None:
        print("âŒ æ•°æ®è·å–å¤±è´¥")
        return False

    # è®¡ç®—é”æ±‡æˆæœ¬
    if "USDCNY1YS.IB" in df.columns and "USDCNH.FX" in df.columns:
        df['é”æ±‡æˆæœ¬'] = df.apply(
            lambda row: calculate_fx_hedging_cost(row["USDCNY1YS.IB"], row["USDCNH.FX"]),
            axis=1
        )
        # åˆ é™¤ä¸­é—´åˆ—
        df = df.drop(columns=["USDCNY1YS.IB", "USDCNH.FX"])

    # é‡å‘½ååˆ—ä¸ºä¸­æ–‡
    name_mapping = {code: WIND_CODES["daily"][code] for code in codes if code in WIND_CODES["daily"]}
    df = df.rename(columns=name_mapping)

    # ä¿å­˜
    output_path = f"{OUTPUT_DIR}/è¿‘1æœˆå‡€å€¼èµ°åŠ¿.xlsx"
    df.index.name = "æ—¥æœŸ"
    df.to_excel(output_path)

    # ç¾åŒ–æ ¼å¼
    format_excel(output_path, is_indicators=False)

    print(f"âœ“ å·²ç”Ÿæˆ: {output_path}")
    print(f"  - äº¤æ˜“æ—¥æ•°: {len(df)}")
    print(f"  - èµ„äº§æ•°: {len(df.columns)}")

    return True


# ==================== ç”ŸæˆæŒ‡æ ‡å€¼è¡¨ ====================

def generate_indicators():
    """ç”ŸæˆæŒ‡æ ‡å€¼.xlsxï¼ˆ37ä¸ªæŒ‡æ ‡ï¼‰"""
    print("\n[3/6] è·å–å‘¨åº¦æ•°æ®...")

    # 1. è·å–ä¼°å€¼æ•°æ®
    equity_codes = ["881001.WI", "SPX.GI"]
    valuation_data = fetch_valuation_data(equity_codes, START_DATE_WEEKLY, END_DATE)

    # 2. è·å–EDBå€ºåˆ¸æ”¶ç›Šç‡æ•°æ®
    bond_yields = fetch_edb_data(EDB_CODES, START_DATE_WEEKLY, END_DATE)

    # 3. è·å–å…¶ä»–å‘¨åº¦æ•°æ®
    weekly_codes = list(WEEKLY_INDEX_CODES.keys())
    weekly_data = fetch_weekly_data(weekly_codes, START_DATE_WEEKLY, END_DATE)

    # 4. è·å–è±†ç²•æœŸè´§æŒä»“é‡
    soybean_oi = fetch_open_interest("M.DCE", START_DATE_WEEKLY, END_DATE)

    if valuation_data is None or bond_yields is None or weekly_data is None:
        print("âŒ æ•°æ®è·å–å¤±è´¥")
        return False

    print("\n[4/6] è®¡ç®—è¡ç”ŸæŒ‡æ ‡...")

    # ========== è‚¡ç¥¨æŒ‡æ ‡ ==========

    # è‚¡å€ºæ€§ä»·æ¯” - ä½¿ç”¨DataFrameåˆå¹¶ç¡®ä¿æ—¥æœŸå¯¹é½
    if "881001.WI" in valuation_data['PE'].columns:
        pe_sh = valuation_data['PE']["881001.WI"]
        bond_yield_cn = bond_yields["ä¸­å€ºå›½å€º10å¹´"]
        # åˆ›å»ºä¸´æ—¶DataFrameè¿›è¡Œåˆå¹¶
        df_temp = pd.DataFrame({'pe': pe_sh, 'yield': bond_yield_cn})
        equity_bond_ratio_sh = df_temp.apply(
            lambda row: calculate_equity_bond_ratio(row['pe'], row['yield']),
            axis=1
        )
    else:
        equity_bond_ratio_sh = pd.Series()

    if "SPX.GI" in valuation_data['PE'].columns:
        pe_sp = valuation_data['PE']["SPX.GI"]
        bond_yield_us = bond_yields["ç¾å›½10å¹´å›½å€º"]
        # åˆ›å»ºä¸´æ—¶DataFrameè¿›è¡Œåˆå¹¶
        df_temp = pd.DataFrame({'pe': pe_sp, 'yield': bond_yield_us})
        equity_bond_ratio_sp = df_temp.apply(
            lambda row: calculate_equity_bond_ratio(row['pe'], row['yield']),
            axis=1
        )
    else:
        equity_bond_ratio_sp = pd.Series()

    # ========== å€ºåˆ¸æŒ‡æ ‡ ==========

    # 10å¹´å›½å¼€
    credit_spread_10y = bond_yields.apply(
        lambda row: calculate_credit_spread(row["ä¸­å€ºå›½å¼€å€º10å¹´"], row["ä¸­å€ºå›½å€º10å¹´"]),
        axis=1
    )

    term_spread_10y = bond_yields.apply(
        lambda row: calculate_term_spread(row["ä¸­å€ºå›½å¼€å€º10å¹´"], row["ä¸­å€ºå›½å¼€å€º1å¹´"]),
        axis=1
    )

    # 2å¹´AAA
    credit_spread_2y = bond_yields.apply(
        lambda row: calculate_credit_spread(row["ä¸­å€ºAAA 2å¹´"], row["ä¸­å€ºå›½å€º2å¹´"]),
        axis=1
    )

    term_spread_2y = bond_yields.apply(
        lambda row: calculate_term_spread(row["ä¸­å€ºAAA 2å¹´"], row["ä¸­å€ºAAA 1å¹´"]),
        axis=1
    )

    # 10å¹´ç¾å€º
    us_term_spread = bond_yields.apply(
        lambda row: calculate_term_spread(row["ç¾å›½10å¹´å›½å€º"], row["ç¾å›½1å¹´å›½å€º"]),
        axis=1
    )

    # ========== æ±‡ç‡æŒ‡æ ‡ ==========

    # é”æ±‡æˆæœ¬
    fx_hedging_cost = weekly_data.apply(
        lambda row: calculate_fx_hedging_cost(row["USDCNY1YS.IB"], row["USDCNH.FX"]) if "USDCNY1YS.IB" in row and "USDCNH.FX" in row else np.nan,
        axis=1
    )

    # ä¸­ç¾åˆ©å·®
    china_us_spread = bond_yields.apply(
        lambda row: calculate_china_us_spread(row["ä¸­å€ºå›½å€º10å¹´"], row["ç¾å›½10å¹´å›½å€º"]),
        axis=1
    )

    # ========== å•†å“æŒ‡æ ‡ ==========

    # æ²ªé‡‘å†…å¤–ç›˜ä»·å·®ï¼ˆä¿®æ­£ï¼šXAUUSD.IDC â†’ GC.CMXï¼‰
    gold_price_diff = weekly_data.apply(
        lambda row: calculate_gold_price_diff(row["AU.SHF"], row["GC.CMX"], row["USDCNY.IB"]) if all(k in row for k in ["AU.SHF", "GC.CMX", "USDCNY.IB"]) else np.nan,
        axis=1
    )

    # èºå·å·®
    rebar_coil_spread = weekly_data.apply(
        lambda row: calculate_rebar_coil_spread(row["HC.SHF"], row["RB.SHF"]) if "HC.SHF" in row and "RB.SHF" in row else np.nan,
        axis=1
    )

    # WTIä¸å¸ƒæ²¹ä»·å·®ï¼ˆä¿®æ­£ï¼šLCO.IPE â†’ B.IPEï¼‰
    wti_brent_spread = weekly_data.apply(
        lambda row: calculate_wti_brent_spread(row["CL.NYM"], row["B.IPE"]) if "CL.NYM" in row and "B.IPE" in row else np.nan,
        axis=1
    )

    # è±†ç²•æœŸè´§ç°è´§ä»·å·®
    soybean_spread = weekly_data.apply(
        lambda row: calculate_futures_spot_spread(row["M.DCE"], row["W00003SPT.NM"]) if "M.DCE" in row and "W00003SPT.NM" in row else np.nan,
        axis=1
    )

    print("\n[5/6] è®¡ç®—æŒ‡æ ‡ç»Ÿè®¡å€¼å’Œåˆ†ä½æ•°...")

    # æ„å»ºæŒ‡æ ‡åˆ—è¡¨ï¼ˆåŸºäºExcelæŒ‡æ ‡å€¼sheetçš„37è¡Œï¼‰
    indicators = [
        # æƒç›Šç±»ï¼ˆè¡Œ2-10ï¼‰
        {"å¤§ç±»": "æƒç›Š", "å­ç±»": "ä¸‡å¾—å…¨A", "æŒ‡æ ‡": "PE", "æ•°æ®": valuation_data['PE']["881001.WI"], "åè½¬": False},
        {"å¤§ç±»": "æƒç›Š", "å­ç±»": "ä¸‡å¾—å…¨A", "æŒ‡æ ‡": "PB", "æ•°æ®": valuation_data['PB']["881001.WI"], "åè½¬": False},
        {"å¤§ç±»": "æƒç›Š", "å­ç±»": "ä¸‡å¾—å…¨A", "æŒ‡æ ‡": "è‚¡å€ºæ€§ä»·æ¯”", "æ•°æ®": equity_bond_ratio_sh, "åè½¬": True},
        {"å¤§ç±»": "æƒç›Š", "å­ç±»": "æ ‡æ™®500", "æŒ‡æ ‡": "PE", "æ•°æ®": valuation_data['PE']["SPX.GI"], "åè½¬": False},
        {"å¤§ç±»": "æƒç›Š", "å­ç±»": "æ ‡æ™®500", "æŒ‡æ ‡": "PB", "æ•°æ®": valuation_data['PB']["SPX.GI"], "åè½¬": False},
        {"å¤§ç±»": "æƒç›Š", "å­ç±»": "æ ‡æ™®500", "æŒ‡æ ‡": "è‚¡å€ºæ€§ä»·æ¯”", "æ•°æ®": equity_bond_ratio_sp, "åè½¬": True},

        # å€ºåˆ¸ç±»ï¼ˆè¡Œ11-19ï¼‰
        {"å¤§ç±»": "å€ºåˆ¸", "å­ç±»": "7-10å¹´å›½å¼€", "æŒ‡æ ‡": "æ”¶ç›Šç‡", "æ•°æ®": bond_yields["ä¸­å€ºå›½å¼€å€º10å¹´"], "åè½¬": False},
        {"å¤§ç±»": "å€ºåˆ¸", "å­ç±»": "7-10å¹´å›½å¼€", "æŒ‡æ ‡": "ä¿¡ç”¨åˆ©å·®", "æ•°æ®": credit_spread_10y, "åè½¬": False},
        {"å¤§ç±»": "å€ºåˆ¸", "å­ç±»": "7-10å¹´å›½å¼€", "æŒ‡æ ‡": "æœŸé™åˆ©å·®", "æ•°æ®": term_spread_10y, "åè½¬": False},
        {"å¤§ç±»": "å€ºåˆ¸", "å­ç±»": "1-3å¹´é«˜ä¿¡ç”¨ç­‰çº§å€ºåˆ¸è´¢å¯Œ", "æŒ‡æ ‡": "æ”¶ç›Šç‡", "æ•°æ®": bond_yields["ä¸­å€ºAAA 2å¹´"], "åè½¬": False},
        {"å¤§ç±»": "å€ºåˆ¸", "å­ç±»": "1-3å¹´é«˜ä¿¡ç”¨ç­‰çº§å€ºåˆ¸è´¢å¯Œ", "æŒ‡æ ‡": "ä¿¡ç”¨åˆ©å·®", "æ•°æ®": credit_spread_2y, "åè½¬": False},
        {"å¤§ç±»": "å€ºåˆ¸", "å­ç±»": "1-3å¹´é«˜ä¿¡ç”¨ç­‰çº§å€ºåˆ¸è´¢å¯Œ", "æŒ‡æ ‡": "æœŸé™åˆ©å·®", "æ•°æ®": term_spread_2y, "åè½¬": False},
        {"å¤§ç±»": "å€ºåˆ¸", "å­ç±»": "10å¹´æœŸç¾å›½å›½å€ºæ”¶ç›Šç‡", "æŒ‡æ ‡": "æ”¶ç›Šç‡", "æ•°æ®": bond_yields["ç¾å›½10å¹´å›½å€º"], "åè½¬": False},
        {"å¤§ç±»": "å€ºåˆ¸", "å­ç±»": "10å¹´æœŸç¾å›½å›½å€ºæ”¶ç›Šç‡", "æŒ‡æ ‡": "æœŸé™åˆ©å·®(10å‡1)", "æ•°æ®": us_term_spread, "åè½¬": False},
        {"å¤§ç±»": "å€ºåˆ¸", "å­ç±»": "10å¹´æœŸç¾å›½å›½å€ºæ”¶ç›Šç‡", "æŒ‡æ ‡": "FF", "æ•°æ®": weekly_data["VIX.GI"] if "VIX.GI" in weekly_data.columns else pd.Series(), "åè½¬": False},

        # æ±‡ç‡ç±»ï¼ˆè¡Œ20-25ï¼‰
        {"å¤§ç±»": "æ±‡ç‡", "å­ç±»": "é”æ±‡æˆæœ¬", "æŒ‡æ ‡": "é”æ±‡æˆæœ¬", "æ•°æ®": fx_hedging_cost, "åè½¬": False},
        {"å¤§ç±»": "æ±‡ç‡", "å­ç±»": "é”æ±‡æˆæœ¬", "æŒ‡æ ‡": "æ‰æœŸç‚¹1Y", "æ•°æ®": weekly_data["USDCNY1YS.IB"] if "USDCNY1YS.IB" in weekly_data.columns else pd.Series(), "åè½¬": False},
        {"å¤§ç±»": "æ±‡ç‡", "å­ç±»": "é”æ±‡æˆæœ¬", "æŒ‡æ ‡": "ç¾å…ƒå…‘ç¦»å²¸äººæ°‘å¸CNH", "æ•°æ®": weekly_data["USDCNH.FX"] if "USDCNH.FX" in weekly_data.columns else pd.Series(), "åè½¬": False},
        {"å¤§ç±»": "æ±‡ç‡", "å­ç±»": "USDCNY", "æŒ‡æ ‡": "ä¸­é—´ä»·", "æ•°æ®": weekly_data["USDCNY.IB"] if "USDCNY.IB" in weekly_data.columns else pd.Series(), "åè½¬": False},
        {"å¤§ç±»": "æ±‡ç‡", "å­ç±»": "USDCNY", "æŒ‡æ ‡": "ä¸­ç¾åˆ©å·®", "æ•°æ®": china_us_spread, "åè½¬": False},
        {"å¤§ç±»": "æ±‡ç‡", "å­ç±»": "USDCNY", "æŒ‡æ ‡": "ç¾å…ƒæŒ‡æ•°", "æ•°æ®": weekly_data["USDX.FX"] if "USDX.FX" in weekly_data.columns else pd.Series(), "åè½¬": False},

        # å•†å“ç±»ï¼ˆè¡Œ26-37ï¼‰
        {"å¤§ç±»": "å•†å“", "å­ç±»": "æ²ªé‡‘", "æŒ‡æ ‡": "å†…å¤–ç›˜ä»·å·®", "æ•°æ®": gold_price_diff, "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "æ²ªé‡‘", "æŒ‡æ ‡": "ç¾å›½å®é™…åˆ©ç‡", "æ•°æ®": bond_yields["ç¾å›½10å¹´å®é™…æ”¶ç›Šç‡"], "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "æ²ªé‡‘", "æŒ‡æ ‡": "USDCNYä¸­é—´ä»·", "æ•°æ®": weekly_data["USDCNY.IB"] if "USDCNY.IB" in weekly_data.columns else pd.Series(), "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "èºçº¹é’¢", "æŒ‡æ ‡": "èºå·å·®ï¼ˆçƒ­å·å‡èºçº¹ï¼‰", "æ•°æ®": rebar_coil_spread, "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "èºçº¹é’¢", "æŒ‡æ ‡": "é“çŸ¿ä»·æ ¼", "æ•°æ®": weekly_data["I.DCE"] if "I.DCE" in weekly_data.columns else pd.Series(), "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "èºçº¹é’¢", "æŒ‡æ ‡": "USDCNYä¸­é—´ä»·", "æ•°æ®": weekly_data["USDCNY.IB"] if "USDCNY.IB" in weekly_data.columns else pd.Series(), "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "åŸæ²¹", "æŒ‡æ ‡": "WITä¸å¸ƒæ²¹ä»·å·®", "æ•°æ®": wti_brent_spread, "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "åŸæ²¹", "æŒ‡æ ‡": "ç¾å…ƒæŒ‡æ•°", "æ•°æ®": weekly_data["USDX.FX"] if "USDX.FX" in weekly_data.columns else pd.Series(), "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "åŸæ²¹", "æŒ‡æ ‡": "USDCNYä¸­é—´ä»·", "æ•°æ®": weekly_data["USDCNY.IB"] if "USDCNY.IB" in weekly_data.columns else pd.Series(), "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "è±†ç²•", "æŒ‡æ ‡": "æœŸè´§ç°è´§ä»·å·®", "æ•°æ®": soybean_spread, "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "è±†ç²•", "æŒ‡æ ‡": "æœŸè´§ä¸»è¿æŒä»“é‡", "æ•°æ®": soybean_oi, "åè½¬": False},
        {"å¤§ç±»": "å•†å“", "å­ç±»": "è±†ç²•", "æŒ‡æ ‡": "USDCNYä¸­é—´ä»·", "æ•°æ®": weekly_data["USDCNY.IB"] if "USDCNY.IB" in weekly_data.columns else pd.Series(), "åè½¬": False},
    ]

    # è®¡ç®—ç»Ÿè®¡å€¼
    results = []
    for ind in indicators:
        series = ind["æ•°æ®"].dropna()

        if len(series) == 0:
            continue

        current = series.iloc[-1]
        max_val = series.max()
        min_val = series.min()
        median = series.median()
        percentile = calculate_percentile(series, current, ind["åè½¬"])

        results.append({
            "å¤§ç±»èµ„äº§": ind["å¤§ç±»"],
            "å­ç±»èµ„äº§": ind["å­ç±»"],
            "è§‚å¯ŸæŒ‡æ ‡ï¼ˆè¿‘äº”å¹´ï¼‰": ind["æŒ‡æ ‡"],
            "å½“å‰å€¼": round(current, 4),
            "æœ€å¤§å€¼": round(max_val, 4),
            "æœ€å°å€¼": round(min_val, 4),
            "å†å²ä¸­ä½æ•°": round(median, 4),
            "å½“å‰åˆ†ä½ç‚¹": round(percentile, 3)
        })

    # ç”ŸæˆDataFrame
    df_indicators = pd.DataFrame(results)

    # ä¿å­˜
    output_path = f"{OUTPUT_DIR}/æŒ‡æ ‡å€¼.xlsx"
    df_indicators.to_excel(output_path, index=False)

    # ç¾åŒ–æ ¼å¼
    format_excel(output_path, is_indicators=True)

    print(f"âœ“ å·²ç”Ÿæˆ: {output_path}")
    print(f"  - æŒ‡æ ‡æ•°: {len(df_indicators)}")

    return True


# ==================== Excelæ ¼å¼ç¾åŒ– ====================

def format_excel(file_path, is_indicators=False):
    """ç¾åŒ–Excelæ ¼å¼"""
    wb = openpyxl.load_workbook(file_path)
    ws = wb.active

    # è¡¨å¤´æ ¼å¼
    header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
    header_font = Font(bold=True, color="FFFFFF", size=11)
    header_alignment = Alignment(horizontal="center", vertical="center")

    # è¾¹æ¡†
    thin_border = Border(
        left=Side(style='thin', color='D3D3D3'),
        right=Side(style='thin', color='D3D3D3'),
        top=Side(style='thin', color='D3D3D3'),
        bottom=Side(style='thin', color='D3D3D3')
    )

    # æ ¼å¼åŒ–è¡¨å¤´
    for cell in ws[1]:
        cell.fill = header_fill
        cell.font = header_font
        cell.alignment = header_alignment
        cell.border = thin_border

    # è°ƒæ•´åˆ—å®½
    for column in ws.columns:
        max_length = 0
        column_letter = column[0].column_letter

        for cell in column:
            try:
                if cell.value:
                    max_length = max(max_length, len(str(cell.value)))
            except:
                pass

        adjusted_width = min(max_length + 3, 35)
        ws.column_dimensions[column_letter].width = adjusted_width

    # æ•°æ®åŒºåŸŸæ ¼å¼
    for row in ws.iter_rows(min_row=2):
        for cell in row:
            cell.border = thin_border
            cell.alignment = Alignment(horizontal="center", vertical="center")

    # ç‰¹æ®Šæ ¼å¼ï¼ˆæŒ‡æ ‡å€¼è¡¨ï¼‰
    if is_indicators:
        # å½“å‰å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼ã€å†å²ä¸­ä½æ•°ä¿ç•™4ä½å°æ•°
        for col in ['D', 'E', 'F', 'G']:
            for cell in ws[col][1:]:  # è·³è¿‡è¡¨å¤´
                if cell.value and isinstance(cell.value, (int, float)):
                    cell.number_format = '0.0000'

        # å½“å‰åˆ†ä½ç‚¹ä¿ç•™3ä½å°æ•°ï¼Œæ˜¾ç¤ºä¸ºç™¾åˆ†æ¯”å½¢å¼
        for cell in ws['H'][1:]:
            if cell.value and isinstance(cell.value, (int, float)):
                cell.number_format = '0.0%'

    # å†»ç»“é¦–è¡Œ
    ws.freeze_panes = "A2"

    # è®¾ç½®è¡Œé«˜
    ws.row_dimensions[1].height = 25

    wb.save(file_path)


# ==================== ä¸»ç¨‹åº ====================

def main():
    try:
        # ç”Ÿæˆè¿‘1æœˆå‡€å€¼èµ°åŠ¿
        if not generate_recent_prices():
            print("\nâŒ è¿‘1æœˆå‡€å€¼èµ°åŠ¿ç”Ÿæˆå¤±è´¥")
            return

        # ç”ŸæˆæŒ‡æ ‡å€¼
        if not generate_indicators():
            print("\nâŒ æŒ‡æ ‡å€¼ç”Ÿæˆå¤±è´¥")
            return

        print("\n" + "=" * 80)
        print("âœ“ æ‰€æœ‰æ–‡ä»¶ç”Ÿæˆå®Œæˆ!")
        print("=" * 80)
        print(f"\nè¾“å‡ºç›®å½•: {OUTPUT_DIR}")
        print("  1. è¿‘1æœˆå‡€å€¼èµ°åŠ¿.xlsx")
        print("  2. æŒ‡æ ‡å€¼.xlsx")

    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()

    finally:
        print("\n[6/6] å…³é—­Windè¿æ¥...")
        w.stop()
        print("âœ“ Windè¿æ¥å·²å…³é—­")


if __name__ == "__main__":
    main()
