<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘åˆ†ç±»æ ‡ç­¾ç®¡ç†ç³»ç»Ÿï¼ˆå«äº¤æ˜“è°ƒä»“ï¼‰</title>
    <script src="xlsx.full.min.js"></script>
    <script src="chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #5a67d8;
            background: #f0f2ff;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #5a67d8;
        }

        .file-input {
            display: none;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: 700;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .error {
            color: #ef4444;
            background: #fef2f2;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .success {
            color: #16a34a;
            background: #f0fdf4;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .trade-adjustment {
            background: #fff8f0;
            border: 2px solid #ff6b35;
            color: #ff6b35;
            font-weight: bold;
        }

        .adjusted-holding {
            background: #f0fdf4;
            border: 2px solid #10b981;
            color: #10b981;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>åŸºé‡‘åˆ†ç±»æ ‡ç­¾ç®¡ç†ç³»ç»Ÿï¼ˆå«äº¤æ˜“è°ƒä»“ï¼‰</h1>
            <p>ä¸Šä¼ æŒä»“æ˜ç»†è¡¨ï¼ˆå«äº¤æ˜“æƒ…å†µï¼‰ï¼Œè‡ªåŠ¨è®¡ç®—å„äº§å“ä¸åŒé£æ ¼çš„æƒç›Šæš´éœ²å æ¯”</p>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“ ä¸Šä¼ æ•°æ®æ–‡ä»¶</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- åŸºé‡‘åˆ†ç±»è¡¨ä¸Šä¼  -->
                <div class="upload-area" id="classificationUploadArea">
                    <p style="font-size: 1.1em; margin-bottom: 10px; font-weight: 600;">ğŸ“‹ 1. åŸºé‡‘åˆ†ç±»è¡¨</p>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">è¯·å…ˆä¸Šä¼ åŸºé‡‘åˆ†ç±»è¡¨</p>
                    <button class="upload-btn" onclick="document.getElementById('classificationInput').click()">é€‰æ‹©åˆ†ç±»è¡¨</button>
                    <input type="file" id="classificationInput" class="file-input" accept=".xlsx,.xls" />
                    <div id="classificationResult" style="margin-top: 10px;"></div>
                </div>

                <!-- æŒä»“æ˜ç»†è¡¨ä¸Šä¼  -->
                <div class="upload-area" id="holdingUploadArea">
                    <p style="font-size: 1.1em; margin-bottom: 10px; font-weight: 600;">ğŸ“Š 2. æŒä»“æ˜ç»†è¡¨ï¼ˆå«äº¤æ˜“æƒ…å†µï¼‰</p>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">ä¸Šä¼ æŒä»“ç›ˆäºè¡¨ï¼Œç¬¬äºŒä¸ªsheetä¸ºäº¤æ˜“æƒ…å†µ</p>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æŒä»“è¡¨</button>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
                    <div id="holdingResult" style="margin-top: 10px;"></div>
                </div>
            </div>
            <div class="loading" id="loading">
                <p>ğŸ“Š æ­£åœ¨å¤„ç†æ•°æ®...</p>
            </div>
            <div id="uploadResult"></div>
        </div>

        <!-- åˆ†æç»“æœåŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“Š åˆ†æç»“æœ</h2>

            <!-- å¯¼å‡ºåŠŸèƒ½ -->
            <div style="margin-bottom: 20px; text-align: right;">
                <button class="btn btn-primary" onclick="exportResultsToExcel()" style="font-size: 1em; padding: 12px 24px;">
                    ğŸ“¥ å¯¼å‡ºåˆ†æç»“æœåˆ°Excel
                </button>
            </div>

            <div class="summary-stats" id="summaryStats">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
        <div class="section">
            <h2>ğŸ“‹ è¯¦ç»†æ•°æ®ï¼ˆå«äº¤æ˜“è°ƒä»“ï¼‰</h2>
            <div class="table-container">
                <table class="data-table" id="detailTable">
                    <thead>
                        <tr>
                            <th>äº§å“åç§°</th>
                            <th>åŸºé‡‘åç§°</th>
                            <th>èµ„äº§ä»£ç </th>
                            <th>é£æ ¼</th>
                            <th>æƒç›Šä»“ä½</th>
                            <th>æ˜¨æ—¥æŒä»“é‡‘é¢</th>
                            <th>å½“æ—¥è°ƒä»“</th>
                            <th>è°ƒä»“åçœŸå®æŒä»“</th>
                            <th>çœŸå®æƒç›Šæš´éœ²</th>
                            <th>çœŸå®æƒç›Šå æ¯”</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                        <!-- è¯¦ç»†æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let fundClassifications = {};
        let classificationData = [];
        let holdingData = [];
        let tradeData = [];
        let detailData = [];
        let isClassificationLoaded = false;
        let styleOrder = ['çº¢åˆ©', 'å‡è¡¡', 'ç§‘æŠ€æˆé•¿', 'å‘¨æœŸ', 'ä»·å€¼'];

        function normalizeText(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'string') return value.trim();
            return String(value).trim();
        }

        function getFundMatchKey(row) {
            const externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);
            const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
            return externalCode || assetCode || '';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            setupFileUpload();
        });

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const classificationInput = document.getElementById('classificationInput');
            const fileInput = document.getElementById('fileInput');

            classificationInput.addEventListener('change', handleClassificationUpload);
            fileInput.addEventListener('change', handleFileUpload);
        }

        // å¤„ç†åŸºé‡‘åˆ†ç±»è¡¨ä¸Šä¼ 
        function handleClassificationUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const loading = document.getElementById('loading');
            const classificationResult = document.getElementById('classificationResult');

            loading.classList.add('show');
            classificationResult.innerHTML = '';

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    let classificationSheet = workbook.Sheets['åŸºé‡‘åˆ†ç±»'] || workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(classificationSheet);

                    classificationData = jsonData;
                    fundClassifications = {};
                    let successCount = 0;

                    jsonData.forEach(row => {
                        const externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);
                        const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
                        const assetClass = normalizeText(row['èµ„äº§ç±»åˆ«ï¼ˆPAS)']);
                        const style = normalizeText(row['é£æ ¼']);
                        const equityPosition = parseInt(row['æƒç›Šä»“ä½']) || 0;

                        const matchKey = externalCode || assetCode;

                        if (matchKey && style && equityPosition >= 0) {
                            fundClassifications[matchKey] = {
                                assetClass: assetClass,
                                style: style,
                                equityPosition: equityPosition
                            };
                            successCount++;
                        }
                    });

                    // è¯»å–é£æ ¼é¡ºåº
                    if (workbook.Sheets['åŸºé‡‘é£æ ¼é¡ºåº']) {
                        const styleOrderData = XLSX.utils.sheet_to_json(workbook.Sheets['åŸºé‡‘é£æ ¼é¡ºåº']);
                        styleOrder = [];
                        styleOrderData.forEach(row => {
                            const style = normalizeText(row['é£æ ¼']);
                            if (style) styleOrder.push(style);
                        });
                    }

                    if (styleOrder.length === 0) {
                        styleOrder = ['çº¢åˆ©', 'å‡è¡¡', 'ç§‘æŠ€æˆé•¿', 'å‘¨æœŸ', 'ä»·å€¼'];
                    }

                    isClassificationLoaded = true;
                    loading.classList.remove('show');

                    let resultMsg = `âœ… æˆåŠŸåŠ è½½ ${successCount} ä¸ªåŸºé‡‘åˆ†ç±»`;
                    if (styleOrder.length > 0) resultMsg += `<br>ğŸ¨ é£æ ¼é¡ºåº: ${styleOrder.join('â†’')}`;

                    classificationResult.innerHTML = `<div class="success">${resultMsg}</div>`;

                    if (holdingData.length > 0) {
                        processData();
                    }
                } catch (error) {
                    loading.classList.remove('show');
                    classificationResult.innerHTML = `<div class="error">âŒ åŸºé‡‘åˆ†ç±»è¡¨å¤„ç†å¤±è´¥: ${error.message}</div>`;
                    console.error('åŸºé‡‘åˆ†ç±»è¡¨å¤„ç†å¤±è´¥:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // å¤„ç†æŒä»“è¡¨ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!isClassificationLoaded) {
                const holdingResult = document.getElementById('holdingResult');
                holdingResult.innerHTML = '<div class="error">âŒ è¯·å…ˆä¸Šä¼ åŸºé‡‘åˆ†ç±»è¡¨</div>';
                event.target.value = '';
                return;
            }

            const loading = document.getElementById('loading');
            const holdingResult = document.getElementById('holdingResult');

            loading.classList.add('show');
            holdingResult.innerHTML = '';

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // è¯»å–ç¬¬ä¸€ä¸ªsheetï¼ˆæŒä»“æ•°æ®ï¼‰
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    holdingData = XLSX.utils.sheet_to_json(firstSheet);

                    // è¯»å–ç¬¬äºŒä¸ªsheetï¼ˆäº¤æ˜“æƒ…å†µï¼‰
                    tradeData = [];
                    if (workbook.SheetNames.length > 1) {
                        const tradeSheet = workbook.Sheets[workbook.SheetNames[1]];
                        tradeData = XLSX.utils.sheet_to_json(tradeSheet);
                    }

                    processData();

                    loading.classList.remove('show');
                    let msg = `âœ… æˆåŠŸå¤„ç† ${holdingData.length} æ¡æŒä»“æ•°æ®`;
                    if (tradeData.length > 0) {
                        msg += `ï¼Œ${tradeData.length} æ¡äº¤æ˜“æ•°æ®`;
                    }
                    holdingResult.innerHTML = `<div class="success">${msg}</div>`;
                } catch (error) {
                    loading.classList.remove('show');
                    holdingResult.innerHTML = `<div class="error">âŒ æŒä»“è¡¨å¤„ç†å¤±è´¥: ${error.message}</div>`;
                    console.error('æŒä»“è¡¨å¤„ç†å¤±è´¥:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // å¤„ç†æ•°æ®
        function processData() {
            if (holdingData.length === 0) return;

            // æ„å»ºäº¤æ˜“æ˜ å°„è¡¨ï¼šäº§å“->èµ„äº§ä»£ç ->äº¤æ˜“è°ƒæ•´
            const tradeMap = {};
            tradeData.forEach(trade => {
                const productName = normalizeText(trade['äº§å“åç§°']);
                const assetCode = normalizeText(trade['èµ„äº§ä»£ç ']);
                const direction = normalizeText(trade['äº¤æ˜“æ–¹å‘']);

                if (!productName || !assetCode) return;

                if (!tradeMap[productName]) {
                    tradeMap[productName] = {};
                }
                if (!tradeMap[productName][assetCode]) {
                    tradeMap[productName][assetCode] = {
                        ç”³è´­: 0,
                        èµå›: 0,
                        å–å‡º: 0
                    };
                }

                if (direction === 'ç”³è´­') {
                    const amount = parseFloat(trade['å§”æ‰˜é‡‘é¢']) || 0;
                    tradeMap[productName][assetCode].ç”³è´­ += amount;
                } else if (direction === 'èµå›' || direction === 'å–å‡º') {
                    const quantity = parseFloat(trade['å§”æ‰˜æ•°é‡']) || 0;
                    tradeMap[productName][assetCode].èµå› += quantity;
                }
            });

            // è®¡ç®—äº§å“å‡€èµ„äº§ï¼ˆè°ƒä»“å‰ï¼‰
            const productNetAssets = {};
            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;

                if (!productName || holdingAmount === 0) return;

                if (!productNetAssets[productName]) {
                    productNetAssets[productName] = 0;
                }

                const isRepo = assetName && assetName.includes('æ­£å›è´­');
                if (isRepo) {
                    productNetAssets[productName] -= holdingAmount;
                } else {
                    productNetAssets[productName] += holdingAmount;
                }
            });

            // ç”Ÿæˆè¯¦ç»†æ•°æ®
            detailData = [];
            let matchedCount = 0;
            let unmatchedCount = 0;

            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;
                const holdingQuantity = parseFloat(row['æŒä»“é¢é¢']) || 0;
                const fullPrice = parseFloat(row['æ—¥ç»ˆå…¨ä»·ï¼ˆå…ƒï¼‰-äº§å“æ³•ä¼°å€¼']) || 0;

                if (!productName || !assetName || holdingAmount === 0) return;

                const matchKey = getFundMatchKey(row);
                const classification = fundClassifications[matchKey];

                if (!classification) {
                    if (matchKey) unmatchedCount++;
                    return;
                }

                matchedCount++;

                // è®¡ç®—äº¤æ˜“è°ƒä»“
                let tradeAdjustment = 0;
                let adjustedHolding = holdingAmount;

                if (tradeMap[productName] && tradeMap[productName][assetCode]) {
                    const trade = tradeMap[productName][assetCode];

                    // ç”³è´­ï¼šåŠ é‡‘é¢
                    if (trade.ç”³è´­ > 0) {
                        tradeAdjustment += trade.ç”³è´­;
                        adjustedHolding += trade.ç”³è´­;
                    }

                    // èµå›ï¼šç”¨ (æŒä»“é¢é¢ - èµå›ä»½é¢) * æ—¥ç»ˆå…¨ä»· - äº§å“æ³•ä¼°å€¼
                    if (trade.èµå› > 0 && fullPrice > 0) {
                        const newQuantity = holdingQuantity - trade.èµå›;
                        const newValue = newQuantity * fullPrice;
                        tradeAdjustment = newValue - holdingAmount;
                        adjustedHolding = newValue;
                    }
                }

                const equityExposure = adjustedHolding * (classification.equityPosition / 100);

                detailData.push({
                    productName,
                    assetName,
                    assetCode,
                    style: classification.style,
                    equityPosition: classification.equityPosition,
                    holdingAmount,
                    tradeAdjustment,
                    adjustedHolding,
                    equityExposure,
                    productNetAsset: productNetAssets[productName]
                });
            });

            console.log(`åŒ¹é…ç»Ÿè®¡: æˆåŠŸåŒ¹é… ${matchedCount} æ¡, æœªåŒ¹é… ${unmatchedCount} æ¡`);
            console.log(`äº¤æ˜“è°ƒä»“: ${Object.keys(tradeMap).length} ä¸ªäº§å“æœ‰äº¤æ˜“`);

            renderResults();
            renderDetailTable();

            const uploadResult = document.getElementById('uploadResult');
            uploadResult.innerHTML = `<div class="success">âœ… æ•°æ®å¤„ç†å®Œæˆ: æˆåŠŸåŒ¹é… ${matchedCount} æ¡æŒä»“ï¼Œå¤„ç† ${tradeData.length} æ¡äº¤æ˜“</div>`;
        }

        // æ¸²æŸ“ç»“æœ
        function renderResults() {
            renderSummaryStats();
        }

        // æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
        function renderSummaryStats() {
            const summaryStats = document.getElementById('summaryStats');

            // æŒ‰äº§å“å’Œé£æ ¼æ±‡æ€»
            const productStyleMap = {};
            let totalEquityExposure = 0;

            detailData.forEach(row => {
                if (!productStyleMap[row.productName]) {
                    productStyleMap[row.productName] = {};
                }
                if (!productStyleMap[row.productName][row.style]) {
                    productStyleMap[row.productName][row.style] = 0;
                }
                productStyleMap[row.productName][row.style] += row.equityExposure;
                totalEquityExposure += row.equityExposure;
            });

            const productCount = Object.keys(productStyleMap).length;
            const totalStyles = new Set();
            Object.values(productStyleMap).forEach(styles => {
                Object.keys(styles).forEach(style => totalStyles.add(style));
            });

            summaryStats.innerHTML = `
                <div class="stat-card">
                    <h4>äº§å“æ•°é‡</h4>
                    <div class="value">${productCount}</div>
                </div>
                <div class="stat-card">
                    <h4>é£æ ¼æ•°é‡</h4>
                    <div class="value">${totalStyles.size}</div>
                </div>
                <div class="stat-card">
                    <h4>æ€»æƒç›Šæš´éœ²ï¼ˆè°ƒä»“åï¼‰</h4>
                    <div class="value">${(totalEquityExposure / 100000000).toFixed(1)}äº¿</div>
                </div>
                <div class="stat-card">
                    <h4>äº¤æ˜“ç¬”æ•°</h4>
                    <div class="value">${tradeData.length}</div>
                </div>
            `;
        }

        // æ¸²æŸ“è¯¦ç»†æ•°æ®è¡¨æ ¼
        function renderDetailTable() {
            const tbody = document.getElementById('detailTableBody');
            tbody.innerHTML = '';

            // è®¡ç®—çœŸå®æƒç›Šå æ¯”
            detailData.forEach(row => {
                row.equityExposureRatio = row.productNetAsset > 0
                    ? (row.equityExposure / row.productNetAsset * 100)
                    : 0;
            });

            // æŒ‰äº§å“ã€é£æ ¼ã€æƒç›Šå æ¯”æ’åº
            const sortedData = [...detailData].sort((a, b) => {
                if (a.productName !== b.productName) {
                    return a.productName.localeCompare(b.productName);
                }
                const styleIndexA = styleOrder.indexOf(a.style);
                const styleIndexB = styleOrder.indexOf(b.style);
                if (styleIndexA !== styleIndexB) {
                    return (styleIndexA === -1 ? 999 : styleIndexA) - (styleIndexB === -1 ? 999 : styleIndexB);
                }
                return b.equityExposureRatio - a.equityExposureRatio;
            });

            sortedData.forEach(row => {
                const tr = document.createElement('tr');

                // è°ƒä»“é‡‘é¢æ˜¾ç¤º
                let tradeDisplay = '-';
                if (row.tradeAdjustment !== 0) {
                    const sign = row.tradeAdjustment > 0 ? '+' : '';
                    tradeDisplay = `${sign}${(row.tradeAdjustment / 10000).toFixed(0)}ä¸‡`;
                }

                tr.innerHTML = `
                    <td>${row.productName}</td>
                    <td>${row.assetName}</td>
                    <td style="font-family: monospace; color: #667eea;">${row.assetCode}</td>
                    <td>${row.style}</td>
                    <td>${row.equityPosition}%</td>
                    <td>${(row.holdingAmount / 10000).toFixed(0)}ä¸‡</td>
                    <td class="${row.tradeAdjustment !== 0 ? 'trade-adjustment' : ''}">${tradeDisplay}</td>
                    <td class="${row.tradeAdjustment !== 0 ? 'adjusted-holding' : ''}">${(row.adjustedHolding / 10000).toFixed(0)}ä¸‡</td>
                    <td>${(row.equityExposure / 10000).toFixed(0)}ä¸‡</td>
                    <td>${row.equityExposureRatio.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // å¯¼å‡ºåˆ†æç»“æœåˆ°Excel
        function exportResultsToExcel() {
            if (detailData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ å¹¶å¤„ç†æ•°æ®');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();

                // Sheet 1: è¯¦ç»†æ•°æ®
                const detailExportData = [];
                detailExportData.push(['äº§å“åç§°', 'åŸºé‡‘åç§°', 'èµ„äº§ä»£ç ', 'é£æ ¼', 'æƒç›Šä»“ä½', 'æ˜¨æ—¥æŒä»“é‡‘é¢(ä¸‡)', 'å½“æ—¥è°ƒä»“(ä¸‡)', 'è°ƒä»“åçœŸå®æŒä»“(ä¸‡)', 'çœŸå®æƒç›Šæš´éœ²(ä¸‡)', 'çœŸå®æƒç›Šå æ¯”']);

                const sortedData = [...detailData].sort((a, b) => {
                    if (a.productName !== b.productName) {
                        return a.productName.localeCompare(b.productName);
                    }
                    const styleIndexA = styleOrder.indexOf(a.style);
                    const styleIndexB = styleOrder.indexOf(b.style);
                    if (styleIndexA !== styleIndexB) {
                        return (styleIndexA === -1 ? 999 : styleIndexA) - (styleIndexB === -1 ? 999 : styleIndexB);
                    }
                    return (b.equityExposure / b.productNetAsset) - (a.equityExposure / a.productNetAsset);
                });

                sortedData.forEach(row => {
                    const equityExposureRatio = row.productNetAsset > 0
                        ? (row.equityExposure / row.productNetAsset * 100)
                        : 0;

                    detailExportData.push([
                        row.productName,
                        row.assetName,
                        row.assetCode,
                        row.style,
                        row.equityPosition + '%',
                        Math.round(row.holdingAmount / 10000),
                        row.tradeAdjustment !== 0 ? Math.round(row.tradeAdjustment / 10000) : '-',
                        Math.round(row.adjustedHolding / 10000),
                        Math.round(row.equityExposure / 10000),
                        equityExposureRatio.toFixed(2) + '%'
                    ]);
                });

                const ws1 = XLSX.utils.aoa_to_sheet(detailExportData);
                XLSX.utils.book_append_sheet(wb, ws1, 'æŒä»“æ˜ç»†ï¼ˆå«è°ƒä»“ï¼‰');

                // Sheet 2: äº§å“é£æ ¼æ±‡æ€»
                const summaryData = [];
                summaryData.push(['äº§å“åç§°', 'é£æ ¼', 'æƒç›Šæš´éœ²é‡‘é¢(ä¸‡)', 'æƒç›Šæš´éœ²å æ¯”']);

                const productStyleMap = {};
                detailData.forEach(row => {
                    if (!productStyleMap[row.productName]) {
                        productStyleMap[row.productName] = {};
                    }
                    if (!productStyleMap[row.productName][row.style]) {
                        productStyleMap[row.productName][row.style] = {
                            amount: 0,
                            netAsset: row.productNetAsset
                        };
                    }
                    productStyleMap[row.productName][row.style].amount += row.equityExposure;
                });

                Object.keys(productStyleMap).sort().forEach(productName => {
                    const styles = productStyleMap[productName];
                    const netAsset = styles[Object.keys(styles)[0]].netAsset;

                    styleOrder.forEach(style => {
                        if (styles[style]) {
                            const ratio = netAsset > 0 ? (styles[style].amount / netAsset * 100) : 0;
                            summaryData.push([
                                productName,
                                style,
                                Math.round(styles[style].amount / 10000),
                                ratio.toFixed(2) + '%'
                            ]);
                        }
                    });
                });

                const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, ws2, 'äº§å“é£æ ¼æ±‡æ€»');

                const fileName = `åŸºé‡‘åˆ†æç»“æœ_å«äº¤æ˜“_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert(`âœ… å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶åï¼š${fileName}`);
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        }

    </script>
</body>

</html>
