<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºé‡‘åˆ†ç±»æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ</title>
    <script src="xlsx.full.min.js"></script>
    <script src="chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f7;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #5a67d8;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #5a67d8;
            background: #e6f3ff;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #5a67d8;
        }

        .fund-settings {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-top: 20px;
        }

        .fund-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .fund-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 60px;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            align-items: center;
        }

        .fund-item:hover {
            background: #f8f9ff;
        }

        .fund-item input,
        .fund-item select {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .fund-item input:focus,
        .fund-item select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-fund-form {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }

        .product-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .product-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .style-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .style-item:last-child {
            border-bottom: none;
        }

        .style-name {
            font-weight: 600;
            color: #374151;
        }

        .style-amount {
            color: #667eea;
            font-weight: 600;
        }

        .style-percentage {
            color: #16a34a;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h4 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: 700;
        }

        .matrix-section {
            margin-top: 30px;
        }

        .matrix-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        .filter-section {
            flex: 1;
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .filter-section h4 {
            margin-bottom: 10px;
            color: #374151;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .filter-btn {
            padding: 6px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .filter-btn:hover {
            background: #5a67d8;
        }

        .filter-btn.secondary {
            background: #6b7280;
        }

        .filter-btn.secondary:hover {
            background: #4b5563;
        }

        .filter-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-checkbox input {
            margin: 0;
        }

        .filter-checkbox label {
            font-size: 0.9em;
            color: #374151;
            cursor: pointer;
        }

        .toggle-section {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .toggle-section h4 {
            margin-bottom: 10px;
            color: #374151;
        }

        .toggle-buttons {
            display: flex;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #d1d5db;
        }

        .toggle-btn {
            flex: 1;
            padding: 8px 16px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .matrix-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9em;
        }

        .matrix-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9em;
        }

        .matrix-table tr:hover {
            background: #f8f9ff;
        }

        .matrix-table .product-name {
            background: #f8f9ff;
            font-weight: 600;
            color: #374151;
            text-align: left;
            padding-left: 15px;
        }

        .matrix-table .amount-cell {
            color: #667eea;
            font-weight: 600;
        }

        .matrix-table .percentage-cell {
            color: #16a34a;
            font-weight: 600;
        }

        .matrix-table .zero-cell {
            color: #9ca3af;
            font-style: italic;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table tr:hover {
            background: #f8f9ff;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.show {
            display: block;
        }

        .error {
            color: #ef4444;
            background: #fef2f2;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .success {
            color: #16a34a;
            background: #f0fdf4;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .fund-settings {
                grid-template-columns: 1fr;
            }

            .fund-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        /* æœªåˆ†ç±»åŸºé‡‘æ ·å¼ */
        .unclassified-funds-container {
            background: #fff8f0;
            border: 2px solid #ff6b35;
            border-radius: 12px;
            padding: 20px;
        }

        .unclassified-fund-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 80px;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            align-items: center;
        }

        .unclassified-fund-item:hover {
            background: #f8f9ff;
            border-color: #667eea;
        }

        .unclassified-fund-item .fund-name {
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .unclassified-fund-item .asset-type {
            background: #ff6b35;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            text-align: center;
        }

        .unclassified-fund-item select,
        .unclassified-fund-item input {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .unclassified-fund-item select:focus,
        .unclassified-fund-item input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .unclassified-fund-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 80px;
            gap: 15px;
            padding: 10px 15px;
            background: #f8f9ff;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #667eea;
            font-size: 0.9em;
        }

        .batch-add-individual {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .batch-add-individual:hover {
            background: #059669;
        }

        /* èµ„äº§æŸ¥è¯¢æ ·å¼ */
        .asset-query-section {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 3px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .asset-query-inner {
            background: white;
            padding: 25px;
            border-radius: 12px;
        }

        .asset-query-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #f093fb;
            padding-bottom: 10px;
        }

        .query-controls {
            display: grid;
            grid-template-columns: 1fr 200px 150px;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        .search-container {
            position: relative;
        }

        .search-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #f093fb;
            box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.2);
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-dropdown.show {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .autocomplete-item:hover {
            background: #f8f9ff;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item .asset-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 3px;
        }

        .autocomplete-item .asset-code {
            font-size: 0.85em;
            color: #667eea;
            font-family: monospace;
        }

        .autocomplete-item .asset-tag {
            display: inline-block;
            background: #f093fb;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 8px;
        }

        .tag-select {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
        }

        .tag-select:focus {
            outline: none;
            border-color: #f093fb;
        }

        .query-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .query-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(240, 147, 251, 0.4);
        }

        .query-results {
            margin-top: 25px;
        }

        .query-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .query-results-header h3 {
            color: #333;
            font-size: 1.3em;
        }

        .query-results-summary {
            display: flex;
            gap: 20px;
        }

        .summary-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
        }

        .summary-item .label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .summary-item .value {
            font-size: 1.3em;
            font-weight: 700;
        }

        .query-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .query-table th {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .query-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .query-table tr:hover {
            background: #fef2f8;
        }

        .query-table .amount-cell {
            color: #667eea;
            font-weight: 600;
            text-align: right;
        }

        .query-table .percentage-cell {
            color: #16a34a;
            font-weight: 600;
            text-align: right;
        }

        .query-table .total-row {
            background: #f8f9ff;
            font-weight: 700;
        }

        .query-table .total-row td {
            border-top: 2px solid #667eea;
        }

        /* çŸ©é˜µè¡¨æ ¼æ ·å¼ */
        .query-table.matrix-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            white-space: normal;
            word-break: break-all;
            text-align: center;
            font-size: 0.82em;
            padding: 8px 6px;
            min-width: 80px;
            max-width: 120px;
            line-height: 1.3;
        }

        .query-table.matrix-table td {
            padding: 8px 10px;
            vertical-align: middle;
        }

        .query-table.matrix-table td:first-child {
            font-weight: 500;
            white-space: nowrap;
        }

        .query-table.matrix-table tr:nth-child(even) {
            background: #fafbff;
        }

        .query-table.matrix-table tr:hover {
            background: #f0f4ff;
        }

        /* çŸ©é˜µè¡¨æ ¼å æ¯”é¢œè‰² */
        .query-table.matrix-table .percentage-text {
            font-size: 0.85em;
            color: #10b981;
            font-weight: 600;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .no-results .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .asset-tag-badge {
            display: inline-block;
            background: #f093fb;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .tag-group-header {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tag-group-header h4 {
            color: #333;
            margin: 0;
        }

        .tag-assets-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tag-asset-chip {
            background: #e2e8f0;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #4b5563;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>åŸºé‡‘åˆ†ç±»æ ‡ç­¾ç®¡ç†ç³»ç»Ÿ</h1>
            <p>ä¸Šä¼ æŒä»“æ˜ç»†è¡¨ï¼Œè‡ªåŠ¨è®¡ç®—å„äº§å“ä¸åŒé£æ ¼çš„æƒç›Šæš´éœ²å æ¯”</p>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“ ä¸Šä¼ æ•°æ®æ–‡ä»¶</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- åŸºé‡‘åˆ†ç±»è¡¨ä¸Šä¼  -->
                <div class="upload-area" id="classificationUploadArea">
                    <p style="font-size: 1.1em; margin-bottom: 10px; font-weight: 600;">ğŸ“‹ 1. åŸºé‡‘åˆ†ç±»è¡¨</p>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">è¯·å…ˆä¸Šä¼ åŸºé‡‘åˆ†ç±»è¡¨</p>
                    <button class="upload-btn" onclick="document.getElementById('classificationInput').click()">é€‰æ‹©åˆ†ç±»è¡¨</button>
                    <input type="file" id="classificationInput" class="file-input" accept=".xlsx,.xls" />
                    <div id="classificationResult" style="margin-top: 10px;"></div>
                </div>

                <!-- æŒä»“æ˜ç»†è¡¨ä¸Šä¼  -->
                <div class="upload-area" id="holdingUploadArea">
                    <p style="font-size: 1.1em; margin-bottom: 10px; font-weight: 600;">ğŸ“Š 2. æŒä»“æ˜ç»†è¡¨</p>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">ä¸Šä¼ æŒä»“ç›ˆäºè¡¨</p>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">é€‰æ‹©æŒä»“è¡¨</button>
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
                    <div id="holdingResult" style="margin-top: 10px;"></div>
                </div>
            </div>
            <div class="loading" id="loading">
                <p>ğŸ“Š æ­£åœ¨å¤„ç†æ•°æ®...</p>
            </div>
            <div id="uploadResult"></div>
        </div>


        <!-- èµ„äº§æŸ¥è¯¢åŒºåŸŸ -->
        <div class="asset-query-section" id="assetQuerySection" style="display: none;">
            <div class="asset-query-inner">
                <h2>ğŸ” èµ„äº§æŸ¥è¯¢</h2>

                <div class="query-controls">
                    <div class="search-container">
                        <label>æœç´¢èµ„äº§ï¼ˆåç§°/ä»£ç ï¼‰</label>
                        <input type="text" class="search-input" id="assetSearchInput"
                               placeholder="è¾“å…¥èµ„äº§åç§°/ä»£ç ï¼Œæ”¯æŒç²˜è´´å¤šä¸ªï¼ˆé€—å·ã€ç©ºæ ¼åˆ†éš”ï¼‰"
                               oninput="handleAssetSearch(this.value)"
                               onfocus="showAutocomplete()"
                               autocomplete="off" />
                        <div class="autocomplete-dropdown" id="autocompleteDropdown">
                            <!-- è‡ªåŠ¨è¡¥å…¨é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <div>
                        <label>æŒ‰æ ‡ç­¾ç­›é€‰</label>
                        <select class="tag-select" id="tagSelect" onchange="handleTagSelect(this.value)">
                            <option value="">-- é€‰æ‹©æ ‡ç­¾ --</option>
                            <!-- æ ‡ç­¾é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>

                    <button class="query-btn" onclick="clearAssetQuery()">
                        ğŸ”„ æ¸…ç©ºæŸ¥è¯¢
                    </button>
                </div>

                <div class="query-results" id="queryResults">
                    <div class="no-results">
                        <div class="icon">ğŸ”</div>
                        <p>è¯·è¾“å…¥èµ„äº§åç§°/ä»£ç æœç´¢ï¼Œæˆ–é€‰æ‹©æ ‡ç­¾æŸ¥çœ‹èµ„äº§åˆ†å¸ƒ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœªåˆ†ç±»å«æƒåŸºé‡‘æç¤ºåŒºåŸŸ -->
        <div class="section" id="unclassifiedEquitySection" style="display: none;">
            <div id="unclassifiedEquityContent">
                <!-- æœªåˆ†ç±»å«æƒåŸºé‡‘æç¤ºå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- åˆ†æç»“æœåŒºåŸŸ -->
        <div class="section">
            <h2>ğŸ“Š åˆ†æç»“æœ</h2>

            <!-- å¯¼å‡ºåŠŸèƒ½ -->
            <div style="margin-bottom: 20px; text-align: right;">
                <button class="btn btn-primary" onclick="exportResultsToExcel()" style="font-size: 1em; padding: 12px 24px;">
                    ğŸ“¥ å¯¼å‡ºåˆ†æç»“æœåˆ°Excel
                </button>
            </div>

            <div class="summary-stats" id="summaryStats">
                <!-- ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>

            <!-- çŸ©é˜µè¡¨æ ¼ -->
            <div class="matrix-section">
                <div class="matrix-controls">
                    <div class="filter-section">
                        <h4>äº§å“ç­›é€‰</h4>
                        <div class="filter-controls">
                            <button class="filter-btn" onclick="selectAllProducts()">å…¨é€‰</button>
                            <button class="filter-btn secondary" onclick="deselectAllProducts()">å…¨ä¸é€‰</button>
                        </div>
                        <div class="filter-checkboxes" id="productFilters">
                            <!-- äº§å“ç­›é€‰å¤é€‰æ¡†å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <div class="toggle-section">
                        <h4>æ˜¾ç¤ºç±»å‹</h4>
                        <div class="toggle-buttons">
                            <button class="toggle-btn active" onclick="toggleMatrixDisplay('amount')">é‡‘é¢</button>
                            <button class="toggle-btn" onclick="toggleMatrixDisplay('percentage')">å æ¯”</button>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="matrix-table" id="matrixTable">
                        <!-- çŸ©é˜µè¡¨æ ¼å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </table>
                </div>
            </div>

            <div class="results-grid" id="resultsGrid">
                <!-- åˆ†æç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
        <div class="section">
            <h2>ğŸ“‹ è¯¦ç»†æ•°æ®</h2>
            <div id="tradeDataInfo" style="display: none; margin-bottom: 15px;">
                <div style="background: #fff8f0; border: 1px solid #ff6b35; border-radius: 8px; padding: 12px;">
                    <span style="color: #ff6b35; font-weight: 600;">ğŸ“ å·²åŠ è½½äº¤æ˜“æ•°æ®</span>
                    <span style="color: #666; margin-left: 10px;">æ©™è‰²é«˜äº®è¡¨ç¤ºå½“æ—¥æœ‰è°ƒä»“ï¼Œç»¿è‰²é«˜äº®è¡¨ç¤ºè°ƒä»“åæŒä»“</span>
                </div>
            </div>
            <div class="table-container">
                <table class="data-table" id="detailTable">
                    <thead>
                        <tr>
                            <th>äº§å“åç§°</th>
                            <th>åŸºé‡‘åç§°</th>
                            <th>èµ„äº§ä»£ç </th>
                            <th>é£æ ¼</th>
                            <th>æƒç›Šä»“ä½</th>
                            <th>æ˜¨æ—¥æŒä»“(ä¸‡)</th>
                            <th>å½“æ—¥è°ƒä»“(ä¸‡)</th>
                            <th>è°ƒä»“åæŒä»“(ä¸‡)</th>
                            <th>æƒç›Šæš´éœ²(ä¸‡)</th>
                            <th>æƒç›Šå æ¯”</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                        <!-- è¯¦ç»†æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let fundClassifications = {}; // ä»åŸºé‡‘åˆ†ç±»è¡¨å¯¼å…¥çš„æ•°æ®
        let classificationData = []; // åŸå§‹åŸºé‡‘åˆ†ç±»è¡¨æ•°æ®
        let holdingData = [];
        let tradeData = []; // äº¤æ˜“æƒ…å†µæ•°æ®
        let tradeMap = {}; // äº¤æ˜“æ˜ å°„ (äº§å“å, èµ„äº§ä»£ç ) -> {ç”³è´­é‡‘é¢, èµå›æ•°é‡}
        let analysisResults = {};
        let selectedProducts = new Set();
        let matrixDisplayType = 'amount';
        let isClassificationLoaded = false; // æ ‡è®°æ˜¯å¦å·²åŠ è½½åˆ†ç±»è¡¨
        let productOrder = []; // ä»Excelå¯¼å…¥çš„äº§å“é¡ºåº
        let styleOrder = []; // ä»Excelå¯¼å…¥çš„é£æ ¼é¡ºåº
        let hasTradeData = false; // æ˜¯å¦æœ‰äº¤æ˜“æ•°æ®

        // èµ„äº§æŸ¥è¯¢ç›¸å…³å˜é‡
        let assetTagData = []; // èµ„äº§æ ‡ç­¾æ•°æ®
        let assetTagMap = {}; // èµ„äº§ä»£ç  -> æ ‡ç­¾ä¿¡æ¯çš„æ˜ å°„
        let allAssetsList = []; // æ‰€æœ‰èµ„äº§åˆ—è¡¨ï¼ˆç”¨äºè‡ªåŠ¨è¡¥å…¨ï¼‰
        let productNetAssets = {}; // å„äº§å“å‡€èµ„äº§

        // éœ€è¦æ£€æµ‹åˆ†ç±»çš„å«æƒèµ„äº§å°ç±»
        const EQUITY_ASSET_CLASSES = [
            'è¢«åŠ¨æŒ‡æ•°å‹åŸºé‡‘',
            'æ··åˆå€ºåˆ¸å‹äºŒçº§åŸºé‡‘',
            'åè‚¡æ··åˆå‹åŸºé‡‘',
            'æ™®é€šè‚¡ç¥¨å‹åŸºé‡‘',
            'çµæ´»é…ç½®å‹åŸºé‡‘'
        ];

        function normalizeText(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'string') return value.trim();
            return String(value).trim();
        }

        // ç®€åŒ–èµ„äº§åç§°ï¼Œå»æ‰é€šç”¨åç¼€
        function shortenAssetName(name) {
            if (!name) return '';
            // éœ€è¦å»æ‰çš„é€šç”¨åç¼€
            const suffixes = [
                'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’',
                'é›†åˆèµ„é‡‘ä¿¡æ‰˜è®¡åˆ’',
                'å•ä¸€èµ„äº§ç®¡ç†è®¡åˆ’',
                'å•ä¸€èµ„é‡‘ä¿¡æ‰˜è®¡åˆ’',
                'èµ„äº§ç®¡ç†è®¡åˆ’',
                'èµ„é‡‘ä¿¡æ‰˜è®¡åˆ’',
                'ä¿¡æ‰˜è®¡åˆ’',
                'ç®¡ç†è®¡åˆ’'
            ];
            let result = name;
            for (const suffix of suffixes) {
                if (result.endsWith(suffix)) {
                    result = result.slice(0, -suffix.length);
                    break;
                }
            }
            return result.trim();
        }

        // æ ¹æ®è‡ªå®šä¹‰é¡ºåºæ’åºé£æ ¼
        function sortByStyleOrder(styles) {
            return Array.from(styles).sort((a, b) => {
                const indexA = styleOrder.indexOf(a);
                const indexB = styleOrder.indexOf(b);
                // å¦‚æœåœ¨é¡ºåºè¡¨ä¸­æ‰¾ä¸åˆ°ï¼Œæ”¾åˆ°æœ€åï¼ŒæŒ‰å­—æ¯é¡ºåºæ’åˆ—
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        }

        // æ ¹æ®è‡ªå®šä¹‰é¡ºåºæ’åºäº§å“
        function sortByProductOrder(products) {
            return Array.from(products).sort((a, b) => {
                const indexA = productOrder.indexOf(a);
                const indexB = productOrder.indexOf(b);
                // å¦‚æœåœ¨é¡ºåºè¡¨ä¸­æ‰¾ä¸åˆ°ï¼Œæ”¾åˆ°æœ€åï¼ŒæŒ‰å­—æ¯é¡ºåºæ’åˆ—
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
        }

        // åˆ›å»ºåŸºé‡‘åŒ¹é…é”®çš„å‡½æ•° - ä½¿ç”¨å¤–éƒ¨ä»£ç æˆ–èµ„äº§ä»£ç åŒ¹é…
        function getFundMatchKey(row) {
            const externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);
            const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);

            // ä¼˜å…ˆä½¿ç”¨å¤–éƒ¨ä»£ç ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨èµ„äº§ä»£ç 
            // ä¸“æˆ·é€šå¸¸æ²¡æœ‰å¤–éƒ¨ä»£ç ï¼Œéœ€è¦ç”¨èµ„äº§ä»£ç åŒ¹é…
            if (externalCode && externalCode !== '0' && externalCode !== 'nan') {
                return externalCode;
            }
            return assetCode || '';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            setupFileUpload();
        });

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const classificationInput = document.getElementById('classificationInput');
            const fileInput = document.getElementById('fileInput');

            // åŸºé‡‘åˆ†ç±»è¡¨ä¸Šä¼ 
            classificationInput.addEventListener('change', handleClassificationUpload);

            // æŒä»“æ˜ç»†è¡¨ä¸Šä¼ 
            fileInput.addEventListener('change', handleFileUpload);
        }

        // å¤„ç†åŸºé‡‘åˆ†ç±»è¡¨ä¸Šä¼ 
        function handleClassificationUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const loading = document.getElementById('loading');
            const classificationResult = document.getElementById('classificationResult');

            loading.classList.add('show');
            classificationResult.innerHTML = '';

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // è¯»å–åŸºé‡‘åˆ†ç±»sheetï¼ˆç¬¬ä¸€ä¸ªsheetæˆ–åä¸º"åŸºé‡‘åˆ†ç±»"çš„sheetï¼‰
                    let classificationSheet = workbook.Sheets['åŸºé‡‘åˆ†ç±»'] || workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(classificationSheet);

                    classificationData = jsonData;

                    // å¤„ç†åŸºé‡‘åˆ†ç±»æ•°æ® - åŒæ—¶ä½¿ç”¨å¤–éƒ¨ä»£ç å’Œèµ„äº§ä»£ç å»ºç«‹æ˜ å°„
                    fundClassifications = {};
                    let successCount = 0;
                    let skipCount = 0;

                    jsonData.forEach(row => {
                        let externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);
                        const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
                        const assetClass = normalizeText(row['èµ„äº§ç±»åˆ«ï¼ˆPAS)']);
                        const style = normalizeText(row['é£æ ¼']);
                        const equityPosition = parseInt(row['æƒç›Šä»“ä½']) || 0;

                        // å¦‚æœå¤–éƒ¨ä»£ç æ˜¯"0"æˆ–ç©ºï¼Œåˆ™å¿½ç•¥
                        if (externalCode === '0' || externalCode === '') {
                            externalCode = '';
                        }

                        if (!style || equityPosition < 0) {
                            skipCount++;
                            return;
                        }

                        const classificationInfo = {
                            assetClass: assetClass,
                            style: style,
                            equityPosition: equityPosition
                        };

                        // åŒæ—¶ç”¨å¤–éƒ¨ä»£ç å’Œèµ„äº§ä»£ç å»ºç«‹æ˜ å°„
                        if (externalCode) {
                            fundClassifications[externalCode] = classificationInfo;
                            successCount++;
                        }
                        if (assetCode) {
                            fundClassifications[assetCode] = classificationInfo;
                            if (!externalCode) successCount++; // åªæœ‰å½“æ²¡æœ‰å¤–éƒ¨ä»£ç æ—¶æ‰è®¡æ•°
                        }

                        if (!externalCode && !assetCode) {
                            skipCount++;
                        }
                    });

                    console.log('åŸºé‡‘åˆ†ç±»æ˜ å°„è¯¦æƒ…:', fundClassifications);

                    // è¯»å–äº§å“å±•ç¤ºé¡ºåºsheet
                    productOrder = [];
                    if (workbook.Sheets['äº§å“å±•ç¤ºé¡ºåº']) {
                        const productOrderData = XLSX.utils.sheet_to_json(workbook.Sheets['äº§å“å±•ç¤ºé¡ºåº']);
                        productOrderData.forEach(row => {
                            const productName = normalizeText(row['äº§å“ç®€ç§°']);
                            if (productName) {
                                productOrder.push(productName);
                            }
                        });
                        console.log('äº§å“é¡ºåºåŠ è½½å®Œæˆï¼Œæ•°é‡:', productOrder.length, productOrder);
                    }

                    // è¯»å–åŸºé‡‘é£æ ¼å±•ç¤ºé¡ºåºsheet
                    styleOrder = [];
                    if (workbook.Sheets['åŸºé‡‘é£æ ¼å±•ç¤ºé¡ºåº']) {
                        const styleOrderData = XLSX.utils.sheet_to_json(workbook.Sheets['åŸºé‡‘é£æ ¼å±•ç¤ºé¡ºåº']);
                        styleOrderData.forEach(row => {
                            const style = normalizeText(row['é£æ ¼']);
                            if (style) {
                                styleOrder.push(style);
                            }
                        });
                        console.log('é£æ ¼é¡ºåºåŠ è½½å®Œæˆï¼Œæ•°é‡:', styleOrder.length, styleOrder);
                    }

                    // å¦‚æœæ²¡æœ‰ä»Excelè¯»å–åˆ°é£æ ¼é¡ºåºï¼Œä½¿ç”¨é»˜è®¤é¡ºåº
                    if (styleOrder.length === 0) {
                        styleOrder = ['çº¢åˆ©', 'å‡è¡¡', 'ç§‘æŠ€æˆé•¿', 'å‘¨æœŸ', 'ä»·å€¼'];
                    }

                    // è¯»å–èµ„äº§æ ‡ç­¾Sheet
                    assetTagData = [];
                    assetTagMap = {};
                    if (workbook.Sheets['èµ„äº§æ ‡ç­¾']) {
                        assetTagData = XLSX.utils.sheet_to_json(workbook.Sheets['èµ„äº§æ ‡ç­¾']);
                        assetTagData.forEach(row => {
                            const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
                            if (assetCode) {
                                assetTagMap[assetCode] = {
                                    assetName: normalizeText(row['èµ„äº§ç®€ç§°']),
                                    tag: normalizeText(row['æ ‡ç­¾']),
                                    category: normalizeText(row['ç»†åˆ†èµ„äº§ç±»åˆ«']),
                                    subClass: normalizeText(row['æ–°ç‰ˆèµ„äº§å°ç±»'])
                                };
                            }
                        });
                        console.log('èµ„äº§æ ‡ç­¾åŠ è½½å®Œæˆï¼Œæ•°é‡:', assetTagData.length);
                    }

                    isClassificationLoaded = true;
                    loading.classList.remove('show');

                    let resultMsg = `âœ… æˆåŠŸåŠ è½½ ${successCount} ä¸ªåŸºé‡‘åˆ†ç±»`;
                    if (skipCount > 0) resultMsg += ` (è·³è¿‡ ${skipCount} ä¸ªæ— æ•ˆè®°å½•)`;
                    if (productOrder.length > 0) resultMsg += `<br>ğŸ“‹ äº§å“é¡ºåº: ${productOrder.length} ä¸ª`;
                    if (styleOrder.length > 0) resultMsg += `<br>ğŸ¨ é£æ ¼é¡ºåº: ${styleOrder.join('â†’')}`;
                    if (assetTagData.length > 0) resultMsg += `<br>ğŸ·ï¸ èµ„äº§æ ‡ç­¾: ${assetTagData.length} ä¸ª`;

                    classificationResult.innerHTML = `<div class="success">${resultMsg}</div>`;

                    // æ›´æ–°æ ‡ç­¾ä¸‹æ‹‰æ¡†
                    updateTagSelect();

                    console.log('åŸºé‡‘åˆ†ç±»æ•°æ®åŠ è½½å®Œæˆï¼Œæ•°é‡:', successCount);

                    // å¦‚æœå·²ç»ä¸Šä¼ äº†æŒä»“è¡¨ï¼Œé‡æ–°å¤„ç†
                    if (holdingData.length > 0) {
                        processData();
                    }
                } catch (error) {
                    loading.classList.remove('show');
                    classificationResult.innerHTML = `<div class="error">âŒ åŸºé‡‘åˆ†ç±»è¡¨å¤„ç†å¤±è´¥: ${error.message}</div>`;
                    console.error('åŸºé‡‘åˆ†ç±»è¡¨å¤„ç†å¤±è´¥:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // å¤„ç†æŒä»“è¡¨ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½åŸºé‡‘åˆ†ç±»è¡¨
            if (!isClassificationLoaded) {
                const holdingResult = document.getElementById('holdingResult');
                holdingResult.innerHTML = '<div class="error">âŒ è¯·å…ˆä¸Šä¼ åŸºé‡‘åˆ†ç±»è¡¨</div>';
                event.target.value = '';
                return;
            }

            const loading = document.getElementById('loading');
            const holdingResult = document.getElementById('holdingResult');

            loading.classList.add('show');
            holdingResult.innerHTML = '';

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    holdingData = jsonData;

                    // å°è¯•è¯»å–äº¤æ˜“æƒ…å†µSheet
                    tradeData = [];
                    tradeMap = {};
                    hasTradeData = false;

                    if (workbook.Sheets['äº¤æ˜“æƒ…å†µ']) {
                        tradeData = XLSX.utils.sheet_to_json(workbook.Sheets['äº¤æ˜“æƒ…å†µ']);
                        hasTradeData = tradeData.length > 0;
                        if (hasTradeData) {
                            buildTradeMap();
                            console.log('äº¤æ˜“æ•°æ®åŠ è½½å®Œæˆï¼Œæ•°é‡:', tradeData.length);
                        }
                    }

                    processData();

                    // æ„å»ºèµ„äº§åˆ—è¡¨ç”¨äºè‡ªåŠ¨è¡¥å…¨
                    buildAssetsList();

                    // æ˜¾ç¤ºèµ„äº§æŸ¥è¯¢åŒºåŸŸ
                    document.getElementById('assetQuerySection').style.display = 'block';

                    loading.classList.remove('show');
                    let resultMsg = `âœ… æˆåŠŸå¤„ç† ${jsonData.length} æ¡æŒä»“æ•°æ®`;
                    if (hasTradeData) {
                        resultMsg += `<br>ğŸ“ æ£€æµ‹åˆ° ${tradeData.length} æ¡äº¤æ˜“è®°å½•ï¼Œå·²è‡ªåŠ¨è°ƒæ•´æŒä»“`;
                    }
                    holdingResult.innerHTML = `<div class="success">${resultMsg}</div>`;
                } catch (error) {
                    loading.classList.remove('show');
                    holdingResult.innerHTML = `<div class="error">âŒ æŒä»“è¡¨å¤„ç†å¤±è´¥: ${error.message}</div>`;
                    console.error('æŒä»“è¡¨å¤„ç†å¤±è´¥:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // æ„å»ºäº¤æ˜“æ˜ å°„
        function buildTradeMap() {
            tradeMap = {};

            console.log('å¼€å§‹æ„å»ºäº¤æ˜“æ˜ å°„ï¼Œäº§å“é¡ºåºè¡¨:', productOrder);

            tradeData.forEach(trade => {
                const productFullName = normalizeText(trade['äº§å“åç§°']);
                const tradeAssetCode = normalizeText(trade['èµ„äº§ä»£ç ']);
                const assetName = normalizeText(trade['èµ„äº§åç§°']);
                const direction = normalizeText(trade['äº¤æ˜“æ–¹å‘']);

                if (!productFullName || !tradeAssetCode) {
                    console.log('è·³è¿‡æ— æ•ˆäº¤æ˜“:', productFullName, tradeAssetCode);
                    return;
                }

                // åŒ¹é…äº§å“ç®€ç§° - æ£€æŸ¥äº§å“ç®€ç§°æ˜¯å¦åŒ…å«åœ¨å®Œæ•´åç§°ä¸­
                let productShortName = null;
                for (const shortName of productOrder) {
                    if (productFullName.includes(shortName)) {
                        productShortName = shortName;
                        break;
                    }
                }

                // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œå°è¯•ä»æŒä»“æ•°æ®ä¸­è·å–äº§å“ç®€ç§°
                if (!productShortName) {
                    // å°è¯•ä»æŒä»“æ•°æ®ä¸­æ‰¾åˆ°å¯¹åº”çš„äº§å“ç®€ç§°
                    for (const row of holdingData) {
                        const holdingProductName = normalizeText(row['äº§å“ç®€ç§°']);
                        if (productFullName.includes(holdingProductName)) {
                            productShortName = holdingProductName;
                            break;
                        }
                    }
                }

                if (!productShortName) {
                    console.log('æœªåŒ¹é…åˆ°äº§å“ç®€ç§°:', productFullName);
                    return;
                }

                const key = `${productShortName}|${tradeAssetCode}`;

                if (!tradeMap[key]) {
                    tradeMap[key] = {
                        assetName: assetName,
                        purchaseAmount: 0,
                        redeemQuantity: 0
                    };
                }

                if (direction === 'ç”³è´­') {
                    const amount = parseFloat(trade['å§”æ‰˜é‡‘é¢']) || 0;
                    tradeMap[key].purchaseAmount += amount;
                    console.log(`ç”³è´­: ${productShortName} - ${assetName}, é‡‘é¢: ${amount}`);
                } else if (direction === 'èµå›' || direction === 'å–å‡º') {
                    const quantity = parseFloat(trade['å§”æ‰˜æ•°é‡']) || 0;
                    tradeMap[key].redeemQuantity += quantity;
                    console.log(`èµå›: ${productShortName} - ${assetName}, æ•°é‡: ${quantity}`);
                }
            });

            console.log('äº¤æ˜“æ˜ å°„æ„å»ºå®Œæˆ:', Object.keys(tradeMap).length, 'æ¡');
            console.log('äº¤æ˜“æ˜ å°„è¯¦æƒ…:', tradeMap);
        }

        // å¤„ç†æ•°æ®
        function processData() {
            if (holdingData.length === 0) return;

            const productResults = {};
            productNetAssets = {}; // æ›´æ–°å…¨å±€å˜é‡ï¼Œå­˜å‚¨å„äº§å“çš„å‡€èµ„äº§
            let matchedCount = 0;
            let unmatchedCount = 0;
            let tradeAdjustedCount = 0;

            // å­˜å‚¨æœªåˆ†ç±»çš„å«æƒåŸºé‡‘
            const unclassifiedEquityFunds = new Map(); // ä½¿ç”¨Mapé¿å…é‡å¤ï¼Œkeyä¸ºmatchKey

            // è°ƒè¯•ï¼šæ£€æŸ¥Excelæ–‡ä»¶çš„åˆ—å
            if (holdingData.length > 0) {
                console.log('æŒä»“è¡¨åˆ—å:', Object.keys(holdingData[0]));
            }

            // é¦–å…ˆè®¡ç®—å„äº§å“çš„å‡€èµ„äº§
            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;

                if (!productName || holdingAmount === 0) return;

                if (!productNetAssets[productName]) {
                    productNetAssets[productName] = 0;
                }

                // æ£€æŸ¥æ˜¯å¦ä¸ºæ­£å›è´­
                const isRepo = assetName && assetName.includes('æ­£å›è´­');

                if (isRepo) {
                    // æ­£å›è´­ä»å‡€èµ„äº§ä¸­å‡å»
                    productNetAssets[productName] -= holdingAmount;
                } else {
                    // å…¶ä»–èµ„äº§åŠ å…¥å‡€èµ„äº§
                    productNetAssets[productName] += holdingAmount;
                }
            });

            // è®°å½•å·²å¤„ç†çš„äº¤æ˜“é”®
            const processedTradeKeys = new Set();

            // å¤„ç†æ¯æ¡æŒä»“è®°å½•
            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                let holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;
                const holdingQuantity = parseFloat(row['æŒä»“é¢é¢']) || 0;
                const fullPrice = parseFloat(row['æ—¥ç»ˆå…¨ä»·ï¼ˆå…ƒï¼‰-äº§å“æ³•ä¼°å€¼']) || 0;
                const assetSubClass = normalizeText(row['æ–°ç‰ˆèµ„äº§å°ç±»']);
                const externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);

                if (!productName || !assetName || holdingAmount === 0) return;

                // ä½¿ç”¨å¤–éƒ¨ä»£ç æˆ–èµ„äº§ä»£ç åŒ¹é…
                const matchKey = getFundMatchKey(row);
                const classification = fundClassifications[matchKey];

                // æ£€æµ‹å«æƒèµ„äº§æ˜¯å¦å·²åˆ†ç±»
                if (!classification && matchKey && EQUITY_ASSET_CLASSES.includes(assetSubClass)) {
                    // è¿™æ˜¯ä¸€ä¸ªéœ€è¦åˆ†ç±»çš„å«æƒåŸºé‡‘ï¼Œä½†æœªåœ¨åˆ†ç±»è¡¨ä¸­æ‰¾åˆ°
                    if (!unclassifiedEquityFunds.has(matchKey)) {
                        unclassifiedEquityFunds.set(matchKey, {
                            matchKey: matchKey,
                            assetName: assetName,
                            assetSubClass: assetSubClass,
                            externalCode: normalizeText(row['å¤–éƒ¨ä»£ç ']),
                            assetCode: normalizeText(row['èµ„äº§ä»£ç '])
                        });
                    }
                }

                // å¦‚æœæ²¡æœ‰åˆ†ç±»ä¿¡æ¯ï¼Œè·³è¿‡å¤„ç†
                if (!classification) {
                    if (matchKey) {
                        unmatchedCount++;
                        console.log('æœªåŒ¹é…åˆ°åŸºé‡‘:', assetName, 'åŒ¹é…é”®:', matchKey);
                    }
                    return;
                }

                matchedCount++;

                // å¤„ç†äº¤æ˜“è°ƒä»“ - ä½¿ç”¨å¤–éƒ¨ä»£ç æˆ–èµ„äº§ä»£ç åŒ¹é…
                let adjustedHolding = holdingAmount;
                const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
                const matchCode = (externalCode && externalCode !== 'nan') ? externalCode : assetCode;
                const tradeKey = matchCode ? `${productName}|${matchCode}` : null;

                if (tradeKey && tradeMap[tradeKey]) {
                    processedTradeKeys.add(tradeKey);
                    const tradeInfo = tradeMap[tradeKey];

                    // ç”³è´­å¢åŠ æŒä»“
                    if (tradeInfo.purchaseAmount > 0) {
                        adjustedHolding += tradeInfo.purchaseAmount;
                        tradeAdjustedCount++;
                    }

                    // èµå›å‡å°‘æŒä»“
                    if (tradeInfo.redeemQuantity > 0 && fullPrice > 0 && holdingQuantity >= tradeInfo.redeemQuantity) {
                        const newQuantity = holdingQuantity - tradeInfo.redeemQuantity;
                        adjustedHolding = newQuantity * fullPrice;
                        tradeAdjustedCount++;
                    }
                }

                const equityExposure = adjustedHolding * (classification.equityPosition / 100);

                if (!productResults[productName]) {
                    productResults[productName] = {};
                }

                if (!productResults[productName][classification.style]) {
                    productResults[productName][classification.style] = 0;
                }

                productResults[productName][classification.style] += equityExposure;
            });

            // å¤„ç†æ–°ç”³è´­èµ„äº§ï¼ˆæŒä»“è¡¨ä¸­æ²¡æœ‰çš„ï¼‰
            Object.keys(tradeMap).forEach(tradeKey => {
                if (processedTradeKeys.has(tradeKey)) return;

                const tradeInfo = tradeMap[tradeKey];
                if (tradeInfo.purchaseAmount <= 0) return;

                const [productName, assetCode] = tradeKey.split('|');
                const classification = fundClassifications[assetCode];

                if (!classification) return;

                matchedCount++;
                tradeAdjustedCount++;

                const equityExposure = tradeInfo.purchaseAmount * (classification.equityPosition / 100);

                if (!productResults[productName]) {
                    productResults[productName] = {};
                }

                if (!productResults[productName][classification.style]) {
                    productResults[productName][classification.style] = 0;
                }

                productResults[productName][classification.style] += equityExposure;
            });

            console.log(`åŒ¹é…ç»Ÿè®¡: æˆåŠŸåŒ¹é… ${matchedCount} æ¡, æœªåŒ¹é… ${unmatchedCount} æ¡, äº¤æ˜“è°ƒæ•´ ${tradeAdjustedCount} æ¡`);

            // è®¡ç®—å æ¯”
            Object.keys(productResults).forEach(productName => {
                const totalEquity = Object.values(productResults[productName]).reduce((sum, value) => sum + value, 0);
                Object.keys(productResults[productName]).forEach(style => {
                    const amount = productResults[productName][style];
                    productResults[productName][style] = {
                        amount: amount,
                        percentage: totalEquity > 0 ? (amount / totalEquity) * 100 : 0
                    };
                });
            });

            analysisResults = productResults;

            // åˆå§‹åŒ–é€‰ä¸­æ‰€æœ‰äº§å“
            selectedProducts.clear();
            Object.keys(productResults).forEach(product => {
                selectedProducts.add(product);
            });

            renderResults();
            renderDetailTable(calculateDetailData());

            // æ¸²æŸ“æœªåˆ†ç±»å«æƒåŸºé‡‘æç¤º
            renderUnclassifiedEquityFunds(unclassifiedEquityFunds);

            // æ˜¾ç¤ºåŒ¹é…ç»Ÿè®¡
            const uploadResult = document.getElementById('uploadResult');
            let resultMsg = `âœ… æ•°æ®å¤„ç†å®Œæˆ: æˆåŠŸåŒ¹é… ${matchedCount} æ¡æŒä»“`;
            if (tradeAdjustedCount > 0) {
                resultMsg += `ï¼Œäº¤æ˜“è°ƒæ•´ ${tradeAdjustedCount} æ¡`;
            }
            uploadResult.innerHTML = `<div class="success">${resultMsg}</div>`;
        }

        // æ¸²æŸ“ç»“æœ
        function renderResults() {
            renderSummaryStats();
            renderProductFilters();
            renderMatrixTable();
            renderProductCards();
        }

        // æ¸²æŸ“ç»Ÿè®¡ä¿¡æ¯
        function renderSummaryStats() {
            const summaryStats = document.getElementById('summaryStats');

            // ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
            const productCount = Object.keys(analysisResults).length;
            const totalStyles = new Set();
            let totalEquityExposure = 0;

            Object.values(analysisResults).forEach(product => {
                Object.keys(product).forEach(style => {
                    totalStyles.add(style);
                    totalEquityExposure += product[style].amount;
                });
            });

            summaryStats.innerHTML = `
                <div class="stat-card">
                    <h4>äº§å“æ•°é‡</h4>
                    <div class="value">${productCount}</div>
                </div>
                <div class="stat-card">
                    <h4>é£æ ¼æ•°é‡</h4>
                    <div class="value">${totalStyles.size}</div>
                </div>
                <div class="stat-card">
                    <h4>æ€»æƒç›Šæš´éœ²</h4>
                    <div class="value">${(totalEquityExposure / 100000000).toFixed(1)}äº¿</div>
                </div>
            `;
        }

        // æ¸²æŸ“äº§å“ç­›é€‰å™¨
        function renderProductFilters() {
            const productFilters = document.getElementById('productFilters');
            productFilters.innerHTML = '';

            // æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åˆ—äº§å“
            const sortedProducts = sortByProductOrder(Object.keys(analysisResults));

            sortedProducts.forEach(productName => {
                const checkbox = document.createElement('div');
                checkbox.className = 'filter-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" id="filter-${productName.replace(/[^a-zA-Z0-9]/g, '')}"
                           ${selectedProducts.has(productName) ? 'checked' : ''}
                           onchange="toggleProductFilter('${productName}')" />
                    <label for="filter-${productName.replace(/[^a-zA-Z0-9]/g, '')}">${productName}</label>
                `;
                productFilters.appendChild(checkbox);
            });
        }

        // æ¸²æŸ“çŸ©é˜µè¡¨æ ¼
        function renderMatrixTable() {
            const matrixTable = document.getElementById('matrixTable');

            // è·å–æ‰€æœ‰é£æ ¼
            const allStyles = new Set();
            Object.values(analysisResults).forEach(product => {
                Object.keys(product).forEach(style => {
                    allStyles.add(style);
                });
            });
            // æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åˆ—é£æ ¼
            const styles = sortByStyleOrder(allStyles);

            // åˆ›å»ºè¡¨å¤´
            let headerHtml = '<tr><th>äº§å“åç§°</th>';
            styles.forEach(style => {
                headerHtml += `<th>${style}</th>`;
            });
            headerHtml += '</tr>';

            // æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åˆ—äº§å“ï¼Œåˆ›å»ºè¡¨æ ¼è¡Œ
            const sortedSelectedProducts = sortByProductOrder(Array.from(selectedProducts));
            let bodyHtml = '';
            sortedSelectedProducts.forEach(productName => {
                const product = analysisResults[productName];
                let rowHtml = `<tr><td class="product-name">${productName}</td>`;

                styles.forEach(style => {
                    const data = product[style];
                    if (data) {
                        if (matrixDisplayType === 'amount') {
                            rowHtml += `<td class="amount-cell">${(data.amount / 10000).toFixed(0)}ä¸‡</td>`;
                        } else {
                            rowHtml += `<td class="percentage-cell">${Math.round(data.percentage)}%</td>`;
                        }
                    } else {
                        rowHtml += `<td class="zero-cell">-</td>`;
                    }
                });

                rowHtml += '</tr>';
                bodyHtml += rowHtml;
            });

            matrixTable.innerHTML = `
                <thead>${headerHtml}</thead>
                <tbody>${bodyHtml}</tbody>
            `;
        }

        // æ¸²æŸ“äº§å“å¡ç‰‡
        function renderProductCards() {
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            // æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åˆ—äº§å“
            const sortedSelectedProducts = sortByProductOrder(Array.from(selectedProducts));

            sortedSelectedProducts.forEach(productName => {
                const product = analysisResults[productName];
                const productCard = document.createElement('div');
                productCard.className = 'product-card';

                // æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åˆ—é£æ ¼
                const sortedStyles = sortByStyleOrder(Object.keys(product));

                let styleItemsHtml = '';
                sortedStyles.forEach(style => {
                    const data = product[style];
                    styleItemsHtml += `
                        <div class="style-item">
                            <span class="style-name">${style}</span>
                            <span class="style-amount">${(data.amount / 10000).toFixed(0)}ä¸‡</span>
                            <span class="style-percentage">${Math.round(data.percentage)}%</span>
                        </div>
                    `;
                });

                productCard.innerHTML = `
                    <h3>${productName}</h3>
                    ${styleItemsHtml}
                    <div class="chart-container">
                        <canvas id="chart-${productName.replace(/[^a-zA-Z0-9]/g, '')}"></canvas>
                    </div>
                `;

                resultsGrid.appendChild(productCard);

                // åˆ›å»ºå›¾è¡¨
                setTimeout(() => {
                    createChart(productName, product);
                }, 100);
            });
        }

        // åˆ‡æ¢äº§å“ç­›é€‰
        function toggleProductFilter(productName) {
            if (selectedProducts.has(productName)) {
                selectedProducts.delete(productName);
            } else {
                selectedProducts.add(productName);
            }

            renderMatrixTable();
            renderProductCards();
            // é‡æ–°æ¸²æŸ“è¯¦ç»†æ•°æ®è¡¨æ ¼ä»¥åæ˜ ç­›é€‰çŠ¶æ€
            if (holdingData.length > 0) {
                renderDetailTable(calculateDetailData());
            }
        }

        // åˆ‡æ¢çŸ©é˜µæ˜¾ç¤ºç±»å‹
        function toggleMatrixDisplay(type) {
            matrixDisplayType = type;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="toggleMatrixDisplay('${type}')"]`).classList.add('active');

            renderMatrixTable();
        }

        // å…¨é€‰äº§å“
        function selectAllProducts() {
            selectedProducts.clear();
            Object.keys(analysisResults).forEach(product => {
                selectedProducts.add(product);
            });

            renderProductFilters();
            renderMatrixTable();
            renderProductCards();
            // é‡æ–°æ¸²æŸ“è¯¦ç»†æ•°æ®è¡¨æ ¼ä»¥åæ˜ ç­›é€‰çŠ¶æ€
            if (holdingData.length > 0) {
                renderDetailTable(calculateDetailData());
            }
        }

        // å…¨ä¸é€‰äº§å“
        function deselectAllProducts() {
            selectedProducts.clear();

            renderProductFilters();
            renderMatrixTable();
            renderProductCards();
            // é‡æ–°æ¸²æŸ“è¯¦ç»†æ•°æ®è¡¨æ ¼ä»¥åæ˜ ç­›é€‰çŠ¶æ€
            if (holdingData.length > 0) {
                renderDetailTable(calculateDetailData());
            }
        }

        // åˆ›å»ºå›¾è¡¨
        function createChart(productName, data) {
            const canvasId = `chart-${productName.replace(/[^a-zA-Z0-9]/g, '')}`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            // æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åˆ—é£æ ¼
            const labels = sortByStyleOrder(Object.keys(data));
            const values = labels.map(label => data[label].percentage);
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#43e97b', '#fa709a', '#fee140', '#ff9a9e', '#a8edea'
            ];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // è®¡ç®—è¯¦ç»†æ•°æ®ï¼ˆåŒ…æ‹¬äº§å“å‡€èµ„äº§å’Œè°ƒä»“ä¿¡æ¯ï¼‰
        function calculateDetailData() {
            const detailData = [];
            const productNetAssets = {}; // å­˜å‚¨å„äº§å“çš„å‡€èµ„äº§
            const processedTradeKeys = new Set(); // è®°å½•å·²å¤„ç†çš„äº¤æ˜“é”®

            // é¦–å…ˆè®¡ç®—å„äº§å“çš„å‡€èµ„äº§
            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;

                if (!productName || holdingAmount === 0) return;

                if (!productNetAssets[productName]) {
                    productNetAssets[productName] = 0;
                }

                // æ£€æŸ¥æ˜¯å¦ä¸ºæ­£å›è´­
                const isRepo = assetName && assetName.includes('æ­£å›è´­');

                if (isRepo) {
                    // æ­£å›è´­ä»å‡€èµ„äº§ä¸­å‡å»
                    productNetAssets[productName] -= holdingAmount;
                } else {
                    // å…¶ä»–èµ„äº§åŠ å…¥å‡€èµ„äº§
                    productNetAssets[productName] += holdingAmount;
                }
            });

            // ç„¶åç”Ÿæˆè¯¦ç»†æ•°æ®
            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;
                const holdingQuantity = parseFloat(row['æŒä»“é¢é¢']) || 0;
                const fullPrice = parseFloat(row['æ—¥ç»ˆå…¨ä»·ï¼ˆå…ƒï¼‰-äº§å“æ³•ä¼°å€¼']) || 0;
                const externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);
                const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);

                if (!productName || !assetName || holdingAmount === 0) return;

                // ä½¿ç”¨æ–°çš„åŒ¹é…é”®é€»è¾‘
                const matchKey = getFundMatchKey(row);
                const classification = fundClassifications[matchKey];
                if (!classification) return;

                // è®¡ç®—è°ƒä»“
                let tradeAdjustment = 0;
                let adjustedHolding = holdingAmount;
                let hasTrade = false;

                // ä½¿ç”¨å¤–éƒ¨ä»£ç æˆ–èµ„äº§ä»£ç æ„å»ºäº¤æ˜“é”®
                const matchCode = (externalCode && externalCode !== 'nan') ? externalCode : assetCode;
                const tradeKey = matchCode ? `${productName}|${matchCode}` : null;

                if (tradeKey && tradeMap[tradeKey]) {
                    processedTradeKeys.add(tradeKey);
                    const tradeInfo = tradeMap[tradeKey];
                    hasTrade = true;
                    console.log(`åŒ¹é…åˆ°äº¤æ˜“: ${tradeKey}, ç”³è´­=${tradeInfo.purchaseAmount}, èµå›æ•°é‡=${tradeInfo.redeemQuantity}`);

                    // ç”³è´­å¢åŠ æŒä»“
                    if (tradeInfo.purchaseAmount > 0) {
                        tradeAdjustment += tradeInfo.purchaseAmount;
                        adjustedHolding = holdingAmount + tradeInfo.purchaseAmount;
                    }

                    // èµå›å‡å°‘æŒä»“
                    if (tradeInfo.redeemQuantity > 0) {
                        if (fullPrice > 0) {
                            const newQuantity = Math.max(0, holdingQuantity - tradeInfo.redeemQuantity);
                            const newValue = newQuantity * fullPrice;
                            tradeAdjustment = newValue - holdingAmount;
                            adjustedHolding = newValue;
                            console.log(`èµå›è®¡ç®—: åŸæ•°é‡=${holdingQuantity}, èµå›=${tradeInfo.redeemQuantity}, å…¨ä»·=${fullPrice}, æ–°å€¼=${newValue}`);
                        } else {
                            console.log(`èµå›è®¡ç®—å¤±è´¥: å…¨ä»·ä¸º0, æŒä»“=${assetName}`);
                        }
                    }
                }

                const equityExposure = adjustedHolding * (classification.equityPosition / 100);

                detailData.push({
                    productName,
                    assetName,
                    assetCode: externalCode || assetCode,
                    assetClass: classification.assetClass,
                    style: classification.style,
                    equityPosition: classification.equityPosition,
                    holdingAmount,
                    tradeAdjustment,
                    adjustedHolding,
                    equityExposure,
                    productNetAsset: productNetAssets[productName],
                    hasTrade,
                    isNew: false
                });
            });

            // å¤„ç†æ–°ç”³è´­èµ„äº§ï¼ˆæŒä»“è¡¨ä¸­æ²¡æœ‰çš„ï¼‰
            console.log('å¤„ç†æ–°ç”³è´­èµ„äº§, tradeMapé”®æ•°é‡:', Object.keys(tradeMap).length);
            console.log('å·²å¤„ç†çš„äº¤æ˜“é”®:', Array.from(processedTradeKeys));

            Object.keys(tradeMap).forEach(tradeKey => {
                if (processedTradeKeys.has(tradeKey)) {
                    console.log(`è·³è¿‡å·²å¤„ç†: ${tradeKey}`);
                    return;
                }

                const tradeInfo = tradeMap[tradeKey];
                if (tradeInfo.purchaseAmount <= 0) {
                    console.log(`è·³è¿‡æ— ç”³è´­: ${tradeKey}`);
                    return;
                }

                const [productName, assetCode] = tradeKey.split('|');
                const classification = fundClassifications[assetCode];

                if (!classification) {
                    console.log(`è·³è¿‡æ— åˆ†ç±»: ${tradeKey}, assetCode=${assetCode}`);
                    return;
                }

                console.log(`æ·»åŠ æ–°ç”³è´­: ${tradeKey}, é‡‘é¢=${tradeInfo.purchaseAmount/10000}ä¸‡`);

                const adjustedHolding = tradeInfo.purchaseAmount;
                const equityExposure = adjustedHolding * (classification.equityPosition / 100);

                detailData.push({
                    productName,
                    assetName: tradeInfo.assetName,
                    assetCode: assetCode,
                    assetClass: classification.assetClass,
                    style: classification.style,
                    equityPosition: classification.equityPosition,
                    holdingAmount: 0,
                    tradeAdjustment: tradeInfo.purchaseAmount,
                    adjustedHolding,
                    equityExposure,
                    productNetAsset: productNetAssets[productName] || 0,
                    hasTrade: true,
                    isNew: true
                });
            });

            console.log('calculateDetailDataå®Œæˆ, æ€»è®°å½•æ•°:', detailData.length);
            const withTrade = detailData.filter(d => d.hasTrade);
            console.log('æœ‰äº¤æ˜“è°ƒæ•´çš„è®°å½•æ•°:', withTrade.length);

            return detailData;
        }

        // æ¸²æŸ“è¯¦ç»†æ•°æ®è¡¨æ ¼
        function renderDetailTable(data) {
            const tbody = document.getElementById('detailTableBody');
            tbody.innerHTML = '';

            // æ˜¾ç¤ºäº¤æ˜“æ•°æ®æç¤º
            const tradeDataInfo = document.getElementById('tradeDataInfo');
            if (tradeDataInfo) {
                tradeDataInfo.style.display = hasTradeData ? 'block' : 'none';
            }

            // ç­›é€‰æ•°æ®ï¼šåªæ˜¾ç¤ºé€‰ä¸­äº§å“çš„æ•°æ®
            const filteredData = data.filter(row => selectedProducts.has(row.productName));

            // ä¸ºç­›é€‰åçš„æ•°æ®è®¡ç®—æƒç›Šæš´éœ²å æ¯”
            filteredData.forEach(row => {
                // ä½¿ç”¨æƒç›Šæš´éœ²é‡‘é¢é™¤ä»¥äº§å“å‡€èµ„äº§è®¡ç®—å æ¯”
                row.equityExposureRatio = row.productNetAsset > 0 ? (row.equityExposure / row.productNetAsset * 100) : 0;
            });

            // æŒ‰ç…§è‡ªå®šä¹‰äº§å“é¡ºåºã€è‡ªå®šä¹‰é£æ ¼é¡ºåºã€æƒç›Šæš´éœ²å æ¯”æ’åº
            filteredData.sort((a, b) => {
                // é¦–å…ˆæŒ‰è‡ªå®šä¹‰äº§å“é¡ºåºæ’åº
                const productIndexA = productOrder.indexOf(a.productName);
                const productIndexB = productOrder.indexOf(b.productName);
                if (productIndexA !== productIndexB) {
                    if (productIndexA === -1 && productIndexB === -1) {
                        if (a.productName !== b.productName) return a.productName.localeCompare(b.productName);
                    } else if (productIndexA === -1) return 1;
                    else if (productIndexB === -1) return -1;
                    else return productIndexA - productIndexB;
                }

                // å¦‚æœäº§å“åç§°ç›¸åŒï¼ŒæŒ‰è‡ªå®šä¹‰é£æ ¼é¡ºåºæ’åº
                const styleIndexA = styleOrder.indexOf(a.style);
                const styleIndexB = styleOrder.indexOf(b.style);
                if (styleIndexA !== styleIndexB) {
                    if (styleIndexA === -1 && styleIndexB === -1) {
                        if (a.style !== b.style) return a.style.localeCompare(b.style);
                    } else if (styleIndexA === -1) return 1;
                    else if (styleIndexB === -1) return -1;
                    else return styleIndexA - styleIndexB;
                }

                // å¦‚æœäº§å“åç§°å’Œé£æ ¼éƒ½ç›¸åŒï¼ŒæŒ‰æƒç›Šæš´éœ²å æ¯”é™åºæ’åº
                return b.equityExposureRatio - a.equityExposureRatio;
            });

            // ç»Ÿè®¡æœ‰è°ƒä»“çš„è®°å½•æ•°
            const tradeAdjustedRows = filteredData.filter(row => row.hasTrade && Math.abs(row.tradeAdjustment) > 0.01);
            console.log(`è¯¦ç»†æ•°æ®: å…±${filteredData.length}æ¡, æœ‰è°ƒä»“${tradeAdjustedRows.length}æ¡`);
            if (tradeAdjustedRows.length > 0) {
                console.log('è°ƒä»“è®°å½•:', tradeAdjustedRows.map(r => ({
                    product: r.productName,
                    asset: r.assetName,
                    adjustment: r.tradeAdjustment / 10000,
                    isNew: r.isNew
                })));
            }

            filteredData.forEach(row => {
                const tr = document.createElement('tr');

                // è°ƒä»“å•å…ƒæ ¼æ ·å¼
                let adjustmentCell = '<td>-</td>';
                let adjustedHoldingCell = `<td>${Math.round(row.adjustedHolding / 10000)}</td>`;

                if (row.hasTrade && Math.abs(row.tradeAdjustment) > 0.01) {
                    const adjustmentValue = Math.round(row.tradeAdjustment / 10000);
                    const adjustmentSign = adjustmentValue >= 0 ? '+' : '';
                    adjustmentCell = `<td style="background: #fff8f0; color: #ff6b35; font-weight: 600;">${adjustmentSign}${adjustmentValue}</td>`;
                    adjustedHoldingCell = `<td style="background: #f0fdf4; color: #10b981; font-weight: 600;">${Math.round(row.adjustedHolding / 10000)}</td>`;
                }

                // èµ„äº§åç§°æ˜¾ç¤ºï¼ˆä¸å†æ˜¾ç¤º"æ–°"æ ‡ç­¾ï¼‰
                const assetNameDisplay = row.assetName;

                tr.innerHTML = `
                    <td>${row.productName}</td>
                    <td>${assetNameDisplay}</td>
                    <td style="font-family: monospace; font-size: 0.9em;">${row.assetCode}</td>
                    <td>${row.style}</td>
                    <td>${row.equityPosition}%</td>
                    <td>${Math.round(row.holdingAmount / 10000)}</td>
                    ${adjustmentCell}
                    ${adjustedHoldingCell}
                    <td>${Math.round(row.equityExposure / 10000)}</td>
                    <td>${row.equityExposureRatio.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }




        // æ¸²æŸ“æœªåˆ†ç±»å«æƒåŸºé‡‘æç¤º
        function renderUnclassifiedEquityFunds(unclassifiedEquityFunds) {
            const section = document.getElementById('unclassifiedEquitySection');
            const content = document.getElementById('unclassifiedEquityContent');

            if (!section || !content) {
                console.error('æœªæ‰¾åˆ°æœªåˆ†ç±»å«æƒåŸºé‡‘æç¤ºåŒºåŸŸçš„HTMLå…ƒç´ ');
                return;
            }

            // å°†Mapè½¬æ¢ä¸ºæ•°ç»„
            const unclassifiedList = Array.from(unclassifiedEquityFunds.values());

            if (unclassifiedList.length === 0) {
                // æ‰€æœ‰å«æƒåŸºé‡‘éƒ½å·²åˆ†ç±»
                content.innerHTML = `
                    <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 20px;">
                        <h2 style="color: #059669; margin-bottom: 15px;">âœ… å«æƒåŸºé‡‘å‡å·²å¯¼å…¥å’Œåˆ†ç±»å®Œæˆ</h2>
                        <p style="color: #059669; font-size: 1em;">
                            å·²æ£€æµ‹çš„å«æƒèµ„äº§ç±»åˆ«ï¼š${EQUITY_ASSET_CLASSES.join('ã€')}
                        </p>
                        <p style="margin-top: 10px; color: #6b7280; font-size: 0.9em;">
                            æ‰€æœ‰ä¸Šè¿°ç±»åˆ«çš„åŸºé‡‘éƒ½å·²åœ¨åŸºé‡‘åˆ†ç±»è¡¨ä¸­æ‰¾åˆ°å¯¹åº”çš„åˆ†ç±»ä¿¡æ¯ï¼Œå¯ä»¥æ­£å¸¸è¿›è¡Œåˆ†æè®¡ç®—ã€‚
                        </p>
                        <button class="btn" style="background: #6b7280; color: white; margin-top: 10px;"
                                onclick="hideUnclassifiedEquitySection()">éšè—æ­¤æç¤º</button>
                    </div>
                `;
                section.style.display = 'block';
                console.log('å«æƒåŸºé‡‘åˆ†ç±»æ£€æµ‹å®Œæˆï¼šæ‰€æœ‰å«æƒåŸºé‡‘éƒ½å·²åˆ†ç±»');
            } else {
                // æœ‰æœªåˆ†ç±»çš„å«æƒåŸºé‡‘
                content.innerHTML = `
                    <div style="background: #fff8f0; border: 2px solid #ff6b35; border-radius: 12px; padding: 20px;">
                        <h2 style="color: #dc2626; margin-bottom: 15px;">âš ï¸ å‘ç°æœªåˆ†ç±»çš„å«æƒåŸºé‡‘</h2>
                        <p style="color: #dc2626; margin-bottom: 15px; font-size: 1em;">
                            åœ¨æŒä»“è¡¨ä¸­æ£€æµ‹åˆ° <strong>${unclassifiedList.length}</strong> ä¸ªå«æƒåŸºé‡‘å°šæœªåœ¨åŸºé‡‘åˆ†ç±»è¡¨ä¸­åˆ†ç±»ï¼Œè¯·åœ¨åŸºé‡‘åˆ†ç±»è¡¨ä¸­è¡¥å……ä»¥ä¸‹åŸºé‡‘çš„åˆ†ç±»ä¿¡æ¯ï¼š
                        </p>

                        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr; gap: 10px; padding: 10px; background: #f8f9ff; border-radius: 6px; font-weight: 600; color: #667eea; margin-bottom: 10px;">
                                <div>åŸºé‡‘åç§°</div>
                                <div>èµ„äº§å°ç±»</div>
                                <div>å¤–éƒ¨ä»£ç </div>
                                <div>èµ„äº§ä»£ç </div>
                            </div>
                            ${unclassifiedList.map(fund => `
                                <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr; gap: 10px; padding: 10px; border-bottom: 1px solid #e2e8f0; align-items: center;">
                                    <div style="font-weight: 500; color: #333;">${fund.assetName}</div>
                                    <div>
                                        <span style="background: #ff6b35; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">
                                            ${fund.assetSubClass}
                                        </span>
                                    </div>
                                    <div style="color: #667eea; font-family: monospace; font-size: 0.9em;">${fund.externalCode || '-'}</div>
                                    <div style="color: #667eea; font-family: monospace; font-size: 0.9em;">${fund.assetCode || '-'}</div>
                                </div>
                            `).join('')}
                        </div>

                        <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 12px; border-radius: 4px; margin-top: 15px;">
                            <p style="color: #dc2626; margin: 0; font-size: 0.95em;">
                                <strong>ğŸ“ æ“ä½œå»ºè®®ï¼š</strong>
                            </p>
                            <ol style="margin: 8px 0 0 20px; color: #991b1b; font-size: 0.9em; line-height: 1.6;">
                                <li>åœ¨åŸºé‡‘åˆ†ç±»è¡¨ï¼ˆExcelï¼‰ä¸­æ·»åŠ ä¸Šè¿°åŸºé‡‘çš„åˆ†ç±»ä¿¡æ¯ï¼ˆèµ„äº§ç±»åˆ«ã€é£æ ¼ã€æƒç›Šä»“ä½ï¼‰</li>
                                <li>ç¡®ä¿åŸºé‡‘åˆ†ç±»è¡¨ä¸­çš„<strong>å¤–éƒ¨ä»£ç </strong>æˆ–<strong>èµ„äº§ä»£ç </strong>ä¸ä¸Šè¡¨ä¸­æ˜¾ç¤ºçš„ä»£ç ä¸€è‡´</li>
                                <li>ä¿å­˜åŸºé‡‘åˆ†ç±»è¡¨åï¼Œé‡æ–°ä¸Šä¼ åŸºé‡‘åˆ†ç±»è¡¨å’ŒæŒä»“æ˜ç»†è¡¨</li>
                            </ol>
                        </div>

                        <button class="btn" style="background: #6b7280; color: white; margin-top: 15px;"
                                onclick="hideUnclassifiedEquitySection()">æš‚æ—¶éšè—</button>
                    </div>
                `;
                section.style.display = 'block';
                console.log(`å‘ç° ${unclassifiedList.length} ä¸ªæœªåˆ†ç±»çš„å«æƒåŸºé‡‘`);
            }
        }

        // éšè—æœªåˆ†ç±»å«æƒåŸºé‡‘æç¤ºåŒºåŸŸ
        function hideUnclassifiedEquitySection() {
            const section = document.getElementById('unclassifiedEquitySection');
            if (section) {
                section.style.display = 'none';
            }
        }

        // å¯¼å‡ºåˆ†æç»“æœåˆ°Excel
        function exportResultsToExcel() {
            if (Object.keys(analysisResults).length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ å¹¶å¤„ç†æ•°æ®');
                return;
            }

            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();

                // Sheet 1: äº§å“é£æ ¼æ±‡æ€»ï¼ˆé‡‘é¢ï¼‰
                const summaryAmountData = createMatrixData('amount');
                const ws1 = XLSX.utils.aoa_to_sheet(summaryAmountData);
                XLSX.utils.book_append_sheet(wb, ws1, 'äº§å“é£æ ¼æ±‡æ€»-é‡‘é¢');

                // Sheet 2: äº§å“é£æ ¼æ±‡æ€»ï¼ˆå æ¯”ï¼‰
                const summaryPercentData = createMatrixData('percentage');
                const ws2 = XLSX.utils.aoa_to_sheet(summaryPercentData);
                XLSX.utils.book_append_sheet(wb, ws2, 'äº§å“é£æ ¼æ±‡æ€»-å æ¯”');

                // Sheet 3: æŒä»“æ˜ç»†
                const detailData = createDetailData();
                const ws3 = XLSX.utils.aoa_to_sheet(detailData);
                XLSX.utils.book_append_sheet(wb, ws3, 'æŒä»“æ˜ç»†');

                // ç”ŸæˆExcelæ–‡ä»¶
                const fileName = `åŸºé‡‘åˆ†æç»“æœ_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);

                alert(`âœ… å¯¼å‡ºæˆåŠŸï¼æ–‡ä»¶åï¼š${fileName}`);
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`);
            }
        }

        // åˆ›å»ºçŸ©é˜µæ•°æ®ï¼ˆç”¨äºå¯¼å‡ºï¼‰
        function createMatrixData(type) {
            const data = [];

            // è·å–æ‰€æœ‰é£æ ¼å¹¶æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åº
            const allStyles = new Set();
            Object.values(analysisResults).forEach(product => {
                Object.keys(product).forEach(style => allStyles.add(style));
            });
            const styles = sortByStyleOrder(allStyles);

            // è¡¨å¤´
            const header = ['äº§å“åç§°', ...styles];
            data.push(header);

            // æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åˆ—äº§å“ï¼Œæ•°æ®è¡Œ - åªå¯¼å‡ºé€‰ä¸­çš„äº§å“
            const sortedSelectedProducts = sortByProductOrder(Array.from(selectedProducts));
            sortedSelectedProducts.forEach(productName => {
                const product = analysisResults[productName];
                const row = [productName];

                styles.forEach(style => {
                    const styleData = product[style];
                    if (styleData) {
                        if (type === 'amount') {
                            // é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰
                            row.push(Math.round(styleData.amount / 10000));
                        } else {
                            // å æ¯”ï¼ˆæ•´æ•°%ï¼‰
                            row.push(Math.round(styleData.percentage) + '%');
                        }
                    } else {
                        row.push('-');
                    }
                });

                data.push(row);
            });

            return data;
        }

        // åˆ›å»ºè¯¦ç»†æ•°æ®ï¼ˆç”¨äºå¯¼å‡ºï¼‰
        function createDetailData() {
            const data = [];

            // è¡¨å¤´ - åŒ…å«è°ƒä»“ä¿¡æ¯
            data.push(['äº§å“åç§°', 'åŸºé‡‘åç§°', 'èµ„äº§ä»£ç ', 'é£æ ¼', 'æƒç›Šä»“ä½', 'æ˜¨æ—¥æŒä»“(ä¸‡)', 'å½“æ—¥è°ƒä»“(ä¸‡)', 'è°ƒä»“åæŒä»“(ä¸‡)', 'æƒç›Šæš´éœ²(ä¸‡)', 'æƒç›Šå æ¯”']);

            // è·å–è¯¦ç»†æ•°æ®
            const detailData = calculateDetailData();

            // ç­›é€‰é€‰ä¸­çš„äº§å“
            const filteredData = detailData.filter(row => selectedProducts.has(row.productName));

            // è®¡ç®—æƒç›Šæš´éœ²å æ¯”
            filteredData.forEach(row => {
                row.equityExposureRatio = row.productNetAsset > 0
                    ? (row.equityExposure / row.productNetAsset * 100)
                    : 0;
            });

            // æŒ‰è‡ªå®šä¹‰é¡ºåºæ’åº
            filteredData.sort((a, b) => {
                // é¦–å…ˆæŒ‰è‡ªå®šä¹‰äº§å“é¡ºåºæ’åº
                const productIndexA = productOrder.indexOf(a.productName);
                const productIndexB = productOrder.indexOf(b.productName);
                if (productIndexA !== productIndexB) {
                    if (productIndexA === -1 && productIndexB === -1) {
                        if (a.productName !== b.productName) return a.productName.localeCompare(b.productName);
                    } else if (productIndexA === -1) return 1;
                    else if (productIndexB === -1) return -1;
                    else return productIndexA - productIndexB;
                }

                // å¦‚æœäº§å“åç§°ç›¸åŒï¼ŒæŒ‰è‡ªå®šä¹‰é£æ ¼é¡ºåºæ’åº
                const styleIndexA = styleOrder.indexOf(a.style);
                const styleIndexB = styleOrder.indexOf(b.style);
                if (styleIndexA !== styleIndexB) {
                    if (styleIndexA === -1 && styleIndexB === -1) {
                        if (a.style !== b.style) return a.style.localeCompare(b.style);
                    } else if (styleIndexA === -1) return 1;
                    else if (styleIndexB === -1) return -1;
                    else return styleIndexA - styleIndexB;
                }

                return b.equityExposureRatio - a.equityExposureRatio;
            });

            // æ•°æ®è¡Œ
            filteredData.forEach(row => {
                const adjustmentValue = row.hasTrade && Math.abs(row.tradeAdjustment) > 0.01
                    ? Math.round(row.tradeAdjustment / 10000)
                    : '-';

                data.push([
                    row.productName,
                    row.assetName,
                    row.assetCode,
                    row.style,
                    row.equityPosition + '%',
                    Math.round(row.holdingAmount / 10000),
                    adjustmentValue,
                    Math.round(row.adjustedHolding / 10000),
                    Math.round(row.equityExposure / 10000),
                    row.equityExposureRatio.toFixed(2) + '%'
                ]);
            });

            return data;
        }

        // ==================== èµ„äº§æŸ¥è¯¢åŠŸèƒ½ ====================

        // æ„å»ºèµ„äº§åˆ—è¡¨ï¼ˆç”¨äºè‡ªåŠ¨è¡¥å…¨ï¼‰
        function buildAssetsList() {
            const assetMap = new Map(); // ç”¨äºå»é‡

            holdingData.forEach(row => {
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);
                const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);

                if (!assetName) return;

                // ä½¿ç”¨èµ„äº§ä»£ç æˆ–å¤–éƒ¨ä»£ç ä½œä¸ºå”¯ä¸€é”®
                const key = (externalCode && externalCode !== 'nan') ? externalCode : assetCode;
                if (!key) return;

                if (!assetMap.has(key)) {
                    // è·å–æ ‡ç­¾ä¿¡æ¯
                    const tagInfo = assetTagMap[assetCode] || {};

                    assetMap.set(key, {
                        assetName: assetName,
                        externalCode: externalCode,
                        assetCode: assetCode,
                        matchKey: key,
                        tag: tagInfo.tag || '',
                        category: tagInfo.category || ''
                    });
                }
            });

            allAssetsList = Array.from(assetMap.values());
            console.log('èµ„äº§åˆ—è¡¨æ„å»ºå®Œæˆï¼Œæ•°é‡:', allAssetsList.length);
        }

        // æ›´æ–°æ ‡ç­¾ä¸‹æ‹‰æ¡†
        function updateTagSelect() {
            const tagSelect = document.getElementById('tagSelect');
            if (!tagSelect) return;

            // è·å–æ‰€æœ‰å”¯ä¸€æ ‡ç­¾
            const tags = new Set();
            assetTagData.forEach(row => {
                const tag = normalizeText(row['æ ‡ç­¾']);
                if (tag) tags.add(tag);
            });

            // æ¸…ç©ºå¹¶é‡å»ºé€‰é¡¹
            tagSelect.innerHTML = '<option value="">-- é€‰æ‹©æ ‡ç­¾ --</option>';
            Array.from(tags).sort().forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                tagSelect.appendChild(option);
            });

            console.log('æ ‡ç­¾é€‰é¡¹æ›´æ–°å®Œæˆï¼Œæ•°é‡:', tags.size);
        }

        // å·²é€‰æ‹©çš„èµ„äº§åˆ—è¡¨
        let selectedAssets = [];

        // è§£ææœç´¢æ–‡æœ¬ï¼Œæ”¯æŒå¤šç§åˆ†éš”ç¬¦
        function parseSearchText(text) {
            // æ”¯æŒçš„åˆ†éš”ç¬¦ï¼šç©ºæ ¼ã€é€—å·ã€åˆ†å·ã€æ¢è¡Œã€åˆ¶è¡¨ç¬¦ã€ä¸­æ–‡é€—å·ã€ä¸­æ–‡åˆ†å·
            const separators = /[\s,;ï¼Œï¼›\t\n]+/;
            return text.split(separators).map(s => s.trim()).filter(s => s.length > 0);
        }

        // å¤„ç†èµ„äº§æœç´¢
        function handleAssetSearch(searchText) {
            const dropdown = document.getElementById('autocompleteDropdown');

            if (!searchText || searchText.length < 1) {
                dropdown.classList.remove('show');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦åŒ…å«åˆ†éš”ç¬¦ï¼ˆå¤šèµ„äº§è¾“å…¥ï¼‰
            const parts = parseSearchText(searchText);
            if (parts.length > 1) {
                // å¤šèµ„äº§è¾“å…¥ï¼Œç›´æ¥æ‰§è¡Œæ‰¹é‡æŸ¥è¯¢
                dropdown.classList.remove('show');
                handleMultiAssetSearch(parts);
                return;
            }

            const searchLower = searchText.toLowerCase();

            // æœç´¢åŒ¹é…çš„èµ„äº§ï¼ˆæ’é™¤å·²é€‰æ‹©çš„ï¼‰
            const matches = allAssetsList.filter(asset => {
                if (selectedAssets.some(s => s.matchKey === asset.matchKey)) return false;
                return asset.assetName.toLowerCase().includes(searchLower) ||
                       (asset.externalCode && asset.externalCode.toLowerCase().includes(searchLower)) ||
                       (asset.assetCode && asset.assetCode.toLowerCase().includes(searchLower));
            }).slice(0, 15);

            if (matches.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item" style="color: #9ca3af;">æœªæ‰¾åˆ°åŒ¹é…çš„èµ„äº§</div>';
                dropdown.classList.add('show');
                return;
            }

            dropdown.innerHTML = matches.map(asset => `
                <div class="autocomplete-item" onclick="selectAsset('${asset.matchKey}')">
                    <div class="asset-name">
                        ${asset.assetName}
                        ${asset.tag ? `<span class="asset-tag">${asset.tag}</span>` : ''}
                    </div>
                    <div class="asset-code">${asset.externalCode || asset.assetCode}</div>
                </div>
            `).join('');

            dropdown.classList.add('show');
        }

        // å¤„ç†å¤šèµ„äº§æœç´¢ï¼ˆæ‰¹é‡ç²˜è´´ï¼‰
        function handleMultiAssetSearch(searchTerms) {
            searchTerms.forEach(term => {
                const termLower = term.toLowerCase();
                const match = allAssetsList.find(asset => {
                    return asset.assetName.toLowerCase().includes(termLower) ||
                           (asset.externalCode && asset.externalCode.toLowerCase() === termLower) ||
                           (asset.assetCode && asset.assetCode.toLowerCase() === termLower);
                });

                if (match && !selectedAssets.some(s => s.matchKey === match.matchKey)) {
                    selectedAssets.push(match);
                }
            });

            document.getElementById('assetSearchInput').value = '';
            document.getElementById('tagSelect').value = '';
            updateSelectedAssetsDisplay();

            if (selectedAssets.length > 0) {
                queryMultiAssetDistribution();
            }
        }

        // æ˜¾ç¤ºè‡ªåŠ¨è¡¥å…¨ä¸‹æ‹‰æ¡†
        function showAutocomplete() {
            const searchInput = document.getElementById('assetSearchInput');
            if (searchInput.value) {
                handleAssetSearch(searchInput.value);
            }
        }

        // é€‰æ‹©èµ„äº§ï¼ˆæ·»åŠ åˆ°å·²é€‰åˆ—è¡¨ï¼‰
        function selectAsset(matchKey) {
            const asset = allAssetsList.find(a => a.matchKey === matchKey);
            if (!asset) return;

            if (!selectedAssets.some(s => s.matchKey === matchKey)) {
                selectedAssets.push(asset);
            }

            document.getElementById('assetSearchInput').value = '';
            document.getElementById('autocompleteDropdown').classList.remove('show');
            document.getElementById('tagSelect').value = '';

            updateSelectedAssetsDisplay();

            if (selectedAssets.length === 1) {
                queryAssetDistribution(asset.matchKey, asset.assetName);
            } else {
                queryMultiAssetDistribution();
            }
        }

        // ç§»é™¤å·²é€‰èµ„äº§
        function removeSelectedAsset(matchKey) {
            selectedAssets = selectedAssets.filter(a => a.matchKey !== matchKey);
            updateSelectedAssetsDisplay();

            if (selectedAssets.length === 0) {
                clearAssetQuery();
            } else if (selectedAssets.length === 1) {
                queryAssetDistribution(selectedAssets[0].matchKey, selectedAssets[0].assetName);
            } else {
                queryMultiAssetDistribution();
            }
        }

        // æ›´æ–°å·²é€‰èµ„äº§æ˜¾ç¤º
        function updateSelectedAssetsDisplay() {
            let container = document.getElementById('selectedAssetsContainer');
            if (!container) {
                const searchContainer = document.querySelector('.search-container');
                container = document.createElement('div');
                container.id = 'selectedAssetsContainer';
                container.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;';
                searchContainer.appendChild(container);
            }

            if (selectedAssets.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = selectedAssets.map(asset => `
                <span style="display: inline-flex; align-items: center; background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 20px; font-size: 0.85em;">
                    ${asset.assetName.length > 15 ? asset.assetName.substring(0, 15) + '...' : asset.assetName}
                    <span onclick="removeSelectedAsset('${asset.matchKey}')" style="margin-left: 6px; cursor: pointer; font-weight: bold;">&times;</span>
                </span>
            `).join('');
        }

        // æŸ¥è¯¢å¤šèµ„äº§åˆ†å¸ƒ
        function queryMultiAssetDistribution() {
            const matchKeys = selectedAssets.map(a => a.matchKey);
            const assetNames = selectedAssets.map(a => a.assetName);

            // æŒ‰äº§å“ç»Ÿè®¡
            const productAssetMap = {}; // productName -> { matchKey -> {assetName, amount} }
            let totalAmount = 0;

            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const rowAssetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);
                const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;

                if (holdingAmount === 0) return;

                const rowMatchKey = (externalCode && externalCode !== 'nan') ? externalCode : assetCode;
                if (!matchKeys.includes(rowMatchKey)) return;

                if (!productAssetMap[productName]) {
                    productAssetMap[productName] = {};
                }

                productAssetMap[productName][rowMatchKey] = {
                    assetName: rowAssetName,
                    amount: holdingAmount
                };

                totalAmount += holdingAmount;
            });

            renderMultiAssetQueryResults(assetNames, matchKeys, productAssetMap, totalAmount);
        }

        // æ¸²æŸ“å¤šèµ„äº§æŸ¥è¯¢ç»“æœï¼ˆçŸ©é˜µè¡¨æ ¼æ ¼å¼ï¼‰
        function renderMultiAssetQueryResults(assetNames, matchKeys, productAssetMap, totalAmount) {
            const queryResults = document.getElementById('queryResults');
            const productCount = Object.keys(productAssetMap).length;

            if (productCount === 0) {
                queryResults.innerHTML = `
                    <div class="no-results">
                        <div class="icon">ğŸ“­</div>
                        <p>æœªæ‰¾åˆ°é€‰ä¸­èµ„äº§çš„æŒä»“è®°å½•</p>
                    </div>
                `;
                return;
            }

            // æ„å»ºèµ„äº§ä¿¡æ¯æ˜ å°„
            const assetInfoMap = {};
            matchKeys.forEach((key, index) => {
                assetInfoMap[key] = assetNames[index];
            });

            let html = `
                <div class="query-results-header">
                    <h3>å¤šèµ„äº§æŸ¥è¯¢ç»“æœ</h3>
                    <div class="query-results-summary">
                        <div class="summary-item">
                            <div class="label">èµ„äº§æ•°é‡</div>
                            <div class="value">${matchKeys.length}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">æ¶‰åŠäº§å“æ•°</div>
                            <div class="value">${productCount}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">æ€»æŒä»“é‡‘é¢</div>
                            <div class="value">${(totalAmount / 100000000).toFixed(2)}äº¿</div>
                        </div>
                    </div>
                </div>

                <div class="tag-group-header">
                    <h4>æŸ¥è¯¢èµ„äº§</h4>
                    <div class="tag-assets-list">
                        ${assetNames.map(name => `<span class="tag-asset-chip" title="${name}">${shortenAssetName(name)}</span>`).join('')}
                    </div>
                </div>

                <div style="overflow-x: auto;">
                <table class="query-table matrix-table">
                    <thead>
                        <tr>
                            <th style="min-width: 200px;">äº§å“åç§°</th>
                            ${matchKeys.map((key, i) => `<th title="${assetNames[i]}">${shortenAssetName(assetNames[i])}</th>`).join('')}
                            <th style="min-width: 100px; text-align: center; background: #f0f4ff; color: #4338ca; font-weight: 600;">åˆè®¡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // æŒ‰äº§å“é¡ºåºæ’åˆ—
            const sortedProducts = sortByProductOrder(Object.keys(productAssetMap));

            // è®¡ç®—æ¯ä¸ªèµ„äº§çš„æ€»é‡‘é¢
            const assetTotals = {};
            matchKeys.forEach(key => assetTotals[key] = 0);
            let grandTotal = 0;

            sortedProducts.forEach(productName => {
                const assets = productAssetMap[productName];
                const productNetAsset = productNetAssets[productName] || 0;

                let productTotal = 0;
                matchKeys.forEach(key => {
                    if (assets[key]) {
                        productTotal += assets[key].amount;
                        assetTotals[key] += assets[key].amount;
                    }
                });
                grandTotal += productTotal;

                const totalPercentage = productNetAsset > 0 ? (productTotal / productNetAsset * 100) : 0;

                html += `<tr>`;
                html += `<td>${productName}</td>`;

                matchKeys.forEach(key => {
                    if (assets[key]) {
                        const amount = assets[key].amount;
                        const percentage = productNetAsset > 0 ? (amount / productNetAsset * 100) : 0;
                        html += `<td style="text-align: right;">
                            <div style="font-weight: 500;">${Math.round(amount / 10000).toLocaleString()}</div>
                            <div class="percentage-text">${percentage.toFixed(2)}%</div>
                        </td>`;
                    } else {
                        html += `<td style="text-align: center; color: #d1d5db;">-</td>`;
                    }
                });

                html += `<td style="text-align: right; background: #f8faff; font-weight: 600;">
                    <div style="color: #4338ca;">${Math.round(productTotal / 10000).toLocaleString()}</div>
                    <div class="percentage-text">${totalPercentage.toFixed(2)}%</div>
                </td>`;
                html += `</tr>`;
            });

            // æ·»åŠ èµ„äº§åˆè®¡è¡Œ
            html += `
                <tr class="total-row" style="background: #f0f4ff;">
                    <td><strong>åˆè®¡</strong></td>
                    ${matchKeys.map(key => `<td style="text-align: right;"><strong>${Math.round(assetTotals[key] / 10000).toLocaleString()}</strong></td>`).join('')}
                    <td style="text-align: right; background: #e0e7ff;"><strong style="color: #4338ca;">${Math.round(grandTotal / 10000).toLocaleString()}</strong></td>
                </tr>
            `;

            html += `
                    </tbody>
                </table>
                </div>
            `;

            queryResults.innerHTML = html;
        }

        // å¤„ç†æ ‡ç­¾é€‰æ‹©
        function handleTagSelect(tag) {
            if (!tag) {
                clearAssetQuery();
                return;
            }

            selectedAssets = [];
            updateSelectedAssetsDisplay();
            document.getElementById('assetSearchInput').value = '';
            document.getElementById('autocompleteDropdown').classList.remove('show');

            queryTagDistribution(tag);
        }

        // æŸ¥è¯¢å•ä¸ªèµ„äº§çš„åˆ†å¸ƒ
        function queryAssetDistribution(matchKey, assetName) {
            const results = [];
            let totalAmount = 0;

            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const rowAssetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const externalCode = normalizeText(row['å¤–éƒ¨ä»£ç ']);
                const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;

                if (holdingAmount === 0) return;

                // åŒ¹é…èµ„äº§
                const rowMatchKey = (externalCode && externalCode !== 'nan') ? externalCode : assetCode;
                if (rowMatchKey !== matchKey) return;

                const productNetAsset = productNetAssets[productName] || 0;
                const percentage = productNetAsset > 0 ? (holdingAmount / productNetAsset * 100) : 0;

                results.push({
                    productName,
                    assetName: rowAssetName,
                    holdingAmount,
                    percentage,
                    productNetAsset
                });

                totalAmount += holdingAmount;
            });

            // æŒ‰é‡‘é¢æ’åº
            results.sort((a, b) => b.holdingAmount - a.holdingAmount);

            // æ¸²æŸ“ç»“æœ
            renderAssetQueryResults(assetName, results, totalAmount);
        }

        // æŸ¥è¯¢æ ‡ç­¾ä¸‹çš„æ‰€æœ‰èµ„äº§åˆ†å¸ƒ
        function queryTagDistribution(tag) {
            // æ‰¾å‡ºè¯¥æ ‡ç­¾ä¸‹çš„æ‰€æœ‰èµ„äº§ä»£ç 
            const tagAssets = assetTagData.filter(row => normalizeText(row['æ ‡ç­¾']) === tag);

            if (tagAssets.length === 0) {
                document.getElementById('queryResults').innerHTML = `
                    <div class="no-results">
                        <div class="icon">ğŸ·ï¸</div>
                        <p>æ ‡ç­¾ "${tag}" ä¸‹æ²¡æœ‰èµ„äº§</p>
                    </div>
                `;
                return;
            }

            // æ„å»ºèµ„äº§ä»£ç é›†åˆ
            const tagAssetCodes = new Set(tagAssets.map(a => normalizeText(a['èµ„äº§ä»£ç '])));

            // æŒ‰äº§å“ç»Ÿè®¡
            const productAssetMap = {}; // productName -> { assetName -> amount }
            let totalAmount = 0;

            holdingData.forEach(row => {
                const productName = normalizeText(row['äº§å“ç®€ç§°']);
                const assetName = normalizeText(row['èµ„äº§ç®€ç§°']);
                const assetCode = normalizeText(row['èµ„äº§ä»£ç ']);
                const holdingAmount = parseFloat(row['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼']) || 0;

                if (holdingAmount === 0) return;

                // æ£€æŸ¥æ˜¯å¦å±äºè¯¥æ ‡ç­¾
                if (!tagAssetCodes.has(assetCode)) return;

                if (!productAssetMap[productName]) {
                    productAssetMap[productName] = {};
                }

                if (!productAssetMap[productName][assetName]) {
                    productAssetMap[productName][assetName] = 0;
                }

                productAssetMap[productName][assetName] += holdingAmount;
                totalAmount += holdingAmount;
            });

            // æ¸²æŸ“æ ‡ç­¾æŸ¥è¯¢ç»“æœ
            renderTagQueryResults(tag, tagAssets, productAssetMap, totalAmount);
        }

        // æ¸²æŸ“å•ä¸ªèµ„äº§æŸ¥è¯¢ç»“æœ
        function renderAssetQueryResults(assetName, results, totalAmount) {
            const queryResults = document.getElementById('queryResults');

            if (results.length === 0) {
                queryResults.innerHTML = `
                    <div class="no-results">
                        <div class="icon">ğŸ“­</div>
                        <p>æœªæ‰¾åˆ° "${assetName}" çš„æŒä»“è®°å½•</p>
                    </div>
                `;
                return;
            }

            // è·å–æ ‡ç­¾ä¿¡æ¯
            const firstResult = results[0];
            const matchKey = allAssetsList.find(a => a.assetName === firstResult.assetName)?.matchKey;
            const tagInfo = matchKey ? (assetTagMap[matchKey] || {}) : {};

            let html = `
                <div class="query-results-header">
                    <h3>${assetName} ${tagInfo.tag ? `<span class="asset-tag-badge">${tagInfo.tag}</span>` : ''}</h3>
                    <div class="query-results-summary">
                        <div class="summary-item">
                            <div class="label">æŒæœ‰äº§å“æ•°</div>
                            <div class="value">${results.length}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">æ€»æŒä»“é‡‘é¢</div>
                            <div class="value">${(totalAmount / 100000000).toFixed(2)}äº¿</div>
                        </div>
                    </div>
                </div>

                <table class="query-table">
                    <thead>
                        <tr>
                            <th>äº§å“åç§°</th>
                            <th style="text-align: right;">æŒä»“é‡‘é¢(ä¸‡)</th>
                            <th style="text-align: right;">å äº§å“å‡€èµ„äº§</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            results.forEach(row => {
                html += `
                    <tr>
                        <td>${row.productName}</td>
                        <td class="amount-cell">${Math.round(row.holdingAmount / 10000).toLocaleString()}</td>
                        <td class="percentage-cell">${row.percentage.toFixed(2)}%</td>
                    </tr>
                `;
            });

            // æ·»åŠ åˆè®¡è¡Œ
            html += `
                    <tr class="total-row">
                        <td><strong>åˆè®¡</strong></td>
                        <td class="amount-cell"><strong>${Math.round(totalAmount / 10000).toLocaleString()}</strong></td>
                        <td class="percentage-cell">-</td>
                    </tr>
                </tbody>
                </table>
            `;

            queryResults.innerHTML = html;
        }

        // æ¸²æŸ“æ ‡ç­¾æŸ¥è¯¢ç»“æœï¼ˆçŸ©é˜µè¡¨æ ¼æ ¼å¼ï¼‰
        function renderTagQueryResults(tag, tagAssets, productAssetMap, totalAmount) {
            const queryResults = document.getElementById('queryResults');

            const productCount = Object.keys(productAssetMap).length;
            const assetCount = tagAssets.length;

            if (productCount === 0) {
                queryResults.innerHTML = `
                    <div class="no-results">
                        <div class="icon">ğŸ·ï¸</div>
                        <p>æ ‡ç­¾ "${tag}" ä¸‹æ²¡æœ‰æŒä»“è®°å½•</p>
                    </div>
                `;
                return;
            }

            // è·å–æ‰€æœ‰æœ‰æŒä»“çš„èµ„äº§åç§°ï¼ˆæŒ‰æ€»é‡‘é¢æ’åºï¼‰
            const assetTotalAmounts = {};
            Object.values(productAssetMap).forEach(assets => {
                Object.entries(assets).forEach(([assetName, amount]) => {
                    assetTotalAmounts[assetName] = (assetTotalAmounts[assetName] || 0) + amount;
                });
            });
            const sortedAssetNames = Object.keys(assetTotalAmounts).sort((a, b) => assetTotalAmounts[b] - assetTotalAmounts[a]);

            let html = `
                <div class="query-results-header">
                    <h3>æ ‡ç­¾: <span class="asset-tag-badge">${tag}</span></h3>
                    <div class="query-results-summary">
                        <div class="summary-item">
                            <div class="label">èµ„äº§æ•°é‡</div>
                            <div class="value">${assetCount}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">æ¶‰åŠäº§å“æ•°</div>
                            <div class="value">${productCount}</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">æ€»æŒä»“é‡‘é¢</div>
                            <div class="value">${(totalAmount / 100000000).toFixed(2)}äº¿</div>
                        </div>
                    </div>
                </div>

                <div class="tag-group-header">
                    <h4>åŒ…å«èµ„äº§</h4>
                    <div class="tag-assets-list">
                        ${sortedAssetNames.map(name => `<span class="tag-asset-chip" title="${name}">${shortenAssetName(name)}</span>`).join('')}
                    </div>
                </div>

                <div style="overflow-x: auto;">
                <table class="query-table matrix-table">
                    <thead>
                        <tr>
                            <th style="min-width: 200px;">äº§å“åç§°</th>
                            ${sortedAssetNames.map(name => `<th title="${name}">${shortenAssetName(name)}</th>`).join('')}
                            <th style="min-width: 100px; text-align: center; background: #f0f4ff; color: #4338ca; font-weight: 600;">åˆè®¡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // æŒ‰äº§å“é¡ºåºæ’åˆ—
            const sortedProducts = sortByProductOrder(Object.keys(productAssetMap));

            // è®¡ç®—æ¯ä¸ªèµ„äº§çš„æ€»é‡‘é¢
            const assetTotals = {};
            sortedAssetNames.forEach(name => assetTotals[name] = 0);
            let grandTotal = 0;

            sortedProducts.forEach(productName => {
                const assets = productAssetMap[productName];
                const productNetAsset = productNetAssets[productName] || 0;

                // è®¡ç®—è¯¥äº§å“åˆè®¡
                let productTotal = 0;
                sortedAssetNames.forEach(assetName => {
                    if (assets[assetName]) {
                        productTotal += assets[assetName];
                        assetTotals[assetName] += assets[assetName];
                    }
                });
                grandTotal += productTotal;

                const totalPercentage = productNetAsset > 0 ? (productTotal / productNetAsset * 100) : 0;

                html += `<tr>`;
                html += `<td>${productName}</td>`;

                sortedAssetNames.forEach(assetName => {
                    if (assets[assetName]) {
                        const amount = assets[assetName];
                        const percentage = productNetAsset > 0 ? (amount / productNetAsset * 100) : 0;
                        html += `<td style="text-align: right;">
                            <div style="font-weight: 500;">${Math.round(amount / 10000).toLocaleString()}</div>
                            <div class="percentage-text">${percentage.toFixed(2)}%</div>
                        </td>`;
                    } else {
                        html += `<td style="text-align: center; color: #d1d5db;">-</td>`;
                    }
                });

                html += `<td style="text-align: right; background: #f8faff; font-weight: 600;">
                    <div style="color: #4338ca;">${Math.round(productTotal / 10000).toLocaleString()}</div>
                    <div class="percentage-text">${totalPercentage.toFixed(2)}%</div>
                </td>`;
                html += `</tr>`;
            });

            // æ·»åŠ èµ„äº§åˆè®¡è¡Œ
            html += `
                <tr class="total-row" style="background: #f0f4ff;">
                    <td><strong>åˆè®¡</strong></td>
                    ${sortedAssetNames.map(name => `<td style="text-align: right;"><strong>${Math.round(assetTotals[name] / 10000).toLocaleString()}</strong></td>`).join('')}
                    <td style="text-align: right; background: #e0e7ff;"><strong style="color: #4338ca;">${Math.round(grandTotal / 10000).toLocaleString()}</strong></td>
                </tr>
            `;

            html += `
                    </tbody>
                </table>
                </div>
            `;

            queryResults.innerHTML = html;
        }

        // æ¸…ç©ºæŸ¥è¯¢
        function clearAssetQuery() {
            document.getElementById('assetSearchInput').value = '';
            document.getElementById('tagSelect').value = '';
            document.getElementById('autocompleteDropdown').classList.remove('show');

            // æ¸…ç©ºå·²é€‰èµ„äº§
            selectedAssets = [];
            updateSelectedAssetsDisplay();

            document.getElementById('queryResults').innerHTML = `
                <div class="no-results">
                    <div class="icon">ğŸ”</div>
                    <p>è¯·è¾“å…¥èµ„äº§åç§°/ä»£ç æœç´¢ï¼Œæˆ–é€‰æ‹©æ ‡ç­¾æŸ¥çœ‹èµ„äº§åˆ†å¸ƒ</p>
                </div>
            `;
        }

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ—¶éšè—è‡ªåŠ¨è¡¥å…¨ä¸‹æ‹‰æ¡†
        document.addEventListener('click', function(e) {
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer && !searchContainer.contains(e.target)) {
                document.getElementById('autocompleteDropdown')?.classList.remove('show');
            }
        });

    </script>
</body>

</html>