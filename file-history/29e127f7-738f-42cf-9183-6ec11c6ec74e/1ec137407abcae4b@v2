#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
基金分析报告生成器
生成包含5个Sheet的Excel报告：
1. 持仓明细（含调仓）
2. 产品风格汇总
3. 产品风格矩阵-金额
4. 产品风格矩阵-占比
5. 悦动系列可转债持仓统计

使用方法：
    python generate_fund_analysis_report.py --holding 持仓盈亏明细列表_20260205.xlsx --date 2026-02-05
"""

import pandas as pd
import numpy as np
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment
from openpyxl.utils import get_column_letter
import argparse
import os
from datetime import datetime


def load_data(holding_file, classification_file):
    """加载数据文件"""
    print("正在读取数据...")

    df_holding = pd.read_excel(holding_file, sheet_name='Sheet1')
    df_trade = pd.read_excel(holding_file, sheet_name='交易情况')
    df_classification = pd.read_excel(classification_file, sheet_name='基金分类')

    # 读取产品和风格的展示顺序
    df_product_order = pd.read_excel(classification_file, sheet_name='产品展示顺序')
    df_style_order = pd.read_excel(classification_file, sheet_name='基金风格展示顺序')

    product_order = df_product_order['产品简称'].dropna().tolist()
    style_order = df_style_order['风格'].dropna().tolist()

    print(f"持仓数据: {len(df_holding)} 条")
    print(f"交易数据: {len(df_trade)} 条")
    print(f"基金分类: {len(df_classification)} 条")
    print(f"产品展示顺序: {len(product_order)} 个")
    print(f"风格展示顺序: {style_order}")

    return df_holding, df_trade, df_classification, product_order, style_order


def build_fund_classifications(df_classification):
    """构建基金分类映射"""
    fund_classifications = {}

    for _, row in df_classification.iterrows():
        external_code = str(row.get('外部代码', '')).strip() if pd.notna(row.get('外部代码')) else ''
        asset_code = str(row.get('资产代码', '')).strip() if pd.notna(row.get('资产代码')) else ''

        if pd.notna(row.get('风格')) and pd.notna(row.get('权益仓位')):
            classification_info = {
                'style': str(row['风格']).strip(),
                'equity_position': float(row['权益仓位']),
                'asset_class': str(row.get('资产类别（PAS)', '')).strip() if pd.notna(row.get('资产类别（PAS)')) else ''
            }

            if external_code:
                fund_classifications[external_code] = classification_info
            if asset_code:
                fund_classifications[asset_code] = classification_info

    print(f"基金分类映射: {len(fund_classifications)} 条")
    return fund_classifications


def build_trade_map(df_trade, product_order):
    """构建交易映射"""
    trade_map = {}

    for _, trade in df_trade.iterrows():
        product_full_name = str(trade.get('产品名称', '')).strip() if pd.notna(trade.get('产品名称')) else ''
        trade_asset_code = str(trade.get('资产代码', '')).strip() if pd.notna(trade.get('资产代码')) else ''
        asset_name = str(trade.get('资产名称', '')).strip() if pd.notna(trade.get('资产名称')) else ''
        direction = str(trade.get('交易方向', '')).strip() if pd.notna(trade.get('交易方向')) else ''

        if not product_full_name or not trade_asset_code:
            continue

        # 匹配产品简称
        product_short_name = None
        for short_name in product_order:
            if short_name in product_full_name:
                product_short_name = short_name
                break

        if not product_short_name:
            continue

        key = (product_short_name, trade_asset_code)

        if key not in trade_map:
            trade_map[key] = {
                'asset_name': asset_name,
                'purchase_amount': 0,
                'redeem_quantity': 0
            }

        if direction == '申购':
            amount = float(trade.get('委托金额', 0)) if pd.notna(trade.get('委托金额')) else 0
            trade_map[key]['purchase_amount'] += amount
        elif direction in ['赎回', '卖出']:
            quantity = float(trade.get('委托数量', 0)) if pd.notna(trade.get('委托数量')) else 0
            trade_map[key]['redeem_quantity'] += quantity

    print(f"交易映射: {len(trade_map)} 条")
    return trade_map


def calculate_product_net_assets(df_holding):
    """计算各产品净资产"""
    product_net_assets = {}

    for _, row in df_holding.iterrows():
        product_name = str(row.get('产品简称', '')).strip() if pd.notna(row.get('产品简称')) else ''
        asset_name = str(row.get('资产简称', '')).strip() if pd.notna(row.get('资产简称')) else ''
        holding_amount = float(row.get('日终市值(元)-产品法估值', 0)) if pd.notna(row.get('日终市值(元)-产品法估值')) else 0

        if not product_name or holding_amount == 0:
            continue

        if product_name not in product_net_assets:
            product_net_assets[product_name] = 0

        # 正回购需要扣除
        is_repo = '正回购' in asset_name if asset_name else False

        if is_repo:
            product_net_assets[product_name] -= holding_amount
        else:
            product_net_assets[product_name] += holding_amount

    return product_net_assets


def process_holdings(df_holding, fund_classifications, trade_map, product_net_assets):
    """处理持仓数据"""
    detail_data = []
    matched_count = 0
    trade_adjusted_count = 0

    for _, row in df_holding.iterrows():
        product_name = str(row.get('产品简称', '')).strip() if pd.notna(row.get('产品简称')) else ''
        asset_name = str(row.get('资产简称', '')).strip() if pd.notna(row.get('资产简称')) else ''
        asset_code = str(row.get('资产代码', '')).strip() if pd.notna(row.get('资产代码')) else ''
        external_code = str(row.get('外部代码', '')).strip() if pd.notna(row.get('外部代码')) else ''

        holding_amount = float(row.get('日终市值(元)-产品法估值', 0)) if pd.notna(row.get('日终市值(元)-产品法估值')) else 0
        holding_quantity = float(row.get('持仓面额', 0)) if pd.notna(row.get('持仓面额')) else 0
        full_price = float(row.get('日终全价（元）-产品法估值', 0)) if pd.notna(row.get('日终全价（元）-产品法估值')) else 0

        if not product_name or not asset_name or holding_amount == 0:
            continue

        # 匹配基金分类
        match_key = external_code if external_code else asset_code
        classification = fund_classifications.get(match_key)

        if not classification:
            continue

        matched_count += 1

        # 处理交易调仓
        trade_key = (product_name, external_code) if external_code else None
        trade_adjustment = 0
        adjusted_holding = holding_amount
        has_trade = False

        if trade_key and trade_key in trade_map:
            trade_info = trade_map[trade_key]
            has_trade = True

            # 申购增加持仓
            if trade_info['purchase_amount'] > 0:
                trade_adjustment += trade_info['purchase_amount']
                adjusted_holding = holding_amount + trade_info['purchase_amount']
                trade_adjusted_count += 1

            # 赎回减少持仓
            if trade_info['redeem_quantity'] > 0:
                if full_price > 0 and holding_quantity >= trade_info['redeem_quantity']:
                    new_quantity = holding_quantity - trade_info['redeem_quantity']
                    new_value = new_quantity * full_price
                    trade_adjustment = new_value - holding_amount
                    adjusted_holding = new_value
                    trade_adjusted_count += 1

        # 计算权益暴露
        equity_exposure = adjusted_holding * (classification['equity_position'] / 100)

        detail_data.append({
            'product_name': product_name,
            'asset_name': asset_name,
            'asset_code': asset_code,
            'external_code': external_code,
            'style': classification['style'],
            'equity_position': classification['equity_position'],
            'holding_amount': holding_amount,
            'trade_adjustment': trade_adjustment,
            'adjusted_holding': adjusted_holding,
            'equity_exposure': equity_exposure,
            'product_net_asset': product_net_assets.get(product_name, 0),
            'is_new': False,
            'has_trade': has_trade
        })

    # 处理新申购资产（持仓表中没有的）
    for (product_name, trade_asset_code), trade_info in trade_map.items():
        already_processed = any(
            d['product_name'] == product_name and d['external_code'] == trade_asset_code
            for d in detail_data
        )

        if already_processed:
            continue

        if trade_info['purchase_amount'] > 0:
            classification = fund_classifications.get(trade_asset_code)

            if not classification:
                continue

            adjusted_holding = trade_info['purchase_amount']
            equity_exposure = adjusted_holding * (classification['equity_position'] / 100)

            detail_data.append({
                'product_name': product_name,
                'asset_name': trade_info['asset_name'],
                'asset_code': trade_asset_code,
                'external_code': trade_asset_code,
                'style': classification['style'],
                'equity_position': classification['equity_position'],
                'holding_amount': 0,
                'trade_adjustment': trade_info['purchase_amount'],
                'adjusted_holding': adjusted_holding,
                'equity_exposure': equity_exposure,
                'product_net_asset': product_net_assets.get(product_name, 0),
                'is_new': True,
                'has_trade': True
            })

            matched_count += 1
            trade_adjusted_count += 1

    print(f"主表统计: {matched_count} 条, 交易调整 {trade_adjusted_count} 条")
    return detail_data


def aggregate_by_product_style(detail_data):
    """按产品和风格汇总"""
    product_style_summary = {}

    for item in detail_data:
        product = item['product_name']
        style = item['style']

        if product not in product_style_summary:
            product_style_summary[product] = {}
        if style not in product_style_summary[product]:
            product_style_summary[product][style] = 0

        product_style_summary[product][style] += item['equity_exposure']

    product_total_equity = {}
    for product, styles in product_style_summary.items():
        product_total_equity[product] = sum(styles.values())

    return product_style_summary, product_total_equity


def get_yuedong_holdings(df_holding, product_net_assets):
    """获取悦动系列可转债持仓统计"""
    # 定义悦动系列产品
    yuedong_products = ['9K210030', '9K731010']

    # 定义目标专户
    target_accounts = [
        '东方红资管-优选可转债1号集合资产管理计划',
        '华润信托·兴稳15号集合资金信托计划',
        '兴业信托·兴享稳健睿郡3号证券投资集合资金信托计划',
        '兴证全球新步步高28号集合资产管理计划',
        '中金赢和1号集合资产管理计划',
        '中欧基金-优选可转债1号集合资产管理计划',
        '中欧基金兴裕可转债1号集合资产管理计划'
    ]

    yuedong_data = []

    for product_code in yuedong_products:
        product_holdings = df_holding[df_holding['产品代码'] == product_code]

        if len(product_holdings) == 0:
            continue

        product_name = product_holdings.iloc[0]['产品简称']
        product_net_asset = product_net_assets.get(product_name, 0)

        for _, row in product_holdings.iterrows():
            asset_name = str(row.get('资产简称', '')).strip() if pd.notna(row.get('资产简称')) else ''
            asset_subclass = str(row.get('新版资产小类', '')).strip() if pd.notna(row.get('新版资产小类')) else ''
            holding_amount = float(row.get('日终市值(元)-产品法估值', 0)) if pd.notna(row.get('日终市值(元)-产品法估值')) else 0

            # 检查是否为目标专户
            is_target_account = any(account in asset_name for account in target_accounts)

            # 检查是否为混合债券型一级基金
            is_bond_fund = asset_subclass == '混合债券型一级基金'

            if is_target_account or is_bond_fund:
                category = ''
                if is_target_account:
                    category = '可转债专户'
                elif is_bond_fund:
                    category = '混合债券型一级基金'

                yuedong_data.append({
                    'product_name': product_name,
                    'asset_name': asset_name,
                    'category': category,
                    'holding_amount': holding_amount,
                    'product_net_asset': product_net_asset
                })

    print(f"悦动系列统计: {len(yuedong_data)} 条记录")
    return yuedong_data


def create_excel_report(detail_data, product_style_summary, product_total_equity,
                       yuedong_data, product_order, style_order, output_file):
    """创建Excel报告"""

    def get_product_order_index(product_name):
        for i, p in enumerate(product_order):
            if p == product_name:
                return i
        return 999

    def get_style_order_index(style):
        if style in style_order:
            return style_order.index(style)
        return 999

    wb = Workbook()
    wb.remove(wb.active)

    # ==================== Sheet 1: 持仓明细（含调仓） ====================
    ws1 = wb.create_sheet('持仓明细（含调仓）')
    headers1 = ['产品名称', '基金名称', '资产代码', '风格', '权益仓位',
                '昨日持仓金额(万)', '当日调仓(万)', '调仓后真实持仓(万)',
                '真实权益暴露(万)', '真实权益占比']

    for col, header in enumerate(headers1, 1):
        cell = ws1.cell(1, col, header)
        cell.font = Font(bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color='667EEA', end_color='667EEA', fill_type='solid')
        cell.alignment = Alignment(horizontal='center', vertical='center')

    # 排序
    detail_data_sorted = sorted(detail_data, key=lambda x: (
        get_product_order_index(x['product_name']),
        get_style_order_index(x['style']),
        -(x['equity_exposure'] / x['product_net_asset'] * 100) if x['product_net_asset'] > 0 else 0
    ))

    row = 2
    for item in detail_data_sorted:
        ws1.cell(row, 1, item['product_name'])
        ws1.cell(row, 2, item['asset_name'])
        ws1.cell(row, 3, item['external_code'] if item['external_code'] else item['asset_code'])
        ws1.cell(row, 4, item['style'])
        ws1.cell(row, 5, f"{item['equity_position']:.0f}%")
        ws1.cell(row, 6, round(item['holding_amount'] / 10000))

        if abs(item['trade_adjustment']) > 0.01:
            adjustment_value = round(item['trade_adjustment'] / 10000)
            ws1.cell(row, 7, adjustment_value)
            ws1.cell(row, 7).fill = PatternFill(start_color='FFF8F0', end_color='FFF8F0', fill_type='solid')
            ws1.cell(row, 7).font = Font(color='FF6B35', bold=True)
        else:
            ws1.cell(row, 7, '-')

        ws1.cell(row, 8, round(item['adjusted_holding'] / 10000))
        if abs(item['trade_adjustment']) > 0.01:
            ws1.cell(row, 8).fill = PatternFill(start_color='F0FDF4', end_color='F0FDF4', fill_type='solid')
            ws1.cell(row, 8).font = Font(color='10B981', bold=True)

        ws1.cell(row, 9, round(item['equity_exposure'] / 10000))

        equity_ratio = (item['equity_exposure'] / item['product_net_asset'] * 100) if item['product_net_asset'] > 0 else 0
        ws1.cell(row, 10, f"{equity_ratio:.2f}%")

        row += 1

    for col, width in enumerate([35, 30, 15, 12, 10, 16, 14, 18, 16, 14], 1):
        ws1.column_dimensions[get_column_letter(col)].width = width

    # ==================== Sheet 2: 产品风格汇总 ====================
    ws2 = wb.create_sheet('产品风格汇总')
    headers2 = ['产品名称', '风格', '权益暴露金额(万)', '权益暴露占比']

    for col, header in enumerate(headers2, 1):
        cell = ws2.cell(1, col, header)
        cell.font = Font(bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color='667EEA', end_color='667EEA', fill_type='solid')
        cell.alignment = Alignment(horizontal='center', vertical='center')

    row = 2
    sorted_products = sorted(product_style_summary.keys(), key=get_product_order_index)

    for product in sorted_products:
        styles = product_style_summary[product]
        total_equity = product_total_equity[product]

        for style in style_order:
            if style in styles:
                amount = styles[style]
                ratio = (amount / total_equity * 100) if total_equity > 0 else 0

                ws2.cell(row, 1, product)
                ws2.cell(row, 2, style)
                ws2.cell(row, 3, round(amount / 10000))
                ws2.cell(row, 4, f"{ratio:.1f}%")

                row += 1

    for col, width in enumerate([35, 12, 18, 14], 1):
        ws2.column_dimensions[get_column_letter(col)].width = width

    # ==================== Sheet 3: 产品风格矩阵（金额） ====================
    ws3 = wb.create_sheet('产品风格矩阵-金额')
    ws3.cell(1, 1, '产品名称')
    ws3.cell(1, 1).font = Font(bold=True, color='FFFFFF')
    ws3.cell(1, 1).fill = PatternFill(start_color='667EEA', end_color='667EEA', fill_type='solid')

    for col, style in enumerate(style_order, 2):
        cell = ws3.cell(1, col, style)
        cell.font = Font(bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color='667EEA', end_color='667EEA', fill_type='solid')
        cell.alignment = Alignment(horizontal='center')

    row = 2
    for product in sorted_products:
        ws3.cell(row, 1, product)
        ws3.cell(row, 1).font = Font(bold=True)

        for col, style in enumerate(style_order, 2):
            if style in product_style_summary[product]:
                amount = product_style_summary[product][style]
                ws3.cell(row, col, round(amount / 10000))
            else:
                ws3.cell(row, col, '-')

        row += 1

    ws3.column_dimensions['A'].width = 35
    for col in range(2, 2 + len(style_order)):
        ws3.column_dimensions[get_column_letter(col)].width = 14

    # ==================== Sheet 4: 产品风格矩阵（占比） ====================
    ws4 = wb.create_sheet('产品风格矩阵-占比')
    ws4.cell(1, 1, '产品名称')
    ws4.cell(1, 1).font = Font(bold=True, color='FFFFFF')
    ws4.cell(1, 1).fill = PatternFill(start_color='667EEA', end_color='667EEA', fill_type='solid')

    for col, style in enumerate(style_order, 2):
        cell = ws4.cell(1, col, style)
        cell.font = Font(bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color='667EEA', end_color='667EEA', fill_type='solid')
        cell.alignment = Alignment(horizontal='center')

    row = 2
    for product in sorted_products:
        ws4.cell(row, 1, product)
        ws4.cell(row, 1).font = Font(bold=True)

        total_equity = product_total_equity[product]

        for col, style in enumerate(style_order, 2):
            if style in product_style_summary[product]:
                amount = product_style_summary[product][style]
                ratio = (amount / total_equity * 100) if total_equity > 0 else 0
                ws4.cell(row, col, f"{round(ratio)}%")
            else:
                ws4.cell(row, col, '-')

        row += 1

    ws4.column_dimensions['A'].width = 35
    for col in range(2, 2 + len(style_order)):
        ws4.column_dimensions[get_column_letter(col)].width = 14

    # ==================== Sheet 5: 悦动系列可转债持仓统计 ====================
    ws5 = wb.create_sheet('悦动系列可转债持仓统计')
    headers5 = ['产品名称', '资产名称', '类别', '持仓金额(万)', '占产品净资产比例']

    for col, header in enumerate(headers5, 1):
        cell = ws5.cell(1, col, header)
        cell.font = Font(bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color='667EEA', end_color='667EEA', fill_type='solid')
        cell.alignment = Alignment(horizontal='center', vertical='center')

    row = 2
    total_by_product = {}

    for item in yuedong_data:
        ws5.cell(row, 1, item['product_name'])
        ws5.cell(row, 2, item['asset_name'])
        ws5.cell(row, 3, item['category'])
        ws5.cell(row, 4, round(item['holding_amount'] / 10000))

        ratio = (item['holding_amount'] / item['product_net_asset'] * 100) if item['product_net_asset'] > 0 else 0
        ws5.cell(row, 5, f"{ratio:.2f}%")

        # 统计合计
        if item['product_name'] not in total_by_product:
            total_by_product[item['product_name']] = {
                'total_amount': 0,
                'net_asset': item['product_net_asset']
            }
        total_by_product[item['product_name']]['total_amount'] += item['holding_amount']

        row += 1

    # 添加合计行
    row += 1
    for product_name, totals in total_by_product.items():
        ws5.cell(row, 1, f"{product_name} - 合计")
        ws5.cell(row, 1).font = Font(bold=True, color='0000FF')
        ws5.cell(row, 4, round(totals['total_amount'] / 10000))
        ws5.cell(row, 4).font = Font(bold=True, color='0000FF')

        ratio = (totals['total_amount'] / totals['net_asset'] * 100) if totals['net_asset'] > 0 else 0
        ws5.cell(row, 5, f"{ratio:.2f}%")
        ws5.cell(row, 5).font = Font(bold=True, color='0000FF')

        row += 1

    ws5.column_dimensions['A'].width = 35
    ws5.column_dimensions['B'].width = 45
    ws5.column_dimensions['C'].width = 20
    ws5.column_dimensions['D'].width = 16
    ws5.column_dimensions['E'].width = 18

    # 保存文件
    wb.save(output_file)
    print(f"\n✅ Excel报告生成成功: {output_file}")


def main():
    parser = argparse.ArgumentParser(description='基金分析报告生成器')
    parser.add_argument('--holding', dest='holding_file', required=True,
                        help='持仓盈亏明细列表Excel文件路径')
    parser.add_argument('--classification', dest='classification_file',
                        default='基金分类数据_2026-01.xlsx',
                        help='基金分类数据Excel文件路径（默认：基金分类数据_2026-01.xlsx）')
    parser.add_argument('--date', '-d', dest='report_date',
                        default=datetime.now().strftime('%Y-%m-%d'),
                        help='报告日期（默认：今天）')
    parser.add_argument('--output', '-o', dest='output_file',
                        help='输出文件路径（默认：基金分析结果_含交易调仓_日期.xlsx）')

    args = parser.parse_args()

    # 获取脚本所在目录
    script_dir = os.path.dirname(os.path.abspath(__file__))

    # 处理文件路径
    holding_file = args.holding_file
    if not os.path.isabs(holding_file):
        holding_file = os.path.join(script_dir, holding_file)

    classification_file = args.classification_file
    if not os.path.isabs(classification_file):
        classification_file = os.path.join(script_dir, classification_file)

    output_file = args.output_file
    if not output_file:
        output_file = os.path.join(script_dir, f'基金分析结果_含交易调仓_{args.report_date}.xlsx')
    elif not os.path.isabs(output_file):
        output_file = os.path.join(script_dir, output_file)

    print(f"="*60)
    print(f"基金分析报告生成器")
    print(f"报告日期: {args.report_date}")
    print(f"="*60)

    # 1. 加载数据
    df_holding, df_trade, df_classification, product_order, style_order = load_data(
        holding_file, classification_file
    )

    # 2. 构建基金分类映射
    fund_classifications = build_fund_classifications(df_classification)

    # 3. 构建交易映射
    trade_map = build_trade_map(df_trade, product_order)

    # 4. 计算各产品净资产
    product_net_assets = calculate_product_net_assets(df_holding)

    # 5. 处理持仓数据
    detail_data = process_holdings(df_holding, fund_classifications, trade_map, product_net_assets)

    # 6. 按产品和风格汇总
    product_style_summary, product_total_equity = aggregate_by_product_style(detail_data)

    # 7. 获取悦动系列可转债持仓统计
    yuedong_data = get_yuedong_holdings(df_holding, product_net_assets)

    # 8. 创建Excel报告
    create_excel_report(
        detail_data, product_style_summary, product_total_equity,
        yuedong_data, product_order, style_order, output_file
    )

    print(f"\n包含以下Sheet:")
    print(f"1. 持仓明细（含调仓）")
    print(f"2. 产品风格汇总")
    print(f"3. 产品风格矩阵-金额")
    print(f"4. 产品风格矩阵-占比")
    print(f"5. 悦动系列可转债持仓统计")


if __name__ == '__main__':
    main()
