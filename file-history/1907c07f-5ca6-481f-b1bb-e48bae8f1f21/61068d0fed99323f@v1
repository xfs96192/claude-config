"""
å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆè„šæœ¬

è¯¥è„šæœ¬æ˜¯å‘¨æŠ¥ç”Ÿæˆç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£ï¼š
1. åŠ è½½äº§å“å‡€å€¼ã€è¿ä½œæ¦‚è§ˆã€æ¸ é“ä¿æœ‰é‡ç­‰æ•°æ®
2. è®¡ç®—å„ç±»ä¸šç»©æŒ‡æ ‡å’Œç»Ÿè®¡æ•°æ®
3. ç”Ÿæˆå¤šä¸ªåˆ†ææŠ¥è¡¨åˆ°Excelè¾“å‡ºæ–‡ä»¶
4. è°ƒç”¨AIç”Ÿæˆæ€»ç»“æ–‡å­—

è¾“å‡ºExcelåŒ…å«ä»¥ä¸‹å·¥ä½œè¡¨ï¼š
- 1ã€åˆ†æ¸ é“ä½™é¢
- æ¸ é“æ˜ç»†
- 2ã€äº§å“è§„æ¨¡
- 3ã€æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–
- æœ¬å‘¨æ–°å‘äº§å“
- å¾…å”®äº§å“
- ç³»åˆ—äº§å“ä¸šç»©ï¼ˆè´¹åå¹³å‡/åŠ æƒã€è´¹å‰å¹³å‡/åŠ æƒï¼‰
- 5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°
- æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡
- æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†
- 8.èµ„äº§å¤§è¡¨
- 9.ä¸­æ”¶ç›‘æ§
- 10.äº§å“åˆ°æœŸæƒ…å†µ
- 11.å„ç±»æŒä»“æ˜ç»†
- 12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•
- 13-14.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡
- 15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š
- ç ´å‡€ç»“æœ
- æ€»ç»“æ–‡å­—
"""

# ==============================================================================
# ç¬¬ä¸€éƒ¨åˆ†ï¼šå¯¼å…¥ä¾èµ–
# ==============================================================================

import os
import pandas as pd
import numpy as np
from datetime import datetime, timedelta, date
import copy
import warnings
warnings.filterwarnings("ignore")

# å¯¼å…¥é¡¹ç›®æ¨¡å—
from config import Config
from config import *  # å‘åå…¼å®¹ï¼Œå¯¼å…¥å¸¸ç”¨å˜é‡
from utils import *
from data_validator import DataValidator, safe_read_excel, validate_critical_paths
from market_data_provider import MarketDataProvider
from load_data import (
    DataLoader,
    map_product_xingtai,
    get_zhaoshang_label,
    get_qudao_label_detail,
    del_Innovation_department
)
from openai import OpenAI


# ==============================================================================
# ç¬¬äºŒéƒ¨åˆ†ï¼šåˆå§‹åŒ–
# ==============================================================================

print("=" * 60)
print("ğŸš€ å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆ - åˆå§‹åŒ–")
print("=" * 60)

# åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨
data_loader = DataLoader()

# åˆå§‹åŒ–å¸‚åœºæ•°æ®æä¾›è€…ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
market_data = MarketDataProvider.get_instance()

# åˆå§‹åŒ–æ•°æ®éªŒè¯å™¨
validator = DataValidator(log_errors=True)

# éªŒè¯å…³é”®è·¯å¾„
print("\nğŸ” éªŒè¯å…³é”®æ•°æ®è·¯å¾„...")
path_validation = validate_critical_paths(Config)
if not path_validation['is_valid']:
    print("âŒ å…³é”®è·¯å¾„éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®ç›®å½•ç»“æ„")
    for error in path_validation['errors']:
        print(f"   - {error}")


# ==============================================================================
# ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¾…åŠ©å‡½æ•°å®šä¹‰
# ==============================================================================

def get_wenzi_result(prompt: str) -> str:
    """è°ƒç”¨DeepSeek APIç”Ÿæˆæ–‡å­—"""
    client = OpenAI(api_key=Config.DEEPSEEK_API_KEY, base_url=Config.DEEPSEEK_BASE_URL)
    response = client.chat.completions.create(
        model=Config.DEEPSEEK_MODEL,
        messages=[
            {"role": "system", "content": "You are a helpful assistant"},
            {"role": "user", "content": prompt},
        ],
        stream=False
    )
    return response.choices[0].message.content


def rank_by_sort(my_df: pd.DataFrame, rank_def: list) -> pd.DataFrame:
    """æŒ‰æŒ‡å®šé¡ºåºå¯¹DataFrameç´¢å¼•æ’åº"""
    my_df = my_df.copy()
    actual = list(my_df.index)
    new_order = [x for x in rank_def if x in actual] + [x for x in actual if x not in rank_def]
    order_map = {val: i for i, val in enumerate(new_order)}
    my_df['__order__'] = my_df.index.map(order_map).fillna(len(new_order))
    my_df = my_df.sort_values('__order__').drop(columns='__order__')
    return my_df


def full_category_or_not(df_def: pd.DataFrame, rank_def: list) -> pd.DataFrame:
    """åˆ¤æ–­å“ç±»Indexæ˜¯å¦é½å…¨ï¼Œè¡¥å……ç¼ºå¤±çš„å“ç±»"""
    df_def = df_def.copy()
    for x in rank_def:
        if x not in df_def.index:
            df_def.loc[x, :] = None
    return df_def


def manager_in_or_not(s: str, y: list) -> bool:
    """åˆ¤æ–­æŠ•èµ„ç»ç†æ˜¯å¦åœ¨æŒ‡å®šåˆ—è¡¨ä¸­"""
    if pd.isnull(s):
        return False
    for mid_y in y:
        if mid_y in s:
            return True
    return False


def clear_manager_name(s: str) -> str:
    """æ¸…ç†æŠ•èµ„ç»ç†åç§°ï¼Œåªä¿ç•™éƒ¨é—¨å†…ç»ç†"""
    first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦', 'æä½³èˆª', "è‹æ–‡æ´¥", "å¤å‡¡ç››", "é»„äº¦å°§"]
    second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ', "ç½—è°¨æ·±"]
    third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°', 'å»–ç‚¯è‡£']
    merge_s = []
    for mid_s in s.split(','):
        if mid_s in first + second + third:
            merge_s.append(mid_s)
    return ','.join(merge_s)


def adjust_manager_aum(mid_data: pd.DataFrame) -> pd.DataFrame:
    """è°ƒæ•´å¤šæŠ•èµ„ç»ç†å…±ç®¡äº§å“çš„è§„æ¨¡åˆ†é…"""
    final_mid_data = mid_data.copy()
    final_mid_data['åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data['å‡€èµ„äº§(äº¿)']
    final_mid_data['åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1

    new_rows = []
    for indx in mid_data.index:
        mng_list = mid_data.loc[indx, 'äº§å“ç»ç†'].split(',')
        if len(mng_list) > 1:
            i = 0
            for mng in mng_list:
                if i == 0:
                    final_mid_data.loc[indx, 'äº§å“ç»ç†'] = mng
                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] / 2
                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1 / len(mng_list)
                    i += 1
                else:
                    mid_series = final_mid_data.loc[indx].copy()
                    mid_series['äº§å“ç»ç†'] = mng
                    new_rows.append(pd.DataFrame(mid_series).T)

    if new_rows:
        final_mid_data = pd.concat([final_mid_data] + new_rows, ignore_index=False)

    return final_mid_data


def get_scaleandnum_by_sort_manager(my_df: pd.DataFrame) -> pd.DataFrame:
    """åŒ¹é…å­æ¯åˆ†ç±»å…³ç³»å¹¶è°ƒæ•´æŠ•èµ„ç»ç†"""
    Parent_sort = data_loader.load_parent_sort(['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»'])
    my_df = my_df.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
    my_df['äº§å“ç»ç†'] = my_df['äº§å“ç»ç†'].map(clear_manager_name)
    return adjust_manager_aum(my_df)


def get_yejijizhunxiaxian(x: str) -> str:
    """è·å–ä¸šç»©åŸºå‡†ä¸‹é™"""
    if not pd.isnull(x):
        try:
            float(x.split('-')[0][:-1])
            return x.split('-')[0]
        except ValueError:
            return ""
    else:
        return x


def get_zhouqi_scale(x: int) -> str:
    """æ ¹æ®å‘¨æœŸå¤©æ•°è¿”å›å‘¨æœŸåŒºé—´æ ‡ç­¾"""
    if x < 30 * 7:
        return '<6M'
    elif (x >= 30 * 7) and (x < 13 * 30):
        return '6M-1Y'
    elif x >= 13 * 30:
        return '>1Y'
    else:
        return 'error'


def get_zhouqi_scale_v2(x: int) -> str:
    """æ ¹æ®å‘¨æœŸå¤©æ•°è¿”å›å‘¨æœŸåŒºé—´æ ‡ç­¾ï¼ˆè¯¦ç»†ç‰ˆï¼‰"""
    if x == 1:
        return 'æ—¥ç›ˆ'
    elif x < 30:
        return '<1M'
    elif x < 31 * 3:
        return '1M-3M'
    elif x < 31 * 6:
        return '3M-6M'
    elif x < 12 * 31:
        return '6M-1Y'
    elif x >= 12 * 31:
        return '>1Y'
    else:
        return 'error'


# ==============================================================================
# ç¬¬å››éƒ¨åˆ†ï¼šåŠ è½½åŸºç¡€æ•°æ®
# ==============================================================================

print("\n" + "=" * 60)
print("ğŸ“Š åŠ è½½åŸºç¡€æ•°æ®...")
print("=" * 60)

# 4.1 åŠ è½½äº§å“å‡€å€¼æ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
print("\n[4.1] åŠ è½½äº§å“å‡€å€¼æ•°æ®...")
data, data_transposition = data_loader.load_nav_data()
data_transposition.replace(0, np.nan, inplace=True)

# 4.2 åŠ è½½DAPäº§å“ä¿¡æ¯è¡¨
print("\n[4.2] åŠ è½½DAPäº§å“ä¿¡æ¯è¡¨...")
Product_information_df_DAP = data_loader.load_product_info_dap()

# 4.3 åŠ è½½å“ç±»åˆ†ç±»æ•°æ®
print("\n[4.3] åŠ è½½å“ç±»åˆ†ç±»æ•°æ®...")
classification_df = data_loader.load_classification_df()
classification_ye = classification_df['å¤šèµ„äº§å“ç±»']

# 4.4 åŠ è½½é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»
print("\n[4.4] åŠ è½½é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»...")
Parent_sort = data_loader.load_parent_sort(['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»'])


# ==============================================================================
# ç¬¬äº”éƒ¨åˆ†ï¼šç”Ÿæˆäº§å“è¿ä½œæ¦‚è§ˆæ•°æ®
# ==============================================================================

def get_yunzuogailan(yunzuogailan_date: str) -> None:
    """
    ç”Ÿæˆå¹¶ä¿å­˜äº§å“è¿ä½œæ¦‚è§ˆæ•°æ®

    å‚æ•°ï¼š
        yunzuogailan_date: è¿ä½œæ¦‚è§ˆæ—¥æœŸ (YYYYMMDDæ ¼å¼)
    """
    print(f"\n[5.0] ç”Ÿæˆäº§å“è¿ä½œæ¦‚è§ˆæ•°æ® - {yunzuogailan_date}")

    # åŠ è½½åŸå§‹æ•°æ®
    yunzuogailan_before = data_loader.load_yunzuogailan_raw()
    Baoyou_df = data_loader.load_baoyou_data()

    # åŒ¹é…ç†è´¢äº§å“çš„å­—æ¯ä»£ç 
    yunzuogailan_before['æ¯äº§å“ä»£ç '] = yunzuogailan_before['äº§å“ç®€ç§°'].map(
        lambda x: yunzuogailan_before[yunzuogailan_before['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]
    )
    yunzuogailan_before = yunzuogailan_before[~(yunzuogailan_before['å•ä½å‡€å€¼'].isnull())]

    # è·å–ç¾å…ƒäº§å“æ¸…å•
    Dollar_product_list = list(
        set(Product_information_df_DAP[Product_information_df_DAP['å¸ç§'] == 'ç¾å…ƒ'].index).intersection(
            yunzuogailan_before.index
        )
    )
    yunzuogailan_before['å‡€èµ„äº§(äº¿)'] = yunzuogailan_before.apply(
        lambda x: Baoyou_df.loc[x.name]['ä¿æœ‰è§„æ¨¡'].sum() / 100000000 if x.name in Dollar_product_list else x['å‡€èµ„äº§(äº¿)'],
        axis=1
    )
    yunzuogailan_before = yunzuogailan_before.merge(
        Product_information_df_DAP[['å¸ç§']], left_index=True, right_index=True, how='left'
    )

    # åŒ¹é…å“ç±»
    yunzuogailan_before['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(
        lambda x: classification_ye[x] if x in classification_ye.index else np.nan
    )
    yunzuogailan_before['äº§å“éƒ¨å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(
        lambda x: classification_df['äº§å“éƒ¨å“ç±»'][x] if x in classification_ye.index else np.nan
    )

    # åŒ¹é…äº§å“è¿ä½œå‘¨æœŸ
    patern = pd.Series(Product_information_df_DAP.apply(map_product_xingtai, axis=1), name='å½¢æ€')

    # åˆå¹¶ä¿æœ‰é‡æ•°æ®
    Baoyou_df_merge = Baoyou_df.merge(yunzuogailan_before['æ¯äº§å“ä»£ç '], left_index=True, right_index=True, how='left')
    yunzuogailan_before = yunzuogailan_before.merge(patern, left_index=True, right_index=True, how='left')
    yunzuogailan_before = yunzuogailan_before.merge(
        Product_information_df_DAP[['å‘¨æœŸå¤©æ•°', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°']],
        left_index=True, right_index=True, how='left'
    )

    # åŒ¹é…æ‹›å•†æ ‡ç­¾
    Zhaoshang_label_df = pd.DataFrame(
        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_zhaoshang_label(set(x['æ¸ é“åç§°']))),
        columns=['æ˜¯å¦æ‹›å•†']
    )
    yunzuogailan_before = yunzuogailan_before.merge(Zhaoshang_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')

    # åŒ¹é…æ¸ é“æ˜ç»†
    Qudao_label_df = pd.DataFrame(
        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_qudao_label_detail(set(x['æ¸ é“åç§°']))),
        columns=['æ¸ é“æ˜ç»†']
    )
    yunzuogailan_before = yunzuogailan_before.merge(Qudao_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')

    # ç‰¹æ®Šæ—¥æœŸå¤„ç†
    if yunzuogailan_date in ['20231229', '20231231']:
        yunzuogailan_before['äº§å“ç»ç†'] = yunzuogailan_before.apply(
            lambda x: Product_information_df_DAP.loc[x.name, 'æ¯äº§å“æŠ•èµ„ç»ç†'], axis=1
        )

    yunzuogailan_before.rename(columns={'ç»„åˆä¹…æœŸ(å¤šèµ„äº§)': 'ç»„åˆä¹…æœŸ'}, inplace=True)
    yunzuogailan_before.rename(columns={'ç»„åˆé™æ€(å¤šèµ„äº§)': 'ç»„åˆé™æ€'}, inplace=True)

    # åˆå¹¶æ¯å­æ ‡å¿—
    yunzuogailan_before_v2 = yunzuogailan_before.merge(
        Product_information_df_DAP[['æ¯å­æ ‡å¿—']], left_index=True, right_index=True, how='left'
    )

    # æ ‡è®°ä¸»è¦å±•ç¤ºäº§å“
    yunzuogailan_before_v2['ä¸»è¦å±•ç¤º'] = yunzuogailan_before_v2.apply(
        lambda x: 'æ˜¯' if ((x['æ¯å­æ ‡å¿—'] == 'éæ¯å­äº§å“') or ('(å­1)' in x['äº§å“ç®€ç§°'])) else 'å¦', axis=1
    )

    # åˆå¹¶æ¯åˆ†ç±»
    Parent_sort_full = pd.read_excel(
        Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),
        sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»',
        index_col=0
    )[['æ¯åˆ†ç±»']]
    Parent_sort_full = Parent_sort_full[~Parent_sort_full.index.duplicated(keep='first')]

    # é˜²å¾¡æ€§å¤„ç†
    if yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(lambda x: isinstance(x, pd.Series)).any():
        print("âš ï¸ æ£€æµ‹åˆ° 'å¤šèµ„äº§å“ç±»' åˆ—ä¸­å­˜åœ¨ Series å€¼ï¼Œå·²è‡ªåŠ¨ä¿®å¤")
        yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(
            lambda s: s.dropna().iloc[0] if isinstance(s, pd.Series) and len(s.dropna()) > 0 else (
                np.nan if isinstance(s, pd.Series) else s
            )
        )

    yunzuogailan_before_v2 = yunzuogailan_before_v2.merge(
        Parent_sort_full, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left'
    )

    # ä¿å­˜æ¯äº§å“ç‰ˆæœ¬
    yunzuogailan_export = yunzuogailan_before_v2[yunzuogailan_before_v2['äº§å“ç®€ç§°'].map(lambda x: '(å­' not in x)]
    keep_col_here = [
        'äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',
        'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'é”€å”®è´¹',
        'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å‘¨æœŸå¤©æ•°', 'æ˜¯å¦æ‹›å•†', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ¯åˆ†ç±»'
    ]
    yunzuogailan_export = yunzuogailan_export[keep_col_here]
    yunzuogailan_export.drop_duplicates().to_excel(Config.get_overview_parent_file(yunzuogailan_date))

    # ç”Ÿæˆå¸¦å˜åŒ–æŒ‡æ ‡çš„ç‰ˆæœ¬
    yzgl = yunzuogailan_before_v2.drop_duplicates().copy()
    yzgl_lastw = pd.read_excel(Config.get_overview_history_file(lastw), index_col=0)
    yzgl_lastm = pd.read_excel(Config.get_overview_history_file(lastm), index_col=0)

    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastw['ç»„åˆä¹…æœŸ']
    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['æ æ†'] - yzgl_lastw['æ æ†']
    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastw['æƒç›Šä»“ä½']
    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastm['ç»„åˆä¹…æœŸ']
    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['æ æ†'] - yzgl_lastm['æ æ†']
    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastm['æƒç›Šä»“ä½']

    mu_col = [
        'äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', '5%æµåŠ¨æ€§å®é™…æŒ‡æ ‡', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ç´¯è®¡å¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'æ æ†',
        'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'è¡ç”Ÿå“ä»“ä½', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥',
        'é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'æ¯äº§å“ä»£ç ', 'å¸ç§', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å½¢æ€', 'å‘¨æœŸå¤©æ•°',
        'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ˜¯å¦æ‹›å•†', 'æ¸ é“æ˜ç»†', 'æ¯å­æ ‡å¿—', 'ä¸»è¦å±•ç¤º', 'æ¯åˆ†ç±»', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨',
        'æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨', 'æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ', 'æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ', 'æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'
    ]
    yzgl[mu_col].to_excel(Config.get_overview_history_file(yunzuogailan_date))
    print("   âœ… äº§å“è¿ä½œæ¦‚è§ˆæ•°æ®å·²ä¿å­˜")


# æ‰§è¡Œè¿ä½œæ¦‚è§ˆæ•°æ®ç”Ÿæˆ
get_yunzuogailan(yunzuogailan_date)


# ==============================================================================
# ç¬¬å…­éƒ¨åˆ†ï¼šåŠ è½½å¤„ç†åçš„æ•°æ®
# ==============================================================================

print("\n[6.0] åŠ è½½å¤„ç†åçš„è¿ä½œæ¦‚è§ˆæ•°æ®...")
yunzuogailan_all = pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)
Channel_df = data_loader.load_channel_data()
date = zhoubao_date

# åˆ›å»ºè¾“å‡ºExcelå†™å…¥å™¨
writer = pd.ExcelWriter(Config.get_current_output_writer(date))

# å®šä¹‰å“ç±»æ’åºé¡ºåº
rank_here = [
    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³äº«çŸ­æŒ'),
    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³/çº¯äº«'),
    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¼˜å…ˆè‚¡çŸ­æŒ'),
    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¸°åˆ©/å¢ç›ˆ'),
    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'è¡Œå¤–éæ ‡é©±åŠ¨å‹å›ºæ”¶+'),
    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å’Œç‘BOF'),
    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€'),
    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'é€¸åŠ¨çŸ­æŒ'),
    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'çµåŠ¨çŸ­æŒ'),
    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å…´åŠ¨çŸ­æŒ'),
    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å«æƒå®šå¼€/å°é—­'),
    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'ESGè”å'),
    ('å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),
    ('å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼'),
]


# ==============================================================================
# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æ¸ é“åˆ†æ
# ==============================================================================

print("\n" + "=" * 60)
print("ğŸ“ˆ ç”ŸæˆæŠ¥è¡¨...")
print("=" * 60)

# ------------------------------------------------------------------------------
# æŠ¥è¡¨1: åˆ†æ¸ é“ä½™é¢
# ------------------------------------------------------------------------------
print("\n[1] ç”ŸæˆæŠ¥è¡¨: 1ã€åˆ†æ¸ é“ä½™é¢...")

# åŒ¹é…æ¸ é“æ•°æ®çš„å“ç±»å’Œäº§å“ç»ç†
Channel_df['æ¯äº§å“ä»£ç '] = Channel_df['äº§å“ç®€ç§°'].map(
    lambda x: Channel_df[Channel_df['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]
)
Channel_df['å¤šèµ„äº§å“ç±»'] = Channel_df['æ¯äº§å“ä»£ç '].map(
    lambda x: classification_ye[x] if x in classification_ye.index else np.nan
)
Channel_df = Channel_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')
Channel_df = Channel_df[~pd.isnull(Channel_df['äº§å“ç»ç†'])]
Channel_df = del_Innovation_department(Channel_df)

# å¤„ç†å­äº§å“æ¸ é“æ•°æ®
Channel_df_subproduct = Channel_df[Channel_df['æ¸ é“åç§°'] != '-']
Channel_df_subproduct['æ¸ é“-è¡Œå†…å¤–'] = Channel_df_subproduct['æ¸ é“åç§°'].map(
    lambda x: 'è¡Œå†…' if x == 'å…´ä¸šé“¶è¡Œ' else 'è¡Œå¤–'
)
Channel_df_subproduct = Channel_df_subproduct.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')

# ç”Ÿæˆåˆ†æ¸ é“ä½™é¢è¡¨
Channel_result1 = pd.pivot_table(
    Channel_df_subproduct,
    index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],
    columns='æ¸ é“-è¡Œå†…å¤–',
    values=['ä¿æœ‰è§„æ¨¡'],
    aggfunc=np.sum
) / 100000000
Channel_result1 = rank_by_sort(Channel_result1, rank_here)

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: æ¸ é“æ˜ç»†
# ------------------------------------------------------------------------------
print("[1.1] ç”ŸæˆæŠ¥è¡¨: æ¸ é“æ˜ç»†...")

Channel_result2 = pd.pivot_table(
    Channel_df_subproduct,
    index=['æ¸ é“åç§°'],
    columns='æ€»åˆ†ç±»',
    values=['ä¿æœ‰è§„æ¨¡'],
    aggfunc=np.sum
) / 100000000
Channel_result2['åˆè®¡'] = Channel_result2.sum(axis=1)
Channel_result2 = Channel_result2.sort_values('åˆè®¡', ascending=False)

# è®¡ç®—ç›¸æ¯”ä¸Šæœˆå’Œä¸Šå¹´çš„å˜åŒ–
Channel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šæœˆ', '')] = Channel_result2[('åˆè®¡', '')] - \
    pd.read_excel(Config.get_output_result_file(lastm), sheet_name='æ¸ é“æ˜ç»†', index_col=0, skiprows=[1, 2])['åˆè®¡']
Channel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šå¹´', '')] = Channel_result2[('åˆè®¡', '')] - \
    pd.read_excel(Config.get_output_result_file(lasty), sheet_name='æ¸ é“æ˜ç»†', index_col=0, skiprows=[1, 2])['åˆè®¡']

Channel_result1.to_excel(writer, sheet_name='1ã€åˆ†æ¸ é“ä½™é¢')
Channel_result2.to_excel(writer, sheet_name='æ¸ é“æ˜ç»†')


# ==============================================================================
# ç¬¬å…«éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“è§„æ¨¡
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨2: äº§å“è§„æ¨¡
# ------------------------------------------------------------------------------
print("\n[2] ç”ŸæˆæŠ¥è¡¨: 2ã€äº§å“è§„æ¨¡...")

now = zhoubao_date
yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))
yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))
yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))

lastm_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - get_scaleandnum_by_sort(yunzuogailan_lastm)
lastm_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«']
lasty_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - full_category_or_not(
    get_scaleandnum_by_sort(yunzuogailan_lasty), rank_here
).fillna(0)
lasty_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']

cols = ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']
result_3 = pd.concat([get_scaleandnum_by_sort(yunzuogailan_now), lastm_delta_df, lasty_delta_df], axis=1)[cols]
result_3[['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']] = result_3[
    ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']
].applymap(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)
result_3 = rank_by_sort(result_3, rank_here)
result_3[cols].to_excel(writer, sheet_name='2ã€äº§å“è§„æ¨¡')


# ==============================================================================
# ç¬¬ä¹éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - è§„æ¨¡å˜åŒ–ä¸æ–°å‘äº§å“
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨3: æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–
# ------------------------------------------------------------------------------
print("\n[3] ç”ŸæˆæŠ¥è¡¨: 3ã€æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–...")

data_zhanbao = zhoubao_date
zhanbao_df = data_loader.load_zhanbao_data()

if 'äº§å“ç»ç†' not in zhanbao_df.columns:
    zhanbao_df = zhanbao_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')
zhanbao_df.rename(columns={'å“ç±»': 'å¤šèµ„äº§å“ç±»'}, inplace=True)

zhanbao_df_1 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: not pd.isnull(x))]
zhanbao_df_1 = del_Innovation_department(zhanbao_df_1)
zhanbao_df_2 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: pd.isnull(x))]
zhanbao_df = pd.concat([zhanbao_df_1, zhanbao_df_2])

zhanbao_df['æ¯äº§å“ä»£ç '] = zhanbao_df.apply(lambda x: x.name if pd.isnull(x['æ¯äº§å“ä»£ç ']) else x['æ¯äº§å“ä»£ç '], axis=1)
zhanbao_df['æ¯äº§å“ç®€ç§°'] = zhanbao_df.apply(
    lambda x: x['äº§å“ç®€ç§°'] if pd.isnull(x['æ¯äº§å“ç®€ç§°']) else x['æ¯äº§å“ç®€ç§°'], axis=1
)

kaifang_df = zhanbao_df[
    (zhanbao_df['å½¢æ€'] == 'å®¢æˆ·å‘¨æœŸ') | (zhanbao_df['å½¢æ€'] == 'æœ€çŸ­æŒæœ‰æœŸ') |
    (zhanbao_df['å½¢æ€'] == 'å®šå¼€') | (zhanbao_df['å½¢æ€'] == 'æ—¥å¼€')
]
kaifang_df = kaifang_df.groupby('æ¯äº§å“ä»£ç ').agg({
    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',
    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'äº§å“ç»ç†': 'first'
})
kaifang_df = kaifang_df[kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(lambda x: abs(x) >= 0.05)]
kaifang_df.sort_values(by='è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', ascending=False, inplace=True)
kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'] = kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(
    lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x
)
kaifang_df = kaifang_df[kaifang_df['æ¯å“ç±»'] != 'å°é—­åˆ°æœŸ']
kaifang_df.to_excel(writer, sheet_name='3ã€æœ¬â½‰å®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–')

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: æœ¬å‘¨æ–°å‘äº§å“
# ------------------------------------------------------------------------------
print("[3.1] ç”ŸæˆæŠ¥è¡¨: æœ¬å‘¨æ–°å‘äº§å“...")

yunzuogailan_date = zhoubao_date
xinfa_thisweek_df = zhanbao_df[zhanbao_df['èµ·æ¯æ—¥'] >= week_Mon]
yunzuogailan_original = pd.read_excel(Config.get_weekly_data_file('äº§å“è¿ä½œæ¦‚è§ˆ'), index_col=0)
yunzuogailan_original['æ¯äº§å“ä»£ç '] = yunzuogailan_original['äº§å“ç®€ç§°'].map(
    lambda x: yunzuogailan_original[yunzuogailan_original['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]
)
yunzuogailan_original = yunzuogailan_original[['äº§å“ç®€ç§°', 'æ¯äº§å“ä»£ç ', 'äº§å“ç»ç†']].drop_duplicates()

for mid_ind in xinfa_thisweek_df.index:
    if mid_ind in yunzuogailan_original.index:
        mother_indx = yunzuogailan_original.loc[mid_ind, 'æ¯äº§å“ä»£ç ']
        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mother_indx
        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç®€ç§°']
        xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç»ç†'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç»ç†']
    else:
        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mid_ind
        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç®€ç§°']

xinfa_thisweek_qudao = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ', 'æ¸ é“-ç®€åŒ–']).agg({
    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',
    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'
})
xinfa_thisweek_sum = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ']).agg({
    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',
    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'
})

for mid_ind in xinfa_thisweek_sum.index:
    if (mid_ind, 'è¡Œå†…') in xinfa_thisweek_qudao.index:
        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå†…(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå†…'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']
    if (mid_ind, 'è¡Œå¤–') in xinfa_thisweek_qudao.index:
        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå¤–(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå¤–'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']

if xinfa_thisweek_sum.empty:
    result_3_2_df = pd.DataFrame(columns=[
        'æ¯äº§å“ç®€ç§°', 'é”€é‡(äº¿)', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',
        'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'
    ])
else:
    keep_columns_xinfa = [
        'æ¯äº§å“ç®€ç§°', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',
        'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'æˆ˜æŠ¥åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'
    ]
    cols_available = [c for c in keep_columns_xinfa if c in xinfa_thisweek_sum.columns]
    xinfa_thisweek_sum = xinfa_thisweek_sum[cols_available].copy()
    xinfa_thisweek_sum.rename(columns={'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'é”€é‡(äº¿)', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'åˆ°æœŸæ—¥'}, inplace=True)
    result_3_2_df = xinfa_thisweek_sum[xinfa_thisweek_sum['é”€é‡(äº¿)'] != 0]
    result_3_2_df.sort_values(by='èµ·æ¯æ—¥', ascending=True, inplace=True)

result_3_2_df.to_excel(writer, sheet_name='æœ¬å‘¨æ–°å‘äº§å“')

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: å¾…å”®äº§å“
# ------------------------------------------------------------------------------
print("[3.2] ç”ŸæˆæŠ¥è¡¨: å¾…å”®äº§å“...")

product_tosale_df = data_loader.load_product_tosale()
product_tosale_df = product_tosale_df.merge(
    Product_information_df_DAP['æ¯äº§å“æŠ•èµ„ç»ç†'], left_index=True, right_index=True, how='left'
)

first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦', 'æä½³èˆª', "è‹æ–‡æ´¥", "å¤å‡¡ç››", "é»„äº¦å°§"]
second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ', "ç½—è°¨æ·±"]
third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°', 'å»–ç‚¯è‡£']

product_tosale_df_new = product_tosale_df[
    product_tosale_df['æ¯äº§å“æŠ•èµ„ç»ç†'].map(lambda x: manager_in_or_not(x, first + second + third))
]
date_here = zhoubao_date[:4] + '-' + zhoubao_date[4:6] + '-' + zhoubao_date[6:]
product_tosale_df_final = product_tosale_df_new[product_tosale_df_new['æˆç«‹æ—¥'] > date_here]
product_tosale_df_final.drop_duplicates(inplace=True)
keep_columns = ['æ¯å­äº§å“æ ‡è¯†', 'äº§å“ç®€ç§°', 'äº§å“å¼€æ”¾å½¢å¼', 'å‹Ÿé›†æœŸ(èµ·)', 'å‹Ÿé›†æœŸ(æ­¢)', 'æˆç«‹æ—¥', 'åˆ°æœŸæ—¥', 'è§„æ¨¡ä¸Šé™(äº¿)', 'é”€å”®å¸ç§']
product_tosale_df_final_v1 = product_tosale_df_final[keep_columns]
product_tosale_df_final_v2 = product_tosale_df_final_v1[
    product_tosale_df_final_v1.apply(
        lambda x: False if (x['äº§å“ç®€ç§°'] in product_tosale_df_final_v1['äº§å“ç®€ç§°']) and (x['æ¯å­äº§å“æ ‡è¯†'] == 'æ¯äº§å“') else True,
        axis=1
    )
]
product_tosale_df_final_v2.sort_values(by='æˆç«‹æ—¥', ascending=True, inplace=True)
product_tosale_df_final_v2.to_excel(writer, sheet_name='å¾…å”®äº§å“')


# ==============================================================================
# ç¬¬åéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“ä¸šç»©åˆ†æ
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: ç³»åˆ—äº§å“ä¸šç»©ï¼ˆè´¹åå¹³å‡/åŠ æƒã€è´¹å‰å¹³å‡/åŠ æƒï¼‰
# ------------------------------------------------------------------------------
print("\n[5] ç”ŸæˆæŠ¥è¡¨: ç³»åˆ—äº§å“ä¸šç»©...")

# è®¡ç®—ä¸šç»©æ•°æ®éœ€è¦ç”¨åˆ°çš„å‡½æ•°
year_col = f"{int(str(zhoubao_date)[:4])}å¹´å¹´åŒ–æ”¶ç›Šç‡"


def weighted_avg(group):
    """è®¡ç®—è§„æ¨¡åŠ æƒå¹³å‡"""
    w_fields = [
        'ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡',
        'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡'
    ]
    results = {}
    for field in w_fields:
        mask = group[field].notna()
        if mask.any():
            weight_valid = group.loc[mask, 'å‡€èµ„äº§(äº¿)']
            total_weight = weight_valid.sum()
            results[field] = (group.loc[mask, field] * weight_valid).sum() / total_weight
        else:
            results[field] = np.nan
    return pd.Series(results)


# ç”Ÿæˆäº§å“ç›‘æ§æ•°æ®
data_transposition_here = data_transposition
data_transposition_here.apply(performance_calculate_optimize).T.to_excel(Config.get_performance_file(zhoubao_date))
print('   æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.index[-1]))

# åŠ è½½è¿ä½œæ¦‚è§ˆæ•°æ®
yunzuogailan_all = del_Innovation_department(
    pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)
)

# ç­›é€‰æŒæœ‰æœŸå’Œå…¶ä»–äº§å“
to_merge_chiyouqi_code = yunzuogailan_all[
    yunzuogailan_all.apply(lambda x: (x['ä¸»è¦å±•ç¤º'] == 'æ˜¯') & (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']), axis=1)
]
to_merge_other_code = yunzuogailan_all[
    yunzuogailan_all.apply(lambda x: (x['æ¯å­æ ‡å¿—'] in ['éæ¯å­äº§å“', 'æ¯äº§å“']) & (x['å½¢æ€'] in ['å°é—­', 'å®šå¼€']), axis=1)
]
yunzuogailan_now = pd.concat([to_merge_chiyouqi_code, to_merge_other_code])

# åˆå¹¶æ”¶ç›Šç‡å’Œæ³¢åŠ¨ç‡æ•°æ®
keep_cols = ['è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']
yunzuogailan_now_5 = yunzuogailan_now.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
perf_df = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0)
keep_cols = [c for c in keep_cols if c in perf_df.columns]
yunzuogailan_now_ret = yunzuogailan_now_5.merge(perf_df[keep_cols], left_index=True, right_index=True, how='left')
yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'] = yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'].map(
    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x
)

# å¯¹è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡ä¸º0æˆ–ç¼ºå¤±çš„äº§å“ï¼Œç”¨æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡æ›¿ä»£
yunzuogailan_now_ret['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] = yunzuogailan_now_ret.apply(
    lambda row: row['ç´¯è®¡å¹´åŒ–'] if (pd.isna(row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡']) or row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] == 0) else row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'],
    axis=1
)

# 5.1 è´¹åå¹³å‡
result_5 = yunzuogailan_now_ret[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + ['ç´¯è®¡å¹´åŒ–'] + keep_cols].groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()[
    ['ç´¯è®¡å¹´åŒ–'] + keep_cols
]
result_5 = rank_by_sort(result_5, rank_here)
result_5.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹åå¹³å‡')

# 5.2 è´¹ååŠ æƒ
result_5_weight = yunzuogailan_now_ret.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)
result_5_weight = rank_by_sort(result_5_weight, rank_here)
result_5_weight.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹ååŠ æƒ')

# 5.3 è´¹å‰æ•°æ®
yunzuogailan_add_fee = yunzuogailan_now_ret.copy()
w_field = ['ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']
yunzuogailan_add_fee[w_field] = yunzuogailan_add_fee[w_field].add(
    yunzuogailan_add_fee[['é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹']].sum(axis=1), axis=0
)

# 5.4 è´¹å‰åŠ æƒ
result_series_performance = yunzuogailan_add_fee.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)
result_series_performance = rank_by_sort(result_series_performance, rank_here)
result_series_performance.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰åŠ æƒ')

# 5.5 è´¹å‰å¹³å‡
result_series_performance_average = yunzuogailan_add_fee[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + w_field + ['è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']].groupby(
    ['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']
).mean()
result_series_performance_average = rank_by_sort(result_series_performance_average, rank_here)
result_series_performance_average.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰å¹³å‡')

# ------------------------------------------------------------------------------
# æŠ¥è¡¨5.2: æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°
# ------------------------------------------------------------------------------
print("[5.2] ç”ŸæˆæŠ¥è¡¨: 5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°...")

yunzuogailan_now_ret_chiyouqi = yunzuogailan_now_ret[yunzuogailan_now_ret.apply(
    lambda x: (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']) and (x['æ¯åˆ†ç±»'] in ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€']),
    axis=1
)]
yunzuogailan_now_ret_chiyouqi.rename(columns={'ç´¯è®¡å¹´åŒ–': 'æˆç«‹ä»¥æ¥å¹´åŒ–', year_col: 'ä»Šå¹´ä»¥æ¥å¹´åŒ–'}, inplace=True)

# æœ±è€å¸ˆçš„æ‚¦åŠ¨ç¨³äº«9M281010å•ç‹¬å¤„ç†
yunzuogailan_now_ret_chiyouqi.loc[
    '9M281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']
] = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0).loc[
    '9A281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col]
].values

yunzuogailan_now_ret_chiyouqi['ä»Šå¹´ä»¥æ¥å¹´åŒ–'] = yunzuogailan_now_ret_chiyouqi.apply(
    lambda x: x['æˆç«‹ä»¥æ¥å¹´åŒ–'] if pd.isnull(x['ä»Šå¹´ä»¥æ¥å¹´åŒ–']) else x['ä»Šå¹´ä»¥æ¥å¹´åŒ–'], axis=1
)


def get_Scale_weighting_ret(my_df):
    keep_ret_cols = ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']
    ret_sum_df = (my_df[keep_ret_cols].multiply(my_df['å‡€èµ„äº§(äº¿)'], axis="index")).sum()
    scale_sum_df = ((my_df[keep_ret_cols] / my_df[keep_ret_cols]).multiply(my_df['å‡€èµ„äº§(äº¿)'], axis="index")).sum()
    return ret_sum_df / scale_sum_df


result_df_52 = yunzuogailan_now_ret_chiyouqi.groupby('æ¯åˆ†ç±»').apply(get_Scale_weighting_ret)
result_df_52.rename(index={'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€': 'æ‚¦åŠ¨çŸ­æŒ'}, inplace=True)
rank_chiyouqi = ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ']
rank_by_sort(result_df_52, rank_chiyouqi).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°1')

yunzuogailan_now_ret_chiyouqi['æŒæœ‰æœŸæ ‡ç­¾'] = yunzuogailan_now_ret_chiyouqi['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale_v2)
yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'] = yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'].map(
    lambda x: 'æ‚¦åŠ¨çŸ­æŒ' if x == 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€' else x
)
result_df_52_3 = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾']).apply(get_Scale_weighting_ret)
result_df_52_3['æ•°é‡'] = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾'])['äº§å“ç®€ç§°'].count()
rank_chiyouqi_v3 = [
    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '<1M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '1M-3M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '3M-6M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '6M-1Y'),
    ('æ‚¦åŠ¨çŸ­æŒ', '<1M'), ('æ‚¦åŠ¨çŸ­æŒ', '1M-3M'), ('æ‚¦åŠ¨çŸ­æŒ', '3M-6M'), ('æ‚¦åŠ¨çŸ­æŒ', '6M-1Y'),
    ('ä¼˜å…ˆè‚¡çŸ­æŒ', '1M-3M')
]
rank_by_sort(result_df_52_3, rank_chiyouqi_v3).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°2')


# ==============================================================================
# ç¬¬åä¸€éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æŠ•èµ„ç»ç†åˆ†æ
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡
# ------------------------------------------------------------------------------
print("\n[6] ç”ŸæˆæŠ¥è¡¨: æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡...")

now = zhoubao_date
yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))
yunzuogailan_lastw = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastw), index_col=0))
yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))
yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))

result_now = get_scaleandnum_by_sort_manager(yunzuogailan_now).groupby('äº§å“ç»ç†').agg({
    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'
})

rikai_now = get_scaleandnum_by_sort_manager(yunzuogailan_now)
rikai_now = rikai_now[rikai_now['å½¢æ€'].map(lambda x: x in ['æ—¥å¼€', 'å®¢æˆ·å‘¨æœŸ', 'æœ€çŸ­æŒæœ‰æœŸ'])].groupby('äº§å“ç»ç†').agg({
    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'
})
rikai_now.rename(columns={'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'}, inplace=True)

result_df_here = []
cols_to_append = ['-è¾ƒä¸Šå‘¨', '-è¾ƒä¸Šæœˆæœ«', '-è¾ƒä¸Šå¹´æœ«']
for i in range(3):
    mid_df = [yunzuogailan_lastw, yunzuogailan_lastm, yunzuogailan_lasty][i]
    result_df_i = result_now - get_scaleandnum_by_sort_manager(mid_df).groupby('äº§å“ç»ç†').agg({
        'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'
    })
    result_df_i.columns = [x + cols_to_append[i] for x in ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°']]
    result_df_here.append(result_df_i)

result_df_here = pd.concat([result_now] + result_df_here + [rikai_now], axis=1)

cols_here = [
    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡',
    'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'
]
indx_here = [
    'ä¸¥æ³“', 'å¾è¹', 'æ¨æ¼ ', 'é«˜ç¿°æ˜†', 'å§œé”¡å³°', 'ä½™æ´é›…', 'è–›çºªæ™”', 'èƒ¡è‰³å©·', 'æœ±è½¶ä¼¦', 'ä»»é›',
    'å¼ ç‰æ°', 'å»–ç‚¯è‡£', 'æä½³èˆª', "è‹æ–‡æ´¥", "å¤å‡¡ç››", "é»„äº¦å°§", "ç½—è°¨æ·±"
]
result_df_here = result_df_here[cols_here]
result_df_here = result_df_here.dropna(axis=0, how='all')
result_df_here = rank_by_sort(result_df_here, indx_here)
result_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']] = \
    result_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']].applymap(
        lambda x: '{:.2f}'.format(x)
    )
result_df_here.to_excel(writer, sheet_name='æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡')

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡
# ------------------------------------------------------------------------------
print("[6.1] ç”ŸæˆæŠ¥è¡¨: ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡...")

yunzuogailan_now_65 = yunzuogailan_now.copy()
yunzuogailan_now_65['å½¢æ€'] = yunzuogailan_now_65['å½¢æ€'].map(lambda x: 'æœ€çŸ­æŒæœ‰æœŸ' if x == 'å®¢æˆ·å‘¨æœŸ' else x)
yunzuogailan_now_65 = yunzuogailan_now_65.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
result_df_here_65 = pd.concat([
    pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€', values=['å‡€èµ„äº§(äº¿)'], aggfunc='count'),
    pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€', values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)
], axis=1)
result_df_here_65.to_excel(writer, sheet_name='ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡')


# ==============================================================================
# ç¬¬åäºŒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æ‹›å•†äº§å“åˆ†æ
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†
# ------------------------------------------------------------------------------
print("\n[7] ç”ŸæˆæŠ¥è¡¨: æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†...")

zhaoshang_product_list = list(set(Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'].index))
zhaoshang_product_df = yunzuogailan_all.loc[zhaoshang_product_list]
zhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'] = zhaoshang_product_df['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)
zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] = zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'].map(
    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x
)
zhaoshangfinal = zhaoshang_product_df[
    (zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] * 100 - zhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'].map(
        lambda x: float(x[:-1]) if (x != "") & (not pd.isnull(x)) else -100
    )) < 0
]
zhaoshang_scale = Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸']['ä¿æœ‰è§„æ¨¡'] / 100000000
zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] = [zhaoshang_scale[ind] for ind in zhaoshangfinal.index]
zhaoshangfinal = zhaoshangfinal[zhaoshangfinal['è¿ä½œå¤©'] > 30]
zhaoshangfinal = zhaoshangfinal[zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] > 0.1]
zhaoshangfinal.sort_values('å‰©ä½™å¤©', ascending=True, inplace=True)
zhaoshangfinal.to_excel(writer, sheet_name='æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†')

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸è¾¾ä¸šç»©äº§å“æ¸…å•
# ------------------------------------------------------------------------------
print("[7.1] ç”ŸæˆæŠ¥è¡¨: å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸è¾¾ä¸šç»©äº§å“æ¸…å•...")

yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'] = yunzuogailan_all['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)
yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] = yunzuogailan_all['æœ¬æœŸå¹´åŒ–'].map(
    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x
)
yunzuogailan_all = yunzuogailan_all[
    (yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] * 100 - yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'].map(
        lambda x: float(x[:-1]) if (x != "") & (not pd.isnull(x)) else -100
    )) < 0
]
bdjz_100 = yunzuogailan_all[(yunzuogailan_all['å½¢æ€'].isin(['å°é—­', 'å®šå¼€'])) & (yunzuogailan_all['å‰©ä½™å¤©'] < 100)]
bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = (bdjz_100['æœ¬æœŸå¹´åŒ–'] - (bdjz_100['ä¸šç»©åŸºå‡†ä¸‹é™'].str[:-1]).astype(float) / 100) * 10000
bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'].astype(int)
bdjz_100 = bdjz_100[bdjz_100['æ¯åˆ†ç±»'] != 'å¤–å¸ä½æ³¢']
bdjz_100.to_excel(writer, sheet_name='å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸å¤§ä¸šç»©äº§å“æ¸…å•')


# ==============================================================================
# ç¬¬åä¸‰éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - èµ„äº§å¤§è¡¨
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨8: èµ„äº§å¤§è¡¨
# ------------------------------------------------------------------------------
print("\n[8] ç”ŸæˆæŠ¥è¡¨: 8.èµ„äº§å¤§è¡¨...")

date = zhoubao_date
date_lastw = lastw
date_lastm = lastm
date_lasty = lasty

yunzuogailan_all = pd.read_excel(Config.get_overview_history_file(date), index_col=0)
Chicang_df = data_loader.load_chicang_data(date)
Chicang_df = Chicang_df.merge(yunzuogailan_all['å¸ç§'], left_on='äº§å“ä»£ç ', right_index=True, how='left')

# ç¾å…ƒäº§å“è½¬æ¢æ±‡ç‡
EXchange_rate = market_data.get_exchange_rate('USDCNY', Config.EXCHANGE_RATE_DATE)
Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.apply(
    lambda x: x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] * EXchange_rate if x['å¸ç§'] == 'ç¾å…ƒ' else x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'],
    axis=1
)

# å¤„ç†ç‰¹æ®ŠåŸºé‡‘ç±»å‹
to_fill_indx = Chicang_df[Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] == 0].index
Chicang_df.loc[to_fill_indx, 'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.loc[to_fill_indx, 'æŒä»“æˆæœ¬(å…ƒ)'] + Chicang_df.loc[to_fill_indx, 'æŒæœ‰æœŸæ”¶ç›Š']
Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].fillna(0)

# åŠ è½½èµ„äº§åˆ†ç±»æ•°æ®
asset_classification_joint_df = data_loader.load_asset_classification()
insurance_pdct_df = data_loader.load_insurance_products()

# åŒ¹é…èµ„äº§å°ç±»å’Œå‹¾ç¨½å…³ç³»
Chicang_df = Chicang_df.merge(
    asset_classification_joint_df[['ç¼–å·', 'ä¸‰çº§åˆ†ç±»']], left_on='æ–°ç‰ˆèµ„äº§å°ç±»', right_index=True, how='left'
)

# æ ‡è®°ä¿é™©èµ„ç®¡èµ„äº§
mid_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å°ç±»'] == 'å§”å¤–ç°é‡‘ç®¡ç†æŠ•èµ„']
insurance_pdct_name_list = list(insurance_pdct_df.index) + ['è‹±å¤§èµ„äº§-èšé‘«22å·', 'å¤§å®¶èµ„ç®¡ç¨³å¥ç²¾é€‰15å·']
insurance_pdct_indx = mid_df[mid_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in insurance_pdct_name_list)].index
Chicang_df.loc[insurance_pdct_indx, 'ç¼–å·'] = '1.2'
Chicang_df.loc[insurance_pdct_indx, 'ä¸‰çº§åˆ†ç±»'] = '1.2 ä¿é™©åè®®å­˜æ¬¾'

# ç»†åŒ–åŸæŠ•å’Œæ°¸ç»­å€ºåˆ†ç±»
bond_set_df = pd.DataFrame(list(set(Chicang_df[Chicang_df['ç¼–å·'] == '3.4-3.5']['å¤–éƒ¨ä»£ç '])), columns=['å¤–éƒ¨ä»£ç '])
bond_code_list = list(bond_set_df['å¤–éƒ¨ä»£ç '].values)
wind_result = market_data.get_bond_attributes(bond_code_list)
bond_set_df[['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­']] = wind_result.values

to_merge_df = pd.DataFrame([
    ['æ˜¯', 'å¦', '3.4.1 éæ°¸ç»­åŸæŠ•å€º'], ['æ˜¯', 'æ˜¯', '3.4.2 æ°¸ç»­åŸæŠ•å€º'],
    ['å¦', 'å¦', '3.5.1 éæ°¸ç»­äº§ä¸šå€º'], ['å¦', 'æ˜¯', '3.5.2 æ°¸ç»­äº§ä¸šå€º']
], columns=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­', 'ä¸‰çº§åˆ†ç±»'])
bond_set_df = bond_set_df.merge(to_merge_df, left_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], right_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], how='left')

Chicang_df['ä¸‰çº§åˆ†ç±»-new'] = Chicang_df.apply(
    lambda x: bond_set_df.set_index('å¤–éƒ¨ä»£ç ').loc[x['å¤–éƒ¨ä»£ç '], 'ä¸‰çº§åˆ†ç±»'] if x['ç¼–å·'] == '3.4-3.5' else x['ä¸‰çº§åˆ†ç±»'],
    axis=1
)

# åŒ¹é…å¤šèµ„äº§å“ç±»
yunzuogailan_now = pd.read_excel(Config.get_overview_parent_file(date), index_col=0)
Chicang_df2 = Chicang_df.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»', 'äº§å“ç»ç†']], left_on='äº§å“ä»£ç ', right_index=True, how='left')
Chicang_df2 = Chicang_df2[Chicang_df2.apply(lambda x: not pd.isnull(x['äº§å“ç»ç†']), axis=1)]
Chicang_df2 = del_Innovation_department(Chicang_df2)
Chicang_df2 = Chicang_df2.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')

result_df_8_initial = pd.pivot_table(
    Chicang_df2, index=['ä¸‰çº§åˆ†ç±»-new'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],
    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum
) / 100000000

# ç»†åŒ–å§”å¤–å€ºåˆ¸æŠ•èµ„å­é¡¹
Outsourced_bond_asset_df = Chicang_df2[Chicang_df2['ä¸‰çº§åˆ†ç±»'] == '7.2 å§”å¤–å€ºåˆ¸æŠ•èµ„']
public_account_tag_df = data_loader.load_public_account_tag()
Outsourced_bond_asset_df_new = Outsourced_bond_asset_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')

Outsourced_bond_tag = {
    'æ”¶ç›˜ä»·æ³•': '7.2.1 æ”¶ç›˜ä»·ä¸“æˆ·', 'åˆ©ç‡å€ºæ”¶ç›˜ä»·': '7.2.2 åˆ©ç‡å€ºæ”¶ç›˜ä»·ä¸“æˆ·',
    'æ¨¡å‹æ³•': '7.2.3 æ¨¡å‹æ³•ä¸“æˆ·', 'å¯è½¬å€º': '7.2.4 å¯è½¬å€ºä¸“æˆ·',
    'æ’å®šä¹…æœŸ': '7.2.5 æ’å®šä¹…æœŸä¸“æˆ·', 'å›ºæ”¶+å§”å¤–': '7.2.6 å›ºæ”¶+å§”å¤–ä¸“æˆ·',
    'Wä¸“æˆ·': '7.2.7 Wä¸“æˆ·', 'ç»¿è‰²å€º': '7.2.8 ç»¿è‰²å€ºä¸“æˆ·', 'å¤–å¸ä¸“æˆ·': '7.2.9 å¤–å¸ä¸“æˆ·',
}
Outsourced_bond_asset_df_new['å››çº§åˆ†ç±»'] = Outsourced_bond_asset_df_new['æ ‡ç­¾'].map(
    lambda x: Outsourced_bond_tag[x] if x in Outsourced_bond_tag.keys() else '7.2.10 å…¶ä»–'
)
Outsourced_bond_asset_result = pd.pivot_table(
    Outsourced_bond_asset_df_new, index=['å››çº§åˆ†ç±»'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],
    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum
) / 100000000

result_df_8 = pd.concat([result_df_8_initial.rename_axis(''), Outsourced_bond_asset_result.rename_axis('')])
result_df_8.to_excel(Config.get_asset_table_file(date))

# è®¡ç®—åŒæ¯”ç¯æ¯”å˜åŒ–
result_df_lastw = pd.read_excel(Config.get_asset_table_file(date_lastw), index_col=0, header=[0, 1, 2])
result_df_lastm = pd.read_excel(Config.get_asset_table_file(lastm), index_col=0, header=[0, 1, 2])
result_df_lasty = pd.read_excel(Config.get_asset_table_file(lasty), index_col=0, header=[0, 1, 2])

result_df_8_final = pd.concat([
    result_df_8, result_df_8.sum(axis=1) - result_df_lastw.sum(axis=1),
    result_df_8.sum(axis=1) - result_df_lastm.sum(axis=1),
    result_df_8.sum(axis=1) - result_df_lasty.sum(axis=1)
], axis=1)

# è¡¥å……æœ¬å¸çš„ç›¸æ¯”å˜åŒ–
foreign_currency_products_cols = [
    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),
    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼')
]
all_columns_8 = list(result_df_8.columns)
domestic_columns_8 = [col for col in all_columns_8 if col not in foreign_currency_products_cols]
all_columns_lastw = list(result_df_lastw.columns)
domestic_columns_lastw = [col for col in all_columns_lastw if col not in foreign_currency_products_cols]
all_columns_lastm = list(result_df_lastm.columns)
domestic_columns_lastm = [col for col in all_columns_lastm if col not in foreign_currency_products_cols]
all_columns_lasty = list(result_df_lasty.columns)
domestic_columns_lasty = [col for col in all_columns_lasty if col not in foreign_currency_products_cols]

result_df_8_domestic_currency = result_df_8[domestic_columns_8].sum(axis=1)
result_df_lastw_domestic_currency = result_df_lastw[domestic_columns_lastw].sum(axis=1)
result_df_lastm_domestic_currency = result_df_lastm[domestic_columns_lastm].sum(axis=1)
result_df_lasty_domestic_currency = result_df_lasty[domestic_columns_lasty].sum(axis=1)

result_df_8_final = pd.concat([
    result_df_8_final,
    result_df_8_domestic_currency - result_df_lastw_domestic_currency,
    result_df_8_domestic_currency - result_df_lastm_domestic_currency,
    result_df_8_domestic_currency - result_df_lasty_domestic_currency
], axis=1)

result_df_8_final.columns = pd.MultiIndex.from_tuples(
    tuple(result_df_8.columns) + (
        ("", "", 'ç›¸æ¯”ä¸Šå‘¨'), ("", "", 'ç›¸æ¯”ä¸Šæœˆ'), ("", "", 'ç›¸æ¯”ä¸Šå¹´'),
        ("", "", 'ç›¸æ¯”ä¸Šå‘¨-ä¸å«å¤–å¸äº§å“'), ("", "", 'ç›¸æ¯”ä¸Šæœˆ-ä¸å«å¤–å¸äº§å“'), ("", "", 'ç›¸æ¯”ä¸Šå¹´-ä¸å«å¤–å¸äº§å“')
    )
)
result_df_8_final.to_excel(writer, sheet_name='8.èµ„äº§å¤§è¡¨')


# ==============================================================================
# ç¬¬åå››éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - ä¸­æ”¶ç›‘æ§
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨9: ä¸­æ”¶ç›‘æ§
# ------------------------------------------------------------------------------
print("\n[9] ç”ŸæˆæŠ¥è¡¨: 9.ä¸­æ”¶ç›‘æ§...")

date = zhoubao_date
zhongshou_m, zhongshou_y = data_loader.load_zhongshou_data(date)


def zhongshou_df_processing_v2(df_here, period_here: str):
    """å¤„ç†ä¸­æ”¶æ•°æ®"""
    fixed_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'æŠ•èµ„å›¢é˜Ÿ', 'å›¢é˜Ÿåˆ’åˆ†', 'äº§å“çº¿']
    df_here.columns = fixed_cols + list(df_here.columns[5:])
    df_here = df_here[df_here['å›¢é˜Ÿåˆ’åˆ†'] == '5.å¤šèµ„äº§æŠ•èµ„éƒ¨']
    df_here.columns = [''.join(x.split('\n')) for x in df_here.columns]
    zhongshou_cols = ['é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']
    df_here = df_here[fixed_cols + zhongshou_cols]
    df_here = df_here[df_here['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰'].map(lambda x: x > 0.00001)]
    df_here = df_here.merge(classification_df[['å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True, how='left')
    df_here = del_Innovation_department(df_here)
    df_here = df_here.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
    mid_result = df_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).sum()[
        ['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']
    ]
    mid_cols = [period_here + x for x in ['ä¸­æ”¶', 'é”€å”®ç®¡ç†è´¹', 'æŠ•èµ„ç®¡ç†è´¹(å«è¶…é¢)', 'è¶…é¢ç®¡ç†è´¹', 'å‰ç«¯æ”¶è´¹']]
    mid_result.columns = mid_cols
    return mid_result


result_9 = pd.concat([
    zhongshou_df_processing_v2(zhongshou_m, '-'.join([date[:4], date[4:6]])),
    zhongshou_df_processing_v2(zhongshou_y, date[:4])
], axis=1)
result_9 = rank_by_sort(result_9, rank_here)
result_9.to_excel(writer, sheet_name='9.ä¸­æ”¶ç›‘æ§')


# ==============================================================================
# ç¬¬åäº”éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“åˆ°æœŸ
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨10: äº§å“åˆ°æœŸæƒ…å†µ
# ------------------------------------------------------------------------------
print("\n[10] ç”ŸæˆæŠ¥è¡¨: 10.äº§å“åˆ°æœŸæƒ…å†µ...")

date = zhoubao_date
yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(date), index_col=0))
yunzuogailan_now['åˆ°æœŸæœˆä»½'] = yunzuogailan_now['åˆ°æœŸæ—¥'].map(lambda x: x[:-3])
yunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
yunzuogailan_here = yunzuogailan_here[yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w]

yunzuogailan_here_fengbi = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å°é—­']
yunzuogailan_here_dingkai = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å®šå¼€']
output_sheetname = ['10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ', '10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ-å®šå¼€']

k = 0
for yunzuogailan_here_to_cal in [yunzuogailan_here_fengbi, yunzuogailan_here_dingkai]:
    result_df_10 = pd.pivot_table(
        yunzuogailan_here_to_cal, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='åˆ°æœŸæœˆä»½',
        values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum
    )
    result_df_10 = rank_by_sort(full_category_or_not(result_df_10, rank_here), rank_here).T
    result_df_10.index = result_df_10.loc['å‡€èµ„äº§(äº¿)'].index
    result_df_10[[float(x[:4]) < 2029 for x in result_df_10.index]].to_excel(writer, sheet_name=output_sheetname[k])
    k += 1

keep_cols = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'æ¯åˆ†ç±»', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']
result_df_10_2 = yunzuogailan_here[
    (yunzuogailan_here['åˆ°æœŸæ—¥'] <= closing_date_next_w) & (yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w)
][keep_cols]
result_df_10_2.sort_values(by='åˆ°æœŸæ—¥', ascending=True, inplace=True)
result_df_10_2.to_excel(writer, sheet_name='10.ä¸‹å‘¨åˆ°æœŸäº§å“æ¸…å•')

print('   ä¸‹å‘¨åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2['å‡€èµ„äº§(äº¿)'].sum()))
print('   å°é—­åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum()))
print('   å®šå¼€åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()))


# ==============================================================================
# ç¬¬åå…­éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æŒä»“åˆ†æ
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨11: æŒä»“æ˜ç»†
# ------------------------------------------------------------------------------
print("\n[11] ç”ŸæˆæŠ¥è¡¨: 11.æŒä»“æ˜ç»†...")

date = zhoubao_date
Chicang_df = data_loader.load_chicang_data(date)
Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()

# 11.1 å…´åˆäº§å“æŒä»“æ˜ç»†
print("[11.1] ç”ŸæˆæŠ¥è¡¨: 11.å…´åˆäº§å“æŒä»“æ˜ç»†...")
xinghe_list = Config.XINGHE_PRODUCTS
concat_xinghe_series = []
for i in range(len(xinghe_list)):
    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'
    concat_xinghe_series.append(pd.Series(
        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
        name=xinghe_list[i] + '-é‡‘é¢'
    ))

concat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)
concat_xinghe_df = concat_xinghe_df.merge(
    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
    left_index=True, right_index=True, how='left'
)
concat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)
concat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]
result_df_11_1 = pd.concat([
    concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
    concat_xinghe_pct_df
], axis=1)
result_df_11_1.to_excel(writer, sheet_name='11.å…´åˆäº§å“æŒä»“æ˜ç»†')

# 11.1.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†
print("[11.1.1] ç”ŸæˆæŠ¥è¡¨: 11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†...")
concat_zhuanzhai_series = []
zhuanzhai_dict = Config.CONVERTIBLE_BOND_ACCOUNTS
zhuanzhai_list = []
for shortname in zhuanzhai_dict.keys():
    concat_zhuanzhai_series.append(pd.Series(
        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
        name=shortname + '-é‡‘é¢'
    ))
    zhuanzhai_list += [shortname]

ETF_bond_list = Config.CONVERTIBLE_BOND_ETF
concat_zhuanzhai_series.append(pd.Series(
    Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
    name='å¯è½¬å€ºETF-é‡‘é¢'
))
zhuanzhai_list += ['å¯è½¬å€ºETF']

concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)
concat_zhuanzhai_df = concat_zhuanzhai_df.merge(
    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
    left_index=True, right_index=True, how='left'
)
concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(
    concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0
)
concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]
result_df_11_1_1 = pd.concat([
    concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
    concat_zhuanzhai_pct_df
], axis=1)
result_df_11_1_1.to_excel(writer, sheet_name='11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†')

# 11.2 é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†
print("[11.2] ç”ŸæˆæŠ¥è¡¨: 11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†...")
public_account_tag_df = data_loader.load_public_account_tag()
Weiwai_df_full = Weiwai_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')
Weiwai_df_full = Weiwai_df_full.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»']], left_on='äº§å“ä»£ç ', right_index=True, how='left')
Weiwai_df_full = Weiwai_df_full.merge(Parent_sort[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')

concat_quant_series = []
quant_list = Config.QUANT_STRATEGY_LABELS
concat_quant_series.append(pd.Series(
    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–ä¸­æ€§'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
    name='é‡åŒ–ä¸­æ€§'
))
concat_quant_series.append(pd.Series(
    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–æŒ‡å¢'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
    name='é‡åŒ–æŒ‡å¢'
))
concat_quant_series.append(pd.Series(
    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–CTA'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
    name='é‡åŒ–CTA'
))
concat_quant_series.append(pd.Series(
    Weiwai_df_full[Weiwai_df_full['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-å…´åˆ4å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
    name='å…´åˆ4å·'
))
concat_quant_df = pd.concat(concat_quant_series, axis=1)
concat_quant_df = concat_quant_df.merge(
    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)']],
    left_index=True, right_index=True, how='left'
)
concat_quant_pct_df = concat_quant_df[quant_list].div(concat_quant_df['å‡€èµ„äº§(äº¿)'], axis=0)
concat_quant_pct_df.columns = [x + '-å æ¯”' for x in quant_list]
result_df_11_3 = pd.concat([concat_quant_df[quant_list + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†']], concat_quant_pct_df], axis=1)
result_df_11_3.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)
result_df_11_3.to_excel(writer, sheet_name='11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†')

# 11.2.1-11.2.3 å§”å¤–ä¸“æˆ·é…ç½®æƒ…å†µ
print("[11.2.1-11.2.3] ç”ŸæˆæŠ¥è¡¨: å§”å¤–ä¸“æˆ·é…ç½®æƒ…å†µ...")
result_df_11_2_amt = pd.pivot_table(
    Weiwai_df_full, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ ‡ç­¾',
    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum
) / 100000000
yunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
result_df_11_2_pct_2 = result_df_11_2_amt.div(yunzuogailan_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'])['å‡€èµ„äº§(äº¿)'].sum(), axis=0)

Weiwai_df_simplify = pd.pivot_table(
    Weiwai_df_full, index=['äº§å“ä»£ç '], columns='æ ‡ç­¾',
    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum
) / 100000000
Weiwai_df_simplify.columns = Weiwai_df_simplify['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].columns
Weiwai_df_simplify = Weiwai_df_simplify.merge(yunzuogailan_here[['å‡€èµ„äº§(äº¿)']], left_index=True, right_index=True, how='left')
result_df_11_2_pct = Weiwai_df_simplify.div(Weiwai_df_simplify['å‡€èµ„äº§(äº¿)'], axis=0).merge(
    yunzuogailan_here[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_index=True, right_index=True, how='left'
)
result_df_11_2_pct = result_df_11_2_pct.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()

rank_by_sort(full_category_or_not(result_df_11_2_amt, rank_here), rank_here).to_excel(
    writer, sheet_name='11.2.1å…¶ä»–å§”å¤–ä¸“æˆ·é‡‘é¢é…ç½®æƒ…å†µ'
)
rank_by_sort(full_category_or_not(result_df_11_2_pct, rank_here), rank_here).to_excel(
    writer, sheet_name='11.2.2å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ'
)
rank_by_sort(full_category_or_not(result_df_11_2_pct_2, rank_here), rank_here).to_excel(
    writer, sheet_name='11.2.3å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ-é™¤ä»¥ç³»åˆ—è§„æ¨¡'
)

# 11.4 å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†
print("[11.4] ç”ŸæˆæŠ¥è¡¨: 11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†...")
xinghe_list = Config.XINGHE_PRODUCTS_2
concat_xinghe_series = []
for i in range(len(xinghe_list)):
    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'
    concat_xinghe_series.append(pd.Series(
        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
        name=xinghe_list[i] + '-é‡‘é¢'
    ))
concat_xinghe_series.append(pd.Series(
    Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-è´¢æ™ºäººç”ŸçµåŠ¨1å·å•ä¸€èµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
    name='çµåŠ¨1å·-é‡‘é¢'
))
xinghe_list = xinghe_list + ['çµåŠ¨1å·']

concat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)
concat_xinghe_df = concat_xinghe_df.merge(
    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
    left_index=True, right_index=True, how='left'
)
concat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)
concat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]
result_df_11_4 = pd.concat([
    concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
    concat_xinghe_pct_df
], axis=1)
result_df_11_4.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)
result_df_11_4.to_excel(writer, sheet_name='11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†')

# 11.5 å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”
print("[11.5] ç”ŸæˆæŠ¥è¡¨: 11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”...")
Zhuanhu_label_df = data_loader.load_public_account_tag()
derivative_zhuanhu_list = list(Zhuanhu_label_df[Zhuanhu_label_df['æ ‡ç­¾'] == 'è¡ç”Ÿå“ä¸“æˆ·'].index)
derivative_zhuanhu_df = Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in derivative_zhuanhu_list)]
derivative_zhuanhu_df = pd.pivot_table(
    derivative_zhuanhu_df, index=['äº§å“ä»£ç '], columns='å€ºåˆ¸ç®€ç§°',
    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum
)
derivative_zhuanhu_df.columns = [x[1][5:-8] for x in derivative_zhuanhu_df.columns]
derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'] = derivative_zhuanhu_df.sum(axis=1)
derivative_zhuanhu_df = derivative_zhuanhu_df.merge(
    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
    left_index=True, right_index=True, how='left'
)
derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ¯”ä¾‹'] = derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'].div(
    derivative_zhuanhu_df['å‡€èµ„äº§(äº¿)'], axis=0
) / 100000000
derivative_zhuanhu_df.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)
derivative_zhuanhu_df.to_excel(writer, sheet_name='11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”')

# 11.6 éæ ‡æŒä»“å æ¯”
print("[11.6] ç”ŸæˆæŠ¥è¡¨: 11.6éæ ‡æŒä»“å æ¯”...")
feibiao_df = Chicang_df[Chicang_df.apply(
    lambda x: (x['æ–°ç‰ˆèµ„äº§å¤§ç±»'] in ['éæ ‡å‡†åŒ–å€ºæƒç±»èµ„äº§', 'ç†è´¢ç›´æ¥èèµ„å·¥å…·', 'æ–°å¢å¯æŠ•èµ„èµ„äº§']) or
              (x['æ–°ç‰ˆèµ„äº§å°ç±»'] in ['åŒä¸šå€Ÿæ¬¾']), axis=1
)]
feibiao_pct_df = pd.DataFrame(feibiao_df.groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum())
feibiao_pct_df = feibiao_pct_df.merge(
    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
    left_index=True, right_index=True, how='left'
)
feibiao_pct_df['éæ ‡å æ¯”'] = feibiao_pct_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] / feibiao_pct_df['å‡€èµ„äº§(äº¿)'] / 100000000
feibiao_pct_df.to_excel(writer, sheet_name='11.6éæ ‡æŒä»“å æ¯”')

# é»„é‡‘æŒä»“
print("[11.7] ç”ŸæˆæŠ¥è¡¨: é»„é‡‘æŒä»“...")
gold_dict = Config.GOLD_ACCOUNTS
gold_ETF_bond_list = Config.GOLD_ETF


def get_zhdata(zhuanzhai_dict, ETF_bond_list):
    """è·å–é»„é‡‘æŒä»“æ•°æ®"""
    concat_zhuanzhai_series = []
    zhuanzhai_list = []
    for shortname in zhuanzhai_dict.keys():
        concat_zhuanzhai_series.append(pd.Series(
            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
            name=shortname + '-é‡‘é¢'
        ))
        zhuanzhai_list += [shortname]
    concat_zhuanzhai_series.append(pd.Series(
        Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
        name='é»„é‡‘ETF-é‡‘é¢'
    ))
    zhuanzhai_list += ['é»„é‡‘ETF']
    concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)
    concat_zhuanzhai_df = concat_zhuanzhai_df.merge(
        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
        left_index=True, right_index=True, how='left'
    )
    concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(
        concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0
    )
    concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]
    result_df_11_1_1 = pd.concat([
        concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
        concat_zhuanzhai_pct_df
    ], axis=1)
    return result_df_11_1_1


hg_asset = get_zhdata(gold_dict, gold_ETF_bond_list)
hg_asset[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-é‡‘é¢', 'é»„é‡‘ETF-é‡‘é¢',
          'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-å æ¯”', 'é»„é‡‘ETF-å æ¯”']].to_excel(writer, sheet_name='é»„é‡‘æŒä»“')

# æƒç›Šä¸“æˆ·æŒä»“
print("[11.8] ç”ŸæˆæŠ¥è¡¨: æƒç›Šä¸“æˆ·æŒä»“...")
equity_dict = Config.EQUITY_ACCOUNTS


def get_equity_data(equity_dict):
    """è·å–æƒç›Šä¸“æˆ·æŒä»“æ•°æ®"""
    concat_equity_series = []
    equity_list = []
    for shortname in equity_dict.keys():
        concat_equity_series.append(pd.Series(
            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == equity_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
            name=shortname + '-é‡‘é¢'
        ))
        equity_list += [shortname]
    concat_equity_df = pd.concat(concat_equity_series, axis=1)
    concat_equity_df = concat_equity_df.merge(
        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
        left_index=True, right_index=True, how='left'
    )
    concat_equity_pct_df = concat_equity_df[[x + '-é‡‘é¢' for x in equity_list]].div(
        concat_equity_df['å‡€èµ„äº§(äº¿)'], axis=0
    )
    concat_equity_pct_df.columns = [x + '-å æ¯”' for x in equity_list]
    result_df = pd.concat([
        concat_equity_df[[x + '-é‡‘é¢' for x in equity_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
        concat_equity_pct_df
    ], axis=1)
    return result_df


equity_asset = get_equity_data(equity_dict)
output_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»'] + \
              [x + suffix for x in equity_dict.keys() for suffix in ['-é‡‘é¢', '-å æ¯”']]
equity_asset[output_cols].to_excel(writer, sheet_name='æƒç›Šä¸“æˆ·æŒä»“')

# å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ
print("[11.9] ç”ŸæˆæŠ¥è¡¨: å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ...")
ggcc = data_loader.load_public_strategy()
wwgl = data_loader.load_weiwai_overview()
chicangsum = Chicang_df.groupby('å€ºåˆ¸ç®€ç§°')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000
ggcc = pd.merge(ggcc, wwgl, left_on='èµ„äº§åç§°', right_on='å§”å¤–èµ„äº§', how='left')
ggcc = pd.merge(ggcc, chicangsum, left_on='èµ„äº§åç§°', right_index=True, how='left')
ggcc = ggcc.rename(columns={'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼': 'å¤šèµ„äº§æŠ•æŒä»“-äº¿', "æœ€æ–°è§„æ¨¡": 'ä¸“æˆ·è§„æ¨¡'})
ggcc['å¤šèµ„äº§æŒä»“å æ¯”'] = ggcc['å¤šèµ„äº§æŠ•æŒä»“-äº¿'] / ggcc['ä¸“æˆ·è§„æ¨¡']
ggcc[['æ‰€å±éƒ¨é—¨', 'ç­–ç•¥æ ‡ç­¾', 'èµ„äº§ä»£ç ', 'èµ„äº§åç§°', 'èµ„äº§ç®€ç§°', 'ä¸“æˆ·è§„æ¨¡',
      'å¤šèµ„äº§æŠ•æŒä»“-äº¿', 'å¤šèµ„äº§æŒä»“å æ¯”']].to_excel(writer, sheet_name='å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ')


# ==============================================================================
# ç¬¬åä¸ƒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å‡€å€¼æ³¢åŠ¨ä¸ç ´å‡€
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨12: å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•
# ------------------------------------------------------------------------------
print("\n[12] ç”ŸæˆæŠ¥è¡¨: 12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•...")

date = zhoubao_date
yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(date), index_col=0))
part_nav_df = data_transposition.loc[:, yunzuogailan_now.index].tail(7 + 1)
rweek = pd.DataFrame(
    (part_nav_df.tail(1).values / part_nav_df.head(1).values - 1) * 10000,
    columns=part_nav_df.columns, index=['å‘¨å‡€å€¼å˜åŒ–bp']
).T
rweek_average = ((part_nav_df / part_nav_df.shift(1) - 1) * 10000).mean(axis=0)
nav_change_df = pd.concat([rweek, rweek_average], axis=1)
nav_change_df.columns = ['å‘¨å‡€å€¼å˜åŒ–bp', 'å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']
nav_change_df_keep = nav_change_df[
    (abs(nav_change_df['å‘¨å‡€å€¼å˜åŒ–bp']) >= 20) | (abs(nav_change_df['å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']) >= 3)
]

result_df_12 = nav_change_df_keep.merge(
    yunzuogailan_now[['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',
                      'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©',
                      'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']],
    left_index=True, right_index=True, how='left'
)
result_df_12.sort_values('å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp', ascending=True, inplace=True)
result_df_12.to_excel(writer, sheet_name='12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•')


# ==============================================================================
# ç¬¬åå…«éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å‘¨æœŸåˆ†å¸ƒ
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨13: ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡
# ------------------------------------------------------------------------------
print("\n[13] ç”ŸæˆæŠ¥è¡¨: 13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡...")

now = zhoubao_date
yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))
yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))
yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))


def get_zhouqi_scale_df(df_f, name: str):
    mid_df = df_f.copy()
    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)
    result_df = pd.concat([
        mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].sum(),
        mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].count()
    ], axis=1)
    result_df.columns = [name + x for x in ['è§„æ¨¡(äº¿)', 'æ•°é‡']]
    return result_df


final_df = pd.concat([get_zhouqi_scale_df(yunzuogailan_lasty, '2024'), get_zhouqi_scale_df(yunzuogailan_now, 'æœ€æ–°')], axis=1)
final_df['vlookupæ ‡ç­¾'] = [''.join(list(x)) for x in final_df.index]
keep_columns = ['vlookupæ ‡ç­¾'] + list(final_df.columns[:-1])
final_df[keep_columns].to_excel(writer, sheet_name='13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡')

# ------------------------------------------------------------------------------
# æŠ¥è¡¨14: ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª
# ------------------------------------------------------------------------------
print("\n[14] ç”ŸæˆæŠ¥è¡¨: 14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª...")

now = zhoubao_date
month7 = '20240731'
lasty = '20241231'

yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))
yunzuogailan_month7 = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(month7), index_col=0))
yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))


def match_kehuzhouqi_narrowed(x: str):
    if x == 'å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“':
        return 'å®¢æˆ·å‘¨æœŸ'
    elif x == 'å®¢æˆ·é”å®šæœŸ':
        return 'æœ€çŸ­æŒæœ‰æœŸ'
    else:
        return ''


def get_kehuzhouqi_narrowed_scale(my_df, col_str: str):
    mid_df = my_df[my_df['äº§å“æ¨¡æ¿ä¸­æ–‡åç§°'].map(lambda x: x in ['å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“', 'å®¢æˆ·é”å®šæœŸ'])]
    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)
    result_df = pd.pivot_table(mid_df, index=['å‘¨æœŸåŒºé—´'], columns='äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)
    result_df.columns = [col_str + match_kehuzhouqi_narrowed(x[1]) for x in list(result_df.columns)]
    return result_df


result_df_14 = pd.concat([
    get_kehuzhouqi_narrowed_scale(yunzuogailan_lasty, '2024å¹´åº•'),
    get_kehuzhouqi_narrowed_scale(yunzuogailan_month7, '2024å¹´7æœˆ'),
    get_kehuzhouqi_narrowed_scale(yunzuogailan_now, 'æœ€æ–°')
], axis=1)
result_df_14.to_excel(writer, sheet_name='14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª')


# ==============================================================================
# ç¬¬åä¹éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å¸‚åœºæŒ‡æ•°æ”¶ç›Š
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨15: å¸‚åœºæŒ‡æ•°æ”¶ç›Š
# ------------------------------------------------------------------------------
print("\n[15] ç”ŸæˆæŠ¥è¡¨: 15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š...")

wind_code_list = Config.MARKET_INDEX_CODES
result_list = []

for deltadays in [30, 30 * 3, 30 * 6, 365]:
    startDate = ''.join(str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=deltadays)).date()).split('-'))
    returns = market_data.get_index_returns(wind_code_list, startDate, zhoubao_date)
    result_list.append(np.array(returns) * 365 / deltadays)

# è®¡ç®—ä»Šå¹´ä»¥æ¥å¹´åŒ–æ”¶ç›Š
deltadays = (datetime.strptime(zhoubao_date, '%Y%m%d') - datetime.strptime('20251231', '%Y%m%d')).days
returns = market_data.get_index_returns(wind_code_list, '20251231', zhoubao_date)
result_list.append(np.array(returns) * 365 / deltadays)

# è®¡ç®—è¿‘1æœˆæ³¢åŠ¨ç‡
start_1m = ''.join(str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=30)).date()).split('-'))
vol_1m = market_data.get_index_volatility(wind_code_list, start_1m, zhoubao_date)
result_list.append(np.array(vol_1m) if vol_1m else np.array([None] * len(wind_code_list)))

# è®¡ç®—ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡
vol_ytd = market_data.get_index_volatility(wind_code_list, '20251231', zhoubao_date)
result_list.append(np.array(vol_ytd) if vol_ytd else np.array([None] * len(wind_code_list)))

result_list.append(np.array(market_data.get_index_names(wind_code_list)))
result_df = pd.DataFrame(result_list).T
result_df.index = wind_code_list
result_df.columns = [
    'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', '2026å¹´å¹´åŒ–æ”¶ç›Šç‡',
    'è¿‘1æœˆæ³¢åŠ¨ç‡', 'ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡', 'æŒ‡æ•°ç®€ç§°'
]
result_df.to_excel(writer, sheet_name='15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š')


# ==============================================================================
# ç¬¬äºŒåéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - ç ´å‡€ç»“æœ
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: ç ´å‡€ç»“æœ
# ------------------------------------------------------------------------------
print("\n[16] ç”ŸæˆæŠ¥è¡¨: ç ´å‡€ç»“æœ...")

nav_date = yunzuogailan_date
yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(yunzuogailan_date), index_col=0))
yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] = [data_transposition.loc[nav_date, x] for x in yunzuogailan_now.index]
yunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] = [
    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(7), x] for x in yunzuogailan_now.index
]
yunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] = [
    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(int(nav_date[-2:])), x] for x in yunzuogailan_now.index
]
pojing_df = yunzuogailan_now[yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] < 1].copy()

pojing_df['è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] - 1
pojing_df['è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] - 1
pojing_df['æ£€æµ‹æ—¶ç‚¹'] = nav_date
pojing_df['äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰'] = pojing_df['å‡€èµ„äº§(äº¿)'] / pojing_df['å•ä½å‡€å€¼']
pojing_df = pojing_df.reset_index()
pojing_df_final = pojing_df[
    ['æ£€æµ‹æ—¶ç‚¹', 'äº§å“ç®€ç§°', 'äº§å“ä»£ç ', 'äº§å“ç»ç†', 'äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰', 'åˆ°æœŸæ—¥', 'ç´¯ç§¯å‡€å€¼', 'è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–', 'è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–']
]
quant = ['ç‹æµ©', 'å¼ é›…å©•', 'å­™æ–°å']


def manager_in_or_not_count(s: str, y: list):
    sum_here = 0
    for mid_y in y:
        if mid_y in s:
            sum_here += 1
    return 1 if sum_here > 0 else 0


pojing_df_final = pojing_df_final[pojing_df_final['äº§å“ç»ç†'].map(lambda x: manager_in_or_not_count(x, quant)) == 0]
pojing_df_final.to_excel(writer, sheet_name='ç ´å‡€ç»“æœ')


# ==============================================================================
# ç¬¬äºŒåä¸€éƒ¨åˆ†ï¼šç”Ÿæˆæ€»ç»“æ–‡å­—
# ==============================================================================

# ------------------------------------------------------------------------------
# æŠ¥è¡¨: æ€»ç»“æ–‡å­—ï¼ˆAIç”Ÿæˆï¼‰
# ------------------------------------------------------------------------------
print("\n[17] ç”ŸæˆæŠ¥è¡¨: æ€»ç»“æ–‡å­—ï¼ˆAIç”Ÿæˆï¼‰...")

# ä½¿ç”¨configä¸­çš„promptæ¨¡æ¿ç”Ÿæˆæ€»ç»“æ–‡å­—
prompt_zs = Config.PROMPT_ZHONGSHOU.format(
    date=yunzuogailan_date,
    data=round(result_9.sum(axis=0), 2)
)

prompt_gm = Config.PROMPT_GUIMO.format(
    date=yunzuogailan_date,
    channel_data=round(Channel_result1.sum(axis=0), 0),
    series_data=round(result_3.astype(float).sum(axis=0), 0)
)

daoqi_summary = Config.PROMPT_DAOQI.format(
    total=result_df_10_2['å‡€èµ„äº§(äº¿)'].sum(),
    fengbi=result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum(),
    dingkai=result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()
)

guimo_summary = get_wenzi_result(prompt_gm)
zhongshou_summary = get_wenzi_result(prompt_zs)

wenzi = {'åˆ°æœŸæ–‡å­—': daoqi_summary, 'ä¸­æ”¶æ–‡å­—': zhongshou_summary, 'è§„æ¨¡æ–‡å­—': guimo_summary}
wenzidf = pd.DataFrame([wenzi]).T.rename(columns={0: 'æ–‡å­—'})
wenzidf.to_excel(writer, sheet_name='æ€»ç»“æ–‡å­—')


# ==============================================================================
# ç¬¬äºŒåäºŒéƒ¨åˆ†ï¼šä¿å­˜å¹¶å…³é—­
# ==============================================================================

writer.close()

print("\n" + "=" * 60)
print("âœ… å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆå®Œæˆï¼")
print(f"   è¾“å‡ºæ–‡ä»¶: {Config.get_current_output_writer(date)}")
print("=" * 60)
