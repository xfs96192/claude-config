/* ============================================
   ä¸»åº”ç”¨é€»è¾‘
   ============================================ */

class App {
    constructor() {
        this.currentNotebookId = null;
        this.currentSectionId = null;
        this.currentPageId = null;
        this.notebooks = [];
        this.sections = [];
        this.pages = [];
    }

    // åˆå§‹åŒ–åº”ç”¨
    async init() {
        try {
            // åˆå§‹åŒ–æ•°æ®åº“
            await db.init();
            console.log('Database initialized');

            // åˆå§‹åŒ–é»˜è®¤æ•°æ®
            await db.initializeDefaultData();

            // åˆå§‹åŒ–ç¼–è¾‘å™¨
            editor.init();
            console.log('Editor initialized');

            // åŠ è½½æ•°æ®
            await this.loadNotebooks();

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            this.setupEventListeners();

            // æ¢å¤ä¸Šæ¬¡çš„çŠ¶æ€
            this.restoreState();

            console.log('Application initialized successfully');
            showNotification('æ¬¢è¿ä½¿ç”¨æŠ•èµ„ç»ç†è®°äº‹æœ¬', 'success');

        } catch (error) {
            console.error('Initialization error:', error);
            alert('åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        }
    }

    // åŠ è½½ç¬”è®°æœ¬
    async loadNotebooks() {
        try {
            this.notebooks = await db.getNotebooks();
            this.renderNotebooks();
        } catch (error) {
            console.error('Error loading notebooks:', error);
            showNotification('åŠ è½½ç¬”è®°æœ¬å¤±è´¥', 'error');
        }
    }

    // æ¸²æŸ“ç¬”è®°æœ¬æ ‘å½¢ç»“æ„
    renderNotebooks() {
        const container = document.getElementById('notebook-tree');
        container.innerHTML = '';

        this.notebooks.forEach(notebook => {
            const notebookEl = this.createNotebookElement(notebook);
            container.appendChild(notebookEl);
        });
    }

    // åˆ›å»ºç¬”è®°æœ¬å…ƒç´ 
    createNotebookElement(notebook) {
        const wrapper = document.createElement('div');

        // ç¬”è®°æœ¬é¡¹
        const item = document.createElement('div');
        item.className = 'notebook-item';
        item.dataset.notebookId = notebook.id;

        const expandIcon = document.createElement('span');
        expandIcon.className = 'expand-icon';
        expandIcon.textContent = 'â–¶';

        const icon = document.createElement('span');
        icon.className = 'notebook-icon';
        icon.textContent = notebook.icon || 'ğŸ“š';
        icon.style.color = notebook.color || '#2d5a7b';

        const name = document.createElement('span');
        name.className = 'notebook-name';
        name.textContent = notebook.name;

        item.appendChild(expandIcon);
        item.appendChild(icon);
        item.appendChild(name);

        // ç‚¹å‡»å±•å¼€/æ”¶èµ·
        item.addEventListener('click', async (e) => {
            e.stopPropagation();
            await this.toggleNotebook(notebook.id, wrapper);
        });

        wrapper.appendChild(item);

        // åˆ†åŒºå®¹å™¨ï¼ˆåˆå§‹éšè—ï¼‰
        const sectionsContainer = document.createElement('div');
        sectionsContainer.className = 'sections-container';
        sectionsContainer.style.display = 'none';
        wrapper.appendChild(sectionsContainer);

        return wrapper;
    }

    // å±•å¼€/æ”¶èµ·ç¬”è®°æœ¬
    async toggleNotebook(notebookId, wrapperEl) {
        const item = wrapperEl.querySelector('.notebook-item');
        const expandIcon = item.querySelector('.expand-icon');
        const sectionsContainer = wrapperEl.querySelector('.sections-container');

        if (sectionsContainer.style.display === 'none') {
            // å±•å¼€
            expandIcon.classList.add('expanded');
            sectionsContainer.style.display = 'block';

            // åŠ è½½åˆ†åŒº
            await this.loadSectionsForNotebook(notebookId, sectionsContainer);

            // è®¾ç½®ä¸ºå½“å‰ç¬”è®°æœ¬
            this.currentNotebookId = notebookId;

            // é«˜äº®å½“å‰ç¬”è®°æœ¬
            document.querySelectorAll('.notebook-item').forEach(el => {
                el.classList.remove('active');
            });
            item.classList.add('active');

        } else {
            // æ”¶èµ·
            expandIcon.classList.remove('expanded');
            sectionsContainer.style.display = 'none';
        }
    }

    // åŠ è½½ç¬”è®°æœ¬çš„åˆ†åŒº
    async loadSectionsForNotebook(notebookId, container) {
        try {
            const sections = await db.getSectionsByNotebook(notebookId);
            container.innerHTML = '';

            if (sections.length === 0) {
                const empty = document.createElement('div');
                empty.style.cssText = 'padding: 8px 16px; color: #9ca3af; font-size: 12px; margin-left: 24px;';
                empty.textContent = 'æš‚æ— åˆ†åŒº';
                container.appendChild(empty);

                // æ·»åŠ æ–°å»ºåˆ†åŒºæŒ‰é’®
                const addBtn = document.createElement('div');
                addBtn.style.cssText = 'padding: 8px 16px; color: #2d5a7b; font-size: 12px; margin-left: 24px; cursor: pointer;';
                addBtn.textContent = '+ æ–°å»ºåˆ†åŒº';
                addBtn.addEventListener('click', () => this.showNewSectionDialog(notebookId));
                container.appendChild(addBtn);
                return;
            }

            sections.forEach(section => {
                const sectionEl = this.createSectionElement(section);
                container.appendChild(sectionEl);
            });

        } catch (error) {
            console.error('Error loading sections:', error);
        }
    }

    // åˆ›å»ºåˆ†åŒºå…ƒç´ 
    createSectionElement(section) {
        const item = document.createElement('div');
        item.className = 'section-item';
        item.dataset.sectionId = section.id;

        const icon = document.createElement('span');
        icon.className = 'section-icon';
        icon.textContent = section.icon || 'ğŸ“';

        const name = document.createElement('span');
        name.className = 'section-name';
        name.textContent = section.name;

        item.appendChild(icon);
        item.appendChild(name);

        // ç‚¹å‡»åŠ è½½é¡µé¢åˆ—è¡¨
        item.addEventListener('click', async (e) => {
            e.stopPropagation();
            await this.selectSection(section.id);
        });

        return item;
    }

    // é€‰æ‹©åˆ†åŒº
    async selectSection(sectionId) {
        this.currentSectionId = sectionId;

        // é«˜äº®å½“å‰åˆ†åŒº
        document.querySelectorAll('.section-item').forEach(el => {
            el.classList.remove('active');
        });
        const sectionEl = document.querySelector(`[data-section-id="${sectionId}"]`);
        if (sectionEl) {
            sectionEl.classList.add('active');
        }

        // åŠ è½½é¡µé¢åˆ—è¡¨
        await this.loadPagesForSection(sectionId);

        // ä¿å­˜çŠ¶æ€
        this.saveState();
    }

    // åŠ è½½åˆ†åŒºçš„é¡µé¢
    async loadPagesForSection(sectionId) {
        try {
            const section = await db.get('sections', sectionId);
            const pages = await db.getPagesBySection(sectionId);

            this.pages = pages;

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('current-section-title').textContent = section.name;

            // æ¸²æŸ“é¡µé¢åˆ—è¡¨
            this.renderPageList(pages);

        } catch (error) {
            console.error('Error loading pages:', error);
            showNotification('åŠ è½½é¡µé¢å¤±è´¥', 'error');
        }
    }

    // æ¸²æŸ“é¡µé¢åˆ—è¡¨
    renderPageList(pages) {
        const container = document.getElementById('page-list');
        container.innerHTML = '';

        if (pages.length === 0) {
            container.innerHTML = '<p style="color: #9ca3af; padding: 20px; text-align: center;">æš‚æ— é¡µé¢<br><br>ç‚¹å‡»ä¸Šæ–¹ â• æŒ‰é’®åˆ›å»ºæ–°é¡µé¢</p>';
            return;
        }

        pages.forEach(page => {
            const item = this.createPageListItem(page);
            container.appendChild(item);
        });
    }

    // åˆ›å»ºé¡µé¢åˆ—è¡¨é¡¹
    createPageListItem(page) {
        const item = document.createElement('div');
        item.className = 'page-item';
        item.dataset.pageId = page.id;

        if (page.isPinned) {
            item.innerHTML = '<span style="margin-right: 4px;">ğŸ“Œ</span>';
        }

        const title = document.createElement('div');
        title.className = 'page-item-title';
        title.textContent = page.title || 'æ— æ ‡é¢˜é¡µé¢';

        const meta = document.createElement('div');
        meta.className = 'page-item-meta';
        meta.innerHTML = `
            <span>${formatRelativeTime(page.updatedAt)}</span>
            <span>${this.getPageTypeLabel(page.type)}</span>
        `;

        item.appendChild(title);
        item.appendChild(meta);

        // æ ‡ç­¾
        if (page.tags && page.tags.length > 0) {
            const tagsContainer = document.createElement('div');
            tagsContainer.className = 'page-item-tags';

            page.tags.forEach(tag => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag';
                tagEl.textContent = tag;
                tagsContainer.appendChild(tagEl);
            });

            item.appendChild(tagsContainer);
        }

        // ç‚¹å‡»åŠ è½½é¡µé¢
        item.addEventListener('click', () => {
            this.loadPage(page.id);
        });

        return item;
    }

    // æ›´æ–°é¡µé¢åˆ—è¡¨é¡¹ï¼ˆå½“æ ‡é¢˜æ”¹å˜æ—¶ï¼‰
    updatePageListItem(pageId, newTitle) {
        const item = document.querySelector(`[data-page-id="${pageId}"]`);
        if (item) {
            const titleEl = item.querySelector('.page-item-title');
            if (titleEl) {
                titleEl.textContent = newTitle || 'æ— æ ‡é¢˜é¡µé¢';
            }
        }
    }

    // è·å–é¡µé¢ç±»å‹æ ‡ç­¾
    getPageTypeLabel(type) {
        const labels = {
            'note': 'ç¬”è®°',
            'trade-log': 'äº¤æ˜“æ—¥å¿—',
            'todo': 'å¾…åŠ'
        };
        return labels[type] || 'ç¬”è®°';
    }

    // åŠ è½½é¡µé¢åˆ°ç¼–è¾‘å™¨
    async loadPage(pageId) {
        this.currentPageId = pageId;

        // é«˜äº®å½“å‰é¡µé¢
        document.querySelectorAll('.page-item').forEach(el => {
            el.classList.remove('active');
        });
        const pageEl = document.querySelector(`[data-page-id="${pageId}"]`);
        if (pageEl) {
            pageEl.classList.add('active');
        }

        // åŠ è½½åˆ°ç¼–è¾‘å™¨
        await editor.loadPage(pageId);

        // ä¿å­˜çŠ¶æ€
        this.saveState();
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    setupEventListeners() {
        // é¡¶éƒ¨å·¥å…·æ æŒ‰é’®
        document.getElementById('btn-new-page').addEventListener('click', () => {
            this.createNewPage();
        });

        document.getElementById('btn-new-template').addEventListener('click', () => {
            templateManager.showTemplateDialog();
        });

        document.getElementById('btn-todos').addEventListener('click', () => {
            this.showAllTodos();
        });

        document.getElementById('btn-export').addEventListener('click', () => {
            exportManager.showExportDialog();
        });

        // æœç´¢æ¡†
        const searchInput = document.getElementById('global-search');
        searchInput.addEventListener('input', debounce((e) => {
            const query = e.target.value;
            if (query.trim()) {
                searchManager.search(query);
            } else {
                searchManager.clearResults();
            }
        }, 300));

        // é¡µé¢åˆ—è¡¨æ–°å»ºæŒ‰é’®
        document.getElementById('btn-add-page').addEventListener('click', () => {
            this.createNewPage();
        });

        // ç¬”è®°æœ¬æ–°å»ºæŒ‰é’®
        document.getElementById('btn-add-notebook').addEventListener('click', () => {
            this.showNewNotebookDialog();
        });

        // é¡µé¢æ ‡é¢˜è¾“å…¥
        document.getElementById('page-title').addEventListener('input', debounce(() => {
            editor.scheduleSave();
        }, 500));

        // é¡µé¢ç±»å‹é€‰æ‹©
        document.getElementById('info-type').addEventListener('change', () => {
            editor.scheduleSave();
        });

        // æ ‡ç­¾è¾“å…¥
        document.getElementById('tag-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const tag = e.target.value.trim();
                if (tag) {
                    editor.addTag(tag);
                    e.target.value = '';
                }
            }
        });

        // é™„ä»¶ä¸Šä¼ 
        document.getElementById('btn-add-attachment').addEventListener('click', () => {
            document.getElementById('attachment-file-input').click();
        });

        document.getElementById('attachment-file-input').addEventListener('change', async (e) => {
            await this.handleAttachmentUpload(e.target.files);
            e.target.value = ''; // é‡ç½®input
        });

        // å¾…åŠè¾“å…¥
        document.getElementById('todo-input').addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const content = e.target.value.trim();
                if (content) {
                    await this.createTodo(content);
                    e.target.value = '';
                }
            }
        });

        // å³ä¾§é¢æ¿æ ‡ç­¾åˆ‡æ¢
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                this.switchTab(btn.dataset.tab);
            });
        });

        // ç­›é€‰å’Œæ’åº
        document.getElementById('filter-type').addEventListener('change', () => {
            this.applyFilters();
        });

        document.getElementById('filter-sort').addEventListener('change', () => {
            this.applyFilters();
        });

        // æ¨¡æ€æ¡†ç›¸å…³
        this.setupModalListeners();
    }

    // è®¾ç½®æ¨¡æ€æ¡†ç›‘å¬å™¨
    setupModalListeners() {
        // æ–°å»ºç¬”è®°æœ¬
        document.getElementById('btn-save-notebook').addEventListener('click', async () => {
            await this.createNotebook();
        });

        document.getElementById('btn-cancel-notebook').addEventListener('click', () => {
            this.closeModal('modal-new-notebook');
        });

        // æ–°å»ºåˆ†åŒº
        document.getElementById('btn-save-section').addEventListener('click', async () => {
            await this.createSection();
        });

        document.getElementById('btn-cancel-section').addEventListener('click', () => {
            this.closeModal('modal-new-section');
        });

        // ä»æ¨¡æ¿åˆ›å»º
        document.getElementById('select-template').addEventListener('change', (e) => {
            templateManager.onTemplateSelect(e.target.value);
        });

        document.getElementById('btn-create-from-template').addEventListener('click', async () => {
            const page = await templateManager.createFromTemplate();
            if (page) {
                templateManager.closeDialog();
                await this.loadPagesForSection(this.currentSectionId);
                await this.loadPage(page.id);
            }
        });

        document.getElementById('btn-cancel-template').addEventListener('click', () => {
            templateManager.closeDialog();
        });

        // å¯¼å‡º
        document.getElementById('btn-do-export').addEventListener('click', async () => {
            const scope = document.getElementById('export-scope').value;
            const format = document.getElementById('export-format').value;
            await exportManager.doExport(scope, format);
            exportManager.closeDialog();
        });

        document.getElementById('btn-cancel-export').addEventListener('click', () => {
            exportManager.closeDialog();
        });

        // å…³é—­æŒ‰é’®
        document.querySelectorAll('.modal-close').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal');
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    switchTab(tabName) {
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.tab === tabName) {
                btn.classList.add('active');
            }
        });

        // æ›´æ–°å†…å®¹
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // æ˜¾ç¤ºæ–°å»ºç¬”è®°æœ¬å¯¹è¯æ¡†
    showNewNotebookDialog() {
        const modal = document.getElementById('modal-new-notebook');
        document.getElementById('input-notebook-name').value = '';
        document.getElementById('input-notebook-type').value = 'product-group';
        document.getElementById('input-notebook-icon').value = 'ğŸ“š';
        document.getElementById('input-notebook-color').value = '#2d5a7b';
        modal.classList.add('active');
    }

    // åˆ›å»ºç¬”è®°æœ¬
    async createNotebook() {
        const name = document.getElementById('input-notebook-name').value.trim();
        const type = document.getElementById('input-notebook-type').value;
        const icon = document.getElementById('input-notebook-icon').value || 'ğŸ“š';
        const color = document.getElementById('input-notebook-color').value;

        if (!name) {
            showNotification('è¯·è¾“å…¥ç¬”è®°æœ¬åç§°', 'error');
            return;
        }

        try {
            await db.createNotebook(name, type, icon, color);
            await this.loadNotebooks();
            this.closeModal('modal-new-notebook');
            showNotification('ç¬”è®°æœ¬å·²åˆ›å»º', 'success');
        } catch (error) {
            console.error('Error creating notebook:', error);
            showNotification('åˆ›å»ºç¬”è®°æœ¬å¤±è´¥', 'error');
        }
    }

    // æ˜¾ç¤ºæ–°å»ºåˆ†åŒºå¯¹è¯æ¡†
    showNewSectionDialog(notebookId) {
        if (!notebookId) {
            showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¬”è®°æœ¬', 'warning');
            return;
        }

        this.currentNotebookId = notebookId;
        const modal = document.getElementById('modal-new-section');
        document.getElementById('input-section-name').value = '';
        document.getElementById('input-section-icon').value = 'ğŸ“';
        modal.classList.add('active');
    }

    // åˆ›å»ºåˆ†åŒº
    async createSection() {
        if (!this.currentNotebookId) {
            showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¬”è®°æœ¬', 'warning');
            return;
        }

        const name = document.getElementById('input-section-name').value.trim();
        const icon = document.getElementById('input-section-icon').value || 'ğŸ“';

        if (!name) {
            showNotification('è¯·è¾“å…¥åˆ†åŒºåç§°', 'error');
            return;
        }

        try {
            await db.createSection(this.currentNotebookId, name, icon);

            // é‡æ–°åŠ è½½å½“å‰ç¬”è®°æœ¬çš„åˆ†åŒº
            const wrapper = document.querySelector(`[data-notebook-id="${this.currentNotebookId}"]`).parentElement;
            const sectionsContainer = wrapper.querySelector('.sections-container');
            await this.loadSectionsForNotebook(this.currentNotebookId, sectionsContainer);

            this.closeModal('modal-new-section');
            showNotification('åˆ†åŒºå·²åˆ›å»º', 'success');
        } catch (error) {
            console.error('Error creating section:', error);
            showNotification('åˆ›å»ºåˆ†åŒºå¤±è´¥', 'error');
        }
    }

    // åˆ›å»ºæ–°é¡µé¢
    async createNewPage() {
        if (!this.currentSectionId) {
            showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†åŒº', 'warning');
            return;
        }

        try {
            const page = await db.createPage(this.currentSectionId);
            await this.loadPagesForSection(this.currentSectionId);
            await this.loadPage(page.id);
            showNotification('é¡µé¢å·²åˆ›å»º', 'success');

            // èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
            document.getElementById('page-title').focus();
        } catch (error) {
            console.error('Error creating page:', error);
            showNotification('åˆ›å»ºé¡µé¢å¤±è´¥', 'error');
        }
    }

    // å¤„ç†é™„ä»¶ä¸Šä¼ 
    async handleAttachmentUpload(files) {
        if (!this.currentPageId) {
            showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡µé¢', 'warning');
            return;
        }

        if (!files || files.length === 0) return;

        try {
            for (const file of files) {
                // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶5MBï¼‰
                if (file.size > 5 * 1024 * 1024) {
                    showNotification(`æ–‡ä»¶ ${file.name} è¶…è¿‡5MBé™åˆ¶`, 'error');
                    continue;
                }

                const base64 = await readFileAsBase64(file);
                await db.addAttachment(
                    this.currentPageId,
                    file.name,
                    file.type,
                    file.size,
                    base64
                );
            }

            await editor.loadAttachments(this.currentPageId);
            showNotification('é™„ä»¶å·²ä¸Šä¼ ', 'success');
        } catch (error) {
            console.error('Error uploading attachments:', error);
            showNotification('ä¸Šä¼ é™„ä»¶å¤±è´¥', 'error');
        }
    }

    // åˆ›å»ºå¾…åŠ
    async createTodo(content) {
        if (!this.currentPageId) {
            showNotification('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé¡µé¢', 'warning');
            return;
        }

        try {
            await db.createTodo(content, this.currentPageId);
            await editor.loadTodos(this.currentPageId);
            showNotification('å¾…åŠå·²æ·»åŠ ', 'success');
        } catch (error) {
            console.error('Error creating todo:', error);
            showNotification('æ·»åŠ å¾…åŠå¤±è´¥', 'error');
        }
    }

    // æ˜¾ç¤ºæ‰€æœ‰å¾…åŠ
    async showAllTodos() {
        try {
            const todos = await db.getTodos();
            // TODO: æ˜¾ç¤ºå…¨å±€å¾…åŠåˆ—è¡¨ï¼ˆå¯ä»¥åœ¨æ¨¡æ€æ¡†ä¸­æ˜¾ç¤ºï¼‰
            console.log('All todos:', todos);
            showNotification('åŠŸèƒ½å¼€å‘ä¸­', 'info');
        } catch (error) {
            console.error('Error loading todos:', error);
        }
    }

    // åº”ç”¨ç­›é€‰å’Œæ’åº
    applyFilters() {
        const type = document.getElementById('filter-type').value;
        const sort = document.getElementById('filter-sort').value;

        let filtered = [...this.pages];

        // ç­›é€‰ç±»å‹
        if (type !== 'all') {
            filtered = filtered.filter(page => page.type === type);
        }

        // æ’åº
        switch (sort) {
            case 'updated-desc':
                filtered.sort((a, b) => b.updatedAt - a.updatedAt);
                break;
            case 'created-desc':
                filtered.sort((a, b) => b.createdAt - a.createdAt);
                break;
            case 'title-asc':
                filtered.sort((a, b) => a.title.localeCompare(b.title));
                break;
        }

        this.renderPageList(filtered);
    }

    // å…³é—­æ¨¡æ€æ¡†
    closeModal(modalId) {
        const modal = document.getElementById(modalId);
        modal.classList.remove('active');
    }

    // ä¿å­˜åº”ç”¨çŠ¶æ€
    saveState() {
        LocalStorage.set('app-state', {
            currentNotebookId: this.currentNotebookId,
            currentSectionId: this.currentSectionId,
            currentPageId: this.currentPageId
        });
    }

    // æ¢å¤åº”ç”¨çŠ¶æ€
    async restoreState() {
        const state = LocalStorage.get('app-state');
        if (!state) {
            // é»˜è®¤å±•å¼€ç¬¬ä¸€ä¸ªç¬”è®°æœ¬
            if (this.notebooks.length > 0) {
                const firstNotebook = this.notebooks[0];
                const wrapper = document.querySelector(`[data-notebook-id="${firstNotebook.id}"]`).parentElement;
                await this.toggleNotebook(firstNotebook.id, wrapper);
            }
            return;
        }

        // æ¢å¤ç¬”è®°æœ¬
        if (state.currentNotebookId) {
            const wrapper = document.querySelector(`[data-notebook-id="${state.currentNotebookId}"]`)?.parentElement;
            if (wrapper) {
                await this.toggleNotebook(state.currentNotebookId, wrapper);
            }
        }

        // æ¢å¤åˆ†åŒº
        if (state.currentSectionId) {
            await this.selectSection(state.currentSectionId);
        }

        // æ¢å¤é¡µé¢
        if (state.currentPageId) {
            await this.loadPage(state.currentPageId);
        }
    }
}

// åº”ç”¨å¯åŠ¨
window.app = new App();

// å½“DOMåŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
document.addEventListener('DOMContentLoaded', async () => {
    try {
        await window.app.init();
    } catch (error) {
        console.error('Failed to initialize app:', error);
        alert('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
    }
});

// åœ¨çª—å£å¸è½½å‰ä¿å­˜ç¼–è¾‘å™¨å†…å®¹
window.addEventListener('beforeunload', () => {
    if (editor.currentPageId) {
        editor.save();
    }
});
