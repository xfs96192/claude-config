#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å‘¨æŠ¥è‡ªåŠ¨åŒ–ä¸»æ§åˆ¶è„šæœ¬
ä¸€é”®æ‰§è¡Œå®Œæ•´çš„Pythonæ•°æ®å¤„ç†æµç¨‹
- å®æ—¶æ˜¾ç¤ºå­è„šæœ¬è¾“å‡º
- æ¸…æ™°å±•ç¤ºé”™è¯¯ä¿¡æ¯
"""

import os
import sys
import subprocess
import time
from datetime import datetime
from config import Config


def run_script(script_name, description, args=None):
    """
    æ‰§è¡ŒæŒ‡å®šçš„Pythonè„šæœ¬ï¼Œå®æ—¶æ˜¾ç¤ºè¾“å‡º
    """
    print(f"\n{'='*60}")
    print(f"ğŸ”„ å¼€å§‹æ‰§è¡Œ: {description}")
    print(f"ğŸ“„ è„šæœ¬æ–‡ä»¶: {script_name}")
    print(f"â° å¼€å§‹æ—¶é—´: {datetime.now().strftime('%H:%M:%S')}")
    print(f"{'='*60}\n")

    script_path = os.path.join(Config.BASE_DIR, script_name)

    # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
    if not os.path.exists(script_path):
        print(f"âŒ é”™è¯¯: è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨ - {script_path}")
        return False

    try:
        command = [sys.executable, "-u", script_path]  # -u ç¦ç”¨è¾“å‡ºç¼“å†²
        if args:
            command.extend(args)

        # ä½¿ç”¨ Popen å®æ—¶æ˜¾ç¤ºè¾“å‡º
        process = subprocess.Popen(
            command,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,  # åˆå¹¶ stderr åˆ° stdout
            text=True,
            bufsize=1,  # è¡Œç¼“å†²
            cwd=Config.BASE_DIR,
            env={**os.environ, 'PYTHONUNBUFFERED': '1'}  # ç¡®ä¿ Python ä¸ç¼“å†²è¾“å‡º
        )

        # å®æ—¶è¯»å–å¹¶æ˜¾ç¤ºè¾“å‡º
        output_lines = []
        while True:
            line = process.stdout.readline()
            if line:
                print(f"  {line}", end='')  # æ·»åŠ ç¼©è¿›ä»¥åŒºåˆ†å­è„šæœ¬è¾“å‡º
                output_lines.append(line)
            elif process.poll() is not None:
                break

        # è¯»å–å‰©ä½™è¾“å‡º
        remaining = process.stdout.read()
        if remaining:
            print(f"  {remaining}", end='')
            output_lines.append(remaining)

        return_code = process.returncode
        end_time = datetime.now().strftime('%H:%M:%S')

        if return_code == 0:
            print(f"\n{'â”€'*60}")
            print(f"âœ… {description} - æ‰§è¡ŒæˆåŠŸ (ç»“æŸæ—¶é—´: {end_time})")
            return True
        else:
            print(f"\n{'â”€'*60}")
            print(f"âŒ {description} - æ‰§è¡Œå¤±è´¥ (è¿”å›ç : {return_code})")
            print(f"â° ç»“æŸæ—¶é—´: {end_time}")

            # å¦‚æœè¾“å‡ºä¸­åŒ…å«é”™è¯¯ä¿¡æ¯ï¼Œé«˜äº®æ˜¾ç¤º
            error_keywords = ['Error', 'Exception', 'Traceback', 'é”™è¯¯', 'å¤±è´¥']
            error_lines = [l for l in output_lines if any(k in l for k in error_keywords)]
            if error_lines:
                print(f"\nğŸ” å…³é”®é”™è¯¯ä¿¡æ¯:")
                for line in error_lines[-10:]:  # æ˜¾ç¤ºæœ€å10æ¡é”™è¯¯ç›¸å…³è¡Œ
                    print(f"   âš ï¸  {line.strip()}")

            return False

    except FileNotFoundError:
        print(f"âŒ é”™è¯¯: Python è§£é‡Šå™¨æœªæ‰¾åˆ°")
        return False
    except Exception as e:
        print(f"âŒ æ‰§è¡Œå¼‚å¸¸: {type(e).__name__}: {str(e)}")
        import traceback
        traceback.print_exc()
        return False


def main():
    """ä¸»æ§åˆ¶å‡½æ•°"""
    start_time = datetime.now()

    print(f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         ğŸ¦ å¤šèµ„äº§æŠ•èµ„éƒ¨äº§å“å‘¨æŠ¥è‡ªåŠ¨åŒ–ç³»ç»Ÿ                    â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ğŸ“… æŠ¥å‘Šæ—¥æœŸ: {Config.YUNZUOGAILAN_DATE}                                       â•‘
â•‘  ğŸ“ æ•°æ®ç›®å½•: {Config.DATA_DIR:<45} â•‘
â•‘  ğŸ“Š è¾“å‡ºç›®å½•: {Config.OUTPUT_DIR:<45} â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)

    # æ‰“å°æ‰€æœ‰æ—¥æœŸé…ç½®
    print("ğŸ“† æ—¥æœŸé…ç½®:")
    print(f"   è¿ä½œæ¦‚è§ˆæ—¥æœŸ: {Config.YUNZUOGAILAN_DATE}")
    print(f"   å‘¨æŠ¥æ—¥æœŸ:     {Config.ZHOUBAO_DATE}")
    print(f"   ä¸Šå‘¨æ—¥æœŸ:     {Config.LASTW}")
    print(f"   ä¸Šæœˆæœ€åä¸€å¤©: {Config.LASTM}")
    print(f"   ä¸Šå¹´æœ€åä¸€å¤©: {Config.LASTY}")
    print(f"   æœ¬å‘¨ä¸€æ—¥æœŸ:   {Config.WEEK_MON}")
    print(f"   ä¸‹å‘¨ä¸€æ—¥æœŸ:   {Config.BEGIN_DATE_NEXT_W}")
    print(f"   ä¸‹å‘¨äº”æ—¥æœŸ:   {Config.CLOSING_DATE_NEXT_W}")

    print(f"\n{'â•'*60}")

    # ç¡®è®¤æ‰§è¡Œ
    user_input = input("\nç¡®è®¤æ‰§è¡Œå®Œæ•´æµç¨‹å—ï¼Ÿ(y/n): ").strip().lower()
    if user_input != 'y':
        print("âŒ ç”¨æˆ·å–æ¶ˆæ‰§è¡Œ")
        return

    # æ‰§è¡Œæµç¨‹
    steps = [
        ("move_files.py", "1. æ•°æ®æºæ–‡ä»¶ç§»åŠ¨"),
        ("update_new_product_catgoery.py", "2. AIäº§å“åˆ†ç±»æ›´æ–°"),
        ("generate_report.py", "3. ä¸»è¦ç»“æœè¡¨ç”Ÿæˆ"),
        ("calculate_all_benchmarks.py", "4. ä¸šç»©åŸºå‡†è¡¨ç°è®¡ç®—"),
        ("yield_forecast.py", "5. æ”¶ç›Šé¢„æµ‹æ•°æ®ç”Ÿæˆ")
    ]

    print(f"\nğŸ“‹ æ‰§è¡Œè®¡åˆ’: å…± {len(steps)} ä¸ªæ­¥éª¤")
    for script, desc in steps:
        print(f"   â€¢ {desc} ({script})")
    print()

    success_count = 0
    failed_step = None

    for i, (script, description) in enumerate(steps, 1):
        args = None
        if script == "calculate_all_benchmarks.py":
            args = ["--date", Config.ZHOUBAO_DATE]

        print(f"\nğŸ“ è¿›åº¦: [{i}/{len(steps)}]")

        if run_script(script, description, args=args):
            success_count += 1
        else:
            failed_step = description
            print(f"\n{'!'*60}")
            print(f"âŒ æµç¨‹åœ¨æ­¥éª¤ [{i}/{len(steps)}] '{description}' å¤±è´¥")
            print(f"{'!'*60}")

            # è¯¢é—®æ˜¯å¦ç»§ç»­
            if i < len(steps):
                cont = input("\næ˜¯å¦è·³è¿‡æ­¤æ­¥éª¤ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤ï¼Ÿ(y/n): ").strip().lower()
                if cont != 'y':
                    break

    # è®¡ç®—æ€»è€—æ—¶
    end_time = datetime.now()
    duration = end_time - start_time
    minutes, seconds = divmod(duration.total_seconds(), 60)

    print(f"\n{'â•'*60}")
    print(f"ğŸ“Š æ‰§è¡Œç»“æœæ±‡æ€»")
    print(f"{'â•'*60}")
    print(f"   æˆåŠŸæ­¥éª¤: {success_count}/{len(steps)}")
    print(f"   æ€»è€—æ—¶:   {int(minutes)} åˆ† {int(seconds)} ç§’")
    print(f"   å¼€å§‹æ—¶é—´: {start_time.strftime('%H:%M:%S')}")
    print(f"   ç»“æŸæ—¶é—´: {end_time.strftime('%H:%M:%S')}")

    if success_count == len(steps):
        print(f"\nâœ… Pythonæ•°æ®å¤„ç†é˜¶æ®µå…¨éƒ¨å®Œæˆï¼")
        print(f"\nğŸ“‹ åç»­æ‰‹åŠ¨æ­¥éª¤:")
        print(f"   6. æ‰“å¼€ 'å‘¨æŠ¥ç”Ÿæˆå·¥å…·_åŠ æƒ.xlsm' æ‰§è¡ŒVBAå®")
        print(f"   7. åœ¨Wordæ¨¡æ¿ä¸­æ‰§è¡ŒVBAç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š")
        print(f"   8. å‘é€PDFå‘¨æŠ¥è‡³é‚®ç®±")
    else:
        print(f"\nâŒ éƒ¨åˆ†æ­¥éª¤æ‰§è¡Œå¤±è´¥")
        if failed_step:
            print(f"   å¤±è´¥æ­¥éª¤: {failed_step}")
        print(f"   è¯·æ£€æŸ¥ä¸Šè¿°é”™è¯¯ä¿¡æ¯åé‡è¯•")

    print(f"{'â•'*60}\n")


if __name__ == "__main__":
    main()
