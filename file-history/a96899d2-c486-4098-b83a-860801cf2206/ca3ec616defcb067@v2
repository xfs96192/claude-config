# å¯¼å…¥åŒ…
import os
import pandas as pd
import numpy as np
from datetime import datetime, timedelta, date
import copy
from utils import *
import warnings
warnings.filterwarnings("ignore")
# å¯¼å…¥ç»Ÿä¸€é…ç½®æ–‡ä»¶ - ä¿æŒæ‰€æœ‰è®¡ç®—é€»è¾‘ä¸å˜
from config import *
# å¯¼å…¥æ•°æ®éªŒè¯æ¨¡å— - ç¡®ä¿æŠ•èµ„æ•°æ®å‡†ç¡®æ€§
from data_validator import DataValidator, safe_read_excel, validate_critical_paths
from openai import OpenAI
# è¯»å–ç†è´¢äº§å“å‡€å€¼åºåˆ—
from WindPy import w
import glob

w.start(waitTime=60)
w.isconnected()
def get_wenzi_result(prompt):
    client = OpenAI(api_key="sk-18da7927fc3444508482c5c66b051fc2", base_url="https://api.deepseek.com")
    response = client.chat.completions.create(
        model="deepseek-reasoner",
        messages=[
            {"role": "system", "content": "You are a helpful assistant"},
            {"role": "user", "content": prompt},
        ],
        stream=False
    )
    return response.choices[0].message.content

# åˆå§‹åŒ–æ•°æ®éªŒè¯å™¨
validator = DataValidator(log_errors=True)

# éªŒè¯å…³é”®è·¯å¾„
print("ğŸ” å¼€å§‹éªŒè¯å…³é”®æ•°æ®è·¯å¾„...")
path_validation = validate_critical_paths(Config)
if not path_validation['is_valid']:
    print("âŒ å…³é”®è·¯å¾„éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®ç›®å½•ç»“æ„")
    for error in path_validation['errors']:
        print(f"   - {error}")

## todo  å‘¨æŠ¥æ–‡å­—éƒ¨åˆ†è‡ªåŠ¨æ›´æ–°äº§å“è®¡åˆ’åŠä¸Šä¸ªæœˆçš„è§„æ¨¡æƒ…å†µ


# æ³¨æ„ï¼šä»¥ä¸‹å˜é‡å·²åœ¨config.pyä¸­ç»Ÿä¸€é…ç½®ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹
# æ‰€æœ‰è®¡ç®—é€»è¾‘å’Œæ•°æ®å¤„ç†ä¿æŒå®Œå…¨ä¸å˜
# Underlying_data_folder_path, yunzuogailan_date, zhoubao_date ç­‰å˜é‡
# ç°åœ¨éƒ½ä»config.pyè‡ªåŠ¨åŠ è½½ï¼Œç¡®ä¿æ•°æ®è®¡ç®—ç»“æœå®Œå…¨ä¸€è‡´


def get_product_data(COOKED_FOLDER, force_rebuild=False):
    """
    è¯»å–äº§å“å‡€å€¼æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜æœºåˆ¶å¤§å¹…æå‡æ€§èƒ½

    ç¼“å­˜ç­–ç•¥ï¼š
    1. é¦–æ¬¡è¿è¡Œï¼šè¯»å–æ‰€æœ‰Excelæ–‡ä»¶ï¼Œä¿å­˜ä¸ºparquetç¼“å­˜
    2. åç»­è¿è¡Œï¼šåªè¯»å–æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶ï¼Œä¸ç¼“å­˜åˆå¹¶
    3. ç›¸åŒæ—¥æœŸ+äº§å“ä»£ç çš„æ•°æ®ï¼Œä¿ç•™æœ€æ–°æ–‡ä»¶çš„å€¼

    å‚æ•°ï¼š
        COOKED_FOLDER: å‡€å€¼æ•°æ®æ–‡ä»¶å¤¹è·¯å¾„
        force_rebuild: æ˜¯å¦å¼ºåˆ¶é‡å»ºç¼“å­˜ï¼ˆé»˜è®¤Falseï¼‰
    """
    import pickle
    import time

    # ç¼“å­˜ç›®å½•å’Œæ–‡ä»¶
    cache_dir = os.path.join(os.path.dirname(COOKED_FOLDER), '.nav_cache')
    cache_data_file = os.path.join(cache_dir, 'nav_master_data.parquet')
    cache_meta_file = os.path.join(cache_dir, 'nav_metadata.pkl')

    # ç¡®ä¿ç¼“å­˜ç›®å½•å­˜åœ¨
    os.makedirs(cache_dir, exist_ok=True)

    # è·å–æ‰€æœ‰Excelæ–‡ä»¶åŠå…¶ä¿®æ”¹æ—¶é—´
    excel_files = glob.glob(os.path.join(COOKED_FOLDER, '*.xlsx'))
    excel_files = [f for f in excel_files if not os.path.basename(f).startswith('~$')]  # æ’é™¤ä¸´æ—¶æ–‡ä»¶

    current_files_info = {}
    for f in excel_files:
        mtime = os.path.getmtime(f)
        current_files_info[f] = mtime

    print(f"ğŸ“‚ å‡€å€¼æ•°æ®æ–‡ä»¶å¤¹: {COOKED_FOLDER}")
    print(f"ğŸ“Š å‘ç° {len(excel_files)} ä¸ªExcelæ–‡ä»¶")

    # åŠ è½½ç¼“å­˜å…ƒæ•°æ®
    cached_files_info = {}
    cached_data = None

    if not force_rebuild and os.path.exists(cache_meta_file) and os.path.exists(cache_data_file):
        try:
            with open(cache_meta_file, 'rb') as f:
                cached_files_info = pickle.load(f)
            cached_data = pd.read_parquet(cache_data_file)
            print(f"âœ… å·²åŠ è½½ç¼“å­˜æ•°æ®: {len(cached_data)} æ¡è®°å½•")
        except Exception as e:
            print(f"âš ï¸ ç¼“å­˜åŠ è½½å¤±è´¥ï¼Œå°†é‡å»ºç¼“å­˜: {e}")
            cached_files_info = {}
            cached_data = None

    # æ‰¾å‡ºéœ€è¦è¯»å–çš„æ–‡ä»¶ï¼ˆæ–°å¢æˆ–ä¿®æ”¹çš„ï¼‰
    files_to_read = []
    for f, mtime in current_files_info.items():
        if f not in cached_files_info or cached_files_info[f] != mtime:
            files_to_read.append(f)

    needed_cols = ['ä¼°å€¼æ—¥', 'äº§å“ä»£ç ', 'ç´¯è®¡å‡€å€¼']

    if len(files_to_read) == 0 and cached_data is not None:
        print(f"âœ… æ‰€æœ‰æ–‡ä»¶å‡å·²ç¼“å­˜ï¼Œæ— éœ€é‡æ–°è¯»å–")
        data = cached_data
    else:
        print(f"ğŸ“– éœ€è¦è¯»å– {len(files_to_read)} ä¸ªæ–‡ä»¶ï¼ˆæ–°å¢æˆ–å·²ä¿®æ”¹ï¼‰")

        # è¯»å–æ–°æ–‡ä»¶
        start_time = time.time()
        new_dfs = []

        for i, f in enumerate(files_to_read, 1):
            if i % 10 == 0 or i == len(files_to_read):
                print(f"   è¯»å–è¿›åº¦: {i}/{len(files_to_read)} - {os.path.basename(f)}")
            try:
                df = pd.read_excel(f, usecols=needed_cols)
                df['_source_file'] = f  # è®°å½•æ¥æºæ–‡ä»¶ç”¨äºè¿½è¸ª
                new_dfs.append(df)
            except Exception as e:
                print(f"   âš ï¸ è¯»å–å¤±è´¥: {os.path.basename(f)} - {e}")

        read_time = time.time() - start_time
        print(f"   è¯»å–è€—æ—¶: {read_time:.1f} ç§’")

        # åˆå¹¶æ–°æ•°æ®ä¸ç¼“å­˜æ•°æ®
        if new_dfs:
            new_data = pd.concat(new_dfs, ignore_index=True)

            if cached_data is not None and len(files_to_read) < len(excel_files):
                # å¢é‡æ›´æ–°ï¼šåˆå¹¶æ–°æ—§æ•°æ®
                # å¯¹äºä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼Œéœ€è¦å…ˆåˆ é™¤æ—§æ•°æ®
                modified_files = [f for f in files_to_read if f in cached_files_info]
                if modified_files and '_source_file' in cached_data.columns:
                    cached_data = cached_data[~cached_data['_source_file'].isin(modified_files)]

                data = pd.concat([cached_data, new_data], ignore_index=True)
                print(f"   å¢é‡åˆå¹¶å®Œæˆ: ç¼“å­˜ {len(cached_data)} + æ–°å¢ {len(new_data)} æ¡")
            else:
                data = new_data
        else:
            data = cached_data if cached_data is not None else pd.DataFrame(columns=needed_cols)

    # å»é‡ï¼šç›¸åŒæ—¥æœŸ+äº§å“ä»£ç ä¿ç•™æœ€åå‡ºç°çš„ï¼ˆå³æœ€æ–°æ–‡ä»¶çš„æ•°æ®ï¼‰
    before_dedup = len(data)
    data.drop_duplicates(subset=['ä¼°å€¼æ—¥', 'äº§å“ä»£ç '], keep='last', inplace=True)
    print(f"   å»é‡: {before_dedup} -> {len(data)} æ¡è®°å½•")

    # ä¿å­˜æ›´æ–°åçš„ç¼“å­˜
    if len(files_to_read) > 0 or not os.path.exists(cache_data_file):
        try:
            data.to_parquet(cache_data_file, index=False)
            with open(cache_meta_file, 'wb') as f:
                pickle.dump(current_files_info, f)
            print(f"ğŸ’¾ ç¼“å­˜å·²æ›´æ–°: {cache_data_file}")
        except Exception as e:
            print(f"âš ï¸ ç¼“å­˜ä¿å­˜å¤±è´¥: {e}")

    # æ„å»ºé€è§†è¡¨
    print(f"ğŸ”„ æ„å»ºæ•°æ®é€è§†è¡¨...")

    # ç§»é™¤è¾…åŠ©åˆ—å†åšé€è§†
    pivot_data = data[['ä¼°å€¼æ—¥', 'äº§å“ä»£ç ', 'ç´¯è®¡å‡€å€¼']].copy()

    data_transposition = pd.pivot_table(
        pivot_data,
        index='ä¼°å€¼æ—¥',
        columns='äº§å“ä»£ç ',
        values='ç´¯è®¡å‡€å€¼',
        aggfunc='median'
    )

    # ä¼˜åŒ–æ—¥æœŸè½¬æ¢ - æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼
    try:
        data_transposition.index = pd.to_datetime(data_transposition.index, format='%Y/%m/%d')
    except:
        data_transposition.index = pd.to_datetime(data_transposition.index, errors='coerce')

    data_transposition = data_transposition.sort_index()
    data_transposition.columns = data_transposition.columns.astype(str)

    print(f"âœ… æ•°æ®åŠ è½½å®Œæˆ: {len(data_transposition)} ä¸ªäº¤æ˜“æ—¥, {len(data_transposition.columns)} ä¸ªäº§å“")

    return data, data_transposition


print("\n" + "="*60)
print("ğŸ“Š å¼€å§‹åŠ è½½äº§å“å‡€å€¼æ•°æ®...")
print("="*60)
data, data_transposition = get_product_data(COOKED_FOLDER)
print("="*60 + "\n")

# DAPäº§å“ä¿¡æ¯è¡¨
Product_information_df_DAP = pd.read_excel(Config.get_weekly_data_file('ç†è´¢äº§å“ä¿¡æ¯æŸ¥è¯¢'), index_col=0)


# åˆ¤æ–­äº§å“å½¢æ€
def map_product_xingtai(series_here):
    if series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å°é—­å¼':
        return 'å°é—­'
    elif (series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å¼€æ”¾å¼') and (series_here['å‘¨æœŸå±æ€§'] == 'å®¢æˆ·å‘¨æœŸ'):
        return 'å®¢æˆ·å‘¨æœŸ'
    elif (series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å¼€æ”¾å¼') and (series_here['å‘¨æœŸå±æ€§'] == 'äº§å“å‘¨æœŸ') and (
            series_here['å‘¨æœŸå¤©æ•°'] == 1):
        return 'æ—¥å¼€'
    elif (series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å¼€æ”¾å¼') and (series_here['å‘¨æœŸå±æ€§'] == 'äº§å“å‘¨æœŸ'):
        return 'å®šå¼€'


# è·å–æ‹›å•†æ ‡ç­¾
def get_zhaoshang_label(set_here):
    if 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸' in set_here:
        if len(set_here.difference({'-', 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'})) == 0:
            return 'æ‹›å•†ç‹¬æœ‰'
        else:
            return 'æ‹›å•†å…±æœ‰'
    else:
        return 'éæ‹›å•†'


# è·å–æ‰€æœ‰çš„æ¸ é“æ ‡ç­¾
def get_qudao_label_detail(set_here):
    # æ¸ é“ç®€ç§°åŒ¹é…
    qudao_forshort_dict = {"å…´ä¸šé“¶è¡Œ": "å…´ä¸š",
                           "æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸": "æ‹›å•†",
                           "ä¸­ä¿¡é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸": "ä¸­ä¿¡",
                           "ä¸Šæµ·æµ¦ä¸œå‘å±•é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸": "æµ¦å‘",
                           'ä¸Šæµ·é“¶è¡Œ': 'ä¸Šæµ·é“¶è¡Œ',
                           "å·¥å•†é“¶è¡Œ": "å·¥å•†",
                           "æ°‘ç”Ÿé“¶è¡Œ": "æ°‘ç”Ÿ",
                           "æµ™å•†é“¶è¡Œ": "æµ™å•†",
                           "å¹¿å‘é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸": "å¹¿å‘",
                           "äº¤é€šé“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸": "äº¤é€š",
                           'å»ºè®¾é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸': 'å»ºè¡Œ',
                           "å®æ³¢é“¶è¡Œ": "å®æ³¢",
                           "ä¸­å›½å…‰å¤§é“¶è¡Œ": "å…‰å¤§",
                           "å¹³å®‰é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸": "å¹³å®‰",
                           "ä¸­å°é“¶è¡Œ": "ä¸­å°",
                           'åå¤é“¶è¡Œ':'åå¤é“¶è¡Œ',
                           "ç½‘å•†é“¶è¡Œ": "ç½‘å•†",
                           "é’±å¤§æŒæŸœ": "é’±å¤§",
                           "è´¢å¯Œäº‘": "è´¢å¯Œäº‘", }
    qudao_rank_dict = dict(enumerate(qudao_forshort_dict.keys()))
    qudao_rank_dict = dict([val, key] for key, val in qudao_rank_dict.items())
    if "-" in set_here:
        set_here.remove("-")
    to_sort_list = list((x, qudao_rank_dict[x]) for x in set_here)  # æŒ‰ç…§ç”±ä¸»åˆ°æ¬¡å¯¹æ¸ é“å±•ç¤ºé¡ºåºæ’åº
    to_sort_list.sort(key=lambda y: y[1])
    return ",".join([qudao_forshort_dict[x[0]] for x in to_sort_list])


def get_yunzuogailan(yunzuogailan_date):
    yunzuogailan_before = pd.read_excel(Config.get_weekly_data_file('äº§å“è¿ä½œæ¦‚è§ˆ'), index_col=0)
    yunzuogailan_before.drop_duplicates(inplace=True)
    # å¤„ç†paså¯¼å‡ºçš„ä¸šç»©åŸºå‡†ï¼Œxå·è¢«å¯¼å‡ºä¸º&times;
    yunzuogailan_before['ä¸šç»©åŸºå‡†'] = yunzuogailan_before['ä¸šç»©åŸºå‡†'].map(
        lambda s: s.replace("&times;", "*") if (isinstance(s, str)) and ("&times;" in s) else s)
    Baoyou_df = pd.read_excel(Config.get_weekly_data_file('å„æ¸ é“ä¿æœ‰é‡'), index_col=0)
    # åˆ é™¤æ¸ é“ä¿æœ‰é‡ä¸­å­äº§å“çš„æ¸ é“ä¸º-çš„ è¿™ä¸ªæ˜¯æ±‡æ€»æ¡ï¼Œä¼šä½¿å¾—è§„æ¨¡è®¡ç®—å‡ºé”™
    Baoyou_df_sub = Baoyou_df[Baoyou_df['æ¸ é“åç§°'] != '-']
    Baoyou_df_mom = Baoyou_df[Baoyou_df.apply(lambda x: '(å­' not in x['äº§å“ç®€ç§°'], axis=1)]
    Baoyou_df = pd.concat([Baoyou_df_mom, Baoyou_df_sub])
    Baoyou_df.drop_duplicates(inplace=True)

    # åŒ¹é…ç†è´¢äº§å“çš„å­—æ¯ä»£ç 
    yunzuogailan_before['æ¯äº§å“ä»£ç '] = yunzuogailan_before['äº§å“ç®€ç§°'].map(
        lambda x: yunzuogailan_before[yunzuogailan_before['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0])
    yunzuogailan_before = yunzuogailan_before[~(yunzuogailan_before['å•ä½å‡€å€¼'].isnull())]
    # è·å–ç¾å…ƒäº§å“æ¸…å•
    Dollar_product_list = list(
        set(Product_information_df_DAP[Product_information_df_DAP['å¸ç§'] == 'ç¾å…ƒ'].index).intersection(
            yunzuogailan_before.index))
    yunzuogailan_before['å‡€èµ„äº§(äº¿)'] = yunzuogailan_before.apply(
        lambda x: Baoyou_df.loc[x.name]['ä¿æœ‰è§„æ¨¡'].sum() / 100000000 if x.name in Dollar_product_list else x[
            'å‡€èµ„äº§(äº¿)'], axis=1)
    yunzuogailan_before = yunzuogailan_before.merge(Product_information_df_DAP[['å¸ç§']], left_index=True,
                                                    right_index=True, how='left')

    # åŒ¹é…å¶è€å¸ˆçš„å“ç±»
    classification_df = pd.read_excel(
        Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),
        sheet_name='å¤šèµ„äº§å“ç±»æ ‡ç­¾',
        index_col='æ¯äº§å“ä»£ç '
    )
    # å¤„ç†å¯èƒ½å­˜åœ¨çš„é‡å¤æ¯äº§å“ä»£ç ï¼Œé¿å…æ˜ å°„æ—¶è¿”å›Serieså¯¼è‡´åç»­mergeæŠ¥é”™
    classification_df = classification_df[~classification_df.index.duplicated(keep='first')]
    classification_ye = classification_df['å¤šèµ„äº§å“ç±»']
    yunzuogailan_before['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(
        lambda x: classification_ye[x] if x in classification_ye.index else np.nan)
    yunzuogailan_before['äº§å“éƒ¨å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(
        lambda x: classification_df['äº§å“éƒ¨å“ç±»'][x] if x in classification_ye.index else np.nan)
    # åŒ¹é…äº§å“è¿ä½œå‘¨æœŸ
    patern = pd.Series(Product_information_df_DAP.apply(map_product_xingtai, axis=1), name='å½¢æ€')

    ###product_code_df=pd.read_excel(Underlying_data_folder_path+'/å­æ¯äº§å“ä»£ç -æ¬¡æ›´.xlsx',index_col=0)
    Baoyou_df_merge = Baoyou_df.merge(yunzuogailan_before['æ¯äº§å“ä»£ç '], left_index=True, right_index=True, how='left')
    yunzuogailan_before = yunzuogailan_before.merge(patern, left_index=True, right_index=True, how='left')
    yunzuogailan_before = yunzuogailan_before.merge(Product_information_df_DAP[['å‘¨æœŸå¤©æ•°', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°']],
                                                    left_index=True, right_index=True, how='left')
    # åŒ¹é…æ‹›å•†æ ‡ç­¾
    Zhaoshang_label_df = pd.DataFrame(
        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_zhaoshang_label(set(x['æ¸ é“åç§°']))),
        columns=['æ˜¯å¦æ‹›å•†'])
    yunzuogailan_before = yunzuogailan_before.merge(Zhaoshang_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True,
                                                    how='left')
    Qudao_label_df = pd.DataFrame(
        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_qudao_label_detail(set(x['æ¸ é“åç§°']))),
        columns=['æ¸ é“æ˜ç»†'])

    yunzuogailan_before = yunzuogailan_before.merge(Qudao_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')
    # å¦‚æœæ˜¯2023å¹´12æœˆ31æ—¥çš„è¯ï¼Œæ¶‰åŠéƒ¨åˆ†æ‹†åˆ†äº§å“ç»ç†åˆ‡æ¢
    if yunzuogailan_date in ['20231229', '20231231']:
        yunzuogailan_before['äº§å“ç»ç†'] = yunzuogailan_before.apply(
            lambda x: Product_information_df_DAP.loc[x.name, 'æ¯äº§å“æŠ•èµ„ç»ç†'], axis=1)
    yunzuogailan_before.rename(columns={'ç»„åˆä¹…æœŸ(å¤šèµ„äº§)': 'ç»„åˆä¹…æœŸ'}, inplace=True)
    yunzuogailan_before.rename(columns={'ç»„åˆé™æ€(å¤šèµ„äº§)': 'ç»„åˆé™æ€'}, inplace=True)
    yunzuogailan_before_v2 = yunzuogailan_before.merge(Product_information_df_DAP[['æ¯å­æ ‡å¿—']], left_index=True,
                                                       right_index=True, how='left')
    # å¯¹äºéæ¯å­äº§å“å’Œå­1ä»½é¢ï¼Œè´´ä¸Šâ€œä¸»è¦å±•ç¤ºâ€æ ‡ç­¾ 'éæ¯å­äº§å“' 'å­äº§å“' (å­1)
    yunzuogailan_before_v2['ä¸»è¦å±•ç¤º'] = yunzuogailan_before_v2.apply(
        lambda x: 'æ˜¯' if ((x['æ¯å­æ ‡å¿—'] == 'éæ¯å­äº§å“') or ('(å­1)' in x['äº§å“ç®€ç§°'])) else 'å¦', axis=1)
    Parent_sort = pd.read_excel(
        Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),
        sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»',
        index_col=0
    )[['æ¯åˆ†ç±»']]
    # å»é‡ï¼Œç¡®ä¿ç´¢å¼•ï¼ˆå¤šèµ„äº§å“ç±»ï¼‰å”¯ä¸€
    Parent_sort = Parent_sort[~Parent_sort.index.duplicated(keep='first')]
    # é˜²å¾¡æ€§å¤„ç†ï¼šç¡®ä¿ç”¨äºåˆå¹¶çš„é”®åˆ—ä¸ºæ ‡é‡ï¼Œé¿å…å‡ºç° Series/åˆ—è¡¨ å¯¼è‡´ merge æŠ¥é”™
    if yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(lambda x: isinstance(x, pd.Series)).any():
        print("âš ï¸ æ£€æµ‹åˆ° 'å¤šèµ„äº§å“ç±»' åˆ—ä¸­å­˜åœ¨ Series å€¼ï¼Œå·²è‡ªåŠ¨å–ç¬¬ä¸€ä¸ªéç©ºå…ƒç´ ä»¥ç¡®ä¿åˆå¹¶æ­£å¸¸è¿›è¡Œã€‚")
        yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(
            lambda s: s.dropna().iloc[0] if isinstance(s, pd.Series) and len(s.dropna()) > 0 else (np.nan if isinstance(s, pd.Series) else s)
        )
    yunzuogailan_before_v2 = yunzuogailan_before_v2.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True,
                                                          how='left')

    # è¾“å‡ºåªä¿ç•™æ¯äº§å“ä»£ç çš„å¦åšå¤‡ç”¨
    yunzuogailan_export = yunzuogailan_before_v2[yunzuogailan_before_v2['äº§å“ç®€ç§°'].map(lambda x: '(å­' not in x)]
    # yunzuogailan_export['20231231å‡€å€¼']=yunzuogailan_export['æ¯äº§å“ä»£ç '].map(lambda x:data_transposition.loc['2023/12/31',x] if x in data_transposition.columns else np.nan)
    keep_col_here = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',
                     'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–',
                     'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥',
                     'å‘¨æœŸå¤©æ•°', 'æ˜¯å¦æ‹›å•†', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ¯åˆ†ç±»']
    yunzuogailan_export = yunzuogailan_export[keep_col_here]
    yunzuogailan_export.drop_duplicates().to_excel(Config.get_overview_parent_file(yunzuogailan_date))
    # yunzuogailan_before_v2.drop_duplicates().to_excel(Underlying_data_folder_path+'/äº§å“è¿ä½œæ¦‚è§ˆä¿¡æ¯è¡¨.xlsx')
    yzgl = yunzuogailan_before_v2.drop_duplicates().copy()
    yzgl_lastw = pd.read_excel(Config.get_overview_history_file(lastw), index_col=0)
    yzgl_lastm = pd.read_excel(Config.get_overview_history_file(lastm), index_col=0)
    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastw['ç»„åˆä¹…æœŸ']
    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['æ æ†'] - yzgl_lastw['æ æ†']
    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastw['æƒç›Šä»“ä½']
    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastm['ç»„åˆä¹…æœŸ']
    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['æ æ†'] - yzgl_lastm['æ æ†']
    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastm['æƒç›Šä»“ä½']  ###è°ƒæ•´é¡ºåº
    mu_col=['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', '5%æµåŠ¨æ€§å®é™…æŒ‡æ ‡', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ç´¯è®¡å¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'æ æ†',
       'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'è¡ç”Ÿå“ä»“ä½', 'è¿ä½œå¤©', 'å‰©ä½™å¤©','äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'é”€å”®è´¹',
       'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'æ¯äº§å“ä»£ç ', 'å¸ç§', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å½¢æ€', 'å‘¨æœŸå¤©æ•°',
       'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ˜¯å¦æ‹›å•†', 'æ¸ é“æ˜ç»†', 'æ¯å­æ ‡å¿—', 'ä¸»è¦å±•ç¤º', 'æ¯åˆ†ç±»', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨',
       'æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨', 'æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ', 'æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ', 'æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ']
    yzgl[mu_col].to_excel(Config.get_overview_history_file(yunzuogailan_date))
    print("åŸºäºä»…æ¯äº§å“çš„è¡¨ æ›´æ–°å“ç±»æ¸…å•åé‡è·‘")
get_yunzuogailan(yunzuogailan_date)

yunzuogailan_all = pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)
Channel_df = pd.read_excel(Config.get_weekly_data_file('å„æ¸ é“ä¿æœ‰é‡'), index_col=0)
date = zhoubao_date
# 1.åŒ¹é…å“ç±»
# åŒ¹é…å¶è€å¸ˆçš„å“ç±»
classification_df = pd.read_excel(
    Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),
    sheet_name='å¤šèµ„äº§å“ç±»æ ‡ç­¾',
    index_col='æ¯äº§å“ä»£ç '
)
# å¤„ç†é‡å¤æ¯äº§å“ä»£ç ï¼Œç¡®ä¿åç»­æ˜ å°„ä¸ºæ ‡é‡
classification_df = classification_df[~classification_df.index.duplicated(keep='first')]
classification_ye = classification_df['å¤šèµ„äº§å“ç±»']

writer = pd.ExcelWriter(Config.get_current_output_writer(date))


# Channel_result1.to_excel(writer,sheet_name='1ã€åˆ†æ¸ é“ä½™é¢')
# Channel_result2.to_excel(writer,sheet_name='æ¸ é“æ˜ç»†')

# æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“
def del_Innovation_department(mid_df):
    mid_df = mid_df[mid_df['å¤šèµ„äº§å“ç±»'].map(
        lambda x: x not in ['ç»“æ„æ€§ç†è´¢R2+', 'ç»“æ„æ€§ç†è´¢R3', 'ç»“æ„æ€§ç†è´¢R4', 'é‡åŒ–ç³»åˆ—', 'é‡åŒ–ç³»åˆ—(*)'])]
    mid_df = mid_df[mid_df['äº§å“ç»ç†'].map(
        lambda x: np.sum([k not in ['ç‹æµ©', 'å¼ é›…å©•', 'å­™æ–°å', ''] for k in x.split(',')]) != 0)]
    return mid_df


# åŒ¹é…ç†è´¢äº§å“çš„å­—æ¯ä»£ç 
Channel_df['æ¯äº§å“ä»£ç '] = Channel_df['äº§å“ç®€ç§°'].map(
    lambda x: Channel_df[Channel_df['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0])
Channel_df['å¤šèµ„äº§å“ç±»'] = Channel_df['æ¯äº§å“ä»£ç '].map(
    lambda x: classification_ye[x] if x in classification_ye.index else np.nan)
Channel_df = Channel_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')
Channel_df = Channel_df[~pd.isnull(Channel_df['äº§å“ç»ç†'])]  # ä»…ä¿ç•™æˆ‘éƒ¨äº§å“(ä¸è¿ä½œæ¦‚è§ˆåŒæ¸…å•)
# æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“
Channel_df = del_Innovation_department(Channel_df)
# 2.ä»…ä¿ç•™å­äº§å“dfï¼ˆæ¸ é“ä¿¡æ¯è¡Œï¼‰
# éƒ¨åˆ†å­äº§å“çš„æ¸ é“åç§°ä¸º'-â€™ï¼Œæ˜¯å› ä¸ºå…¶ä¸‹è¿˜å¯ä»¥è¿›ä¸€æ­¥å±•å¼€
# å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ¯äº§å“éƒ½æ˜¯â€˜-â€™ï¼Œå› ä¸ºè¿˜æœ‰æ¯äº§å“ä¸å«å­äº§å“ï¼Œé‚£æ¯äº§å“æœ¬èº«å°±æ˜¯æ¸ é“æ•°æ®ï¼Œæ‰€ä»¥ä¸èƒ½åˆ é™¤æ‰€æœ‰æ¯äº§å“
Channel_df_subproduct = Channel_df[Channel_df['æ¸ é“åç§°'] != '-']
Channel_df_subproduct['æ¸ é“-è¡Œå†…å¤–'] = Channel_df_subproduct['æ¸ é“åç§°'].map(
    lambda x: 'è¡Œå†…' if x == 'å…´ä¸šé“¶è¡Œ' else 'è¡Œå¤–')
# åŒ¹é…å¶è€å¸ˆçš„å­æ¯åˆ†ç±»å…³ç³»
Parent_sort = pd.read_excel(
    Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),
    sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»',
    index_col=0
)[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]
# å»é‡ï¼Œç¡®ä¿ç´¢å¼•ï¼ˆå¤šèµ„äº§å“ç±»ï¼‰å”¯ä¸€
Parent_sort = Parent_sort[~Parent_sort.index.duplicated(keep='first')]
Channel_df_subproduct = Channel_df_subproduct.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')



def rank_by_sort(my_df, rank_def):
    my_df = my_df.copy()
    # å®é™…å‡ºç°çš„ç´¢å¼•é›†åˆ
    actual = list(my_df.index)
    # æ„é€ æ–°çš„æ’åºé¡ºåºï¼šå…ˆæ”¾åœ¨ rank_def ä¸­ä¸”å®é™…å‡ºç°çš„ï¼Œå†æ”¾å…¶ä½™å®é™…å‡ºç°ä½†ä¸åœ¨ rank_def çš„
    new_order = [x for x in rank_def if x in actual] + [x for x in actual if x not in rank_def]
    # ä¾æ® new_order ç”Ÿæˆæ’åºé”®
    order_map = {val: i for i, val in enumerate(new_order)}
    my_df['__order__'] = my_df.index.map(order_map).fillna(len(new_order))
    my_df = my_df.sort_values('__order__').drop(columns='__order__')
    return my_df



# å¯¹indexæ–‡æœ¬æŒ‰ç…§æŒ‡å®šé¡ºåºæ’åº
rank_here = [('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³äº«çŸ­æŒ'),
             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³/çº¯äº«'),
             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¼˜å…ˆè‚¡çŸ­æŒ'),
             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¸°åˆ©/å¢ç›ˆ'),
             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'è¡Œå¤–éæ ‡é©±åŠ¨å‹å›ºæ”¶+'),
             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å’Œç‘BOF'),
             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€'),
             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'é€¸åŠ¨çŸ­æŒ'),
             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'çµåŠ¨çŸ­æŒ'),
             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å…´åŠ¨çŸ­æŒ'),
             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å«æƒå®šå¼€/å°é—­'),
             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'ESGè”å'),
             ('å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),
             ('å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼'), ]

# æ”¹æˆæ•°æ®é€è§†è¡¨çš„é‚£ç§æ ¼å¼
Channel_result1 = pd.pivot_table(Channel_df_subproduct, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ¸ é“-è¡Œå†…å¤–',
                                 values=['ä¿æœ‰è§„æ¨¡'], aggfunc=np.sum) / 100000000  # æ•°æ®é€è§†
Channel_result1 = rank_by_sort(Channel_result1, rank_here)
Channel_result2 = pd.pivot_table(Channel_df_subproduct, index=['æ¸ é“åç§°'], columns='æ€»åˆ†ç±»', values=['ä¿æœ‰è§„æ¨¡'],
                                 aggfunc=np.sum) / 100000000
Channel_result2['åˆè®¡'] = Channel_result2.sum(axis=1)
Channel_result2 = Channel_result2.sort_values('åˆè®¡', ascending=False)  # åº•è¡¨æŒ‰ç…§åˆè®¡è§„æ¨¡æ’åº
Channel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šæœˆ', '')] = Channel_result2[('åˆè®¡', '')] - \
                                         pd.read_excel(Config.get_output_result_file(lastm), sheet_name='æ¸ é“æ˜ç»†',
                                                       index_col=0, skiprows=[1, 2])['åˆè®¡']
Channel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šå¹´', '')] = Channel_result2[('åˆè®¡', '')] - \
                                         pd.read_excel(Config.get_output_result_file(lasty), sheet_name='æ¸ é“æ˜ç»†',
                                                       index_col=0, skiprows=[1, 2])['åˆè®¡']
Channel_result1.to_excel(writer, sheet_name='1ã€åˆ†æ¸ é“ä½™é¢')
Channel_result2.to_excel(writer, sheet_name='æ¸ é“æ˜ç»†')

now = zhoubao_date
# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°
yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))
yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))
yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))

lastm_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - get_scaleandnum_by_sort(yunzuogailan_lastm)
lastm_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«']
lasty_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - full_category_or_not(
    get_scaleandnum_by_sort(yunzuogailan_lasty), rank_here).fillna(0)
lasty_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']

cols = ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']
result_3 = pd.concat([get_scaleandnum_by_sort(yunzuogailan_now), lastm_delta_df, lasty_delta_df], axis=1)[cols]
result_3[['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']] = result_3[
    ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']].applymap(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)
result_3 = rank_by_sort(result_3, rank_here)
result_3[cols].to_excel(writer, sheet_name='2ã€äº§å“è§„æ¨¡')

# ï¼æ³¨ï¼šæˆ˜æŠ¥åº•è¡¨æ—¥æœŸéœ€è¦æ›´æ–°
# month_now='2024-10'
data_zhanbao = zhoubao_date  # å¯ä¿®æ”¹æˆ˜æŠ¥æ—¥æœŸ
zhanbao_df = pd.read_excel(Config.get_weekly_data_file('æˆ˜æŠ¥åº•è¡¨(v2)'), index_col=0)
zhanbao_df = zhanbao_df[zhanbao_df['è§„æ¨¡ç±»å‹-ç®€åŒ–'] == 'é”€é‡']

# æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“
if 'äº§å“ç»ç†' not in zhanbao_df.columns:
    zhanbao_df = zhanbao_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')
zhanbao_df.rename(columns={'å“ç±»': 'å¤šèµ„äº§å“ç±»'}, inplace=True)
# å¯¹äº§å“ç»ç†ä¸æ˜¯ç©ºçš„,åˆ¤æ–­æ˜¯å¦æ˜¯æˆ‘éƒ¨çš„äº§å“
zhanbao_df_1 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: not pd.isnull(x))]
zhanbao_df_1 = del_Innovation_department(zhanbao_df_1)
zhanbao_df_2 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: pd.isnull(x))]
zhanbao_df = pd.concat([zhanbao_df_1, zhanbao_df_2])

# æ¯äº§å“ä»£ç å’Œç®€ç§°ä¸ºç©ºçš„ï¼Œæ›¿æ¢ä¸ºå­äº§å“ä»£ç å’Œç®€ç§°
zhanbao_df['æ¯äº§å“ä»£ç '] = zhanbao_df.apply(lambda x: x.name if pd.isnull(x['æ¯äº§å“ä»£ç ']) else x['æ¯äº§å“ä»£ç '], axis=1)
zhanbao_df['æ¯äº§å“ç®€ç§°'] = zhanbao_df.apply(lambda x: x['äº§å“ç®€ç§°'] if pd.isnull(x['æ¯äº§å“ç®€ç§°']) else x['æ¯äº§å“ç®€ç§°'],
                                            axis=1)

kaifang_df = zhanbao_df[
    (zhanbao_df['å½¢æ€'] == 'å®¢æˆ·å‘¨æœŸ') | (zhanbao_df['å½¢æ€'] == 'æœ€çŸ­æŒæœ‰æœŸ') | (zhanbao_df['å½¢æ€'] == 'å®šå¼€') | (
                zhanbao_df['å½¢æ€'] == 'æ—¥å¼€')]
# æŒ‰æ¯äº§å“æ±‡æ€»
kaifang_df = kaifang_df.groupby('æ¯äº§å“ä»£ç ').agg(
    {'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first', 'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum',
     'äº§å“ç»ç†': 'first'})
# å»æ‰å˜åŠ¨å°äº500wçš„äº§å“-å¯èƒ½æ˜¯å‡€å€¼å˜åŒ–é€ æˆï¼Œä»…çœ‹å¤§çš„
kaifang_df = kaifang_df[kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(lambda x: abs(x) >= 0.05)]

kaifang_df.sort_values(by='è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', ascending=False, inplace=True)
kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'] = kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)
# kaifang_df['æŠ•èµ„ç»ç†']=[yunzuogailan_all.loc[x,'äº§å“ç»ç†'] for x in kaifang_df.index] #ä»£ç åŠŸèƒ½å†™é‡äº†
# å»æ‰å°é—­åˆ°æœŸçš„
kaifang_df = kaifang_df[kaifang_df['æ¯å“ç±»'] != 'å°é—­åˆ°æœŸ']
kaifang_df.to_excel(writer, sheet_name='3ã€æœ¬â½‰å®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–')

yunzuogailan_date = zhoubao_date
xinfa_thisweek_df = zhanbao_df[zhanbao_df['èµ·æ¯æ—¥'] >= week_Mon]
# å«æœ‰å¾…èµ·æ¯äº§å“çš„è¿ä½œæ¦‚è§ˆ
yunzuogailan_original = pd.read_excel(Config.get_weekly_data_file('äº§å“è¿ä½œæ¦‚è§ˆ'), index_col=0)
# åŒ¹é…ç†è´¢äº§å“çš„å­æ¯ä»£ç 
yunzuogailan_original['æ¯äº§å“ä»£ç '] = yunzuogailan_original['äº§å“ç®€ç§°'].map(
    lambda x: yunzuogailan_original[yunzuogailan_original['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0])
yunzuogailan_original = yunzuogailan_original[['äº§å“ç®€ç§°', 'æ¯äº§å“ä»£ç ', 'äº§å“ç»ç†']].drop_duplicates()

# åŒ¹é…æ–°å‘äº§å“çš„æ¯äº§å“ä»£ç ï¼Œå¦‚æœæ²¡æœ‰ç”¨å­äº§å“ä»£ç æ›¿ä»£
for mid_ind in xinfa_thisweek_df.index:
    if mid_ind in yunzuogailan_original.index:
        mother_indx = yunzuogailan_original.loc[mid_ind, 'æ¯äº§å“ä»£ç ']
        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mother_indx
        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç®€ç§°']
        xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç»ç†'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç»ç†']
    else:
        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mid_ind
        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç®€ç§°']

xinfa_thisweek_qudao = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ', 'æ¸ é“-ç®€åŒ–']).agg(
    {'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first', 'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum',
     'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'})
xinfa_thisweek_sum = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ']).agg(
    {'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first', 'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum',
     'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'})

# å•ç‹¬åˆ—ç¤ºè¡Œå†…è¡Œå¤–çš„è§„æ¨¡å€¼
for mid_ind in xinfa_thisweek_sum.index:
    if (mid_ind, 'è¡Œå†…') in xinfa_thisweek_qudao.index:
        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå†…(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå†…'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']
    if (mid_ind, 'è¡Œå¤–') in xinfa_thisweek_qudao.index:
        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå¤–(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå¤–'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']

# å½“æœ¬å‘¨æ— æ–°å‘äº§å“æ—¶ï¼Œxinfa_thisweek_sum å¯èƒ½ä¸ºç©ºæˆ–ç¼ºå°‘æŒ‡å®šåˆ—ï¼Œå…ˆåšå®‰å…¨å¤„ç†
if xinfa_thisweek_sum.empty:
    # åˆ›å»ºä¸€ä¸ªç©ºè¡¨ä½†ä¿ç•™å¿…è¦åˆ—ï¼Œé˜²æ­¢åç»­æŠ¥é”™
    result_3_2_df = pd.DataFrame(columns=['æ¯äº§å“ç®€ç§°', 'é”€é‡(äº¿)', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',
                                          'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'])
else:
    # ä»…ä¿ç•™å®é™…å­˜åœ¨çš„åˆ—
    keep_columns_xinfa = ['æ¯äº§å“ç®€ç§°', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»', 'æ¯å“ç±»', 'èµ·æ¯æ—¥',
                          'æˆ˜æŠ¥åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†']
    # å–äº¤é›†ï¼Œé¿å… KeyError
    cols_available = [c for c in keep_columns_xinfa if c in xinfa_thisweek_sum.columns]
    xinfa_thisweek_sum = xinfa_thisweek_sum[cols_available].copy()
    xinfa_thisweek_sum.rename(columns={'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'é”€é‡(äº¿)', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'åˆ°æœŸæ—¥'}, inplace=True)
    result_3_2_df = xinfa_thisweek_sum[xinfa_thisweek_sum['é”€é‡(äº¿)'] != 0]
    result_3_2_df.sort_values(by='èµ·æ¯æ—¥', ascending=True, inplace=True)

result_3_2_df.to_excel(writer, sheet_name='æœ¬å‘¨æ–°å‘äº§å“')
# xinfa_thisweek_sum[xinfa_thisweek_sum['é”€é‡(äº¿)']!=0].to_excel('test1.xlsx',sheet_name='3ã€æœ¬å‘¨æ–°å‘äº§å“')

product_tosale_df = pd.read_excel(Config.get_weekly_data_file('ç†è´¢äº§å“åŒºé—´åœ¨å”®å¾…å”®æƒ…å†µè¡¨'), index_col=0, skiprows=1)
product_tosale_df = product_tosale_df.merge(Product_information_df_DAP['æ¯äº§å“æŠ•èµ„ç»ç†'], left_index=True,
                                            right_index=True, how='left')
first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦','æä½³èˆª',"è‹æ–‡æ´¥","å¤å‡¡ç››","é»„äº¦å°§"]
second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ',"ç½—è°¨æ·±"]
third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°','å»–ç‚¯è‡£']


def manager_in_or_not(s: str, y: list):
    if pd.isnull(s):
        return False
    else:
        for mid_y in y:
            if mid_y in s:
                return True
        return False


product_tosale_df_new = product_tosale_df[
    product_tosale_df['æ¯äº§å“æŠ•èµ„ç»ç†'].map(lambda x: manager_in_or_not(x, first + second + third))]
date_here = zhoubao_date[:4] + '-' + zhoubao_date[4:6] + '-' + zhoubao_date[6:]
product_tosale_df_final = product_tosale_df_new[product_tosale_df_new['æˆç«‹æ—¥'] > date_here]
product_tosale_df_final.drop_duplicates(inplace=True)
keep_columns = ['æ¯å­äº§å“æ ‡è¯†', 'äº§å“ç®€ç§°', 'äº§å“å¼€æ”¾å½¢å¼', 'å‹Ÿé›†æœŸ(èµ·)', 'å‹Ÿé›†æœŸ(æ­¢)',
                'æˆç«‹æ—¥', 'åˆ°æœŸæ—¥', 'è§„æ¨¡ä¸Šé™(äº¿)', 'é”€å”®å¸ç§']
# product_tosale_df_final[keep_columns].to_excel('test.xlsx')
product_tosale_df_final_v1 = product_tosale_df_final[keep_columns]
product_tosale_df_final_v2 = product_tosale_df_final_v1[product_tosale_df_final_v1.apply(lambda x: False if ( \
                                                                                                                        x[
                                                                                                                            'äº§å“ç®€ç§°'] in
                                                                                                                        product_tosale_df_final_v1[
                                                                                                                            'äº§å“ç®€ç§°']) and (
                                                                                                                        x[
                                                                                                                            'æ¯å­äº§å“æ ‡è¯†'] == 'æ¯äº§å“') else True,
                                                                                         axis=1)]
product_tosale_df_final_v2.sort_values(by='æˆç«‹æ—¥', ascending=True, inplace=True)
product_tosale_df_final_v2.to_excel(writer, sheet_name='å¾…å”®äº§å“')

# å¤šèµ„äº§äº§å“ç›‘æ§
start_date = ''  # æ•°æ®åŒºé—´å¼€å§‹ï¼Œå¯é€‰â€œâ€æˆ–è€…'2024-10-16'
end_date = ''  # æ•°æ®æˆªæ­¢æ—¶é—´ï¼Œå¯é€‰â€œâ€æˆ–è€…'2024-04-15'
# ä½¿ç”¨é…ç½®çš„æ•°æ®ç›®å½•ï¼Œä¸å†ä½¿ç”¨ç¡¬ç¼–ç è·¯å¾„
# path='/Users/fanshengxia/Desktop/å‘¨æŠ¥/2.å¤šèµ„äº§äº§å“ç›‘æ§'

data_transposition.replace(0, np.nan, inplace=True)
if start_date == "":
    data_transposition_here = data_transposition
else:
    data_transposition_here = data_transposition.loc[start_date:]

if end_date == "":
    data_transposition_here.apply(performance_calculate_optimize).T.to_excel(Config.get_performance_file(zhoubao_date))
    print('æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.index[-1]))
else:
    data_transposition_here.loc[:end_date].apply(performance_calculate_optimize).T.to_excel(
        Config.get_performance_file(end_date))
    print('æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.loc[:end_date].index[-1]))

# now='20241024'
Parent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[
    ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]


# yunzuogailan_now=del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now),index_col=0))


# æœ€çŸ­æŒæœ‰æœŸäº§å“ç”¨Aä»½é¢æ›¿ä»£
year_col = f"{int(str(zhoubao_date)[:4])}å¹´å¹´åŒ–æ”¶ç›Šç‡"
def weighted_avg(group):
    w_fields = [
        'ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡',
        'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡'
    ]
    results = {}

    for field in w_fields:
        # ä»…ä¿ç•™è¯¥å­—æ®µä¸ä¸ºç©ºçš„è¡Œ
        mask = group[field].notna()
        if mask.any():  # è‡³å°‘æœ‰ä¸€ä¸ªæœ‰æ•ˆæ ·æœ¬
            weight_valid = group.loc[mask, 'å‡€èµ„äº§(äº¿)']
            total_weight = weight_valid.sum()
            results[field] = (
                    (group.loc[mask, field] * weight_valid).sum() / total_weight
            )
        else:  # å…¨éƒ¨ä¸ºç©ºï¼Œè¿”å› NaN
            results[field] = np.nan

    return pd.Series(results)
yunzuogailan_all = del_Innovation_department(
    pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0))

# ç­›é€‰æŒæœ‰æœŸå’Œå…¶ä»–äº§å“
to_merge_chiyouqi_code = yunzuogailan_all[
    yunzuogailan_all.apply(lambda x: (x['ä¸»è¦å±•ç¤º'] == 'æ˜¯') & (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']), axis=1)]
to_merge_other_code = yunzuogailan_all[
    yunzuogailan_all.apply(lambda x: (x['æ¯å­æ ‡å¿—'] in ['éæ¯å­äº§å“', 'æ¯äº§å“']) & (x['å½¢æ€'] in ['å°é—­', 'å®šå¼€']),
                           axis=1)]
yunzuogailan_now = pd.concat([to_merge_chiyouqi_code, to_merge_other_code])

# è·å–æ”¶ç›Šç‡å’Œæ³¢åŠ¨ç‡æ•°æ®
keep_cols = ['è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']
yunzuogailan_now_5 = yunzuogailan_now.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
perf_df = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0)
keep_cols = [c for c in keep_cols if c in perf_df.columns]
yunzuogailan_now_ret = yunzuogailan_now_5.merge(
    perf_df[keep_cols],
    left_index=True, right_index=True, how='left')
yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'] = yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'].map(
    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x)

# å¯¹è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡ä¸º0æˆ–ç¼ºå¤±çš„äº§å“ï¼Œç”¨æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡æ›¿ä»£
yunzuogailan_now_ret['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] = yunzuogailan_now_ret.apply(
    lambda row: row['ç´¯è®¡å¹´åŒ–'] if (pd.isna(row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡']) or row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] == 0) else row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'],
    axis=1
)

# è®¡ç®—è´¹åå¹³å‡
result_5 = yunzuogailan_now_ret[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + ['ç´¯è®¡å¹´åŒ–'] + keep_cols].groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()[
    ['ç´¯è®¡å¹´åŒ–'] + keep_cols]
result_5 = rank_by_sort(result_5, rank_here)
result_5.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹åå¹³å‡')

# è®¡ç®—è´¹ååŠ æƒ
result_5_weight = yunzuogailan_now_ret.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)
result_5_weight = rank_by_sort(result_5_weight, rank_here)
result_5_weight.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹ååŠ æƒ')

# è®¡ç®—è´¹å‰æ•°æ®
yunzuogailan_add_fee = yunzuogailan_now_ret.copy()
w_field = ['ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']
yunzuogailan_add_fee[w_field] = yunzuogailan_add_fee[w_field].add(
    yunzuogailan_add_fee[['é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹']].sum(axis=1), axis=0)

# è®¡ç®—è´¹å‰åŠ æƒ
result_series_performance = yunzuogailan_add_fee.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)
result_series_performance = rank_by_sort(result_series_performance, rank_here)
result_series_performance.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰åŠ æƒ')

# è®¡ç®—è´¹å‰å¹³å‡
result_series_performance_average = yunzuogailan_add_fee[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + w_field + ['è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']].groupby(
    ['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()
result_series_performance_average = rank_by_sort(result_series_performance_average, rank_here)
result_series_performance_average.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰å¹³å‡')
# ç­›é€‰æŒæœ‰æœŸäº§å“ï¼Œä¸åŒ…å«å¤–å¸
yunzuogailan_now_ret_chiyouqi = yunzuogailan_now_ret[yunzuogailan_now_ret.apply(
    lambda x: (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']) and (x['æ¯åˆ†ç±»'] in ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€']),
    axis=1)]
yunzuogailan_now_ret_chiyouqi.rename(columns={'ç´¯è®¡å¹´åŒ–': 'æˆç«‹ä»¥æ¥å¹´åŒ–', year_col: 'ä»Šå¹´ä»¥æ¥å¹´åŒ–'},
                                     inplace=True)

# æœ±è€å¸ˆçš„æ‚¦åŠ¨ç¨³äº«9M281010å•ç‹¬å¤„ç†ï¼Œæ¯äº§å“ä¸šç»©æœ‰è¯¯
yunzuogailan_now_ret_chiyouqi.loc[
    '9M281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡',
                 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']] = \
    pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0).loc[
        '9A281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡',
                     year_col]].values

# 2024å¹´åæˆç«‹çš„ï¼Œä»Šå¹´ä»¥æ¥å¹´åŒ–ä¸ºç©ºï¼Œç”¨æˆç«‹ä»¥æ¥å¹´åŒ–æ›¿ä»£
yunzuogailan_now_ret_chiyouqi['ä»Šå¹´ä»¥æ¥å¹´åŒ–'] = yunzuogailan_now_ret_chiyouqi.apply(
    lambda x: x['æˆç«‹ä»¥æ¥å¹´åŒ–'] if pd.isnull(x['ä»Šå¹´ä»¥æ¥å¹´åŒ–']) else x['ä»Šå¹´ä»¥æ¥å¹´åŒ–'], axis=1)


def get_Scale_weighting_ret(my_df):
    keep_ret_cols = ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']
    ret_sum_df = (my_df[keep_ret_cols].multiply(my_df['å‡€èµ„äº§(äº¿)'], axis="index")).sum()
    scale_sum_df = ((my_df[keep_ret_cols] / my_df[keep_ret_cols]).multiply(my_df['å‡€èµ„äº§(äº¿)'], axis="index")).sum()
    return ret_sum_df / scale_sum_df


result_df_52 = yunzuogailan_now_ret_chiyouqi.groupby('æ¯åˆ†ç±»').apply(get_Scale_weighting_ret)
result_df_52.rename(index={'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€': 'æ‚¦åŠ¨çŸ­æŒ'}, inplace=True)
rank_chiyouqi = ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ']
rank_by_sort(result_df_52, rank_chiyouqi).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°1')


# rank_by_sort(result_df_52,rank_chiyouqi).to_excel('test.xlsx',sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°1')

def get_zhouqi_scale_v2(x):
    if x == 1:
        return 'æ—¥ç›ˆ'
    elif x < 30:
        return '<1M'
    elif x < 31 * 3:
        return '1M-3M'
    elif x < 31 * 6:
        return '3M-6M'
    elif x < 12 * 31:
        return '6M-1Y'
    elif x >= 12 * 31:
        return '>1Y'
    else:
        return 'error'


yunzuogailan_now_ret_chiyouqi['æŒæœ‰æœŸæ ‡ç­¾'] = yunzuogailan_now_ret_chiyouqi['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale_v2)
yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'] = yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'].map(
    lambda x: 'æ‚¦åŠ¨çŸ­æŒ' if x == 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€' else x)
result_df_52_3 = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾']).apply(get_Scale_weighting_ret)
result_df_52_3['æ•°é‡'] = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾'])['äº§å“ç®€ç§°'].count()
rank_chiyouqi_v3 = [('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '<1M'),
                    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '1M-3M'),
                    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '3M-6M'),
                    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '6M-1Y'),
                    ('æ‚¦åŠ¨çŸ­æŒ', '<1M'),
                    ('æ‚¦åŠ¨çŸ­æŒ', '1M-3M'),
                    ('æ‚¦åŠ¨çŸ­æŒ', '3M-6M'),
                    ('æ‚¦åŠ¨çŸ­æŒ', '6M-1Y'),
                    ('ä¼˜å…ˆè‚¡çŸ­æŒ', '1M-3M')]
rank_by_sort(result_df_52_3, rank_chiyouqi_v3).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°2')
# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°
now = zhoubao_date
# lastm='20250228'  è·Ÿç€ä¸Šé¢ä¸€èµ·æ”¹äº†
# lasty='20241231'  è·Ÿç€ä¸Šé¢ä¸€èµ·æ”¹äº†
yunzuogailan_now = del_Innovation_department(pd.read_excel( \
    Config.get_overview_parent_file(now), index_col=0))
yunzuogailan_lastw = del_Innovation_department(pd.read_excel( \
    Config.get_overview_parent_file(lastw), index_col=0))
yunzuogailan_lastm = del_Innovation_department(pd.read_excel( \
    Config.get_overview_parent_file(lastm), index_col=0))
yunzuogailan_lasty = del_Innovation_department(pd.read_excel( \
    Config.get_overview_parent_file(lasty), index_col=0))

first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦','æä½³èˆª',"è‹æ–‡æ´¥","å¤å‡¡ç››","é»„äº¦å°§"]
second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ',"ç½—è°¨æ·±"]
third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°','å»–ç‚¯è‡£']

manager_belong_to = {'æŠ•èµ„ç»ç†å§“å': 'å¤„å®¤', }
team = ['ä¸€å¤„', 'äºŒå¤„', 'å¤–å¸']
team_list = [first, second, third]
for i in range(len(team)):
    for name_here in team_list[i]:
        manager_belong_to[name_here] = team[i]

Parent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[
    ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]


# åˆ é™¤éæˆ‘éƒ¨é—¨æŠ•èµ„ç»ç†
def clear_manager_name(s: str):
    merge_s = []
    for mid_s in s.split(','):
        #         if mid_s in first+second+third+quant:
        if mid_s in first + second + third:
            merge_s.append(mid_s)
    return ','.join(merge_s)


# æœ‰å¤šä¸ªæŠ•èµ„ç»ç†å…±åŒç®¡ç†çš„æ•°æ®ï¼Œè¦å¤åˆ¶ä¸€æ¡æ•°æ®ç»™æ¯ä¸ªæŠ•èµ„ç»ç†ï¼Œè§„æ¨¡å’Œä¸ªæ•°å‡åŠ
def adjust_manager_aum(mid_data):
    import pandas as pd  # Ensure pandas is imported

    final_mid_data = mid_data.copy()
    final_mid_data['åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data['å‡€èµ„äº§(äº¿)']
    final_mid_data['åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1

    # Create a list to store new rows
    new_rows = []

    for indx in mid_data.index:
        mng_list = mid_data.loc[indx, 'äº§å“ç»ç†'].split(',')
        if len(mng_list) > 1:
            i = 0
            for mng in mng_list:
                if i == 0:
                    final_mid_data.loc[indx, 'äº§å“ç»ç†'] = mng
                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] / 2
                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1 / len(mng_list)
                    i += 1
                else:
                    mid_series = final_mid_data.loc[indx].copy()
                    mid_series['äº§å“ç»ç†'] = mng
                    # Instead of append, we'll collect new rows and concat later
                    new_rows.append(pd.DataFrame(mid_series).T)

    # If we have new rows, concatenate them to the original dataframe
    if new_rows:
        final_mid_data = pd.concat([final_mid_data] + new_rows, ignore_index=False)

    return final_mid_data


# åŒ¹é…å­æ¯åˆ†ç±»å…³ç³»+å¯¹æŠ•èµ„ç»ç†è¿›è¡Œå¤„ç†
def get_scaleandnum_by_sort_manager(my_df):
    Parent_sort = \
    pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[
        ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]
    my_df = my_df.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
    my_df['äº§å“ç»ç†'] = my_df['äº§å“ç»ç†'].map(clear_manager_name)

    return adjust_manager_aum(my_df)


result_now = get_scaleandnum_by_sort_manager(yunzuogailan_now).groupby('äº§å“ç»ç†').agg(
    {'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'})

rikai_now = get_scaleandnum_by_sort_manager(yunzuogailan_now)
rikai_now = rikai_now[rikai_now['å½¢æ€'].map(lambda x: x in ['æ—¥å¼€', 'å®¢æˆ·å‘¨æœŸ', 'æœ€çŸ­æŒæœ‰æœŸ'])].groupby('äº§å“ç»ç†').agg(
    {'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'})
rikai_now.rename(columns={'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'}, inplace=True)
result_df_here = []
cols_to_append = ['-è¾ƒä¸Šå‘¨', '-è¾ƒä¸Šæœˆæœ«', '-è¾ƒä¸Šå¹´æœ«']
for i in range(3):
    mid_df = [yunzuogailan_lastw, yunzuogailan_lastm, yunzuogailan_lasty][i]
    result_df_i = result_now - get_scaleandnum_by_sort_manager(mid_df).groupby('äº§å“ç»ç†').agg(
        {'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'})
    result_df_i.columns = [x + cols_to_append[i] for x in ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°']]
    result_df_here.append(result_df_i)

result_df_here = pd.concat([result_now] + result_df_here + [rikai_now], axis=1)

cols_here = ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«',
             'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡',
             'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šæœˆæœ«',
             'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°']
indx_here = ['ä¸¥æ³“', 'å¾è¹', 'æ¨æ¼ ', 'é«˜ç¿°æ˜†', 'å§œé”¡å³°', 'ä½™æ´é›…', 'è–›çºªæ™”', 'èƒ¡è‰³å©·', 'æœ±è½¶ä¼¦', 'ä»»é›',
             'å¼ ç‰æ°','å»–ç‚¯è‡£','æä½³èˆª',"è‹æ–‡æ´¥","å¤å‡¡ç››","é»„äº¦å°§","ç½—è°¨æ·±"]
result_df_here = result_df_here[cols_here]
result_df_here =result_df_here.dropna(axis=0,how='all')
result_df_here = rank_by_sort(result_df_here, indx_here)
result_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«',
                'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']] = result_df_here[
    ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«',
     'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']].applymap(lambda x: '{:.2f}'.format(x))
result_df_here.to_excel(writer, sheet_name='æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡')
# result_df_here.to_excel('test2.xlsx',sheet_name='æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡')

yunzuogailan_now_65 = yunzuogailan_now.copy()
yunzuogailan_now_65['å½¢æ€'] = yunzuogailan_now_65['å½¢æ€'].map(lambda x: 'æœ€çŸ­æŒæœ‰æœŸ' if x == 'å®¢æˆ·å‘¨æœŸ' else x)
yunzuogailan_now_65 = yunzuogailan_now_65.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True,
                                                how='left')
result_df_here_65 = pd.concat([pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€',
                                              values=['å‡€èµ„äº§(äº¿)'], aggfunc='count'), \
                               pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€',
                                              values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)], axis=1)
result_df_here_65.to_excel(writer, sheet_name='ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡')

# æ‹›å•†äº§å“åˆ—è¡¨
# æ”¹æˆå±•ç¤ºå­äº§å“
zhaoshang_product_list = list(set(Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'].index))
zhaoshang_product_df = yunzuogailan_all.loc[zhaoshang_product_list]


def get_yejijizhunxiaxian(x: str):
    if not pd.isnull(x):
        try:
            float(x.split('-')[0][:-1])
            return x.split('-')[0]
        except ValueError:
            return ""
    else:
        return x


zhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'] = zhaoshang_product_df['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)

# è·å–è¶…é¢ä¸šç»©<0æ¸…å•
zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] = zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'].map(
    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x)  # çº¦å®šå¹´åŒ–çš„æ•°æ®ç±»å‹
zhaoshangfinal = zhaoshang_product_df[(zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] * 100 - zhaoshang_product_df[
    'ä¸šç»©åŸºå‡†ä¸‹é™'].map(lambda x: float(x[:-1]) if (x != "") & (not pd.isnull(x)) else -100)) < 0]
# åŒ¹é…æ‹›å•†è§„æ¨¡
zhaoshang_scale = Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸']['ä¿æœ‰è§„æ¨¡'] / 100000000
zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] = [zhaoshang_scale[ind] for ind in zhaoshangfinal.index]
# ä»…ä¿ç•™æˆç«‹å¤§äºä¸€æœˆçš„
zhaoshangfinal = zhaoshangfinal[zhaoshangfinal['è¿ä½œå¤©'] > 30]
zhaoshangfinal = zhaoshangfinal[zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] > 0.1]
zhaoshangfinal.sort_values('å‰©ä½™å¤©', ascending=True, inplace=True)  # åº•è¡¨æŒ‰ç…§å‰©ä½™å¤©æ’åº
zhaoshangfinal.to_excel(writer, sheet_name='æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†')
# zhaoshangfinal.to_excel('test.xlsx',sheet_name='æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†')

yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'] = yunzuogailan_all['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)
yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] = yunzuogailan_all['æœ¬æœŸå¹´åŒ–'].map(
    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x)  # çº¦å®šå¹´åŒ–çš„æ•°æ®ç±»å‹
yunzuogailan_all = yunzuogailan_all[(yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] * 100 - yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'].map(
    lambda x: float(x[:-1]) if (x != "") & (not pd.isnull(x)) else -100)) < 0]
bdjz_100 = yunzuogailan_all[(yunzuogailan_all['å½¢æ€'].isin(['å°é—­', 'å®šå¼€'])) & (yunzuogailan_all['å‰©ä½™å¤©'] < 100)]
bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = (bdjz_100['æœ¬æœŸå¹´åŒ–'] - (bdjz_100['ä¸šç»©åŸºå‡†ä¸‹é™'].str[:-1]).astype(
    float) / 100) * 10000
bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'].astype(int)
bdjz_100 =bdjz_100[bdjz_100['æ¯åˆ†ç±»'] !='å¤–å¸ä½æ³¢']  ##å‰”é™¤å¤–å¸äº§å“ ç³»ç»Ÿæ•°æ®ä¸å‡†ç¡®
bdjz_100.to_excel(writer, sheet_name='å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸å¤§ä¸šç»©äº§å“æ¸…å•')

date = zhoubao_date

date_lastw = lastw
date_lastm = lastm
date_lasty = lasty
excel_name = 'æŒä»“ç›ˆäºæ˜ç»†åˆ—è¡¨_' + date + '.xlsx'
yunzuogailan_all = pd.read_excel(Config.get_overview_history_file(date), index_col=0)
Chicang_df = pd.read_excel(os.path.join(Config.WEEKLY_DATA_DIR, excel_name))
Chicang_df.rename(columns={'èµ„äº§ç®€ç§°': 'å€ºåˆ¸ç®€ç§°'}, inplace=True)  ###æŒ‰ç…§è€çš„ç®€ç§°è®¡ç®—
Chicang_df.drop_duplicates(inplace=True)
Chicang_df = Chicang_df.merge(yunzuogailan_all['å¸ç§'], left_on='äº§å“ä»£ç ', right_index=True, how='left')
# äº§å“è®¡ä»·å•ä½ä¸ºç¾å…ƒçš„ï¼Œéœ€è¦è½¬æ¢æˆäººæ°‘å¸
# æ³¨ï¼šæˆ‘ä»¬pasç³»ç»Ÿçš„é€»è¾‘æ˜¯å±•ç¤ºæœ¬å¸è§„æ¨¡ï¼Œæœ¬å¸æ˜¯æŒ‡äº§å“çš„é”€å”®å•ä½/è®¡ä»·å•ä½ï¼Œç›®å‰ç¾å…ƒäº§å“åº•å±‚èµ„äº§åªæœ‰ç¾å…ƒèµ„äº§ï¼Œå±•ç¤ºè§„æ¨¡ä¸ºç¾å…ƒï¼›äººæ°‘å¸äº§å“åº•å±‚èµ„äº§ï¼Œç¾å…ƒçš„ä¼šè½¬æˆäººæ°‘å¸ï¼Œäººæ°‘å¸çš„ç›´æ¥å±•ç¤ºäººæ°‘å¸
EXchange_rate = w.wss("USDCNY.EX", "close", "tradeDate=20241229;priceAdj=U;cycle=D").Data[0][0]
Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.apply(
    lambda x: x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] * EXchange_rate if x['å¸ç§'] == 'ç¾å…ƒ' else x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'],
    axis=1)

# æš‚æ—¶ä»£ç â€”â€”æ–°åŸºé‡‘ç±»å‹äº’è®¤åŸºé‡‘å’ŒåŸºå‡†åšå¸‚åŸºé‡‘çš„'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'æ˜¯0ï¼Œä½†æ˜¯æœ‰æŒä»“æˆæœ¬å’ŒæŒæœ‰æœŸæ”¶ç›Šæ•°æ®ï¼Œæ‰€ä»¥æš‚æ—¶ç”¨äºŒè€…è®¡ç®—ä»£æ›¿
to_fill_indx = Chicang_df[Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] == 0].index
Chicang_df.loc[to_fill_indx, 'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.loc[to_fill_indx, 'æŒä»“æˆæœ¬(å…ƒ)'] + Chicang_df.loc[
    to_fill_indx, 'æŒæœ‰æœŸæ”¶ç›Š']
Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].fillna(0)

# è·å–èµ„äº§å‹¾ç¨½å…³ç³»å’Œä¿é™©èµ„ç®¡äº§å“
asset_classification_joint_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),
                                              sheet_name='èµ„äº§åˆ†ç±»å‹¾ç¨½å…³ç³»', index_col=0)
insurance_pdct_df = pd.read_excel(Config.get_weekly_data_file('ä¿é™©èµ„ç®¡è®¡åˆ’'), index_col=0)  # è¿‘7å¤©å¹´åŒ–æ”¶ç›Š
# åŒ¹é…èµ„äº§å°ç±»å’Œå‹¾ç¨½å…³ç³»ä¸‹çš„ä¸‰çº§åˆ†ç±»
Chicang_df = Chicang_df.merge(asset_classification_joint_df[['ç¼–å·', 'ä¸‰çº§åˆ†ç±»']], left_on='æ–°ç‰ˆèµ„äº§å°ç±»',
                              right_index=True, how='left')
# æ ‡è®°ä¿é™©èµ„ç®¡èµ„äº§
mid_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å°ç±»'] == 'å§”å¤–ç°é‡‘ç®¡ç†æŠ•èµ„']
insurance_pdct_name_list = list(insurance_pdct_df.index) + ['è‹±å¤§èµ„äº§-èšé‘«22å·', 'å¤§å®¶èµ„ç®¡ç¨³å¥ç²¾é€‰15å·']
insurance_pdct_indx = mid_df[mid_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in insurance_pdct_name_list)].index
Chicang_df.loc[insurance_pdct_indx, 'ç¼–å·'] = '1.2'
Chicang_df.loc[insurance_pdct_indx, 'ä¸‰çº§åˆ†ç±»'] = '1.2 ä¿é™©åè®®å­˜æ¬¾'
# ç»†åŒ–3.4-3.5ä¸­çš„åŸæŠ•å’Œæ°¸ç»­
# å•ç‹¬æå‡ºæ‰€æœ‰çš„å€ºåˆ¸æ•°æ®è·å–åŸæŠ•å’Œæ°¸ç»­ä¿¡æ¯
bond_set_df = pd.DataFrame(list(set(Chicang_df[Chicang_df['ç¼–å·'] == '3.4-3.5']['å¤–éƒ¨ä»£ç '])), columns=['å¤–éƒ¨ä»£ç '])

# è·å–windæ•°æ®â€”â€”æœ€å¥½ä¸è¦é‡å¤è·‘ï¼Œå¯ç”¨æ•°æ®é‡æœ‰é™
bond_code = ','.join(list(bond_set_df['å¤–éƒ¨ä»£ç '].values))
wind_result = pd.DataFrame(w.wss(bond_code, "municipalbondWind,  perpetualornot", "").Data).T
bond_set_df[['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­']] = wind_result.values
# é€šè¿‡åŸæŠ•å’Œæ°¸ç»­åŒ¹é…ä¸‰çº§åˆ†ç±»çš„å‹¾ç¨½è¡¨
to_merge_df = pd.DataFrame(
    [['æ˜¯', 'å¦', '3.4.1 éæ°¸ç»­åŸæŠ•å€º'], ['æ˜¯', 'æ˜¯', '3.4.2 æ°¸ç»­åŸæŠ•å€º'], ['å¦', 'å¦', '3.5.1 éæ°¸ç»­äº§ä¸šå€º'],
     ['å¦', 'æ˜¯', '3.5.2 æ°¸ç»­äº§ä¸šå€º']], columns=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­', 'ä¸‰çº§åˆ†ç±»'])
bond_set_df = bond_set_df.merge(to_merge_df, left_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], right_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'],
                                how='left')
# åˆå¹¶åˆ°æŒä»“è¡¨
Chicang_df['ä¸‰çº§åˆ†ç±»-new'] = Chicang_df.apply(
    lambda x: bond_set_df.set_index('å¤–éƒ¨ä»£ç ').loc[x['å¤–éƒ¨ä»£ç '], 'ä¸‰çº§åˆ†ç±»'] if x['ç¼–å·'] == '3.4-3.5' else x[
        'ä¸‰çº§åˆ†ç±»'], axis=1)
# åŒ¹é…å¤šèµ„äº§å“ç±»
yunzuogailan_now = pd.read_excel(Config.get_overview_parent_file(date), index_col=0)
Parent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[
    ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]
Chicang_df2 = Chicang_df.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»', 'äº§å“ç»ç†']], left_on='äº§å“ä»£ç ', right_index=True,
                               how='left')
Chicang_df2 = Chicang_df2[
    Chicang_df2.apply(lambda x: not pd.isnull(x['äº§å“ç»ç†']), axis=1)]  # åŒ¹é…ä¸åˆ°äº§å“ç»ç†çš„æ˜¯å½“å¤©äº§å“å·²ç»åˆ°æœŸäº†ï¼Œä½†æ˜¯pasæŒä»“ä»æœ‰æ‹‰å–
Chicang_df2 = del_Innovation_department(Chicang_df2)  # æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“
Chicang_df2 = Chicang_df2.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')

result_df_8_initial = pd.pivot_table(Chicang_df2, index=['ä¸‰çº§åˆ†ç±»-new'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],
                                     values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum) / 100000000  # ä¸“æˆ·æŒä»“çš„æ•°æ®é€è§†

# ç»†åŒ–7.2 å§”å¤–å€ºåˆ¸æŠ•èµ„çš„å­é¡¹
Outsourced_bond_asset_df = Chicang_df2[Chicang_df2['ä¸‰çº§åˆ†ç±»'] == '7.2 å§”å¤–å€ºåˆ¸æŠ•èµ„']
public_account_tag_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å§”å¤–å…¬å…±ç­–ç•¥ä¸“æˆ·æ ‡ç­¾',
                                      index_col=0)
Outsourced_bond_asset_df_new = Outsourced_bond_asset_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°',
                                                              right_index=True, how='left')
Outsourced_bond_tag = {'æ”¶ç›˜ä»·æ³•': '7.2.1 æ”¶ç›˜ä»·ä¸“æˆ·',
                       'åˆ©ç‡å€ºæ”¶ç›˜ä»·': '7.2.2 åˆ©ç‡å€ºæ”¶ç›˜ä»·ä¸“æˆ·',
                       'æ¨¡å‹æ³•': '7.2.3 æ¨¡å‹æ³•ä¸“æˆ·',
                       'å¯è½¬å€º': '7.2.4 å¯è½¬å€ºä¸“æˆ·',
                       'æ’å®šä¹…æœŸ': '7.2.5 æ’å®šä¹…æœŸä¸“æˆ·',
                       'å›ºæ”¶+å§”å¤–': '7.2.6 å›ºæ”¶+å§”å¤–ä¸“æˆ·',
                       'Wä¸“æˆ·': '7.2.7 Wä¸“æˆ·',
                       'ç»¿è‰²å€º': '7.2.8 ç»¿è‰²å€ºä¸“æˆ·',
                       'å¤–å¸ä¸“æˆ·': '7.2.9 å¤–å¸ä¸“æˆ·', }
# é¢å¤–å®šä¹‰è¡¥å……çš„åˆ†ç±»ï¼Œéç”±æ±‡æ€»çš„pivot_tableè®¡ç®—
Outsourced_bond_asset_df_new['å››çº§åˆ†ç±»'] = Outsourced_bond_asset_df_new['æ ‡ç­¾'].map(
    lambda x: Outsourced_bond_tag[x] if x in Outsourced_bond_tag.keys() else '7.2.10 å…¶ä»–')
Outsourced_bond_asset_result = pd.pivot_table(Outsourced_bond_asset_df_new, index=['å››çº§åˆ†ç±»'],
                                              columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'],
                                              aggfunc=np.sum) / 100000000  # ä¸“æˆ·æŒä»“çš„æ•°æ®é€è§†
result_df_8 = pd.concat([result_df_8_initial.rename_axis(''), Outsourced_bond_asset_result.rename_axis('')])
result_df_8.to_excel(Config.get_asset_table_file(date))
result_df_lastw = pd.read_excel(Config.get_asset_table_file(date_lastw), index_col=0, header=[0, 1, 2])
result_df_lastm = pd.read_excel(Config.get_asset_table_file(lastm), index_col=0, header=[0, 1, 2])
result_df_lasty = pd.read_excel(Config.get_asset_table_file(lasty), index_col=0, header=[0, 1, 2])
# åˆå¹¶æœ¬å‘¨æ•°æ®å’Œç›¸æ¯”ä¹‹å‰ï¼Œå¹¶è°ƒèŠ‚å¤šé‡ç´¢å¼•
result_df_8_final = pd.concat([result_df_8, result_df_8.sum(axis=1) - result_df_lastw.sum(axis=1),
                               result_df_8.sum(axis=1) - result_df_lastm.sum(axis=1),
                               result_df_8.sum(axis=1) - result_df_lasty.sum(axis=1)], axis=1)

# result_df_8_final.to_excel('test.xlsx',sheet_name='8.èµ„äº§å¤§è¡¨')

# è¡¥å……æœ¬å¸çš„ç›¸æ¯”ä¸Šå‘¨ã€ç›¸æ¯”ä¸Šæœˆã€ç›¸æ¯”ä¸Šå¹´(å»æ‰å¤–å¸äº§å“ï¼‰
foreign_currency_products_cols = [
    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),
    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼')
]

# è·å–æ‰€æœ‰éå¤–å¸äº§å“åˆ—
all_columns_8 = list(result_df_8.columns)
domestic_columns_8 = [col for col in all_columns_8 if col not in foreign_currency_products_cols]

all_columns_lastw = list(result_df_lastw.columns)
domestic_columns_lastw = [col for col in all_columns_lastw if col not in foreign_currency_products_cols]

all_columns_lastm = list(result_df_lastm.columns)
domestic_columns_lastm = [col for col in all_columns_lastm if col not in foreign_currency_products_cols]

all_columns_lasty = list(result_df_lasty.columns)
domestic_columns_lasty = [col for col in all_columns_lasty if col not in foreign_currency_products_cols]

# ä½¿ç”¨åˆ—è¡¨è€Œä¸æ˜¯é›†åˆæ¥è®¡ç®—å›½å†…è´§å¸æ•°æ®
result_df_8_domestic_currency = result_df_8[domestic_columns_8].sum(axis=1)
result_df_lastw_domestic_currency = result_df_lastw[domestic_columns_lastw].sum(axis=1)
result_df_lastm_domestic_currency = result_df_lastm[domestic_columns_lastm].sum(axis=1)
result_df_lasty_domestic_currency = result_df_lasty[domestic_columns_lasty].sum(axis=1)

# å°†å›½å†…è´§å¸çš„æ¯”è¾ƒæ•°æ®åˆå¹¶åˆ°æœ€ç»ˆç»“æœ
result_df_8_final = pd.concat([
    result_df_8_final,
    result_df_8_domestic_currency - result_df_lastw_domestic_currency,
    result_df_8_domestic_currency - result_df_lastm_domestic_currency,
    result_df_8_domestic_currency - result_df_lasty_domestic_currency
], axis=1)

# è®¾ç½®æœ€ç»ˆç»“æœçš„åˆ—å
result_df_8_final.columns = pd.MultiIndex.from_tuples(
    tuple(result_df_8.columns) +
    (("", "", 'ç›¸æ¯”ä¸Šå‘¨'),
     ("", "", 'ç›¸æ¯”ä¸Šæœˆ'),
     ("", "", 'ç›¸æ¯”ä¸Šå¹´'),
     ("", "", 'ç›¸æ¯”ä¸Šå‘¨-ä¸å«å¤–å¸äº§å“'),
     ("", "", 'ç›¸æ¯”ä¸Šæœˆ-ä¸å«å¤–å¸äº§å“'),
     ("", "", 'ç›¸æ¯”ä¸Šå¹´-ä¸å«å¤–å¸äº§å“'))
)

# å°†ç»“æœå†™å…¥Excel
result_df_8_final.to_excel(writer, sheet_name='8.èµ„äº§å¤§è¡¨')

date = zhoubao_date
zhongshou_m_path = os.path.join(Config.WEEKLY_DATA_DIR, f'ä¸­æ”¶åˆ†ææŠ¥è¡¨-äº§å“æ˜ç»†-{date}-m.xlsx')
zhongshou_y_path = os.path.join(Config.WEEKLY_DATA_DIR, f'ä¸­æ”¶åˆ†ææŠ¥è¡¨-äº§å“æ˜ç»†-{date}-y.xlsx')
zhongshou_m = pd.read_excel(zhongshou_m_path, index_col=0, skiprows=1)
zhongshou_y = pd.read_excel(zhongshou_y_path, index_col=0, skiprows=1)
# æ³¨ï¼šåˆäº«å’ŒBOFçš„é”€å”®ç®¡ç†è´¹=0.é¢å¤–åŠ ä¸Šæœ¬æœˆæ–°èµ·æ¯åˆäº«çš„ä»½é¢*é”€å”®ç®¡ç†è´¹*è¿ä½œå¤©æ•°/365

classification_df = pd.read_excel(
    Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),
    sheet_name='å¤šèµ„äº§å“ç±»æ ‡ç­¾',
    index_col='æ¯äº§å“ä»£ç '
)
# å»é‡é˜²æ­¢ç´¢å¼•é‡å¤å¯¼è‡´mergeæˆ–æ˜ å°„å¼‚å¸¸
classification_df = classification_df[~classification_df.index.duplicated(keep='first')]
classification_ye = classification_df[['å¤šèµ„äº§å“ç±»']]


def zhongshou_df_processing_v2(df_here, period_here: str):  # æ ¹æ®è®¡è´¢éƒ¨æ–°è°ƒæ•´çš„è¡¨æ ¼è®¡ç®—ã€‚å‰ç«¯æ”¶è´¹äº§å“ä¸ç”¨å†æ‰‹åŠ¨è°ƒæ•´ï¼Œ
    # ä¾‹zhongshou_df_processing(zhongshou_m,'æœ¬æœˆ','2024-03')
    fixed_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'æŠ•èµ„å›¢é˜Ÿ', 'å›¢é˜Ÿåˆ’åˆ†', 'äº§å“çº¿']
    df_here.columns = fixed_cols + list(df_here.columns[5:])
    df_here = df_here[df_here['å›¢é˜Ÿåˆ’åˆ†'] == '5.å¤šèµ„äº§æŠ•èµ„éƒ¨']
    # å•ç‹¬æ‹‰å–é”€å”®ç®¡ç†è´¹å’ŒæŠ•èµ„ç®¡ç†è´¹ï¼Œæ–¹ä¾¿åé¢è°ƒæ•´è®¡ç®—ä¸­æ”¶
    df_here.columns = [''.join(x.split('\n')) for x in df_here.columns]
    zhongshou_cols = ['é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰',
                      'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']  # æ‰£å‡ä»£é”€ä¸­æ”¶
    df_here = df_here[fixed_cols + zhongshou_cols]
    # åˆ é™¤ä¸­æ”¶ä¸º0çš„è¡Œï¼Œæœ‰ä¸€äº›æ˜¯è€äº§å“æˆ–è€…æœªå‘è¡Œäº§å“
    df_here = df_here[df_here['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰'].map(lambda x: x > 0.00001)]
    # åŒ¹é…å“ç±»
    df_here = df_here.merge(classification_ye, left_index=True, right_index=True, how='left')
    df_here = del_Innovation_department(df_here)  # æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“,å…ˆä¸å»ï¼Œç›®å‰ç»Ÿä¸€è€ƒæ ¸
    df_here = df_here.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
    # æ±‡æ€»ç³»åˆ—ç»“æœ
    mid_result = df_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).sum()[
        ['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']]
    mid_cols = [period_here + x for x in ['ä¸­æ”¶', 'é”€å”®ç®¡ç†è´¹', 'æŠ•èµ„ç®¡ç†è´¹(å«è¶…é¢)', 'è¶…é¢ç®¡ç†è´¹', 'å‰ç«¯æ”¶è´¹']]
    mid_result.columns = mid_cols
    return mid_result


result_9 = pd.concat([zhongshou_df_processing_v2(zhongshou_m, '-'.join([date[:4], date[4:6]])),
                      zhongshou_df_processing_v2(zhongshou_y, date[:4])], axis=1)
result_9 = rank_by_sort(result_9, rank_here)
result_9.to_excel(writer, sheet_name='9.ä¸­æ”¶ç›‘æ§')


# result_9.to_excel('test.xlsx',sheet_name='9.ä¸­æ”¶ç›‘æ§')

# åˆ¤æ–­å“ç±»Indexæ˜¯å¦é½å…¨
def full_category_or_not(df_def, rank_def):
    df_def = df_def.copy()
    for x in rank_def:
        if x not in df_def.index:
            df_def.loc[x, :] = None
    return df_def


date = zhoubao_date
yunzuogailan_now = del_Innovation_department(pd.read_excel(
    Config.get_overview_parent_file(date), index_col=0))
yunzuogailan_now['åˆ°æœŸæœˆä»½'] = yunzuogailan_now['åˆ°æœŸæ—¥'].map(lambda x: x[:-3])
Parent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)
yunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
# ä»…çœ‹å‘¨æŠ¥ä¸‹å‘¨åçš„åˆ°æœŸæƒ…å†µ
yunzuogailan_here = yunzuogailan_here[yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w]
yunzuogailan_here_fengbi = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å°é—­']
yunzuogailan_here_dingkai = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å®šå¼€']
output_sheetname = ['10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ', '10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ-å®šå¼€']
k = 0
for yunzuogailan_here_to_cal in [yunzuogailan_here_fengbi, yunzuogailan_here_dingkai]:
    result_df_10 = pd.pivot_table(yunzuogailan_here_to_cal, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='åˆ°æœŸæœˆä»½',
                                  values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)  # æ•°æ®é€è§†
    result_df_10 = rank_by_sort(full_category_or_not(result_df_10, rank_here), rank_here).T  # å¯¹åˆ†ç±»è¿›è¡Œæ’åº-å±•ç¤ºä¼˜åŒ–
    result_df_10.index = result_df_10.loc['å‡€èµ„äº§(äº¿)'].index  # å¤šé‡indxç´¢å¼•è½¬æˆå•ç´¢å¼•float
    result_df_10[[float(x[:4]) < 2029 for x in result_df_10.index]].to_excel(writer, sheet_name=output_sheetname[k])
    k += 1
keep_cols = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'æ¯åˆ†ç±»', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©',
             'å‰©ä½™å¤©', 'äº§å“ç»ç†',
             'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']
result_df_10_2 = yunzuogailan_here[
    (yunzuogailan_here['åˆ°æœŸæ—¥'] <= closing_date_next_w) & (yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w)][
    keep_cols]
result_df_10_2.sort_values(by='åˆ°æœŸæ—¥', ascending=True, inplace=True)
result_df_10_2.to_excel(writer, sheet_name='10.ä¸‹å‘¨åˆ°æœŸäº§å“æ¸…å•')

print('ä¸‹å‘¨åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2['å‡€èµ„äº§(äº¿)'].sum()))
print('å°é—­åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum()))
print('å®šå¼€åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()))
date = zhoubao_date
excel_name = 'æŒä»“ç›ˆäºæ˜ç»†åˆ—è¡¨_' + date + '.xlsx'
Chicang_df = pd.read_excel(os.path.join(Config.WEEKLY_DATA_DIR, excel_name))
Chicang_df.rename(columns={'èµ„äº§ç®€ç§°': 'å€ºåˆ¸ç®€ç§°'}, inplace=True)  ###æŒ‰ç…§è€çš„ç®€ç§°è®¡ç®—
Chicang_df.drop_duplicates(inplace=True)

# å…´åˆç³»åˆ—
Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()
xinghe_list = ['å…´åˆ1å·', 'å…´åˆ2å·', 'å…´åˆ3å·', 'å…´åˆ6å·', 'å…´åˆ11å·']  # éœ€è¦å±•ç¤ºçš„å…´åˆæ¸…å•
concat_xinghe_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢
for i in range(len(xinghe_list)):
    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'
    concat_xinghe_series.append(pd.Series(
        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
        name=xinghe_list[i] + '-é‡‘é¢'))

concat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)
concat_xinghe_df = concat_xinghe_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
                                          left_index=True, right_index=True, how='left')
concat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)
concat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]
result_df_11_1 = pd.concat(
    [concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
     concat_xinghe_pct_df], axis=1)
result_df_11_1.to_excel(writer, sheet_name='11.å…´åˆäº§å“æŒä»“æ˜ç»†')

# å¯è½¬å€ºä¸“æˆ·
Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()
concat_zhuanzhai_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢
zhuanzhai_dict = {
    'ç¿éƒ¡2å·': 'å…´ä¸šä¿¡æ‰˜Â·å…´äº«ç¨³å¥ç¿éƒ¡2å·',
    'ç¿éƒ¡3å·': 'å…´ä¸šä¿¡æ‰˜Â·å…´äº«ç¨³å¥ç¿éƒ¡3å·è¯åˆ¸æŠ•èµ„é›†åˆèµ„é‡‘ä¿¡æ‰˜è®¡åˆ’',
    'æ­¥æ­¥é«˜28å·': 'å…´è¯å…¨çƒæ–°æ­¥æ­¥é«˜28å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’',
    'ä¸­æ¬§1å·': 'ä¸­æ¬§åŸºé‡‘-ä¼˜é€‰å¯è½¬å€º1å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’',
    'ä¸œæ–¹çº¢1å·': 'ä¸œæ–¹çº¢èµ„ç®¡-ä¼˜é€‰å¯è½¬å€º1å·é›†åˆèµ„ç®¡è®¡åˆ’',
    'ä¸­é‡‘1å·':'ä¸­é‡‘èµ¢å’Œ1å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’',
    'å…´è…¾ç¿é€‰3å·':'ä¸­ä¿¡æœŸè´§å…´è…¾ç¿é€‰3å·ç®¡ç†äººä¸­ç®¡ç†äººï¼ˆMOMï¼‰é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’',
}
# æ‰‹å·¥å¢åŠ å¯è½¬å€ºä¸“æˆ·çš„é…ç½®æƒ…å†µ
zhuanzhai_list = []
for shortname in zhuanzhai_dict.keys():
    concat_zhuanzhai_series.append(pd.Series(
        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')[
            'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name=shortname + '-é‡‘é¢'))
    zhuanzhai_list += [shortname]

# æ‰‹å·¥å¢åŠ å¯è½¬å€ºåŸºé‡‘çš„é…ç½®æƒ…å†µ
ETF_bond_list = ['æµ·å¯Œé€šä¸Šè¯æŠ•èµ„çº§å¯è½¬å€ºåŠå¯äº¤æ¢å€ºåˆ¸äº¤æ˜“å‹å¼€æ”¾å¼æŒ‡æ•°è¯åˆ¸æŠ•èµ„åŸºé‡‘',
                 'åšæ—¶ä¸­è¯å¯è½¬å€ºåŠå¯äº¤æ¢å€ºåˆ¸äº¤æ˜“å‹å¼€æ”¾å¼æŒ‡æ•°è¯åˆ¸æŠ•èµ„åŸºé‡‘']
concat_zhuanzhai_series.append(pd.Series(
    Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')[
        'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='å¯è½¬å€ºETF-é‡‘é¢'))
zhuanzhai_list += ['å¯è½¬å€ºETF']

concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)
concat_zhuanzhai_df = concat_zhuanzhai_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
                                                left_index=True, right_index=True, how='left')
concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(
    concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0)
concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]
result_df_11_1_1 = pd.concat(
    [concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
     concat_zhuanzhai_pct_df], axis=1)
result_df_11_1_1.to_excel(writer, sheet_name='11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†')
# result_df_11_1_1.to_excel(Underlying_data_folder_path+'test2.xlsx',sheet_name='11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†')

# è¡¥å……å§”å¤–ä¸“æˆ·çš„æ ‡ç­¾
public_account_tag_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å§”å¤–å…¬å…±ç­–ç•¥ä¸“æˆ·æ ‡ç­¾',
                                      index_col=0)
Weiwai_df_full = Weiwai_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')
# è¡¥å……äº§å“çš„å“ç±»
Weiwai_df_full = Weiwai_df_full.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»']], left_on='äº§å“ä»£ç ', right_index=True,
                                      how='left')
Weiwai_df_full = Weiwai_df_full.merge(Parent_sort[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True,
                                      how='left')

# é‡åŒ–ç­–ç•¥ä¸“æˆ·å’Œå…´åˆ4çš„é…ç½®æƒ…å†µï¼ˆç»†åŒ–æ ‡ç­¾ï¼‰
concat_quant_series = []
quant_list = ['é‡åŒ–ä¸­æ€§', 'é‡åŒ–æŒ‡å¢', 'é‡åŒ–CTA', 'å…´åˆ4å·']
concat_quant_series.append(pd.Series(Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–ä¸­æ€§'].groupby('äº§å“ä»£ç ')[
                                         'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é‡åŒ–ä¸­æ€§'))
concat_quant_series.append(pd.Series(Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–æŒ‡å¢'].groupby('äº§å“ä»£ç ')[
                                         'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é‡åŒ–æŒ‡å¢'))
concat_quant_series.append(pd.Series(Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–CTA'].groupby('äº§å“ä»£ç ')[
                                         'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é‡åŒ–CTA'))
concat_quant_series.append(pd.Series(
    Weiwai_df_full[Weiwai_df_full['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-å…´åˆ4å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')[
        'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='å…´åˆ4å·'))
concat_quant_df = pd.concat(concat_quant_series, axis=1)
concat_quant_df = concat_quant_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)']], left_index=True,
                                        right_index=True, how='left')
concat_quant_pct_df = concat_quant_df[quant_list].div(concat_quant_df['å‡€èµ„äº§(äº¿)'], axis=0)
concat_quant_pct_df.columns = [x + '-å æ¯”' for x in quant_list]
result_df_11_3 = pd.concat([concat_quant_df[quant_list + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†']], concat_quant_pct_df], axis=1)
result_df_11_3.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)
result_df_11_3.to_excel(writer, sheet_name='11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†')



# è®¡ç®—æŒä»“çš„è§„æ¨¡åŠå æ¯”(å•ä¸ªç†è´¢äº§å“æŒä»“å äº§å“è§„æ¨¡çš„æ¯”-çš„å¹³å‡)
result_df_11_2_amt = pd.pivot_table(Weiwai_df_full, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ ‡ç­¾',
                                    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum) / 100000000  # æ•°æ®é€è§†
yunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')
# å æ¯”è®¡ç®—æ–¹å¼1ï¼šé™¤ä»¥ç³»åˆ—è§„æ¨¡
result_df_11_2_pct_2 = result_df_11_2_amt.div(yunzuogailan_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'])['å‡€èµ„äº§(äº¿)'].sum(),
                                              axis=0)
# å æ¯”è®¡ç®—æ–¹å¼2ï¼šä¹‹å‰çš„ç™¾åˆ†æ¯”è®¡ç®—æ–¹å¼ä¸åˆç†ï¼Œä¹‹å‰æ˜¯å…¨éƒ¨ç†è´¢äº§å“æŒä»“/å…¨éƒ¨ç†è´¢äº§å“è§„æ¨¡ï¼Œå¾ˆå¤šç†è´¢äº§å“å¹¶æœªæŒæœ‰ä¸“æˆ·çš„ä¼šæ‘Šè–„æŒä»“æ¯”ä¾‹
Weiwai_df_simplify = pd.pivot_table(Weiwai_df_full, index=['äº§å“ä»£ç '], columns='æ ‡ç­¾',
                                    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum) / 100000000  # æ•°æ®é€è§†
Weiwai_df_simplify.columns = Weiwai_df_simplify['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].columns
Weiwai_df_simplify = Weiwai_df_simplify.merge(yunzuogailan_here[['å‡€èµ„äº§(äº¿)']], left_index=True, right_index=True,
                                              how='left')
result_df_11_2_pct = Weiwai_df_simplify.div(Weiwai_df_simplify['å‡€èµ„äº§(äº¿)'], axis=0).merge(
    yunzuogailan_here[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_index=True, right_index=True, how='left')
result_df_11_2_pct = result_df_11_2_pct.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()
rank_by_sort(full_category_or_not(result_df_11_2_amt, rank_here), rank_here).to_excel(writer,
                                                                                      sheet_name='11.2.1å…¶ä»–å§”å¤–ä¸“æˆ·é‡‘é¢é…ç½®æƒ…å†µ')
rank_by_sort(full_category_or_not(result_df_11_2_pct, rank_here), rank_here).to_excel(writer,
                                                                                      sheet_name='11.2.2å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ')
rank_by_sort(full_category_or_not(result_df_11_2_pct_2, rank_here), rank_here).to_excel(writer,
                                                                                        sheet_name='11.2.3å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ-é™¤ä»¥ç³»åˆ—è§„æ¨¡')

# å…¶ä»–è¡ç”Ÿå“æŒä»“æƒ…å†µ
Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()
xinghe_list = ['å…´åˆ1å·', 'å…´åˆ5å·', 'å…´åˆ7å·', 'å…´åˆ8å·', 'ä¸°å’Œ1å·', 'ä¸°å’Œ2å·', 'ä¸°æ³°2å·']  # éœ€è¦å±•ç¤ºçš„å…´åˆæ¸…å•
concat_xinghe_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢
for i in range(len(xinghe_list)):
    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'
    concat_xinghe_series.append(pd.Series(
        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,
        name=xinghe_list[i] + '-é‡‘é¢'))
# æ‰‹å·¥å¢åŠ çµåŠ¨1å·çš„é…ç½®æƒ…å†µ
concat_xinghe_series.append(pd.Series(
    Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-è´¢æ™ºäººç”ŸçµåŠ¨1å·å•ä¸€èµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')[
        'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='çµåŠ¨1å·-é‡‘é¢'))
xinghe_list += ['çµåŠ¨1å·']
concat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)
concat_xinghe_df = concat_xinghe_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
                                          left_index=True, right_index=True, how='left')
concat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)
concat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]
result_df_11_4 = pd.concat(
    [concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
     concat_xinghe_pct_df], axis=1)
result_df_11_4.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)  # å»æ‰åˆ›æ–°éƒ¨äº§å“
result_df_11_4.to_excel(writer, sheet_name='11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†')
# result_df_11_4.to_excel(Underlying_data_folder_path+'test1.xlsx',sheet_name='11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†')

# æ±‡æ€»è¡ç”Ÿå“ä¸“æˆ·çš„é…ç½®æƒ…å†µ
Zhuanhu_label_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å§”å¤–å…¬å…±ç­–ç•¥ä¸“æˆ·æ ‡ç­¾',
                                 index_col=0)
derivative_zhuanhu_list = list(Zhuanhu_label_df[Zhuanhu_label_df['æ ‡ç­¾'] == 'è¡ç”Ÿå“ä¸“æˆ·'].index)
derivative_zhuanhu_df = Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in derivative_zhuanhu_list)]
# è·å–è¡ç”Ÿå“æŒä»“æ˜ç»†
derivative_zhuanhu_df = pd.pivot_table(derivative_zhuanhu_df, index=['äº§å“ä»£ç '], columns='å€ºåˆ¸ç®€ç§°',
                                       values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum)
derivative_zhuanhu_df.columns = [x[1][5:-8] for x in derivative_zhuanhu_df.columns]
derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'] = derivative_zhuanhu_df.sum(axis=1)  # æ±‡æ€»è¡ç”Ÿå“æŒä»“é‡‘é¢
derivative_zhuanhu_df = derivative_zhuanhu_df.merge(
    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True,
    how='left')
derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ¯”ä¾‹'] = derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'].div(
    derivative_zhuanhu_df['å‡€èµ„äº§(äº¿)'], axis=0) / 100000000
derivative_zhuanhu_df.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)  # å»æ‰åˆ›æ–°éƒ¨äº§å“
derivative_zhuanhu_df.to_excel(writer, sheet_name='11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”')
# derivative_zhuanhu_df.to_excel(Underlying_data_folder_path+'test2.xlsx',sheet_name='11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”')

# éæ ‡æŒä»“æ˜ç»†
feibiao_df = Chicang_df[Chicang_df.apply(
    lambda x: (x['æ–°ç‰ˆèµ„äº§å¤§ç±»'] in ['éæ ‡å‡†åŒ–å€ºæƒç±»èµ„äº§', 'ç†è´¢ç›´æ¥èèµ„å·¥å…·', 'æ–°å¢å¯æŠ•èµ„èµ„äº§']) or (
                x['æ–°ç‰ˆèµ„äº§å°ç±»'] in ['åŒä¸šå€Ÿæ¬¾']), axis=1)]
feibiao_pct_df = pd.DataFrame(feibiao_df.groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum())
feibiao_pct_df = feibiao_pct_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],
                                      left_index=True, right_index=True, how='left')
feibiao_pct_df['éæ ‡å æ¯”'] = feibiao_pct_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] / feibiao_pct_df['å‡€èµ„äº§(äº¿)'] / 100000000
feibiao_pct_df.to_excel(writer, sheet_name='11.6éæ ‡æŒä»“å æ¯”')
# feibiao_pct_df.to_excel('test.xlsx',sheet_name='11.6éæ ‡æŒä»“å æ¯”')


# é»„é‡‘ä¸“æˆ·é…ç½®
gold_dict = {
    'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·': 'å…´ä¸šæœŸè´§-é»„é‡‘æŒ‡æ•°å¢å¼º1å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’',
}
gold_ETF_bond_list = ['åå®‰æ˜“å¯Œé»„é‡‘äº¤æ˜“å‹å¼€æ”¾å¼è¯åˆ¸æŠ•èµ„åŸºé‡‘',
'æ°¸èµ¢ä¸­è¯æ²ªæ·±æ¸¯é»„é‡‘äº§ä¸šè‚¡ç¥¨äº¤æ˜“å‹å¼€æ”¾å¼æŒ‡æ•°è¯åˆ¸æŠ•èµ„åŸºé‡‘',
'åå¤é»„é‡‘äº¤æ˜“å‹å¼€æ”¾å¼è¯åˆ¸æŠ•èµ„åŸºé‡‘',
'åå¤ä¸­è¯æ²ªæ·±æ¸¯é»„é‡‘äº§ä¸šè‚¡ç¥¨äº¤æ˜“å‹å¼€æ”¾å¼æŒ‡æ•°è¯åˆ¸æŠ•èµ„åŸºé‡‘',
'æ˜“æ–¹è¾¾é»„é‡‘äº¤æ˜“å‹å¼€æ”¾å¼è¯åˆ¸æŠ•èµ„åŸºé‡‘']

#['åå®‰æ˜“å¯Œé»„é‡‘äº¤æ˜“å‹å¼€æ”¾å¼è¯åˆ¸æŠ•èµ„åŸºé‡‘']

# æƒç›Šä¸“æˆ·é…ç½®
equity_dict = {
    'åœ†ä¿¡æ°¸ä¸°åŸºæœ¬é¢é©±åŠ¨9å·': 'åœ†ä¿¡æ°¸ä¸°åŸºæœ¬é¢é©±åŠ¨9å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’.',
    'æ™¯é¡ºé•¿åŸè‡´è¿œ2å·': 'æ™¯é¡ºé•¿åŸåŸºé‡‘è‡´è¿œ2å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’',
    'å…´äº«ç¨³å¥æ—¥æ–—1å·': 'å…´äº«ç¨³å¥æ—¥æ–—1å·è¯åˆ¸æŠ•èµ„é›†åˆèµ„é‡‘ä¿¡æ‰˜è®¡åˆ’',
    'å¸¸æ˜¥è—¤1å·': 'å…´ä¸šä¿¡æ‰˜Â·å…´äº«ç¨³å¥å¸¸æ˜¥è—¤1å·',
    'å¸¸æ˜¥è—¤2å·': 'å…´ä¸šä¿¡æ‰˜Â·å…´äº«ç¨³å¥å¸¸æ˜¥è—¤2å·è¯åˆ¸æŠ•èµ„é›†åˆèµ„é‡‘ä¿¡æ‰˜è®¡åˆ’',
    "ç¿è¿œçº¢åˆ©1å·":"ç¿è¿œåŸºé‡‘æ±‡è§çº¢åˆ©1å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’",
    "ä¸­æ¬§ç§‘æŠ€å…´ç››1å·":"ä¸­æ¬§åŸºé‡‘å…´ç››1å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’",
}

def get_zhdata(zhuanzhai_dict, ETF_bond_list):
    # å¯è½¬å€ºä¸“æˆ·
    Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()
    concat_zhuanzhai_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢
    # æ‰‹å·¥å¢åŠ å¯è½¬å€ºä¸“æˆ·çš„é…ç½®æƒ…å†µ
    zhuanzhai_list = []
    for shortname in zhuanzhai_dict.keys():
        concat_zhuanzhai_series.append(pd.Series(
            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')[
                'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name=shortname + '-é‡‘é¢'))
        zhuanzhai_list += [shortname]
    # æ‰‹å·¥å¢åŠ å¯è½¬å€ºåŸºé‡‘çš„é…ç½®æƒ…å†µ
    concat_zhuanzhai_series.append(pd.Series(
        Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')[
            'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é»„é‡‘ETF-é‡‘é¢'))
    zhuanzhai_list += ['é»„é‡‘ETF']
    concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)
    concat_zhuanzhai_df = concat_zhuanzhai_df.merge(
        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True,
        how='left')
    concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(
        concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0)
    concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]
    result_df_11_1_1 = pd.concat(
        [concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
         concat_zhuanzhai_pct_df], axis=1)
    return result_df_11_1_1

def get_equity_data(equity_dict):
    # æƒç›Šä¸“æˆ·
    Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()
    concat_equity_series = []  # åˆå¹¶çš„æƒç›Šä¸“æˆ·æŒä»“é‡‘é¢
    equity_list = []
    
    # æ‰‹å·¥å¢åŠ æƒç›Šä¸“æˆ·çš„é…ç½®æƒ…å†µ
    for shortname in equity_dict.keys():
        concat_equity_series.append(pd.Series(
            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == equity_dict[shortname]].groupby('äº§å“ä»£ç ')[
                'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name=shortname + '-é‡‘é¢'))
        equity_list += [shortname]
    
    # åˆå¹¶æ•°æ®
    concat_equity_df = pd.concat(concat_equity_series, axis=1)
    concat_equity_df = concat_equity_df.merge(
        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True,
        how='left')
    
    # è®¡ç®—å æ¯”
    concat_equity_pct_df = concat_equity_df[[x + '-é‡‘é¢' for x in equity_list]].div(
        concat_equity_df['å‡€èµ„äº§(äº¿)'], axis=0)
    concat_equity_pct_df.columns = [x + '-å æ¯”' for x in equity_list]
    
    # åˆå¹¶ç»“æœ
    result_df = pd.concat(
        [concat_equity_df[[x + '-é‡‘é¢' for x in equity_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],
         concat_equity_pct_df], axis=1)
    return result_df
# ç”Ÿæˆé»„é‡‘æŒä»“æ•°æ®
hg_asset = get_zhdata(gold_dict, gold_ETF_bond_list)
hg_asset[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-é‡‘é¢', 'é»„é‡‘ETF-é‡‘é¢', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-å æ¯”',
          'é»„é‡‘ETF-å æ¯”']].to_excel(writer, sheet_name='é»„é‡‘æŒä»“')

# ç”Ÿæˆæƒç›Šä¸“æˆ·æŒä»“æ•°æ®
equity_asset = get_equity_data(equity_dict)
output_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»'] + \
             [x + suffix for x in equity_dict.keys() for suffix in ['-é‡‘é¢', '-å æ¯”']]
equity_asset[output_cols].to_excel(writer, sheet_name='æƒç›Šä¸“æˆ·æŒä»“')

# ç”Ÿæˆå…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ
# è¯»å–å…¬å…±ç­–ç•¥æ•°æ®
ggcc = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å…¬å¸å…¬å…±ç­–ç•¥ä¸“æˆ·')
wwgl = pd.read_excel(Config.get_weekly_data_file('å§”å¤–äº§å“æ¦‚è§ˆ(å›¢é˜Ÿè§†è§’)'))[['å§”å¤–èµ„äº§','æœ€æ–°è§„æ¨¡']]

# è®¡ç®—æŒä»“æ±‡æ€»
chicangsum = Chicang_df.groupby('å€ºåˆ¸ç®€ç§°')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum()/100000000

# åˆå¹¶æ•°æ®
ggcc = pd.merge(ggcc, wwgl, left_on='èµ„äº§åç§°', right_on='å§”å¤–èµ„äº§', how='left')
ggcc = pd.merge(ggcc, chicangsum, left_on='èµ„äº§åç§°', right_index=True, how='left')

# é‡å‘½ååˆ—å¹¶è®¡ç®—å æ¯”
ggcc = ggcc.rename(columns={'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼':'å¤šèµ„äº§æŠ•æŒä»“-äº¿', "æœ€æ–°è§„æ¨¡":'ä¸“æˆ·è§„æ¨¡'})
ggcc['å¤šèµ„äº§æŒä»“å æ¯”'] = ggcc['å¤šèµ„äº§æŠ•æŒä»“-äº¿']/ggcc['ä¸“æˆ·è§„æ¨¡']

# è¾“å‡ºç»“æœ
ggcc[['æ‰€å±éƒ¨é—¨', 'ç­–ç•¥æ ‡ç­¾', 'èµ„äº§ä»£ç ', 'èµ„äº§åç§°', 'èµ„äº§ç®€ç§°', 'ä¸“æˆ·è§„æ¨¡', 
      'å¤šèµ„äº§æŠ•æŒä»“-äº¿', 'å¤šèµ„äº§æŒä»“å æ¯”']].to_excel(writer, sheet_name='å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ')

          
date = zhoubao_date
yunzuogailan_now = del_Innovation_department(pd.read_excel(
    Config.get_overview_parent_file(date), index_col=0))
part_nav_df = data_transposition.loc[:, yunzuogailan_now.index].tail(7 + 1)  # å‘¨å‡€å€¼å˜åŒ–
# å‘¨å†…æ—¥å‡€å€¼å˜åŒ–å¹³å‡
rweek = pd.DataFrame((part_nav_df.tail(1).values / part_nav_df.head(1).values - 1) * 10000, columns=part_nav_df.columns,
                     index=['å‘¨å‡€å€¼å˜åŒ–bp']).T
rweek_average = ((part_nav_df / part_nav_df.shift(1) - 1) * 10000).mean(axis=0)
nav_change_df = pd.concat([rweek, rweek_average], axis=1)
nav_change_df.columns = ['å‘¨å‡€å€¼å˜åŒ–bp', 'å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']
nav_change_df_keep = nav_change_df[
    (abs(nav_change_df['å‘¨å‡€å€¼å˜åŒ–bp']) >= 20) | (abs(nav_change_df['å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']) >= 3)]  # ç­›é€‰æ ‡å‡†
# nav_change_df.iplot()


result_df_12 = nav_change_df_keep.merge(
    yunzuogailan_now[['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†', 'ç»„åˆä¹…æœŸ',
                      'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥',
                      'åˆ°æœŸæ—¥']], left_index=True, right_index=True, how='left')
result_df_12.sort_values('å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp', ascending=True, inplace=True)  # åº•è¡¨æŒ‰ç…§å‡€å€¼æ³¢åŠ¨
result_df_12.to_excel(writer, sheet_name='12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•')
# result_df_12.to_excel('test.xlsx',sheet_name='12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•')

now = zhoubao_date
# lastm='20250228'
# lasty='20241231'

# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°
yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))
yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))
yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))


def get_zhouqi_scale(x):
    if x < 30 * 7:
        return '<6M'
    elif (x >= 30 * 7) and (x < 13 * 30):
        return '6M-1Y'
    elif x >= 13 * 30:
        return '>1Y'
    else:
        return 'error'


def get_zhouqi_scale_df(df_f, name: str):
    mid_df = df_f.copy()
    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)
    result_df = pd.concat([mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].sum(),
                           mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].count()], axis=1)
    result_df.columns = [name + x for x in ['è§„æ¨¡(äº¿)', 'æ•°é‡']]
    return result_df


final_df = pd.concat([get_zhouqi_scale_df(yunzuogailan_lasty, '2024'), get_zhouqi_scale_df(yunzuogailan_now, 'æœ€æ–°')],
                     axis=1)
final_df['vlookupæ ‡ç­¾'] = [''.join(list(x)) for x in final_df.index]
keep_columns = ['vlookupæ ‡ç­¾'] + list(final_df.columns[:-1])

# final_df[keep_columns].to_excel('test3.xlsx',sheet_name='13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡')
final_df[keep_columns].to_excel(writer, sheet_name='13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡')

now = zhoubao_date
month7 = '20240731'
lasty = '20241231'

# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°
yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))
yunzuogailan_month7 = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(month7), index_col=0))
yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))

yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))
yunzuogailan_month7 = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(month7), index_col=0))
yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))


def match_kehuzhouqi_narrowed(x: str):
    if x == 'å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“':
        return 'å®¢æˆ·å‘¨æœŸ'
    elif x == 'å®¢æˆ·é”å®šæœŸ':
        return 'æœ€çŸ­æŒæœ‰æœŸ'
    else:
        return ''


def get_kehuzhouqi_narrowed_scale(my_df, col_str: str):
    # col_str='2023å¹´åº•'
    mid_df = my_df[my_df['äº§å“æ¨¡æ¿ä¸­æ–‡åç§°'].map(lambda x: x in ['å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“', 'å®¢æˆ·é”å®šæœŸ'])]
    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)
    result_df = pd.pivot_table(mid_df, index=['å‘¨æœŸåŒºé—´'], columns='äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', values=['å‡€èµ„äº§(äº¿)'],
                               aggfunc=np.sum)  # ä¸€ç»´å˜äºŒç»´
    result_df.columns = [col_str + match_kehuzhouqi_narrowed(x[1]) for x in list(result_df.columns)]
    return result_df


result_df_14 = pd.concat([get_kehuzhouqi_narrowed_scale(yunzuogailan_lasty, '2024å¹´åº•'),
                          get_kehuzhouqi_narrowed_scale(yunzuogailan_month7, '2024å¹´7æœˆ'),
                          get_kehuzhouqi_narrowed_scale(yunzuogailan_now, 'æœ€æ–°')], axis=1)
# result_df_14.to_excel('test.xlsx',sheet_name='14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª')
result_df_14.to_excel(writer, sheet_name='14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª')
wind_code_list = ['885005.WI', 'CBA00111.CS', 'CBA00121.CS', 'CBA00101.CS', '885008.WI', '885006.WI', '885007.WI',
                  '885001.WI', '000300.SH']
result_list = []
for deltadays in [30, 30 * 3, 30 * 6, 365]:
    startDate = ''.join(
        str((datetime.strptime(zhoubao_date, '%Y%m%d') -timedelta(days=deltadays)).date()).split(
            '-'))
    result_list.append(np.array(
        w.wss(wind_code_list, "pct_chg_per", "startDate=" + startDate + ";endDate=" + zhoubao_date).Data[
            0]) * 365 / deltadays)
# è®¡ç®—2026å¹´å¹´åŒ–æ”¶ç›Šï¼ˆæ¯å¹´éœ€æ›´æ–°å¹´æœ«æ—¥æœŸï¼‰
deltadays = (datetime.strptime(zhoubao_date, '%Y%m%d') - datetime.strptime('20251231', '%Y%m%d')).days
result_list.append(np.array(
    w.wss(wind_code_list, "pct_chg_per", "startDate=" + '20251231' + ";endDate=" + zhoubao_date).Data[
        0]) * 365 / deltadays)
result_list.append(np.array(w.wss(wind_code_list, "sec_name").Data[0]))
result_df = pd.DataFrame(result_list).T
result_df.index = wind_code_list
result_df.columns = ['è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', '2026å¹´å¹´åŒ–æ”¶ç›Šç‡',
                     'æŒ‡æ•°ç®€ç§°']
# result_df.to_excel('test.xlsx',sheet_name='15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š')
result_df.to_excel(writer, sheet_name='15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š')

nav_date = yunzuogailan_date
yunzuogailan_now = del_Innovation_department(
    pd.read_excel(Config.get_overview_parent_file(yunzuogailan_date), index_col=0))
yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] = [data_transposition.loc[nav_date, x] for x in yunzuogailan_now.index]
yunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] = [data_transposition.loc[pd.to_datetime(nav_date) - timedelta(7), x] for x in
                                     yunzuogailan_now.index]
yunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] = [
    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(int(nav_date[-2:])), x] for x in yunzuogailan_now.index]
pojing_df = yunzuogailan_now[yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] < 1].copy()

pojing_df['è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] - 1
pojing_df['è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] - 1
pojing_df['æ£€æµ‹æ—¶ç‚¹'] = nav_date
pojing_df['äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰'] = pojing_df['å‡€èµ„äº§(äº¿)'] / pojing_df['å•ä½å‡€å€¼']
pojing_df = pojing_df.reset_index()
pojing_df_final = pojing_df[
    ['æ£€æµ‹æ—¶ç‚¹', 'äº§å“ç®€ç§°', 'äº§å“ä»£ç ', 'äº§å“ç»ç†', 'äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰', 'åˆ°æœŸæ—¥', 'ç´¯ç§¯å‡€å€¼', 'è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–',
     'è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–']]
quant = ['ç‹æµ©', 'å¼ é›…å©•', 'å­™æ–°å']


def manager_in_or_not(s: str, y: list):
    sum_here = 0
    for mid_y in y:
        if mid_y in s:
            sum_here += 1
    if sum_here > 0:
        return 1
    else:
        return 0


pojing_df_final = pojing_df_final[pojing_df_final['äº§å“ç»ç†'].map(lambda x: manager_in_or_not(x, quant)) == 0]
pojing_df_final.to_excel(writer, sheet_name='ç ´å‡€ç»“æœ')



prompt_zs="""
æˆ‘éœ€è¦æ›´æ–°æˆ‘çš„å‘¨æŠ¥ä¸­å›¢é˜Ÿä¸­æ”¶æ•°æ®çš„æƒ…å†µã€‚
æ–‡å­—å¦‚ä¸‹ï¼š"æ³¨ï¼š1ï¼‰2025 å¹´12â½‰äº§å“å§”å¤šèµ„äº§æŠ•èµ„éƒ¨ä¸­æ”¶è®¡åˆ’0.62eï¼ˆå«0.60 è´¹ç‡ä¸­æ”¶+0.02e å‰ç«¯æ”¶è´¹+0.00e è¶…é¢ç®¡ç†è´¹ï¼‰ï¼Œæˆªâ½Œ20251016 â½‰åº¦ä¸­æ”¶0.36eï¼ˆå«
0.32e è´¹ç‡ä¸­æ”¶+0.02e å‰ç«¯æ”¶è´¹+0.02e è¶…é¢ç®¡ç†è´¹ï¼Œä¸ºå®é™…å·²äº§â½£ç°â¾¦æµçš„è¶…é¢ç®¡ç†è´¹ï¼‰ã€‚
2ï¼‰2025 å¹´å¤šèµ„äº§æŠ•èµ„éƒ¨ä¸­æ”¶è®¡åˆ’5.67eï¼ˆçº¦å«5.2e è´¹ç‡ä¸­æ”¶+0.4e å‰ç«¯æ”¶è´¹+0.1e è¶…é¢ç®¡ç†è´¹ï¼‰ï¼Œæˆªâ½Œ20250807 å…¨å¹´ä¸­æ”¶3.46eï¼ˆå«2.89e è´¹ç‡ä¸­æ”¶
+0.45e å‰ç«¯æ”¶è´¹+0.12e è¶…é¢ç®¡ç†è´¹ï¼Œä¸ºå®é™…å·²äº§â½£ç°â¾¦æµçš„è¶…é¢ç®¡ç†è´¹ï¼‰ã€‚
3ï¼‰ä¸­æ”¶æŠ¥è¡¨éšç³»ç»Ÿâ¼å¾„è¿›â¾è°ƒæ•´ï¼Œâ½¬å‰å·²åŒ…å«å‰ç«¯æ”¶è´¹äº§å“çš„è®¡æè°ƒæ•´ã€‚
4ï¼‰è¶…é¢ç®¡ç†è´¹åŒ…å«â½¬å‰å·²äº§â½£å®é™…ç°â¾¦æµçš„è¶…é¢ç®¡ç†è´¹ï¼Œä¸å«è®¡æå¾…å‘â½£ã€‚
5ï¼‰å¤–å¸äº§å“çš„è¶…é¢ç®¡ç†è´¹è®¡ä»·å•ä½ä¸ºç¾å…ƒï¼ŒæŠ¥è¡¨è®¡ç®—æ—¶å·²è°ƒæ•´ä¸ºâ¼ˆâº å¸ã€‚
"
è¯·åªç”¨è¿”å›ä½ æ›´æ–°åçš„æ–‡æœ¬å†…å®¹ç»™æˆ‘ï¼Œå…¶ä¸­æœ€æ–°çš„æ›´æ–°æ—¥æœŸä¸º%sã€‚æœ€æ–°çš„éƒ¨é—¨çš„ä¸­æ”¶è§„æ¨¡æ•°æ®å¦‚ä¸‹ï¼Œä½ åº”è¯¥å…³æ³¨åˆè®¡å˜åŒ–æ¥æ›´æ–°æ•°æ®ã€‚
å…¶ä¸­æ–‡å­—ä¸­çš„æå‰æ”¶è´¹ä¸ºå‰ç«¯æ”¶è´¹ï¼Œè¶…é¢ä¸­æ”¶ä¸ºè¶…é¢ç®¡ç†è´¹ï¼Œè´¹ç‡ä¸­æ”¶åº”ä¸ºä¸­æ”¶å‡å‰ç«¯æ”¶è´¹å‡è¶…é¢ç®¡ç†è´¹ã€‚ä½ ä¸ç”¨è°ƒæ•´è®¡åˆ’ä¸­æ”¶é™¤éåˆ°äº†ä¸‹ä¸€ä¸ªæœˆã€‚

åˆ†ç³»åˆ—ä¸­æ”¶æ•°æ®ï¼š%s"""%(yunzuogailan_date,round(result_9.sum(axis=0),2))

prompt_gm="""æˆ‘éœ€è¦æ›´æ–°æˆ‘çš„å‘¨æŠ¥ä¸­å›¢é˜Ÿè§„æ¨¡æ•°æ®çš„æƒ…å†µã€‚
æ–‡å­—å¦‚ä¸‹ï¼š"æˆªâ½Œ 20250807ï¼Œå¤šèµ„äº§æŠ•èµ„éƒ¨ç®¡ç†çš„åœ¨è¿ä½œç†è´¢äº§å“è§„æ¨¡ 3049 äº¿ï¼Œè¾ƒä¸Šâ½‰åº•å¢åŠ çº¦ 26 äº¿ï¼ˆæˆªâ½Œ2025 å¹´7
â½‰åº•3023 äº¿è§„æ¨¡ï¼‰ï¼Œè¾ƒå»å¹´åº•å¢åŠ çº¦694 äº¿ï¼ˆæˆªâ½Œ2024 å¹´åº•è¿ä½œè§„æ¨¡çº¦2355 äº¿ï¼‰ã€‚å…¶ä¸­â¾å†…ä½™é¢ä¸º2094 äº¿ï¼ˆç›¸
â½ä¸Šâ½‰åº•2080äº¿è§„æ¨¡å¢åŠ çº¦14 äº¿ï¼Œâ½å»å¹´åº•ä½™é¢1630 äº¿å¢åŠ çº¦464 äº¿ï¼‰ï¼Œâ¾å¤–ä½™é¢ä¸º955 äº¿ï¼ˆç›¸â½ä¸Šâ½‰åº•943
äº¿å¢åŠ çº¦12äº¿ï¼Œâ½å»å¹´åº•ä½™é¢725äº¿å¢åŠ çº¦230äº¿ï¼‰""
è¯·åªç”¨è¿”å›ä½ æ›´æ–°åçš„æ–‡æœ¬å†…å®¹ç»™æˆ‘ï¼Œä¸éœ€è¦è°ƒæ•´æ ¼å¼ï¼Œå…¶ä¸­æœ€æ–°çš„æ›´æ–°æ—¥æœŸä¸º%sã€‚æœ€æ–°çš„äº§å“çš„è¡Œå†…å¤–å’Œäº§å“è§„æ¨¡åˆè®¡æ•°æ®å¦‚ä¸‹ï¼Œä½ åº”è¯¥å…³æ³¨åˆè®¡å˜åŒ–æ¥æ›´æ–°æ•°æ®ï¼š
åˆ†æ¸ é“è§„æ¨¡æ•°æ®:%sã€‚
åˆ†ç³»åˆ—è§„æ¨¡æ•°æ®ï¼š%s"""%(yunzuogailan_date,round(Channel_result1.sum(axis=0),0),round(result_3.astype(float).sum(axis=0),0))
daoqi_summary ='ä¸‹å‘¨åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2['å‡€èµ„äº§(äº¿)'].sum())+'\n'+'å°é—­åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum())+'\n'+'å®šå¼€åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum())
guimo_summary= get_wenzi_result(prompt_gm)
zhongshou_summary= get_wenzi_result(prompt_zs)

wenzi = {'åˆ°æœŸæ–‡å­—':daoqi_summary,'ä¸­æ”¶æ–‡å­—':zhongshou_summary,'è§„æ¨¡æ–‡å­—':guimo_summary}
wenzidf = pd.DataFrame([wenzi]).T.rename(columns={0:'æ–‡å­—'})
wenzidf.to_excel(writer, sheet_name='æ€»ç»“æ–‡å­—')

writer.close()
