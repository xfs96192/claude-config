{"parentUuid":"ed61bd6a-f65e-494f-846b-90ed4294d8ea","isSidechain":true,"userType":"external","cwd":"/private/tmp","sessionId":"785d3a51-0a04-4501-aca2-c87ea3b69707","version":"2.1.37","gitBranch":"main","agentId":"acompact-73e96c","slug":"joyful-soaring-rose","message":{"model":"claude-opus-4-6","id":"msg_01XYemLnsnhjqev5c86qBm7H","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_0116n6spHUu5bmMkyVfEF22C","name":"Write","input":{"file_path":"/tmp/generate_weekly_dashboard.py","content":"#!/usr/bin/env python3\n\"\"\"\nGenerate a comprehensive web dashboard for the weekly report.\nReads data from the extracted JSON and generates a self-contained HTML file.\nMatches the structure and formatting of the PDF weekly report.\n\"\"\"\nimport json\nimport os\nimport math\nimport re\n\n# ─── Configuration ───\nJSON_PATH = '/tmp/weekly_report_data.json'\nOUTPUT_HTML = '/Users/fanshengxia/Desktop/周报V2/输出结果/周报仪表板-20260205.html'\nREPORT_DATE = '2026-02-05'\nREPORT_TITLE = '多资产投资部理财产品运作周报'\n\n# ─── Load Data ───\nwith open(JSON_PATH, 'r', encoding='utf-8') as f:\n    raw_data = json.load(f)\n\noutput_sheets = raw_data['output_file']\nvba_sheets = raw_data['vba_workbook']\n\n# ─── Sheets that should use integer display with parentheses for negatives ───\nSCALE_INT_SHEETS = {\n    '2、产品规模',\n    '1、分渠道余额',\n    '投资经理维度产品规模和数量',\n    '不同形态产品规模和数量',\n    '13.不同周期产品规模',\n    '14.狭义客户周期和最短持有期的产品规模跟踪',\n    '10.未来全年产品到期情况',\n    '10.未来全年产品到期情况-定开',\n}\n\n# ─── Sheets with percentage values already in percentage form (e.g., 1.87 = 1.87%) ───\nPCT_RAW_SHEETS = {\n    '15.市场指数收益',\n}\n\n# ─── Sheets with percentage values in decimal form (e.g., 0.0187 = 1.87%) ───\nPCT_DECIMAL_SHEETS = {\n    '系列产品业绩-费后加权',\n    '系列产品业绩-费后平均',\n    '系列产品业绩-费前加权',\n    '系列产品业绩-费前平均',\n    '5.2 最短持有期产品业绩表现1',\n    '5.2 最短持有期产品业绩表现2',\n}\n\n\n# ─── Helper Functions ───\n\ndef is_numeric(val):\n    if val is None:\n        return False\n    if isinstance(val, (int, float)):\n        return not (isinstance(val, float) and (math.isnan(val) or math.isinf(val)))\n    if isinstance(val, str):\n        try:\n            float(val)\n            return True\n        except:\n            return False\n    return False\n\n\ndef to_float(val):\n    if val is None:\n        return None\n    if isinstance(val, (int, float)):\n        if isinstance(val, float) and (math.isnan(val) or math.isinf(val)):\n            return None\n        return float(val)\n    if isinstance(val, str):\n        if val in ('nan', 'inf', '-inf', ''):\n            return None\n        try:\n            return float(val)\n        except:\n            return None\n    return None\n\n\ndef escape_html(s):\n    if s is None:\n        return ''\n    s = str(s)\n    return s.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('\"', '&quot;')\n\n\ndef detect_column_types(sheet_data, sheet_name=''):\n    \"\"\"Detect which columns contain percentages, basis points, or regular numbers.\"\"\"\n    data = sheet_data['data']\n    headers = data[0] if data else []\n    col_types = {}\n\n    for ci in range(len(headers)):\n        h = str(headers[ci] or '')\n        h_lower = h.lower()\n\n        # Force override for known sheet types\n        if sheet_name in PCT_RAW_SHEETS:\n            is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h\n            if is_pct_header:\n                col_types[ci] = 'percent_raw'\n                continue\n\n        if sheet_name in PCT_DECIMAL_SHEETS:\n            is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h\n            if is_pct_header:\n                col_types[ci] = 'percent'\n                continue\n\n        if 'bp' in h_lower or '净值变化bp' in h:\n            col_types[ci] = 'bps'\n            continue\n\n        is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h or '比例' in h\n\n        if is_pct_header:\n            numeric_vals = []\n            for ri in range(1, min(len(data), 20)):\n                if ci < len(data[ri]):\n                    v = to_float(data[ri][ci])\n                    if v is not None and v != 0:\n                        numeric_vals.append(abs(v))\n            if numeric_vals:\n                avg = sum(numeric_vals) / len(numeric_vals)\n                if avg > 0.5:\n                    col_types[ci] = 'percent_raw'\n                else:\n                    col_types[ci] = 'percent'\n            else:\n                col_types[ci] = 'percent'\n        else:\n            # Auto-detect percentage columns by value range\n            numeric_vals = []\n            for ri in range(1, min(len(data), 20)):\n                if ci < len(data[ri]):\n                    v = to_float(data[ri][ci])\n                    if v is not None and v != 0:\n                        numeric_vals.append(abs(v))\n            if len(numeric_vals) >= 2:\n                avg = sum(numeric_vals) / len(numeric_vals)\n                max_v = max(numeric_vals)\n                if 0 < avg < 0.5 and max_v < 1.5:\n                    col_types[ci] = 'percent'\n\n    return col_types\n\n\ndef format_cell_value(val, col_type=None, use_parens=False):\n    \"\"\"Format a cell value based on its type.\n    use_parens: if True, show negatives as (N) instead of -N, and use integer display for scale values.\n    \"\"\"\n    if val is None:\n        return ''\n    if isinstance(val, str):\n        if val in ('nan', 'inf', '-inf'):\n            return ''\n        try:\n            fval = float(val)\n            val = fval\n        except:\n            return escape_html(val)\n\n    if isinstance(val, bool):\n        return str(val)\n    if not isinstance(val, (int, float)):\n        return escape_html(str(val))\n    if math.isnan(val) or math.isinf(val):\n        return ''\n\n    if col_type == 'percent':\n        pct = val * 100\n        return f'{pct:.2f}%'\n    elif col_type == 'percent_raw':\n        return f'{val:.2f}%'\n    elif col_type == 'bps':\n        return f'{val:.2f}'\n\n    # Scale integer mode: show rounded integers with parentheses for negatives\n    if use_parens:\n        # For very small values close to 0\n        if abs(val) < 0.005:\n            return '-'\n        # Round to reasonable precision\n        rounded = round(val)\n        if abs(val) < 1 and val != 0:\n            # Show one decimal for small values\n            if val < 0:\n                return f'({abs(val):.1f})'\n            return f'{val:.1f}'\n        if rounded == 0 and val != 0:\n            if val < 0:\n                return '(0)'\n            return '0'\n        if rounded < 0:\n            return f'({abs(rounded):,})'\n        return f'{rounded:,}'\n\n    # Default formatting\n    if isinstance(val, int) or (isinstance(val, float) and val == int(val) and abs(val) < 10000):\n        return str(int(val))\n    elif abs(val) < 0.0001 and val != 0:\n        return f'{val:.6f}'\n    elif abs(val) < 0.01 and val != 0:\n        return f'{val:.4f}'\n    elif abs(val) < 100:\n        return f'{val:.2f}'\n    elif abs(val) < 100000:\n        return f'{val:,.2f}'\n    else:\n        return f'{val:,.0f}'\n\n\ndef get_cell_class(val, col_type=None, header=''):\n    \"\"\"Get CSS class for conditional formatting.\"\"\"\n    classes = []\n    if val is None:\n        return ''\n\n    fval = to_float(val)\n    if fval is None:\n        return ''\n\n    h = str(header).lower()\n\n    is_change = any(kw in h for kw in ['变化', '较上周', '较上月', '较上年', 'bp'])\n    is_return = any(kw in h for kw in ['年化', '收益率'])\n\n    if is_change:\n        if fval > 0:\n            classes.append('val-positive')\n        elif fval < 0:\n            classes.append('val-negative')\n\n    if is_return and col_type == 'percent':\n        if fval < 0:\n            classes.append('val-negative')\n\n    # Heatmap intensity for change columns\n    if is_change and fval != 0:\n        if col_type == 'percent':\n            intensity = min(abs(fval) * 20, 1)\n        elif col_type == 'percent_raw':\n            intensity = min(abs(fval) / 5, 1)\n        elif 'bp' in h:\n            intensity = min(abs(fval) / 50, 1)\n        else:\n            intensity = min(abs(fval) / 20, 1)\n        level = min(int(intensity * 5) + 1, 5)\n        if fval > 0:\n            classes.append(f'heat-pos-{level}')\n        else:\n            classes.append(f'heat-neg-{level}')\n\n    return ' '.join(classes)\n\n\ndef parse_merged_cells(merged_list):\n    \"\"\"Parse merged cell ranges into a dict of (row,col) -> (rowspan, colspan).\"\"\"\n    merges = {}\n    skip = set()\n    for m in merged_list:\n        match = re.match(r'([A-Z]+)(\\d+):([A-Z]+)(\\d+)', m)\n        if not match:\n            continue\n        c1 = col_letter_to_num(match.group(1))\n        r1 = int(match.group(2))\n        c2 = col_letter_to_num(match.group(3))\n        r2 = int(match.group(4))\n        rowspan = r2 - r1 + 1\n        colspan = c2 - c1 + 1\n        merges[(r1, c1)] = (rowspan, colspan)\n        for r in range(r1, r2 + 1):\n            for c in range(c1, c2 + 1):\n                if (r, c) != (r1, c1):\n                    skip.add((r, c))\n    return merges, skip\n\n\ndef col_letter_to_num(letters):\n    num = 0\n    for ch in letters:\n        num = num * 26 + (ord(ch) - ord('A') + 1)\n    return num\n\n\n# ─── Data Preprocessing ───\ndef preprocess_sheets():\n    \"\"\"Add computed subtotal rows and fix data where needed.\"\"\"\n\n    # 1. Add subtotal rows to 分渠道余额\n    sheet = output_sheets.get('1、分渠道余额')\n    if sheet and sheet.get('data'):\n        data = sheet['data']\n        new_data = list(data[:3])  # Keep headers (rows 0-2)\n\n        # Group rows by 总分类\n        groups = {}\n        current_group = None\n        for ri in range(3, len(data)):\n            row = data[ri]\n            if row[0] is not None:\n                current_group = str(row[0])\n            if current_group:\n                if current_group not in groups:\n                    groups[current_group] = []\n                groups[current_group].append(row)\n\n        grand_total = [0, 0, 0]\n\n        for group_name in ['中低波稳健产品', '中高波市值产品', '外币产品']:\n            rows = groups.get(group_name, [])\n            subtotal = [0, 0]  # 行内, 行外\n            for row in rows:\n                v_inner = to_float(row[2])\n                v_outer = to_float(row[3])\n                if v_inner:\n                    subtotal[0] += v_inner\n                if v_outer:\n                    subtotal[1] += v_outer\n                new_data.append(row)\n\n            total_val = subtotal[0] + subtotal[1]\n            # Add subtotal row\n            label = f'{group_name}合计'\n            new_data.append([None, label, round(subtotal[0]), round(subtotal[1])])\n            grand_total[0] += subtotal[0]\n            grand_total[1] += subtotal[1]\n\n        # Add 合计 column header\n        if len(new_data[0]) == 4:\n            new_data[0] = [None, None, '保有规模', None, None]\n            new_data[1] = [None, '渠道-行内外', '行内', '行外', '合计']\n            new_data[2] = ['总分类', '母分类', None, None, None]\n\n        # Add 合计 column to each data row\n        for ri in range(3, len(new_data)):\n            row = new_data[ri]\n            if len(row) == 4:\n                v1 = to_float(row[2]) or 0\n                v2 = to_float(row[3]) or 0\n                row.append(round(v1 + v2))\n            elif len(row) == 5:\n                pass  # already has 合计\n\n        # Add 总计 row\n        new_data.append([None, '总计', round(grand_total[0]), round(grand_total[1]),\n                         round(grand_total[0] + grand_total[1])])\n\n        sheet['data'] = new_data\n        sheet['col_count'] = 5\n\n    # 2. Add 合计 row to 产品规模\n    sheet = output_sheets.get('2、产品规模')\n    if sheet and sheet.get('data'):\n        data = sheet['data']\n        # Check if 合计 row already exists\n        has_total = any(str(row[0] or '').strip() in ('合计', '总计') for row in data[1:])\n        if not has_total:\n            totals = [0] * len(data[0])\n            for row in data[1:]:\n                for ci in range(2, len(row)):\n                    v = to_float(row[ci])\n                    if v is not None:\n                        totals[ci] += v\n            total_row = ['', '合计']\n            for ci in range(2, len(data[0])):\n                total_row.append(round(totals[ci]))\n            while len(total_row) < len(data[0]):\n                total_row.append(None)\n            data.append(total_row)\n\n    # 3. Add 合计 row to 投资经理维度\n    sheet = output_sheets.get('投资经理维度产品规模和数量')\n    if sheet and sheet.get('data'):\n        data = sheet['data']\n        has_total = any(str(row[0] or '').strip() in ('合计', '总计') for row in data[1:])\n        if not has_total:\n            totals = [0] * len(data[0])\n            for row in data[1:]:\n                for ci in range(1, len(row)):\n                    v = to_float(row[ci])\n                    if v is not None:\n                        totals[ci] += v\n            total_row = ['合计']\n            for ci in range(1, len(data[0])):\n                total_row.append(round(totals[ci], 1))\n            while len(total_row) < len(data[0]):\n                total_row.append(None)\n            data.append(total_row)\n\n\npreprocess_sheets()\n\n\n# ─── Section Definitions (matching PDF TOC order) ───\nSECTIONS = [\n    {\n        'id': 'overview',\n        'title': '报告概览',\n        'icon': '&#9670;',\n        'sheets': ['总结文字'],\n        'type': 'overview'\n    },\n    # ─── 一、规模及发行情况 ───\n    {\n        'id': 'channel-aum',\n        'title': '1. 渠道代销规模',\n        'icon': '&#9632;',\n        'sheets': ['1、分渠道余额', '渠道明细'],\n        'type': 'tables'\n    },\n    {\n        'id': 'product-scale',\n        'title': '2. 产品规模',\n        'icon': '&#9632;',\n        'sheets': ['2、产品规模', '不同形态产品规模和数量', '13.不同周期产品规模',\n                   '14.狭义客户周期和最短持有期的产品规模跟踪'],\n        'type': 'tables'\n    },\n    {\n        'id': 'scale-changes',\n        'title': '3. 在售产品销售情况',\n        'icon': '&#9632;',\n        'sheets': ['3、本月定开或客户周期产品规模变化', '本周新发产品', '待售产品'],\n        'type': 'tables'\n    },\n    {\n        'id': 'pm-metrics',\n        'title': '4. 投资经理维度',\n        'icon': '&#9632;',\n        'sheets': ['投资经理维度产品规模和数量'],\n        'type': 'tables'\n    },\n    {\n        'id': 'maturity',\n        'title': '5. 产品到期情况',\n        'icon': '&#9670;',\n        'sheets': ['10.未来全年产品到期情况', '10.未来全年产品到期情况-定开', '10.下周到期产品清单'],\n        'type': 'tables'\n    },\n    # ─── 二、产品业绩 ───\n    {\n        'id': 'break-even',\n        'title': '6. 破净情况',\n        'icon': '&#9670;',\n        'sheets': ['破净结果'],\n        'type': 'tables'\n    },\n    {\n        'id': 'market-index',\n        'title': '7. 市场指数收益',\n        'icon': '&#9670;',\n        'sheets': ['15.市场指数收益'],\n        'type': 'tables'\n    },\n    {\n        'id': 'series-perf',\n        'title': '8. 系列产品业绩',\n        'icon': '&#9670;',\n        'sheets': ['系列产品业绩-费前加权', '系列产品业绩-费后加权', '系列产品业绩-费前平均', '系列产品业绩-费后平均'],\n        'type': 'tabs'\n    },\n    {\n        'id': 'min-hold-perf',\n        'title': '9. 最短持有期业绩',\n        'icon': '&#9670;',\n        'sheets': ['5.2 最短持有期产品业绩表现1', '5.2 最短持有期产品业绩表现2'],\n        'type': 'tables'\n    },\n    {\n        'id': 'underperform',\n        'title': '10. 不达基准清单',\n        'icon': '&#9888;',\n        'sheets': ['招商在售产品不达基准', '封闭及定开产品100日内不大业绩产品清单',\n                   '合享及悦动稳享临近到期预测不达标产品清单'],\n        'type': 'tables'\n    },\n    {\n        'id': 'high-vol',\n        'title': '11. 高波动产品',\n        'icon': '&#9888;',\n        'sheets': ['12.周净值高波动产品清单'],\n        'type': 'tables'\n    },\n    # ─── 资产与持仓 ───\n    {\n        'id': 'asset-alloc',\n        'title': '12. 资产维度数据统计',\n        'icon': '&#9679;',\n        'sheets': ['8.资产大表'],\n        'type': 'tables'\n    },\n    {\n        'id': 'fee-income',\n        'title': '13. 中收监控',\n        'icon': '&#9679;',\n        'sheets': ['9.中收监控'],\n        'type': 'tables'\n    },\n    {\n        'id': 'public-strategy',\n        'title': '14. 公共策略专户',\n        'icon': '&#9679;',\n        'sheets': ['公共策略持仓概况'],\n        'type': 'tables'\n    },\n    {\n        'id': 'xinghe',\n        'title': '15. 兴合产品持仓',\n        'icon': '&#9679;',\n        'sheets': ['11.兴合产品持仓明细'],\n        'type': 'tables'\n    },\n    {\n        'id': 'bond-holdings',\n        'title': '16. 可转债/量化持仓',\n        'icon': '&#9679;',\n        'sheets': ['11.1 可转债专户持仓明细', '11.2量化和可转债持仓明细'],\n        'type': 'tables'\n    },\n    {\n        'id': 'outsource',\n        'title': '17. 委外专户配置',\n        'icon': '&#9679;',\n        'sheets': ['11.2.1其他委外专户金额配置情况', '11.2.2其他委外专户配置占比情况',\n                   '11.2.3其他委外专户配置占比情况-除以系列规模'],\n        'type': 'tables'\n    },\n    {\n        'id': 'derivatives',\n        'title': '18. 衍生品/非标持仓',\n        'icon': '&#9679;',\n        'sheets': ['11.4其他衍生品专户持仓明细', '11.5全部衍生品专户持仓占比', '11.6非标持仓占比'],\n        'type': 'tables'\n    },\n    {\n        'id': 'gold-equity',\n        'title': '19. 黄金/权益持仓',\n        'icon': '&#9679;',\n        'sheets': ['黄金持仓', '权益专户持仓'],\n        'type': 'tables'\n    },\n]\n\n\n# ─── Compute Overview Stats ───\ndef compute_overview_stats():\n    stats = {}\n\n    ps = output_sheets.get('2、产品规模', {})\n    if ps.get('data'):\n        total_aum = 0\n        total_count = 0\n        total_aum_m = 0\n        total_aum_y = 0\n        for row in ps['data'][1:]:\n            first = str(row[0] or '').strip() if row[0] else ''\n            second = str(row[1] or '').strip() if len(row) > 1 else ''\n            # Skip the 合计 row we added\n            if first in ('合计', '总计') or second in ('合计', '总计'):\n                continue\n            v = to_float(row[2]) if len(row) > 2 else None\n            if v is not None:\n                total_aum += v\n            v = to_float(row[5]) if len(row) > 5 else None\n            if v is not None:\n                total_count += v\n            v = to_float(row[3]) if len(row) > 3 else None\n            if v is not None:\n                total_aum_m += v\n            v = to_float(row[4]) if len(row) > 4 else None\n            if v is not None:\n                total_aum_y += v\n        stats['total_aum'] = total_aum\n        stats['total_count'] = total_count\n        stats['aum_vs_month'] = total_aum_m\n        stats['aum_vs_year'] = total_aum_y\n\n    text_sheet = output_sheets.get('总结文字', {})\n    if text_sheet.get('data'):\n        for row in text_sheet['data'][1:]:\n            if len(row) >= 2 and row[0] and row[1]:\n                key = str(row[0])\n                val = str(row[1])\n                if '规模' in key:\n                    stats['guimo_text'] = val\n                elif '中收' in key:\n                    stats['zhongshou_text'] = val\n                elif '到期' in key:\n                    stats['daoqi_text'] = val\n\n    bp_sheet = output_sheets.get('破净结果', {})\n    if bp_sheet.get('data'):\n        data_rows = [r for r in bp_sheet['data'][1:] if any(v is not None for v in r)]\n        stats['broken_count'] = len(data_rows)\n\n    up_sheet = output_sheets.get('招商在售产品不达基准', {})\n    if up_sheet.get('data'):\n        stats['underperform_count'] = len(up_sheet['data']) - 1\n\n    hv_sheet = output_sheets.get('12.周净值高波动产品清单', {})\n    if hv_sheet.get('data'):\n        stats['high_vol_count'] = len(hv_sheet['data']) - 1\n\n    return stats\n\n\n# ─── Generate HTML Table ───\ndef generate_table_html(sheet_name, sheet_data, table_id=''):\n    \"\"\"Generate an HTML table from sheet data with formatting.\"\"\"\n    if not sheet_data or not sheet_data.get('data'):\n        return f'<div class=\"empty-state\">暂无数据</div>'\n\n    data = sheet_data['data']\n    merged_cells = sheet_data.get('merged_cells', [])\n    merges, skip_cells = parse_merged_cells(merged_cells)\n    col_types = detect_column_types(sheet_data, sheet_name)\n    use_parens = sheet_name in SCALE_INT_SHEETS\n\n    rows_html = []\n    num_cols = sheet_data.get('col_count', 0)\n\n    for ri, row in enumerate(data):\n        is_header = ri == 0\n        # Check if this is a sub-header row (mostly text, not data)\n        is_subheader = False\n        if ri in (1, 2) and ri < len(data):\n            row_vals = [v for v in row if v is not None]\n            numeric_count = sum(1 for v in row_vals if is_numeric(v))\n            text_count = len(row_vals) - numeric_count\n            if row_vals and text_count > numeric_count and text_count >= 2:\n                is_subheader = True\n\n        cells_html = []\n        for ci in range(min(len(row), num_cols)):\n            if (ri + 1, ci + 1) in skip_cells:\n                continue\n\n            val = row[ci]\n            merge_info = merges.get((ri + 1, ci + 1))\n\n            tag = 'th' if is_header or (is_subheader and ri < 3) else 'td'\n\n            col_header = str(data[0][ci] or '') if ci < len(data[0]) else ''\n            col_type = col_types.get(ci)\n\n            # Format value\n            if is_header or (is_subheader and ri < 3):\n                display = escape_html(str(val)) if val is not None else ''\n            else:\n                display = format_cell_value(val, col_type, use_parens=use_parens)\n\n            # Build attributes\n            attrs = []\n            css_classes = []\n\n            if merge_info:\n                rs, cs = merge_info\n                if rs > 1:\n                    attrs.append(f'rowspan=\"{rs}\"')\n                if cs > 1:\n                    attrs.append(f'colspan=\"{cs}\"')\n\n            if not is_header and not is_subheader:\n                cell_class = get_cell_class(val, col_type, col_header)\n                if cell_class:\n                    css_classes.append(cell_class)\n                fval = to_float(val)\n                if fval is not None:\n                    css_classes.append('num-cell')\n\n            if css_classes:\n                attrs.append(f'class=\"{\" \".join(css_classes)}\"')\n\n            attrs_str = ' ' + ' '.join(attrs) if attrs else ''\n            cells_html.append(f'<{tag}{attrs_str}>{display}</{tag}>')\n\n        # Determine row class\n        row_class = 'header-row' if is_header else ('subheader-row' if is_subheader and ri < 3 else '')\n        if not is_header and row:\n            first_val = str(row[0] or '').strip()\n            second_val = str(row[1] or '').strip() if len(row) > 1 else ''\n            if first_val in ('合计', '总计', '总合计', '汇总', '总规模') or \\\n               second_val in ('合计', '总计', '汇总'):\n                row_class = 'total-row'\n            # Subtotal rows (e.g., \"中低波稳健产品合计\")\n            elif '合计' in second_val:\n                row_class = 'subtotal-row'\n            # Check any of first 3 cells for 合计\n            elif any('合计' in str(v or '') for v in row[:3]):\n                row_class = 'total-row'\n\n        row_class_attr = f' class=\"{row_class}\"' if row_class else ''\n        rows_html.append(f'<tr{row_class_attr}>{\"\".join(cells_html)}</tr>')\n\n    tid = f' id=\"{table_id}\"' if table_id else ''\n    return f'''<div class=\"table-wrapper\">\n<table{tid}>\n{\"\".join(rows_html)}\n</table>\n</div>'''\n\n\n# ─── Generate Section HTML ───\ndef generate_section_html(section):\n    parts = []\n\n    if section['type'] == 'overview':\n        stats = compute_overview_stats()\n        parts.append(generate_overview_html(stats))\n\n    elif section['type'] == 'tabs':\n        tab_names = []\n        tab_contents = []\n        for i, sn in enumerate(section['sheets']):\n            sd = output_sheets.get(sn)\n            if not sd:\n                continue\n            # Create display-friendly tab names\n            short = sn.replace('系列产品业绩-', '')\n            tab_names.append(short)\n            active = 'active' if i == 0 else ''\n            tab_contents.append(\n                f'<div class=\"tab-content {active}\" data-tab=\"{section[\"id\"]}-tab-{i}\">'\n                f'{generate_table_html(sn, sd)}</div>')\n\n        tabs_html = ''.join(\n            f'<button class=\"tab-btn {\"active\" if i == 0 else \"\"}\" '\n            f'onclick=\"switchTab(\\'{section[\"id\"]}\\', {i})\" '\n            f'data-tabgroup=\"{section[\"id\"]}\" data-tabidx=\"{i}\">{tn}</button>'\n            for i, tn in enumerate(tab_names)\n        )\n        parts.append(\n            f'<div class=\"tabs-container\"><div class=\"tab-buttons\">{tabs_html}</div>'\n            f'{\"\".join(tab_contents)}</div>')\n\n    elif section['type'] == 'tables':\n        for sn in section['sheets']:\n            sd = output_sheets.get(sn)\n            if not sd:\n                continue\n            # Display-friendly subtitle\n            subtitle = sn\n            parts.append(f'<h3 class=\"sheet-title\">{escape_html(subtitle)}</h3>')\n            parts.append(generate_table_html(sn, sd))\n\n    return '\\n'.join(parts)\n\n\ndef generate_overview_html(stats):\n    aum = stats.get('total_aum')\n    aum_str = f'{aum:,.0f}亿' if aum and aum > 100 else (f'{aum:,.2f}亿' if aum else 'N/A')\n    count = stats.get('total_count')\n    count_str = f'{int(count)}只' if count else 'N/A'\n    aum_m = stats.get('aum_vs_month')\n    aum_m_str = f'{aum_m:+.0f}亿' if aum_m is not None else 'N/A'\n    aum_m_class = 'stat-positive' if aum_m and aum_m > 0 else ('stat-negative' if aum_m and aum_m < 0 else '')\n    aum_y = stats.get('aum_vs_year')\n    aum_y_str = f'{aum_y:+.0f}亿' if aum_y is not None else 'N/A'\n    aum_y_class = 'stat-positive' if aum_y and aum_y > 0 else ('stat-negative' if aum_y and aum_y < 0 else '')\n\n    broken = stats.get('broken_count', 0)\n    broken_class = 'stat-alert' if broken > 0 else 'stat-ok'\n    broken_str = f'{broken}只' if broken > 0 else '无'\n\n    underperf = stats.get('underperform_count', 0)\n    high_vol = stats.get('high_vol_count', 0)\n\n    text_cards = ''\n    for key, label in [('guimo_text', '规模概况'), ('zhongshou_text', '中收概况'), ('daoqi_text', '到期概况')]:\n        text = stats.get(key, '')\n        if text:\n            text_display = escape_html(text).replace('\\n', '<br>')\n            text_cards += f'''<div class=\"text-card\">\n<div class=\"text-card-label\">{label}</div>\n<div class=\"text-card-content\">{text_display}</div>\n</div>'''\n\n    # Build bar chart from 产品规模 data\n    ps = output_sheets.get('2、产品规模', {})\n    bar_items = []\n    if ps.get('data'):\n        max_aum = 0\n        for row in ps['data'][1:]:\n            second = str(row[1] or '').strip() if len(row) > 1 else ''\n            if second in ('合计', '总计'):\n                continue\n            v = to_float(row[2]) if len(row) > 2 else None\n            if v and v > max_aum:\n                max_aum = v\n        for row in ps['data'][1:]:\n            name = str(row[1] or '')\n            if name in ('合计', '总计'):\n                continue\n            v = to_float(row[2]) if len(row) > 2 else 0\n            chg = to_float(row[3]) if len(row) > 3 else 0\n            if v and name:\n                pct = (v / max_aum * 100) if max_aum > 0 else 0\n                color = 'var(--positive)' if chg and chg > 0 else (\n                    'var(--negative)' if chg and chg < 0 else 'var(--accent-blue)')\n                bar_items.append(f'''<div class=\"bar-row\">\n  <div class=\"bar-label\" title=\"{escape_html(name)}\">{escape_html(name[:8])}</div>\n  <div class=\"bar-track\"><div class=\"bar-fill\" style=\"width:{pct:.1f}%;background:{color}\"></div></div>\n  <div class=\"bar-value\">{v:.0f}</div>\n</div>''')\n\n    bars_html = '\\n'.join(bar_items) if bar_items else ''\n\n    return f'''\n<div class=\"overview-grid\">\n  <div class=\"stat-card stat-primary\">\n    <div class=\"stat-label\">管理规模</div>\n    <div class=\"stat-value\">{aum_str}</div>\n    <div class=\"stat-sub\">\n      <span class=\"{aum_m_class}\">较上月 {aum_m_str}</span>\n      <span class=\"{aum_y_class}\">较年初 {aum_y_str}</span>\n    </div>\n  </div>\n  <div class=\"stat-card\">\n    <div class=\"stat-label\">产品数量</div>\n    <div class=\"stat-value\">{count_str}</div>\n  </div>\n  <div class=\"stat-card {broken_class}\">\n    <div class=\"stat-label\">破净产品</div>\n    <div class=\"stat-value\">{broken_str}</div>\n  </div>\n  <div class=\"stat-card {\"stat-alert\" if underperf > 3 else \"\"}\">\n    <div class=\"stat-label\">不达基准</div>\n    <div class=\"stat-value\">{underperf}只</div>\n  </div>\n  <div class=\"stat-card {\"stat-alert\" if high_vol > 20 else \"\"}\">\n    <div class=\"stat-label\">高波动产品</div>\n    <div class=\"stat-value\">{high_vol}只</div>\n  </div>\n</div>\n<div class=\"overview-grid\" style=\"grid-template-columns: 1fr 1fr;\">\n  <div class=\"stat-card\" style=\"padding:14px 18px;\">\n    <div class=\"stat-label\" style=\"margin-bottom:10px;\">各系列规模分布 (亿)</div>\n    <div class=\"bar-chart\">{bars_html}</div>\n  </div>\n  <div class=\"stat-card\" style=\"padding:14px 18px;\">\n    <div class=\"stat-label\" style=\"margin-bottom:6px;\">AI 摘要</div>\n    <div class=\"text-cards-inline\">\n{text_cards}\n    </div>\n  </div>\n</div>\n'''\n\n\n# ─── CSS Styles ───\nCSS = '''\n@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Source+Han+Sans+SC:wght@300;400;500;700&display=swap');\n\n:root {\n  --bg-primary: #050a18;\n  --bg-secondary: #0c1425;\n  --bg-card: #111c32;\n  --bg-card-hover: #162040;\n  --bg-table-header: #0f1b33;\n  --bg-table-row-alt: #0a1226;\n  --bg-sidebar: #080e1f;\n  --bg-sidebar-active: #1a2744;\n\n  --text-primary: #e2e8f0;\n  --text-secondary: #94a3b8;\n  --text-muted: #64748b;\n  --text-header: #f1f5f9;\n\n  --accent-gold: #f59e0b;\n  --accent-blue: #3b82f6;\n  --accent-cyan: #06b6d4;\n\n  --positive: #10b981;\n  --positive-bg: rgba(16, 185, 129, 0.08);\n  --negative: #ef4444;\n  --negative-bg: rgba(239, 68, 68, 0.08);\n  --alert: #f97316;\n  --alert-bg: rgba(249, 115, 22, 0.08);\n\n  --border: #1e293b;\n  --border-light: #1a2540;\n\n  --sidebar-width: 260px;\n  --header-height: 56px;\n\n  --heat-pos-1: rgba(16, 185, 129, 0.1);\n  --heat-pos-2: rgba(16, 185, 129, 0.2);\n  --heat-pos-3: rgba(16, 185, 129, 0.3);\n  --heat-pos-4: rgba(16, 185, 129, 0.45);\n  --heat-pos-5: rgba(16, 185, 129, 0.6);\n  --heat-neg-1: rgba(239, 68, 68, 0.1);\n  --heat-neg-2: rgba(239, 68, 68, 0.2);\n  --heat-neg-3: rgba(239, 68, 68, 0.3);\n  --heat-neg-4: rgba(239, 68, 68, 0.45);\n  --heat-neg-5: rgba(239, 68, 68, 0.6);\n}\n\n* { box-sizing: border-box; margin: 0; padding: 0; }\n\nhtml {\n  font-size: 13px;\n  scroll-behavior: smooth;\n}\n\nbody {\n  font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", \"Noto Sans SC\", sans-serif;\n  background: var(--bg-primary);\n  color: var(--text-primary);\n  line-height: 1.5;\n  overflow-x: hidden;\n}\n\n/* Header */\n.top-header {\n  position: fixed;\n  top: 0; left: 0; right: 0;\n  height: var(--header-height);\n  background: linear-gradient(135deg, #0a1628 0%, #0f1d35 100%);\n  border-bottom: 1px solid var(--border);\n  display: flex; align-items: center;\n  padding: 0 24px;\n  z-index: 100;\n  backdrop-filter: blur(12px);\n}\n\n.header-brand { display: flex; align-items: center; gap: 12px; }\n\n.header-logo {\n  width: 32px; height: 32px;\n  background: linear-gradient(135deg, var(--accent-gold), #d97706);\n  border-radius: 8px;\n  display: flex; align-items: center; justify-content: center;\n  font-weight: 700; font-size: 14px; color: #0a0f1c;\n}\n\n.header-title {\n  font-family: \"Noto Serif SC\", serif;\n  font-size: 16px; font-weight: 700;\n  color: var(--text-header);\n  letter-spacing: 1px;\n}\n\n.header-date {\n  margin-left: auto;\n  font-size: 12px; color: var(--text-secondary);\n  background: var(--bg-card);\n  padding: 4px 12px; border-radius: 4px;\n  border: 1px solid var(--border);\n  font-variant-numeric: tabular-nums;\n}\n\n/* Sidebar */\n.sidebar {\n  position: fixed;\n  top: var(--header-height); left: 0; bottom: 0;\n  width: var(--sidebar-width);\n  background: var(--bg-sidebar);\n  border-right: 1px solid var(--border);\n  overflow-y: auto;\n  padding: 12px 0; z-index: 90;\n}\n\n.sidebar::-webkit-scrollbar { width: 4px; }\n.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }\n\n.sidebar-section { padding: 4px 0; }\n\n.sidebar-group-label {\n  font-size: 10px; font-weight: 600;\n  color: var(--text-muted);\n  text-transform: uppercase;\n  letter-spacing: 1.5px;\n  padding: 12px 20px 4px;\n}\n\n.nav-item {\n  display: flex; align-items: center; gap: 10px;\n  padding: 8px 20px;\n  color: var(--text-secondary);\n  text-decoration: none; font-size: 12.5px;\n  cursor: pointer;\n  transition: all 0.15s ease;\n  border-left: 3px solid transparent;\n}\n\n.nav-item:hover { color: var(--text-primary); background: var(--bg-card); }\n\n.nav-item.active {\n  color: var(--accent-gold);\n  background: var(--bg-sidebar-active);\n  border-left-color: var(--accent-gold);\n}\n\n.nav-icon { font-size: 8px; opacity: 0.6; width: 14px; text-align: center; }\n\n/* Main Content */\n.main-content {\n  margin-left: var(--sidebar-width);\n  margin-top: var(--header-height);\n  padding: 24px 28px;\n  min-height: calc(100vh - var(--header-height));\n}\n\n.section {\n  margin-bottom: 36px;\n  scroll-margin-top: calc(var(--header-height) + 20px);\n  animation: fadeInUp 0.4s ease-out;\n}\n\n.section-header {\n  font-family: \"Noto Serif SC\", serif;\n  font-size: 18px; font-weight: 700;\n  color: var(--text-header);\n  margin-bottom: 16px;\n  padding-bottom: 10px;\n  border-bottom: 2px solid var(--accent-gold);\n  display: flex; align-items: center; gap: 10px;\n}\n\n.section-header::before {\n  content: '';\n  width: 4px; height: 20px;\n  background: var(--accent-gold);\n  border-radius: 2px;\n}\n\n.sheet-title {\n  font-size: 13px; font-weight: 600;\n  color: var(--accent-cyan);\n  margin: 16px 0 8px;\n  padding-left: 12px;\n  border-left: 2px solid var(--accent-cyan);\n}\n\n/* Overview Cards */\n.overview-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n  gap: 14px; margin-bottom: 20px;\n}\n\n.stat-card {\n  background: var(--bg-card);\n  border: 1px solid var(--border);\n  border-radius: 10px;\n  padding: 16px 18px;\n  transition: transform 0.2s ease, box-shadow 0.2s ease;\n}\n\n.stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }\n\n.stat-card.stat-primary {\n  border-color: var(--accent-gold);\n  background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), var(--bg-card));\n}\n.stat-card.stat-alert {\n  border-color: var(--negative);\n  background: linear-gradient(135deg, var(--negative-bg), var(--bg-card));\n}\n.stat-card.stat-ok {\n  border-color: var(--positive);\n  background: linear-gradient(135deg, var(--positive-bg), var(--bg-card));\n}\n\n.stat-label {\n  font-size: 11px; color: var(--text-muted);\n  text-transform: uppercase;\n  letter-spacing: 0.5px; margin-bottom: 6px;\n}\n\n.stat-value {\n  font-size: 22px; font-weight: 700;\n  color: var(--text-header);\n  font-variant-numeric: tabular-nums;\n}\n\n.stat-sub { margin-top: 8px; display: flex; gap: 14px; font-size: 11px; }\n.stat-positive { color: var(--positive); }\n.stat-negative { color: var(--negative); }\n\n.text-card {\n  background: var(--bg-card);\n  border: 1px solid var(--border);\n  border-radius: 10px;\n  padding: 14px 18px;\n}\n\n.text-card-label {\n  font-size: 11px; font-weight: 600;\n  color: var(--accent-cyan);\n  text-transform: uppercase;\n  letter-spacing: 0.5px; margin-bottom: 8px;\n}\n\n.text-card-content {\n  font-size: 12.5px; line-height: 1.7;\n  color: var(--text-secondary);\n}\n\n/* Bar Chart */\n.bar-chart { display: flex; flex-direction: column; gap: 4px; }\n.bar-row { display: flex; align-items: center; gap: 8px; height: 18px; }\n.bar-label {\n  width: 80px; font-size: 10.5px;\n  color: var(--text-secondary);\n  text-align: right; flex-shrink: 0;\n  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\n}\n.bar-track {\n  flex: 1; height: 10px;\n  background: var(--bg-secondary);\n  border-radius: 3px; overflow: hidden;\n}\n.bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; min-width: 2px; }\n.bar-value {\n  width: 45px; font-size: 10.5px;\n  color: var(--text-muted);\n  text-align: right; font-variant-numeric: tabular-nums;\n}\n\n.text-cards-inline {\n  display: flex; flex-direction: column; gap: 8px;\n  max-height: 320px; overflow-y: auto;\n}\n.text-cards-inline .text-card { padding: 10px 14px; border-radius: 6px; }\n\n/* Tables */\n.table-wrapper {\n  overflow-x: auto;\n  margin: 8px 0 20px;\n  border-radius: 8px;\n  border: 1px solid var(--border);\n  background: var(--bg-card);\n}\n\n.table-wrapper::-webkit-scrollbar { height: 6px; }\n.table-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }\n\ntable {\n  width: 100%; border-collapse: collapse;\n  font-size: 12px; font-variant-numeric: tabular-nums;\n  white-space: nowrap;\n}\n\nth, td {\n  padding: 7px 10px;\n  border-bottom: 1px solid var(--border-light);\n  text-align: left;\n  max-width: 280px;\n  overflow: hidden; text-overflow: ellipsis;\n}\n\nth {\n  background: var(--bg-table-header);\n  color: var(--text-secondary);\n  font-weight: 600; font-size: 11px;\n  letter-spacing: 0.3px;\n  position: sticky; top: 0; z-index: 2;\n}\n\ntr:nth-child(even) td { background: var(--bg-table-row-alt); }\ntr:hover td { background: var(--bg-card-hover) !important; }\n\n.num-cell {\n  text-align: right;\n  font-family: \"SF Mono\", \"Cascadia Code\", \"JetBrains Mono\", monospace;\n  font-size: 11.5px;\n}\n\n.val-positive { color: var(--positive); }\n.val-negative { color: var(--negative); }\n\n.total-row td {\n  font-weight: 700;\n  background: rgba(245, 158, 11, 0.06) !important;\n  border-top: 2px solid var(--accent-gold);\n}\n\n.subtotal-row td {\n  font-weight: 600;\n  background: rgba(6, 182, 212, 0.04) !important;\n  border-top: 1px solid var(--accent-cyan);\n  color: var(--accent-cyan);\n}\n\ntd[rowspan] {\n  background: var(--bg-table-header) !important;\n  font-weight: 600;\n  color: var(--accent-cyan);\n  border-right: 2px solid var(--accent-cyan);\n  vertical-align: middle;\n}\n\nth[colspan] {\n  text-align: center;\n  background: linear-gradient(180deg, var(--bg-table-header), rgba(15, 27, 51, 0.9));\n}\n\n/* Heatmap */\n.heat-pos-1 { background: var(--heat-pos-1) !important; }\n.heat-pos-2 { background: var(--heat-pos-2) !important; }\n.heat-pos-3 { background: var(--heat-pos-3) !important; }\n.heat-pos-4 { background: var(--heat-pos-4) !important; }\n.heat-pos-5 { background: var(--heat-pos-5) !important; }\n.heat-neg-1 { background: var(--heat-neg-1) !important; }\n.heat-neg-2 { background: var(--heat-neg-2) !important; }\n.heat-neg-3 { background: var(--heat-neg-3) !important; }\n.heat-neg-4 { background: var(--heat-neg-4) !important; }\n.heat-neg-5 { background: var(--heat-neg-5) !important; }\n\n/* Tabs */\n.tabs-container { margin: 8px 0 20px; }\n\n.tab-buttons {\n  display: flex; gap: 0;\n  margin-bottom: -1px;\n  position: relative; z-index: 3;\n}\n\n.tab-btn {\n  padding: 8px 16px;\n  background: var(--bg-secondary);\n  border: 1px solid var(--border);\n  border-bottom: none;\n  color: var(--text-secondary);\n  font-size: 12px; cursor: pointer;\n  border-radius: 6px 6px 0 0;\n  transition: all 0.15s ease;\n}\n\n.tab-btn:hover { color: var(--text-primary); background: var(--bg-card); }\n.tab-btn.active {\n  color: var(--accent-gold);\n  background: var(--bg-card);\n  border-color: var(--accent-gold);\n  border-bottom: 1px solid var(--bg-card);\n}\n\n.tab-content { display: none; }\n.tab-content.active { display: block; }\n\n.empty-state {\n  padding: 32px; text-align: center;\n  color: var(--text-muted); font-size: 13px;\n  background: var(--bg-card);\n  border-radius: 8px;\n  border: 1px dashed var(--border);\n}\n\n/* Search */\n.search-bar { display: flex; align-items: center; margin-left: 24px; }\n\n.search-input {\n  background: var(--bg-card);\n  border: 1px solid var(--border);\n  color: var(--text-primary);\n  padding: 6px 12px; font-size: 12px;\n  border-radius: 6px; width: 200px;\n  outline: none; transition: border-color 0.2s;\n}\n\n.search-input:focus { border-color: var(--accent-blue); }\n.search-input::placeholder { color: var(--text-muted); }\n\n/* Print */\n@media print {\n  .sidebar, .top-header { display: none; }\n  .main-content { margin: 0; padding: 10px; }\n  table { font-size: 9px; }\n  th, td { padding: 3px 5px; }\n  .stat-card { break-inside: avoid; }\n}\n\n@keyframes fadeInUp {\n  from { opacity: 0; transform: translateY(12px); }\n  to { opacity: 1; transform: translateY(0); }\n}\n\n@media (max-width: 900px) {\n  .sidebar { display: none; }\n  .main-content { margin-left: 0; }\n}\n'''\n\n# ─── JavaScript ───\nJS = '''\nfunction switchTab(groupId, tabIdx) {\n  document.querySelectorAll(`[data-tabgroup=\"${groupId}\"]`).forEach(btn => btn.classList.remove('active'));\n  document.querySelectorAll(`[data-tab^=\"${groupId}-tab-\"]`).forEach(c => c.classList.remove('active'));\n  document.querySelector(`[data-tabgroup=\"${groupId}\"][data-tabidx=\"${tabIdx}\"]`).classList.add('active');\n  document.querySelector(`[data-tab=\"${groupId}-tab-${tabIdx}\"]`).classList.add('active');\n}\n\nfunction initNavHighlight() {\n  const sections = document.querySelectorAll('.section');\n  const navItems = document.querySelectorAll('.nav-item');\n  const observer = new IntersectionObserver((entries) => {\n    entries.forEach(entry => {\n      if (entry.isIntersecting) {\n        const id = entry.target.id;\n        navItems.forEach(item => {\n          item.classList.toggle('active', item.getAttribute('href') === '#' + id);\n        });\n      }\n    });\n  }, { threshold: 0.2, rootMargin: '-80px 0px -60% 0px' });\n  sections.forEach(s => observer.observe(s));\n}\n\nfunction initSearch() {\n  const input = document.getElementById('global-search');\n  if (!input) return;\n  input.addEventListener('input', (e) => {\n    const query = e.target.value.toLowerCase().trim();\n    document.querySelectorAll('table').forEach(table => {\n      table.querySelectorAll('tr:not(.header-row):not(.subheader-row)').forEach(row => {\n        if (!query) { row.style.display = ''; return; }\n        row.style.display = row.textContent.toLowerCase().includes(query) ? '' : 'none';\n      });\n    });\n  });\n}\n\nfunction initTableSort() {\n  document.querySelectorAll('th').forEach(th => {\n    th.style.cursor = 'pointer';\n    th.addEventListener('click', () => {\n      const table = th.closest('table');\n      const idx = Array.from(th.parentNode.children).indexOf(th);\n      const tbody = table.querySelector('tbody') || table;\n      const rows = Array.from(tbody.querySelectorAll('tr')).filter(r =>\n        !r.classList.contains('header-row') && !r.classList.contains('subheader-row') &&\n        !r.classList.contains('total-row') && !r.classList.contains('subtotal-row'));\n      const isAsc = th.getAttribute('data-sort') !== 'asc';\n      th.setAttribute('data-sort', isAsc ? 'asc' : 'desc');\n      rows.sort((a, b) => {\n        const aVal = a.children[idx]?.textContent?.trim()?.replace(/[()]/g, '') || '';\n        const bVal = b.children[idx]?.textContent?.trim()?.replace(/[()]/g, '') || '';\n        const aNum = parseFloat(aVal.replace(/[,%亿万只]/g, ''));\n        const bNum = parseFloat(bVal.replace(/[,%亿万只]/g, ''));\n        if (!isNaN(aNum) && !isNaN(bNum)) return isAsc ? aNum - bNum : bNum - aNum;\n        return isAsc ? aVal.localeCompare(bVal, 'zh') : bVal.localeCompare(aVal, 'zh');\n      });\n      rows.forEach(r => tbody.appendChild(r));\n    });\n  });\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  initNavHighlight();\n  initSearch();\n  initTableSort();\n});\n'''\n\n\n# ─── Assemble HTML ───\ndef generate_html():\n    # Sidebar navigation - grouped to match PDF structure\n    groups = {\n        '一、规模及发行': ['overview', 'channel-aum', 'product-scale', 'scale-changes', 'pm-metrics', 'maturity'],\n        '二、产品业绩': ['break-even', 'market-index', 'series-perf', 'min-hold-perf', 'underperform', 'high-vol'],\n        '三、资产与持仓': ['asset-alloc', 'fee-income', 'public-strategy', 'xinghe', 'bond-holdings',\n                     'outsource', 'derivatives', 'gold-equity'],\n    }\n\n    section_map = {s['id']: s for s in SECTIONS}\n\n    nav_html = ''\n    for group_name, section_ids in groups.items():\n        nav_html += f'<div class=\"sidebar-section\"><div class=\"sidebar-group-label\">{group_name}</div>'\n        for sid in section_ids:\n            sec = section_map.get(sid)\n            if sec:\n                nav_html += (f'<a class=\"nav-item\" href=\"#{sid}\">'\n                             f'<span class=\"nav-icon\">{sec[\"icon\"]}</span>{sec[\"title\"]}</a>')\n        nav_html += '</div>'\n\n    # Main content sections\n    content_html = ''\n    for section in SECTIONS:\n        section_content = generate_section_html(section)\n        content_html += f'''<div class=\"section\" id=\"{section['id']}\">\n<h2 class=\"section-header\">{escape_html(section['title'])}</h2>\n{section_content}\n</div>'''\n\n    from datetime import datetime\n    now = datetime.now().strftime('%Y-%m-%d %H:%M')\n\n    html = f'''<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>{REPORT_TITLE} - {REPORT_DATE}</title>\n<style>\n{CSS}\n</style>\n</head>\n<body>\n\n<header class=\"top-header\">\n  <div class=\"header-brand\">\n    <div class=\"header-logo\">XY</div>\n    <div class=\"header-title\">{REPORT_TITLE}</div>\n  </div>\n  <div class=\"search-bar\">\n    <input type=\"text\" id=\"global-search\" class=\"search-input\" placeholder=\"搜索产品/经理/代码...\">\n  </div>\n  <div class=\"header-date\">数据截止 {REPORT_DATE}</div>\n</header>\n\n<nav class=\"sidebar\">\n{nav_html}\n</nav>\n\n<main class=\"main-content\">\n{content_html}\n<footer style=\"text-align:center;padding:24px;color:var(--text-muted);font-size:11px;border-top:1px solid var(--border);margin-top:40px;\">\n  兴银理财多资产投资部 | 数据截止 {REPORT_DATE} | 仪表板生成于 {now}\n</footer>\n</main>\n\n<script>\n{JS}\n</script>\n</body>\n</html>'''\n\n    return html\n\n\n# ─── Main ───\nif __name__ == '__main__':\n    print('Generating dashboard HTML...')\n    html = generate_html()\n\n    with open(OUTPUT_HTML, 'w', encoding='utf-8') as f:\n        f.write(html)\n\n    file_size = os.path.getsize(OUTPUT_HTML)\n    print(f'Dashboard generated: {OUTPUT_HTML}')\n    print(f'File size: {file_size:,} bytes ({file_size/1024:.1f} KB)')\n    print(f'Sections: {len(SECTIONS)}')\n    print(f'Total sheets displayed: {sum(len(s[\"sheets\"]) for s in SECTIONS)}')\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":1,"cache_creation_input_tokens":2274,"cache_read_input_tokens":151187,"output_tokens":16862,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":2274}}},"requestId":"req_011CXwwupkSQPLNdUpQG2ZgQ","type":"assistant","uuid":"aca17055-a133-4f3c-b57a-c620988cfe29","timestamp":"2026-02-09T05:35:26.704Z"}
{"parentUuid":"aca17055-a133-4f3c-b57a-c620988cfe29","isSidechain":true,"userType":"external","cwd":"/private/tmp","sessionId":"785d3a51-0a04-4501-aca2-c87ea3b69707","version":"2.1.37","gitBranch":"main","agentId":"acompact-73e96c","slug":"joyful-soaring-rose","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_0116n6spHUu5bmMkyVfEF22C","type":"tool_result","content":"The file /tmp/generate_weekly_dashboard.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→#!/usr/bin/env python3\n     2→\"\"\"\n     3→Generate a comprehensive web dashboard for the weekly report.\n     4→Reads data from the extracted JSON and generates a self-contained HTML file.\n     5→Matches the structure and formatting of the PDF weekly report.\n     6→\"\"\"\n     7→import json\n     8→import os\n     9→import math\n    10→import re\n    11→\n    12→# ─── Configuration ───\n    13→JSON_PATH = '/tmp/weekly_report_data.json'\n    14→OUTPUT_HTML = '/Users/fanshengxia/Desktop/周报V2/输出结果/周报仪表板-20260205.html'\n    15→REPORT_DATE = '2026-02-05'\n    16→REPORT_TITLE = '多资产投资部理财产品运作周报'\n    17→\n    18→# ─── Load Data ───\n    19→with open(JSON_PATH, 'r', encoding='utf-8') as f:\n    20→    raw_data = json.load(f)\n    21→\n    22→output_sheets = raw_data['output_file']\n    23→vba_sheets = raw_data['vba_workbook']\n    24→\n    25→# ─── Sheets that should use integer display with parentheses for negatives ───\n    26→SCALE_INT_SHEETS = {\n    27→    '2、产品规模',\n    28→    '1、分渠道余额',\n    29→    '投资经理维度产品规模和数量',\n    30→    '不同形态产品规模和数量',\n    31→    '13.不同周期产品规模',\n    32→    '14.狭义客户周期和最短持有期的产品规模跟踪',\n    33→    '10.未来全年产品到期情况',\n    34→    '10.未来全年产品到期情况-定开',\n    35→}\n    36→\n    37→# ─── Sheets with percentage values already in percentage form (e.g., 1.87 = 1.87%) ───\n    38→PCT_RAW_SHEETS = {\n    39→    '15.市场指数收益',\n    40→}\n    41→\n    42→# ─── Sheets with percentage values in decimal form (e.g., 0.0187 = 1.87%) ───\n    43→PCT_DECIMAL_SHEETS = {\n    44→    '系列产品业绩-费后加权',\n    45→    '系列产品业绩-费后平均',\n    46→    '系列产品业绩-费前加权',\n    47→    '系列产品业绩-费前平均',\n    48→    '5.2 最短持有期产品业绩表现1',\n    49→    '5.2 最短持有期产品业绩表现2',\n    50→}\n    51→\n    52→\n    53→# ─── Helper Functions ───\n    54→\n    55→def is_numeric(val):\n    56→    if val is None:\n    57→        return False\n    58→    if isinstance(val, (int, float)):\n    59→        return not (isinstance(val, float) and (math.isnan(val) or math.isinf(val)))\n    60→    if isinstance(val, str):\n    61→        try:\n    62→            float(val)\n    63→            return True\n    64→        except:\n    65→            return False\n    66→    return False\n    67→\n    68→\n    69→def to_float(val):\n    70→    if val is None:\n    71→        return None\n    72→    if isinstance(val, (int, float)):\n    73→        if isinstance(val, float) and (math.isnan(val) or math.isinf(val)):\n    74→            return None\n    75→        return float(val)\n    76→    if isinstance(val, str):\n    77→        if val in ('nan', 'inf', '-inf', ''):\n    78→            return None\n    79→        try:\n    80→            return float(val)\n    81→        except:\n    82→            return None\n    83→    return None\n    84→\n    85→\n    86→def escape_html(s):\n    87→    if s is None:\n    88→        return ''\n    89→    s = str(s)\n    90→    return s.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('\"', '&quot;')\n    91→\n    92→\n    93→def detect_column_types(sheet_data, sheet_name=''):\n    94→    \"\"\"Detect which columns contain percentages, basis points, or regular numbers.\"\"\"\n    95→    data = sheet_data['data']\n    96→    headers = data[0] if data else []\n    97→    col_types = {}\n    98→\n    99→    for ci in range(len(headers)):\n   100→        h = str(headers[ci] or '')\n   101→        h_lower = h.lower()\n   102→\n   103→        # Force override for known sheet types\n   104→        if sheet_name in PCT_RAW_SHEETS:\n   105→            is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h\n   106→            if is_pct_header:\n   107→                col_types[ci] = 'percent_raw'\n   108→                continue\n   109→\n   110→        if sheet_name in PCT_DECIMAL_SHEETS:\n   111→            is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h\n   112→            if is_pct_header:\n   113→                col_types[ci] = 'percent'\n   114→                continue\n   115→\n   116→        if 'bp' in h_lower or '净值变化bp' in h:\n   117→            col_types[ci] = 'bps'\n   118→            continue\n   119→\n   120→        is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h or '比例' in h\n   121→\n   122→        if is_pct_header:\n   123→            numeric_vals = []\n   124→            for ri in range(1, min(len(data), 20)):\n   125→                if ci < len(data[ri]):\n   126→                    v = to_float(data[ri][ci])\n   127→                    if v is not None and v != 0:\n   128→                        numeric_vals.append(abs(v))\n   129→            if numeric_vals:\n   130→                avg = sum(numeric_vals) / len(numeric_vals)\n   131→                if avg > 0.5:\n   132→                    col_types[ci] = 'percent_raw'\n   133→                else:\n   134→                    col_types[ci] = 'percent'\n   135→            else:\n   136→                col_types[ci] = 'percent'\n   137→        else:\n   138→            # Auto-detect percentage columns by value range\n   139→            numeric_vals = []\n   140→            for ri in range(1, min(len(data), 20)):\n   141→                if ci < len(data[ri]):\n   142→                    v = to_float(data[ri][ci])\n   143→                    if v is not None and v != 0:\n   144→                        numeric_vals.append(abs(v))\n   145→            if len(numeric_vals) >= 2:\n   146→                avg = sum(numeric_vals) / len(numeric_vals)\n   147→                max_v = max(numeric_vals)\n   148→                if 0 < avg < 0.5 and max_v < 1.5:\n   149→                    col_types[ci] = 'percent'\n   150→\n   151→    return col_types\n   152→\n   153→\n   154→def format_cell_value(val, col_type=None, use_parens=False):\n   155→    \"\"\"Format a cell value based on its type.\n   156→    use_parens: if True, show negatives as (N) instead of -N, and use integer display for scale values.\n   157→    \"\"\"\n   158→    if val is None:\n   159→        return ''\n   160→    if isinstance(val, str):\n   161→        if val in ('nan', 'inf', '-inf'):\n   162→            return ''\n   163→        try:\n   164→            fval = float(val)\n   165→            val = fval\n   166→        except:\n   167→            return escape_html(val)\n   168→\n   169→    if isinstance(val, bool):\n   170→        return str(val)\n   171→    if not isinstance(val, (int, float)):\n   172→        return escape_html(str(val))\n   173→    if math.isnan(val) or math.isinf(val):\n   174→        return ''\n   175→\n   176→    if col_type == 'percent':\n   177→        pct = val * 100\n   178→        return f'{pct:.2f}%'\n   179→    elif col_type == 'percent_raw':\n   180→        return f'{val:.2f}%'\n   181→    elif col_type == 'bps':\n   182→        return f'{val:.2f}'\n   183→\n   184→    # Scale integer mode: show rounded integers with parentheses for negatives\n   185→    if use_parens:\n   186→        # For very small values close to 0\n   187→        if abs(val) < 0.005:\n   188→            return '-'\n   189→        # Round to reasonable precision\n   190→        rounded = round(val)\n   191→        if abs(val) < 1 and val != 0:\n   192→            # Show one decimal for small values\n   193→            if val < 0:\n   194→                return f'({abs(val):.1f})'\n   195→            return f'{val:.1f}'\n   196→        if rounded == 0 and val != 0:\n   197→            if val < 0:\n   198→                return '(0)'\n   199→            return '0'\n   200→        if rounded < 0:\n   201→            return f'({abs(rounded):,})'\n   202→        return f'{rounded:,}'\n   203→\n   204→    # Default formatting\n   205→    if isinstance(val, int) or (isinstance(val, float) and val == int(val) and abs(val) < 10000):\n   206→        return str(int(val))\n   207→    elif abs(val) < 0.0001 and val != 0:\n   208→        return f'{val:.6f}'\n   209→    elif abs(val) < 0.01 and val != 0:\n   210→        return f'{val:.4f}'\n   211→    elif abs(val) < 100:\n   212→        return f'{val:.2f}'\n   213→    elif abs(val) < 100000:\n   214→        return f'{val:,.2f}'\n   215→    else:\n   216→        return f'{val:,.0f}'\n   217→\n   218→\n   219→def get_cell_class(val, col_type=None, header=''):\n   220→    \"\"\"Get CSS class for conditional formatting.\"\"\"\n   221→    classes = []\n   222→    if val is None:\n   223→        return ''\n   224→\n   225→    fval = to_float(val)\n   226→    if fval is None:\n   227→        return ''\n   228→\n   229→    h = str(header).lower()\n   230→\n   231→    is_change = any(kw in h for kw in ['变化', '较上周', '较上月', '较上年', 'bp'])\n   232→    is_return = any(kw in h for kw in ['年化', '收益率'])\n   233→\n   234→    if is_change:\n   235→        if fval > 0:\n   236→            classes.append('val-positive')\n   237→        elif fval < 0:\n   238→            classes.append('val-negative')\n   239→\n   240→    if is_return and col_type == 'percent':\n   241→        if fval < 0:\n   242→            classes.append('val-negative')\n   243→\n   244→    # Heatmap intensity for change columns\n   245→    if is_change and fval != 0:\n   246→        if col_type == 'percent':\n   247→            intensity = min(abs(fval) * 20, 1)\n   248→        elif col_type == 'percent_raw':\n   249→            intensity = min(abs(fval) / 5, 1)\n   250→        elif 'bp' in h:\n   251→            intensity = min(abs(fval) / 50, 1)\n   252→        else:\n   253→            intensity = min(abs(fval) / 20, 1)\n   254→        level = min(int(intensity * 5) + 1, 5)\n   255→        if fval > 0:\n   256→            classes.append(f'heat-pos-{level}')\n   257→        else:\n   258→            classes.append(f'heat-neg-{level}')\n   259→\n   260→    return ' '.join(classes)\n   261→\n   262→\n   263→def parse_merged_cells(merged_list):\n   264→    \"\"\"Parse merged cell ranges into a dict of (row,col) -> (rowspan, colspan).\"\"\"\n   265→    merges = {}\n   266→    skip = set()\n   267→    for m in merged_list:\n   268→        match = re.match(r'([A-Z]+)(\\d+):([A-Z]+)(\\d+)', m)\n   269→        if not match:\n   270→            continue\n   271→        c1 = col_letter_to_num(match.group(1))\n   272→        r1 = int(match.group(2))\n   273→        c2 = col_letter_to_num(match.group(3))\n   274→        r2 = int(match.group(4))\n   275→        rowspan = r2 - r1 + 1\n   276→        colspan = c2 - c1 + 1\n   277→        merges[(r1, c1)] = (rowspan, colspan)\n   278→        for r in range(r1, r2 + 1):\n   279→            for c in range(c1, c2 + 1):\n   280→                if (r, c) != (r1, c1):\n   281→                    skip.add((r, c))\n   282→    return merges, skip\n   283→\n   284→\n   285→def col_letter_to_num(letters):\n   286→    num = 0\n   287→    for ch in letters:\n   288→        num = num * 26 + (ord(ch) - ord('A') + 1)\n   289→    return num\n   290→\n   291→\n   292→# ─── Data Preprocessing ───\n   293→def preprocess_sheets():\n   294→    \"\"\"Add computed subtotal rows and fix data where needed.\"\"\"\n   295→\n   296→    # 1. Add subtotal rows to 分渠道余额\n   297→    sheet = output_sheets.get('1、分渠道余额')\n   298→    if sheet and sheet.get('data'):\n   299→        data = sheet['data']\n   300→        new_data = list(data[:3])  # Keep headers (rows 0-2)\n   301→\n   302→        # Group rows by 总分类\n   303→        groups = {}\n   304→        current_group = None\n   305→        for ri in range(3, len(data)):\n   306→            row = data[ri]\n   307→            if row[0] is not None:\n   308→                current_group = str(row[0])\n   309→            if current_group:\n   310→                if current_group not in groups:\n   311→                    groups[current_group] = []\n   312→                groups[current_group].append(row)\n   313→\n   314→        grand_total = [0, 0, 0]\n   315→\n   316→        for group_name in ['中低波稳健产品', '中高波市值产品', '外币产品']:\n   317→            rows = groups.get(group_name, [])\n   318→            subtotal = [0, 0]  # 行内, 行外\n   319→            for row in rows:\n   320→                v_inner = to_float(row[2])\n   321→                v_outer = to_float(row[3])\n   322→                if v_inner:\n   323→                    subtotal[0] += v_inner\n   324→                if v_outer:\n   325→                    subtotal[1] += v_outer\n   326→                new_data.append(row)\n   327→\n   328→            total_val = subtotal[0] + subtotal[1]\n   329→            # Add subtotal row\n   330→            label = f'{group_name}合计'\n   331→            new_data.append([None, label, round(subtotal[0]), round(subtotal[1])])\n   332→            grand_total[0] += subtotal[0]\n   333→            grand_total[1] += subtotal[1]\n   334→\n   335→        # Add 合计 column header\n   336→        if len(new_data[0]) == 4:\n   337→            new_data[0] = [None, None, '保有规模', None, None]\n   338→            new_data[1] = [None, '渠道-行内外', '行内', '行外', '合计']\n   339→            new_data[2] = ['总分类', '母分类', None, None, None]\n   340→\n   341→        # Add 合计 column to each data row\n   342→        for ri in range(3, len(new_data)):\n   343→            row = new_data[ri]\n   344→            if len(row) == 4:\n   345→                v1 = to_float(row[2]) or 0\n   346→                v2 = to_float(row[3]) or 0\n   347→                row.append(round(v1 + v2))\n   348→            elif len(row) == 5:\n   349→                pass  # already has 合计\n   350→\n   351→        # Add 总计 row\n   352→        new_data.append([None, '总计', round(grand_total[0]), round(grand_total[1]),\n   353→                         round(grand_total[0] + grand_total[1])])\n   354→\n   355→        sheet['data'] = new_data\n   356→        sheet['col_count'] = 5\n   357→\n   358→    # 2. Add 合计 row to 产品规模\n   359→    sheet = output_sheets.get('2、产品规模')\n   360→    if sheet and sheet.get('data'):\n   361→        data = sheet['data']\n   362→        # Check if 合计 row already exists\n   363→        has_total = any(str(row[0] or '').strip() in ('合计', '总计') for row in data[1:])\n   364→        if not has_total:\n   365→            totals = [0] * len(data[0])\n   366→            for row in data[1:]:\n   367→                for ci in range(2, len(row)):\n   368→                    v = to_float(row[ci])\n   369→                    if v is not None:\n   370→                        totals[ci] += v\n   371→            total_row = ['', '合计']\n   372→            for ci in range(2, len(data[0])):\n   373→                total_row.append(round(totals[ci]))\n   374→            while len(total_row) < len(data[0]):\n   375→                total_row.append(None)\n   376→            data.append(total_row)\n   377→\n   378→    # 3. Add 合计 row to 投资经理维度\n   379→    sheet = output_sheets.get('投资经理维度产品规模和数量')\n   380→    if sheet and sheet.get('data'):\n   381→        data = sheet['data']\n   382→        has_total = any(str(row[0] or '').strip() in ('合计', '总计') for row in data[1:])\n   383→        if not has_total:\n   384→            totals = [0] * len(data[0])\n   385→            for row in data[1:]:\n   386→                for ci in range(1, len(row)):\n   387→                    v = to_float(row[ci])\n   388→                    if v is not None:\n   389→                        totals[ci] += v\n   390→            total_row = ['合计']\n   391→            for ci in range(1, len(data[0])):\n   392→                total_row.append(round(totals[ci], 1))\n   393→            while len(total_row) < len(data[0]):\n   394→                total_row.append(None)\n   395→            data.append(total_row)\n   396→\n   397→\n   398→preprocess_sheets()\n   399→\n   400→\n   401→# ─── Section Definitions (matching PDF TOC order) ───\n   402→SECTIONS = [\n   403→    {\n   404→        'id': 'overview',\n   405→        'title': '报告概览',\n   406→        'icon': '&#9670;',\n   407→        'sheets': ['总结文字'],\n   408→        'type': 'overview'\n   409→    },\n   410→    # ─── 一、规模及发行情况 ───\n   411→    {\n   412→        'id': 'channel-aum',\n   413→        'title': '1. 渠道代销规模',\n   414→        'icon': '&#9632;',\n   415→        'sheets': ['1、分渠道余额', '渠道明细'],\n   416→        'type': 'tables'\n   417→    },\n   418→    {\n   419→        'id': 'product-scale',\n   420→        'title': '2. 产品规模',\n   421→        'icon': '&#9632;',\n   422→        'sheets': ['2、产品规模', '不同形态产品规模和数量', '13.不同周期产品规模',\n   423→                   '14.狭义客户周期和最短持有期的产品规模跟踪'],\n   424→        'type': 'tables'\n   425→    },\n   426→    {\n   427→        'id': 'scale-changes',\n   428→        'title': '3. 在售产品销售情况',\n   429→        'icon': '&#9632;',\n   430→        'sheets': ['3、本月定开或客户周期产品规模变化', '本周新发产品', '待售产品'],\n   431→        'type': 'tables'\n   432→    },\n   433→    {\n   434→        'id': 'pm-metrics',\n   435→        'title': '4. 投资经理维度',\n   436→        'icon': '&#9632;',\n   437→        'sheets': ['投资经理维度产品规模和数量'],\n   438→        'type': 'tables'\n   439→    },\n   440→    {\n   441→        'id': 'maturity',\n   442→        'title': '5. 产品到期情况',\n   443→        'icon': '&#9670;',\n   444→        'sheets': ['10.未来全年产品到期情况', '10.未来全年产品到期情况-定开', '10.下周到期产品清单'],\n   445→        'type': 'tables'\n   446→    },\n   447→    # ─── 二、产品业绩 ───\n   448→    {\n   449→        'id': 'break-even',\n   450→        'title': '6. 破净情况',\n   451→        'icon': '&#9670;',\n   452→        'sheets': ['破净结果'],\n   453→        'type': 'tables'\n   454→    },\n   455→    {\n   456→        'id': 'market-index',\n   457→        'title': '7. 市场指数收益',\n   458→        'icon': '&#9670;',\n   459→        'sheets': ['15.市场指数收益'],\n   460→        'type': 'tables'\n   461→    },\n   462→    {\n   463→        'id': 'series-perf',\n   464→        'title': '8. 系列产品业绩',\n   465→        'icon': '&#9670;',\n   466→        'sheets': ['系列产品业绩-费前加权', '系列产品业绩-费后加权', '系列产品业绩-费前平均', '系列产品业绩-费后平均'],\n   467→        'type': 'tabs'\n   468→    },\n   469→    {\n   470→        'id': 'min-hold-perf',\n   471→        'title': '9. 最短持有期业绩',\n   472→        'icon': '&#9670;',\n   473→        'sheets': ['5.2 最短持有期产品业绩表现1', '5.2 最短持有期产品业绩表现2'],\n   474→        'type': 'tables'\n   475→    },\n   476→    {\n   477→        'id': 'underperform',\n   478→        'title': '10. 不达基准清单',\n   479→        'icon': '&#9888;',\n   480→        'sheets': ['招商在售产品不达基准', '封闭及定开产品100日内不大业绩产品清单',\n   481→                   '合享及悦动稳享临近到期预测不达标产品清单'],\n   482→        'type': 'tables'\n   483→    },\n   484→    {\n   485→        'id': 'high-vol',\n   486→        'title': '11. 高波动产品',\n   487→        'icon': '&#9888;',\n   488→        'sheets': ['12.周净值高波动产品清单'],\n   489→        'type': 'tables'\n   490→    },\n   491→    # ─── 资产与持仓 ───\n   492→    {\n   493→        'id': 'asset-alloc',\n   494→        'title': '12. 资产维度数据统计',\n   495→        'icon': '&#9679;',\n   496→        'sheets': ['8.资产大表'],\n   497→        'type': 'tables'\n   498→    },\n   499→    {\n   500→        'id': 'fee-income',\n   501→        'title': '13. 中收监控',\n   502→        'icon': '&#9679;',\n   503→        'sheets': ['9.中收监控'],\n   504→        'type': 'tables'\n   505→    },\n   506→    {\n   507→        'id': 'public-strategy',\n   508→        'title': '14. 公共策略专户',\n   509→        'icon': '&#9679;',\n   510→        'sheets': ['公共策略持仓概况'],\n   511→        'type': 'tables'\n   512→    },\n   513→    {\n   514→        'id': 'xinghe',\n   515→        'title': '15. 兴合产品持仓',\n   516→        'icon': '&#9679;',\n   517→        'sheets': ['11.兴合产品持仓明细'],\n   518→        'type': 'tables'\n   519→    },\n   520→    {\n   521→        'id': 'bond-holdings',\n   522→        'title': '16. 可转债/量化持仓',\n   523→        'icon': '&#9679;',\n   524→        'sheets': ['11.1 可转债专户持仓明细', '11.2量化和可转债持仓明细'],\n   525→        'type': 'tables'\n   526→    },\n   527→    {\n   528→        'id': 'outsource',\n   529→        'title': '17. 委外专户配置',\n   530→        'icon': '&#9679;',\n   531→        'sheets': ['11.2.1其他委外专户金额配置情况', '11.2.2其他委外专户配置占比情况',\n   532→                   '11.2.3其他委外专户配置占比情况-除以系列规模'],\n   533→        'type': 'tables'\n   534→    },\n   535→    {\n   536→        'id': 'derivatives',\n   537→        'title': '18. 衍生品/非标持仓',\n   538→        'icon': '&#9679;',\n   539→        'sheets': ['11.4其他衍生品专户持仓明细', '11.5全部衍生品专户持仓占比', '11.6非标持仓占比'],\n   540→        'type': 'tables'\n   541→    },\n   542→    {\n   543→        'id': 'gold-equity',\n   544→        'title': '19. 黄金/权益持仓',\n   545→        'icon': '&#9679;',\n   546→        'sheets': ['黄金持仓', '权益专户持仓'],\n   547→        'type': 'tables'\n   548→    },\n   549→]\n   550→\n   551→\n   552→# ─── Compute Overview Stats ───\n   553→def compute_overview_stats():\n   554→    stats = {}\n   555→\n   556→    ps = output_sheets.get('2、产品规模', {})\n   557→    if ps.get('data'):\n   558→        total_aum = 0\n   559→        total_count = 0\n   560→        total_aum_m = 0\n   561→        total_aum_y = 0\n   562→        for row in ps['data'][1:]:\n   563→            first = str(row[0] or '').strip() if row[0] else ''\n   564→            second = str(row[1] or '').strip() if len(row) > 1 else ''\n   565→            # Skip the 合计 row we added\n   566→            if first in ('合计', '总计') or second in ('合计', '总计'):\n   567→                continue\n   568→            v = to_float(row[2]) if len(row) > 2 else None\n   569→            if v is not None:\n   570→                total_aum += v\n   571→            v = to_float(row[5]) if len(row) > 5 else None\n   572→            if v is not None:\n   573→                total_count += v\n   574→            v = to_float(row[3]) if len(row) > 3 else None\n   575→            if v is not None:\n   576→                total_aum_m += v\n   577→            v = to_float(row[4]) if len(row) > 4 else None\n   578→            if v is not None:\n   579→                total_aum_y += v\n   580→        stats['total_aum'] = total_aum\n   581→        stats['total_count'] = total_count\n   582→        stats['aum_vs_month'] = total_aum_m\n   583→        stats['aum_vs_year'] = total_aum_y\n   584→\n   585→    text_sheet = output_sheets.get('总结文字', {})\n   586→    if text_sheet.get('data'):\n   587→        for row in text_sheet['data'][1:]:\n   588→            if len(row) >= 2 and row[0] and row[1]:\n   589→                key = str(row[0])\n   590→                val = str(row[1])\n   591→                if '规模' in key:\n   592→                    stats['guimo_text'] = val\n   593→                elif '中收' in key:\n   594→                    stats['zhongshou_text'] = val\n   595→                elif '到期' in key:\n   596→                    stats['daoqi_text'] = val\n   597→\n   598→    bp_sheet = output_sheets.get('破净结果', {})\n   599→    if bp_sheet.get('data'):\n   600→        data_rows = [r for r in bp_sheet['data'][1:] if any(v is not None for v in r)]\n   601→        stats['broken_count'] = len(data_rows)\n   602→\n   603→    up_sheet = output_sheets.get('招商在售产品不达基准', {})\n   604→    if up_sheet.get('data'):\n   605→        stats['underperform_count'] = len(up_sheet['data']) - 1\n   606→\n   607→    hv_sheet = output_sheets.get('12.周净值高波动产品清单', {})\n   608→    if hv_sheet.get('data'):\n   609→        stats['high_vol_count'] = len(hv_sheet['data']) - 1\n   610→\n   611→    return stats\n   612→\n   613→\n   614→# ─── Generate HTML Table ───\n   615→def generate_table_html(sheet_name, sheet_data, table_id=''):\n   616→    \"\"\"Generate an HTML table from sheet data with formatting.\"\"\"\n   617→    if not sheet_data or not sheet_data.get('data'):\n   618→        return f'<div class=\"empty-state\">暂无数据</div>'\n   619→\n   620→    data = sheet_data['data']\n   621→    merged_cells = sheet_data.get('merged_cells', [])\n   622→    merges, skip_cells = parse_merged_cells(merged_cells)\n   623→    col_types = detect_column_types(sheet_data, sheet_name)\n   624→    use_parens = sheet_name in SCALE_INT_SHEETS\n   625→\n   626→    rows_html = []\n   627→    num_cols = sheet_data.get('col_count', 0)\n   628→\n   629→    for ri, row in enumerate(data):\n   630→        is_header = ri == 0\n   631→        # Check if this is a sub-header row (mostly text, not data)\n   632→        is_subheader = False\n   633→        if ri in (1, 2) and ri < len(data):\n   634→            row_vals = [v for v in row if v is not None]\n   635→            numeric_count = sum(1 for v in row_vals if is_numeric(v))\n   636→            text_count = len(row_vals) - numeric_count\n   637→            if row_vals and text_count > numeric_count and text_count >= 2:\n   638→                is_subheader = True\n   639→\n   640→        cells_html = []\n   641→        for ci in range(min(len(row), num_cols)):\n   642→            if (ri + 1, ci + 1) in skip_cells:\n   643→                continue\n   644→\n   645→            val = row[ci]\n   646→            merge_info = merges.get((ri + 1, ci + 1))\n   647→\n   648→            tag = 'th' if is_header or (is_subheader and ri < 3) else 'td'\n   649→\n   650→            col_header = str(data[0][ci] or '') if ci < len(data[0]) else ''\n   651→            col_type = col_types.get(ci)\n   652→\n   653→            # Format value\n   654→            if is_header or (is_subheader and ri < 3):\n   655→                display = escape_html(str(val)) if val is not None else ''\n   656→            else:\n   657→                display = format_cell_value(val, col_type, use_parens=use_parens)\n   658→\n   659→            # Build attributes\n   660→            attrs = []\n   661→            css_classes = []\n   662→\n   663→            if merge_info:\n   664→                rs, cs = merge_info\n   665→                if rs > 1:\n   666→                    attrs.append(f'rowspan=\"{rs}\"')\n   667→                if cs > 1:\n   668→                    attrs.append(f'colspan=\"{cs}\"')\n   669→\n   670→            if not is_header and not is_subheader:\n   671→                cell_class = get_cell_class(val, col_type, col_header)\n   672→                if cell_class:\n   673→                    css_classes.append(cell_class)\n   674→                fval = to_float(val)\n   675→                if fval is not None:\n   676→                    css_classes.append('num-cell')\n   677→\n   678→            if css_classes:\n   679→                attrs.append(f'class=\"{\" \".join(css_classes)}\"')\n   680→\n   681→            attrs_str = ' ' + ' '.join(attrs) if attrs else ''\n   682→            cells_html.append(f'<{tag}{attrs_str}>{display}</{tag}>')\n   683→\n   684→        # Determine row class\n   685→        row_class = 'header-row' if is_header else ('subheader-row' if is_subheader and ri < 3 else '')\n   686→        if not is_header and row:\n   687→            first_val = str(row[0] or '').strip()\n   688→            second_val = str(row[1] or '').strip() if len(row) > 1 else ''\n   689→            if first_val in ('合计', '总计', '总合计', '汇总', '总规模') or \\\n   690→               second_val in ('合计', '总计', '汇总'):\n   691→                row_class = 'total-row'\n   692→            # Subtotal rows (e.g., \"中低波稳健产品合计\")\n   693→            elif '合计' in second_val:\n   694→                row_class = 'subtotal-row'\n   695→            # Check any of first 3 cells for 合计\n   696→            elif any('合计' in str(v or '') for v in row[:3]):\n   697→                row_class = 'total-row'\n   698→\n   699→        row_class_attr = f' class=\"{row_class}\"' if row_class else ''\n   700→        rows_html.append(f'<tr{row_class_attr}>{\"\".join(cells_html)}</tr>')\n   701→\n   702→    tid = f' id=\"{table_id}\"' if table_id else ''\n   703→    return f'''<div class=\"table-wrapper\">\n   704→<table{tid}>\n   705→{\"\".join(rows_html)}\n   706→</table>\n   707→</div>'''\n   708→\n   709→\n   710→# ─── Generate Section HTML ───\n   711→def generate_section_html(section):\n   712→    parts = []\n   713→\n   714→    if section['type'] == 'overview':\n   715→        stats = compute_overview_stats()\n   716→        parts.append(generate_overview_html(stats))\n   717→\n   718→    elif section['type'] == 'tabs':\n   719→        tab_names = []\n   720→        tab_contents = []\n   721→        for i, sn in enumerate(section['sheets']):\n   722→            sd = output_sheets.get(sn)\n   723→            if not sd:\n   724→                continue\n   725→            # Create display-friendly tab names\n   726→            short = sn.replace('系列产品业绩-', '')\n   727→            tab_names.append(short)\n   728→            active = 'active' if i == 0 else ''\n   729→            tab_contents.append(\n   730→                f'<div class=\"tab-content {active}\" data-tab=\"{section[\"id\"]}-tab-{i}\">'\n   731→                f'{generate_table_html(sn, sd)}</div>')\n   732→\n   733→        tabs_html = ''.join(\n   734→            f'<button class=\"tab-btn {\"active\" if i == 0 else \"\"}\" '\n   735→            f'onclick=\"switchTab(\\'{section[\"id\"]}\\', {i})\" '\n   736→            f'data-tabgroup=\"{section[\"id\"]}\" data-tabidx=\"{i}\">{tn}</button>'\n   737→            for i, tn in enumerate(tab_names)\n   738→        )\n   739→        parts.append(\n   740→            f'<div class=\"tabs-container\"><div class=\"tab-buttons\">{tabs_html}</div>'\n   741→            f'{\"\".join(tab_contents)}</div>')\n   742→\n   743→    elif section['type'] == 'tables':\n   744→        for sn in section['sheets']:\n   745→            sd = output_sheets.get(sn)\n   746→            if not sd:\n   747→                continue\n   748→            # Display-friendly subtitle\n   749→            subtitle = sn\n   750→            parts.append(f'<h3 class=\"sheet-title\">{escape_html(subtitle)}</h3>')\n   751→            parts.append(generate_table_html(sn, sd))\n   752→\n   753→    return '\\n'.join(parts)\n   754→\n   755→\n   756→def generate_overview_html(stats):\n   757→    aum = stats.get('total_aum')\n   758→    aum_str = f'{aum:,.0f}亿' if aum and aum > 100 else (f'{aum:,.2f}亿' if aum else 'N/A')\n   759→    count = stats.get('total_count')\n   760→    count_str = f'{int(count)}只' if count else 'N/A'\n   761→    aum_m = stats.get('aum_vs_month')\n   762→    aum_m_str = f'{aum_m:+.0f}亿' if aum_m is not None else 'N/A'\n   763→    aum_m_class = 'stat-positive' if aum_m and aum_m > 0 else ('stat-negative' if aum_m and aum_m < 0 else '')\n   764→    aum_y = stats.get('aum_vs_year')\n   765→    aum_y_str = f'{aum_y:+.0f}亿' if aum_y is not None else 'N/A'\n   766→    aum_y_class = 'stat-positive' if aum_y and aum_y > 0 else ('stat-negative' if aum_y and aum_y < 0 else '')\n   767→\n   768→    broken = stats.get('broken_count', 0)\n   769→    broken_class = 'stat-alert' if broken > 0 else 'stat-ok'\n   770→    broken_str = f'{broken}只' if broken > 0 else '无'\n   771→\n   772→    underperf = stats.get('underperform_count', 0)\n   773→    high_vol = stats.get('high_vol_count', 0)\n   774→\n   775→    text_cards = ''\n   776→    for key, label in [('guimo_text', '规模概况'), ('zhongshou_text', '中收概况'), ('daoqi_text', '到期概况')]:\n   777→        text = stats.get(key, '')\n   778→        if text:\n   779→            text_display = escape_html(text).replace('\\n', '<br>')\n   780→            text_cards += f'''<div class=\"text-card\">\n   781→<div class=\"text-card-label\">{label}</div>\n   782→<div class=\"text-card-content\">{text_display}</div>\n   783→</div>'''\n   784→\n   785→    # Build bar chart from 产品规模 data\n   786→    ps = output_sheets.get('2、产品规模', {})\n   787→    bar_items = []\n   788→    if ps.get('data'):\n   789→        max_aum = 0\n   790→        for row in ps['data'][1:]:\n   791→            second = str(row[1] or '').strip() if len(row) > 1 else ''\n   792→            if second in ('合计', '总计'):\n   793→                continue\n   794→            v = to_float(row[2]) if len(row) > 2 else None\n   795→            if v and v > max_aum:\n   796→                max_aum = v\n   797→        for row in ps['data'][1:]:\n   798→            name = str(row[1] or '')\n   799→            if name in ('合计', '总计'):\n   800→                continue\n   801→            v = to_float(row[2]) if len(row) > 2 else 0\n   802→            chg = to_float(row[3]) if len(row) > 3 else 0\n   803→            if v and name:\n   804→                pct = (v / max_aum * 100) if max_aum > 0 else 0\n   805→                color = 'var(--positive)' if chg and chg > 0 else (\n   806→                    'var(--negative)' if chg and chg < 0 else 'var(--accent-blue)')\n   807→                bar_items.append(f'''<div class=\"bar-row\">\n   808→  <div class=\"bar-label\" title=\"{escape_html(name)}\">{escape_html(name[:8])}</div>\n   809→  <div class=\"bar-track\"><div class=\"bar-fill\" style=\"width:{pct:.1f}%;background:{color}\"></div></div>\n   810→  <div class=\"bar-value\">{v:.0f}</div>\n   811→</div>''')\n   812→\n   813→    bars_html = '\\n'.join(bar_items) if bar_items else ''\n   814→\n   815→    return f'''\n   816→<div class=\"overview-grid\">\n   817→  <div class=\"stat-card stat-primary\">\n   818→    <div class=\"stat-label\">管理规模</div>\n   819→    <div class=\"stat-value\">{aum_str}</div>\n   820→    <div class=\"stat-sub\">\n   821→      <span class=\"{aum_m_class}\">较上月 {aum_m_str}</span>\n   822→      <span class=\"{aum_y_class}\">较年初 {aum_y_str}</span>\n   823→    </div>\n   824→  </div>\n   825→  <div class=\"stat-card\">\n   826→    <div class=\"stat-label\">产品数量</div>\n   827→    <div class=\"stat-value\">{count_str}</div>\n   828→  </div>\n   829→  <div class=\"stat-card {broken_class}\">\n   830→    <div class=\"stat-label\">破净产品</div>\n   831→    <div class=\"stat-value\">{broken_str}</div>\n   832→  </div>\n   833→  <div class=\"stat-card {\"stat-alert\" if underperf > 3 else \"\"}\">\n   834→    <div class=\"stat-label\">不达基准</div>\n   835→    <div class=\"stat-value\">{underperf}只</div>\n   836→  </div>\n   837→  <div class=\"stat-card {\"stat-alert\" if high_vol > 20 else \"\"}\">\n   838→    <div class=\"stat-label\">高波动产品</div>\n   839→    <div class=\"stat-value\">{high_vol}只</div>\n   840→  </div>\n   841→</div>\n   842→<div class=\"overview-grid\" style=\"grid-template-columns: 1fr 1fr;\">\n   843→  <div class=\"stat-card\" style=\"padding:14px 18px;\">\n   844→    <div class=\"stat-label\" style=\"margin-bottom:10px;\">各系列规模分布 (亿)</div>\n   845→    <div class=\"bar-chart\">{bars_html}</div>\n   846→  </div>\n   847→  <div class=\"stat-card\" style=\"padding:14px 18px;\">\n   848→    <div class=\"stat-label\" style=\"margin-bottom:6px;\">AI 摘要</div>\n   849→    <div class=\"text-cards-inline\">\n   850→{text_cards}\n   851→    </div>\n   852→  </div>\n   853→</div>\n   854→'''\n   855→\n   856→\n   857→# ─── CSS Styles ───\n   858→CSS = '''\n   859→@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Source+Han+Sans+SC:wght@300;400;500;700&display=swap');\n   860→\n   861→:root {\n   862→  --bg-primary: #050a18;\n   863→  --bg-secondary: #0c1425;\n   864→  --bg-card: #111c32;\n   865→  --bg-card-hover: #162040;\n   866→  --bg-table-header: #0f1b33;\n   867→  --bg-table-row-alt: #0a1226;\n   868→  --bg-sidebar: #080e1f;\n   869→  --bg-sidebar-active: #1a2744;\n   870→\n   871→  --text-primary: #e2e8f0;\n   872→  --text-secondary: #94a3b8;\n   873→  --text-muted: #64748b;\n   874→  --text-header: #f1f5f9;\n   875→\n   876→  --accent-gold: #f59e0b;\n   877→  --accent-blue: #3b82f6;\n   878→  --accent-cyan: #06b6d4;\n   879→\n   880→  --positive: #10b981;\n   881→  --positive-bg: rgba(16, 185, 129, 0.08);\n   882→  --negative: #ef4444;\n   883→  --negative-bg: rgba(239, 68, 68, 0.08);\n   884→  --alert: #f97316;\n   885→  --alert-bg: rgba(249, 115, 22, 0.08);\n   886→\n   887→  --border: #1e293b;\n   888→  --border-light: #1a2540;\n   889→\n   890→  --sidebar-width: 260px;\n   891→  --header-height: 56px;\n   892→\n   893→  --heat-pos-1: rgba(16, 185, 129, 0.1);\n   894→  --heat-pos-2: rgba(16, 185, 129, 0.2);\n   895→  --heat-pos-3: rgba(16, 185, 129, 0.3);\n   896→  --heat-pos-4: rgba(16, 185, 129, 0.45);\n   897→  --heat-pos-5: rgba(16, 185, 129, 0.6);\n   898→  --heat-neg-1: rgba(239, 68, 68, 0.1);\n   899→  --heat-neg-2: rgba(239, 68, 68, 0.2);\n   900→  --heat-neg-3: rgba(239, 68, 68, 0.3);\n   901→  --heat-neg-4: rgba(239, 68, 68, 0.45);\n   902→  --heat-neg-5: rgba(239, 68, 68, 0.6);\n   903→}\n   904→\n   905→* { box-sizing: border-box; margin: 0; padding: 0; }\n   906→\n   907→html {\n   908→  font-size: 13px;\n   909→  scroll-behavior: smooth;\n   910→}\n   911→\n   912→body {\n   913→  font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", \"Noto Sans SC\", sans-serif;\n   914→  background: var(--bg-primary);\n   915→  color: var(--text-primary);\n   916→  line-height: 1.5;\n   917→  overflow-x: hidden;\n   918→}\n   919→\n   920→/* Header */\n   921→.top-header {\n   922→  position: fixed;\n   923→  top: 0; left: 0; right: 0;\n   924→  height: var(--header-height);\n   925→  background: linear-gradient(135deg, #0a1628 0%, #0f1d35 100%);\n   926→  border-bottom: 1px solid var(--border);\n   927→  display: flex; align-items: center;\n   928→  padding: 0 24px;\n   929→  z-index: 100;\n   930→  backdrop-filter: blur(12px);\n   931→}\n   932→\n   933→.header-brand { display: flex; align-items: center; gap: 12px; }\n   934→\n   935→.header-logo {\n   936→  width: 32px; height: 32px;\n   937→  background: linear-gradient(135deg, var(--accent-gold), #d97706);\n   938→  border-radius: 8px;\n   939→  display: flex; align-items: center; justify-content: center;\n   940→  font-weight: 700; font-size: 14px; color: #0a0f1c;\n   941→}\n   942→\n   943→.header-title {\n   944→  font-family: \"Noto Serif SC\", serif;\n   945→  font-size: 16px; font-weight: 700;\n   946→  color: var(--text-header);\n   947→  letter-spacing: 1px;\n   948→}\n   949→\n   950→.header-date {\n   951→  margin-left: auto;\n   952→  font-size: 12px; color: var(--text-secondary);\n   953→  background: var(--bg-card);\n   954→  padding: 4px 12px; border-radius: 4px;\n   955→  border: 1px solid var(--border);\n   956→  font-variant-numeric: tabular-nums;\n   957→}\n   958→\n   959→/* Sidebar */\n   960→.sidebar {\n   961→  position: fixed;\n   962→  top: var(--header-height); left: 0; bottom: 0;\n   963→  width: var(--sidebar-width);\n   964→  background: var(--bg-sidebar);\n   965→  border-right: 1px solid var(--border);\n   966→  overflow-y: auto;\n   967→  padding: 12px 0; z-index: 90;\n   968→}\n   969→\n   970→.sidebar::-webkit-scrollbar { width: 4px; }\n   971→.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }\n   972→\n   973→.sidebar-section { padding: 4px 0; }\n   974→\n   975→.sidebar-group-label {\n   976→  font-size: 10px; font-weight: 600;\n   977→  color: var(--text-muted);\n   978→  text-transform: uppercase;\n   979→  letter-spacing: 1.5px;\n   980→  padding: 12px 20px 4px;\n   981→}\n   982→\n   983→.nav-item {\n   984→  display: flex; align-items: center; gap: 10px;\n   985→  padding: 8px 20px;\n   986→  color: var(--text-secondary);\n   987→  text-decoration: none; font-size: 12.5px;\n   988→  cursor: pointer;\n   989→  transition: all 0.15s ease;\n   990→  border-left: 3px solid transparent;\n   991→}\n   992→\n   993→.nav-item:hover { color: var(--text-primary); background: var(--bg-card); }\n   994→\n   995→.nav-item.active {\n   996→  color: var(--accent-gold);\n   997→  background: var(--bg-sidebar-active);\n   998→  border-left-color: var(--accent-gold);\n   999→}\n  1000→\n  1001→.nav-icon { font-size: 8px; opacity: 0.6; width: 14px; text-align: center; }\n  1002→\n  1003→/* Main Content */\n  1004→.main-content {\n  1005→  margin-left: var(--sidebar-width);\n  1006→  margin-top: var(--header-height);\n  1007→  padding: 24px 28px;\n  1008→  min-height: calc(100vh - var(--header-height));\n  1009→}\n  1010→\n  1011→.section {\n  1012→  margin-bottom: 36px;\n  1013→  scroll-margin-top: calc(var(--header-height) + 20px);\n  1014→  animation: fadeInUp 0.4s ease-out;\n  1015→}\n  1016→\n  1017→.section-header {\n  1018→  font-family: \"Noto Serif SC\", serif;\n  1019→  font-size: 18px; font-weight: 700;\n  1020→  color: var(--text-header);\n  1021→  margin-bottom: 16px;\n  1022→  padding-bottom: 10px;\n  1023→  border-bottom: 2px solid var(--accent-gold);\n  1024→  display: flex; align-items: center; gap: 10px;\n  1025→}\n  1026→\n  1027→.section-header::before {\n  1028→  content: '';\n  1029→  width: 4px; height: 20px;\n  1030→  background: var(--accent-gold);\n  1031→  border-radius: 2px;\n  1032→}\n  1033→\n  1034→.sheet-title {\n  1035→  font-size: 13px; font-weight: 600;\n  1036→  color: var(--accent-cyan);\n  1037→  margin: 16px 0 8px;\n  1038→  padding-left: 12px;\n  1039→  border-left: 2px solid var(--accent-cyan);\n  1040→}\n  1041→\n  1042→/* Overview Cards */\n  1043→.overview-grid {\n  1044→  display: grid;\n  1045→  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n  1046→  gap: 14px; margin-bottom: 20px;\n  1047→}\n  1048→\n  1049→.stat-card {\n  1050→  background: var(--bg-card);\n  1051→  border: 1px solid var(--border);\n  1052→  border-radius: 10px;\n  1053→  padding: 16px 18px;\n  1054→  transition: transform 0.2s ease, box-shadow 0.2s ease;\n  1055→}\n  1056→\n  1057→.stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }\n  1058→\n  1059→.stat-card.stat-primary {\n  1060→  border-color: var(--accent-gold);\n  1061→  background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), var(--bg-card));\n  1062→}\n  1063→.stat-card.stat-alert {\n  1064→  border-color: var(--negative);\n  1065→  background: linear-gradient(135deg, var(--negative-bg), var(--bg-card));\n  1066→}\n  1067→.stat-card.stat-ok {\n  1068→  border-color: var(--positive);\n  1069→  background: linear-gradient(135deg, var(--positive-bg), var(--bg-card));\n  1070→}\n  1071→\n  1072→.stat-label {\n  1073→  font-size: 11px; color: var(--text-muted);\n  1074→  text-transform: uppercase;\n  1075→  letter-spacing: 0.5px; margin-bottom: 6px;\n  1076→}\n  1077→\n  1078→.stat-value {\n  1079→  font-size: 22px; font-weight: 700;\n  1080→  color: var(--text-header);\n  1081→  font-variant-numeric: tabular-nums;\n  1082→}\n  1083→\n  1084→.stat-sub { margin-top: 8px; display: flex; gap: 14px; font-size: 11px; }\n  1085→.stat-positive { color: var(--positive); }\n  1086→.stat-negative { color: var(--negative); }\n  1087→\n  1088→.text-card {\n  1089→  background: var(--bg-card);\n  1090→  border: 1px solid var(--border);\n  1091→  border-radius: 10px;\n  1092→  padding: 14px 18px;\n  1093→}\n  1094→\n  1095→.text-card-label {\n  1096→  font-size: 11px; font-weight: 600;\n  1097→  color: var(--accent-cyan);\n  1098→  text-transform: uppercase;\n  1099→  letter-spacing: 0.5px; margin-bottom: 8px;\n  1100→}\n  1101→\n  1102→.text-card-content {\n  1103→  font-size: 12.5px; line-height: 1.7;\n  1104→  color: var(--text-secondary);\n  1105→}\n  1106→\n  1107→/* Bar Chart */\n  1108→.bar-chart { display: flex; flex-direction: column; gap: 4px; }\n  1109→.bar-row { display: flex; align-items: center; gap: 8px; height: 18px; }\n  1110→.bar-label {\n  1111→  width: 80px; font-size: 10.5px;\n  1112→  color: var(--text-secondary);\n  1113→  text-align: right; flex-shrink: 0;\n  1114→  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\n  1115→}\n  1116→.bar-track {\n  1117→  flex: 1; height: 10px;\n  1118→  background: var(--bg-secondary);\n  1119→  border-radius: 3px; overflow: hidden;\n  1120→}\n  1121→.bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; min-width: 2px; }\n  1122→.bar-value {\n  1123→  width: 45px; font-size: 10.5px;\n  1124→  color: var(--text-muted);\n  1125→  text-align: right; font-variant-numeric: tabular-nums;\n  1126→}\n  1127→\n  1128→.text-cards-inline {\n  1129→  display: flex; flex-direction: column; gap: 8px;\n  1130→  max-height: 320px; overflow-y: auto;\n  1131→}\n  1132→.text-cards-inline .text-card { padding: 10px 14px; border-radius: 6px; }\n  1133→\n  1134→/* Tables */\n  1135→.table-wrapper {\n  1136→  overflow-x: auto;\n  1137→  margin: 8px 0 20px;\n  1138→  border-radius: 8px;\n  1139→  border: 1px solid var(--border);\n  1140→  background: var(--bg-card);\n  1141→}\n  1142→\n  1143→.table-wrapper::-webkit-scrollbar { height: 6px; }\n  1144→.table-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }\n  1145→\n  1146→table {\n  1147→  width: 100%; border-collapse: collapse;\n  1148→  font-size: 12px; font-variant-numeric: tabular-nums;\n  1149→  white-space: nowrap;\n  1150→}\n  1151→\n  1152→th, td {\n  1153→  padding: 7px 10px;\n  1154→  border-bottom: 1px solid var(--border-light);\n  1155→  text-align: left;\n  1156→  max-width: 280px;\n  1157→  overflow: hidden; text-overflow: ellipsis;\n  1158→}\n  1159→\n  1160→th {\n  1161→  background: var(--bg-table-header);\n  1162→  color: var(--text-secondary);\n  1163→  font-weight: 600; font-size: 11px;\n  1164→  letter-spacing: 0.3px;\n  1165→  position: sticky; top: 0; z-index: 2;\n  1166→}\n  1167→\n  1168→tr:nth-child(even) td { background: var(--bg-table-row-alt); }\n  1169→tr:hover td { background: var(--bg-card-hover) !important; }\n  1170→\n  1171→.num-cell {\n  1172→  text-align: right;\n  1173→  font-family: \"SF Mono\", \"Cascadia Code\", \"JetBrains Mono\", monospace;\n  1174→  font-size: 11.5px;\n  1175→}\n  1176→\n  1177→.val-positive { color: var(--positive); }\n  1178→.val-negative { color: var(--negative); }\n  1179→\n  1180→.total-row td {\n  1181→  font-weight: 700;\n  1182→  background: rgba(245, 158, 11, 0.06) !important;\n  1183→  border-top: 2px solid var(--accent-gold);\n  1184→}\n  1185→\n  1186→.subtotal-row td {\n  1187→  font-weight: 600;\n  1188→  background: rgba(6, 182, 212, 0.04) !important;\n  1189→  border-top: 1px solid var(--accent-cyan);\n  1190→  color: var(--accent-cyan);\n  1191→}\n  1192→\n  1193→td[rowspan] {\n  1194→  background: var(--bg-table-header) !important;\n  1195→  font-weight: 600;\n  1196→  color: var(--accent-cyan);\n  1197→  border-right: 2px solid var(--accent-cyan);\n  1198→  vertical-align: middle;\n  1199→}\n  1200→\n  1201→th[colspan] {\n  1202→  text-align: center;\n  1203→  background: linear-gradient(180deg, var(--bg-table-header), rgba(15, 27, 51, 0.9));\n  1204→}\n  1205→\n  1206→/* Heatmap */\n  1207→.heat-pos-1 { background: var(--heat-pos-1) !important; }\n  1208→.heat-pos-2 { background: var(--heat-pos-2) !important; }\n  1209→.heat-pos-3 { background: var(--heat-pos-3) !important; }\n  1210→.heat-pos-4 { background: var(--heat-pos-4) !important; }\n  1211→.heat-pos-5 { background: var(--heat-pos-5) !important; }\n  1212→.heat-neg-1 { background: var(--heat-neg-1) !important; }\n  1213→.heat-neg-2 { background: var(--heat-neg-2) !important; }\n  1214→.heat-neg-3 { background: var(--heat-neg-3) !important; }\n  1215→.heat-neg-4 { background: var(--heat-neg-4) !important; }\n  1216→.heat-neg-5 { background: var(--heat-neg-5) !important; }\n  1217→\n  1218→/* Tabs */\n  1219→.tabs-container { margin: 8px 0 20px; }\n  1220→\n  1221→.tab-buttons {\n  1222→  display: flex; gap: 0;\n  1223→  margin-bottom: -1px;\n  1224→  position: relative; z-index: 3;\n  1225→}\n  1226→\n  1227→.tab-btn {\n  1228→  padding: 8px 16px;\n  1229→  background: var(--bg-secondary);\n  1230→  border: 1px solid var(--border);\n  1231→  border-bottom: none;\n  1232→  color: var(--text-secondary);\n  1233→  font-size: 12px; cursor: pointer;\n  1234→  border-radius: 6px 6px 0 0;\n  1235→  transition: all 0.15s ease;\n  1236→}\n  1237→\n  1238→.tab-btn:hover { color: var(--text-primary); background: var(--bg-card); }\n  1239→.tab-btn.active {\n  1240→  color: var(--accent-gold);\n  1241→  background: var(--bg-card);\n  1242→  border-color: var(--accent-gold);\n  1243→  border-bottom: 1px solid var(--bg-card);\n  1244→}\n  1245→\n  1246→.tab-content { display: none; }\n  1247→.tab-content.active { display: block; }\n  1248→\n  1249→.empty-state {\n  1250→  padding: 32px; text-align: center;\n  1251→  color: var(--text-muted); font-size: 13px;\n  1252→  background: var(--bg-card);\n  1253→  border-radius: 8px;\n  1254→  border: 1px dashed var(--border);\n  1255→}\n  1256→\n  1257→/* Search */\n  1258→.search-bar { display: flex; align-items: center; margin-left: 24px; }\n  1259→\n  1260→.search-input {\n  1261→  background: var(--bg-card);\n  1262→  border: 1px solid var(--border);\n  1263→  color: var(--text-primary);\n  1264→  padding: 6px 12px; font-size: 12px;\n  1265→  border-radius: 6px; width: 200px;\n  1266→  outline: none; transition: border-color 0.2s;\n  1267→}\n  1268→\n  1269→.search-input:focus { border-color: var(--accent-blue); }\n  1270→.search-input::placeholder { color: var(--text-muted); }\n  1271→\n  1272→/* Print */\n  1273→@media print {\n  1274→  .sidebar, .top-header { display: none; }\n  1275→  .main-content { margin: 0; padding: 10px; }\n  1276→  table { font-size: 9px; }\n  1277→  th, td { padding: 3px 5px; }\n  1278→  .stat-card { break-inside: avoid; }\n  1279→}\n  1280→\n  1281→@keyframes fadeInUp {\n  1282→  from { opacity: 0; transform: translateY(12px); }\n  1283→  to { opacity: 1; transform: translateY(0); }\n  1284→}\n  1285→\n  1286→@media (max-width: 900px) {\n  1287→  .sidebar { display: none; }\n  1288→  .main-content { margin-left: 0; }\n  1289→}\n  1290→'''\n  1291→\n  1292→# ─── JavaScript ───\n  1293→JS = '''\n  1294→function switchTab(groupId, tabIdx) {\n  1295→  document.querySelectorAll(`[data-tabgroup=\"${groupId}\"]`).forEach(btn => btn.classList.remove('active'));\n  1296→  document.querySelectorAll(`[data-tab^=\"${groupId}-tab-\"]`).forEach(c => c.classList.remove('active'));\n  1297→  document.querySelector(`[data-tabgroup=\"${groupId}\"][data-tabidx=\"${tabIdx}\"]`).classList.add('active');\n  1298→  document.querySelector(`[data-tab=\"${groupId}-tab-${tabIdx}\"]`).classList.add('active');\n  1299→}\n  1300→\n  1301→function initNavHighlight() {\n  1302→  const sections = document.querySelectorAll('.section');\n  1303→  const navItems = document.querySelectorAll('.nav-item');\n  1304→  const observer = new IntersectionObserver((entries) => {\n  1305→    entries.forEach(entry => {\n  1306→      if (entry.isIntersecting) {\n  1307→        const id = entry.target.id;\n  1308→        navItems.forEach(item => {\n  1309→          item.classList.toggle('active', item.getAttribute('href') === '#' + id);\n  1310→        });\n  1311→      }\n  1312→    });\n  1313→  }, { threshold: 0.2, rootMargin: '-80px 0px -60% 0px' });\n  1314→  sections.forEach(s => observer.observe(s));\n  1315→}\n  1316→\n  1317→function initSearch() {\n  1318→  const input = document.getElementById('global-search');\n  1319→  if (!input) return;\n  1320→  input.addEventListener('input', (e) => {\n  1321→    const query = e.target.value.toLowerCase().trim();\n  1322→    document.querySelectorAll('table').forEach(table => {\n  1323→      table.querySelectorAll('tr:not(.header-row):not(.subheader-row)').forEach(row => {\n  1324→        if (!query) { row.style.display = ''; return; }\n  1325→        row.style.display = row.textContent.toLowerCase().includes(query) ? '' : 'none';\n  1326→      });\n  1327→    });\n  1328→  });\n  1329→}\n  1330→\n  1331→function initTableSort() {\n  1332→  document.querySelectorAll('th').forEach(th => {\n  1333→    th.style.cursor = 'pointer';\n  1334→    th.addEventListener('click', () => {\n  1335→      const table = th.closest('table');\n  1336→      const idx = Array.from(th.parentNode.children).indexOf(th);\n  1337→      const tbody = table.querySelector('tbody') || table;\n  1338→      const rows = Array.from(tbody.querySelectorAll('tr')).filter(r =>\n  1339→        !r.classList.contains('header-row') && !r.classList.contains('subheader-row') &&\n  1340→        !r.classList.contains('total-row') && !r.classList.contains('subtotal-row'));\n  1341→      const isAsc = th.getAttribute('data-sort') !== 'asc';\n  1342→      th.setAttribute('data-sort', isAsc ? 'asc' : 'desc');\n  1343→      rows.sort((a, b) => {\n  1344→        const aVal = a.children[idx]?.textContent?.trim()?.replace(/[()]/g, '') || '';\n  1345→        const bVal = b.children[idx]?.textContent?.trim()?.replace(/[()]/g, '') || '';\n  1346→        const aNum = parseFloat(aVal.replace(/[,%亿万只]/g, ''));\n  1347→        const bNum = parseFloat(bVal.replace(/[,%亿万只]/g, ''));\n  1348→        if (!isNaN(aNum) && !isNaN(bNum)) return isAsc ? aNum - bNum : bNum - aNum;\n  1349→        return isAsc ? aVal.localeCompare(bVal, 'zh') : bVal.localeCompare(aVal, 'zh');\n  1350→      });\n  1351→      rows.forEach(r => tbody.appendChild(r));\n  1352→    });\n  1353→  });\n  1354→}\n  1355→\n  1356→document.addEventListener('DOMContentLoaded', () => {\n  1357→  initNavHighlight();\n  1358→  initSearch();\n  1359→  initTableSort();\n  1360→});\n  1361→'''\n  1362→\n  1363→\n  1364→# ─── Assemble HTML ───\n  1365→def generate_html():\n  1366→    # Sidebar navigation - grouped to match PDF structure\n  1367→    groups = {\n  1368→        '一、规模及发行': ['overview', 'channel-aum', 'product-scale', 'scale-changes', 'pm-metrics', 'maturity'],\n  1369→        '二、产品业绩': ['break-even', 'market-index', 'series-perf', 'min-hold-perf', 'underperform', 'high-vol'],\n  1370→        '三、资产与持仓': ['asset-alloc', 'fee-income', 'public-strategy', 'xinghe', 'bond-holdings',\n  1371→                     'outsource', 'derivatives', 'gold-equity'],\n  1372→    }\n  1373→\n  1374→    section_map = {s['id']: s for s in SECTIONS}\n  1375→\n  1376→    nav_html = ''\n  1377→    for group_name, section_ids in groups.items():\n  1378→        nav_html += f'<div class=\"sidebar-section\"><div class=\"sidebar-group-label\">{group_name}</div>'\n  1379→        for sid in section_ids:\n  1380→            sec = section_map.get(sid)\n  1381→            if sec:\n  1382→                nav_html += (f'<a class=\"nav-item\" href=\"#{sid}\">'\n  1383→                             f'<span class=\"nav-icon\">{sec[\"icon\"]}</span>{sec[\"title\"]}</a>')\n  1384→        nav_html += '</div>'\n  1385→\n  1386→    # Main content sections\n  1387→    content_html = ''\n  1388→    for section in SECTIONS:\n  1389→        section_content = generate_section_html(section)\n  1390→        content_html += f'''<div class=\"section\" id=\"{section['id']}\">\n  1391→<h2 class=\"section-header\">{escape_html(section['title'])}</h2>\n  1392→{section_content}\n  1393→</div>'''\n  1394→\n  1395→    from datetime import datetime\n  1396→    now = datetime.now().strftime('%Y-%m-%d %H:%M')\n  1397→\n  1398→    html = f'''<!DOCTYPE html>\n  1399→<html lang=\"zh-CN\">\n  1400→<head>\n  1401→<meta charset=\"UTF-8\">\n  1402→<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  1403→<title>{REPORT_TITLE} - {REPORT_DATE}</title>\n  1404→<style>\n  1405→{CSS}\n  1406→</style>\n  1407→</head>\n  1408→<body>\n  1409→\n  1410→<header class=\"top-header\">\n  1411→  <div class=\"header-brand\">\n  1412→    <div class=\"header-logo\">XY</div>\n  1413→    <div class=\"header-title\">{REPORT_TITLE}</div>\n  1414→  </div>\n  1415→  <div class=\"search-bar\">\n  1416→    <input type=\"text\" id=\"global-search\" class=\"search-input\" placeholder=\"搜索产品/经理/代码...\">\n  1417→  </div>\n  1418→  <div class=\"header-date\">数据截止 {REPORT_DATE}</div>\n  1419→</header>\n  1420→\n  1421→<nav class=\"sidebar\">\n  1422→{nav_html}\n  1423→</nav>\n  1424→\n  1425→<main class=\"main-content\">\n  1426→{content_html}\n  1427→<footer style=\"text-align:center;padding:24px;color:var(--text-muted);font-size:11px;border-top:1px solid var(--border);margin-top:40px;\">\n  1428→  兴银理财多资产投资部 | 数据截止 {REPORT_DATE} | 仪表板生成于 {now}\n  1429→</footer>\n  1430→</main>\n  1431→\n  1432→<script>\n  1433→{JS}\n  1434→</script>\n  1435→</body>\n  1436→</html>'''\n  1437→\n  1438→    return html\n  1439→\n  1440→\n  1441→# ─── Main ───\n  1442→if __name__ == '__main__':\n  1443→    print('Generating dashboard HTML...')\n  1444→    html = generate_html()\n  1445→\n  1446→    with open(OUTPUT_HTML, 'w', encoding='utf-8') as f:\n  1447→        f.write(html)\n  1448→\n  1449→    file_size = os.path.getsize(OUTPUT_HTML)\n  1450→    print(f'Dashboard generated: {OUTPUT_HTML}')\n  1451→    print(f'File size: {file_size:,} bytes ({file_size/1024:.1f} KB)')\n  1452→    print(f'Sections: {len(SECTIONS)}')\n  1453→    print(f'Total sheets displayed: {sum(len(s[\"sheets\"]) for s in SECTIONS)}')\n  1454→"}]},"uuid":"fd980fa2-fac9-407a-9951-ad45413e80df","timestamp":"2026-02-09T05:35:26.771Z","toolUseResult":{"type":"update","filePath":"/tmp/generate_weekly_dashboard.py","content":"#!/usr/bin/env python3\n\"\"\"\nGenerate a comprehensive web dashboard for the weekly report.\nReads data from the extracted JSON and generates a self-contained HTML file.\nMatches the structure and formatting of the PDF weekly report.\n\"\"\"\nimport json\nimport os\nimport math\nimport re\n\n# ─── Configuration ───\nJSON_PATH = '/tmp/weekly_report_data.json'\nOUTPUT_HTML = '/Users/fanshengxia/Desktop/周报V2/输出结果/周报仪表板-20260205.html'\nREPORT_DATE = '2026-02-05'\nREPORT_TITLE = '多资产投资部理财产品运作周报'\n\n# ─── Load Data ───\nwith open(JSON_PATH, 'r', encoding='utf-8') as f:\n    raw_data = json.load(f)\n\noutput_sheets = raw_data['output_file']\nvba_sheets = raw_data['vba_workbook']\n\n# ─── Sheets that should use integer display with parentheses for negatives ───\nSCALE_INT_SHEETS = {\n    '2、产品规模',\n    '1、分渠道余额',\n    '投资经理维度产品规模和数量',\n    '不同形态产品规模和数量',\n    '13.不同周期产品规模',\n    '14.狭义客户周期和最短持有期的产品规模跟踪',\n    '10.未来全年产品到期情况',\n    '10.未来全年产品到期情况-定开',\n}\n\n# ─── Sheets with percentage values already in percentage form (e.g., 1.87 = 1.87%) ───\nPCT_RAW_SHEETS = {\n    '15.市场指数收益',\n}\n\n# ─── Sheets with percentage values in decimal form (e.g., 0.0187 = 1.87%) ───\nPCT_DECIMAL_SHEETS = {\n    '系列产品业绩-费后加权',\n    '系列产品业绩-费后平均',\n    '系列产品业绩-费前加权',\n    '系列产品业绩-费前平均',\n    '5.2 最短持有期产品业绩表现1',\n    '5.2 最短持有期产品业绩表现2',\n}\n\n\n# ─── Helper Functions ───\n\ndef is_numeric(val):\n    if val is None:\n        return False\n    if isinstance(val, (int, float)):\n        return not (isinstance(val, float) and (math.isnan(val) or math.isinf(val)))\n    if isinstance(val, str):\n        try:\n            float(val)\n            return True\n        except:\n            return False\n    return False\n\n\ndef to_float(val):\n    if val is None:\n        return None\n    if isinstance(val, (int, float)):\n        if isinstance(val, float) and (math.isnan(val) or math.isinf(val)):\n            return None\n        return float(val)\n    if isinstance(val, str):\n        if val in ('nan', 'inf', '-inf', ''):\n            return None\n        try:\n            return float(val)\n        except:\n            return None\n    return None\n\n\ndef escape_html(s):\n    if s is None:\n        return ''\n    s = str(s)\n    return s.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('\"', '&quot;')\n\n\ndef detect_column_types(sheet_data, sheet_name=''):\n    \"\"\"Detect which columns contain percentages, basis points, or regular numbers.\"\"\"\n    data = sheet_data['data']\n    headers = data[0] if data else []\n    col_types = {}\n\n    for ci in range(len(headers)):\n        h = str(headers[ci] or '')\n        h_lower = h.lower()\n\n        # Force override for known sheet types\n        if sheet_name in PCT_RAW_SHEETS:\n            is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h\n            if is_pct_header:\n                col_types[ci] = 'percent_raw'\n                continue\n\n        if sheet_name in PCT_DECIMAL_SHEETS:\n            is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h\n            if is_pct_header:\n                col_types[ci] = 'percent'\n                continue\n\n        if 'bp' in h_lower or '净值变化bp' in h:\n            col_types[ci] = 'bps'\n            continue\n\n        is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h or '比例' in h\n\n        if is_pct_header:\n            numeric_vals = []\n            for ri in range(1, min(len(data), 20)):\n                if ci < len(data[ri]):\n                    v = to_float(data[ri][ci])\n                    if v is not None and v != 0:\n                        numeric_vals.append(abs(v))\n            if numeric_vals:\n                avg = sum(numeric_vals) / len(numeric_vals)\n                if avg > 0.5:\n                    col_types[ci] = 'percent_raw'\n                else:\n                    col_types[ci] = 'percent'\n            else:\n                col_types[ci] = 'percent'\n        else:\n            # Auto-detect percentage columns by value range\n            numeric_vals = []\n            for ri in range(1, min(len(data), 20)):\n                if ci < len(data[ri]):\n                    v = to_float(data[ri][ci])\n                    if v is not None and v != 0:\n                        numeric_vals.append(abs(v))\n            if len(numeric_vals) >= 2:\n                avg = sum(numeric_vals) / len(numeric_vals)\n                max_v = max(numeric_vals)\n                if 0 < avg < 0.5 and max_v < 1.5:\n                    col_types[ci] = 'percent'\n\n    return col_types\n\n\ndef format_cell_value(val, col_type=None, use_parens=False):\n    \"\"\"Format a cell value based on its type.\n    use_parens: if True, show negatives as (N) instead of -N, and use integer display for scale values.\n    \"\"\"\n    if val is None:\n        return ''\n    if isinstance(val, str):\n        if val in ('nan', 'inf', '-inf'):\n            return ''\n        try:\n            fval = float(val)\n            val = fval\n        except:\n            return escape_html(val)\n\n    if isinstance(val, bool):\n        return str(val)\n    if not isinstance(val, (int, float)):\n        return escape_html(str(val))\n    if math.isnan(val) or math.isinf(val):\n        return ''\n\n    if col_type == 'percent':\n        pct = val * 100\n        return f'{pct:.2f}%'\n    elif col_type == 'percent_raw':\n        return f'{val:.2f}%'\n    elif col_type == 'bps':\n        return f'{val:.2f}'\n\n    # Scale integer mode: show rounded integers with parentheses for negatives\n    if use_parens:\n        # For very small values close to 0\n        if abs(val) < 0.005:\n            return '-'\n        # Round to reasonable precision\n        rounded = round(val)\n        if abs(val) < 1 and val != 0:\n            # Show one decimal for small values\n            if val < 0:\n                return f'({abs(val):.1f})'\n            return f'{val:.1f}'\n        if rounded == 0 and val != 0:\n            if val < 0:\n                return '(0)'\n            return '0'\n        if rounded < 0:\n            return f'({abs(rounded):,})'\n        return f'{rounded:,}'\n\n    # Default formatting\n    if isinstance(val, int) or (isinstance(val, float) and val == int(val) and abs(val) < 10000):\n        return str(int(val))\n    elif abs(val) < 0.0001 and val != 0:\n        return f'{val:.6f}'\n    elif abs(val) < 0.01 and val != 0:\n        return f'{val:.4f}'\n    elif abs(val) < 100:\n        return f'{val:.2f}'\n    elif abs(val) < 100000:\n        return f'{val:,.2f}'\n    else:\n        return f'{val:,.0f}'\n\n\ndef get_cell_class(val, col_type=None, header=''):\n    \"\"\"Get CSS class for conditional formatting.\"\"\"\n    classes = []\n    if val is None:\n        return ''\n\n    fval = to_float(val)\n    if fval is None:\n        return ''\n\n    h = str(header).lower()\n\n    is_change = any(kw in h for kw in ['变化', '较上周', '较上月', '较上年', 'bp'])\n    is_return = any(kw in h for kw in ['年化', '收益率'])\n\n    if is_change:\n        if fval > 0:\n            classes.append('val-positive')\n        elif fval < 0:\n            classes.append('val-negative')\n\n    if is_return and col_type == 'percent':\n        if fval < 0:\n            classes.append('val-negative')\n\n    # Heatmap intensity for change columns\n    if is_change and fval != 0:\n        if col_type == 'percent':\n            intensity = min(abs(fval) * 20, 1)\n        elif col_type == 'percent_raw':\n            intensity = min(abs(fval) / 5, 1)\n        elif 'bp' in h:\n            intensity = min(abs(fval) / 50, 1)\n        else:\n            intensity = min(abs(fval) / 20, 1)\n        level = min(int(intensity * 5) + 1, 5)\n        if fval > 0:\n            classes.append(f'heat-pos-{level}')\n        else:\n            classes.append(f'heat-neg-{level}')\n\n    return ' '.join(classes)\n\n\ndef parse_merged_cells(merged_list):\n    \"\"\"Parse merged cell ranges into a dict of (row,col) -> (rowspan, colspan).\"\"\"\n    merges = {}\n    skip = set()\n    for m in merged_list:\n        match = re.match(r'([A-Z]+)(\\d+):([A-Z]+)(\\d+)', m)\n        if not match:\n            continue\n        c1 = col_letter_to_num(match.group(1))\n        r1 = int(match.group(2))\n        c2 = col_letter_to_num(match.group(3))\n        r2 = int(match.group(4))\n        rowspan = r2 - r1 + 1\n        colspan = c2 - c1 + 1\n        merges[(r1, c1)] = (rowspan, colspan)\n        for r in range(r1, r2 + 1):\n            for c in range(c1, c2 + 1):\n                if (r, c) != (r1, c1):\n                    skip.add((r, c))\n    return merges, skip\n\n\ndef col_letter_to_num(letters):\n    num = 0\n    for ch in letters:\n        num = num * 26 + (ord(ch) - ord('A') + 1)\n    return num\n\n\n# ─── Data Preprocessing ───\ndef preprocess_sheets():\n    \"\"\"Add computed subtotal rows and fix data where needed.\"\"\"\n\n    # 1. Add subtotal rows to 分渠道余额\n    sheet = output_sheets.get('1、分渠道余额')\n    if sheet and sheet.get('data'):\n        data = sheet['data']\n        new_data = list(data[:3])  # Keep headers (rows 0-2)\n\n        # Group rows by 总分类\n        groups = {}\n        current_group = None\n        for ri in range(3, len(data)):\n            row = data[ri]\n            if row[0] is not None:\n                current_group = str(row[0])\n            if current_group:\n                if current_group not in groups:\n                    groups[current_group] = []\n                groups[current_group].append(row)\n\n        grand_total = [0, 0, 0]\n\n        for group_name in ['中低波稳健产品', '中高波市值产品', '外币产品']:\n            rows = groups.get(group_name, [])\n            subtotal = [0, 0]  # 行内, 行外\n            for row in rows:\n                v_inner = to_float(row[2])\n                v_outer = to_float(row[3])\n                if v_inner:\n                    subtotal[0] += v_inner\n                if v_outer:\n                    subtotal[1] += v_outer\n                new_data.append(row)\n\n            total_val = subtotal[0] + subtotal[1]\n            # Add subtotal row\n            label = f'{group_name}合计'\n            new_data.append([None, label, round(subtotal[0]), round(subtotal[1])])\n            grand_total[0] += subtotal[0]\n            grand_total[1] += subtotal[1]\n\n        # Add 合计 column header\n        if len(new_data[0]) == 4:\n            new_data[0] = [None, None, '保有规模', None, None]\n            new_data[1] = [None, '渠道-行内外', '行内', '行外', '合计']\n            new_data[2] = ['总分类', '母分类', None, None, None]\n\n        # Add 合计 column to each data row\n        for ri in range(3, len(new_data)):\n            row = new_data[ri]\n            if len(row) == 4:\n                v1 = to_float(row[2]) or 0\n                v2 = to_float(row[3]) or 0\n                row.append(round(v1 + v2))\n            elif len(row) == 5:\n                pass  # already has 合计\n\n        # Add 总计 row\n        new_data.append([None, '总计', round(grand_total[0]), round(grand_total[1]),\n                         round(grand_total[0] + grand_total[1])])\n\n        sheet['data'] = new_data\n        sheet['col_count'] = 5\n\n    # 2. Add 合计 row to 产品规模\n    sheet = output_sheets.get('2、产品规模')\n    if sheet and sheet.get('data'):\n        data = sheet['data']\n        # Check if 合计 row already exists\n        has_total = any(str(row[0] or '').strip() in ('合计', '总计') for row in data[1:])\n        if not has_total:\n            totals = [0] * len(data[0])\n            for row in data[1:]:\n                for ci in range(2, len(row)):\n                    v = to_float(row[ci])\n                    if v is not None:\n                        totals[ci] += v\n            total_row = ['', '合计']\n            for ci in range(2, len(data[0])):\n                total_row.append(round(totals[ci]))\n            while len(total_row) < len(data[0]):\n                total_row.append(None)\n            data.append(total_row)\n\n    # 3. Add 合计 row to 投资经理维度\n    sheet = output_sheets.get('投资经理维度产品规模和数量')\n    if sheet and sheet.get('data'):\n        data = sheet['data']\n        has_total = any(str(row[0] or '').strip() in ('合计', '总计') for row in data[1:])\n        if not has_total:\n            totals = [0] * len(data[0])\n            for row in data[1:]:\n                for ci in range(1, len(row)):\n                    v = to_float(row[ci])\n                    if v is not None:\n                        totals[ci] += v\n            total_row = ['合计']\n            for ci in range(1, len(data[0])):\n                total_row.append(round(totals[ci], 1))\n            while len(total_row) < len(data[0]):\n                total_row.append(None)\n            data.append(total_row)\n\n\npreprocess_sheets()\n\n\n# ─── Section Definitions (matching PDF TOC order) ───\nSECTIONS = [\n    {\n        'id': 'overview',\n        'title': '报告概览',\n        'icon': '&#9670;',\n        'sheets': ['总结文字'],\n        'type': 'overview'\n    },\n    # ─── 一、规模及发行情况 ───\n    {\n        'id': 'channel-aum',\n        'title': '1. 渠道代销规模',\n        'icon': '&#9632;',\n        'sheets': ['1、分渠道余额', '渠道明细'],\n        'type': 'tables'\n    },\n    {\n        'id': 'product-scale',\n        'title': '2. 产品规模',\n        'icon': '&#9632;',\n        'sheets': ['2、产品规模', '不同形态产品规模和数量', '13.不同周期产品规模',\n                   '14.狭义客户周期和最短持有期的产品规模跟踪'],\n        'type': 'tables'\n    },\n    {\n        'id': 'scale-changes',\n        'title': '3. 在售产品销售情况',\n        'icon': '&#9632;',\n        'sheets': ['3、本月定开或客户周期产品规模变化', '本周新发产品', '待售产品'],\n        'type': 'tables'\n    },\n    {\n        'id': 'pm-metrics',\n        'title': '4. 投资经理维度',\n        'icon': '&#9632;',\n        'sheets': ['投资经理维度产品规模和数量'],\n        'type': 'tables'\n    },\n    {\n        'id': 'maturity',\n        'title': '5. 产品到期情况',\n        'icon': '&#9670;',\n        'sheets': ['10.未来全年产品到期情况', '10.未来全年产品到期情况-定开', '10.下周到期产品清单'],\n        'type': 'tables'\n    },\n    # ─── 二、产品业绩 ───\n    {\n        'id': 'break-even',\n        'title': '6. 破净情况',\n        'icon': '&#9670;',\n        'sheets': ['破净结果'],\n        'type': 'tables'\n    },\n    {\n        'id': 'market-index',\n        'title': '7. 市场指数收益',\n        'icon': '&#9670;',\n        'sheets': ['15.市场指数收益'],\n        'type': 'tables'\n    },\n    {\n        'id': 'series-perf',\n        'title': '8. 系列产品业绩',\n        'icon': '&#9670;',\n        'sheets': ['系列产品业绩-费前加权', '系列产品业绩-费后加权', '系列产品业绩-费前平均', '系列产品业绩-费后平均'],\n        'type': 'tabs'\n    },\n    {\n        'id': 'min-hold-perf',\n        'title': '9. 最短持有期业绩',\n        'icon': '&#9670;',\n        'sheets': ['5.2 最短持有期产品业绩表现1', '5.2 最短持有期产品业绩表现2'],\n        'type': 'tables'\n    },\n    {\n        'id': 'underperform',\n        'title': '10. 不达基准清单',\n        'icon': '&#9888;',\n        'sheets': ['招商在售产品不达基准', '封闭及定开产品100日内不大业绩产品清单',\n                   '合享及悦动稳享临近到期预测不达标产品清单'],\n        'type': 'tables'\n    },\n    {\n        'id': 'high-vol',\n        'title': '11. 高波动产品',\n        'icon': '&#9888;',\n        'sheets': ['12.周净值高波动产品清单'],\n        'type': 'tables'\n    },\n    # ─── 资产与持仓 ───\n    {\n        'id': 'asset-alloc',\n        'title': '12. 资产维度数据统计',\n        'icon': '&#9679;',\n        'sheets': ['8.资产大表'],\n        'type': 'tables'\n    },\n    {\n        'id': 'fee-income',\n        'title': '13. 中收监控',\n        'icon': '&#9679;',\n        'sheets': ['9.中收监控'],\n        'type': 'tables'\n    },\n    {\n        'id': 'public-strategy',\n        'title': '14. 公共策略专户',\n        'icon': '&#9679;',\n        'sheets': ['公共策略持仓概况'],\n        'type': 'tables'\n    },\n    {\n        'id': 'xinghe',\n        'title': '15. 兴合产品持仓',\n        'icon': '&#9679;',\n        'sheets': ['11.兴合产品持仓明细'],\n        'type': 'tables'\n    },\n    {\n        'id': 'bond-holdings',\n        'title': '16. 可转债/量化持仓',\n        'icon': '&#9679;',\n        'sheets': ['11.1 可转债专户持仓明细', '11.2量化和可转债持仓明细'],\n        'type': 'tables'\n    },\n    {\n        'id': 'outsource',\n        'title': '17. 委外专户配置',\n        'icon': '&#9679;',\n        'sheets': ['11.2.1其他委外专户金额配置情况', '11.2.2其他委外专户配置占比情况',\n                   '11.2.3其他委外专户配置占比情况-除以系列规模'],\n        'type': 'tables'\n    },\n    {\n        'id': 'derivatives',\n        'title': '18. 衍生品/非标持仓',\n        'icon': '&#9679;',\n        'sheets': ['11.4其他衍生品专户持仓明细', '11.5全部衍生品专户持仓占比', '11.6非标持仓占比'],\n        'type': 'tables'\n    },\n    {\n        'id': 'gold-equity',\n        'title': '19. 黄金/权益持仓',\n        'icon': '&#9679;',\n        'sheets': ['黄金持仓', '权益专户持仓'],\n        'type': 'tables'\n    },\n]\n\n\n# ─── Compute Overview Stats ───\ndef compute_overview_stats():\n    stats = {}\n\n    ps = output_sheets.get('2、产品规模', {})\n    if ps.get('data'):\n        total_aum = 0\n        total_count = 0\n        total_aum_m = 0\n        total_aum_y = 0\n        for row in ps['data'][1:]:\n            first = str(row[0] or '').strip() if row[0] else ''\n            second = str(row[1] or '').strip() if len(row) > 1 else ''\n            # Skip the 合计 row we added\n            if first in ('合计', '总计') or second in ('合计', '总计'):\n                continue\n            v = to_float(row[2]) if len(row) > 2 else None\n            if v is not None:\n                total_aum += v\n            v = to_float(row[5]) if len(row) > 5 else None\n            if v is not None:\n                total_count += v\n            v = to_float(row[3]) if len(row) > 3 else None\n            if v is not None:\n                total_aum_m += v\n            v = to_float(row[4]) if len(row) > 4 else None\n            if v is not None:\n                total_aum_y += v\n        stats['total_aum'] = total_aum\n        stats['total_count'] = total_count\n        stats['aum_vs_month'] = total_aum_m\n        stats['aum_vs_year'] = total_aum_y\n\n    text_sheet = output_sheets.get('总结文字', {})\n    if text_sheet.get('data'):\n        for row in text_sheet['data'][1:]:\n            if len(row) >= 2 and row[0] and row[1]:\n                key = str(row[0])\n                val = str(row[1])\n                if '规模' in key:\n                    stats['guimo_text'] = val\n                elif '中收' in key:\n                    stats['zhongshou_text'] = val\n                elif '到期' in key:\n                    stats['daoqi_text'] = val\n\n    bp_sheet = output_sheets.get('破净结果', {})\n    if bp_sheet.get('data'):\n        data_rows = [r for r in bp_sheet['data'][1:] if any(v is not None for v in r)]\n        stats['broken_count'] = len(data_rows)\n\n    up_sheet = output_sheets.get('招商在售产品不达基准', {})\n    if up_sheet.get('data'):\n        stats['underperform_count'] = len(up_sheet['data']) - 1\n\n    hv_sheet = output_sheets.get('12.周净值高波动产品清单', {})\n    if hv_sheet.get('data'):\n        stats['high_vol_count'] = len(hv_sheet['data']) - 1\n\n    return stats\n\n\n# ─── Generate HTML Table ───\ndef generate_table_html(sheet_name, sheet_data, table_id=''):\n    \"\"\"Generate an HTML table from sheet data with formatting.\"\"\"\n    if not sheet_data or not sheet_data.get('data'):\n        return f'<div class=\"empty-state\">暂无数据</div>'\n\n    data = sheet_data['data']\n    merged_cells = sheet_data.get('merged_cells', [])\n    merges, skip_cells = parse_merged_cells(merged_cells)\n    col_types = detect_column_types(sheet_data, sheet_name)\n    use_parens = sheet_name in SCALE_INT_SHEETS\n\n    rows_html = []\n    num_cols = sheet_data.get('col_count', 0)\n\n    for ri, row in enumerate(data):\n        is_header = ri == 0\n        # Check if this is a sub-header row (mostly text, not data)\n        is_subheader = False\n        if ri in (1, 2) and ri < len(data):\n            row_vals = [v for v in row if v is not None]\n            numeric_count = sum(1 for v in row_vals if is_numeric(v))\n            text_count = len(row_vals) - numeric_count\n            if row_vals and text_count > numeric_count and text_count >= 2:\n                is_subheader = True\n\n        cells_html = []\n        for ci in range(min(len(row), num_cols)):\n            if (ri + 1, ci + 1) in skip_cells:\n                continue\n\n            val = row[ci]\n            merge_info = merges.get((ri + 1, ci + 1))\n\n            tag = 'th' if is_header or (is_subheader and ri < 3) else 'td'\n\n            col_header = str(data[0][ci] or '') if ci < len(data[0]) else ''\n            col_type = col_types.get(ci)\n\n            # Format value\n            if is_header or (is_subheader and ri < 3):\n                display = escape_html(str(val)) if val is not None else ''\n            else:\n                display = format_cell_value(val, col_type, use_parens=use_parens)\n\n            # Build attributes\n            attrs = []\n            css_classes = []\n\n            if merge_info:\n                rs, cs = merge_info\n                if rs > 1:\n                    attrs.append(f'rowspan=\"{rs}\"')\n                if cs > 1:\n                    attrs.append(f'colspan=\"{cs}\"')\n\n            if not is_header and not is_subheader:\n                cell_class = get_cell_class(val, col_type, col_header)\n                if cell_class:\n                    css_classes.append(cell_class)\n                fval = to_float(val)\n                if fval is not None:\n                    css_classes.append('num-cell')\n\n            if css_classes:\n                attrs.append(f'class=\"{\" \".join(css_classes)}\"')\n\n            attrs_str = ' ' + ' '.join(attrs) if attrs else ''\n            cells_html.append(f'<{tag}{attrs_str}>{display}</{tag}>')\n\n        # Determine row class\n        row_class = 'header-row' if is_header else ('subheader-row' if is_subheader and ri < 3 else '')\n        if not is_header and row:\n            first_val = str(row[0] or '').strip()\n            second_val = str(row[1] or '').strip() if len(row) > 1 else ''\n            if first_val in ('合计', '总计', '总合计', '汇总', '总规模') or \\\n               second_val in ('合计', '总计', '汇总'):\n                row_class = 'total-row'\n            # Subtotal rows (e.g., \"中低波稳健产品合计\")\n            elif '合计' in second_val:\n                row_class = 'subtotal-row'\n            # Check any of first 3 cells for 合计\n            elif any('合计' in str(v or '') for v in row[:3]):\n                row_class = 'total-row'\n\n        row_class_attr = f' class=\"{row_class}\"' if row_class else ''\n        rows_html.append(f'<tr{row_class_attr}>{\"\".join(cells_html)}</tr>')\n\n    tid = f' id=\"{table_id}\"' if table_id else ''\n    return f'''<div class=\"table-wrapper\">\n<table{tid}>\n{\"\".join(rows_html)}\n</table>\n</div>'''\n\n\n# ─── Generate Section HTML ───\ndef generate_section_html(section):\n    parts = []\n\n    if section['type'] == 'overview':\n        stats = compute_overview_stats()\n        parts.append(generate_overview_html(stats))\n\n    elif section['type'] == 'tabs':\n        tab_names = []\n        tab_contents = []\n        for i, sn in enumerate(section['sheets']):\n            sd = output_sheets.get(sn)\n            if not sd:\n                continue\n            # Create display-friendly tab names\n            short = sn.replace('系列产品业绩-', '')\n            tab_names.append(short)\n            active = 'active' if i == 0 else ''\n            tab_contents.append(\n                f'<div class=\"tab-content {active}\" data-tab=\"{section[\"id\"]}-tab-{i}\">'\n                f'{generate_table_html(sn, sd)}</div>')\n\n        tabs_html = ''.join(\n            f'<button class=\"tab-btn {\"active\" if i == 0 else \"\"}\" '\n            f'onclick=\"switchTab(\\'{section[\"id\"]}\\', {i})\" '\n            f'data-tabgroup=\"{section[\"id\"]}\" data-tabidx=\"{i}\">{tn}</button>'\n            for i, tn in enumerate(tab_names)\n        )\n        parts.append(\n            f'<div class=\"tabs-container\"><div class=\"tab-buttons\">{tabs_html}</div>'\n            f'{\"\".join(tab_contents)}</div>')\n\n    elif section['type'] == 'tables':\n        for sn in section['sheets']:\n            sd = output_sheets.get(sn)\n            if not sd:\n                continue\n            # Display-friendly subtitle\n            subtitle = sn\n            parts.append(f'<h3 class=\"sheet-title\">{escape_html(subtitle)}</h3>')\n            parts.append(generate_table_html(sn, sd))\n\n    return '\\n'.join(parts)\n\n\ndef generate_overview_html(stats):\n    aum = stats.get('total_aum')\n    aum_str = f'{aum:,.0f}亿' if aum and aum > 100 else (f'{aum:,.2f}亿' if aum else 'N/A')\n    count = stats.get('total_count')\n    count_str = f'{int(count)}只' if count else 'N/A'\n    aum_m = stats.get('aum_vs_month')\n    aum_m_str = f'{aum_m:+.0f}亿' if aum_m is not None else 'N/A'\n    aum_m_class = 'stat-positive' if aum_m and aum_m > 0 else ('stat-negative' if aum_m and aum_m < 0 else '')\n    aum_y = stats.get('aum_vs_year')\n    aum_y_str = f'{aum_y:+.0f}亿' if aum_y is not None else 'N/A'\n    aum_y_class = 'stat-positive' if aum_y and aum_y > 0 else ('stat-negative' if aum_y and aum_y < 0 else '')\n\n    broken = stats.get('broken_count', 0)\n    broken_class = 'stat-alert' if broken > 0 else 'stat-ok'\n    broken_str = f'{broken}只' if broken > 0 else '无'\n\n    underperf = stats.get('underperform_count', 0)\n    high_vol = stats.get('high_vol_count', 0)\n\n    text_cards = ''\n    for key, label in [('guimo_text', '规模概况'), ('zhongshou_text', '中收概况'), ('daoqi_text', '到期概况')]:\n        text = stats.get(key, '')\n        if text:\n            text_display = escape_html(text).replace('\\n', '<br>')\n            text_cards += f'''<div class=\"text-card\">\n<div class=\"text-card-label\">{label}</div>\n<div class=\"text-card-content\">{text_display}</div>\n</div>'''\n\n    # Build bar chart from 产品规模 data\n    ps = output_sheets.get('2、产品规模', {})\n    bar_items = []\n    if ps.get('data'):\n        max_aum = 0\n        for row in ps['data'][1:]:\n            second = str(row[1] or '').strip() if len(row) > 1 else ''\n            if second in ('合计', '总计'):\n                continue\n            v = to_float(row[2]) if len(row) > 2 else None\n            if v and v > max_aum:\n                max_aum = v\n        for row in ps['data'][1:]:\n            name = str(row[1] or '')\n            if name in ('合计', '总计'):\n                continue\n            v = to_float(row[2]) if len(row) > 2 else 0\n            chg = to_float(row[3]) if len(row) > 3 else 0\n            if v and name:\n                pct = (v / max_aum * 100) if max_aum > 0 else 0\n                color = 'var(--positive)' if chg and chg > 0 else (\n                    'var(--negative)' if chg and chg < 0 else 'var(--accent-blue)')\n                bar_items.append(f'''<div class=\"bar-row\">\n  <div class=\"bar-label\" title=\"{escape_html(name)}\">{escape_html(name[:8])}</div>\n  <div class=\"bar-track\"><div class=\"bar-fill\" style=\"width:{pct:.1f}%;background:{color}\"></div></div>\n  <div class=\"bar-value\">{v:.0f}</div>\n</div>''')\n\n    bars_html = '\\n'.join(bar_items) if bar_items else ''\n\n    return f'''\n<div class=\"overview-grid\">\n  <div class=\"stat-card stat-primary\">\n    <div class=\"stat-label\">管理规模</div>\n    <div class=\"stat-value\">{aum_str}</div>\n    <div class=\"stat-sub\">\n      <span class=\"{aum_m_class}\">较上月 {aum_m_str}</span>\n      <span class=\"{aum_y_class}\">较年初 {aum_y_str}</span>\n    </div>\n  </div>\n  <div class=\"stat-card\">\n    <div class=\"stat-label\">产品数量</div>\n    <div class=\"stat-value\">{count_str}</div>\n  </div>\n  <div class=\"stat-card {broken_class}\">\n    <div class=\"stat-label\">破净产品</div>\n    <div class=\"stat-value\">{broken_str}</div>\n  </div>\n  <div class=\"stat-card {\"stat-alert\" if underperf > 3 else \"\"}\">\n    <div class=\"stat-label\">不达基准</div>\n    <div class=\"stat-value\">{underperf}只</div>\n  </div>\n  <div class=\"stat-card {\"stat-alert\" if high_vol > 20 else \"\"}\">\n    <div class=\"stat-label\">高波动产品</div>\n    <div class=\"stat-value\">{high_vol}只</div>\n  </div>\n</div>\n<div class=\"overview-grid\" style=\"grid-template-columns: 1fr 1fr;\">\n  <div class=\"stat-card\" style=\"padding:14px 18px;\">\n    <div class=\"stat-label\" style=\"margin-bottom:10px;\">各系列规模分布 (亿)</div>\n    <div class=\"bar-chart\">{bars_html}</div>\n  </div>\n  <div class=\"stat-card\" style=\"padding:14px 18px;\">\n    <div class=\"stat-label\" style=\"margin-bottom:6px;\">AI 摘要</div>\n    <div class=\"text-cards-inline\">\n{text_cards}\n    </div>\n  </div>\n</div>\n'''\n\n\n# ─── CSS Styles ───\nCSS = '''\n@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Source+Han+Sans+SC:wght@300;400;500;700&display=swap');\n\n:root {\n  --bg-primary: #050a18;\n  --bg-secondary: #0c1425;\n  --bg-card: #111c32;\n  --bg-card-hover: #162040;\n  --bg-table-header: #0f1b33;\n  --bg-table-row-alt: #0a1226;\n  --bg-sidebar: #080e1f;\n  --bg-sidebar-active: #1a2744;\n\n  --text-primary: #e2e8f0;\n  --text-secondary: #94a3b8;\n  --text-muted: #64748b;\n  --text-header: #f1f5f9;\n\n  --accent-gold: #f59e0b;\n  --accent-blue: #3b82f6;\n  --accent-cyan: #06b6d4;\n\n  --positive: #10b981;\n  --positive-bg: rgba(16, 185, 129, 0.08);\n  --negative: #ef4444;\n  --negative-bg: rgba(239, 68, 68, 0.08);\n  --alert: #f97316;\n  --alert-bg: rgba(249, 115, 22, 0.08);\n\n  --border: #1e293b;\n  --border-light: #1a2540;\n\n  --sidebar-width: 260px;\n  --header-height: 56px;\n\n  --heat-pos-1: rgba(16, 185, 129, 0.1);\n  --heat-pos-2: rgba(16, 185, 129, 0.2);\n  --heat-pos-3: rgba(16, 185, 129, 0.3);\n  --heat-pos-4: rgba(16, 185, 129, 0.45);\n  --heat-pos-5: rgba(16, 185, 129, 0.6);\n  --heat-neg-1: rgba(239, 68, 68, 0.1);\n  --heat-neg-2: rgba(239, 68, 68, 0.2);\n  --heat-neg-3: rgba(239, 68, 68, 0.3);\n  --heat-neg-4: rgba(239, 68, 68, 0.45);\n  --heat-neg-5: rgba(239, 68, 68, 0.6);\n}\n\n* { box-sizing: border-box; margin: 0; padding: 0; }\n\nhtml {\n  font-size: 13px;\n  scroll-behavior: smooth;\n}\n\nbody {\n  font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", \"Noto Sans SC\", sans-serif;\n  background: var(--bg-primary);\n  color: var(--text-primary);\n  line-height: 1.5;\n  overflow-x: hidden;\n}\n\n/* Header */\n.top-header {\n  position: fixed;\n  top: 0; left: 0; right: 0;\n  height: var(--header-height);\n  background: linear-gradient(135deg, #0a1628 0%, #0f1d35 100%);\n  border-bottom: 1px solid var(--border);\n  display: flex; align-items: center;\n  padding: 0 24px;\n  z-index: 100;\n  backdrop-filter: blur(12px);\n}\n\n.header-brand { display: flex; align-items: center; gap: 12px; }\n\n.header-logo {\n  width: 32px; height: 32px;\n  background: linear-gradient(135deg, var(--accent-gold), #d97706);\n  border-radius: 8px;\n  display: flex; align-items: center; justify-content: center;\n  font-weight: 700; font-size: 14px; color: #0a0f1c;\n}\n\n.header-title {\n  font-family: \"Noto Serif SC\", serif;\n  font-size: 16px; font-weight: 700;\n  color: var(--text-header);\n  letter-spacing: 1px;\n}\n\n.header-date {\n  margin-left: auto;\n  font-size: 12px; color: var(--text-secondary);\n  background: var(--bg-card);\n  padding: 4px 12px; border-radius: 4px;\n  border: 1px solid var(--border);\n  font-variant-numeric: tabular-nums;\n}\n\n/* Sidebar */\n.sidebar {\n  position: fixed;\n  top: var(--header-height); left: 0; bottom: 0;\n  width: var(--sidebar-width);\n  background: var(--bg-sidebar);\n  border-right: 1px solid var(--border);\n  overflow-y: auto;\n  padding: 12px 0; z-index: 90;\n}\n\n.sidebar::-webkit-scrollbar { width: 4px; }\n.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }\n\n.sidebar-section { padding: 4px 0; }\n\n.sidebar-group-label {\n  font-size: 10px; font-weight: 600;\n  color: var(--text-muted);\n  text-transform: uppercase;\n  letter-spacing: 1.5px;\n  padding: 12px 20px 4px;\n}\n\n.nav-item {\n  display: flex; align-items: center; gap: 10px;\n  padding: 8px 20px;\n  color: var(--text-secondary);\n  text-decoration: none; font-size: 12.5px;\n  cursor: pointer;\n  transition: all 0.15s ease;\n  border-left: 3px solid transparent;\n}\n\n.nav-item:hover { color: var(--text-primary); background: var(--bg-card); }\n\n.nav-item.active {\n  color: var(--accent-gold);\n  background: var(--bg-sidebar-active);\n  border-left-color: var(--accent-gold);\n}\n\n.nav-icon { font-size: 8px; opacity: 0.6; width: 14px; text-align: center; }\n\n/* Main Content */\n.main-content {\n  margin-left: var(--sidebar-width);\n  margin-top: var(--header-height);\n  padding: 24px 28px;\n  min-height: calc(100vh - var(--header-height));\n}\n\n.section {\n  margin-bottom: 36px;\n  scroll-margin-top: calc(var(--header-height) + 20px);\n  animation: fadeInUp 0.4s ease-out;\n}\n\n.section-header {\n  font-family: \"Noto Serif SC\", serif;\n  font-size: 18px; font-weight: 700;\n  color: var(--text-header);\n  margin-bottom: 16px;\n  padding-bottom: 10px;\n  border-bottom: 2px solid var(--accent-gold);\n  display: flex; align-items: center; gap: 10px;\n}\n\n.section-header::before {\n  content: '';\n  width: 4px; height: 20px;\n  background: var(--accent-gold);\n  border-radius: 2px;\n}\n\n.sheet-title {\n  font-size: 13px; font-weight: 600;\n  color: var(--accent-cyan);\n  margin: 16px 0 8px;\n  padding-left: 12px;\n  border-left: 2px solid var(--accent-cyan);\n}\n\n/* Overview Cards */\n.overview-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n  gap: 14px; margin-bottom: 20px;\n}\n\n.stat-card {\n  background: var(--bg-card);\n  border: 1px solid var(--border);\n  border-radius: 10px;\n  padding: 16px 18px;\n  transition: transform 0.2s ease, box-shadow 0.2s ease;\n}\n\n.stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }\n\n.stat-card.stat-primary {\n  border-color: var(--accent-gold);\n  background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), var(--bg-card));\n}\n.stat-card.stat-alert {\n  border-color: var(--negative);\n  background: linear-gradient(135deg, var(--negative-bg), var(--bg-card));\n}\n.stat-card.stat-ok {\n  border-color: var(--positive);\n  background: linear-gradient(135deg, var(--positive-bg), var(--bg-card));\n}\n\n.stat-label {\n  font-size: 11px; color: var(--text-muted);\n  text-transform: uppercase;\n  letter-spacing: 0.5px; margin-bottom: 6px;\n}\n\n.stat-value {\n  font-size: 22px; font-weight: 700;\n  color: var(--text-header);\n  font-variant-numeric: tabular-nums;\n}\n\n.stat-sub { margin-top: 8px; display: flex; gap: 14px; font-size: 11px; }\n.stat-positive { color: var(--positive); }\n.stat-negative { color: var(--negative); }\n\n.text-card {\n  background: var(--bg-card);\n  border: 1px solid var(--border);\n  border-radius: 10px;\n  padding: 14px 18px;\n}\n\n.text-card-label {\n  font-size: 11px; font-weight: 600;\n  color: var(--accent-cyan);\n  text-transform: uppercase;\n  letter-spacing: 0.5px; margin-bottom: 8px;\n}\n\n.text-card-content {\n  font-size: 12.5px; line-height: 1.7;\n  color: var(--text-secondary);\n}\n\n/* Bar Chart */\n.bar-chart { display: flex; flex-direction: column; gap: 4px; }\n.bar-row { display: flex; align-items: center; gap: 8px; height: 18px; }\n.bar-label {\n  width: 80px; font-size: 10.5px;\n  color: var(--text-secondary);\n  text-align: right; flex-shrink: 0;\n  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\n}\n.bar-track {\n  flex: 1; height: 10px;\n  background: var(--bg-secondary);\n  border-radius: 3px; overflow: hidden;\n}\n.bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; min-width: 2px; }\n.bar-value {\n  width: 45px; font-size: 10.5px;\n  color: var(--text-muted);\n  text-align: right; font-variant-numeric: tabular-nums;\n}\n\n.text-cards-inline {\n  display: flex; flex-direction: column; gap: 8px;\n  max-height: 320px; overflow-y: auto;\n}\n.text-cards-inline .text-card { padding: 10px 14px; border-radius: 6px; }\n\n/* Tables */\n.table-wrapper {\n  overflow-x: auto;\n  margin: 8px 0 20px;\n  border-radius: 8px;\n  border: 1px solid var(--border);\n  background: var(--bg-card);\n}\n\n.table-wrapper::-webkit-scrollbar { height: 6px; }\n.table-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }\n\ntable {\n  width: 100%; border-collapse: collapse;\n  font-size: 12px; font-variant-numeric: tabular-nums;\n  white-space: nowrap;\n}\n\nth, td {\n  padding: 7px 10px;\n  border-bottom: 1px solid var(--border-light);\n  text-align: left;\n  max-width: 280px;\n  overflow: hidden; text-overflow: ellipsis;\n}\n\nth {\n  background: var(--bg-table-header);\n  color: var(--text-secondary);\n  font-weight: 600; font-size: 11px;\n  letter-spacing: 0.3px;\n  position: sticky; top: 0; z-index: 2;\n}\n\ntr:nth-child(even) td { background: var(--bg-table-row-alt); }\ntr:hover td { background: var(--bg-card-hover) !important; }\n\n.num-cell {\n  text-align: right;\n  font-family: \"SF Mono\", \"Cascadia Code\", \"JetBrains Mono\", monospace;\n  font-size: 11.5px;\n}\n\n.val-positive { color: var(--positive); }\n.val-negative { color: var(--negative); }\n\n.total-row td {\n  font-weight: 700;\n  background: rgba(245, 158, 11, 0.06) !important;\n  border-top: 2px solid var(--accent-gold);\n}\n\n.subtotal-row td {\n  font-weight: 600;\n  background: rgba(6, 182, 212, 0.04) !important;\n  border-top: 1px solid var(--accent-cyan);\n  color: var(--accent-cyan);\n}\n\ntd[rowspan] {\n  background: var(--bg-table-header) !important;\n  font-weight: 600;\n  color: var(--accent-cyan);\n  border-right: 2px solid var(--accent-cyan);\n  vertical-align: middle;\n}\n\nth[colspan] {\n  text-align: center;\n  background: linear-gradient(180deg, var(--bg-table-header), rgba(15, 27, 51, 0.9));\n}\n\n/* Heatmap */\n.heat-pos-1 { background: var(--heat-pos-1) !important; }\n.heat-pos-2 { background: var(--heat-pos-2) !important; }\n.heat-pos-3 { background: var(--heat-pos-3) !important; }\n.heat-pos-4 { background: var(--heat-pos-4) !important; }\n.heat-pos-5 { background: var(--heat-pos-5) !important; }\n.heat-neg-1 { background: var(--heat-neg-1) !important; }\n.heat-neg-2 { background: var(--heat-neg-2) !important; }\n.heat-neg-3 { background: var(--heat-neg-3) !important; }\n.heat-neg-4 { background: var(--heat-neg-4) !important; }\n.heat-neg-5 { background: var(--heat-neg-5) !important; }\n\n/* Tabs */\n.tabs-container { margin: 8px 0 20px; }\n\n.tab-buttons {\n  display: flex; gap: 0;\n  margin-bottom: -1px;\n  position: relative; z-index: 3;\n}\n\n.tab-btn {\n  padding: 8px 16px;\n  background: var(--bg-secondary);\n  border: 1px solid var(--border);\n  border-bottom: none;\n  color: var(--text-secondary);\n  font-size: 12px; cursor: pointer;\n  border-radius: 6px 6px 0 0;\n  transition: all 0.15s ease;\n}\n\n.tab-btn:hover { color: var(--text-primary); background: var(--bg-card); }\n.tab-btn.active {\n  color: var(--accent-gold);\n  background: var(--bg-card);\n  border-color: var(--accent-gold);\n  border-bottom: 1px solid var(--bg-card);\n}\n\n.tab-content { display: none; }\n.tab-content.active { display: block; }\n\n.empty-state {\n  padding: 32px; text-align: center;\n  color: var(--text-muted); font-size: 13px;\n  background: var(--bg-card);\n  border-radius: 8px;\n  border: 1px dashed var(--border);\n}\n\n/* Search */\n.search-bar { display: flex; align-items: center; margin-left: 24px; }\n\n.search-input {\n  background: var(--bg-card);\n  border: 1px solid var(--border);\n  color: var(--text-primary);\n  padding: 6px 12px; font-size: 12px;\n  border-radius: 6px; width: 200px;\n  outline: none; transition: border-color 0.2s;\n}\n\n.search-input:focus { border-color: var(--accent-blue); }\n.search-input::placeholder { color: var(--text-muted); }\n\n/* Print */\n@media print {\n  .sidebar, .top-header { display: none; }\n  .main-content { margin: 0; padding: 10px; }\n  table { font-size: 9px; }\n  th, td { padding: 3px 5px; }\n  .stat-card { break-inside: avoid; }\n}\n\n@keyframes fadeInUp {\n  from { opacity: 0; transform: translateY(12px); }\n  to { opacity: 1; transform: translateY(0); }\n}\n\n@media (max-width: 900px) {\n  .sidebar { display: none; }\n  .main-content { margin-left: 0; }\n}\n'''\n\n# ─── JavaScript ───\nJS = '''\nfunction switchTab(groupId, tabIdx) {\n  document.querySelectorAll(`[data-tabgroup=\"${groupId}\"]`).forEach(btn => btn.classList.remove('active'));\n  document.querySelectorAll(`[data-tab^=\"${groupId}-tab-\"]`).forEach(c => c.classList.remove('active'));\n  document.querySelector(`[data-tabgroup=\"${groupId}\"][data-tabidx=\"${tabIdx}\"]`).classList.add('active');\n  document.querySelector(`[data-tab=\"${groupId}-tab-${tabIdx}\"]`).classList.add('active');\n}\n\nfunction initNavHighlight() {\n  const sections = document.querySelectorAll('.section');\n  const navItems = document.querySelectorAll('.nav-item');\n  const observer = new IntersectionObserver((entries) => {\n    entries.forEach(entry => {\n      if (entry.isIntersecting) {\n        const id = entry.target.id;\n        navItems.forEach(item => {\n          item.classList.toggle('active', item.getAttribute('href') === '#' + id);\n        });\n      }\n    });\n  }, { threshold: 0.2, rootMargin: '-80px 0px -60% 0px' });\n  sections.forEach(s => observer.observe(s));\n}\n\nfunction initSearch() {\n  const input = document.getElementById('global-search');\n  if (!input) return;\n  input.addEventListener('input', (e) => {\n    const query = e.target.value.toLowerCase().trim();\n    document.querySelectorAll('table').forEach(table => {\n      table.querySelectorAll('tr:not(.header-row):not(.subheader-row)').forEach(row => {\n        if (!query) { row.style.display = ''; return; }\n        row.style.display = row.textContent.toLowerCase().includes(query) ? '' : 'none';\n      });\n    });\n  });\n}\n\nfunction initTableSort() {\n  document.querySelectorAll('th').forEach(th => {\n    th.style.cursor = 'pointer';\n    th.addEventListener('click', () => {\n      const table = th.closest('table');\n      const idx = Array.from(th.parentNode.children).indexOf(th);\n      const tbody = table.querySelector('tbody') || table;\n      const rows = Array.from(tbody.querySelectorAll('tr')).filter(r =>\n        !r.classList.contains('header-row') && !r.classList.contains('subheader-row') &&\n        !r.classList.contains('total-row') && !r.classList.contains('subtotal-row'));\n      const isAsc = th.getAttribute('data-sort') !== 'asc';\n      th.setAttribute('data-sort', isAsc ? 'asc' : 'desc');\n      rows.sort((a, b) => {\n        const aVal = a.children[idx]?.textContent?.trim()?.replace(/[()]/g, '') || '';\n        const bVal = b.children[idx]?.textContent?.trim()?.replace(/[()]/g, '') || '';\n        const aNum = parseFloat(aVal.replace(/[,%亿万只]/g, ''));\n        const bNum = parseFloat(bVal.replace(/[,%亿万只]/g, ''));\n        if (!isNaN(aNum) && !isNaN(bNum)) return isAsc ? aNum - bNum : bNum - aNum;\n        return isAsc ? aVal.localeCompare(bVal, 'zh') : bVal.localeCompare(aVal, 'zh');\n      });\n      rows.forEach(r => tbody.appendChild(r));\n    });\n  });\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  initNavHighlight();\n  initSearch();\n  initTableSort();\n});\n'''\n\n\n# ─── Assemble HTML ───\ndef generate_html():\n    # Sidebar navigation - grouped to match PDF structure\n    groups = {\n        '一、规模及发行': ['overview', 'channel-aum', 'product-scale', 'scale-changes', 'pm-metrics', 'maturity'],\n        '二、产品业绩': ['break-even', 'market-index', 'series-perf', 'min-hold-perf', 'underperform', 'high-vol'],\n        '三、资产与持仓': ['asset-alloc', 'fee-income', 'public-strategy', 'xinghe', 'bond-holdings',\n                     'outsource', 'derivatives', 'gold-equity'],\n    }\n\n    section_map = {s['id']: s for s in SECTIONS}\n\n    nav_html = ''\n    for group_name, section_ids in groups.items():\n        nav_html += f'<div class=\"sidebar-section\"><div class=\"sidebar-group-label\">{group_name}</div>'\n        for sid in section_ids:\n            sec = section_map.get(sid)\n            if sec:\n                nav_html += (f'<a class=\"nav-item\" href=\"#{sid}\">'\n                             f'<span class=\"nav-icon\">{sec[\"icon\"]}</span>{sec[\"title\"]}</a>')\n        nav_html += '</div>'\n\n    # Main content sections\n    content_html = ''\n    for section in SECTIONS:\n        section_content = generate_section_html(section)\n        content_html += f'''<div class=\"section\" id=\"{section['id']}\">\n<h2 class=\"section-header\">{escape_html(section['title'])}</h2>\n{section_content}\n</div>'''\n\n    from datetime import datetime\n    now = datetime.now().strftime('%Y-%m-%d %H:%M')\n\n    html = f'''<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>{REPORT_TITLE} - {REPORT_DATE}</title>\n<style>\n{CSS}\n</style>\n</head>\n<body>\n\n<header class=\"top-header\">\n  <div class=\"header-brand\">\n    <div class=\"header-logo\">XY</div>\n    <div class=\"header-title\">{REPORT_TITLE}</div>\n  </div>\n  <div class=\"search-bar\">\n    <input type=\"text\" id=\"global-search\" class=\"search-input\" placeholder=\"搜索产品/经理/代码...\">\n  </div>\n  <div class=\"header-date\">数据截止 {REPORT_DATE}</div>\n</header>\n\n<nav class=\"sidebar\">\n{nav_html}\n</nav>\n\n<main class=\"main-content\">\n{content_html}\n<footer style=\"text-align:center;padding:24px;color:var(--text-muted);font-size:11px;border-top:1px solid var(--border);margin-top:40px;\">\n  兴银理财多资产投资部 | 数据截止 {REPORT_DATE} | 仪表板生成于 {now}\n</footer>\n</main>\n\n<script>\n{JS}\n</script>\n</body>\n</html>'''\n\n    return html\n\n\n# ─── Main ───\nif __name__ == '__main__':\n    print('Generating dashboard HTML...')\n    html = generate_html()\n\n    with open(OUTPUT_HTML, 'w', encoding='utf-8') as f:\n        f.write(html)\n\n    file_size = os.path.getsize(OUTPUT_HTML)\n    print(f'Dashboard generated: {OUTPUT_HTML}')\n    print(f'File size: {file_size:,} bytes ({file_size/1024:.1f} KB)')\n    print(f'Sections: {len(SECTIONS)}')\n    print(f'Total sheets displayed: {sum(len(s[\"sheets\"]) for s in SECTIONS)}')\n","structuredPatch":[{"oldStart":2,"oldLines":6,"newStart":2,"newLines":7,"lines":[" \"\"\""," Generate a comprehensive web dashboard for the weekly report."," Reads data from the extracted JSON and generates a self-contained HTML file.","+Matches the structure and formatting of the PDF weekly report."," \"\"\""," import json"," import os"]},{"oldStart":21,"oldLines":38,"newStart":22,"newLines":36,"lines":[" output_sheets = raw_data['output_file']"," vba_sheets = raw_data['vba_workbook']"," ","-# ─── Helper Functions ───","+# ─── Sheets that should use integer display with parentheses for negatives ───","+SCALE_INT_SHEETS = {","+    '2、产品规模',","+    '1、分渠道余额',","+    '投资经理维度产品规模和数量',","+    '不同形态产品规模和数量',","+    '13.不同周期产品规模',","+    '14.狭义客户周期和最短持有期的产品规模跟踪',","+    '10.未来全年产品到期情况',","+    '10.未来全年产品到期情况-定开',","+}"," ","-def fmt_num(val, decimals=2, is_percent=False, is_bps=False):","-    \"\"\"Format a number for display.\"\"\"","-    if val is None:","-        return ''","-    if isinstance(val, str):","-        if val == 'nan' or val == 'inf' or val == '-inf':","-            return ''","-        try:","-            val = float(val)","-        except:","-            return val","-    if isinstance(val, bool):","-        return str(val)","-    if not isinstance(val, (int, float)):","-        return str(val)","-    if math.isnan(val) or math.isinf(val):","-        return ''","-    if is_percent:","-        return f'{val * 100:.{decimals}f}%'","-    if is_bps:","-        return f'{val:.{decimals}f}'","-    if abs(val) >= 1e8:","-        return f'{val/1e8:.{decimals}f}亿'","-    if abs(val) >= 1e4:","-        return f'{val/1e4:.{decimals}f}万'","-    if isinstance(val, int) or (isinstance(val, float) and val == int(val) and abs(val) < 1000):","-        return str(int(val))","-    return f'{val:.{decimals}f}'","+# ─── Sheets with percentage values already in percentage form (e.g., 1.87 = 1.87%) ───","+PCT_RAW_SHEETS = {","+    '15.市场指数收益',","+}"," ","+# ─── Sheets with percentage values in decimal form (e.g., 0.0187 = 1.87%) ───","+PCT_DECIMAL_SHEETS = {","+    '系列产品业绩-费后加权',","+    '系列产品业绩-费后平均',","+    '系列产品业绩-费前加权',","+    '系列产品业绩-费前平均',","+    '5.2 最短持有期产品业绩表现1',","+    '5.2 最短持有期产品业绩表现2',","+}"," ","+","+# ─── Helper Functions ───","+"," def is_numeric(val):","     if val is None:","         return False"]},{"oldStart":91,"oldLines":7,"newStart":90,"newLines":7,"lines":["     return s.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('\"', '&quot;')"," "," ","-def detect_column_types(sheet_data):","+def detect_column_types(sheet_data, sheet_name=''):","     \"\"\"Detect which columns contain percentages, basis points, or regular numbers.\"\"\"","     data = sheet_data['data']","     headers = data[0] if data else []"]},{"oldStart":100,"oldLines":14,"newStart":99,"newLines":27,"lines":["     for ci in range(len(headers)):","         h = str(headers[ci] or '')","         h_lower = h.lower()","-        is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h or '比例' in h"," ","+        # Force override for known sheet types","+        if sheet_name in PCT_RAW_SHEETS:","+            is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h","+            if is_pct_header:","+                col_types[ci] = 'percent_raw'","+                continue","+","+        if sheet_name in PCT_DECIMAL_SHEETS:","+            is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h","+            if is_pct_header:","+                col_types[ci] = 'percent'","+                continue","+","         if 'bp' in h_lower or '净值变化bp' in h:","             col_types[ci] = 'bps'","             continue"," ","+        is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h or '比例' in h","+","         if is_pct_header:","-            # Check if values are already in percentage form (> 1) or decimal form (< 1)","             numeric_vals = []","             for ri in range(1, min(len(data), 20)):","                 if ci < len(data[ri]):"]},{"oldStart":117,"oldLines":15,"newStart":129,"newLines":13,"lines":["             if numeric_vals:","                 avg = sum(numeric_vals) / len(numeric_vals)","                 if avg > 0.5:","-                    # Already in percentage form (e.g., 1.87 = 1.87%)","                     col_types[ci] = 'percent_raw'","                 else:","-                    # Decimal form (e.g., 0.0187 = 1.87%)","                     col_types[ci] = 'percent'","             else:","                 col_types[ci] = 'percent'","         else:","-            # Check if values look like percentages (small decimals 0~0.5 range)","+            # Auto-detect percentage columns by value range","             numeric_vals = []","             for ri in range(1, min(len(data), 20)):","                 if ci < len(data[ri]):"]},{"oldStart":141,"oldLines":14,"newStart":151,"newLines":15,"lines":["     return col_types"," "," ","-def format_cell_value(val, col_type=None):","-    \"\"\"Format a cell value based on its type.\"\"\"","+def format_cell_value(val, col_type=None, use_parens=False):","+    \"\"\"Format a cell value based on its type.","+    use_parens: if True, show negatives as (N) instead of -N, and use integer display for scale values.","+    \"\"\"","     if val is None:","         return ''","     if isinstance(val, str):","         if val in ('nan', 'inf', '-inf'):","             return ''","-        # Check if it's a string that looks like a number","         try:","             fval = float(val)","             val = fval"]},{"oldStart":157,"oldLines":20,"newStart":168,"newLines":41,"lines":[" ","     if isinstance(val, bool):","         return str(val)","-","     if not isinstance(val, (int, float)):","         return escape_html(str(val))","-","     if math.isnan(val) or math.isinf(val):","         return ''"," ","     if col_type == 'percent':","-        return f'{val * 100:.2f}%'","+        pct = val * 100","+        return f'{pct:.2f}%'","     elif col_type == 'percent_raw':","         return f'{val:.2f}%'","     elif col_type == 'bps':","         return f'{val:.2f}'","-    elif isinstance(val, int) or (isinstance(val, float) and val == int(val) and abs(val) < 10000):","+","+    # Scale integer mode: show rounded integers with parentheses for negatives","+    if use_parens:","+        # For very small values close to 0","+        if abs(val) < 0.005:","+            return '-'","+        # Round to reasonable precision","+        rounded = round(val)","+        if abs(val) < 1 and val != 0:","+            # Show one decimal for small values","+            if val < 0:","+                return f'({abs(val):.1f})'","+            return f'{val:.1f}'","+        if rounded == 0 and val != 0:","+            if val < 0:","+                return '(0)'","+            return '0'","+        if rounded < 0:","+            return f'({abs(rounded):,})'","+        return f'{rounded:,}'","+","+    # Default formatting","+    if isinstance(val, int) or (isinstance(val, float) and val == int(val) and abs(val) < 10000):","         return str(int(val))","     elif abs(val) < 0.0001 and val != 0:","         return f'{val:.6f}'"]},{"oldStart":196,"oldLines":7,"newStart":228,"newLines":6,"lines":[" ","     h = str(header).lower()"," ","-    # Detect change/delta columns","     is_change = any(kw in h for kw in ['变化', '较上周', '较上月', '较上年', 'bp'])","     is_return = any(kw in h for kw in ['年化', '收益率'])"," "]},{"oldStart":213,"oldLines":13,"newStart":244,"newLines":13,"lines":["     # Heatmap intensity for change columns","     if is_change and fval != 0:","         if col_type == 'percent':","-            intensity = min(abs(fval) * 20, 1)  # 5% decimal = max intensity","+            intensity = min(abs(fval) * 20, 1)","         elif col_type == 'percent_raw':","-            intensity = min(abs(fval) / 5, 1)  # 5% = max intensity","+            intensity = min(abs(fval) / 5, 1)","         elif 'bp' in h:","-            intensity = min(abs(fval) / 50, 1)  # 50bp = max intensity","+            intensity = min(abs(fval) / 50, 1)","         else:","-            intensity = min(abs(fval) / 20, 1)  # 20 units = max intensity","+            intensity = min(abs(fval) / 20, 1)","         level = min(int(intensity * 5) + 1, 5)","         if fval > 0:","             classes.append(f'heat-pos-{level}')"]},{"oldStart":233,"oldLines":7,"newStart":264,"newLines":6,"lines":["     \"\"\"Parse merged cell ranges into a dict of (row,col) -> (rowspan, colspan).\"\"\"","     merges = {}","     skip = set()","-","     for m in merged_list:","         match = re.match(r'([A-Z]+)(\\d+):([A-Z]+)(\\d+)', m)","         if not match:"]},{"oldStart":242,"oldLines":30,"newStart":272,"newLines":133,"lines":["         r1 = int(match.group(2))","         c2 = col_letter_to_num(match.group(3))","         r2 = int(match.group(4))","-","         rowspan = r2 - r1 + 1","         colspan = c2 - c1 + 1","         merges[(r1, c1)] = (rowspan, colspan)","-","         for r in range(r1, r2 + 1):","             for c in range(c1, c2 + 1):","                 if (r, c) != (r1, c1):","                     skip.add((r, c))","-","     return merges, skip"," "," "," def col_letter_to_num(letters):","-    \"\"\"Convert column letter(s) to number (A=1, B=2, ..., AA=27).\"\"\"","     num = 0","     for ch in letters:","         num = num * 26 + (ord(ch) - ord('A') + 1)","     return num"," "," ","-# ─── Section Definitions ───","-# Each section maps to one or more sheets from the output file","+# ─── Data Preprocessing ───","+def preprocess_sheets():","+    \"\"\"Add computed subtotal rows and fix data where needed.\"\"\""," ","+    # 1. Add subtotal rows to 分渠道余额","+    sheet = output_sheets.get('1、分渠道余额')","+    if sheet and sheet.get('data'):","+        data = sheet['data']","+        new_data = list(data[:3])  # Keep headers (rows 0-2)","+","+        # Group rows by 总分类","+        groups = {}","+        current_group = None","+        for ri in range(3, len(data)):","+            row = data[ri]","+            if row[0] is not None:","+                current_group = str(row[0])","+            if current_group:","+                if current_group not in groups:","+                    groups[current_group] = []","+                groups[current_group].append(row)","+","+        grand_total = [0, 0, 0]","+","+        for group_name in ['中低波稳健产品', '中高波市值产品', '外币产品']:","+            rows = groups.get(group_name, [])","+            subtotal = [0, 0]  # 行内, 行外","+            for row in rows:","+                v_inner = to_float(row[2])","+                v_outer = to_float(row[3])","+                if v_inner:","+                    subtotal[0] += v_inner","+                if v_outer:","+                    subtotal[1] += v_outer","+                new_data.append(row)","+","+            total_val = subtotal[0] + subtotal[1]","+            # Add subtotal row","+            label = f'{group_name}合计'","+            new_data.append([None, label, round(subtotal[0]), round(subtotal[1])])","+            grand_total[0] += subtotal[0]","+            grand_total[1] += subtotal[1]","+","+        # Add 合计 column header","+        if len(new_data[0]) == 4:","+            new_data[0] = [None, None, '保有规模', None, None]","+            new_data[1] = [None, '渠道-行内外', '行内', '行外', '合计']","+            new_data[2] = ['总分类', '母分类', None, None, None]","+","+        # Add 合计 column to each data row","+        for ri in range(3, len(new_data)):","+            row = new_data[ri]","+            if len(row) == 4:","+                v1 = to_float(row[2]) or 0","+                v2 = to_float(row[3]) or 0","+                row.append(round(v1 + v2))","+            elif len(row) == 5:","+                pass  # already has 合计","+","+        # Add 总计 row","+        new_data.append([None, '总计', round(grand_total[0]), round(grand_total[1]),","+                         round(grand_total[0] + grand_total[1])])","+","+        sheet['data'] = new_data","+        sheet['col_count'] = 5","+","+    # 2. Add 合计 row to 产品规模","+    sheet = output_sheets.get('2、产品规模')","+    if sheet and sheet.get('data'):","+        data = sheet['data']","+        # Check if 合计 row already exists","+        has_total = any(str(row[0] or '').strip() in ('合计', '总计') for row in data[1:])","+        if not has_total:","+            totals = [0] * len(data[0])","+            for row in data[1:]:","+                for ci in range(2, len(row)):","+                    v = to_float(row[ci])","+                    if v is not None:","+                        totals[ci] += v","+            total_row = ['', '合计']","+            for ci in range(2, len(data[0])):","+                total_row.append(round(totals[ci]))","+            while len(total_row) < len(data[0]):","+                total_row.append(None)","+            data.append(total_row)","+","+    # 3. Add 合计 row to 投资经理维度","+    sheet = output_sheets.get('投资经理维度产品规模和数量')","+    if sheet and sheet.get('data'):","+        data = sheet['data']","+        has_total = any(str(row[0] or '').strip() in ('合计', '总计') for row in data[1:])","+        if not has_total:","+            totals = [0] * len(data[0])","+            for row in data[1:]:","+                for ci in range(1, len(row)):","+                    v = to_float(row[ci])","+                    if v is not None:","+                        totals[ci] += v","+            total_row = ['合计']","+            for ci in range(1, len(data[0])):","+                total_row.append(round(totals[ci], 1))","+            while len(total_row) < len(data[0]):","+                total_row.append(None)","+            data.append(total_row)","+","+","+preprocess_sheets()","+","+","+# ─── Section Definitions (matching PDF TOC order) ───"," SECTIONS = [","     {","         'id': 'overview',"]},{"oldStart":274,"oldLines":6,"newStart":407,"newLines":7,"lines":["         'sheets': ['总结文字'],","         'type': 'overview'","     },","+    # ─── 一、规模及发行情况 ───","     {","         'id': 'channel-aum',","         'title': '1. 渠道代销规模',"]},{"oldStart":285,"oldLines":149,"newStart":419,"newLines":152,"lines":["         'id': 'product-scale',","         'title': '2. 产品规模',","         'icon': '&#9632;',","-        'sheets': ['2、产品规模', '不同形态产品规模和数量', '13.不同周期产品规模', '14.狭义客户周期和最短持有期的产品规模跟踪'],","+        'sheets': ['2、产品规模', '不同形态产品规模和数量', '13.不同周期产品规模',","+                   '14.狭义客户周期和最短持有期的产品规模跟踪'],","         'type': 'tables'","     },","     {","         'id': 'scale-changes',","-        'title': '3. 产品规模变化',","+        'title': '3. 在售产品销售情况',","         'icon': '&#9632;',","-        'sheets': ['3、本月定开或客户周期产品规模变化'],","+        'sheets': ['3、本月定开或客户周期产品规模变化', '本周新发产品', '待售产品'],","         'type': 'tables'","     },","     {","-        'id': 'new-products',","-        'title': '4. 新发/待售产品',","-        'icon': '&#9632;',","-        'sheets': ['本周新发产品', '待售产品'],","-        'type': 'tables'","-    },","-    {","         'id': 'pm-metrics',","-        'title': '5. 投资经理维度',","+        'title': '4. 投资经理维度',","         'icon': '&#9632;',","         'sheets': ['投资经理维度产品规模和数量'],","         'type': 'tables'","     },","     {","         'id': 'maturity',","-        'title': '6. 产品到期情况',","+        'title': '5. 产品到期情况',","         'icon': '&#9670;',","         'sheets': ['10.未来全年产品到期情况', '10.未来全年产品到期情况-定开', '10.下周到期产品清单'],","         'type': 'tables'","     },","+    # ─── 二、产品业绩 ───","     {","         'id': 'break-even',","-        'title': '7. 破净情况',","+        'title': '6. 破净情况',","         'icon': '&#9670;',","         'sheets': ['破净结果'],","         'type': 'tables'","     },","     {","         'id': 'market-index',","-        'title': '8. 市场指数收益',","+        'title': '7. 市场指数收益',","         'icon': '&#9670;',","         'sheets': ['15.市场指数收益'],","         'type': 'tables'","     },","     {","         'id': 'series-perf',","-        'title': '9. 系列产品业绩',","+        'title': '8. 系列产品业绩',","         'icon': '&#9670;',","-        'sheets': ['系列产品业绩-费后加权', '系列产品业绩-费后平均', '系列产品业绩-费前加权', '系列产品业绩-费前平均'],","+        'sheets': ['系列产品业绩-费前加权', '系列产品业绩-费后加权', '系列产品业绩-费前平均', '系列产品业绩-费后平均'],","         'type': 'tabs'","     },","     {","         'id': 'min-hold-perf',","-        'title': '10. 最短持有期业绩',","+        'title': '9. 最短持有期业绩',","         'icon': '&#9670;',","         'sheets': ['5.2 最短持有期产品业绩表现1', '5.2 最短持有期产品业绩表现2'],","         'type': 'tables'","     },","     {","         'id': 'underperform',","-        'title': '11. 不达基准清单',","+        'title': '10. 不达基准清单',","         'icon': '&#9888;',","-        'sheets': ['招商在售产品不达基准', '封闭及定开产品100日内不大业绩产品清单', '合享及悦动稳享临近到期预测不达标产品清单'],","+        'sheets': ['招商在售产品不达基准', '封闭及定开产品100日内不大业绩产品清单',","+                   '合享及悦动稳享临近到期预测不达标产品清单'],","         'type': 'tables'","     },","     {","         'id': 'high-vol',","-        'title': '12. 高波动产品',","+        'title': '11. 高波动产品',","         'icon': '&#9888;',","         'sheets': ['12.周净值高波动产品清单'],","         'type': 'tables'","     },","+    # ─── 资产与持仓 ───","     {","         'id': 'asset-alloc',","-        'title': '13. 资产大表',","+        'title': '12. 资产维度数据统计',","         'icon': '&#9679;',","         'sheets': ['8.资产大表'],","         'type': 'tables'","     },","     {","         'id': 'fee-income',","-        'title': '14. 中收监控',","+        'title': '13. 中收监控',","         'icon': '&#9679;',","         'sheets': ['9.中收监控'],","         'type': 'tables'","     },","     {","         'id': 'public-strategy',","-        'title': '15. 公共策略持仓',","+        'title': '14. 公共策略专户',","         'icon': '&#9679;',","         'sheets': ['公共策略持仓概况'],","         'type': 'tables'","     },","     {","         'id': 'xinghe',","-        'title': '16. 兴合产品持仓',","+        'title': '15. 兴合产品持仓',","         'icon': '&#9679;',","         'sheets': ['11.兴合产品持仓明细'],","         'type': 'tables'","     },","     {","         'id': 'bond-holdings',","-        'title': '17. 可转债/量化持仓',","+        'title': '16. 可转债/量化持仓',","         'icon': '&#9679;',","         'sheets': ['11.1 可转债专户持仓明细', '11.2量化和可转债持仓明细'],","         'type': 'tables'","     },","     {","         'id': 'outsource',","-        'title': '18. 委外专户配置',","+        'title': '17. 委外专户配置',","         'icon': '&#9679;',","-        'sheets': ['11.2.1其他委外专户金额配置情况', '11.2.2其他委外专户配置占比情况', '11.2.3其他委外专户配置占比情况-除以系列规模'],","+        'sheets': ['11.2.1其他委外专户金额配置情况', '11.2.2其他委外专户配置占比情况',","+                   '11.2.3其他委外专户配置占比情况-除以系列规模'],","         'type': 'tables'","     },","     {","         'id': 'derivatives',","-        'title': '19. 衍生品/非标持仓',","+        'title': '18. 衍生品/非标持仓',","         'icon': '&#9679;',","         'sheets': ['11.4其他衍生品专户持仓明细', '11.5全部衍生品专户持仓占比', '11.6非标持仓占比'],","         'type': 'tables'","     },","     {","         'id': 'gold-equity',","-        'title': '20. 黄金/权益持仓',","+        'title': '19. 黄金/权益持仓',","         'icon': '&#9679;',","         'sheets': ['黄金持仓', '权益专户持仓'],","         'type': 'tables'","     },"," ]"," ","+"," # ─── Compute Overview Stats ───"," def compute_overview_stats():","     stats = {}"," ","-    # Total AUM from 产品规模 - SUM all rows (not last row)","     ps = output_sheets.get('2、产品规模', {})","     if ps.get('data'):","         total_aum = 0","         total_count = 0","         total_aum_m = 0","         total_aum_y = 0","-        for row in ps['data'][1:]:  # skip header","+        for row in ps['data'][1:]:","+            first = str(row[0] or '').strip() if row[0] else ''","+            second = str(row[1] or '').strip() if len(row) > 1 else ''","+            # Skip the 合计 row we added","+            if first in ('合计', '总计') or second in ('合计', '总计'):","+                continue","             v = to_float(row[2]) if len(row) > 2 else None","             if v is not None:","                 total_aum += v"]},{"oldStart":445,"oldLines":7,"newStart":582,"newLines":6,"lines":["         stats['aum_vs_month'] = total_aum_m","         stats['aum_vs_year'] = total_aum_y"," ","-    # Summary text","     text_sheet = output_sheets.get('总结文字', {})","     if text_sheet.get('data'):","         for row in text_sheet['data'][1:]:"]},{"oldStart":459,"oldLines":18,"newStart":595,"newLines":15,"lines":["                 elif '到期' in key:","                     stats['daoqi_text'] = val"," ","-    # Break-even status","     bp_sheet = output_sheets.get('破净结果', {})","     if bp_sheet.get('data'):","         data_rows = [r for r in bp_sheet['data'][1:] if any(v is not None for v in r)]","         stats['broken_count'] = len(data_rows)"," ","-    # Underperforming count","     up_sheet = output_sheets.get('招商在售产品不达基准', {})","     if up_sheet.get('data'):","-        stats['underperform_count'] = len(up_sheet['data']) - 1  # minus header","+        stats['underperform_count'] = len(up_sheet['data']) - 1"," ","-    # High volatility count","     hv_sheet = output_sheets.get('12.周净值高波动产品清单', {})","     if hv_sheet.get('data'):","         stats['high_vol_count'] = len(hv_sheet['data']) - 1"]},{"oldStart":487,"oldLines":27,"newStart":620,"newLines":25,"lines":["     data = sheet_data['data']","     merged_cells = sheet_data.get('merged_cells', [])","     merges, skip_cells = parse_merged_cells(merged_cells)","-    col_types = detect_column_types(sheet_data)","+    col_types = detect_column_types(sheet_data, sheet_name)","+    use_parens = sheet_name in SCALE_INT_SHEETS"," ","     rows_html = []","     num_cols = sheet_data.get('col_count', 0)"," ","     for ri, row in enumerate(data):","         is_header = ri == 0","-        # Check if this is also a sub-header (row 1 or 2 for multi-header tables)","-        # A sub-header row should contain mostly text/None values, not numbers","+        # Check if this is a sub-header row (mostly text, not data)","         is_subheader = False","         if ri in (1, 2) and ri < len(data):","             row_vals = [v for v in row if v is not None]","             numeric_count = sum(1 for v in row_vals if is_numeric(v))","             text_count = len(row_vals) - numeric_count","-            # Only treat as sub-header if mostly text (at least 60% non-numeric)","             if row_vals and text_count > numeric_count and text_count >= 2:","                 is_subheader = True"," ","         cells_html = []","         for ci in range(min(len(row), num_cols)):","-            # Check if this cell should be skipped (part of a merge)","             if (ri + 1, ci + 1) in skip_cells:","                 continue"," "]},{"oldStart":516,"oldLines":7,"newStart":647,"newLines":6,"lines":[" ","             tag = 'th' if is_header or (is_subheader and ri < 3) else 'td'"," ","-            # Get header for this column (from first row)","             col_header = str(data[0][ci] or '') if ci < len(data[0]) else ''","             col_type = col_types.get(ci)"," "]},{"oldStart":524,"oldLines":7,"newStart":654,"newLines":7,"lines":["             if is_header or (is_subheader and ri < 3):","                 display = escape_html(str(val)) if val is not None else ''","             else:","-                display = format_cell_value(val, col_type)","+                display = format_cell_value(val, col_type, use_parens=use_parens)"," ","             # Build attributes","             attrs = []"]},{"oldStart":541,"oldLines":8,"newStart":671,"newLines":6,"lines":["                 cell_class = get_cell_class(val, col_type, col_header)","                 if cell_class:","                     css_classes.append(cell_class)","-","-                # Right-align numbers","                 fval = to_float(val)","                 if fval is not None:","                     css_classes.append('num-cell')"]},{"oldStart":553,"oldLines":14,"newStart":681,"newLines":19,"lines":["             attrs_str = ' ' + ' '.join(attrs) if attrs else ''","             cells_html.append(f'<{tag}{attrs_str}>{display}</{tag}>')"," ","+        # Determine row class","         row_class = 'header-row' if is_header else ('subheader-row' if is_subheader and ri < 3 else '')","-        # Highlight total/summary rows","         if not is_header and row:","             first_val = str(row[0] or '').strip()","-            if first_val in ('合计', '总计', '总合计', '-', '总规模'):","+            second_val = str(row[1] or '').strip() if len(row) > 1 else ''","+            if first_val in ('合计', '总计', '总合计', '汇总', '总规模') or \\","+               second_val in ('合计', '总计', '汇总'):","                 row_class = 'total-row'","-            # Also check if any cell contains 合计","-            if any('合计' in str(v or '') for v in row[:3]):","+            # Subtotal rows (e.g., \"中低波稳健产品合计\")","+            elif '合计' in second_val:","+                row_class = 'subtotal-row'","+            # Check any of first 3 cells for 合计","+            elif any('合计' in str(v or '') for v in row[:3]):","                 row_class = 'total-row'"," ","         row_class_attr = f' class=\"{row_class}\"' if row_class else ''"]},{"oldStart":583,"oldLines":30,"newStart":716,"newLines":36,"lines":["         parts.append(generate_overview_html(stats))"," ","     elif section['type'] == 'tabs':","-        # Tabbed interface for multiple variants of the same data","         tab_names = []","         tab_contents = []","         for i, sn in enumerate(section['sheets']):","             sd = output_sheets.get(sn)","             if not sd:","                 continue","-            # Create short tab name","+            # Create display-friendly tab names","             short = sn.replace('系列产品业绩-', '')","             tab_names.append(short)","             active = 'active' if i == 0 else ''","-            tab_contents.append(f'<div class=\"tab-content {active}\" data-tab=\"{section[\"id\"]}-tab-{i}\">{generate_table_html(sn, sd)}</div>')","+            tab_contents.append(","+                f'<div class=\"tab-content {active}\" data-tab=\"{section[\"id\"]}-tab-{i}\">'","+                f'{generate_table_html(sn, sd)}</div>')"," ","         tabs_html = ''.join(","-            f'<button class=\"tab-btn {\"active\" if i == 0 else \"\"}\" onclick=\"switchTab(\\'{section[\"id\"]}\\', {i})\" data-tabgroup=\"{section[\"id\"]}\" data-tabidx=\"{i}\">{tn}</button>'","+            f'<button class=\"tab-btn {\"active\" if i == 0 else \"\"}\" '","+            f'onclick=\"switchTab(\\'{section[\"id\"]}\\', {i})\" '","+            f'data-tabgroup=\"{section[\"id\"]}\" data-tabidx=\"{i}\">{tn}</button>'","             for i, tn in enumerate(tab_names)","         )","-        parts.append(f'<div class=\"tabs-container\"><div class=\"tab-buttons\">{tabs_html}</div>{\"\".join(tab_contents)}</div>')","+        parts.append(","+            f'<div class=\"tabs-container\"><div class=\"tab-buttons\">{tabs_html}</div>'","+            f'{\"\".join(tab_contents)}</div>')"," ","     elif section['type'] == 'tables':","         for sn in section['sheets']:","             sd = output_sheets.get(sn)","             if not sd:","                 continue","+            # Display-friendly subtitle","             subtitle = sn","             parts.append(f'<h3 class=\"sheet-title\">{escape_html(subtitle)}</h3>')","             parts.append(generate_table_html(sn, sd))"]},{"oldStart":615,"oldLines":16,"newStart":754,"newLines":15,"lines":[" "," "," def generate_overview_html(stats):","-    \"\"\"Generate the overview/summary section.\"\"\"","     aum = stats.get('total_aum')","     aum_str = f'{aum:,.0f}亿' if aum and aum > 100 else (f'{aum:,.2f}亿' if aum else 'N/A')","     count = stats.get('total_count')","     count_str = f'{int(count)}只' if count else 'N/A'","     aum_m = stats.get('aum_vs_month')","-    aum_m_str = f'{aum_m:+.2f}亿' if aum_m is not None else 'N/A'","+    aum_m_str = f'{aum_m:+.0f}亿' if aum_m is not None else 'N/A'","     aum_m_class = 'stat-positive' if aum_m and aum_m > 0 else ('stat-negative' if aum_m and aum_m < 0 else '')","     aum_y = stats.get('aum_vs_year')","-    aum_y_str = f'{aum_y:+.2f}亿' if aum_y is not None else 'N/A'","+    aum_y_str = f'{aum_y:+.0f}亿' if aum_y is not None else 'N/A'","     aum_y_class = 'stat-positive' if aum_y and aum_y > 0 else ('stat-negative' if aum_y and aum_y < 0 else '')"," ","     broken = stats.get('broken_count', 0)"]},{"oldStart":634,"oldLines":7,"newStart":772,"newLines":6,"lines":["     underperf = stats.get('underperform_count', 0)","     high_vol = stats.get('high_vol_count', 0)"," ","-    # Summary text cards","     text_cards = ''","     for key, label in [('guimo_text', '规模概况'), ('zhongshou_text', '中收概况'), ('daoqi_text', '到期概况')]:","         text = stats.get(key, '')"]},{"oldStart":645,"oldLines":22,"newStart":782,"newLines":28,"lines":[" <div class=\"text-card-content\">{text_display}</div>"," </div>'''"," ","-    # Build mini AUM bar chart from 产品规模 data","+    # Build bar chart from 产品规模 data","     ps = output_sheets.get('2、产品规模', {})","     bar_items = []","     if ps.get('data'):","         max_aum = 0","         for row in ps['data'][1:]:","+            second = str(row[1] or '').strip() if len(row) > 1 else ''","+            if second in ('合计', '总计'):","+                continue","             v = to_float(row[2]) if len(row) > 2 else None","             if v and v > max_aum:","                 max_aum = v","         for row in ps['data'][1:]:","             name = str(row[1] or '')","+            if name in ('合计', '总计'):","+                continue","             v = to_float(row[2]) if len(row) > 2 else 0","             chg = to_float(row[3]) if len(row) > 3 else 0","             if v and name:","                 pct = (v / max_aum * 100) if max_aum > 0 else 0","-                color = 'var(--positive)' if chg and chg > 0 else ('var(--negative)' if chg and chg < 0 else 'var(--accent-blue)')","+                color = 'var(--positive)' if chg and chg > 0 else (","+                    'var(--negative)' if chg and chg < 0 else 'var(--accent-blue)')","                 bar_items.append(f'''<div class=\"bar-row\">","   <div class=\"bar-label\" title=\"{escape_html(name)}\">{escape_html(name[:8])}</div>","   <div class=\"bar-track\"><div class=\"bar-fill\" style=\"width:{pct:.1f}%;background:{color}\"></div></div>"]},{"oldStart":774,"oldLines":84,"newStart":917,"newLines":63,"lines":["   overflow-x: hidden;"," }"," ","-/* ─── Header ─── */","+/* Header */"," .top-header {","   position: fixed;","-  top: 0;","-  left: 0;","-  right: 0;","+  top: 0; left: 0; right: 0;","   height: var(--header-height);","   background: linear-gradient(135deg, #0a1628 0%, #0f1d35 100%);","   border-bottom: 1px solid var(--border);","-  display: flex;","-  align-items: center;","+  display: flex; align-items: center;","   padding: 0 24px;","   z-index: 100;","   backdrop-filter: blur(12px);"," }"," ","-.header-brand {","-  display: flex;","-  align-items: center;","-  gap: 12px;","-}","+.header-brand { display: flex; align-items: center; gap: 12px; }"," "," .header-logo {","-  width: 32px;","-  height: 32px;","+  width: 32px; height: 32px;","   background: linear-gradient(135deg, var(--accent-gold), #d97706);","   border-radius: 8px;","-  display: flex;","-  align-items: center;","-  justify-content: center;","-  font-weight: 700;","-  font-size: 14px;","-  color: #0a0f1c;","+  display: flex; align-items: center; justify-content: center;","+  font-weight: 700; font-size: 14px; color: #0a0f1c;"," }"," "," .header-title {","   font-family: \"Noto Serif SC\", serif;","-  font-size: 16px;","-  font-weight: 700;","+  font-size: 16px; font-weight: 700;","   color: var(--text-header);","   letter-spacing: 1px;"," }"," "," .header-date {","   margin-left: auto;","-  font-size: 12px;","-  color: var(--text-secondary);","+  font-size: 12px; color: var(--text-secondary);","   background: var(--bg-card);","-  padding: 4px 12px;","-  border-radius: 4px;","+  padding: 4px 12px; border-radius: 4px;","   border: 1px solid var(--border);","   font-variant-numeric: tabular-nums;"," }"," ","-/* ─── Sidebar ─── */","+/* Sidebar */"," .sidebar {","   position: fixed;","-  top: var(--header-height);","-  left: 0;","-  bottom: 0;","+  top: var(--header-height); left: 0; bottom: 0;","   width: var(--sidebar-width);","   background: var(--bg-sidebar);","   border-right: 1px solid var(--border);","   overflow-y: auto;","-  padding: 12px 0;","-  z-index: 90;","+  padding: 12px 0; z-index: 90;"," }"," "," .sidebar::-webkit-scrollbar { width: 4px; }"," .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }"," ","-.sidebar-section {","-  padding: 4px 0;","-}","+.sidebar-section { padding: 4px 0; }"," "," .sidebar-group-label {","-  font-size: 10px;","-  font-weight: 600;","+  font-size: 10px; font-weight: 600;","   color: var(--text-muted);","   text-transform: uppercase;","   letter-spacing: 1.5px;"]},{"oldStart":859,"oldLines":22,"newStart":981,"newLines":16,"lines":[" }"," "," .nav-item {","-  display: flex;","-  align-items: center;","-  gap: 10px;","+  display: flex; align-items: center; gap: 10px;","   padding: 8px 20px;","   color: var(--text-secondary);","-  text-decoration: none;","-  font-size: 12.5px;","+  text-decoration: none; font-size: 12.5px;","   cursor: pointer;","   transition: all 0.15s ease;","   border-left: 3px solid transparent;"," }"," ","-.nav-item:hover {","-  color: var(--text-primary);","-  background: var(--bg-card);","-}","+.nav-item:hover { color: var(--text-primary); background: var(--bg-card); }"," "," .nav-item.active {","   color: var(--accent-gold);"]},{"oldStart":882,"oldLines":14,"newStart":998,"newLines":9,"lines":["   border-left-color: var(--accent-gold);"," }"," ","-.nav-icon {","-  font-size: 8px;","-  opacity: 0.6;","-  width: 14px;","-  text-align: center;","-}","+.nav-icon { font-size: 8px; opacity: 0.6; width: 14px; text-align: center; }"," ","-/* ─── Main Content ─── */","+/* Main Content */"," .main-content {","   margin-left: var(--sidebar-width);","   margin-top: var(--header-height);"]},{"oldStart":900,"oldLines":44,"newStart":1011,"newLines":39,"lines":[" .section {","   margin-bottom: 36px;","   scroll-margin-top: calc(var(--header-height) + 20px);","+  animation: fadeInUp 0.4s ease-out;"," }"," "," .section-header {","   font-family: \"Noto Serif SC\", serif;","-  font-size: 18px;","-  font-weight: 700;","+  font-size: 18px; font-weight: 700;","   color: var(--text-header);","   margin-bottom: 16px;","   padding-bottom: 10px;","   border-bottom: 2px solid var(--accent-gold);","-  display: flex;","-  align-items: center;","-  gap: 10px;","+  display: flex; align-items: center; gap: 10px;"," }"," "," .section-header::before {","   content: '';","-  width: 4px;","-  height: 20px;","+  width: 4px; height: 20px;","   background: var(--accent-gold);","   border-radius: 2px;"," }"," "," .sheet-title {","-  font-size: 13px;","-  font-weight: 600;","+  font-size: 13px; font-weight: 600;","   color: var(--accent-cyan);","   margin: 16px 0 8px;","   padding-left: 12px;","   border-left: 2px solid var(--accent-cyan);"," }"," ","-/* ─── Overview Cards ─── */","+/* Overview Cards */"," .overview-grid {","   display: grid;","   grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));","-  gap: 14px;","-  margin-bottom: 20px;","+  gap: 14px; margin-bottom: 20px;"," }"," "," .stat-card {"]},{"oldStart":948,"oldLines":58,"newStart":1054,"newLines":37,"lines":["   transition: transform 0.2s ease, box-shadow 0.2s ease;"," }"," ","-.stat-card:hover {","-  transform: translateY(-2px);","-  box-shadow: 0 4px 20px rgba(0,0,0,0.3);","-}","+.stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }"," "," .stat-card.stat-primary {","   border-color: var(--accent-gold);","   background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), var(--bg-card));"," }","-"," .stat-card.stat-alert {","   border-color: var(--negative);","   background: linear-gradient(135deg, var(--negative-bg), var(--bg-card));"," }","-"," .stat-card.stat-ok {","   border-color: var(--positive);","   background: linear-gradient(135deg, var(--positive-bg), var(--bg-card));"," }"," "," .stat-label {","-  font-size: 11px;","-  color: var(--text-muted);","+  font-size: 11px; color: var(--text-muted);","   text-transform: uppercase;","-  letter-spacing: 0.5px;","-  margin-bottom: 6px;","+  letter-spacing: 0.5px; margin-bottom: 6px;"," }"," "," .stat-value {","-  font-size: 22px;","-  font-weight: 700;","+  font-size: 22px; font-weight: 700;","   color: var(--text-header);","   font-variant-numeric: tabular-nums;"," }"," ","-.stat-sub {","-  margin-top: 8px;","-  display: flex;","-  gap: 14px;","-  font-size: 11px;","-}","-","+.stat-sub { margin-top: 8px; display: flex; gap: 14px; font-size: 11px; }"," .stat-positive { color: var(--positive); }"," .stat-negative { color: var(--negative); }"," ","-.text-cards-grid {","-  display: grid;","-  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));","-  gap: 14px;","-  margin-top: 14px;","-}","-"," .text-card {","   background: var(--bg-card);","   border: 1px solid var(--border);"]},{"oldStart":1008,"oldLines":82,"newStart":1093,"newLines":45,"lines":[" }"," "," .text-card-label {","-  font-size: 11px;","-  font-weight: 600;","+  font-size: 11px; font-weight: 600;","   color: var(--accent-cyan);","   text-transform: uppercase;","-  letter-spacing: 0.5px;","-  margin-bottom: 8px;","+  letter-spacing: 0.5px; margin-bottom: 8px;"," }"," "," .text-card-content {","-  font-size: 12.5px;","-  line-height: 1.7;","+  font-size: 12.5px; line-height: 1.7;","   color: var(--text-secondary);"," }"," ","-/* ─── Bar Chart ─── */","-.bar-chart {","-  display: flex;","-  flex-direction: column;","-  gap: 4px;","-}","-","-.bar-row {","-  display: flex;","-  align-items: center;","-  gap: 8px;","-  height: 18px;","-}","-","+/* Bar Chart */","+.bar-chart { display: flex; flex-direction: column; gap: 4px; }","+.bar-row { display: flex; align-items: center; gap: 8px; height: 18px; }"," .bar-label {","-  width: 80px;","-  font-size: 10.5px;","+  width: 80px; font-size: 10.5px;","   color: var(--text-secondary);","-  text-align: right;","-  flex-shrink: 0;","-  overflow: hidden;","-  text-overflow: ellipsis;","-  white-space: nowrap;","+  text-align: right; flex-shrink: 0;","+  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"," }","-"," .bar-track {","-  flex: 1;","-  height: 10px;","+  flex: 1; height: 10px;","   background: var(--bg-secondary);","-  border-radius: 3px;","-  overflow: hidden;","+  border-radius: 3px; overflow: hidden;"," }","-","-.bar-fill {","-  height: 100%;","-  border-radius: 3px;","-  transition: width 0.6s ease;","-  min-width: 2px;","-}","-","+.bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; min-width: 2px; }"," .bar-value {","-  width: 45px;","-  font-size: 10.5px;","+  width: 45px; font-size: 10.5px;","   color: var(--text-muted);","-  text-align: right;","-  font-variant-numeric: tabular-nums;","+  text-align: right; font-variant-numeric: tabular-nums;"," }"," "," .text-cards-inline {","-  display: flex;","-  flex-direction: column;","-  gap: 8px;","-  max-height: 320px;","-  overflow-y: auto;","+  display: flex; flex-direction: column; gap: 8px;","+  max-height: 320px; overflow-y: auto;"," }","+.text-cards-inline .text-card { padding: 10px 14px; border-radius: 6px; }"," ","-.text-cards-inline .text-card {","-  padding: 10px 14px;","-  border-radius: 6px;","-}","-","-/* ─── Tables ─── */","+/* Tables */"," .table-wrapper {","   overflow-x: auto;","   margin: 8px 0 20px;"]},{"oldStart":1096,"oldLines":10,"newStart":1144,"newLines":8,"lines":[" .table-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }"," "," table {","-  width: 100%;","-  border-collapse: collapse;","-  font-size: 12px;","-  font-variant-numeric: tabular-nums;","+  width: 100%; border-collapse: collapse;","+  font-size: 12px; font-variant-numeric: tabular-nums;","   white-space: nowrap;"," }"," "]},{"oldStart":1108,"oldLines":30,"newStart":1154,"newLines":20,"lines":["   border-bottom: 1px solid var(--border-light);","   text-align: left;","   max-width: 280px;","-  overflow: hidden;","-  text-overflow: ellipsis;","+  overflow: hidden; text-overflow: ellipsis;"," }"," "," th {","   background: var(--bg-table-header);","   color: var(--text-secondary);","-  font-weight: 600;","-  font-size: 11px;","-  text-transform: none;","+  font-weight: 600; font-size: 11px;","   letter-spacing: 0.3px;","-  position: sticky;","-  top: 0;","-  z-index: 2;","+  position: sticky; top: 0; z-index: 2;"," }"," ","-tr:nth-child(even) td {","-  background: var(--bg-table-row-alt);","-}","+tr:nth-child(even) td { background: var(--bg-table-row-alt); }","+tr:hover td { background: var(--bg-card-hover) !important; }"," ","-tr:hover td {","-  background: var(--bg-card-hover) !important;","-}","-"," .num-cell {","   text-align: right;","   font-family: \"SF Mono\", \"Cascadia Code\", \"JetBrains Mono\", monospace;"]},{"oldStart":1147,"oldLines":7,"newStart":1183,"newLines":13,"lines":["   border-top: 2px solid var(--accent-gold);"," }"," ","-/* Merged cell (rowspan) group indicator */","+.subtotal-row td {","+  font-weight: 600;","+  background: rgba(6, 182, 212, 0.04) !important;","+  border-top: 1px solid var(--accent-cyan);","+  color: var(--accent-cyan);","+}","+"," td[rowspan] {","   background: var(--bg-table-header) !important;","   font-weight: 600;"]},{"oldStart":1161,"oldLines":7,"newStart":1203,"newLines":7,"lines":["   background: linear-gradient(180deg, var(--bg-table-header), rgba(15, 27, 51, 0.9));"," }"," ","-/* ─── Heatmap ─── */","+/* Heatmap */"," .heat-pos-1 { background: var(--heat-pos-1) !important; }"," .heat-pos-2 { background: var(--heat-pos-2) !important; }"," .heat-pos-3 { background: var(--heat-pos-3) !important; }"]},{"oldStart":1173,"oldLines":15,"newStart":1215,"newLines":13,"lines":[" .heat-neg-4 { background: var(--heat-neg-4) !important; }"," .heat-neg-5 { background: var(--heat-neg-5) !important; }"," ","-/* ─── Tabs ─── */","+/* Tabs */"," .tabs-container { margin: 8px 0 20px; }"," "," .tab-buttons {","-  display: flex;","-  gap: 0;","+  display: flex; gap: 0;","   margin-bottom: -1px;","-  position: relative;","-  z-index: 3;","+  position: relative; z-index: 3;"," }"," "," .tab-btn {"]},{"oldStart":1190,"oldLines":8,"newStart":1230,"newLines":7,"lines":["   border: 1px solid var(--border);","   border-bottom: none;","   color: var(--text-secondary);","-  font-size: 12px;","-  cursor: pointer;","+  font-size: 12px; cursor: pointer;","   border-radius: 6px 6px 0 0;","   transition: all 0.15s ease;"," }"]},{"oldStart":1207,"oldLines":40,"newStart":1246,"newLines":30,"lines":[" .tab-content { display: none; }"," .tab-content.active { display: block; }"," ","-/* ─── Empty State ─── */"," .empty-state {","-  padding: 32px;","-  text-align: center;","-  color: var(--text-muted);","-  font-size: 13px;","+  padding: 32px; text-align: center;","+  color: var(--text-muted); font-size: 13px;","   background: var(--bg-card);","   border-radius: 8px;","   border: 1px dashed var(--border);"," }"," ","-/* ─── Search ─── */","-.search-bar {","-  display: flex;","-  align-items: center;","-  margin-left: 24px;","-}","+/* Search */","+.search-bar { display: flex; align-items: center; margin-left: 24px; }"," "," .search-input {","   background: var(--bg-card);","   border: 1px solid var(--border);","   color: var(--text-primary);","-  padding: 6px 12px;","-  font-size: 12px;","-  border-radius: 6px;","-  width: 200px;","-  outline: none;","-  transition: border-color 0.2s;","+  padding: 6px 12px; font-size: 12px;","+  border-radius: 6px; width: 200px;","+  outline: none; transition: border-color 0.2s;"," }"," "," .search-input:focus { border-color: var(--accent-blue); }"," .search-input::placeholder { color: var(--text-muted); }"," ","-/* ─── Print ─── */","+/* Print */"," @media print {","   .sidebar, .top-header { display: none; }","   .main-content { margin: 0; padding: 10px; }"]},{"oldStart":1249,"oldLines":17,"newStart":1278,"newLines":11,"lines":["   .stat-card { break-inside: avoid; }"," }"," ","-/* ─── Animations ─── */"," @keyframes fadeInUp {","   from { opacity: 0; transform: translateY(12px); }","   to { opacity: 1; transform: translateY(0); }"," }"," ","-.section {","-  animation: fadeInUp 0.4s ease-out;","-}","-","-/* ─── Responsive ─── */"," @media (max-width: 900px) {","   .sidebar { display: none; }","   .main-content { margin-left: 0; }"]},{"oldStart":1268,"oldLines":22,"newStart":1291,"newLines":16,"lines":[" "," # ─── JavaScript ───"," JS = '''","-// Tab switching"," function switchTab(groupId, tabIdx) {","-  // Deactivate all tabs in group","   document.querySelectorAll(`[data-tabgroup=\"${groupId}\"]`).forEach(btn => btn.classList.remove('active'));","   document.querySelectorAll(`[data-tab^=\"${groupId}-tab-\"]`).forEach(c => c.classList.remove('active'));","-","-  // Activate selected","   document.querySelector(`[data-tabgroup=\"${groupId}\"][data-tabidx=\"${tabIdx}\"]`).classList.add('active');","   document.querySelector(`[data-tab=\"${groupId}-tab-${tabIdx}\"]`).classList.add('active');"," }"," ","-// Sidebar navigation highlighting"," function initNavHighlight() {","   const sections = document.querySelectorAll('.section');","   const navItems = document.querySelectorAll('.nav-item');","-","   const observer = new IntersectionObserver((entries) => {","     entries.forEach(entry => {","       if (entry.isIntersecting) {"]},{"oldStart":1294,"oldLines":34,"newStart":1311,"newLines":23,"lines":["       }","     });","   }, { threshold: 0.2, rootMargin: '-80px 0px -60% 0px' });","-","   sections.forEach(s => observer.observe(s));"," }"," ","-// Search functionality"," function initSearch() {","   const input = document.getElementById('global-search');","   if (!input) return;","-","   input.addEventListener('input', (e) => {","     const query = e.target.value.toLowerCase().trim();","-    const allTables = document.querySelectorAll('table');","-","-    allTables.forEach(table => {","-      const rows = table.querySelectorAll('tr:not(.header-row):not(.subheader-row)');","-      rows.forEach(row => {","-        if (!query) {","-          row.style.display = '';","-          return;","-        }","-        const text = row.textContent.toLowerCase();","-        row.style.display = text.includes(query) ? '' : 'none';","+    document.querySelectorAll('table').forEach(table => {","+      table.querySelectorAll('tr:not(.header-row):not(.subheader-row)').forEach(row => {","+        if (!query) { row.style.display = ''; return; }","+        row.style.display = row.textContent.toLowerCase().includes(query) ? '' : 'none';","       });","     });","   });"," }"," ","-// Table sorting"," function initTableSort() {","   document.querySelectorAll('th').forEach(th => {","     th.style.cursor = 'pointer';"]},{"oldStart":1329,"oldLines":27,"newStart":1335,"newLines":19,"lines":["       const table = th.closest('table');","       const idx = Array.from(th.parentNode.children).indexOf(th);","       const tbody = table.querySelector('tbody') || table;","-      const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('header-row') && !r.classList.contains('subheader-row'));","-","-      // Skip if first few rows are headers","-      const headerRows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.classList.contains('header-row') || r.classList.contains('subheader-row'));","-","+      const rows = Array.from(tbody.querySelectorAll('tr')).filter(r =>","+        !r.classList.contains('header-row') && !r.classList.contains('subheader-row') &&","+        !r.classList.contains('total-row') && !r.classList.contains('subtotal-row'));","       const isAsc = th.getAttribute('data-sort') !== 'asc';","       th.setAttribute('data-sort', isAsc ? 'asc' : 'desc');","-","       rows.sort((a, b) => {","-        const aVal = a.children[idx]?.textContent?.trim() || '';","-        const bVal = b.children[idx]?.textContent?.trim() || '';","+        const aVal = a.children[idx]?.textContent?.trim()?.replace(/[()]/g, '') || '';","+        const bVal = b.children[idx]?.textContent?.trim()?.replace(/[()]/g, '') || '';","         const aNum = parseFloat(aVal.replace(/[,%亿万只]/g, ''));","         const bNum = parseFloat(bVal.replace(/[,%亿万只]/g, ''));","-","-        if (!isNaN(aNum) && !isNaN(bNum)) {","-          return isAsc ? aNum - bNum : bNum - aNum;","-        }","+        if (!isNaN(aNum) && !isNaN(bNum)) return isAsc ? aNum - bNum : bNum - aNum;","         return isAsc ? aVal.localeCompare(bVal, 'zh') : bVal.localeCompare(aVal, 'zh');","       });","-","-      // Re-append in order (after header rows)","       rows.forEach(r => tbody.appendChild(r));","     });","   });"]},{"oldStart":1365,"oldLines":24,"newStart":1363,"newLines":24,"lines":[" "," # ─── Assemble HTML ───"," def generate_html():","-    # Sidebar navigation","-    nav_html = ''","+    # Sidebar navigation - grouped to match PDF structure","     groups = {","-        '规模及发行': ['overview', 'channel-aum', 'product-scale', 'scale-changes', 'new-products', 'pm-metrics'],","-        '产品业绩': ['market-index', 'break-even', 'series-perf', 'min-hold-perf', 'underperform', 'high-vol'],","-        '到期情况': ['maturity'],","-        '资产配置': ['asset-alloc', 'fee-income'],","-        '持仓明细': ['public-strategy', 'xinghe', 'bond-holdings', 'outsource', 'derivatives', 'gold-equity'],","+        '一、规模及发行': ['overview', 'channel-aum', 'product-scale', 'scale-changes', 'pm-metrics', 'maturity'],","+        '二、产品业绩': ['break-even', 'market-index', 'series-perf', 'min-hold-perf', 'underperform', 'high-vol'],","+        '三、资产与持仓': ['asset-alloc', 'fee-income', 'public-strategy', 'xinghe', 'bond-holdings',","+                     'outsource', 'derivatives', 'gold-equity'],","     }"," ","     section_map = {s['id']: s for s in SECTIONS}"," ","+    nav_html = ''","     for group_name, section_ids in groups.items():","         nav_html += f'<div class=\"sidebar-section\"><div class=\"sidebar-group-label\">{group_name}</div>'","         for sid in section_ids:","             sec = section_map.get(sid)","             if sec:","-                nav_html += f'<a class=\"nav-item\" href=\"#{sid}\"><span class=\"nav-icon\">{sec[\"icon\"]}</span>{sec[\"title\"]}</a>'","+                nav_html += (f'<a class=\"nav-item\" href=\"#{sid}\">'","+                             f'<span class=\"nav-icon\">{sec[\"icon\"]}</span>{sec[\"title\"]}</a>')","         nav_html += '</div>'"," ","     # Main content sections"]},{"oldStart":1394,"oldLines":7,"newStart":1392,"newLines":9,"lines":[" {section_content}"," </div>'''"," ","-    # Full HTML","+    from datetime import datetime","+    now = datetime.now().strftime('%Y-%m-%d %H:%M')","+","     html = f'''<!DOCTYPE html>"," <html lang=\"zh-CN\">"," <head>"]},{"oldStart":1424,"oldLines":6,"newStart":1424,"newLines":9,"lines":[" "," <main class=\"main-content\">"," {content_html}","+<footer style=\"text-align:center;padding:24px;color:var(--text-muted);font-size:11px;border-top:1px solid var(--border);margin-top:40px;\">","+  兴银理财多资产投资部 | 数据截止 {REPORT_DATE} | 仪表板生成于 {now}","+</footer>"," </main>"," "," <script>"]},{"oldStart":1432,"oldLines":15,"newStart":1435,"newLines":6,"lines":[" </body>"," </html>'''"," ","-    # Add generation footer","-    from datetime import datetime","-    now = datetime.now().strftime('%Y-%m-%d %H:%M')","-    html = html.replace('</main>', f'''","-<footer style=\"text-align:center;padding:24px;color:var(--text-muted);font-size:11px;border-top:1px solid var(--border);margin-top:40px;\">","-  兴银理财多资产投资部 | 数据截止 {REPORT_DATE} | 仪表板生成于 {now}","-</footer>","-</main>''')","-","     return html"," "," "]}],"originalFile":"#!/usr/bin/env python3\n\"\"\"\nGenerate a comprehensive web dashboard for the weekly report.\nReads data from the extracted JSON and generates a self-contained HTML file.\n\"\"\"\nimport json\nimport os\nimport math\nimport re\n\n# ─── Configuration ───\nJSON_PATH = '/tmp/weekly_report_data.json'\nOUTPUT_HTML = '/Users/fanshengxia/Desktop/周报V2/输出结果/周报仪表板-20260205.html'\nREPORT_DATE = '2026-02-05'\nREPORT_TITLE = '多资产投资部理财产品运作周报'\n\n# ─── Load Data ───\nwith open(JSON_PATH, 'r', encoding='utf-8') as f:\n    raw_data = json.load(f)\n\noutput_sheets = raw_data['output_file']\nvba_sheets = raw_data['vba_workbook']\n\n# ─── Helper Functions ───\n\ndef fmt_num(val, decimals=2, is_percent=False, is_bps=False):\n    \"\"\"Format a number for display.\"\"\"\n    if val is None:\n        return ''\n    if isinstance(val, str):\n        if val == 'nan' or val == 'inf' or val == '-inf':\n            return ''\n        try:\n            val = float(val)\n        except:\n            return val\n    if isinstance(val, bool):\n        return str(val)\n    if not isinstance(val, (int, float)):\n        return str(val)\n    if math.isnan(val) or math.isinf(val):\n        return ''\n    if is_percent:\n        return f'{val * 100:.{decimals}f}%'\n    if is_bps:\n        return f'{val:.{decimals}f}'\n    if abs(val) >= 1e8:\n        return f'{val/1e8:.{decimals}f}亿'\n    if abs(val) >= 1e4:\n        return f'{val/1e4:.{decimals}f}万'\n    if isinstance(val, int) or (isinstance(val, float) and val == int(val) and abs(val) < 1000):\n        return str(int(val))\n    return f'{val:.{decimals}f}'\n\n\ndef is_numeric(val):\n    if val is None:\n        return False\n    if isinstance(val, (int, float)):\n        return not (isinstance(val, float) and (math.isnan(val) or math.isinf(val)))\n    if isinstance(val, str):\n        try:\n            float(val)\n            return True\n        except:\n            return False\n    return False\n\n\ndef to_float(val):\n    if val is None:\n        return None\n    if isinstance(val, (int, float)):\n        if isinstance(val, float) and (math.isnan(val) or math.isinf(val)):\n            return None\n        return float(val)\n    if isinstance(val, str):\n        if val in ('nan', 'inf', '-inf', ''):\n            return None\n        try:\n            return float(val)\n        except:\n            return None\n    return None\n\n\ndef escape_html(s):\n    if s is None:\n        return ''\n    s = str(s)\n    return s.replace('&', '&amp;').replace('<', '&lt;').replace('>', '&gt;').replace('\"', '&quot;')\n\n\ndef detect_column_types(sheet_data):\n    \"\"\"Detect which columns contain percentages, basis points, or regular numbers.\"\"\"\n    data = sheet_data['data']\n    headers = data[0] if data else []\n    col_types = {}\n\n    for ci in range(len(headers)):\n        h = str(headers[ci] or '')\n        h_lower = h.lower()\n        is_pct_header = '年化' in h or '收益率' in h or '波动率' in h or '占比' in h or '比例' in h\n\n        if 'bp' in h_lower or '净值变化bp' in h:\n            col_types[ci] = 'bps'\n            continue\n\n        if is_pct_header:\n            # Check if values are already in percentage form (> 1) or decimal form (< 1)\n            numeric_vals = []\n            for ri in range(1, min(len(data), 20)):\n                if ci < len(data[ri]):\n                    v = to_float(data[ri][ci])\n                    if v is not None and v != 0:\n                        numeric_vals.append(abs(v))\n            if numeric_vals:\n                avg = sum(numeric_vals) / len(numeric_vals)\n                if avg > 0.5:\n                    # Already in percentage form (e.g., 1.87 = 1.87%)\n                    col_types[ci] = 'percent_raw'\n                else:\n                    # Decimal form (e.g., 0.0187 = 1.87%)\n                    col_types[ci] = 'percent'\n            else:\n                col_types[ci] = 'percent'\n        else:\n            # Check if values look like percentages (small decimals 0~0.5 range)\n            numeric_vals = []\n            for ri in range(1, min(len(data), 20)):\n                if ci < len(data[ri]):\n                    v = to_float(data[ri][ci])\n                    if v is not None and v != 0:\n                        numeric_vals.append(abs(v))\n            if len(numeric_vals) >= 2:\n                avg = sum(numeric_vals) / len(numeric_vals)\n                max_v = max(numeric_vals)\n                if 0 < avg < 0.5 and max_v < 1.5:\n                    col_types[ci] = 'percent'\n\n    return col_types\n\n\ndef format_cell_value(val, col_type=None):\n    \"\"\"Format a cell value based on its type.\"\"\"\n    if val is None:\n        return ''\n    if isinstance(val, str):\n        if val in ('nan', 'inf', '-inf'):\n            return ''\n        # Check if it's a string that looks like a number\n        try:\n            fval = float(val)\n            val = fval\n        except:\n            return escape_html(val)\n\n    if isinstance(val, bool):\n        return str(val)\n\n    if not isinstance(val, (int, float)):\n        return escape_html(str(val))\n\n    if math.isnan(val) or math.isinf(val):\n        return ''\n\n    if col_type == 'percent':\n        return f'{val * 100:.2f}%'\n    elif col_type == 'percent_raw':\n        return f'{val:.2f}%'\n    elif col_type == 'bps':\n        return f'{val:.2f}'\n    elif isinstance(val, int) or (isinstance(val, float) and val == int(val) and abs(val) < 10000):\n        return str(int(val))\n    elif abs(val) < 0.0001 and val != 0:\n        return f'{val:.6f}'\n    elif abs(val) < 0.01 and val != 0:\n        return f'{val:.4f}'\n    elif abs(val) < 100:\n        return f'{val:.2f}'\n    elif abs(val) < 100000:\n        return f'{val:,.2f}'\n    else:\n        return f'{val:,.0f}'\n\n\ndef get_cell_class(val, col_type=None, header=''):\n    \"\"\"Get CSS class for conditional formatting.\"\"\"\n    classes = []\n    if val is None:\n        return ''\n\n    fval = to_float(val)\n    if fval is None:\n        return ''\n\n    h = str(header).lower()\n\n    # Detect change/delta columns\n    is_change = any(kw in h for kw in ['变化', '较上周', '较上月', '较上年', 'bp'])\n    is_return = any(kw in h for kw in ['年化', '收益率'])\n\n    if is_change:\n        if fval > 0:\n            classes.append('val-positive')\n        elif fval < 0:\n            classes.append('val-negative')\n\n    if is_return and col_type == 'percent':\n        if fval < 0:\n            classes.append('val-negative')\n\n    # Heatmap intensity for change columns\n    if is_change and fval != 0:\n        if col_type == 'percent':\n            intensity = min(abs(fval) * 20, 1)  # 5% decimal = max intensity\n        elif col_type == 'percent_raw':\n            intensity = min(abs(fval) / 5, 1)  # 5% = max intensity\n        elif 'bp' in h:\n            intensity = min(abs(fval) / 50, 1)  # 50bp = max intensity\n        else:\n            intensity = min(abs(fval) / 20, 1)  # 20 units = max intensity\n        level = min(int(intensity * 5) + 1, 5)\n        if fval > 0:\n            classes.append(f'heat-pos-{level}')\n        else:\n            classes.append(f'heat-neg-{level}')\n\n    return ' '.join(classes)\n\n\ndef parse_merged_cells(merged_list):\n    \"\"\"Parse merged cell ranges into a dict of (row,col) -> (rowspan, colspan).\"\"\"\n    merges = {}\n    skip = set()\n\n    for m in merged_list:\n        match = re.match(r'([A-Z]+)(\\d+):([A-Z]+)(\\d+)', m)\n        if not match:\n            continue\n        c1 = col_letter_to_num(match.group(1))\n        r1 = int(match.group(2))\n        c2 = col_letter_to_num(match.group(3))\n        r2 = int(match.group(4))\n\n        rowspan = r2 - r1 + 1\n        colspan = c2 - c1 + 1\n        merges[(r1, c1)] = (rowspan, colspan)\n\n        for r in range(r1, r2 + 1):\n            for c in range(c1, c2 + 1):\n                if (r, c) != (r1, c1):\n                    skip.add((r, c))\n\n    return merges, skip\n\n\ndef col_letter_to_num(letters):\n    \"\"\"Convert column letter(s) to number (A=1, B=2, ..., AA=27).\"\"\"\n    num = 0\n    for ch in letters:\n        num = num * 26 + (ord(ch) - ord('A') + 1)\n    return num\n\n\n# ─── Section Definitions ───\n# Each section maps to one or more sheets from the output file\n\nSECTIONS = [\n    {\n        'id': 'overview',\n        'title': '报告概览',\n        'icon': '&#9670;',\n        'sheets': ['总结文字'],\n        'type': 'overview'\n    },\n    {\n        'id': 'channel-aum',\n        'title': '1. 渠道代销规模',\n        'icon': '&#9632;',\n        'sheets': ['1、分渠道余额', '渠道明细'],\n        'type': 'tables'\n    },\n    {\n        'id': 'product-scale',\n        'title': '2. 产品规模',\n        'icon': '&#9632;',\n        'sheets': ['2、产品规模', '不同形态产品规模和数量', '13.不同周期产品规模', '14.狭义客户周期和最短持有期的产品规模跟踪'],\n        'type': 'tables'\n    },\n    {\n        'id': 'scale-changes',\n        'title': '3. 产品规模变化',\n        'icon': '&#9632;',\n        'sheets': ['3、本月定开或客户周期产品规模变化'],\n        'type': 'tables'\n    },\n    {\n        'id': 'new-products',\n        'title': '4. 新发/待售产品',\n        'icon': '&#9632;',\n        'sheets': ['本周新发产品', '待售产品'],\n        'type': 'tables'\n    },\n    {\n        'id': 'pm-metrics',\n        'title': '5. 投资经理维度',\n        'icon': '&#9632;',\n        'sheets': ['投资经理维度产品规模和数量'],\n        'type': 'tables'\n    },\n    {\n        'id': 'maturity',\n        'title': '6. 产品到期情况',\n        'icon': '&#9670;',\n        'sheets': ['10.未来全年产品到期情况', '10.未来全年产品到期情况-定开', '10.下周到期产品清单'],\n        'type': 'tables'\n    },\n    {\n        'id': 'break-even',\n        'title': '7. 破净情况',\n        'icon': '&#9670;',\n        'sheets': ['破净结果'],\n        'type': 'tables'\n    },\n    {\n        'id': 'market-index',\n        'title': '8. 市场指数收益',\n        'icon': '&#9670;',\n        'sheets': ['15.市场指数收益'],\n        'type': 'tables'\n    },\n    {\n        'id': 'series-perf',\n        'title': '9. 系列产品业绩',\n        'icon': '&#9670;',\n        'sheets': ['系列产品业绩-费后加权', '系列产品业绩-费后平均', '系列产品业绩-费前加权', '系列产品业绩-费前平均'],\n        'type': 'tabs'\n    },\n    {\n        'id': 'min-hold-perf',\n        'title': '10. 最短持有期业绩',\n        'icon': '&#9670;',\n        'sheets': ['5.2 最短持有期产品业绩表现1', '5.2 最短持有期产品业绩表现2'],\n        'type': 'tables'\n    },\n    {\n        'id': 'underperform',\n        'title': '11. 不达基准清单',\n        'icon': '&#9888;',\n        'sheets': ['招商在售产品不达基准', '封闭及定开产品100日内不大业绩产品清单', '合享及悦动稳享临近到期预测不达标产品清单'],\n        'type': 'tables'\n    },\n    {\n        'id': 'high-vol',\n        'title': '12. 高波动产品',\n        'icon': '&#9888;',\n        'sheets': ['12.周净值高波动产品清单'],\n        'type': 'tables'\n    },\n    {\n        'id': 'asset-alloc',\n        'title': '13. 资产大表',\n        'icon': '&#9679;',\n        'sheets': ['8.资产大表'],\n        'type': 'tables'\n    },\n    {\n        'id': 'fee-income',\n        'title': '14. 中收监控',\n        'icon': '&#9679;',\n        'sheets': ['9.中收监控'],\n        'type': 'tables'\n    },\n    {\n        'id': 'public-strategy',\n        'title': '15. 公共策略持仓',\n        'icon': '&#9679;',\n        'sheets': ['公共策略持仓概况'],\n        'type': 'tables'\n    },\n    {\n        'id': 'xinghe',\n        'title': '16. 兴合产品持仓',\n        'icon': '&#9679;',\n        'sheets': ['11.兴合产品持仓明细'],\n        'type': 'tables'\n    },\n    {\n        'id': 'bond-holdings',\n        'title': '17. 可转债/量化持仓',\n        'icon': '&#9679;',\n        'sheets': ['11.1 可转债专户持仓明细', '11.2量化和可转债持仓明细'],\n        'type': 'tables'\n    },\n    {\n        'id': 'outsource',\n        'title': '18. 委外专户配置',\n        'icon': '&#9679;',\n        'sheets': ['11.2.1其他委外专户金额配置情况', '11.2.2其他委外专户配置占比情况', '11.2.3其他委外专户配置占比情况-除以系列规模'],\n        'type': 'tables'\n    },\n    {\n        'id': 'derivatives',\n        'title': '19. 衍生品/非标持仓',\n        'icon': '&#9679;',\n        'sheets': ['11.4其他衍生品专户持仓明细', '11.5全部衍生品专户持仓占比', '11.6非标持仓占比'],\n        'type': 'tables'\n    },\n    {\n        'id': 'gold-equity',\n        'title': '20. 黄金/权益持仓',\n        'icon': '&#9679;',\n        'sheets': ['黄金持仓', '权益专户持仓'],\n        'type': 'tables'\n    },\n]\n\n# ─── Compute Overview Stats ───\ndef compute_overview_stats():\n    stats = {}\n\n    # Total AUM from 产品规模 - SUM all rows (not last row)\n    ps = output_sheets.get('2、产品规模', {})\n    if ps.get('data'):\n        total_aum = 0\n        total_count = 0\n        total_aum_m = 0\n        total_aum_y = 0\n        for row in ps['data'][1:]:  # skip header\n            v = to_float(row[2]) if len(row) > 2 else None\n            if v is not None:\n                total_aum += v\n            v = to_float(row[5]) if len(row) > 5 else None\n            if v is not None:\n                total_count += v\n            v = to_float(row[3]) if len(row) > 3 else None\n            if v is not None:\n                total_aum_m += v\n            v = to_float(row[4]) if len(row) > 4 else None\n            if v is not None:\n                total_aum_y += v\n        stats['total_aum'] = total_aum\n        stats['total_count'] = total_count\n        stats['aum_vs_month'] = total_aum_m\n        stats['aum_vs_year'] = total_aum_y\n\n    # Summary text\n    text_sheet = output_sheets.get('总结文字', {})\n    if text_sheet.get('data'):\n        for row in text_sheet['data'][1:]:\n            if len(row) >= 2 and row[0] and row[1]:\n                key = str(row[0])\n                val = str(row[1])\n                if '规模' in key:\n                    stats['guimo_text'] = val\n                elif '中收' in key:\n                    stats['zhongshou_text'] = val\n                elif '到期' in key:\n                    stats['daoqi_text'] = val\n\n    # Break-even status\n    bp_sheet = output_sheets.get('破净结果', {})\n    if bp_sheet.get('data'):\n        data_rows = [r for r in bp_sheet['data'][1:] if any(v is not None for v in r)]\n        stats['broken_count'] = len(data_rows)\n\n    # Underperforming count\n    up_sheet = output_sheets.get('招商在售产品不达基准', {})\n    if up_sheet.get('data'):\n        stats['underperform_count'] = len(up_sheet['data']) - 1  # minus header\n\n    # High volatility count\n    hv_sheet = output_sheets.get('12.周净值高波动产品清单', {})\n    if hv_sheet.get('data'):\n        stats['high_vol_count'] = len(hv_sheet['data']) - 1\n\n    return stats\n\n\n# ─── Generate HTML Table ───\ndef generate_table_html(sheet_name, sheet_data, table_id=''):\n    \"\"\"Generate an HTML table from sheet data with formatting.\"\"\"\n    if not sheet_data or not sheet_data.get('data'):\n        return f'<div class=\"empty-state\">暂无数据</div>'\n\n    data = sheet_data['data']\n    merged_cells = sheet_data.get('merged_cells', [])\n    merges, skip_cells = parse_merged_cells(merged_cells)\n    col_types = detect_column_types(sheet_data)\n\n    rows_html = []\n    num_cols = sheet_data.get('col_count', 0)\n\n    for ri, row in enumerate(data):\n        is_header = ri == 0\n        # Check if this is also a sub-header (row 1 or 2 for multi-header tables)\n        # A sub-header row should contain mostly text/None values, not numbers\n        is_subheader = False\n        if ri in (1, 2) and ri < len(data):\n            row_vals = [v for v in row if v is not None]\n            numeric_count = sum(1 for v in row_vals if is_numeric(v))\n            text_count = len(row_vals) - numeric_count\n            # Only treat as sub-header if mostly text (at least 60% non-numeric)\n            if row_vals and text_count > numeric_count and text_count >= 2:\n                is_subheader = True\n\n        cells_html = []\n        for ci in range(min(len(row), num_cols)):\n            # Check if this cell should be skipped (part of a merge)\n            if (ri + 1, ci + 1) in skip_cells:\n                continue\n\n            val = row[ci]\n            merge_info = merges.get((ri + 1, ci + 1))\n\n            tag = 'th' if is_header or (is_subheader and ri < 3) else 'td'\n\n            # Get header for this column (from first row)\n            col_header = str(data[0][ci] or '') if ci < len(data[0]) else ''\n            col_type = col_types.get(ci)\n\n            # Format value\n            if is_header or (is_subheader and ri < 3):\n                display = escape_html(str(val)) if val is not None else ''\n            else:\n                display = format_cell_value(val, col_type)\n\n            # Build attributes\n            attrs = []\n            css_classes = []\n\n            if merge_info:\n                rs, cs = merge_info\n                if rs > 1:\n                    attrs.append(f'rowspan=\"{rs}\"')\n                if cs > 1:\n                    attrs.append(f'colspan=\"{cs}\"')\n\n            if not is_header and not is_subheader:\n                cell_class = get_cell_class(val, col_type, col_header)\n                if cell_class:\n                    css_classes.append(cell_class)\n\n                # Right-align numbers\n                fval = to_float(val)\n                if fval is not None:\n                    css_classes.append('num-cell')\n\n            if css_classes:\n                attrs.append(f'class=\"{\" \".join(css_classes)}\"')\n\n            attrs_str = ' ' + ' '.join(attrs) if attrs else ''\n            cells_html.append(f'<{tag}{attrs_str}>{display}</{tag}>')\n\n        row_class = 'header-row' if is_header else ('subheader-row' if is_subheader and ri < 3 else '')\n        # Highlight total/summary rows\n        if not is_header and row:\n            first_val = str(row[0] or '').strip()\n            if first_val in ('合计', '总计', '总合计', '-', '总规模'):\n                row_class = 'total-row'\n            # Also check if any cell contains 合计\n            if any('合计' in str(v or '') for v in row[:3]):\n                row_class = 'total-row'\n\n        row_class_attr = f' class=\"{row_class}\"' if row_class else ''\n        rows_html.append(f'<tr{row_class_attr}>{\"\".join(cells_html)}</tr>')\n\n    tid = f' id=\"{table_id}\"' if table_id else ''\n    return f'''<div class=\"table-wrapper\">\n<table{tid}>\n{\"\".join(rows_html)}\n</table>\n</div>'''\n\n\n# ─── Generate Section HTML ───\ndef generate_section_html(section):\n    parts = []\n\n    if section['type'] == 'overview':\n        stats = compute_overview_stats()\n        parts.append(generate_overview_html(stats))\n\n    elif section['type'] == 'tabs':\n        # Tabbed interface for multiple variants of the same data\n        tab_names = []\n        tab_contents = []\n        for i, sn in enumerate(section['sheets']):\n            sd = output_sheets.get(sn)\n            if not sd:\n                continue\n            # Create short tab name\n            short = sn.replace('系列产品业绩-', '')\n            tab_names.append(short)\n            active = 'active' if i == 0 else ''\n            tab_contents.append(f'<div class=\"tab-content {active}\" data-tab=\"{section[\"id\"]}-tab-{i}\">{generate_table_html(sn, sd)}</div>')\n\n        tabs_html = ''.join(\n            f'<button class=\"tab-btn {\"active\" if i == 0 else \"\"}\" onclick=\"switchTab(\\'{section[\"id\"]}\\', {i})\" data-tabgroup=\"{section[\"id\"]}\" data-tabidx=\"{i}\">{tn}</button>'\n            for i, tn in enumerate(tab_names)\n        )\n        parts.append(f'<div class=\"tabs-container\"><div class=\"tab-buttons\">{tabs_html}</div>{\"\".join(tab_contents)}</div>')\n\n    elif section['type'] == 'tables':\n        for sn in section['sheets']:\n            sd = output_sheets.get(sn)\n            if not sd:\n                continue\n            subtitle = sn\n            parts.append(f'<h3 class=\"sheet-title\">{escape_html(subtitle)}</h3>')\n            parts.append(generate_table_html(sn, sd))\n\n    return '\\n'.join(parts)\n\n\ndef generate_overview_html(stats):\n    \"\"\"Generate the overview/summary section.\"\"\"\n    aum = stats.get('total_aum')\n    aum_str = f'{aum:,.0f}亿' if aum and aum > 100 else (f'{aum:,.2f}亿' if aum else 'N/A')\n    count = stats.get('total_count')\n    count_str = f'{int(count)}只' if count else 'N/A'\n    aum_m = stats.get('aum_vs_month')\n    aum_m_str = f'{aum_m:+.2f}亿' if aum_m is not None else 'N/A'\n    aum_m_class = 'stat-positive' if aum_m and aum_m > 0 else ('stat-negative' if aum_m and aum_m < 0 else '')\n    aum_y = stats.get('aum_vs_year')\n    aum_y_str = f'{aum_y:+.2f}亿' if aum_y is not None else 'N/A'\n    aum_y_class = 'stat-positive' if aum_y and aum_y > 0 else ('stat-negative' if aum_y and aum_y < 0 else '')\n\n    broken = stats.get('broken_count', 0)\n    broken_class = 'stat-alert' if broken > 0 else 'stat-ok'\n    broken_str = f'{broken}只' if broken > 0 else '无'\n\n    underperf = stats.get('underperform_count', 0)\n    high_vol = stats.get('high_vol_count', 0)\n\n    # Summary text cards\n    text_cards = ''\n    for key, label in [('guimo_text', '规模概况'), ('zhongshou_text', '中收概况'), ('daoqi_text', '到期概况')]:\n        text = stats.get(key, '')\n        if text:\n            text_display = escape_html(text).replace('\\n', '<br>')\n            text_cards += f'''<div class=\"text-card\">\n<div class=\"text-card-label\">{label}</div>\n<div class=\"text-card-content\">{text_display}</div>\n</div>'''\n\n    # Build mini AUM bar chart from 产品规模 data\n    ps = output_sheets.get('2、产品规模', {})\n    bar_items = []\n    if ps.get('data'):\n        max_aum = 0\n        for row in ps['data'][1:]:\n            v = to_float(row[2]) if len(row) > 2 else None\n            if v and v > max_aum:\n                max_aum = v\n        for row in ps['data'][1:]:\n            name = str(row[1] or '')\n            v = to_float(row[2]) if len(row) > 2 else 0\n            chg = to_float(row[3]) if len(row) > 3 else 0\n            if v and name:\n                pct = (v / max_aum * 100) if max_aum > 0 else 0\n                color = 'var(--positive)' if chg and chg > 0 else ('var(--negative)' if chg and chg < 0 else 'var(--accent-blue)')\n                bar_items.append(f'''<div class=\"bar-row\">\n  <div class=\"bar-label\" title=\"{escape_html(name)}\">{escape_html(name[:8])}</div>\n  <div class=\"bar-track\"><div class=\"bar-fill\" style=\"width:{pct:.1f}%;background:{color}\"></div></div>\n  <div class=\"bar-value\">{v:.0f}</div>\n</div>''')\n\n    bars_html = '\\n'.join(bar_items) if bar_items else ''\n\n    return f'''\n<div class=\"overview-grid\">\n  <div class=\"stat-card stat-primary\">\n    <div class=\"stat-label\">管理规模</div>\n    <div class=\"stat-value\">{aum_str}</div>\n    <div class=\"stat-sub\">\n      <span class=\"{aum_m_class}\">较上月 {aum_m_str}</span>\n      <span class=\"{aum_y_class}\">较年初 {aum_y_str}</span>\n    </div>\n  </div>\n  <div class=\"stat-card\">\n    <div class=\"stat-label\">产品数量</div>\n    <div class=\"stat-value\">{count_str}</div>\n  </div>\n  <div class=\"stat-card {broken_class}\">\n    <div class=\"stat-label\">破净产品</div>\n    <div class=\"stat-value\">{broken_str}</div>\n  </div>\n  <div class=\"stat-card {\"stat-alert\" if underperf > 3 else \"\"}\">\n    <div class=\"stat-label\">不达基准</div>\n    <div class=\"stat-value\">{underperf}只</div>\n  </div>\n  <div class=\"stat-card {\"stat-alert\" if high_vol > 20 else \"\"}\">\n    <div class=\"stat-label\">高波动产品</div>\n    <div class=\"stat-value\">{high_vol}只</div>\n  </div>\n</div>\n<div class=\"overview-grid\" style=\"grid-template-columns: 1fr 1fr;\">\n  <div class=\"stat-card\" style=\"padding:14px 18px;\">\n    <div class=\"stat-label\" style=\"margin-bottom:10px;\">各系列规模分布 (亿)</div>\n    <div class=\"bar-chart\">{bars_html}</div>\n  </div>\n  <div class=\"stat-card\" style=\"padding:14px 18px;\">\n    <div class=\"stat-label\" style=\"margin-bottom:6px;\">AI 摘要</div>\n    <div class=\"text-cards-inline\">\n{text_cards}\n    </div>\n  </div>\n</div>\n'''\n\n\n# ─── CSS Styles ───\nCSS = '''\n@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Source+Han+Sans+SC:wght@300;400;500;700&display=swap');\n\n:root {\n  --bg-primary: #050a18;\n  --bg-secondary: #0c1425;\n  --bg-card: #111c32;\n  --bg-card-hover: #162040;\n  --bg-table-header: #0f1b33;\n  --bg-table-row-alt: #0a1226;\n  --bg-sidebar: #080e1f;\n  --bg-sidebar-active: #1a2744;\n\n  --text-primary: #e2e8f0;\n  --text-secondary: #94a3b8;\n  --text-muted: #64748b;\n  --text-header: #f1f5f9;\n\n  --accent-gold: #f59e0b;\n  --accent-blue: #3b82f6;\n  --accent-cyan: #06b6d4;\n\n  --positive: #10b981;\n  --positive-bg: rgba(16, 185, 129, 0.08);\n  --negative: #ef4444;\n  --negative-bg: rgba(239, 68, 68, 0.08);\n  --alert: #f97316;\n  --alert-bg: rgba(249, 115, 22, 0.08);\n\n  --border: #1e293b;\n  --border-light: #1a2540;\n\n  --sidebar-width: 260px;\n  --header-height: 56px;\n\n  --heat-pos-1: rgba(16, 185, 129, 0.1);\n  --heat-pos-2: rgba(16, 185, 129, 0.2);\n  --heat-pos-3: rgba(16, 185, 129, 0.3);\n  --heat-pos-4: rgba(16, 185, 129, 0.45);\n  --heat-pos-5: rgba(16, 185, 129, 0.6);\n  --heat-neg-1: rgba(239, 68, 68, 0.1);\n  --heat-neg-2: rgba(239, 68, 68, 0.2);\n  --heat-neg-3: rgba(239, 68, 68, 0.3);\n  --heat-neg-4: rgba(239, 68, 68, 0.45);\n  --heat-neg-5: rgba(239, 68, 68, 0.6);\n}\n\n* { box-sizing: border-box; margin: 0; padding: 0; }\n\nhtml {\n  font-size: 13px;\n  scroll-behavior: smooth;\n}\n\nbody {\n  font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", \"Noto Sans SC\", sans-serif;\n  background: var(--bg-primary);\n  color: var(--text-primary);\n  line-height: 1.5;\n  overflow-x: hidden;\n}\n\n/* ─── Header ─── */\n.top-header {\n  position: fixed;\n  top: 0;\n  left: 0;\n  right: 0;\n  height: var(--header-height);\n  background: linear-gradient(135deg, #0a1628 0%, #0f1d35 100%);\n  border-bottom: 1px solid var(--border);\n  display: flex;\n  align-items: center;\n  padding: 0 24px;\n  z-index: 100;\n  backdrop-filter: blur(12px);\n}\n\n.header-brand {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n}\n\n.header-logo {\n  width: 32px;\n  height: 32px;\n  background: linear-gradient(135deg, var(--accent-gold), #d97706);\n  border-radius: 8px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  font-weight: 700;\n  font-size: 14px;\n  color: #0a0f1c;\n}\n\n.header-title {\n  font-family: \"Noto Serif SC\", serif;\n  font-size: 16px;\n  font-weight: 700;\n  color: var(--text-header);\n  letter-spacing: 1px;\n}\n\n.header-date {\n  margin-left: auto;\n  font-size: 12px;\n  color: var(--text-secondary);\n  background: var(--bg-card);\n  padding: 4px 12px;\n  border-radius: 4px;\n  border: 1px solid var(--border);\n  font-variant-numeric: tabular-nums;\n}\n\n/* ─── Sidebar ─── */\n.sidebar {\n  position: fixed;\n  top: var(--header-height);\n  left: 0;\n  bottom: 0;\n  width: var(--sidebar-width);\n  background: var(--bg-sidebar);\n  border-right: 1px solid var(--border);\n  overflow-y: auto;\n  padding: 12px 0;\n  z-index: 90;\n}\n\n.sidebar::-webkit-scrollbar { width: 4px; }\n.sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }\n\n.sidebar-section {\n  padding: 4px 0;\n}\n\n.sidebar-group-label {\n  font-size: 10px;\n  font-weight: 600;\n  color: var(--text-muted);\n  text-transform: uppercase;\n  letter-spacing: 1.5px;\n  padding: 12px 20px 4px;\n}\n\n.nav-item {\n  display: flex;\n  align-items: center;\n  gap: 10px;\n  padding: 8px 20px;\n  color: var(--text-secondary);\n  text-decoration: none;\n  font-size: 12.5px;\n  cursor: pointer;\n  transition: all 0.15s ease;\n  border-left: 3px solid transparent;\n}\n\n.nav-item:hover {\n  color: var(--text-primary);\n  background: var(--bg-card);\n}\n\n.nav-item.active {\n  color: var(--accent-gold);\n  background: var(--bg-sidebar-active);\n  border-left-color: var(--accent-gold);\n}\n\n.nav-icon {\n  font-size: 8px;\n  opacity: 0.6;\n  width: 14px;\n  text-align: center;\n}\n\n/* ─── Main Content ─── */\n.main-content {\n  margin-left: var(--sidebar-width);\n  margin-top: var(--header-height);\n  padding: 24px 28px;\n  min-height: calc(100vh - var(--header-height));\n}\n\n.section {\n  margin-bottom: 36px;\n  scroll-margin-top: calc(var(--header-height) + 20px);\n}\n\n.section-header {\n  font-family: \"Noto Serif SC\", serif;\n  font-size: 18px;\n  font-weight: 700;\n  color: var(--text-header);\n  margin-bottom: 16px;\n  padding-bottom: 10px;\n  border-bottom: 2px solid var(--accent-gold);\n  display: flex;\n  align-items: center;\n  gap: 10px;\n}\n\n.section-header::before {\n  content: '';\n  width: 4px;\n  height: 20px;\n  background: var(--accent-gold);\n  border-radius: 2px;\n}\n\n.sheet-title {\n  font-size: 13px;\n  font-weight: 600;\n  color: var(--accent-cyan);\n  margin: 16px 0 8px;\n  padding-left: 12px;\n  border-left: 2px solid var(--accent-cyan);\n}\n\n/* ─── Overview Cards ─── */\n.overview-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n  gap: 14px;\n  margin-bottom: 20px;\n}\n\n.stat-card {\n  background: var(--bg-card);\n  border: 1px solid var(--border);\n  border-radius: 10px;\n  padding: 16px 18px;\n  transition: transform 0.2s ease, box-shadow 0.2s ease;\n}\n\n.stat-card:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n}\n\n.stat-card.stat-primary {\n  border-color: var(--accent-gold);\n  background: linear-gradient(135deg, rgba(245, 158, 11, 0.08), var(--bg-card));\n}\n\n.stat-card.stat-alert {\n  border-color: var(--negative);\n  background: linear-gradient(135deg, var(--negative-bg), var(--bg-card));\n}\n\n.stat-card.stat-ok {\n  border-color: var(--positive);\n  background: linear-gradient(135deg, var(--positive-bg), var(--bg-card));\n}\n\n.stat-label {\n  font-size: 11px;\n  color: var(--text-muted);\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  margin-bottom: 6px;\n}\n\n.stat-value {\n  font-size: 22px;\n  font-weight: 700;\n  color: var(--text-header);\n  font-variant-numeric: tabular-nums;\n}\n\n.stat-sub {\n  margin-top: 8px;\n  display: flex;\n  gap: 14px;\n  font-size: 11px;\n}\n\n.stat-positive { color: var(--positive); }\n.stat-negative { color: var(--negative); }\n\n.text-cards-grid {\n  display: grid;\n  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n  gap: 14px;\n  margin-top: 14px;\n}\n\n.text-card {\n  background: var(--bg-card);\n  border: 1px solid var(--border);\n  border-radius: 10px;\n  padding: 14px 18px;\n}\n\n.text-card-label {\n  font-size: 11px;\n  font-weight: 600;\n  color: var(--accent-cyan);\n  text-transform: uppercase;\n  letter-spacing: 0.5px;\n  margin-bottom: 8px;\n}\n\n.text-card-content {\n  font-size: 12.5px;\n  line-height: 1.7;\n  color: var(--text-secondary);\n}\n\n/* ─── Bar Chart ─── */\n.bar-chart {\n  display: flex;\n  flex-direction: column;\n  gap: 4px;\n}\n\n.bar-row {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n  height: 18px;\n}\n\n.bar-label {\n  width: 80px;\n  font-size: 10.5px;\n  color: var(--text-secondary);\n  text-align: right;\n  flex-shrink: 0;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n}\n\n.bar-track {\n  flex: 1;\n  height: 10px;\n  background: var(--bg-secondary);\n  border-radius: 3px;\n  overflow: hidden;\n}\n\n.bar-fill {\n  height: 100%;\n  border-radius: 3px;\n  transition: width 0.6s ease;\n  min-width: 2px;\n}\n\n.bar-value {\n  width: 45px;\n  font-size: 10.5px;\n  color: var(--text-muted);\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n.text-cards-inline {\n  display: flex;\n  flex-direction: column;\n  gap: 8px;\n  max-height: 320px;\n  overflow-y: auto;\n}\n\n.text-cards-inline .text-card {\n  padding: 10px 14px;\n  border-radius: 6px;\n}\n\n/* ─── Tables ─── */\n.table-wrapper {\n  overflow-x: auto;\n  margin: 8px 0 20px;\n  border-radius: 8px;\n  border: 1px solid var(--border);\n  background: var(--bg-card);\n}\n\n.table-wrapper::-webkit-scrollbar { height: 6px; }\n.table-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }\n\ntable {\n  width: 100%;\n  border-collapse: collapse;\n  font-size: 12px;\n  font-variant-numeric: tabular-nums;\n  white-space: nowrap;\n}\n\nth, td {\n  padding: 7px 10px;\n  border-bottom: 1px solid var(--border-light);\n  text-align: left;\n  max-width: 280px;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n\nth {\n  background: var(--bg-table-header);\n  color: var(--text-secondary);\n  font-weight: 600;\n  font-size: 11px;\n  text-transform: none;\n  letter-spacing: 0.3px;\n  position: sticky;\n  top: 0;\n  z-index: 2;\n}\n\ntr:nth-child(even) td {\n  background: var(--bg-table-row-alt);\n}\n\ntr:hover td {\n  background: var(--bg-card-hover) !important;\n}\n\n.num-cell {\n  text-align: right;\n  font-family: \"SF Mono\", \"Cascadia Code\", \"JetBrains Mono\", monospace;\n  font-size: 11.5px;\n}\n\n.val-positive { color: var(--positive); }\n.val-negative { color: var(--negative); }\n\n.total-row td {\n  font-weight: 700;\n  background: rgba(245, 158, 11, 0.06) !important;\n  border-top: 2px solid var(--accent-gold);\n}\n\n/* Merged cell (rowspan) group indicator */\ntd[rowspan] {\n  background: var(--bg-table-header) !important;\n  font-weight: 600;\n  color: var(--accent-cyan);\n  border-right: 2px solid var(--accent-cyan);\n  vertical-align: middle;\n}\n\nth[colspan] {\n  text-align: center;\n  background: linear-gradient(180deg, var(--bg-table-header), rgba(15, 27, 51, 0.9));\n}\n\n/* ─── Heatmap ─── */\n.heat-pos-1 { background: var(--heat-pos-1) !important; }\n.heat-pos-2 { background: var(--heat-pos-2) !important; }\n.heat-pos-3 { background: var(--heat-pos-3) !important; }\n.heat-pos-4 { background: var(--heat-pos-4) !important; }\n.heat-pos-5 { background: var(--heat-pos-5) !important; }\n.heat-neg-1 { background: var(--heat-neg-1) !important; }\n.heat-neg-2 { background: var(--heat-neg-2) !important; }\n.heat-neg-3 { background: var(--heat-neg-3) !important; }\n.heat-neg-4 { background: var(--heat-neg-4) !important; }\n.heat-neg-5 { background: var(--heat-neg-5) !important; }\n\n/* ─── Tabs ─── */\n.tabs-container { margin: 8px 0 20px; }\n\n.tab-buttons {\n  display: flex;\n  gap: 0;\n  margin-bottom: -1px;\n  position: relative;\n  z-index: 3;\n}\n\n.tab-btn {\n  padding: 8px 16px;\n  background: var(--bg-secondary);\n  border: 1px solid var(--border);\n  border-bottom: none;\n  color: var(--text-secondary);\n  font-size: 12px;\n  cursor: pointer;\n  border-radius: 6px 6px 0 0;\n  transition: all 0.15s ease;\n}\n\n.tab-btn:hover { color: var(--text-primary); background: var(--bg-card); }\n.tab-btn.active {\n  color: var(--accent-gold);\n  background: var(--bg-card);\n  border-color: var(--accent-gold);\n  border-bottom: 1px solid var(--bg-card);\n}\n\n.tab-content { display: none; }\n.tab-content.active { display: block; }\n\n/* ─── Empty State ─── */\n.empty-state {\n  padding: 32px;\n  text-align: center;\n  color: var(--text-muted);\n  font-size: 13px;\n  background: var(--bg-card);\n  border-radius: 8px;\n  border: 1px dashed var(--border);\n}\n\n/* ─── Search ─── */\n.search-bar {\n  display: flex;\n  align-items: center;\n  margin-left: 24px;\n}\n\n.search-input {\n  background: var(--bg-card);\n  border: 1px solid var(--border);\n  color: var(--text-primary);\n  padding: 6px 12px;\n  font-size: 12px;\n  border-radius: 6px;\n  width: 200px;\n  outline: none;\n  transition: border-color 0.2s;\n}\n\n.search-input:focus { border-color: var(--accent-blue); }\n.search-input::placeholder { color: var(--text-muted); }\n\n/* ─── Print ─── */\n@media print {\n  .sidebar, .top-header { display: none; }\n  .main-content { margin: 0; padding: 10px; }\n  table { font-size: 9px; }\n  th, td { padding: 3px 5px; }\n  .stat-card { break-inside: avoid; }\n}\n\n/* ─── Animations ─── */\n@keyframes fadeInUp {\n  from { opacity: 0; transform: translateY(12px); }\n  to { opacity: 1; transform: translateY(0); }\n}\n\n.section {\n  animation: fadeInUp 0.4s ease-out;\n}\n\n/* ─── Responsive ─── */\n@media (max-width: 900px) {\n  .sidebar { display: none; }\n  .main-content { margin-left: 0; }\n}\n'''\n\n# ─── JavaScript ───\nJS = '''\n// Tab switching\nfunction switchTab(groupId, tabIdx) {\n  // Deactivate all tabs in group\n  document.querySelectorAll(`[data-tabgroup=\"${groupId}\"]`).forEach(btn => btn.classList.remove('active'));\n  document.querySelectorAll(`[data-tab^=\"${groupId}-tab-\"]`).forEach(c => c.classList.remove('active'));\n\n  // Activate selected\n  document.querySelector(`[data-tabgroup=\"${groupId}\"][data-tabidx=\"${tabIdx}\"]`).classList.add('active');\n  document.querySelector(`[data-tab=\"${groupId}-tab-${tabIdx}\"]`).classList.add('active');\n}\n\n// Sidebar navigation highlighting\nfunction initNavHighlight() {\n  const sections = document.querySelectorAll('.section');\n  const navItems = document.querySelectorAll('.nav-item');\n\n  const observer = new IntersectionObserver((entries) => {\n    entries.forEach(entry => {\n      if (entry.isIntersecting) {\n        const id = entry.target.id;\n        navItems.forEach(item => {\n          item.classList.toggle('active', item.getAttribute('href') === '#' + id);\n        });\n      }\n    });\n  }, { threshold: 0.2, rootMargin: '-80px 0px -60% 0px' });\n\n  sections.forEach(s => observer.observe(s));\n}\n\n// Search functionality\nfunction initSearch() {\n  const input = document.getElementById('global-search');\n  if (!input) return;\n\n  input.addEventListener('input', (e) => {\n    const query = e.target.value.toLowerCase().trim();\n    const allTables = document.querySelectorAll('table');\n\n    allTables.forEach(table => {\n      const rows = table.querySelectorAll('tr:not(.header-row):not(.subheader-row)');\n      rows.forEach(row => {\n        if (!query) {\n          row.style.display = '';\n          return;\n        }\n        const text = row.textContent.toLowerCase();\n        row.style.display = text.includes(query) ? '' : 'none';\n      });\n    });\n  });\n}\n\n// Table sorting\nfunction initTableSort() {\n  document.querySelectorAll('th').forEach(th => {\n    th.style.cursor = 'pointer';\n    th.addEventListener('click', () => {\n      const table = th.closest('table');\n      const idx = Array.from(th.parentNode.children).indexOf(th);\n      const tbody = table.querySelector('tbody') || table;\n      const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => !r.classList.contains('header-row') && !r.classList.contains('subheader-row'));\n\n      // Skip if first few rows are headers\n      const headerRows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.classList.contains('header-row') || r.classList.contains('subheader-row'));\n\n      const isAsc = th.getAttribute('data-sort') !== 'asc';\n      th.setAttribute('data-sort', isAsc ? 'asc' : 'desc');\n\n      rows.sort((a, b) => {\n        const aVal = a.children[idx]?.textContent?.trim() || '';\n        const bVal = b.children[idx]?.textContent?.trim() || '';\n        const aNum = parseFloat(aVal.replace(/[,%亿万只]/g, ''));\n        const bNum = parseFloat(bVal.replace(/[,%亿万只]/g, ''));\n\n        if (!isNaN(aNum) && !isNaN(bNum)) {\n          return isAsc ? aNum - bNum : bNum - aNum;\n        }\n        return isAsc ? aVal.localeCompare(bVal, 'zh') : bVal.localeCompare(aVal, 'zh');\n      });\n\n      // Re-append in order (after header rows)\n      rows.forEach(r => tbody.appendChild(r));\n    });\n  });\n}\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  initNavHighlight();\n  initSearch();\n  initTableSort();\n});\n'''\n\n\n# ─── Assemble HTML ───\ndef generate_html():\n    # Sidebar navigation\n    nav_html = ''\n    groups = {\n        '规模及发行': ['overview', 'channel-aum', 'product-scale', 'scale-changes', 'new-products', 'pm-metrics'],\n        '产品业绩': ['market-index', 'break-even', 'series-perf', 'min-hold-perf', 'underperform', 'high-vol'],\n        '到期情况': ['maturity'],\n        '资产配置': ['asset-alloc', 'fee-income'],\n        '持仓明细': ['public-strategy', 'xinghe', 'bond-holdings', 'outsource', 'derivatives', 'gold-equity'],\n    }\n\n    section_map = {s['id']: s for s in SECTIONS}\n\n    for group_name, section_ids in groups.items():\n        nav_html += f'<div class=\"sidebar-section\"><div class=\"sidebar-group-label\">{group_name}</div>'\n        for sid in section_ids:\n            sec = section_map.get(sid)\n            if sec:\n                nav_html += f'<a class=\"nav-item\" href=\"#{sid}\"><span class=\"nav-icon\">{sec[\"icon\"]}</span>{sec[\"title\"]}</a>'\n        nav_html += '</div>'\n\n    # Main content sections\n    content_html = ''\n    for section in SECTIONS:\n        section_content = generate_section_html(section)\n        content_html += f'''<div class=\"section\" id=\"{section['id']}\">\n<h2 class=\"section-header\">{escape_html(section['title'])}</h2>\n{section_content}\n</div>'''\n\n    # Full HTML\n    html = f'''<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>{REPORT_TITLE} - {REPORT_DATE}</title>\n<style>\n{CSS}\n</style>\n</head>\n<body>\n\n<header class=\"top-header\">\n  <div class=\"header-brand\">\n    <div class=\"header-logo\">XY</div>\n    <div class=\"header-title\">{REPORT_TITLE}</div>\n  </div>\n  <div class=\"search-bar\">\n    <input type=\"text\" id=\"global-search\" class=\"search-input\" placeholder=\"搜索产品/经理/代码...\">\n  </div>\n  <div class=\"header-date\">数据截止 {REPORT_DATE}</div>\n</header>\n\n<nav class=\"sidebar\">\n{nav_html}\n</nav>\n\n<main class=\"main-content\">\n{content_html}\n</main>\n\n<script>\n{JS}\n</script>\n</body>\n</html>'''\n\n    # Add generation footer\n    from datetime import datetime\n    now = datetime.now().strftime('%Y-%m-%d %H:%M')\n    html = html.replace('</main>', f'''\n<footer style=\"text-align:center;padding:24px;color:var(--text-muted);font-size:11px;border-top:1px solid var(--border);margin-top:40px;\">\n  兴银理财多资产投资部 | 数据截止 {REPORT_DATE} | 仪表板生成于 {now}\n</footer>\n</main>''')\n\n    return html\n\n\n# ─── Main ───\nif __name__ == '__main__':\n    print('Generating dashboard HTML...')\n    html = generate_html()\n\n    with open(OUTPUT_HTML, 'w', encoding='utf-8') as f:\n        f.write(html)\n\n    file_size = os.path.getsize(OUTPUT_HTML)\n    print(f'Dashboard generated: {OUTPUT_HTML}')\n    print(f'File size: {file_size:,} bytes ({file_size/1024:.1f} KB)')\n    print(f'Sections: {len(SECTIONS)}')\n    print(f'Total sheets displayed: {sum(len(s[\"sheets\"]) for s in SECTIONS)}')\n"},"sourceToolAssistantUUID":"aca17055-a133-4f3c-b57a-c620988cfe29"}
{"parentUuid":"fd980fa2-fac9-407a-9951-ad45413e80df","isSidechain":true,"userType":"external","cwd":"/private/tmp","sessionId":"785d3a51-0a04-4501-aca2-c87ea3b69707","version":"2.1.37","gitBranch":"main","agentId":"acompact-73e96c","slug":"joyful-soaring-rose","type":"user","message":{"role":"user","content":"Your task is to create a detailed summary of the conversation so far, paying close attention to the user's explicit requests and your previous actions.\nThis summary should be thorough in capturing technical details, code patterns, and architectural decisions that would be essential for continuing development work without losing context.\n\nBefore providing your final summary, wrap your analysis in <analysis> tags to organize your thoughts and ensure you've covered all necessary points. In your analysis process:\n\n1. Chronologically analyze each message and section of the conversation. For each section thoroughly identify:\n   - The user's explicit requests and intents\n   - Your approach to addressing the user's requests\n   - Key decisions, technical concepts and code patterns\n   - Specific details like:\n     - file names\n     - full code snippets\n     - function signatures\n     - file edits\n  - Errors that you ran into and how you fixed them\n  - Pay special attention to specific user feedback that you received, especially if the user told you to do something differently.\n2. Double-check for technical accuracy and completeness, addressing each required element thoroughly.\n\nYour summary should include the following sections:\n\n1. Primary Request and Intent: Capture all of the user's explicit requests and intents in detail\n2. Key Technical Concepts: List all important technical concepts, technologies, and frameworks discussed.\n3. Files and Code Sections: Enumerate specific files and code sections examined, modified, or created. Pay special attention to the most recent messages and include full code snippets where applicable and include a summary of why this file read or edit is important.\n4. Errors and fixes: List all errors that you ran into, and how you fixed them. Pay special attention to specific user feedback that you received, especially if the user told you to do something differently.\n5. Problem Solving: Document problems solved and any ongoing troubleshooting efforts.\n6. All user messages: List ALL user messages that are not tool results. These are critical for understanding the users' feedback and changing intent.\n6. Pending Tasks: Outline any pending tasks that you have explicitly been asked to work on.\n7. Current Work: Describe in detail precisely what was being worked on immediately before this summary request, paying special attention to the most recent messages from both user and assistant. Include file names and code snippets where applicable.\n8. Optional Next Step: List the next step that you will take that is related to the most recent work you were doing. IMPORTANT: ensure that this step is DIRECTLY in line with the user's most recent explicit requests, and the task you were working on immediately before this summary request. If your last task was concluded, then only list next steps if they are explicitly in line with the users request. Do not start on tangential requests or really old requests that were already completed without confirming with the user first.\n                       If there is a next step, include direct quotes from the most recent conversation showing exactly what task you were working on and where you left off. This should be verbatim to ensure there's no drift in task interpretation.\n\nHere's an example of how your output should be structured:\n\n<example>\n<analysis>\n[Your thought process, ensuring all points are covered thoroughly and accurately]\n</analysis>\n\n<summary>\n1. Primary Request and Intent:\n   [Detailed description]\n\n2. Key Technical Concepts:\n   - [Concept 1]\n   - [Concept 2]\n   - [...]\n\n3. Files and Code Sections:\n   - [File Name 1]\n      - [Summary of why this file is important]\n      - [Summary of the changes made to this file, if any]\n      - [Important Code Snippet]\n   - [File Name 2]\n      - [Important Code Snippet]\n   - [...]\n\n4. Errors and fixes:\n    - [Detailed description of error 1]:\n      - [How you fixed the error]\n      - [User feedback on the error if any]\n    - [...]\n\n5. Problem Solving:\n   [Description of solved problems and ongoing troubleshooting]\n\n6. All user messages: \n    - [Detailed non tool use user message]\n    - [...]\n\n7. Pending Tasks:\n   - [Task 1]\n   - [Task 2]\n   - [...]\n\n8. Current Work:\n   [Precise description of current work]\n\n9. Optional Next Step:\n   [Optional Next step to take]\n\n</summary>\n</example>\n\nPlease provide your summary based on the conversation so far, following this structure and ensuring precision and thoroughness in your response. \n\nThere may be additional summarization instructions provided in the included context. If so, remember to follow these instructions when creating the above summary. Examples of instructions include:\n<example>\n## Compact Instructions\nWhen summarizing the conversation focus on typescript code changes and also remember the mistakes you made and how you fixed them.\n</example>\n\n<example>\n# Summary instructions\nWhen you are using compact - please focus on test output and code changes. Include file reads verbatim.\n</example>\n\n\nIMPORTANT: Do NOT use any tools. You MUST respond with ONLY the <summary>...</summary> block as your text output."},"uuid":"5b9f76e0-7ca6-4ec5-9cf3-14c4873d3783","timestamp":"2026-02-09T05:35:26.778Z"}
{"parentUuid":"5b9f76e0-7ca6-4ec5-9cf3-14c4873d3783","isSidechain":true,"userType":"external","cwd":"/private/tmp","sessionId":"785d3a51-0a04-4501-aca2-c87ea3b69707","version":"2.1.37","gitBranch":"main","agentId":"acompact-73e96c","slug":"joyful-soaring-rose","message":{"model":"claude-opus-4-6","id":"msg_01KCTXtGZa4Rvt1Jb3e5uzGx","type":"message","role":"assistant","content":[{"type":"text","text":"<analysis>\nLet me analyze the conversation chronologically:\n\n1. **Context from previous sessions**: The user had a complete weekly report pipeline (Steps 1-5) for generating financial reports. This was summarized at the start of the conversation.\n\n2. **Original request (from previous session)**: Create a web dashboard displaying all data from the weekly report Excel files, replacing the complex Excel-based format. The dashboard was already built in a previous session at `/tmp/generate_weekly_dashboard.py`.\n\n3. **Current session's user request**: The user posted screenshots of the PDF report pages (1-10) showing the exact table formats, and the conversation continued from the previous context where the task was to compare the dashboard against the PDF and fix formatting issues.\n\n4. **The user's explicit request** (from summary): \"参考我的周报pdf的格式，有一些表格缺少合计行，有一些表格的列的顺序和实际展示字段不对，有一些表格的数字格式不对，持仓明细中有部分行数据的格式不对，请统一检查和规范，表格的展示顺序和格式与pdf周报保持一致和美观\"\n\n5. **What I did in this session**:\n   - Read the current dashboard generator script (`/tmp/generate_weekly_dashboard.py`)\n   - Read the PDF report pages 1-10, 11-20, 21-30, 31-40 to catalog all table structures\n   - The user also posted screenshots of PDF pages 1-10 as images\n   - Examined the JSON data structure for key sheets\n   - Created a task to track the work\n   - Wrote a complete updated version of the generator script with fixes for:\n     - Section reordering to match PDF TOC\n     - Number formatting (parentheses for negatives in scale tables)\n     - Computed subtotal/合计 rows for 分渠道余额, 产品规模, 投资经理维度\n     - Sheet-specific percentage formatting (PCT_RAW_SHEETS, PCT_DECIMAL_SHEETS)\n     - Added 合计 column to 分渠道余额\n     - Subtotal row CSS styling\n     - Sidebar grouping matching PDF structure\n     - Table sorting that preserves total/subtotal rows\n\n6. **I did NOT yet run the script** to generate the updated HTML. That's the immediate next step.\n\nLet me catalog all the specific changes made:\n\n**preprocess_sheets()** function added:\n- Adds subtotal rows to 分渠道余额 (中低波稳健产品合计, 中高波市值产品合计, 外币产品合计, 总计)\n- Adds 合计 column to 分渠道余额\n- Adds 合计 row to 产品规模\n- Adds 合计 row to 投资经理维度\n\n**SCALE_INT_SHEETS** set: Sheets that use integer display with parentheses for negatives\n**PCT_RAW_SHEETS** set: Sheets where percentages are already in percentage form (1.87 = 1.87%)\n**PCT_DECIMAL_SHEETS** set: Sheets where percentages are in decimal form (0.0187 = 1.87%)\n\n**format_cell_value()** updated with `use_parens` parameter for parentheses formatting\n\n**detect_column_types()** updated with `sheet_name` parameter for forced overrides\n\n**SECTIONS** reordered to match PDF TOC\n\n**Sidebar groups** changed from 5 groups to 3 matching PDF structure\n\n**CSS** added `.subtotal-row` styling\n\n**JS** table sort now excludes total-row and subtotal-row from sorting, and handles parentheses in values\n</analysis>\n\n<summary>\n1. Primary Request and Intent:\n   - **Original request (previous session)**: Create a web dashboard based on `输出结果20260205.xlsx` that displays ALL table data from the weekly report (both the PDF and VBA workbook), with visual enhancements like heatmaps, highlighting for underperforming products. Use `frontend-design` skill for design optimization.\n   - **Current request (most recent, PENDING)**: Compare the dashboard against the actual PDF report (`多资产投资部产品周报-20260129.pdf`) and fix: (1) missing 合计/subtotal rows, (2) incorrect column order and fields, (3) wrong number formatting, (4) formatting issues in holdings detail rows, (5) ensure table display order matches PDF structure exactly.\n   - User's exact quote: \"参考我的周报pdf的格式，有一些表格缺少合计行，有一些表格的列的顺序和实际展示字段不对，有一些表格的数字格式不对，持仓明细中有部分行数据的格式不对，请统一检查和规范，表格的展示顺序和格式与pdf周报保持一致和美观\"\n\n2. Key Technical Concepts:\n   - Self-contained HTML dashboard generated from Python script reading JSON data\n   - Two data sources: `output_file` (40 sheets, complete data) and `vba_workbook` (68 sheets, many with low fill rates due to unresolved VLOOKUP formulas)\n   - Percentage value detection: two forms - decimal (0.027 → 2.70%) vs already-percentage (1.87 → 1.87%)\n   - Parentheses notation for negative numbers in financial tables: (48) instead of -48\n   - Sheet-specific formatting modes: `SCALE_INT_SHEETS`, `PCT_RAW_SHEETS`, `PCT_DECIMAL_SHEETS`\n   - Data preprocessing: computing subtotal rows and 合计 columns from raw data\n   - CSS heatmap gradient classes for change/delta columns\n   - Merged cell handling via Excel merge range parsing\n   - Tab interface for 4 variants of series performance tables\n   - Section ordering matching PDF table of contents\n\n3. Files and Code Sections:\n   - **`/tmp/generate_weekly_dashboard.py`** (~1450 lines) - Main dashboard generator script, FULLY REWRITTEN in this session\n     - Key changes from original version:\n     - Added `SCALE_INT_SHEETS`, `PCT_RAW_SHEETS`, `PCT_DECIMAL_SHEETS` configuration sets (lines 25-50)\n     - Added `preprocess_sheets()` function (lines 292-398) that computes subtotal rows for 分渠道余额, 产品规模, 投资经理维度\n     - Updated `detect_column_types()` with `sheet_name` parameter for forced column type overrides (lines 93-151)\n     - Updated `format_cell_value()` with `use_parens` parameter for parentheses formatting of negatives (lines 154-216)\n     - Reordered `SECTIONS` list to match PDF TOC (lines 401-549): overview → channel-aum → product-scale → scale-changes → pm-metrics → maturity → break-even → market-index → series-perf → min-hold-perf → underperform → high-vol → asset-alloc → fee-income → public-strategy → xinghe → bond-holdings → outsource → derivatives → gold-equity\n     - Updated sidebar groups to 3 groups matching PDF (lines 1367-1372): \"一、规模及发行\", \"二、产品业绩\", \"三、资产与持仓\"\n     - Added `.subtotal-row` CSS styling (lines 1186-1191)\n     - Updated JS sort to exclude total/subtotal rows and handle parenthesized values (lines 1338-1344)\n     - Updated `generate_table_html()` to pass `sheet_name` to `detect_column_types()` and `use_parens` flag (lines 614-707)\n     - Updated total/subtotal row detection to handle \"XX合计\" subtotal patterns (lines 686-697)\n\n   - **`/tmp/weekly_report_data.json`** (768KB) - Extracted data from both Excel files\n     - Structure: `{\"output_file\": {\"sheet_name\": {...}}, \"vba_workbook\": {...}}`\n     - 40 sheets from output file (complete data), 68 from VBA workbook (many low fill rate)\n\n   - **`/Users/fanshengxia/Desktop/周报V2/输出结果/周报仪表板-20260205.html`** - Generated dashboard output file (to be regenerated)\n\n   - **`/Users/fanshengxia/Desktop/周报V2/输出结果/多资产投资部产品周报-20260129.pdf`** - Reference PDF (40 pages)\n     - Read all 40 pages to catalog exact table structures\n\n   - **Key data structure findings from JSON examination**:\n     - `1、分渠道余额`: 17 rows x 4 cols, headers=[None, None, '保有规模', None], NO subtotals in raw data, NO 合计 column\n     - `2、产品规模`: 15 rows x 8 cols, values like '203.82', '-0.83' (strings), NO 合计 row\n     - `15.市场指数收益`: Values are already percentage form (1.866... = 1.87%), first column has index codes\n     - `系列产品业绩-费前加权`: Values are decimal form (0.02895 = 2.90%)\n     - `投资经理维度产品规模和数量`: Values are strings ('432.32'), with 'nan' for missing data\n\n4. Errors and fixes:\n   - **Previous sessions** (from summary):\n     - Overview stats showing wrong values (18.96亿 instead of 3,471亿): Fixed by summing all rows instead of reading last row\n     - Market index percentages not formatted: Fixed sub-header detection bug\n     - Two forms of percentage values: Added `percent_raw` column type\n   - **This session**: No runtime errors yet - script was rewritten but not yet executed\n\n5. Problem Solving:\n   - Solved: Comprehensive PDF-to-dashboard comparison across all 40 pages\n   - Solved: Data preprocessing to compute missing subtotal rows (分渠道余额, 产品规模, 投资经理维度)\n   - Solved: Added 合计 column computation for 分渠道余额\n   - Solved: Sheet-specific formatting modes to correctly handle different percentage/number formats\n   - Solved: Parentheses notation for negative numbers in financial scale tables\n   - Solved: Section ordering to match PDF TOC structure\n   - Solved: Sidebar navigation grouping to match PDF chapters\n   - Solved: Subtotal row visual distinction (cyan styling) vs total row (gold styling)\n   - Not yet solved: \"三、各系列产品运作情况\" (pages 19-40 of PDF) - these detailed per-product tables come from VBA workbook sheets with low fill rates due to unresolved VLOOKUP formulas, so they cannot be included from current JSON data\n\n6. All user messages:\n   - (From previous session summary) \"我觉得目前的周报流程有点太复杂了...基于我的输出结果20260205.xlsx生成一个网页...完全展示里面每个表格的数据\"\n   - (From previous session summary) \"参考我的周报pdf的格式，有一些表格缺少合计行，有一些表格的列的顺序和实际展示字段不对，有一些表格的数字格式不对，持仓明细中有部分行数据的格式不对，请统一检查和规范，表格的展示顺序和格式与pdf周报保持一致和美观\"\n   - This session: User posted 30 screenshots of the PDF report (pages 1-40) showing exact table formats as visual reference\n\n7. Pending Tasks:\n   - Task #8 (in_progress): \"Fix dashboard tables to match PDF report format\"\n   - Run the updated `/tmp/generate_weekly_dashboard.py` to generate the new HTML\n   - Visually verify the output by opening it in browser or taking screenshots\n   - Compare specific tables against PDF screenshots to confirm fixes are working\n\n8. Current Work:\n   I just finished writing the complete updated `/tmp/generate_weekly_dashboard.py` with all formatting fixes. The script has been written to disk but has NOT been executed yet. The key changes include:\n   - Data preprocessing with computed subtotals\n   - Parentheses formatting for negatives in scale tables\n   - Sheet-specific percentage detection overrides\n   - Reordered sections matching PDF TOC\n   - Updated sidebar groups\n   - New subtotal-row CSS styling\n\n9. Optional Next Step:\n   Run the updated script to generate the new dashboard HTML:\n   ```bash\n   python3 /tmp/generate_weekly_dashboard.py\n   ```\n   Then open the generated HTML to visually verify the fixes, checking specifically:\n   - 分渠道余额 has subtotal rows and 合计 column\n   - 产品规模 shows integers with parentheses for negatives and has 合计 row\n   - 市场指数收益 shows percentages correctly (1.87%)\n   - 系列产品业绩 shows percentages correctly (2.90%)\n   - Section order matches PDF\n   This directly continues the user's request: \"参考我的周报pdf的格式...请统一检查和规范，表格的展示顺序和格式与pdf周报保持一致和美观\"\n</summary>"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":39831,"cache_read_input_tokens":153461,"cache_creation":{"ephemeral_5m_input_tokens":39831,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard","inference_geo":"not_available"}},"requestId":"req_011CXwxBwThscUr9mGAvHGEi","type":"assistant","uuid":"18ccf2e9-e1be-487f-bf5b-ad9dc7e97655","timestamp":"2026-02-09T05:36:45.267Z"}
