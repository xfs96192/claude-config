{"parentUuid":"27564b51-d7ec-4f54-8fdf-41a88f95635a","isSidechain":true,"userType":"external","cwd":"/Users/fanshengxia/Desktop/å‘¨æŠ¥V2","sessionId":"a96899d2-c486-4098-b83a-860801cf2206","version":"2.1.31","gitBranch":"main","agentId":"acompact-6ace98","slug":"sprightly-roaming-patterson","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JeumKyiaFj8VTus1sNA5B6","type":"tool_result","content":"The file /Users/fanshengxia/Desktop/å‘¨æŠ¥V2/å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆ.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1â†’\"\"\"\n     2â†’å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆè„šæœ¬\n     3â†’\n     4â†’è¯¥è„šæœ¬æ˜¯å‘¨æŠ¥ç”Ÿæˆç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£ï¼š\n     5â†’1. åŠ è½½äº§å“å‡€å€¼ã€è¿ä½œæ¦‚è§ˆã€æ¸ é“ä¿æœ‰é‡ç­‰æ•°æ®\n     6â†’2. è®¡ç®—å„ç±»ä¸šç»©æŒ‡æ ‡å’Œç»Ÿè®¡æ•°æ®\n     7â†’3. ç”Ÿæˆå¤šä¸ªåˆ†ææŠ¥è¡¨åˆ°Excelè¾“å‡ºæ–‡ä»¶\n     8â†’4. è°ƒç”¨AIç”Ÿæˆæ€»ç»“æ–‡å­—\n     9â†’\n    10â†’è¾“å‡ºExcelåŒ…å«ä»¥ä¸‹å·¥ä½œè¡¨ï¼š\n    11â†’- 1ã€åˆ†æ¸ é“ä½™é¢\n    12â†’- æ¸ é“æ˜ç»†\n    13â†’- 2ã€äº§å“è§„æ¨¡\n    14â†’- 3ã€æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–\n    15â†’- æœ¬å‘¨æ–°å‘äº§å“\n    16â†’- å¾…å”®äº§å“\n    17â†’- ç³»åˆ—äº§å“ä¸šç»©ï¼ˆè´¹åå¹³å‡/åŠ æƒã€è´¹å‰å¹³å‡/åŠ æƒï¼‰\n    18â†’- 5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°\n    19â†’- æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡\n    20â†’- æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†\n    21â†’- 8.èµ„äº§å¤§è¡¨\n    22â†’- 9.ä¸­æ”¶ç›‘æ§\n    23â†’- 10.äº§å“åˆ°æœŸæƒ…å†µ\n    24â†’- 11.å„ç±»æŒä»“æ˜ç»†\n    25â†’- 12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•\n    26â†’- 13-14.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡\n    27â†’- 15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š\n    28â†’- ç ´å‡€ç»“æœ\n    29â†’- æ€»ç»“æ–‡å­—\n    30â†’\"\"\"\n    31â†’\n    32â†’# ==============================================================================\n    33â†’# ç¬¬ä¸€éƒ¨åˆ†ï¼šå¯¼å…¥ä¾èµ–\n    34â†’# ==============================================================================\n    35â†’\n    36â†’import os\n    37â†’import pandas as pd\n    38â†’import numpy as np\n    39â†’from datetime import datetime, timedelta, date\n    40â†’import copy\n    41â†’import warnings\n    42â†’warnings.filterwarnings(\"ignore\")\n    43â†’\n    44â†’# å¯¼å…¥é¡¹ç›®æ¨¡å—\n    45â†’from config import Config\n    46â†’from config import *  # å‘åå…¼å®¹ï¼Œå¯¼å…¥å¸¸ç”¨å˜é‡\n    47â†’from utils import *\n    48â†’from data_validator import DataValidator, safe_read_excel, validate_critical_paths\n    49â†’from market_data_provider import MarketDataProvider\n    50â†’from load_data import (\n    51â†’    DataLoader,\n    52â†’    map_product_xingtai,\n    53â†’    get_zhaoshang_label,\n    54â†’    get_qudao_label_detail,\n    55â†’    del_Innovation_department\n    56â†’)\n    57â†’from openai import OpenAI\n    58â†’\n    59â†’\n    60â†’# ==============================================================================\n    61â†’# ç¬¬äºŒéƒ¨åˆ†ï¼šåˆå§‹åŒ–\n    62â†’# ==============================================================================\n    63â†’\n    64â†’print(\"=\" * 60)\n    65â†’print(\"ğŸš€ å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆ - åˆå§‹åŒ–\")\n    66â†’print(\"=\" * 60)\n    67â†’\n    68â†’# åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨\n    69â†’data_loader = DataLoader()\n    70â†’\n    71â†’# åˆå§‹åŒ–å¸‚åœºæ•°æ®æä¾›è€…ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰\n    72â†’market_data = MarketDataProvider.get_instance()\n    73â†’\n    74â†’# åˆå§‹åŒ–æ•°æ®éªŒè¯å™¨\n    75â†’validator = DataValidator(log_errors=True)\n    76â†’\n    77â†’# éªŒè¯å…³é”®è·¯å¾„\n    78â†’print(\"\\nğŸ” éªŒè¯å…³é”®æ•°æ®è·¯å¾„...\")\n    79â†’path_validation = validate_critical_paths(Config)\n    80â†’if not path_validation['is_valid']:\n    81â†’    print(\"âŒ å…³é”®è·¯å¾„éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®ç›®å½•ç»“æ„\")\n    82â†’    for error in path_validation['errors']:\n    83â†’        print(f\"   - {error}\")\n    84â†’\n    85â†’\n    86â†’# ==============================================================================\n    87â†’# ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¾…åŠ©å‡½æ•°å®šä¹‰\n    88â†’# ==============================================================================\n    89â†’\n    90â†’def get_wenzi_result(prompt: str) -> str:\n    91â†’    \"\"\"è°ƒç”¨DeepSeek APIç”Ÿæˆæ–‡å­—\"\"\"\n    92â†’    client = OpenAI(api_key=Config.DEEPSEEK_API_KEY, base_url=Config.DEEPSEEK_BASE_URL)\n    93â†’    response = client.chat.completions.create(\n    94â†’        model=Config.DEEPSEEK_MODEL,\n    95â†’        messages=[\n    96â†’            {\"role\": \"system\", \"content\": \"You are a helpful assistant\"},\n    97â†’            {\"role\": \"user\", \"content\": prompt},\n    98â†’        ],\n    99â†’        stream=False\n   100â†’    )\n   101â†’    return response.choices[0].message.content\n   102â†’\n   103â†’\n   104â†’def rank_by_sort(my_df: pd.DataFrame, rank_def: list) -> pd.DataFrame:\n   105â†’    \"\"\"æŒ‰æŒ‡å®šé¡ºåºå¯¹DataFrameç´¢å¼•æ’åº\"\"\"\n   106â†’    my_df = my_df.copy()\n   107â†’    actual = list(my_df.index)\n   108â†’    new_order = [x for x in rank_def if x in actual] + [x for x in actual if x not in rank_def]\n   109â†’    order_map = {val: i for i, val in enumerate(new_order)}\n   110â†’    my_df['__order__'] = my_df.index.map(order_map).fillna(len(new_order))\n   111â†’    my_df = my_df.sort_values('__order__').drop(columns='__order__')\n   112â†’    return my_df\n   113â†’\n   114â†’\n   115â†’def full_category_or_not(df_def: pd.DataFrame, rank_def: list) -> pd.DataFrame:\n   116â†’    \"\"\"åˆ¤æ–­å“ç±»Indexæ˜¯å¦é½å…¨ï¼Œè¡¥å……ç¼ºå¤±çš„å“ç±»\"\"\"\n   117â†’    df_def = df_def.copy()\n   118â†’    for x in rank_def:\n   119â†’        if x not in df_def.index:\n   120â†’            df_def.loc[x, :] = None\n   121â†’    return df_def\n   122â†’\n   123â†’\n   124â†’def manager_in_or_not(s: str, y: list) -> bool:\n   125â†’    \"\"\"åˆ¤æ–­æŠ•èµ„ç»ç†æ˜¯å¦åœ¨æŒ‡å®šåˆ—è¡¨ä¸­\"\"\"\n   126â†’    if pd.isnull(s):\n   127â†’        return False\n   128â†’    for mid_y in y:\n   129â†’        if mid_y in s:\n   130â†’            return True\n   131â†’    return False\n   132â†’\n   133â†’\n   134â†’def clear_manager_name(s: str) -> str:\n   135â†’    \"\"\"æ¸…ç†æŠ•èµ„ç»ç†åç§°ï¼Œåªä¿ç•™éƒ¨é—¨å†…ç»ç†\"\"\"\n   136â†’    first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦', 'æä½³èˆª', \"è‹æ–‡æ´¥\", \"å¤å‡¡ç››\", \"é»„äº¦å°§\"]\n   137â†’    second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ', \"ç½—è°¨æ·±\"]\n   138â†’    third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°', 'å»–ç‚¯è‡£']\n   139â†’    merge_s = []\n   140â†’    for mid_s in s.split(','):\n   141â†’        if mid_s in first + second + third:\n   142â†’            merge_s.append(mid_s)\n   143â†’    return ','.join(merge_s)\n   144â†’\n   145â†’\n   146â†’def adjust_manager_aum(mid_data: pd.DataFrame) -> pd.DataFrame:\n   147â†’    \"\"\"è°ƒæ•´å¤šæŠ•èµ„ç»ç†å…±ç®¡äº§å“çš„è§„æ¨¡åˆ†é…\"\"\"\n   148â†’    final_mid_data = mid_data.copy()\n   149â†’    final_mid_data['åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data['å‡€èµ„äº§(äº¿)']\n   150â†’    final_mid_data['åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1\n   151â†’\n   152â†’    new_rows = []\n   153â†’    for indx in mid_data.index:\n   154â†’        mng_list = mid_data.loc[indx, 'äº§å“ç»ç†'].split(',')\n   155â†’        if len(mng_list) > 1:\n   156â†’            i = 0\n   157â†’            for mng in mng_list:\n   158â†’                if i == 0:\n   159â†’                    final_mid_data.loc[indx, 'äº§å“ç»ç†'] = mng\n   160â†’                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] / 2\n   161â†’                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1 / len(mng_list)\n   162â†’                    i += 1\n   163â†’                else:\n   164â†’                    mid_series = final_mid_data.loc[indx].copy()\n   165â†’                    mid_series['äº§å“ç»ç†'] = mng\n   166â†’                    new_rows.append(pd.DataFrame(mid_series).T)\n   167â†’\n   168â†’    if new_rows:\n   169â†’        final_mid_data = pd.concat([final_mid_data] + new_rows, ignore_index=False)\n   170â†’\n   171â†’    return final_mid_data\n   172â†’\n   173â†’\n   174â†’def get_scaleandnum_by_sort_manager(my_df: pd.DataFrame) -> pd.DataFrame:\n   175â†’    \"\"\"åŒ¹é…å­æ¯åˆ†ç±»å…³ç³»å¹¶è°ƒæ•´æŠ•èµ„ç»ç†\"\"\"\n   176â†’    Parent_sort = data_loader.load_parent_sort(['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»'])\n   177â†’    my_df = my_df.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n   178â†’    my_df['äº§å“ç»ç†'] = my_df['äº§å“ç»ç†'].map(clear_manager_name)\n   179â†’    return adjust_manager_aum(my_df)\n   180â†’\n   181â†’\n   182â†’def get_yejijizhunxiaxian(x: str) -> str:\n   183â†’    \"\"\"è·å–ä¸šç»©åŸºå‡†ä¸‹é™\"\"\"\n   184â†’    if not pd.isnull(x):\n   185â†’        try:\n   186â†’            float(x.split('-')[0][:-1])\n   187â†’            return x.split('-')[0]\n   188â†’        except ValueError:\n   189â†’            return \"\"\n   190â†’    else:\n   191â†’        return x\n   192â†’\n   193â†’\n   194â†’def get_zhouqi_scale(x: int) -> str:\n   195â†’    \"\"\"æ ¹æ®å‘¨æœŸå¤©æ•°è¿”å›å‘¨æœŸåŒºé—´æ ‡ç­¾\"\"\"\n   196â†’    if x < 30 * 7:\n   197â†’        return '<6M'\n   198â†’    elif (x >= 30 * 7) and (x < 13 * 30):\n   199â†’        return '6M-1Y'\n   200â†’    elif x >= 13 * 30:\n   201â†’        return '>1Y'\n   202â†’    else:\n   203â†’        return 'error'\n   204â†’\n   205â†’\n   206â†’def get_zhouqi_scale_v2(x: int) -> str:\n   207â†’    \"\"\"æ ¹æ®å‘¨æœŸå¤©æ•°è¿”å›å‘¨æœŸåŒºé—´æ ‡ç­¾ï¼ˆè¯¦ç»†ç‰ˆï¼‰\"\"\"\n   208â†’    if x == 1:\n   209â†’        return 'æ—¥ç›ˆ'\n   210â†’    elif x < 30:\n   211â†’        return '<1M'\n   212â†’    elif x < 31 * 3:\n   213â†’        return '1M-3M'\n   214â†’    elif x < 31 * 6:\n   215â†’        return '3M-6M'\n   216â†’    elif x < 12 * 31:\n   217â†’        return '6M-1Y'\n   218â†’    elif x >= 12 * 31:\n   219â†’        return '>1Y'\n   220â†’    else:\n   221â†’        return 'error'\n   222â†’\n   223â†’\n   224â†’# ==============================================================================\n   225â†’# ç¬¬å››éƒ¨åˆ†ï¼šåŠ è½½åŸºç¡€æ•°æ®\n   226â†’# ==============================================================================\n   227â†’\n   228â†’print(\"\\n\" + \"=\" * 60)\n   229â†’print(\"ğŸ“Š åŠ è½½åŸºç¡€æ•°æ®...\")\n   230â†’print(\"=\" * 60)\n   231â†’\n   232â†’# 4.1 åŠ è½½äº§å“å‡€å€¼æ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰\n   233â†’print(\"\\n[4.1] åŠ è½½äº§å“å‡€å€¼æ•°æ®...\")\n   234â†’data, data_transposition = data_loader.load_nav_data()\n   235â†’data_transposition.replace(0, np.nan, inplace=True)\n   236â†’\n   237â†’# 4.2 åŠ è½½DAPäº§å“ä¿¡æ¯è¡¨\n   238â†’print(\"\\n[4.2] åŠ è½½DAPäº§å“ä¿¡æ¯è¡¨...\")\n   239â†’Product_information_df_DAP = data_loader.load_product_info_dap()\n   240â†’\n   241â†’# 4.3 åŠ è½½å“ç±»åˆ†ç±»æ•°æ®\n   242â†’print(\"\\n[4.3] åŠ è½½å“ç±»åˆ†ç±»æ•°æ®...\")\n   243â†’classification_df = data_loader.load_classification_df()\n   244â†’classification_ye = classification_df['å¤šèµ„äº§å“ç±»']\n   245â†’\n   246â†’# 4.4 åŠ è½½é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»\n   247â†’print(\"\\n[4.4] åŠ è½½é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»...\")\n   248â†’Parent_sort = data_loader.load_parent_sort(['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»'])\n   249â†’\n   250â†’\n   251â†’# ==============================================================================\n   252â†’# ç¬¬äº”éƒ¨åˆ†ï¼šç”Ÿæˆäº§å“è¿ä½œæ¦‚è§ˆæ•°æ®\n   253â†’# ==============================================================================\n   254â†’\n   255â†’def get_yunzuogailan(yunzuogailan_date: str) -> None:\n   256â†’    \"\"\"\n   257â†’    ç”Ÿæˆå¹¶ä¿å­˜äº§å“è¿ä½œæ¦‚è§ˆæ•°æ®\n   258â†’\n   259â†’    å‚æ•°ï¼š\n   260â†’        yunzuogailan_date: è¿ä½œæ¦‚è§ˆæ—¥æœŸ (YYYYMMDDæ ¼å¼)\n   261â†’    \"\"\"\n   262â†’    print(f\"\\n[5.0] ç”Ÿæˆäº§å“è¿ä½œæ¦‚è§ˆæ•°æ® - {yunzuogailan_date}\")\n   263â†’\n   264â†’    # åŠ è½½åŸå§‹æ•°æ®\n   265â†’    yunzuogailan_before = data_loader.load_yunzuogailan_raw()\n   266â†’    Baoyou_df = data_loader.load_baoyou_data()\n   267â†’\n   268â†’    # åŒ¹é…ç†è´¢äº§å“çš„å­—æ¯ä»£ç \n   269â†’    yunzuogailan_before['æ¯äº§å“ä»£ç '] = yunzuogailan_before['äº§å“ç®€ç§°'].map(\n   270â†’        lambda x: yunzuogailan_before[yunzuogailan_before['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]\n   271â†’    )\n   272â†’    yunzuogailan_before = yunzuogailan_before[~(yunzuogailan_before['å•ä½å‡€å€¼'].isnull())]\n   273â†’\n   274â†’    # è·å–ç¾å…ƒäº§å“æ¸…å•\n   275â†’    Dollar_product_list = list(\n   276â†’        set(Product_information_df_DAP[Product_information_df_DAP['å¸ç§'] == 'ç¾å…ƒ'].index).intersection(\n   277â†’            yunzuogailan_before.index\n   278â†’        )\n   279â†’    )\n   280â†’    yunzuogailan_before['å‡€èµ„äº§(äº¿)'] = yunzuogailan_before.apply(\n   281â†’        lambda x: Baoyou_df.loc[x.name]['ä¿æœ‰è§„æ¨¡'].sum() / 100000000 if x.name in Dollar_product_list else x['å‡€èµ„äº§(äº¿)'],\n   282â†’        axis=1\n   283â†’    )\n   284â†’    yunzuogailan_before = yunzuogailan_before.merge(\n   285â†’        Product_information_df_DAP[['å¸ç§']], left_index=True, right_index=True, how='left'\n   286â†’    )\n   287â†’\n   288â†’    # åŒ¹é…å“ç±»\n   289â†’    yunzuogailan_before['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(\n   290â†’        lambda x: classification_ye[x] if x in classification_ye.index else np.nan\n   291â†’    )\n   292â†’    yunzuogailan_before['äº§å“éƒ¨å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(\n   293â†’        lambda x: classification_df['äº§å“éƒ¨å“ç±»'][x] if x in classification_ye.index else np.nan\n   294â†’    )\n   295â†’\n   296â†’    # åŒ¹é…äº§å“è¿ä½œå‘¨æœŸ\n   297â†’    patern = pd.Series(Product_information_df_DAP.apply(map_product_xingtai, axis=1), name='å½¢æ€')\n   298â†’\n   299â†’    # åˆå¹¶ä¿æœ‰é‡æ•°æ®\n   300â†’    Baoyou_df_merge = Baoyou_df.merge(yunzuogailan_before['æ¯äº§å“ä»£ç '], left_index=True, right_index=True, how='left')\n   301â†’    yunzuogailan_before = yunzuogailan_before.merge(patern, left_index=True, right_index=True, how='left')\n   302â†’    yunzuogailan_before = yunzuogailan_before.merge(\n   303â†’        Product_information_df_DAP[['å‘¨æœŸå¤©æ•°', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°']],\n   304â†’        left_index=True, right_index=True, how='left'\n   305â†’    )\n   306â†’\n   307â†’    # åŒ¹é…æ‹›å•†æ ‡ç­¾\n   308â†’    Zhaoshang_label_df = pd.DataFrame(\n   309â†’        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_zhaoshang_label(set(x['æ¸ é“åç§°']))),\n   310â†’        columns=['æ˜¯å¦æ‹›å•†']\n   311â†’    )\n   312â†’    yunzuogailan_before = yunzuogailan_before.merge(Zhaoshang_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')\n   313â†’\n   314â†’    # åŒ¹é…æ¸ é“æ˜ç»†\n   315â†’    Qudao_label_df = pd.DataFrame(\n   316â†’        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_qudao_label_detail(set(x['æ¸ é“åç§°']))),\n   317â†’        columns=['æ¸ é“æ˜ç»†']\n   318â†’    )\n   319â†’    yunzuogailan_before = yunzuogailan_before.merge(Qudao_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')\n   320â†’\n   321â†’    # ç‰¹æ®Šæ—¥æœŸå¤„ç†\n   322â†’    if yunzuogailan_date in ['20231229', '20231231']:\n   323â†’        yunzuogailan_before['äº§å“ç»ç†'] = yunzuogailan_before.apply(\n   324â†’            lambda x: Product_information_df_DAP.loc[x.name, 'æ¯äº§å“æŠ•èµ„ç»ç†'], axis=1\n   325â†’        )\n   326â†’\n   327â†’    yunzuogailan_before.rename(columns={'ç»„åˆä¹…æœŸ(å¤šèµ„äº§)': 'ç»„åˆä¹…æœŸ'}, inplace=True)\n   328â†’    yunzuogailan_before.rename(columns={'ç»„åˆé™æ€(å¤šèµ„äº§)': 'ç»„åˆé™æ€'}, inplace=True)\n   329â†’\n   330â†’    # åˆå¹¶æ¯å­æ ‡å¿—\n   331â†’    yunzuogailan_before_v2 = yunzuogailan_before.merge(\n   332â†’        Product_information_df_DAP[['æ¯å­æ ‡å¿—']], left_index=True, right_index=True, how='left'\n   333â†’    )\n   334â†’\n   335â†’    # æ ‡è®°ä¸»è¦å±•ç¤ºäº§å“\n   336â†’    yunzuogailan_before_v2['ä¸»è¦å±•ç¤º'] = yunzuogailan_before_v2.apply(\n   337â†’        lambda x: 'æ˜¯' if ((x['æ¯å­æ ‡å¿—'] == 'éæ¯å­äº§å“') or ('(å­1)' in x['äº§å“ç®€ç§°'])) else 'å¦', axis=1\n   338â†’    )\n   339â†’\n   340â†’    # åˆå¹¶æ¯åˆ†ç±»\n   341â†’    Parent_sort_full = pd.read_excel(\n   342â†’        Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),\n   343â†’        sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»',\n   344â†’        index_col=0\n   345â†’    )[['æ¯åˆ†ç±»']]\n   346â†’    Parent_sort_full = Parent_sort_full[~Parent_sort_full.index.duplicated(keep='first')]\n   347â†’\n   348â†’    # é˜²å¾¡æ€§å¤„ç†\n   349â†’    if yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(lambda x: isinstance(x, pd.Series)).any():\n   350â†’        print(\"âš ï¸ æ£€æµ‹åˆ° 'å¤šèµ„äº§å“ç±»' åˆ—ä¸­å­˜åœ¨ Series å€¼ï¼Œå·²è‡ªåŠ¨ä¿®å¤\")\n   351â†’        yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(\n   352â†’            lambda s: s.dropna().iloc[0] if isinstance(s, pd.Series) and len(s.dropna()) > 0 else (\n   353â†’                np.nan if isinstance(s, pd.Series) else s\n   354â†’            )\n   355â†’        )\n   356â†’\n   357â†’    yunzuogailan_before_v2 = yunzuogailan_before_v2.merge(\n   358â†’        Parent_sort_full, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left'\n   359â†’    )\n   360â†’\n   361â†’    # ä¿å­˜æ¯äº§å“ç‰ˆæœ¬\n   362â†’    yunzuogailan_export = yunzuogailan_before_v2[yunzuogailan_before_v2['äº§å“ç®€ç§°'].map(lambda x: '(å­' not in x)]\n   363â†’    keep_col_here = [\n   364â†’        'äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',\n   365â†’        'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'é”€å”®è´¹',\n   366â†’        'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å‘¨æœŸå¤©æ•°', 'æ˜¯å¦æ‹›å•†', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ¯åˆ†ç±»'\n   367â†’    ]\n   368â†’    yunzuogailan_export = yunzuogailan_export[keep_col_here]\n   369â†’    yunzuogailan_export.drop_duplicates().to_excel(Config.get_overview_parent_file(yunzuogailan_date))\n   370â†’\n   371â†’    # ç”Ÿæˆå¸¦å˜åŒ–æŒ‡æ ‡çš„ç‰ˆæœ¬\n   372â†’    yzgl = yunzuogailan_before_v2.drop_duplicates().copy()\n   373â†’    yzgl_lastw = pd.read_excel(Config.get_overview_history_file(lastw), index_col=0)\n   374â†’    yzgl_lastm = pd.read_excel(Config.get_overview_history_file(lastm), index_col=0)\n   375â†’\n   376â†’    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastw['ç»„åˆä¹…æœŸ']\n   377â†’    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['æ æ†'] - yzgl_lastw['æ æ†']\n   378â†’    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastw['æƒç›Šä»“ä½']\n   379â†’    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastm['ç»„åˆä¹…æœŸ']\n   380â†’    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['æ æ†'] - yzgl_lastm['æ æ†']\n   381â†’    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastm['æƒç›Šä»“ä½']\n   382â†’\n   383â†’    mu_col = [\n   384â†’        'äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', '5%æµåŠ¨æ€§å®é™…æŒ‡æ ‡', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ç´¯è®¡å¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'æ æ†',\n   385â†’        'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'è¡ç”Ÿå“ä»“ä½', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥',\n   386â†’        'é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'æ¯äº§å“ä»£ç ', 'å¸ç§', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å½¢æ€', 'å‘¨æœŸå¤©æ•°',\n   387â†’        'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ˜¯å¦æ‹›å•†', 'æ¸ é“æ˜ç»†', 'æ¯å­æ ‡å¿—', 'ä¸»è¦å±•ç¤º', 'æ¯åˆ†ç±»', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨',\n   388â†’        'æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨', 'æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ', 'æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ', 'æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'\n   389â†’    ]\n   390â†’    yzgl[mu_col].to_excel(Config.get_overview_history_file(yunzuogailan_date))\n   391â†’    print(\"   âœ… äº§å“è¿ä½œæ¦‚è§ˆæ•°æ®å·²ä¿å­˜\")\n   392â†’\n   393â†’\n   394â†’# æ‰§è¡Œè¿ä½œæ¦‚è§ˆæ•°æ®ç”Ÿæˆ\n   395â†’get_yunzuogailan(yunzuogailan_date)\n   396â†’\n   397â†’\n   398â†’# ==============================================================================\n   399â†’# ç¬¬å…­éƒ¨åˆ†ï¼šåŠ è½½å¤„ç†åçš„æ•°æ®\n   400â†’# ==============================================================================\n   401â†’\n   402â†’print(\"\\n[6.0] åŠ è½½å¤„ç†åçš„è¿ä½œæ¦‚è§ˆæ•°æ®...\")\n   403â†’yunzuogailan_all = pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)\n   404â†’Channel_df = data_loader.load_channel_data()\n   405â†’date = zhoubao_date\n   406â†’\n   407â†’# åˆ›å»ºè¾“å‡ºExcelå†™å…¥å™¨\n   408â†’writer = pd.ExcelWriter(Config.get_current_output_writer(date))\n   409â†’\n   410â†’# å®šä¹‰å“ç±»æ’åºé¡ºåº\n   411â†’rank_here = [\n   412â†’    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³äº«çŸ­æŒ'),\n   413â†’    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³/çº¯äº«'),\n   414â†’    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¼˜å…ˆè‚¡çŸ­æŒ'),\n   415â†’    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¸°åˆ©/å¢ç›ˆ'),\n   416â†’    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'è¡Œå¤–éæ ‡é©±åŠ¨å‹å›ºæ”¶+'),\n   417â†’    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å’Œç‘BOF'),\n   418â†’    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€'),\n   419â†’    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'é€¸åŠ¨çŸ­æŒ'),\n   420â†’    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'çµåŠ¨çŸ­æŒ'),\n   421â†’    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å…´åŠ¨çŸ­æŒ'),\n   422â†’    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å«æƒå®šå¼€/å°é—­'),\n   423â†’    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'ESGè”å'),\n   424â†’    ('å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),\n   425â†’    ('å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼'),\n   426â†’]\n   427â†’\n   428â†’\n   429â†’# ==============================================================================\n   430â†’# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æ¸ é“åˆ†æ\n   431â†’# ==============================================================================\n   432â†’\n   433â†’print(\"\\n\" + \"=\" * 60)\n   434â†’print(\"ğŸ“ˆ ç”ŸæˆæŠ¥è¡¨...\")\n   435â†’print(\"=\" * 60)\n   436â†’\n   437â†’# ------------------------------------------------------------------------------\n   438â†’# æŠ¥è¡¨1: åˆ†æ¸ é“ä½™é¢\n   439â†’# ------------------------------------------------------------------------------\n   440â†’print(\"\\n[1] ç”ŸæˆæŠ¥è¡¨: 1ã€åˆ†æ¸ é“ä½™é¢...\")\n   441â†’\n   442â†’# åŒ¹é…æ¸ é“æ•°æ®çš„å“ç±»å’Œäº§å“ç»ç†\n   443â†’Channel_df['æ¯äº§å“ä»£ç '] = Channel_df['äº§å“ç®€ç§°'].map(\n   444â†’    lambda x: Channel_df[Channel_df['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]\n   445â†’)\n   446â†’Channel_df['å¤šèµ„äº§å“ç±»'] = Channel_df['æ¯äº§å“ä»£ç '].map(\n   447â†’    lambda x: classification_ye[x] if x in classification_ye.index else np.nan\n   448â†’)\n   449â†’Channel_df = Channel_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')\n   450â†’Channel_df = Channel_df[~pd.isnull(Channel_df['äº§å“ç»ç†'])]\n   451â†’Channel_df = del_Innovation_department(Channel_df)\n   452â†’\n   453â†’# å¤„ç†å­äº§å“æ¸ é“æ•°æ®\n   454â†’Channel_df_subproduct = Channel_df[Channel_df['æ¸ é“åç§°'] != '-']\n   455â†’Channel_df_subproduct['æ¸ é“-è¡Œå†…å¤–'] = Channel_df_subproduct['æ¸ é“åç§°'].map(\n   456â†’    lambda x: 'è¡Œå†…' if x == 'å…´ä¸šé“¶è¡Œ' else 'è¡Œå¤–'\n   457â†’)\n   458â†’Channel_df_subproduct = Channel_df_subproduct.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n   459â†’\n   460â†’# ç”Ÿæˆåˆ†æ¸ é“ä½™é¢è¡¨\n   461â†’Channel_result1 = pd.pivot_table(\n   462â†’    Channel_df_subproduct,\n   463â†’    index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],\n   464â†’    columns='æ¸ é“-è¡Œå†…å¤–',\n   465â†’    values=['ä¿æœ‰è§„æ¨¡'],\n   466â†’    aggfunc=np.sum\n   467â†’) / 100000000\n   468â†’Channel_result1 = rank_by_sort(Channel_result1, rank_here)\n   469â†’\n   470â†’# ------------------------------------------------------------------------------\n   471â†’# æŠ¥è¡¨: æ¸ é“æ˜ç»†\n   472â†’# ------------------------------------------------------------------------------\n   473â†’print(\"[1.1] ç”ŸæˆæŠ¥è¡¨: æ¸ é“æ˜ç»†...\")\n   474â†’\n   475â†’Channel_result2 = pd.pivot_table(\n   476â†’    Channel_df_subproduct,\n   477â†’    index=['æ¸ é“åç§°'],\n   478â†’    columns='æ€»åˆ†ç±»',\n   479â†’    values=['ä¿æœ‰è§„æ¨¡'],\n   480â†’    aggfunc=np.sum\n   481â†’) / 100000000\n   482â†’Channel_result2['åˆè®¡'] = Channel_result2.sum(axis=1)\n   483â†’Channel_result2 = Channel_result2.sort_values('åˆè®¡', ascending=False)\n   484â†’\n   485â†’# è®¡ç®—ç›¸æ¯”ä¸Šæœˆå’Œä¸Šå¹´çš„å˜åŒ–\n   486â†’Channel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šæœˆ', '')] = Channel_result2[('åˆè®¡', '')] - \\\n   487â†’    pd.read_excel(Config.get_output_result_file(lastm), sheet_name='æ¸ é“æ˜ç»†', index_col=0, skiprows=[1, 2])['åˆè®¡']\n   488â†’Channel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šå¹´', '')] = Channel_result2[('åˆè®¡', '')] - \\\n   489â†’    pd.read_excel(Config.get_output_result_file(lasty), sheet_name='æ¸ é“æ˜ç»†', index_col=0, skiprows=[1, 2])['åˆè®¡']\n   490â†’\n   491â†’Channel_result1.to_excel(writer, sheet_name='1ã€åˆ†æ¸ é“ä½™é¢')\n   492â†’Channel_result2.to_excel(writer, sheet_name='æ¸ é“æ˜ç»†')\n   493â†’\n   494â†’\n   495â†’# ==============================================================================\n   496â†’# ç¬¬å…«éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“è§„æ¨¡\n   497â†’# ==============================================================================\n   498â†’\n   499â†’# ------------------------------------------------------------------------------\n   500â†’# æŠ¥è¡¨2: äº§å“è§„æ¨¡\n   501â†’# ------------------------------------------------------------------------------\n   502â†’print(\"\\n[2] ç”ŸæˆæŠ¥è¡¨: 2ã€äº§å“è§„æ¨¡...\")\n   503â†’\n   504â†’now = zhoubao_date\n   505â†’yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\n   506â†’yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))\n   507â†’yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n   508â†’\n   509â†’lastm_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - get_scaleandnum_by_sort(yunzuogailan_lastm)\n   510â†’lastm_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«']\n   511â†’lasty_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - full_category_or_not(\n   512â†’    get_scaleandnum_by_sort(yunzuogailan_lasty), rank_here\n   513â†’).fillna(0)\n   514â†’lasty_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']\n   515â†’\n   516â†’cols = ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']\n   517â†’result_3 = pd.concat([get_scaleandnum_by_sort(yunzuogailan_now), lastm_delta_df, lasty_delta_df], axis=1)[cols]\n   518â†’result_3[['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']] = result_3[\n   519â†’    ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']\n   520â†’].applymap(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)\n   521â†’result_3 = rank_by_sort(result_3, rank_here)\n   522â†’result_3[cols].to_excel(writer, sheet_name='2ã€äº§å“è§„æ¨¡')\n   523â†’\n   524â†’\n   525â†’# ==============================================================================\n   526â†’# ç¬¬ä¹éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - è§„æ¨¡å˜åŒ–ä¸æ–°å‘äº§å“\n   527â†’# ==============================================================================\n   528â†’\n   529â†’# ------------------------------------------------------------------------------\n   530â†’# æŠ¥è¡¨3: æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–\n   531â†’# ------------------------------------------------------------------------------\n   532â†’print(\"\\n[3] ç”ŸæˆæŠ¥è¡¨: 3ã€æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–...\")\n   533â†’\n   534â†’data_zhanbao = zhoubao_date\n   535â†’zhanbao_df = data_loader.load_zhanbao_data()\n   536â†’\n   537â†’if 'äº§å“ç»ç†' not in zhanbao_df.columns:\n   538â†’    zhanbao_df = zhanbao_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')\n   539â†’zhanbao_df.rename(columns={'å“ç±»': 'å¤šèµ„äº§å“ç±»'}, inplace=True)\n   540â†’\n   541â†’zhanbao_df_1 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: not pd.isnull(x))]\n   542â†’zhanbao_df_1 = del_Innovation_department(zhanbao_df_1)\n   543â†’zhanbao_df_2 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: pd.isnull(x))]\n   544â†’zhanbao_df = pd.concat([zhanbao_df_1, zhanbao_df_2])\n   545â†’\n   546â†’zhanbao_df['æ¯äº§å“ä»£ç '] = zhanbao_df.apply(lambda x: x.name if pd.isnull(x['æ¯äº§å“ä»£ç ']) else x['æ¯äº§å“ä»£ç '], axis=1)\n   547â†’zhanbao_df['æ¯äº§å“ç®€ç§°'] = zhanbao_df.apply(\n   548â†’    lambda x: x['äº§å“ç®€ç§°'] if pd.isnull(x['æ¯äº§å“ç®€ç§°']) else x['æ¯äº§å“ç®€ç§°'], axis=1\n   549â†’)\n   550â†’\n   551â†’kaifang_df = zhanbao_df[\n   552â†’    (zhanbao_df['å½¢æ€'] == 'å®¢æˆ·å‘¨æœŸ') | (zhanbao_df['å½¢æ€'] == 'æœ€çŸ­æŒæœ‰æœŸ') |\n   553â†’    (zhanbao_df['å½¢æ€'] == 'å®šå¼€') | (zhanbao_df['å½¢æ€'] == 'æ—¥å¼€')\n   554â†’]\n   555â†’kaifang_df = kaifang_df.groupby('æ¯äº§å“ä»£ç ').agg({\n   556â†’    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',\n   557â†’    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'äº§å“ç»ç†': 'first'\n   558â†’})\n   559â†’kaifang_df = kaifang_df[kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(lambda x: abs(x) >= 0.05)]\n   560â†’kaifang_df.sort_values(by='è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', ascending=False, inplace=True)\n   561â†’kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'] = kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(\n   562â†’    lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x\n   563â†’)\n   564â†’kaifang_df = kaifang_df[kaifang_df['æ¯å“ç±»'] != 'å°é—­åˆ°æœŸ']\n   565â†’kaifang_df.to_excel(writer, sheet_name='3ã€æœ¬â½‰å®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–')\n   566â†’\n   567â†’# ------------------------------------------------------------------------------\n   568â†’# æŠ¥è¡¨: æœ¬å‘¨æ–°å‘äº§å“\n   569â†’# ------------------------------------------------------------------------------\n   570â†’print(\"[3.1] ç”ŸæˆæŠ¥è¡¨: æœ¬å‘¨æ–°å‘äº§å“...\")\n   571â†’\n   572â†’yunzuogailan_date = zhoubao_date\n   573â†’xinfa_thisweek_df = zhanbao_df[zhanbao_df['èµ·æ¯æ—¥'] >= week_Mon]\n   574â†’yunzuogailan_original = pd.read_excel(Config.get_weekly_data_file('äº§å“è¿ä½œæ¦‚è§ˆ'), index_col=0)\n   575â†’yunzuogailan_original['æ¯äº§å“ä»£ç '] = yunzuogailan_original['äº§å“ç®€ç§°'].map(\n   576â†’    lambda x: yunzuogailan_original[yunzuogailan_original['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]\n   577â†’)\n   578â†’yunzuogailan_original = yunzuogailan_original[['äº§å“ç®€ç§°', 'æ¯äº§å“ä»£ç ', 'äº§å“ç»ç†']].drop_duplicates()\n   579â†’\n   580â†’for mid_ind in xinfa_thisweek_df.index:\n   581â†’    if mid_ind in yunzuogailan_original.index:\n   582â†’        mother_indx = yunzuogailan_original.loc[mid_ind, 'æ¯äº§å“ä»£ç ']\n   583â†’        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mother_indx\n   584â†’        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç®€ç§°']\n   585â†’        xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç»ç†'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç»ç†']\n   586â†’    else:\n   587â†’        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mid_ind\n   588â†’        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç®€ç§°']\n   589â†’\n   590â†’xinfa_thisweek_qudao = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ', 'æ¸ é“-ç®€åŒ–']).agg({\n   591â†’    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',\n   592â†’    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'\n   593â†’})\n   594â†’xinfa_thisweek_sum = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ']).agg({\n   595â†’    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',\n   596â†’    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'\n   597â†’})\n   598â†’\n   599â†’for mid_ind in xinfa_thisweek_sum.index:\n   600â†’    if (mid_ind, 'è¡Œå†…') in xinfa_thisweek_qudao.index:\n   601â†’        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå†…(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå†…'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']\n   602â†’    if (mid_ind, 'è¡Œå¤–') in xinfa_thisweek_qudao.index:\n   603â†’        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå¤–(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå¤–'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']\n   604â†’\n   605â†’if xinfa_thisweek_sum.empty:\n   606â†’    result_3_2_df = pd.DataFrame(columns=[\n   607â†’        'æ¯äº§å“ç®€ç§°', 'é”€é‡(äº¿)', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',\n   608â†’        'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'\n   609â†’    ])\n   610â†’else:\n   611â†’    keep_columns_xinfa = [\n   612â†’        'æ¯äº§å“ç®€ç§°', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',\n   613â†’        'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'æˆ˜æŠ¥åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'\n   614â†’    ]\n   615â†’    cols_available = [c for c in keep_columns_xinfa if c in xinfa_thisweek_sum.columns]\n   616â†’    xinfa_thisweek_sum = xinfa_thisweek_sum[cols_available].copy()\n   617â†’    xinfa_thisweek_sum.rename(columns={'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'é”€é‡(äº¿)', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'åˆ°æœŸæ—¥'}, inplace=True)\n   618â†’    result_3_2_df = xinfa_thisweek_sum[xinfa_thisweek_sum['é”€é‡(äº¿)'] != 0]\n   619â†’    result_3_2_df.sort_values(by='èµ·æ¯æ—¥', ascending=True, inplace=True)\n   620â†’\n   621â†’result_3_2_df.to_excel(writer, sheet_name='æœ¬å‘¨æ–°å‘äº§å“')\n   622â†’\n   623â†’# ------------------------------------------------------------------------------\n   624â†’# æŠ¥è¡¨: å¾…å”®äº§å“\n   625â†’# ------------------------------------------------------------------------------\n   626â†’print(\"[3.2] ç”ŸæˆæŠ¥è¡¨: å¾…å”®äº§å“...\")\n   627â†’\n   628â†’product_tosale_df = data_loader.load_product_tosale()\n   629â†’product_tosale_df = product_tosale_df.merge(\n   630â†’    Product_information_df_DAP['æ¯äº§å“æŠ•èµ„ç»ç†'], left_index=True, right_index=True, how='left'\n   631â†’)\n   632â†’\n   633â†’first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦', 'æä½³èˆª', \"è‹æ–‡æ´¥\", \"å¤å‡¡ç››\", \"é»„äº¦å°§\"]\n   634â†’second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ', \"ç½—è°¨æ·±\"]\n   635â†’third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°', 'å»–ç‚¯è‡£']\n   636â†’\n   637â†’product_tosale_df_new = product_tosale_df[\n   638â†’    product_tosale_df['æ¯äº§å“æŠ•èµ„ç»ç†'].map(lambda x: manager_in_or_not(x, first + second + third))\n   639â†’]\n   640â†’date_here = zhoubao_date[:4] + '-' + zhoubao_date[4:6] + '-' + zhoubao_date[6:]\n   641â†’product_tosale_df_final = product_tosale_df_new[product_tosale_df_new['æˆç«‹æ—¥'] > date_here]\n   642â†’product_tosale_df_final.drop_duplicates(inplace=True)\n   643â†’keep_columns = ['æ¯å­äº§å“æ ‡è¯†', 'äº§å“ç®€ç§°', 'äº§å“å¼€æ”¾å½¢å¼', 'å‹Ÿé›†æœŸ(èµ·)', 'å‹Ÿé›†æœŸ(æ­¢)', 'æˆç«‹æ—¥', 'åˆ°æœŸæ—¥', 'è§„æ¨¡ä¸Šé™(äº¿)', 'é”€å”®å¸ç§']\n   644â†’product_tosale_df_final_v1 = product_tosale_df_final[keep_columns]\n   645â†’product_tosale_df_final_v2 = product_tosale_df_final_v1[\n   646â†’    product_tosale_df_final_v1.apply(\n   647â†’        lambda x: False if (x['äº§å“ç®€ç§°'] in product_tosale_df_final_v1['äº§å“ç®€ç§°']) and (x['æ¯å­äº§å“æ ‡è¯†'] == 'æ¯äº§å“') else True,\n   648â†’        axis=1\n   649â†’    )\n   650â†’]\n   651â†’product_tosale_df_final_v2.sort_values(by='æˆç«‹æ—¥', ascending=True, inplace=True)\n   652â†’product_tosale_df_final_v2.to_excel(writer, sheet_name='å¾…å”®äº§å“')\n   653â†’\n   654â†’\n   655â†’# ==============================================================================\n   656â†’# ç¬¬åéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“ä¸šç»©åˆ†æ\n   657â†’# ==============================================================================\n   658â†’\n   659â†’# ------------------------------------------------------------------------------\n   660â†’# æŠ¥è¡¨: ç³»åˆ—äº§å“ä¸šç»©ï¼ˆè´¹åå¹³å‡/åŠ æƒã€è´¹å‰å¹³å‡/åŠ æƒï¼‰\n   661â†’# ------------------------------------------------------------------------------\n   662â†’print(\"\\n[5] ç”ŸæˆæŠ¥è¡¨: ç³»åˆ—äº§å“ä¸šç»©...\")\n   663â†’\n   664â†’# è®¡ç®—ä¸šç»©æ•°æ®éœ€è¦ç”¨åˆ°çš„å‡½æ•°\n   665â†’year_col = f\"{int(str(zhoubao_date)[:4])}å¹´å¹´åŒ–æ”¶ç›Šç‡\"\n   666â†’\n   667â†’\n   668â†’def weighted_avg(group):\n   669â†’    \"\"\"è®¡ç®—è§„æ¨¡åŠ æƒå¹³å‡\"\"\"\n   670â†’    w_fields = [\n   671â†’        'ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡',\n   672â†’        'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡'\n   673â†’    ]\n   674â†’    results = {}\n   675â†’    for field in w_fields:\n   676â†’        mask = group[field].notna()\n   677â†’        if mask.any():\n   678â†’            weight_valid = group.loc[mask, 'å‡€èµ„äº§(äº¿)']\n   679â†’            total_weight = weight_valid.sum()\n   680â†’            results[field] = (group.loc[mask, field] * weight_valid).sum() / total_weight\n   681â†’        else:\n   682â†’            results[field] = np.nan\n   683â†’    return pd.Series(results)\n   684â†’\n   685â†’\n   686â†’# ç”Ÿæˆäº§å“ç›‘æ§æ•°æ®\n   687â†’data_transposition_here = data_transposition\n   688â†’data_transposition_here.apply(performance_calculate_optimize).T.to_excel(Config.get_performance_file(zhoubao_date))\n   689â†’print('   æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.index[-1]))\n   690â†’\n   691â†’# åŠ è½½è¿ä½œæ¦‚è§ˆæ•°æ®\n   692â†’yunzuogailan_all = del_Innovation_department(\n   693â†’    pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)\n   694â†’)\n   695â†’\n   696â†’# ç­›é€‰æŒæœ‰æœŸå’Œå…¶ä»–äº§å“\n   697â†’to_merge_chiyouqi_code = yunzuogailan_all[\n   698â†’    yunzuogailan_all.apply(lambda x: (x['ä¸»è¦å±•ç¤º'] == 'æ˜¯') & (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']), axis=1)\n   699â†’]\n   700â†’to_merge_other_code = yunzuogailan_all[\n   701â†’    yunzuogailan_all.apply(lambda x: (x['æ¯å­æ ‡å¿—'] in ['éæ¯å­äº§å“', 'æ¯äº§å“']) & (x['å½¢æ€'] in ['å°é—­', 'å®šå¼€']), axis=1)\n   702â†’]\n   703â†’yunzuogailan_now = pd.concat([to_merge_chiyouqi_code, to_merge_other_code])\n   704â†’\n   705â†’# åˆå¹¶æ”¶ç›Šç‡å’Œæ³¢åŠ¨ç‡æ•°æ®\n   706â†’keep_cols = ['è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']\n   707â†’yunzuogailan_now_5 = yunzuogailan_now.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n   708â†’perf_df = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0)\n   709â†’keep_cols = [c for c in keep_cols if c in perf_df.columns]\n   710â†’yunzuogailan_now_ret = yunzuogailan_now_5.merge(perf_df[keep_cols], left_index=True, right_index=True, how='left')\n   711â†’yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'] = yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'].map(\n   712â†’    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x\n   713â†’)\n   714â†’\n   715â†’# å¯¹è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡ä¸º0æˆ–ç¼ºå¤±çš„äº§å“ï¼Œç”¨æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡æ›¿ä»£\n   716â†’yunzuogailan_now_ret['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] = yunzuogailan_now_ret.apply(\n   717â†’    lambda row: row['ç´¯è®¡å¹´åŒ–'] if (pd.isna(row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡']) or row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] == 0) else row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'],\n   718â†’    axis=1\n   719â†’)\n   720â†’\n   721â†’# 5.1 è´¹åå¹³å‡\n   722â†’result_5 = yunzuogailan_now_ret[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + ['ç´¯è®¡å¹´åŒ–'] + keep_cols].groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()[\n   723â†’    ['ç´¯è®¡å¹´åŒ–'] + keep_cols\n   724â†’]\n   725â†’result_5 = rank_by_sort(result_5, rank_here)\n   726â†’result_5.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹åå¹³å‡')\n   727â†’\n   728â†’# 5.2 è´¹ååŠ æƒ\n   729â†’result_5_weight = yunzuogailan_now_ret.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)\n   730â†’result_5_weight = rank_by_sort(result_5_weight, rank_here)\n   731â†’result_5_weight.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹ååŠ æƒ')\n   732â†’\n   733â†’# 5.3 è´¹å‰æ•°æ®\n   734â†’yunzuogailan_add_fee = yunzuogailan_now_ret.copy()\n   735â†’w_field = ['ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']\n   736â†’yunzuogailan_add_fee[w_field] = yunzuogailan_add_fee[w_field].add(\n   737â†’    yunzuogailan_add_fee[['é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹']].sum(axis=1), axis=0\n   738â†’)\n   739â†’\n   740â†’# 5.4 è´¹å‰åŠ æƒ\n   741â†’result_series_performance = yunzuogailan_add_fee.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)\n   742â†’result_series_performance = rank_by_sort(result_series_performance, rank_here)\n   743â†’result_series_performance.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰åŠ æƒ')\n   744â†’\n   745â†’# 5.5 è´¹å‰å¹³å‡\n   746â†’result_series_performance_average = yunzuogailan_add_fee[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + w_field + ['è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']].groupby(\n   747â†’    ['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']\n   748â†’).mean()\n   749â†’result_series_performance_average = rank_by_sort(result_series_performance_average, rank_here)\n   750â†’result_series_performance_average.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰å¹³å‡')\n   751â†’\n   752â†’# ------------------------------------------------------------------------------\n   753â†’# æŠ¥è¡¨5.2: æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°\n   754â†’# ------------------------------------------------------------------------------\n   755â†’print(\"[5.2] ç”ŸæˆæŠ¥è¡¨: 5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°...\")\n   756â†’\n   757â†’yunzuogailan_now_ret_chiyouqi = yunzuogailan_now_ret[yunzuogailan_now_ret.apply(\n   758â†’    lambda x: (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']) and (x['æ¯åˆ†ç±»'] in ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€']),\n   759â†’    axis=1\n   760â†’)]\n   761â†’yunzuogailan_now_ret_chiyouqi.rename(columns={'ç´¯è®¡å¹´åŒ–': 'æˆç«‹ä»¥æ¥å¹´åŒ–', year_col: 'ä»Šå¹´ä»¥æ¥å¹´åŒ–'}, inplace=True)\n   762â†’\n   763â†’# æœ±è€å¸ˆçš„æ‚¦åŠ¨ç¨³äº«9M281010å•ç‹¬å¤„ç†\n   764â†’yunzuogailan_now_ret_chiyouqi.loc[\n   765â†’    '9M281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']\n   766â†’] = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0).loc[\n   767â†’    '9A281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col]\n   768â†’].values\n   769â†’\n   770â†’yunzuogailan_now_ret_chiyouqi['ä»Šå¹´ä»¥æ¥å¹´åŒ–'] = yunzuogailan_now_ret_chiyouqi.apply(\n   771â†’    lambda x: x['æˆç«‹ä»¥æ¥å¹´åŒ–'] if pd.isnull(x['ä»Šå¹´ä»¥æ¥å¹´åŒ–']) else x['ä»Šå¹´ä»¥æ¥å¹´åŒ–'], axis=1\n   772â†’)\n   773â†’\n   774â†’\n   775â†’def get_Scale_weighting_ret(my_df):\n   776â†’    keep_ret_cols = ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']\n   777â†’    ret_sum_df = (my_df[keep_ret_cols].multiply(my_df['å‡€èµ„äº§(äº¿)'], axis=\"index\")).sum()\n   778â†’    scale_sum_df = ((my_df[keep_ret_cols] / my_df[keep_ret_cols]).multiply(my_df['å‡€èµ„äº§(äº¿)'], axis=\"index\")).sum()\n   779â†’    return ret_sum_df / scale_sum_df\n   780â†’\n   781â†’\n   782â†’result_df_52 = yunzuogailan_now_ret_chiyouqi.groupby('æ¯åˆ†ç±»').apply(get_Scale_weighting_ret)\n   783â†’result_df_52.rename(index={'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€': 'æ‚¦åŠ¨çŸ­æŒ'}, inplace=True)\n   784â†’rank_chiyouqi = ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ']\n   785â†’rank_by_sort(result_df_52, rank_chiyouqi).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°1')\n   786â†’\n   787â†’yunzuogailan_now_ret_chiyouqi['æŒæœ‰æœŸæ ‡ç­¾'] = yunzuogailan_now_ret_chiyouqi['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale_v2)\n   788â†’yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'] = yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'].map(\n   789â†’    lambda x: 'æ‚¦åŠ¨çŸ­æŒ' if x == 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€' else x\n   790â†’)\n   791â†’result_df_52_3 = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾']).apply(get_Scale_weighting_ret)\n   792â†’result_df_52_3['æ•°é‡'] = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾'])['äº§å“ç®€ç§°'].count()\n   793â†’rank_chiyouqi_v3 = [\n   794â†’    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '<1M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '1M-3M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '3M-6M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '6M-1Y'),\n   795â†’    ('æ‚¦åŠ¨çŸ­æŒ', '<1M'), ('æ‚¦åŠ¨çŸ­æŒ', '1M-3M'), ('æ‚¦åŠ¨çŸ­æŒ', '3M-6M'), ('æ‚¦åŠ¨çŸ­æŒ', '6M-1Y'),\n   796â†’    ('ä¼˜å…ˆè‚¡çŸ­æŒ', '1M-3M')\n   797â†’]\n   798â†’rank_by_sort(result_df_52_3, rank_chiyouqi_v3).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°2')\n   799â†’\n   800â†’\n   801â†’# ==============================================================================\n   802â†’# ç¬¬åä¸€éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æŠ•èµ„ç»ç†åˆ†æ\n   803â†’# ==============================================================================\n   804â†’\n   805â†’# ------------------------------------------------------------------------------\n   806â†’# æŠ¥è¡¨: æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡\n   807â†’# ------------------------------------------------------------------------------\n   808â†’print(\"\\n[6] ç”ŸæˆæŠ¥è¡¨: æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡...\")\n   809â†’\n   810â†’now = zhoubao_date\n   811â†’yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\n   812â†’yunzuogailan_lastw = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastw), index_col=0))\n   813â†’yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))\n   814â†’yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n   815â†’\n   816â†’result_now = get_scaleandnum_by_sort_manager(yunzuogailan_now).groupby('äº§å“ç»ç†').agg({\n   817â†’    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'\n   818â†’})\n   819â†’\n   820â†’rikai_now = get_scaleandnum_by_sort_manager(yunzuogailan_now)\n   821â†’rikai_now = rikai_now[rikai_now['å½¢æ€'].map(lambda x: x in ['æ—¥å¼€', 'å®¢æˆ·å‘¨æœŸ', 'æœ€çŸ­æŒæœ‰æœŸ'])].groupby('äº§å“ç»ç†').agg({\n   822â†’    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'\n   823â†’})\n   824â†’rikai_now.rename(columns={'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'}, inplace=True)\n   825â†’\n   826â†’result_df_here = []\n   827â†’cols_to_append = ['-è¾ƒä¸Šå‘¨', '-è¾ƒä¸Šæœˆæœ«', '-è¾ƒä¸Šå¹´æœ«']\n   828â†’for i in range(3):\n   829â†’    mid_df = [yunzuogailan_lastw, yunzuogailan_lastm, yunzuogailan_lasty][i]\n   830â†’    result_df_i = result_now - get_scaleandnum_by_sort_manager(mid_df).groupby('äº§å“ç»ç†').agg({\n   831â†’        'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'\n   832â†’    })\n   833â†’    result_df_i.columns = [x + cols_to_append[i] for x in ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°']]\n   834â†’    result_df_here.append(result_df_i)\n   835â†’\n   836â†’result_df_here = pd.concat([result_now] + result_df_here + [rikai_now], axis=1)\n   837â†’\n   838â†’cols_here = [\n   839â†’    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡',\n   840â†’    'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'\n   841â†’]\n   842â†’indx_here = [\n   843â†’    'ä¸¥æ³“', 'å¾è¹', 'æ¨æ¼ ', 'é«˜ç¿°æ˜†', 'å§œé”¡å³°', 'ä½™æ´é›…', 'è–›çºªæ™”', 'èƒ¡è‰³å©·', 'æœ±è½¶ä¼¦', 'ä»»é›',\n   844â†’    'å¼ ç‰æ°', 'å»–ç‚¯è‡£', 'æä½³èˆª', \"è‹æ–‡æ´¥\", \"å¤å‡¡ç››\", \"é»„äº¦å°§\", \"ç½—è°¨æ·±\"\n   845â†’]\n   846â†’result_df_here = result_df_here[cols_here]\n   847â†’result_df_here = result_df_here.dropna(axis=0, how='all')\n   848â†’result_df_here = rank_by_sort(result_df_here, indx_here)\n   849â†’result_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']] = \\\n   850â†’    result_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']].applymap(\n   851â†’        lambda x: '{:.2f}'.format(x)\n   852â†’    )\n   853â†’result_df_here.to_excel(writer, sheet_name='æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡')\n   854â†’\n   855â†’# ------------------------------------------------------------------------------\n   856â†’# æŠ¥è¡¨: ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡\n   857â†’# ------------------------------------------------------------------------------\n   858â†’print(\"[6.1] ç”ŸæˆæŠ¥è¡¨: ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡...\")\n   859â†’\n   860â†’yunzuogailan_now_65 = yunzuogailan_now.copy()\n   861â†’yunzuogailan_now_65['å½¢æ€'] = yunzuogailan_now_65['å½¢æ€'].map(lambda x: 'æœ€çŸ­æŒæœ‰æœŸ' if x == 'å®¢æˆ·å‘¨æœŸ' else x)\n   862â†’yunzuogailan_now_65 = yunzuogailan_now_65.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n   863â†’result_df_here_65 = pd.concat([\n   864â†’    pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€', values=['å‡€èµ„äº§(äº¿)'], aggfunc='count'),\n   865â†’    pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€', values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)\n   866â†’], axis=1)\n   867â†’result_df_here_65.to_excel(writer, sheet_name='ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡')\n   868â†’\n   869â†’\n   870â†’# ==============================================================================\n   871â†’# ç¬¬åäºŒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æ‹›å•†äº§å“åˆ†æ\n   872â†’# ==============================================================================\n   873â†’\n   874â†’# ------------------------------------------------------------------------------\n   875â†’# æŠ¥è¡¨: æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†\n   876â†’# ------------------------------------------------------------------------------\n   877â†’print(\"\\n[7] ç”ŸæˆæŠ¥è¡¨: æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†...\")\n   878â†’\n   879â†’zhaoshang_product_list = list(set(Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'].index))\n   880â†’zhaoshang_product_df = yunzuogailan_all.loc[zhaoshang_product_list]\n   881â†’zhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'] = zhaoshang_product_df['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)\n   882â†’zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] = zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'].map(\n   883â†’    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x\n   884â†’)\n   885â†’zhaoshangfinal = zhaoshang_product_df[\n   886â†’    (zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] * 100 - zhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'].map(\n   887â†’        lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100\n   888â†’    )) < 0\n   889â†’]\n   890â†’zhaoshang_scale = Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸']['ä¿æœ‰è§„æ¨¡'] / 100000000\n   891â†’zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] = [zhaoshang_scale[ind] for ind in zhaoshangfinal.index]\n   892â†’zhaoshangfinal = zhaoshangfinal[zhaoshangfinal['è¿ä½œå¤©'] > 30]\n   893â†’zhaoshangfinal = zhaoshangfinal[zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] > 0.1]\n   894â†’zhaoshangfinal.sort_values('å‰©ä½™å¤©', ascending=True, inplace=True)\n   895â†’zhaoshangfinal.to_excel(writer, sheet_name='æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†')\n   896â†’\n   897â†’# ------------------------------------------------------------------------------\n   898â†’# æŠ¥è¡¨: å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸è¾¾ä¸šç»©äº§å“æ¸…å•\n   899â†’# ------------------------------------------------------------------------------\n   900â†’print(\"[7.1] ç”ŸæˆæŠ¥è¡¨: å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸è¾¾ä¸šç»©äº§å“æ¸…å•...\")\n   901â†’\n   902â†’yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'] = yunzuogailan_all['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)\n   903â†’yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] = yunzuogailan_all['æœ¬æœŸå¹´åŒ–'].map(\n   904â†’    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x\n   905â†’)\n   906â†’yunzuogailan_all = yunzuogailan_all[\n   907â†’    (yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] * 100 - yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'].map(\n   908â†’        lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100\n   909â†’    )) < 0\n   910â†’]\n   911â†’bdjz_100 = yunzuogailan_all[(yunzuogailan_all['å½¢æ€'].isin(['å°é—­', 'å®šå¼€'])) & (yunzuogailan_all['å‰©ä½™å¤©'] < 100)]\n   912â†’bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = (bdjz_100['æœ¬æœŸå¹´åŒ–'] - (bdjz_100['ä¸šç»©åŸºå‡†ä¸‹é™'].str[:-1]).astype(float) / 100) * 10000\n   913â†’bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'].astype(int)\n   914â†’bdjz_100 = bdjz_100[bdjz_100['æ¯åˆ†ç±»'] != 'å¤–å¸ä½æ³¢']\n   915â†’bdjz_100.to_excel(writer, sheet_name='å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸å¤§ä¸šç»©äº§å“æ¸…å•')\n   916â†’\n   917â†’\n   918â†’# ==============================================================================\n   919â†’# ç¬¬åä¸‰éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - èµ„äº§å¤§è¡¨\n   920â†’# ==============================================================================\n   921â†’\n   922â†’# ------------------------------------------------------------------------------\n   923â†’# æŠ¥è¡¨8: èµ„äº§å¤§è¡¨\n   924â†’# ------------------------------------------------------------------------------\n   925â†’print(\"\\n[8] ç”ŸæˆæŠ¥è¡¨: 8.èµ„äº§å¤§è¡¨...\")\n   926â†’\n   927â†’date = zhoubao_date\n   928â†’date_lastw = lastw\n   929â†’date_lastm = lastm\n   930â†’date_lasty = lasty\n   931â†’\n   932â†’yunzuogailan_all = pd.read_excel(Config.get_overview_history_file(date), index_col=0)\n   933â†’Chicang_df = data_loader.load_chicang_data(date)\n   934â†’Chicang_df = Chicang_df.merge(yunzuogailan_all['å¸ç§'], left_on='äº§å“ä»£ç ', right_index=True, how='left')\n   935â†’\n   936â†’# ç¾å…ƒäº§å“è½¬æ¢æ±‡ç‡\n   937â†’EXchange_rate = market_data.get_exchange_rate('USDCNY', Config.EXCHANGE_RATE_DATE)\n   938â†’Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.apply(\n   939â†’    lambda x: x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] * EXchange_rate if x['å¸ç§'] == 'ç¾å…ƒ' else x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'],\n   940â†’    axis=1\n   941â†’)\n   942â†’\n   943â†’# å¤„ç†ç‰¹æ®ŠåŸºé‡‘ç±»å‹\n   944â†’to_fill_indx = Chicang_df[Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] == 0].index\n   945â†’Chicang_df.loc[to_fill_indx, 'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.loc[to_fill_indx, 'æŒä»“æˆæœ¬(å…ƒ)'] + Chicang_df.loc[to_fill_indx, 'æŒæœ‰æœŸæ”¶ç›Š']\n   946â†’Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].fillna(0)\n   947â†’\n   948â†’# åŠ è½½èµ„äº§åˆ†ç±»æ•°æ®\n   949â†’asset_classification_joint_df = data_loader.load_asset_classification()\n   950â†’insurance_pdct_df = data_loader.load_insurance_products()\n   951â†’\n   952â†’# åŒ¹é…èµ„äº§å°ç±»å’Œå‹¾ç¨½å…³ç³»\n   953â†’Chicang_df = Chicang_df.merge(\n   954â†’    asset_classification_joint_df[['ç¼–å·', 'ä¸‰çº§åˆ†ç±»']], left_on='æ–°ç‰ˆèµ„äº§å°ç±»', right_index=True, how='left'\n   955â†’)\n   956â†’\n   957â†’# æ ‡è®°ä¿é™©èµ„ç®¡èµ„äº§\n   958â†’mid_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å°ç±»'] == 'å§”å¤–ç°é‡‘ç®¡ç†æŠ•èµ„']\n   959â†’insurance_pdct_name_list = list(insurance_pdct_df.index) + ['è‹±å¤§èµ„äº§-èšé‘«22å·', 'å¤§å®¶èµ„ç®¡ç¨³å¥ç²¾é€‰15å·']\n   960â†’insurance_pdct_indx = mid_df[mid_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in insurance_pdct_name_list)].index\n   961â†’Chicang_df.loc[insurance_pdct_indx, 'ç¼–å·'] = '1.2'\n   962â†’Chicang_df.loc[insurance_pdct_indx, 'ä¸‰çº§åˆ†ç±»'] = '1.2 ä¿é™©åè®®å­˜æ¬¾'\n   963â†’\n   964â†’# ç»†åŒ–åŸæŠ•å’Œæ°¸ç»­å€ºåˆ†ç±»\n   965â†’bond_set_df = pd.DataFrame(list(set(Chicang_df[Chicang_df['ç¼–å·'] == '3.4-3.5']['å¤–éƒ¨ä»£ç '])), columns=['å¤–éƒ¨ä»£ç '])\n   966â†’bond_code_list = list(bond_set_df['å¤–éƒ¨ä»£ç '].values)\n   967â†’wind_result = market_data.get_bond_attributes(bond_code_list)\n   968â†’bond_set_df[['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­']] = wind_result.values\n   969â†’\n   970â†’to_merge_df = pd.DataFrame([\n   971â†’    ['æ˜¯', 'å¦', '3.4.1 éæ°¸ç»­åŸæŠ•å€º'], ['æ˜¯', 'æ˜¯', '3.4.2 æ°¸ç»­åŸæŠ•å€º'],\n   972â†’    ['å¦', 'å¦', '3.5.1 éæ°¸ç»­äº§ä¸šå€º'], ['å¦', 'æ˜¯', '3.5.2 æ°¸ç»­äº§ä¸šå€º']\n   973â†’], columns=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­', 'ä¸‰çº§åˆ†ç±»'])\n   974â†’bond_set_df = bond_set_df.merge(to_merge_df, left_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], right_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], how='left')\n   975â†’\n   976â†’Chicang_df['ä¸‰çº§åˆ†ç±»-new'] = Chicang_df.apply(\n   977â†’    lambda x: bond_set_df.set_index('å¤–éƒ¨ä»£ç ').loc[x['å¤–éƒ¨ä»£ç '], 'ä¸‰çº§åˆ†ç±»'] if x['ç¼–å·'] == '3.4-3.5' else x['ä¸‰çº§åˆ†ç±»'],\n   978â†’    axis=1\n   979â†’)\n   980â†’\n   981â†’# åŒ¹é…å¤šèµ„äº§å“ç±»\n   982â†’yunzuogailan_now = pd.read_excel(Config.get_overview_parent_file(date), index_col=0)\n   983â†’Chicang_df2 = Chicang_df.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»', 'äº§å“ç»ç†']], left_on='äº§å“ä»£ç ', right_index=True, how='left')\n   984â†’Chicang_df2 = Chicang_df2[Chicang_df2.apply(lambda x: not pd.isnull(x['äº§å“ç»ç†']), axis=1)]\n   985â†’Chicang_df2 = del_Innovation_department(Chicang_df2)\n   986â†’Chicang_df2 = Chicang_df2.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n   987â†’\n   988â†’result_df_8_initial = pd.pivot_table(\n   989â†’    Chicang_df2, index=['ä¸‰çº§åˆ†ç±»-new'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],\n   990â†’    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n   991â†’) / 100000000\n   992â†’\n   993â†’# ç»†åŒ–å§”å¤–å€ºåˆ¸æŠ•èµ„å­é¡¹\n   994â†’Outsourced_bond_asset_df = Chicang_df2[Chicang_df2['ä¸‰çº§åˆ†ç±»'] == '7.2 å§”å¤–å€ºåˆ¸æŠ•èµ„']\n   995â†’public_account_tag_df = data_loader.load_public_account_tag()\n   996â†’Outsourced_bond_asset_df_new = Outsourced_bond_asset_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')\n   997â†’\n   998â†’Outsourced_bond_tag = {\n   999â†’    'æ”¶ç›˜ä»·æ³•': '7.2.1 æ”¶ç›˜ä»·ä¸“æˆ·', 'åˆ©ç‡å€ºæ”¶ç›˜ä»·': '7.2.2 åˆ©ç‡å€ºæ”¶ç›˜ä»·ä¸“æˆ·',\n  1000â†’    'æ¨¡å‹æ³•': '7.2.3 æ¨¡å‹æ³•ä¸“æˆ·', 'å¯è½¬å€º': '7.2.4 å¯è½¬å€ºä¸“æˆ·',\n  1001â†’    'æ’å®šä¹…æœŸ': '7.2.5 æ’å®šä¹…æœŸä¸“æˆ·', 'å›ºæ”¶+å§”å¤–': '7.2.6 å›ºæ”¶+å§”å¤–ä¸“æˆ·',\n  1002â†’    'Wä¸“æˆ·': '7.2.7 Wä¸“æˆ·', 'ç»¿è‰²å€º': '7.2.8 ç»¿è‰²å€ºä¸“æˆ·', 'å¤–å¸ä¸“æˆ·': '7.2.9 å¤–å¸ä¸“æˆ·',\n  1003â†’}\n  1004â†’Outsourced_bond_asset_df_new['å››çº§åˆ†ç±»'] = Outsourced_bond_asset_df_new['æ ‡ç­¾'].map(\n  1005â†’    lambda x: Outsourced_bond_tag[x] if x in Outsourced_bond_tag.keys() else '7.2.10 å…¶ä»–'\n  1006â†’)\n  1007â†’Outsourced_bond_asset_result = pd.pivot_table(\n  1008â†’    Outsourced_bond_asset_df_new, index=['å››çº§åˆ†ç±»'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],\n  1009â†’    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n  1010â†’) / 100000000\n  1011â†’\n  1012â†’result_df_8 = pd.concat([result_df_8_initial.rename_axis(''), Outsourced_bond_asset_result.rename_axis('')])\n  1013â†’result_df_8.to_excel(Config.get_asset_table_file(date))\n  1014â†’\n  1015â†’# è®¡ç®—åŒæ¯”ç¯æ¯”å˜åŒ–\n  1016â†’result_df_lastw = pd.read_excel(Config.get_asset_table_file(date_lastw), index_col=0, header=[0, 1, 2])\n  1017â†’result_df_lastm = pd.read_excel(Config.get_asset_table_file(lastm), index_col=0, header=[0, 1, 2])\n  1018â†’result_df_lasty = pd.read_excel(Config.get_asset_table_file(lasty), index_col=0, header=[0, 1, 2])\n  1019â†’\n  1020â†’result_df_8_final = pd.concat([\n  1021â†’    result_df_8, result_df_8.sum(axis=1) - result_df_lastw.sum(axis=1),\n  1022â†’    result_df_8.sum(axis=1) - result_df_lastm.sum(axis=1),\n  1023â†’    result_df_8.sum(axis=1) - result_df_lasty.sum(axis=1)\n  1024â†’], axis=1)\n  1025â†’\n  1026â†’# è¡¥å……æœ¬å¸çš„ç›¸æ¯”å˜åŒ–\n  1027â†’foreign_currency_products_cols = [\n  1028â†’    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),\n  1029â†’    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼')\n  1030â†’]\n  1031â†’all_columns_8 = list(result_df_8.columns)\n  1032â†’domestic_columns_8 = [col for col in all_columns_8 if col not in foreign_currency_products_cols]\n  1033â†’all_columns_lastw = list(result_df_lastw.columns)\n  1034â†’domestic_columns_lastw = [col for col in all_columns_lastw if col not in foreign_currency_products_cols]\n  1035â†’all_columns_lastm = list(result_df_lastm.columns)\n  1036â†’domestic_columns_lastm = [col for col in all_columns_lastm if col not in foreign_currency_products_cols]\n  1037â†’all_columns_lasty = list(result_df_lasty.columns)\n  1038â†’domestic_columns_lasty = [col for col in all_columns_lasty if col not in foreign_currency_products_cols]\n  1039â†’\n  1040â†’result_df_8_domestic_currency = result_df_8[domestic_columns_8].sum(axis=1)\n  1041â†’result_df_lastw_domestic_currency = result_df_lastw[domestic_columns_lastw].sum(axis=1)\n  1042â†’result_df_lastm_domestic_currency = result_df_lastm[domestic_columns_lastm].sum(axis=1)\n  1043â†’result_df_lasty_domestic_currency = result_df_lasty[domestic_columns_lasty].sum(axis=1)\n  1044â†’\n  1045â†’result_df_8_final = pd.concat([\n  1046â†’    result_df_8_final,\n  1047â†’    result_df_8_domestic_currency - result_df_lastw_domestic_currency,\n  1048â†’    result_df_8_domestic_currency - result_df_lastm_domestic_currency,\n  1049â†’    result_df_8_domestic_currency - result_df_lasty_domestic_currency\n  1050â†’], axis=1)\n  1051â†’\n  1052â†’result_df_8_final.columns = pd.MultiIndex.from_tuples(\n  1053â†’    tuple(result_df_8.columns) + (\n  1054â†’        (\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨'), (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ'), (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´'),\n  1055â†’        (\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨-ä¸å«å¤–å¸äº§å“'), (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ-ä¸å«å¤–å¸äº§å“'), (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´-ä¸å«å¤–å¸äº§å“')\n  1056â†’    )\n  1057â†’)\n  1058â†’result_df_8_final.to_excel(writer, sheet_name='8.èµ„äº§å¤§è¡¨')\n  1059â†’\n  1060â†’\n  1061â†’# ==============================================================================\n  1062â†’# ç¬¬åå››éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - ä¸­æ”¶ç›‘æ§\n  1063â†’# ==============================================================================\n  1064â†’\n  1065â†’# ------------------------------------------------------------------------------\n  1066â†’# æŠ¥è¡¨9: ä¸­æ”¶ç›‘æ§\n  1067â†’# ------------------------------------------------------------------------------\n  1068â†’print(\"\\n[9] ç”ŸæˆæŠ¥è¡¨: 9.ä¸­æ”¶ç›‘æ§...\")\n  1069â†’\n  1070â†’date = zhoubao_date\n  1071â†’zhongshou_m, zhongshou_y = data_loader.load_zhongshou_data(date)\n  1072â†’\n  1073â†’\n  1074â†’def zhongshou_df_processing_v2(df_here, period_here: str):\n  1075â†’    \"\"\"å¤„ç†ä¸­æ”¶æ•°æ®\"\"\"\n  1076â†’    fixed_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'æŠ•èµ„å›¢é˜Ÿ', 'å›¢é˜Ÿåˆ’åˆ†', 'äº§å“çº¿']\n  1077â†’    df_here.columns = fixed_cols + list(df_here.columns[5:])\n  1078â†’    df_here = df_here[df_here['å›¢é˜Ÿåˆ’åˆ†'] == '5.å¤šèµ„äº§æŠ•èµ„éƒ¨']\n  1079â†’    df_here.columns = [''.join(x.split('\\n')) for x in df_here.columns]\n  1080â†’    zhongshou_cols = ['é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']\n  1081â†’    df_here = df_here[fixed_cols + zhongshou_cols]\n  1082â†’    df_here = df_here[df_here['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰'].map(lambda x: x > 0.00001)]\n  1083â†’    df_here = df_here.merge(classification_df[['å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True, how='left')\n  1084â†’    df_here = del_Innovation_department(df_here)\n  1085â†’    df_here = df_here.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n  1086â†’    mid_result = df_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).sum()[\n  1087â†’        ['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']\n  1088â†’    ]\n  1089â†’    mid_cols = [period_here + x for x in ['ä¸­æ”¶', 'é”€å”®ç®¡ç†è´¹', 'æŠ•èµ„ç®¡ç†è´¹(å«è¶…é¢)', 'è¶…é¢ç®¡ç†è´¹', 'å‰ç«¯æ”¶è´¹']]\n  1090â†’    mid_result.columns = mid_cols\n  1091â†’    return mid_result\n  1092â†’\n  1093â†’\n  1094â†’result_9 = pd.concat([\n  1095â†’    zhongshou_df_processing_v2(zhongshou_m, '-'.join([date[:4], date[4:6]])),\n  1096â†’    zhongshou_df_processing_v2(zhongshou_y, date[:4])\n  1097â†’], axis=1)\n  1098â†’result_9 = rank_by_sort(result_9, rank_here)\n  1099â†’result_9.to_excel(writer, sheet_name='9.ä¸­æ”¶ç›‘æ§')\n  1100â†’\n  1101â†’\n  1102â†’# ==============================================================================\n  1103â†’# ç¬¬åäº”éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“åˆ°æœŸ\n  1104â†’# ==============================================================================\n  1105â†’\n  1106â†’# ------------------------------------------------------------------------------\n  1107â†’# æŠ¥è¡¨10: äº§å“åˆ°æœŸæƒ…å†µ\n  1108â†’# ------------------------------------------------------------------------------\n  1109â†’print(\"\\n[10] ç”ŸæˆæŠ¥è¡¨: 10.äº§å“åˆ°æœŸæƒ…å†µ...\")\n  1110â†’\n  1111â†’date = zhoubao_date\n  1112â†’yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(date), index_col=0))\n  1113â†’yunzuogailan_now['åˆ°æœŸæœˆä»½'] = yunzuogailan_now['åˆ°æœŸæ—¥'].map(lambda x: x[:-3])\n  1114â†’yunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n  1115â†’yunzuogailan_here = yunzuogailan_here[yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w]\n  1116â†’\n  1117â†’yunzuogailan_here_fengbi = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å°é—­']\n  1118â†’yunzuogailan_here_dingkai = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å®šå¼€']\n  1119â†’output_sheetname = ['10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ', '10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ-å®šå¼€']\n  1120â†’\n  1121â†’k = 0\n  1122â†’for yunzuogailan_here_to_cal in [yunzuogailan_here_fengbi, yunzuogailan_here_dingkai]:\n  1123â†’    result_df_10 = pd.pivot_table(\n  1124â†’        yunzuogailan_here_to_cal, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='åˆ°æœŸæœˆä»½',\n  1125â†’        values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum\n  1126â†’    )\n  1127â†’    result_df_10 = rank_by_sort(full_category_or_not(result_df_10, rank_here), rank_here).T\n  1128â†’    result_df_10.index = result_df_10.loc['å‡€èµ„äº§(äº¿)'].index\n  1129â†’    result_df_10[[float(x[:4]) < 2029 for x in result_df_10.index]].to_excel(writer, sheet_name=output_sheetname[k])\n  1130â†’    k += 1\n  1131â†’\n  1132â†’keep_cols = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'æ¯åˆ†ç±»', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']\n  1133â†’result_df_10_2 = yunzuogailan_here[\n  1134â†’    (yunzuogailan_here['åˆ°æœŸæ—¥'] <= closing_date_next_w) & (yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w)\n  1135â†’][keep_cols]\n  1136â†’result_df_10_2.sort_values(by='åˆ°æœŸæ—¥', ascending=True, inplace=True)\n  1137â†’result_df_10_2.to_excel(writer, sheet_name='10.ä¸‹å‘¨åˆ°æœŸäº§å“æ¸…å•')\n  1138â†’\n  1139â†’print('   ä¸‹å‘¨åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2['å‡€èµ„äº§(äº¿)'].sum()))\n  1140â†’print('   å°é—­åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum()))\n  1141â†’print('   å®šå¼€åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()))\n  1142â†’\n  1143â†’\n  1144â†’# ==============================================================================\n  1145â†’# ç¬¬åå…­éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æŒä»“åˆ†æ\n  1146â†’# ==============================================================================\n  1147â†’\n  1148â†’# ------------------------------------------------------------------------------\n  1149â†’# æŠ¥è¡¨11: æŒä»“æ˜ç»†\n  1150â†’# ------------------------------------------------------------------------------\n  1151â†’print(\"\\n[11] ç”ŸæˆæŠ¥è¡¨: 11.æŒä»“æ˜ç»†...\")\n  1152â†’\n  1153â†’date = zhoubao_date\n  1154â†’Chicang_df = data_loader.load_chicang_data(date)\n  1155â†’Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()\n  1156â†’\n  1157â†’# 11.1 å…´åˆäº§å“æŒä»“æ˜ç»†\n  1158â†’print(\"[11.1] ç”ŸæˆæŠ¥è¡¨: 11.å…´åˆäº§å“æŒä»“æ˜ç»†...\")\n  1159â†’xinghe_list = Config.XINGHE_PRODUCTS\n  1160â†’concat_xinghe_series = []\n  1161â†’for i in range(len(xinghe_list)):\n  1162â†’    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'\n  1163â†’    concat_xinghe_series.append(pd.Series(\n  1164â†’        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1165â†’        name=xinghe_list[i] + '-é‡‘é¢'\n  1166â†’    ))\n  1167â†’\n  1168â†’concat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)\n  1169â†’concat_xinghe_df = concat_xinghe_df.merge(\n  1170â†’    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n  1171â†’    left_index=True, right_index=True, how='left'\n  1172â†’)\n  1173â†’concat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)\n  1174â†’concat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]\n  1175â†’result_df_11_1 = pd.concat([\n  1176â†’    concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n  1177â†’    concat_xinghe_pct_df\n  1178â†’], axis=1)\n  1179â†’result_df_11_1.to_excel(writer, sheet_name='11.å…´åˆäº§å“æŒä»“æ˜ç»†')\n  1180â†’\n  1181â†’# 11.1.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†\n  1182â†’print(\"[11.1.1] ç”ŸæˆæŠ¥è¡¨: 11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†...\")\n  1183â†’concat_zhuanzhai_series = []\n  1184â†’zhuanzhai_dict = Config.CONVERTIBLE_BOND_ACCOUNTS\n  1185â†’zhuanzhai_list = []\n  1186â†’for shortname in zhuanzhai_dict.keys():\n  1187â†’    concat_zhuanzhai_series.append(pd.Series(\n  1188â†’        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1189â†’        name=shortname + '-é‡‘é¢'\n  1190â†’    ))\n  1191â†’    zhuanzhai_list += [shortname]\n  1192â†’\n  1193â†’ETF_bond_list = Config.CONVERTIBLE_BOND_ETF\n  1194â†’concat_zhuanzhai_series.append(pd.Series(\n  1195â†’    Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1196â†’    name='å¯è½¬å€ºETF-é‡‘é¢'\n  1197â†’))\n  1198â†’zhuanzhai_list += ['å¯è½¬å€ºETF']\n  1199â†’\n  1200â†’concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)\n  1201â†’concat_zhuanzhai_df = concat_zhuanzhai_df.merge(\n  1202â†’    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n  1203â†’    left_index=True, right_index=True, how='left'\n  1204â†’)\n  1205â†’concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(\n  1206â†’    concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0\n  1207â†’)\n  1208â†’concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]\n  1209â†’result_df_11_1_1 = pd.concat([\n  1210â†’    concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n  1211â†’    concat_zhuanzhai_pct_df\n  1212â†’], axis=1)\n  1213â†’result_df_11_1_1.to_excel(writer, sheet_name='11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†')\n  1214â†’\n  1215â†’# 11.2 é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†\n  1216â†’print(\"[11.2] ç”ŸæˆæŠ¥è¡¨: 11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†...\")\n  1217â†’public_account_tag_df = data_loader.load_public_account_tag()\n  1218â†’Weiwai_df_full = Weiwai_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')\n  1219â†’Weiwai_df_full = Weiwai_df_full.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»']], left_on='äº§å“ä»£ç ', right_index=True, how='left')\n  1220â†’Weiwai_df_full = Weiwai_df_full.merge(Parent_sort[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n  1221â†’\n  1222â†’concat_quant_series = []\n  1223â†’quant_list = Config.QUANT_STRATEGY_LABELS\n  1224â†’concat_quant_series.append(pd.Series(\n  1225â†’    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–ä¸­æ€§'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1226â†’    name='é‡åŒ–ä¸­æ€§'\n  1227â†’))\n  1228â†’concat_quant_series.append(pd.Series(\n  1229â†’    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–æŒ‡å¢'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1230â†’    name='é‡åŒ–æŒ‡å¢'\n  1231â†’))\n  1232â†’concat_quant_series.append(pd.Series(\n  1233â†’    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–CTA'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1234â†’    name='é‡åŒ–CTA'\n  1235â†’))\n  1236â†’concat_quant_series.append(pd.Series(\n  1237â†’    Weiwai_df_full[Weiwai_df_full['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-å…´åˆ4å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1238â†’    name='å…´åˆ4å·'\n  1239â†’))\n  1240â†’concat_quant_df = pd.concat(concat_quant_series, axis=1)\n  1241â†’concat_quant_df = concat_quant_df.merge(\n  1242â†’    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)']],\n  1243â†’    left_index=True, right_index=True, how='left'\n  1244â†’)\n  1245â†’concat_quant_pct_df = concat_quant_df[quant_list].div(concat_quant_df['å‡€èµ„äº§(äº¿)'], axis=0)\n  1246â†’concat_quant_pct_df.columns = [x + '-å æ¯”' for x in quant_list]\n  1247â†’result_df_11_3 = pd.concat([concat_quant_df[quant_list + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†']], concat_quant_pct_df], axis=1)\n  1248â†’result_df_11_3.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)\n  1249â†’result_df_11_3.to_excel(writer, sheet_name='11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†')\n  1250â†’\n  1251â†’# 11.2.1-11.2.3 å§”å¤–ä¸“æˆ·é…ç½®æƒ…å†µ\n  1252â†’print(\"[11.2.1-11.2.3] ç”ŸæˆæŠ¥è¡¨: å§”å¤–ä¸“æˆ·é…ç½®æƒ…å†µ...\")\n  1253â†’result_df_11_2_amt = pd.pivot_table(\n  1254â†’    Weiwai_df_full, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ ‡ç­¾',\n  1255â†’    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n  1256â†’) / 100000000\n  1257â†’yunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n  1258â†’result_df_11_2_pct_2 = result_df_11_2_amt.div(yunzuogailan_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'])['å‡€èµ„äº§(äº¿)'].sum(), axis=0)\n  1259â†’\n  1260â†’Weiwai_df_simplify = pd.pivot_table(\n  1261â†’    Weiwai_df_full, index=['äº§å“ä»£ç '], columns='æ ‡ç­¾',\n  1262â†’    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n  1263â†’) / 100000000\n  1264â†’Weiwai_df_simplify.columns = Weiwai_df_simplify['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].columns\n  1265â†’Weiwai_df_simplify = Weiwai_df_simplify.merge(yunzuogailan_here[['å‡€èµ„äº§(äº¿)']], left_index=True, right_index=True, how='left')\n  1266â†’result_df_11_2_pct = Weiwai_df_simplify.div(Weiwai_df_simplify['å‡€èµ„äº§(äº¿)'], axis=0).merge(\n  1267â†’    yunzuogailan_here[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_index=True, right_index=True, how='left'\n  1268â†’)\n  1269â†’result_df_11_2_pct = result_df_11_2_pct.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()\n  1270â†’\n  1271â†’rank_by_sort(full_category_or_not(result_df_11_2_amt, rank_here), rank_here).to_excel(\n  1272â†’    writer, sheet_name='11.2.1å…¶ä»–å§”å¤–ä¸“æˆ·é‡‘é¢é…ç½®æƒ…å†µ'\n  1273â†’)\n  1274â†’rank_by_sort(full_category_or_not(result_df_11_2_pct, rank_here), rank_here).to_excel(\n  1275â†’    writer, sheet_name='11.2.2å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ'\n  1276â†’)\n  1277â†’rank_by_sort(full_category_or_not(result_df_11_2_pct_2, rank_here), rank_here).to_excel(\n  1278â†’    writer, sheet_name='11.2.3å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ-é™¤ä»¥ç³»åˆ—è§„æ¨¡'\n  1279â†’)\n  1280â†’\n  1281â†’# 11.4 å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†\n  1282â†’print(\"[11.4] ç”ŸæˆæŠ¥è¡¨: 11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†...\")\n  1283â†’xinghe_list = Config.XINGHE_PRODUCTS_2\n  1284â†’concat_xinghe_series = []\n  1285â†’for i in range(len(xinghe_list)):\n  1286â†’    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'\n  1287â†’    concat_xinghe_series.append(pd.Series(\n  1288â†’        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1289â†’        name=xinghe_list[i] + '-é‡‘é¢'\n  1290â†’    ))\n  1291â†’concat_xinghe_series.append(pd.Series(\n  1292â†’    Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-è´¢æ™ºäººç”ŸçµåŠ¨1å·å•ä¸€èµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1293â†’    name='çµåŠ¨1å·-é‡‘é¢'\n  1294â†’))\n  1295â†’xinghe_list = xinghe_list + ['çµåŠ¨1å·']\n  1296â†’\n  1297â†’concat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)\n  1298â†’concat_xinghe_df = concat_xinghe_df.merge(\n  1299â†’    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n  1300â†’    left_index=True, right_index=True, how='left'\n  1301â†’)\n  1302â†’concat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)\n  1303â†’concat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]\n  1304â†’result_df_11_4 = pd.concat([\n  1305â†’    concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n  1306â†’    concat_xinghe_pct_df\n  1307â†’], axis=1)\n  1308â†’result_df_11_4.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)\n  1309â†’result_df_11_4.to_excel(writer, sheet_name='11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†')\n  1310â†’\n  1311â†’# 11.5 å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”\n  1312â†’print(\"[11.5] ç”ŸæˆæŠ¥è¡¨: 11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”...\")\n  1313â†’Zhuanhu_label_df = data_loader.load_public_account_tag()\n  1314â†’derivative_zhuanhu_list = list(Zhuanhu_label_df[Zhuanhu_label_df['æ ‡ç­¾'] == 'è¡ç”Ÿå“ä¸“æˆ·'].index)\n  1315â†’derivative_zhuanhu_df = Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in derivative_zhuanhu_list)]\n  1316â†’derivative_zhuanhu_df = pd.pivot_table(\n  1317â†’    derivative_zhuanhu_df, index=['äº§å“ä»£ç '], columns='å€ºåˆ¸ç®€ç§°',\n  1318â†’    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n  1319â†’)\n  1320â†’derivative_zhuanhu_df.columns = [x[1][5:-8] for x in derivative_zhuanhu_df.columns]\n  1321â†’derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'] = derivative_zhuanhu_df.sum(axis=1)\n  1322â†’derivative_zhuanhu_df = derivative_zhuanhu_df.merge(\n  1323â†’    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n  1324â†’    left_index=True, right_index=True, how='left'\n  1325â†’)\n  1326â†’derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ¯”ä¾‹'] = derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'].div(\n  1327â†’    derivative_zhuanhu_df['å‡€èµ„äº§(äº¿)'], axis=0\n  1328â†’) / 100000000\n  1329â†’derivative_zhuanhu_df.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)\n  1330â†’derivative_zhuanhu_df.to_excel(writer, sheet_name='11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”')\n  1331â†’\n  1332â†’# 11.6 éæ ‡æŒä»“å æ¯”\n  1333â†’print(\"[11.6] ç”ŸæˆæŠ¥è¡¨: 11.6éæ ‡æŒä»“å æ¯”...\")\n  1334â†’feibiao_df = Chicang_df[Chicang_df.apply(\n  1335â†’    lambda x: (x['æ–°ç‰ˆèµ„äº§å¤§ç±»'] in ['éæ ‡å‡†åŒ–å€ºæƒç±»èµ„äº§', 'ç†è´¢ç›´æ¥èèµ„å·¥å…·', 'æ–°å¢å¯æŠ•èµ„èµ„äº§']) or\n  1336â†’              (x['æ–°ç‰ˆèµ„äº§å°ç±»'] in ['åŒä¸šå€Ÿæ¬¾']), axis=1\n  1337â†’)]\n  1338â†’feibiao_pct_df = pd.DataFrame(feibiao_df.groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum())\n  1339â†’feibiao_pct_df = feibiao_pct_df.merge(\n  1340â†’    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n  1341â†’    left_index=True, right_index=True, how='left'\n  1342â†’)\n  1343â†’feibiao_pct_df['éæ ‡å æ¯”'] = feibiao_pct_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] / feibiao_pct_df['å‡€èµ„äº§(äº¿)'] / 100000000\n  1344â†’feibiao_pct_df.to_excel(writer, sheet_name='11.6éæ ‡æŒä»“å æ¯”')\n  1345â†’\n  1346â†’# é»„é‡‘æŒä»“\n  1347â†’print(\"[11.7] ç”ŸæˆæŠ¥è¡¨: é»„é‡‘æŒä»“...\")\n  1348â†’gold_dict = Config.GOLD_ACCOUNTS\n  1349â†’gold_ETF_bond_list = Config.GOLD_ETF\n  1350â†’\n  1351â†’\n  1352â†’def get_zhdata(zhuanzhai_dict, ETF_bond_list):\n  1353â†’    \"\"\"è·å–é»„é‡‘æŒä»“æ•°æ®\"\"\"\n  1354â†’    concat_zhuanzhai_series = []\n  1355â†’    zhuanzhai_list = []\n  1356â†’    for shortname in zhuanzhai_dict.keys():\n  1357â†’        concat_zhuanzhai_series.append(pd.Series(\n  1358â†’            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1359â†’            name=shortname + '-é‡‘é¢'\n  1360â†’        ))\n  1361â†’        zhuanzhai_list += [shortname]\n  1362â†’    concat_zhuanzhai_series.append(pd.Series(\n  1363â†’        Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1364â†’        name='é»„é‡‘ETF-é‡‘é¢'\n  1365â†’    ))\n  1366â†’    zhuanzhai_list += ['é»„é‡‘ETF']\n  1367â†’    concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)\n  1368â†’    concat_zhuanzhai_df = concat_zhuanzhai_df.merge(\n  1369â†’        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n  1370â†’        left_index=True, right_index=True, how='left'\n  1371â†’    )\n  1372â†’    concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(\n  1373â†’        concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0\n  1374â†’    )\n  1375â†’    concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]\n  1376â†’    result_df_11_1_1 = pd.concat([\n  1377â†’        concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n  1378â†’        concat_zhuanzhai_pct_df\n  1379â†’    ], axis=1)\n  1380â†’    return result_df_11_1_1\n  1381â†’\n  1382â†’\n  1383â†’hg_asset = get_zhdata(gold_dict, gold_ETF_bond_list)\n  1384â†’hg_asset[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-é‡‘é¢', 'é»„é‡‘ETF-é‡‘é¢',\n  1385â†’          'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-å æ¯”', 'é»„é‡‘ETF-å æ¯”']].to_excel(writer, sheet_name='é»„é‡‘æŒä»“')\n  1386â†’\n  1387â†’# æƒç›Šä¸“æˆ·æŒä»“\n  1388â†’print(\"[11.8] ç”ŸæˆæŠ¥è¡¨: æƒç›Šä¸“æˆ·æŒä»“...\")\n  1389â†’equity_dict = Config.EQUITY_ACCOUNTS\n  1390â†’\n  1391â†’\n  1392â†’def get_equity_data(equity_dict):\n  1393â†’    \"\"\"è·å–æƒç›Šä¸“æˆ·æŒä»“æ•°æ®\"\"\"\n  1394â†’    concat_equity_series = []\n  1395â†’    equity_list = []\n  1396â†’    for shortname in equity_dict.keys():\n  1397â†’        concat_equity_series.append(pd.Series(\n  1398â†’            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == equity_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n  1399â†’            name=shortname + '-é‡‘é¢'\n  1400â†’        ))\n  1401â†’        equity_list += [shortname]\n  1402â†’    concat_equity_df = pd.concat(concat_equity_series, axis=1)\n  1403â†’    concat_equity_df = concat_equity_df.merge(\n  1404â†’        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n  1405â†’        left_index=True, right_index=True, how='left'\n  1406â†’    )\n  1407â†’    concat_equity_pct_df = concat_equity_df[[x + '-é‡‘é¢' for x in equity_list]].div(\n  1408â†’        concat_equity_df['å‡€èµ„äº§(äº¿)'], axis=0\n  1409â†’    )\n  1410â†’    concat_equity_pct_df.columns = [x + '-å æ¯”' for x in equity_list]\n  1411â†’    result_df = pd.concat([\n  1412â†’        concat_equity_df[[x + '-é‡‘é¢' for x in equity_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n  1413â†’        concat_equity_pct_df\n  1414â†’    ], axis=1)\n  1415â†’    return result_df\n  1416â†’\n  1417â†’\n  1418â†’equity_asset = get_equity_data(equity_dict)\n  1419â†’output_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»'] + \\\n  1420â†’              [x + suffix for x in equity_dict.keys() for suffix in ['-é‡‘é¢', '-å æ¯”']]\n  1421â†’equity_asset[output_cols].to_excel(writer, sheet_name='æƒç›Šä¸“æˆ·æŒä»“')\n  1422â†’\n  1423â†’# å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ\n  1424â†’print(\"[11.9] ç”ŸæˆæŠ¥è¡¨: å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ...\")\n  1425â†’ggcc = data_loader.load_public_strategy()\n  1426â†’wwgl = data_loader.load_weiwai_overview()\n  1427â†’chicangsum = Chicang_df.groupby('å€ºåˆ¸ç®€ç§°')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000\n  1428â†’ggcc = pd.merge(ggcc, wwgl, left_on='èµ„äº§åç§°', right_on='å§”å¤–èµ„äº§', how='left')\n  1429â†’ggcc = pd.merge(ggcc, chicangsum, left_on='èµ„äº§åç§°', right_index=True, how='left')\n  1430â†’ggcc = ggcc.rename(columns={'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼': 'å¤šèµ„äº§æŠ•æŒä»“-äº¿', \"æœ€æ–°è§„æ¨¡\": 'ä¸“æˆ·è§„æ¨¡'})\n  1431â†’ggcc['å¤šèµ„äº§æŒä»“å æ¯”'] = ggcc['å¤šèµ„äº§æŠ•æŒä»“-äº¿'] / ggcc['ä¸“æˆ·è§„æ¨¡']\n  1432â†’ggcc[['æ‰€å±éƒ¨é—¨', 'ç­–ç•¥æ ‡ç­¾', 'èµ„äº§ä»£ç ', 'èµ„äº§åç§°', 'èµ„äº§ç®€ç§°', 'ä¸“æˆ·è§„æ¨¡',\n  1433â†’      'å¤šèµ„äº§æŠ•æŒä»“-äº¿', 'å¤šèµ„äº§æŒä»“å æ¯”']].to_excel(writer, sheet_name='å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ')\n  1434â†’\n  1435â†’\n  1436â†’# ==============================================================================\n  1437â†’# ç¬¬åä¸ƒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å‡€å€¼æ³¢åŠ¨ä¸ç ´å‡€\n  1438â†’# ==============================================================================\n  1439â†’\n  1440â†’# ------------------------------------------------------------------------------\n  1441â†’# æŠ¥è¡¨12: å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•\n  1442â†’# ------------------------------------------------------------------------------\n  1443â†’print(\"\\n[12] ç”ŸæˆæŠ¥è¡¨: 12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•...\")\n  1444â†’\n  1445â†’date = zhoubao_date\n  1446â†’yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(date), index_col=0))\n  1447â†’part_nav_df = data_transposition.loc[:, yunzuogailan_now.index].tail(7 + 1)\n  1448â†’rweek = pd.DataFrame(\n  1449â†’    (part_nav_df.tail(1).values / part_nav_df.head(1).values - 1) * 10000,\n  1450â†’    columns=part_nav_df.columns, index=['å‘¨å‡€å€¼å˜åŒ–bp']\n  1451â†’).T\n  1452â†’rweek_average = ((part_nav_df / part_nav_df.shift(1) - 1) * 10000).mean(axis=0)\n  1453â†’nav_change_df = pd.concat([rweek, rweek_average], axis=1)\n  1454â†’nav_change_df.columns = ['å‘¨å‡€å€¼å˜åŒ–bp', 'å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']\n  1455â†’nav_change_df_keep = nav_change_df[\n  1456â†’    (abs(nav_change_df['å‘¨å‡€å€¼å˜åŒ–bp']) >= 20) | (abs(nav_change_df['å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']) >= 3)\n  1457â†’]\n  1458â†’\n  1459â†’result_df_12 = nav_change_df_keep.merge(\n  1460â†’    yunzuogailan_now[['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',\n  1461â†’                      'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©',\n  1462â†’                      'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']],\n  1463â†’    left_index=True, right_index=True, how='left'\n  1464â†’)\n  1465â†’result_df_12.sort_values('å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp', ascending=True, inplace=True)\n  1466â†’result_df_12.to_excel(writer, sheet_name='12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•')\n  1467â†’\n  1468â†’\n  1469â†’# ==============================================================================\n  1470â†’# ç¬¬åå…«éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å‘¨æœŸåˆ†å¸ƒ\n  1471â†’# ==============================================================================\n  1472â†’\n  1473â†’# ------------------------------------------------------------------------------\n  1474â†’# æŠ¥è¡¨13: ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡\n  1475â†’# ------------------------------------------------------------------------------\n  1476â†’print(\"\\n[13] ç”ŸæˆæŠ¥è¡¨: 13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡...\")\n  1477â†’\n  1478â†’now = zhoubao_date\n  1479â†’yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\n  1480â†’yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))\n  1481â†’yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n  1482â†’\n  1483â†’\n  1484â†’def get_zhouqi_scale_df(df_f, name: str):\n  1485â†’    mid_df = df_f.copy()\n  1486â†’    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)\n  1487â†’    result_df = pd.concat([\n  1488â†’        mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].sum(),\n  1489â†’        mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].count()\n  1490â†’    ], axis=1)\n  1491â†’    result_df.columns = [name + x for x in ['è§„æ¨¡(äº¿)', 'æ•°é‡']]\n  1492â†’    return result_df\n  1493â†’\n  1494â†’\n  1495â†’final_df = pd.concat([get_zhouqi_scale_df(yunzuogailan_lasty, '2024'), get_zhouqi_scale_df(yunzuogailan_now, 'æœ€æ–°')], axis=1)\n  1496â†’final_df['vlookupæ ‡ç­¾'] = [''.join(list(x)) for x in final_df.index]\n  1497â†’keep_columns = ['vlookupæ ‡ç­¾'] + list(final_df.columns[:-1])\n  1498â†’final_df[keep_columns].to_excel(writer, sheet_name='13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡')\n  1499â†’\n  1500â†’# ------------------------------------------------------------------------------\n  1501â†’# æŠ¥è¡¨14: ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª\n  1502â†’# ------------------------------------------------------------------------------\n  1503â†’print(\"\\n[14] ç”ŸæˆæŠ¥è¡¨: 14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª...\")\n  1504â†’\n  1505â†’now = zhoubao_date\n  1506â†’month7 = '20240731'\n  1507â†’lasty = '20241231'\n  1508â†’\n  1509â†’yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\n  1510â†’yunzuogailan_month7 = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(month7), index_col=0))\n  1511â†’yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n  1512â†’\n  1513â†’\n  1514â†’def match_kehuzhouqi_narrowed(x: str):\n  1515â†’    if x == 'å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“':\n  1516â†’        return 'å®¢æˆ·å‘¨æœŸ'\n  1517â†’    elif x == 'å®¢æˆ·é”å®šæœŸ':\n  1518â†’        return 'æœ€çŸ­æŒæœ‰æœŸ'\n  1519â†’    else:\n  1520â†’        return ''\n  1521â†’\n  1522â†’\n  1523â†’def get_kehuzhouqi_narrowed_scale(my_df, col_str: str):\n  1524â†’    mid_df = my_df[my_df['äº§å“æ¨¡æ¿ä¸­æ–‡åç§°'].map(lambda x: x in ['å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“', 'å®¢æˆ·é”å®šæœŸ'])]\n  1525â†’    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)\n  1526â†’    result_df = pd.pivot_table(mid_df, index=['å‘¨æœŸåŒºé—´'], columns='äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)\n  1527â†’    result_df.columns = [col_str + match_kehuzhouqi_narrowed(x[1]) for x in list(result_df.columns)]\n  1528â†’    return result_df\n  1529â†’\n  1530â†’\n  1531â†’result_df_14 = pd.concat([\n  1532â†’    get_kehuzhouqi_narrowed_scale(yunzuogailan_lasty, '2024å¹´åº•'),\n  1533â†’    get_kehuzhouqi_narrowed_scale(yunzuogailan_month7, '2024å¹´7æœˆ'),\n  1534â†’    get_kehuzhouqi_narrowed_scale(yunzuogailan_now, 'æœ€æ–°')\n  1535â†’], axis=1)\n  1536â†’result_df_14.to_excel(writer, sheet_name='14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª')\n  1537â†’\n  1538â†’\n  1539â†’# ==============================================================================\n  1540â†’# ç¬¬åä¹éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å¸‚åœºæŒ‡æ•°æ”¶ç›Š\n  1541â†’# ==============================================================================\n  1542â†’\n  1543â†’# ------------------------------------------------------------------------------\n  1544â†’# æŠ¥è¡¨15: å¸‚åœºæŒ‡æ•°æ”¶ç›Š\n  1545â†’# ------------------------------------------------------------------------------\n  1546â†’print(\"\\n[15] ç”ŸæˆæŠ¥è¡¨: 15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š...\")\n  1547â†’\n  1548â†’wind_code_list = Config.MARKET_INDEX_CODES\n  1549â†’result_list = []\n  1550â†’\n  1551â†’for deltadays in [30, 30 * 3, 30 * 6, 365]:\n  1552â†’    startDate = ''.join(str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=deltadays)).date()).split('-'))\n  1553â†’    returns = market_data.get_index_returns(wind_code_list, startDate, zhoubao_date)\n  1554â†’    result_list.append(np.array(returns) * 365 / deltadays)\n  1555â†’\n  1556â†’# è®¡ç®—ä»Šå¹´ä»¥æ¥å¹´åŒ–æ”¶ç›Š\n  1557â†’deltadays = (datetime.strptime(zhoubao_date, '%Y%m%d') - datetime.strptime('20251231', '%Y%m%d')).days\n  1558â†’returns = market_data.get_index_returns(wind_code_list, '20251231', zhoubao_date)\n  1559â†’result_list.append(np.array(returns) * 365 / deltadays)\n  1560â†’\n  1561â†’# è®¡ç®—è¿‘1æœˆæ³¢åŠ¨ç‡\n  1562â†’start_1m = ''.join(str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=30)).date()).split('-'))\n  1563â†’vol_1m = market_data.get_index_volatility(wind_code_list, start_1m, zhoubao_date)\n  1564â†’result_list.append(np.array(vol_1m) if vol_1m else np.array([None] * len(wind_code_list)))\n  1565â†’\n  1566â†’# è®¡ç®—ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡\n  1567â†’vol_ytd = market_data.get_index_volatility(wind_code_list, '20251231', zhoubao_date)\n  1568â†’result_list.append(np.array(vol_ytd) if vol_ytd else np.array([None] * len(wind_code_list)))\n  1569â†’\n  1570â†’result_list.append(np.array(market_data.get_index_names(wind_code_list)))\n  1571â†’result_df = pd.DataFrame(result_list).T\n  1572â†’result_df.index = wind_code_list\n  1573â†’result_df.columns = [\n  1574â†’    'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', '2026å¹´å¹´åŒ–æ”¶ç›Šç‡',\n  1575â†’    'è¿‘1æœˆæ³¢åŠ¨ç‡', 'ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡', 'æŒ‡æ•°ç®€ç§°'\n  1576â†’]\n  1577â†’result_df.to_excel(writer, sheet_name='15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š')\n  1578â†’\n  1579â†’\n  1580â†’# ==============================================================================\n  1581â†’# ç¬¬äºŒåéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - ç ´å‡€ç»“æœ\n  1582â†’# ==============================================================================\n  1583â†’\n  1584â†’# ------------------------------------------------------------------------------\n  1585â†’# æŠ¥è¡¨: ç ´å‡€ç»“æœ\n  1586â†’# ------------------------------------------------------------------------------\n  1587â†’print(\"\\n[16] ç”ŸæˆæŠ¥è¡¨: ç ´å‡€ç»“æœ...\")\n  1588â†’\n  1589â†’nav_date = yunzuogailan_date\n  1590â†’yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(yunzuogailan_date), index_col=0))\n  1591â†’yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] = [data_transposition.loc[nav_date, x] for x in yunzuogailan_now.index]\n  1592â†’yunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] = [\n  1593â†’    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(7), x] for x in yunzuogailan_now.index\n  1594â†’]\n  1595â†’yunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] = [\n  1596â†’    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(int(nav_date[-2:])), x] for x in yunzuogailan_now.index\n  1597â†’]\n  1598â†’pojing_df = yunzuogailan_now[yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] < 1].copy()\n  1599â†’\n  1600â†’pojing_df['è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] - 1\n  1601â†’pojing_df['è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] - 1\n  1602â†’pojing_df['æ£€æµ‹æ—¶ç‚¹'] = nav_date\n  1603â†’pojing_df['äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰'] = pojing_df['å‡€èµ„äº§(äº¿)'] / pojing_df['å•ä½å‡€å€¼']\n  1604â†’pojing_df = pojing_df.reset_index()\n  1605â†’pojing_df_final = pojing_df[\n  1606â†’    ['æ£€æµ‹æ—¶ç‚¹', 'äº§å“ç®€ç§°', 'äº§å“ä»£ç ', 'äº§å“ç»ç†', 'äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰', 'åˆ°æœŸæ—¥', 'ç´¯ç§¯å‡€å€¼', 'è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–', 'è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–']\n  1607â†’]\n  1608â†’quant = ['ç‹æµ©', 'å¼ é›…å©•', 'å­™æ–°å']\n  1609â†’\n  1610â†’\n  1611â†’def manager_in_or_not_count(s: str, y: list):\n  1612â†’    sum_here = 0\n  1613â†’    for mid_y in y:\n  1614â†’        if mid_y in s:\n  1615â†’            sum_here += 1\n  1616â†’    return 1 if sum_here > 0 else 0\n  1617â†’\n  1618â†’\n  1619â†’pojing_df_final = pojing_df_final[pojing_df_final['äº§å“ç»ç†'].map(lambda x: manager_in_or_not_count(x, quant)) == 0]\n  1620â†’pojing_df_final.to_excel(writer, sheet_name='ç ´å‡€ç»“æœ')\n  1621â†’\n  1622â†’\n  1623â†’# ==============================================================================\n  1624â†’# ç¬¬äºŒåä¸€éƒ¨åˆ†ï¼šç”Ÿæˆæ€»ç»“æ–‡å­—\n  1625â†’# ==============================================================================\n  1626â†’\n  1627â†’# ------------------------------------------------------------------------------\n  1628â†’# æŠ¥è¡¨: æ€»ç»“æ–‡å­—ï¼ˆAIç”Ÿæˆï¼‰\n  1629â†’# ------------------------------------------------------------------------------\n  1630â†’print(\"\\n[17] ç”ŸæˆæŠ¥è¡¨: æ€»ç»“æ–‡å­—ï¼ˆAIç”Ÿæˆï¼‰...\")\n  1631â†’\n  1632â†’# ä½¿ç”¨configä¸­çš„promptæ¨¡æ¿ç”Ÿæˆæ€»ç»“æ–‡å­—\n  1633â†’prompt_zs = Config.PROMPT_ZHONGSHOU.format(\n  1634â†’    date=yunzuogailan_date,\n  1635â†’    data=round(result_9.sum(axis=0), 2)\n  1636â†’)\n  1637â†’\n  1638â†’prompt_gm = Config.PROMPT_GUIMO.format(\n  1639â†’    date=yunzuogailan_date,\n  1640â†’    channel_data=round(Channel_result1.sum(axis=0), 0),\n  1641â†’    series_data=round(result_3.astype(float).sum(axis=0), 0)\n  1642â†’)\n  1643â†’\n  1644â†’daoqi_summary = Config.PROMPT_DAOQI.format(\n  1645â†’    total=result_df_10_2['å‡€èµ„äº§(äº¿)'].sum(),\n  1646â†’    fengbi=result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum(),\n  1647â†’    dingkai=result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()\n  1648â†’)\n  1649â†’\n  1650â†’guimo_summary = get_wenzi_result(prompt_gm)\n  1651â†’zhongshou_summary = get_wenzi_result(prompt_zs)\n  1652â†’\n  1653â†’wenzi = {'åˆ°æœŸæ–‡å­—': daoqi_summary, 'ä¸­æ”¶æ–‡å­—': zhongshou_summary, 'è§„æ¨¡æ–‡å­—': guimo_summary}\n  1654â†’wenzidf = pd.DataFrame([wenzi]).T.rename(columns={0: 'æ–‡å­—'})\n  1655â†’wenzidf.to_excel(writer, sheet_name='æ€»ç»“æ–‡å­—')\n  1656â†’\n  1657â†’\n  1658â†’# ==============================================================================\n  1659â†’# ç¬¬äºŒåäºŒéƒ¨åˆ†ï¼šä¿å­˜å¹¶å…³é—­\n  1660â†’# ==============================================================================\n  1661â†’\n  1662â†’writer.close()\n  1663â†’\n  1664â†’print(\"\\n\" + \"=\" * 60)\n  1665â†’print(\"âœ… å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆå®Œæˆï¼\")\n  1666â†’print(f\"   è¾“å‡ºæ–‡ä»¶: {Config.get_current_output_writer(date)}\")\n  1667â†’print(\"=\" * 60)\n  1668â†’"}]},"uuid":"00b512bd-3d2f-4596-85c7-54a38782f8e6","timestamp":"2026-02-04T09:50:28.936Z","toolUseResult":{"type":"update","filePath":"/Users/fanshengxia/Desktop/å‘¨æŠ¥V2/å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆ.py","content":"\"\"\"\nå‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆè„šæœ¬\n\nè¯¥è„šæœ¬æ˜¯å‘¨æŠ¥ç”Ÿæˆç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£ï¼š\n1. åŠ è½½äº§å“å‡€å€¼ã€è¿ä½œæ¦‚è§ˆã€æ¸ é“ä¿æœ‰é‡ç­‰æ•°æ®\n2. è®¡ç®—å„ç±»ä¸šç»©æŒ‡æ ‡å’Œç»Ÿè®¡æ•°æ®\n3. ç”Ÿæˆå¤šä¸ªåˆ†ææŠ¥è¡¨åˆ°Excelè¾“å‡ºæ–‡ä»¶\n4. è°ƒç”¨AIç”Ÿæˆæ€»ç»“æ–‡å­—\n\nè¾“å‡ºExcelåŒ…å«ä»¥ä¸‹å·¥ä½œè¡¨ï¼š\n- 1ã€åˆ†æ¸ é“ä½™é¢\n- æ¸ é“æ˜ç»†\n- 2ã€äº§å“è§„æ¨¡\n- 3ã€æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–\n- æœ¬å‘¨æ–°å‘äº§å“\n- å¾…å”®äº§å“\n- ç³»åˆ—äº§å“ä¸šç»©ï¼ˆè´¹åå¹³å‡/åŠ æƒã€è´¹å‰å¹³å‡/åŠ æƒï¼‰\n- 5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°\n- æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡\n- æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†\n- 8.èµ„äº§å¤§è¡¨\n- 9.ä¸­æ”¶ç›‘æ§\n- 10.äº§å“åˆ°æœŸæƒ…å†µ\n- 11.å„ç±»æŒä»“æ˜ç»†\n- 12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•\n- 13-14.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡\n- 15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š\n- ç ´å‡€ç»“æœ\n- æ€»ç»“æ–‡å­—\n\"\"\"\n\n# ==============================================================================\n# ç¬¬ä¸€éƒ¨åˆ†ï¼šå¯¼å…¥ä¾èµ–\n# ==============================================================================\n\nimport os\nimport pandas as pd\nimport numpy as np\nfrom datetime import datetime, timedelta, date\nimport copy\nimport warnings\nwarnings.filterwarnings(\"ignore\")\n\n# å¯¼å…¥é¡¹ç›®æ¨¡å—\nfrom config import Config\nfrom config import *  # å‘åå…¼å®¹ï¼Œå¯¼å…¥å¸¸ç”¨å˜é‡\nfrom utils import *\nfrom data_validator import DataValidator, safe_read_excel, validate_critical_paths\nfrom market_data_provider import MarketDataProvider\nfrom load_data import (\n    DataLoader,\n    map_product_xingtai,\n    get_zhaoshang_label,\n    get_qudao_label_detail,\n    del_Innovation_department\n)\nfrom openai import OpenAI\n\n\n# ==============================================================================\n# ç¬¬äºŒéƒ¨åˆ†ï¼šåˆå§‹åŒ–\n# ==============================================================================\n\nprint(\"=\" * 60)\nprint(\"ğŸš€ å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆ - åˆå§‹åŒ–\")\nprint(\"=\" * 60)\n\n# åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨\ndata_loader = DataLoader()\n\n# åˆå§‹åŒ–å¸‚åœºæ•°æ®æä¾›è€…ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰\nmarket_data = MarketDataProvider.get_instance()\n\n# åˆå§‹åŒ–æ•°æ®éªŒè¯å™¨\nvalidator = DataValidator(log_errors=True)\n\n# éªŒè¯å…³é”®è·¯å¾„\nprint(\"\\nğŸ” éªŒè¯å…³é”®æ•°æ®è·¯å¾„...\")\npath_validation = validate_critical_paths(Config)\nif not path_validation['is_valid']:\n    print(\"âŒ å…³é”®è·¯å¾„éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®ç›®å½•ç»“æ„\")\n    for error in path_validation['errors']:\n        print(f\"   - {error}\")\n\n\n# ==============================================================================\n# ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¾…åŠ©å‡½æ•°å®šä¹‰\n# ==============================================================================\n\ndef get_wenzi_result(prompt: str) -> str:\n    \"\"\"è°ƒç”¨DeepSeek APIç”Ÿæˆæ–‡å­—\"\"\"\n    client = OpenAI(api_key=Config.DEEPSEEK_API_KEY, base_url=Config.DEEPSEEK_BASE_URL)\n    response = client.chat.completions.create(\n        model=Config.DEEPSEEK_MODEL,\n        messages=[\n            {\"role\": \"system\", \"content\": \"You are a helpful assistant\"},\n            {\"role\": \"user\", \"content\": prompt},\n        ],\n        stream=False\n    )\n    return response.choices[0].message.content\n\n\ndef rank_by_sort(my_df: pd.DataFrame, rank_def: list) -> pd.DataFrame:\n    \"\"\"æŒ‰æŒ‡å®šé¡ºåºå¯¹DataFrameç´¢å¼•æ’åº\"\"\"\n    my_df = my_df.copy()\n    actual = list(my_df.index)\n    new_order = [x for x in rank_def if x in actual] + [x for x in actual if x not in rank_def]\n    order_map = {val: i for i, val in enumerate(new_order)}\n    my_df['__order__'] = my_df.index.map(order_map).fillna(len(new_order))\n    my_df = my_df.sort_values('__order__').drop(columns='__order__')\n    return my_df\n\n\ndef full_category_or_not(df_def: pd.DataFrame, rank_def: list) -> pd.DataFrame:\n    \"\"\"åˆ¤æ–­å“ç±»Indexæ˜¯å¦é½å…¨ï¼Œè¡¥å……ç¼ºå¤±çš„å“ç±»\"\"\"\n    df_def = df_def.copy()\n    for x in rank_def:\n        if x not in df_def.index:\n            df_def.loc[x, :] = None\n    return df_def\n\n\ndef manager_in_or_not(s: str, y: list) -> bool:\n    \"\"\"åˆ¤æ–­æŠ•èµ„ç»ç†æ˜¯å¦åœ¨æŒ‡å®šåˆ—è¡¨ä¸­\"\"\"\n    if pd.isnull(s):\n        return False\n    for mid_y in y:\n        if mid_y in s:\n            return True\n    return False\n\n\ndef clear_manager_name(s: str) -> str:\n    \"\"\"æ¸…ç†æŠ•èµ„ç»ç†åç§°ï¼Œåªä¿ç•™éƒ¨é—¨å†…ç»ç†\"\"\"\n    first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦', 'æä½³èˆª', \"è‹æ–‡æ´¥\", \"å¤å‡¡ç››\", \"é»„äº¦å°§\"]\n    second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ', \"ç½—è°¨æ·±\"]\n    third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°', 'å»–ç‚¯è‡£']\n    merge_s = []\n    for mid_s in s.split(','):\n        if mid_s in first + second + third:\n            merge_s.append(mid_s)\n    return ','.join(merge_s)\n\n\ndef adjust_manager_aum(mid_data: pd.DataFrame) -> pd.DataFrame:\n    \"\"\"è°ƒæ•´å¤šæŠ•èµ„ç»ç†å…±ç®¡äº§å“çš„è§„æ¨¡åˆ†é…\"\"\"\n    final_mid_data = mid_data.copy()\n    final_mid_data['åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data['å‡€èµ„äº§(äº¿)']\n    final_mid_data['åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1\n\n    new_rows = []\n    for indx in mid_data.index:\n        mng_list = mid_data.loc[indx, 'äº§å“ç»ç†'].split(',')\n        if len(mng_list) > 1:\n            i = 0\n            for mng in mng_list:\n                if i == 0:\n                    final_mid_data.loc[indx, 'äº§å“ç»ç†'] = mng\n                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] / 2\n                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1 / len(mng_list)\n                    i += 1\n                else:\n                    mid_series = final_mid_data.loc[indx].copy()\n                    mid_series['äº§å“ç»ç†'] = mng\n                    new_rows.append(pd.DataFrame(mid_series).T)\n\n    if new_rows:\n        final_mid_data = pd.concat([final_mid_data] + new_rows, ignore_index=False)\n\n    return final_mid_data\n\n\ndef get_scaleandnum_by_sort_manager(my_df: pd.DataFrame) -> pd.DataFrame:\n    \"\"\"åŒ¹é…å­æ¯åˆ†ç±»å…³ç³»å¹¶è°ƒæ•´æŠ•èµ„ç»ç†\"\"\"\n    Parent_sort = data_loader.load_parent_sort(['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»'])\n    my_df = my_df.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n    my_df['äº§å“ç»ç†'] = my_df['äº§å“ç»ç†'].map(clear_manager_name)\n    return adjust_manager_aum(my_df)\n\n\ndef get_yejijizhunxiaxian(x: str) -> str:\n    \"\"\"è·å–ä¸šç»©åŸºå‡†ä¸‹é™\"\"\"\n    if not pd.isnull(x):\n        try:\n            float(x.split('-')[0][:-1])\n            return x.split('-')[0]\n        except ValueError:\n            return \"\"\n    else:\n        return x\n\n\ndef get_zhouqi_scale(x: int) -> str:\n    \"\"\"æ ¹æ®å‘¨æœŸå¤©æ•°è¿”å›å‘¨æœŸåŒºé—´æ ‡ç­¾\"\"\"\n    if x < 30 * 7:\n        return '<6M'\n    elif (x >= 30 * 7) and (x < 13 * 30):\n        return '6M-1Y'\n    elif x >= 13 * 30:\n        return '>1Y'\n    else:\n        return 'error'\n\n\ndef get_zhouqi_scale_v2(x: int) -> str:\n    \"\"\"æ ¹æ®å‘¨æœŸå¤©æ•°è¿”å›å‘¨æœŸåŒºé—´æ ‡ç­¾ï¼ˆè¯¦ç»†ç‰ˆï¼‰\"\"\"\n    if x == 1:\n        return 'æ—¥ç›ˆ'\n    elif x < 30:\n        return '<1M'\n    elif x < 31 * 3:\n        return '1M-3M'\n    elif x < 31 * 6:\n        return '3M-6M'\n    elif x < 12 * 31:\n        return '6M-1Y'\n    elif x >= 12 * 31:\n        return '>1Y'\n    else:\n        return 'error'\n\n\n# ==============================================================================\n# ç¬¬å››éƒ¨åˆ†ï¼šåŠ è½½åŸºç¡€æ•°æ®\n# ==============================================================================\n\nprint(\"\\n\" + \"=\" * 60)\nprint(\"ğŸ“Š åŠ è½½åŸºç¡€æ•°æ®...\")\nprint(\"=\" * 60)\n\n# 4.1 åŠ è½½äº§å“å‡€å€¼æ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰\nprint(\"\\n[4.1] åŠ è½½äº§å“å‡€å€¼æ•°æ®...\")\ndata, data_transposition = data_loader.load_nav_data()\ndata_transposition.replace(0, np.nan, inplace=True)\n\n# 4.2 åŠ è½½DAPäº§å“ä¿¡æ¯è¡¨\nprint(\"\\n[4.2] åŠ è½½DAPäº§å“ä¿¡æ¯è¡¨...\")\nProduct_information_df_DAP = data_loader.load_product_info_dap()\n\n# 4.3 åŠ è½½å“ç±»åˆ†ç±»æ•°æ®\nprint(\"\\n[4.3] åŠ è½½å“ç±»åˆ†ç±»æ•°æ®...\")\nclassification_df = data_loader.load_classification_df()\nclassification_ye = classification_df['å¤šèµ„äº§å“ç±»']\n\n# 4.4 åŠ è½½é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»\nprint(\"\\n[4.4] åŠ è½½é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»...\")\nParent_sort = data_loader.load_parent_sort(['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»'])\n\n\n# ==============================================================================\n# ç¬¬äº”éƒ¨åˆ†ï¼šç”Ÿæˆäº§å“è¿ä½œæ¦‚è§ˆæ•°æ®\n# ==============================================================================\n\ndef get_yunzuogailan(yunzuogailan_date: str) -> None:\n    \"\"\"\n    ç”Ÿæˆå¹¶ä¿å­˜äº§å“è¿ä½œæ¦‚è§ˆæ•°æ®\n\n    å‚æ•°ï¼š\n        yunzuogailan_date: è¿ä½œæ¦‚è§ˆæ—¥æœŸ (YYYYMMDDæ ¼å¼)\n    \"\"\"\n    print(f\"\\n[5.0] ç”Ÿæˆäº§å“è¿ä½œæ¦‚è§ˆæ•°æ® - {yunzuogailan_date}\")\n\n    # åŠ è½½åŸå§‹æ•°æ®\n    yunzuogailan_before = data_loader.load_yunzuogailan_raw()\n    Baoyou_df = data_loader.load_baoyou_data()\n\n    # åŒ¹é…ç†è´¢äº§å“çš„å­—æ¯ä»£ç \n    yunzuogailan_before['æ¯äº§å“ä»£ç '] = yunzuogailan_before['äº§å“ç®€ç§°'].map(\n        lambda x: yunzuogailan_before[yunzuogailan_before['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]\n    )\n    yunzuogailan_before = yunzuogailan_before[~(yunzuogailan_before['å•ä½å‡€å€¼'].isnull())]\n\n    # è·å–ç¾å…ƒäº§å“æ¸…å•\n    Dollar_product_list = list(\n        set(Product_information_df_DAP[Product_information_df_DAP['å¸ç§'] == 'ç¾å…ƒ'].index).intersection(\n            yunzuogailan_before.index\n        )\n    )\n    yunzuogailan_before['å‡€èµ„äº§(äº¿)'] = yunzuogailan_before.apply(\n        lambda x: Baoyou_df.loc[x.name]['ä¿æœ‰è§„æ¨¡'].sum() / 100000000 if x.name in Dollar_product_list else x['å‡€èµ„äº§(äº¿)'],\n        axis=1\n    )\n    yunzuogailan_before = yunzuogailan_before.merge(\n        Product_information_df_DAP[['å¸ç§']], left_index=True, right_index=True, how='left'\n    )\n\n    # åŒ¹é…å“ç±»\n    yunzuogailan_before['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(\n        lambda x: classification_ye[x] if x in classification_ye.index else np.nan\n    )\n    yunzuogailan_before['äº§å“éƒ¨å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(\n        lambda x: classification_df['äº§å“éƒ¨å“ç±»'][x] if x in classification_ye.index else np.nan\n    )\n\n    # åŒ¹é…äº§å“è¿ä½œå‘¨æœŸ\n    patern = pd.Series(Product_information_df_DAP.apply(map_product_xingtai, axis=1), name='å½¢æ€')\n\n    # åˆå¹¶ä¿æœ‰é‡æ•°æ®\n    Baoyou_df_merge = Baoyou_df.merge(yunzuogailan_before['æ¯äº§å“ä»£ç '], left_index=True, right_index=True, how='left')\n    yunzuogailan_before = yunzuogailan_before.merge(patern, left_index=True, right_index=True, how='left')\n    yunzuogailan_before = yunzuogailan_before.merge(\n        Product_information_df_DAP[['å‘¨æœŸå¤©æ•°', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°']],\n        left_index=True, right_index=True, how='left'\n    )\n\n    # åŒ¹é…æ‹›å•†æ ‡ç­¾\n    Zhaoshang_label_df = pd.DataFrame(\n        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_zhaoshang_label(set(x['æ¸ é“åç§°']))),\n        columns=['æ˜¯å¦æ‹›å•†']\n    )\n    yunzuogailan_before = yunzuogailan_before.merge(Zhaoshang_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')\n\n    # åŒ¹é…æ¸ é“æ˜ç»†\n    Qudao_label_df = pd.DataFrame(\n        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_qudao_label_detail(set(x['æ¸ é“åç§°']))),\n        columns=['æ¸ é“æ˜ç»†']\n    )\n    yunzuogailan_before = yunzuogailan_before.merge(Qudao_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')\n\n    # ç‰¹æ®Šæ—¥æœŸå¤„ç†\n    if yunzuogailan_date in ['20231229', '20231231']:\n        yunzuogailan_before['äº§å“ç»ç†'] = yunzuogailan_before.apply(\n            lambda x: Product_information_df_DAP.loc[x.name, 'æ¯äº§å“æŠ•èµ„ç»ç†'], axis=1\n        )\n\n    yunzuogailan_before.rename(columns={'ç»„åˆä¹…æœŸ(å¤šèµ„äº§)': 'ç»„åˆä¹…æœŸ'}, inplace=True)\n    yunzuogailan_before.rename(columns={'ç»„åˆé™æ€(å¤šèµ„äº§)': 'ç»„åˆé™æ€'}, inplace=True)\n\n    # åˆå¹¶æ¯å­æ ‡å¿—\n    yunzuogailan_before_v2 = yunzuogailan_before.merge(\n        Product_information_df_DAP[['æ¯å­æ ‡å¿—']], left_index=True, right_index=True, how='left'\n    )\n\n    # æ ‡è®°ä¸»è¦å±•ç¤ºäº§å“\n    yunzuogailan_before_v2['ä¸»è¦å±•ç¤º'] = yunzuogailan_before_v2.apply(\n        lambda x: 'æ˜¯' if ((x['æ¯å­æ ‡å¿—'] == 'éæ¯å­äº§å“') or ('(å­1)' in x['äº§å“ç®€ç§°'])) else 'å¦', axis=1\n    )\n\n    # åˆå¹¶æ¯åˆ†ç±»\n    Parent_sort_full = pd.read_excel(\n        Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),\n        sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»',\n        index_col=0\n    )[['æ¯åˆ†ç±»']]\n    Parent_sort_full = Parent_sort_full[~Parent_sort_full.index.duplicated(keep='first')]\n\n    # é˜²å¾¡æ€§å¤„ç†\n    if yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(lambda x: isinstance(x, pd.Series)).any():\n        print(\"âš ï¸ æ£€æµ‹åˆ° 'å¤šèµ„äº§å“ç±»' åˆ—ä¸­å­˜åœ¨ Series å€¼ï¼Œå·²è‡ªåŠ¨ä¿®å¤\")\n        yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(\n            lambda s: s.dropna().iloc[0] if isinstance(s, pd.Series) and len(s.dropna()) > 0 else (\n                np.nan if isinstance(s, pd.Series) else s\n            )\n        )\n\n    yunzuogailan_before_v2 = yunzuogailan_before_v2.merge(\n        Parent_sort_full, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left'\n    )\n\n    # ä¿å­˜æ¯äº§å“ç‰ˆæœ¬\n    yunzuogailan_export = yunzuogailan_before_v2[yunzuogailan_before_v2['äº§å“ç®€ç§°'].map(lambda x: '(å­' not in x)]\n    keep_col_here = [\n        'äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',\n        'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'é”€å”®è´¹',\n        'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å‘¨æœŸå¤©æ•°', 'æ˜¯å¦æ‹›å•†', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ¯åˆ†ç±»'\n    ]\n    yunzuogailan_export = yunzuogailan_export[keep_col_here]\n    yunzuogailan_export.drop_duplicates().to_excel(Config.get_overview_parent_file(yunzuogailan_date))\n\n    # ç”Ÿæˆå¸¦å˜åŒ–æŒ‡æ ‡çš„ç‰ˆæœ¬\n    yzgl = yunzuogailan_before_v2.drop_duplicates().copy()\n    yzgl_lastw = pd.read_excel(Config.get_overview_history_file(lastw), index_col=0)\n    yzgl_lastm = pd.read_excel(Config.get_overview_history_file(lastm), index_col=0)\n\n    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastw['ç»„åˆä¹…æœŸ']\n    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['æ æ†'] - yzgl_lastw['æ æ†']\n    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastw['æƒç›Šä»“ä½']\n    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastm['ç»„åˆä¹…æœŸ']\n    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['æ æ†'] - yzgl_lastm['æ æ†']\n    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastm['æƒç›Šä»“ä½']\n\n    mu_col = [\n        'äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', '5%æµåŠ¨æ€§å®é™…æŒ‡æ ‡', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ç´¯è®¡å¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'æ æ†',\n        'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'è¡ç”Ÿå“ä»“ä½', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥',\n        'é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'æ¯äº§å“ä»£ç ', 'å¸ç§', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å½¢æ€', 'å‘¨æœŸå¤©æ•°',\n        'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ˜¯å¦æ‹›å•†', 'æ¸ é“æ˜ç»†', 'æ¯å­æ ‡å¿—', 'ä¸»è¦å±•ç¤º', 'æ¯åˆ†ç±»', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨',\n        'æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨', 'æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ', 'æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ', 'æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'\n    ]\n    yzgl[mu_col].to_excel(Config.get_overview_history_file(yunzuogailan_date))\n    print(\"   âœ… äº§å“è¿ä½œæ¦‚è§ˆæ•°æ®å·²ä¿å­˜\")\n\n\n# æ‰§è¡Œè¿ä½œæ¦‚è§ˆæ•°æ®ç”Ÿæˆ\nget_yunzuogailan(yunzuogailan_date)\n\n\n# ==============================================================================\n# ç¬¬å…­éƒ¨åˆ†ï¼šåŠ è½½å¤„ç†åçš„æ•°æ®\n# ==============================================================================\n\nprint(\"\\n[6.0] åŠ è½½å¤„ç†åçš„è¿ä½œæ¦‚è§ˆæ•°æ®...\")\nyunzuogailan_all = pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)\nChannel_df = data_loader.load_channel_data()\ndate = zhoubao_date\n\n# åˆ›å»ºè¾“å‡ºExcelå†™å…¥å™¨\nwriter = pd.ExcelWriter(Config.get_current_output_writer(date))\n\n# å®šä¹‰å“ç±»æ’åºé¡ºåº\nrank_here = [\n    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³äº«çŸ­æŒ'),\n    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³/çº¯äº«'),\n    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¼˜å…ˆè‚¡çŸ­æŒ'),\n    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¸°åˆ©/å¢ç›ˆ'),\n    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'è¡Œå¤–éæ ‡é©±åŠ¨å‹å›ºæ”¶+'),\n    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å’Œç‘BOF'),\n    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€'),\n    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'é€¸åŠ¨çŸ­æŒ'),\n    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'çµåŠ¨çŸ­æŒ'),\n    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å…´åŠ¨çŸ­æŒ'),\n    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å«æƒå®šå¼€/å°é—­'),\n    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'ESGè”å'),\n    ('å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),\n    ('å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼'),\n]\n\n\n# ==============================================================================\n# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æ¸ é“åˆ†æ\n# ==============================================================================\n\nprint(\"\\n\" + \"=\" * 60)\nprint(\"ğŸ“ˆ ç”ŸæˆæŠ¥è¡¨...\")\nprint(\"=\" * 60)\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨1: åˆ†æ¸ é“ä½™é¢\n# ------------------------------------------------------------------------------\nprint(\"\\n[1] ç”ŸæˆæŠ¥è¡¨: 1ã€åˆ†æ¸ é“ä½™é¢...\")\n\n# åŒ¹é…æ¸ é“æ•°æ®çš„å“ç±»å’Œäº§å“ç»ç†\nChannel_df['æ¯äº§å“ä»£ç '] = Channel_df['äº§å“ç®€ç§°'].map(\n    lambda x: Channel_df[Channel_df['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]\n)\nChannel_df['å¤šèµ„äº§å“ç±»'] = Channel_df['æ¯äº§å“ä»£ç '].map(\n    lambda x: classification_ye[x] if x in classification_ye.index else np.nan\n)\nChannel_df = Channel_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')\nChannel_df = Channel_df[~pd.isnull(Channel_df['äº§å“ç»ç†'])]\nChannel_df = del_Innovation_department(Channel_df)\n\n# å¤„ç†å­äº§å“æ¸ é“æ•°æ®\nChannel_df_subproduct = Channel_df[Channel_df['æ¸ é“åç§°'] != '-']\nChannel_df_subproduct['æ¸ é“-è¡Œå†…å¤–'] = Channel_df_subproduct['æ¸ é“åç§°'].map(\n    lambda x: 'è¡Œå†…' if x == 'å…´ä¸šé“¶è¡Œ' else 'è¡Œå¤–'\n)\nChannel_df_subproduct = Channel_df_subproduct.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n\n# ç”Ÿæˆåˆ†æ¸ é“ä½™é¢è¡¨\nChannel_result1 = pd.pivot_table(\n    Channel_df_subproduct,\n    index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],\n    columns='æ¸ é“-è¡Œå†…å¤–',\n    values=['ä¿æœ‰è§„æ¨¡'],\n    aggfunc=np.sum\n) / 100000000\nChannel_result1 = rank_by_sort(Channel_result1, rank_here)\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: æ¸ é“æ˜ç»†\n# ------------------------------------------------------------------------------\nprint(\"[1.1] ç”ŸæˆæŠ¥è¡¨: æ¸ é“æ˜ç»†...\")\n\nChannel_result2 = pd.pivot_table(\n    Channel_df_subproduct,\n    index=['æ¸ é“åç§°'],\n    columns='æ€»åˆ†ç±»',\n    values=['ä¿æœ‰è§„æ¨¡'],\n    aggfunc=np.sum\n) / 100000000\nChannel_result2['åˆè®¡'] = Channel_result2.sum(axis=1)\nChannel_result2 = Channel_result2.sort_values('åˆè®¡', ascending=False)\n\n# è®¡ç®—ç›¸æ¯”ä¸Šæœˆå’Œä¸Šå¹´çš„å˜åŒ–\nChannel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šæœˆ', '')] = Channel_result2[('åˆè®¡', '')] - \\\n    pd.read_excel(Config.get_output_result_file(lastm), sheet_name='æ¸ é“æ˜ç»†', index_col=0, skiprows=[1, 2])['åˆè®¡']\nChannel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šå¹´', '')] = Channel_result2[('åˆè®¡', '')] - \\\n    pd.read_excel(Config.get_output_result_file(lasty), sheet_name='æ¸ é“æ˜ç»†', index_col=0, skiprows=[1, 2])['åˆè®¡']\n\nChannel_result1.to_excel(writer, sheet_name='1ã€åˆ†æ¸ é“ä½™é¢')\nChannel_result2.to_excel(writer, sheet_name='æ¸ é“æ˜ç»†')\n\n\n# ==============================================================================\n# ç¬¬å…«éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“è§„æ¨¡\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨2: äº§å“è§„æ¨¡\n# ------------------------------------------------------------------------------\nprint(\"\\n[2] ç”ŸæˆæŠ¥è¡¨: 2ã€äº§å“è§„æ¨¡...\")\n\nnow = zhoubao_date\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\nyunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))\nyunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n\nlastm_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - get_scaleandnum_by_sort(yunzuogailan_lastm)\nlastm_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«']\nlasty_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - full_category_or_not(\n    get_scaleandnum_by_sort(yunzuogailan_lasty), rank_here\n).fillna(0)\nlasty_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']\n\ncols = ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']\nresult_3 = pd.concat([get_scaleandnum_by_sort(yunzuogailan_now), lastm_delta_df, lasty_delta_df], axis=1)[cols]\nresult_3[['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']] = result_3[\n    ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']\n].applymap(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)\nresult_3 = rank_by_sort(result_3, rank_here)\nresult_3[cols].to_excel(writer, sheet_name='2ã€äº§å“è§„æ¨¡')\n\n\n# ==============================================================================\n# ç¬¬ä¹éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - è§„æ¨¡å˜åŒ–ä¸æ–°å‘äº§å“\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨3: æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–\n# ------------------------------------------------------------------------------\nprint(\"\\n[3] ç”ŸæˆæŠ¥è¡¨: 3ã€æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–...\")\n\ndata_zhanbao = zhoubao_date\nzhanbao_df = data_loader.load_zhanbao_data()\n\nif 'äº§å“ç»ç†' not in zhanbao_df.columns:\n    zhanbao_df = zhanbao_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')\nzhanbao_df.rename(columns={'å“ç±»': 'å¤šèµ„äº§å“ç±»'}, inplace=True)\n\nzhanbao_df_1 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: not pd.isnull(x))]\nzhanbao_df_1 = del_Innovation_department(zhanbao_df_1)\nzhanbao_df_2 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: pd.isnull(x))]\nzhanbao_df = pd.concat([zhanbao_df_1, zhanbao_df_2])\n\nzhanbao_df['æ¯äº§å“ä»£ç '] = zhanbao_df.apply(lambda x: x.name if pd.isnull(x['æ¯äº§å“ä»£ç ']) else x['æ¯äº§å“ä»£ç '], axis=1)\nzhanbao_df['æ¯äº§å“ç®€ç§°'] = zhanbao_df.apply(\n    lambda x: x['äº§å“ç®€ç§°'] if pd.isnull(x['æ¯äº§å“ç®€ç§°']) else x['æ¯äº§å“ç®€ç§°'], axis=1\n)\n\nkaifang_df = zhanbao_df[\n    (zhanbao_df['å½¢æ€'] == 'å®¢æˆ·å‘¨æœŸ') | (zhanbao_df['å½¢æ€'] == 'æœ€çŸ­æŒæœ‰æœŸ') |\n    (zhanbao_df['å½¢æ€'] == 'å®šå¼€') | (zhanbao_df['å½¢æ€'] == 'æ—¥å¼€')\n]\nkaifang_df = kaifang_df.groupby('æ¯äº§å“ä»£ç ').agg({\n    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',\n    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'äº§å“ç»ç†': 'first'\n})\nkaifang_df = kaifang_df[kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(lambda x: abs(x) >= 0.05)]\nkaifang_df.sort_values(by='è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', ascending=False, inplace=True)\nkaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'] = kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(\n    lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x\n)\nkaifang_df = kaifang_df[kaifang_df['æ¯å“ç±»'] != 'å°é—­åˆ°æœŸ']\nkaifang_df.to_excel(writer, sheet_name='3ã€æœ¬â½‰å®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–')\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: æœ¬å‘¨æ–°å‘äº§å“\n# ------------------------------------------------------------------------------\nprint(\"[3.1] ç”ŸæˆæŠ¥è¡¨: æœ¬å‘¨æ–°å‘äº§å“...\")\n\nyunzuogailan_date = zhoubao_date\nxinfa_thisweek_df = zhanbao_df[zhanbao_df['èµ·æ¯æ—¥'] >= week_Mon]\nyunzuogailan_original = pd.read_excel(Config.get_weekly_data_file('äº§å“è¿ä½œæ¦‚è§ˆ'), index_col=0)\nyunzuogailan_original['æ¯äº§å“ä»£ç '] = yunzuogailan_original['äº§å“ç®€ç§°'].map(\n    lambda x: yunzuogailan_original[yunzuogailan_original['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]\n)\nyunzuogailan_original = yunzuogailan_original[['äº§å“ç®€ç§°', 'æ¯äº§å“ä»£ç ', 'äº§å“ç»ç†']].drop_duplicates()\n\nfor mid_ind in xinfa_thisweek_df.index:\n    if mid_ind in yunzuogailan_original.index:\n        mother_indx = yunzuogailan_original.loc[mid_ind, 'æ¯äº§å“ä»£ç ']\n        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mother_indx\n        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç®€ç§°']\n        xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç»ç†'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç»ç†']\n    else:\n        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mid_ind\n        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç®€ç§°']\n\nxinfa_thisweek_qudao = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ', 'æ¸ é“-ç®€åŒ–']).agg({\n    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',\n    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'\n})\nxinfa_thisweek_sum = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ']).agg({\n    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',\n    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'\n})\n\nfor mid_ind in xinfa_thisweek_sum.index:\n    if (mid_ind, 'è¡Œå†…') in xinfa_thisweek_qudao.index:\n        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå†…(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå†…'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']\n    if (mid_ind, 'è¡Œå¤–') in xinfa_thisweek_qudao.index:\n        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå¤–(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå¤–'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']\n\nif xinfa_thisweek_sum.empty:\n    result_3_2_df = pd.DataFrame(columns=[\n        'æ¯äº§å“ç®€ç§°', 'é”€é‡(äº¿)', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',\n        'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'\n    ])\nelse:\n    keep_columns_xinfa = [\n        'æ¯äº§å“ç®€ç§°', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',\n        'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'æˆ˜æŠ¥åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'\n    ]\n    cols_available = [c for c in keep_columns_xinfa if c in xinfa_thisweek_sum.columns]\n    xinfa_thisweek_sum = xinfa_thisweek_sum[cols_available].copy()\n    xinfa_thisweek_sum.rename(columns={'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'é”€é‡(äº¿)', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'åˆ°æœŸæ—¥'}, inplace=True)\n    result_3_2_df = xinfa_thisweek_sum[xinfa_thisweek_sum['é”€é‡(äº¿)'] != 0]\n    result_3_2_df.sort_values(by='èµ·æ¯æ—¥', ascending=True, inplace=True)\n\nresult_3_2_df.to_excel(writer, sheet_name='æœ¬å‘¨æ–°å‘äº§å“')\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: å¾…å”®äº§å“\n# ------------------------------------------------------------------------------\nprint(\"[3.2] ç”ŸæˆæŠ¥è¡¨: å¾…å”®äº§å“...\")\n\nproduct_tosale_df = data_loader.load_product_tosale()\nproduct_tosale_df = product_tosale_df.merge(\n    Product_information_df_DAP['æ¯äº§å“æŠ•èµ„ç»ç†'], left_index=True, right_index=True, how='left'\n)\n\nfirst = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦', 'æä½³èˆª', \"è‹æ–‡æ´¥\", \"å¤å‡¡ç››\", \"é»„äº¦å°§\"]\nsecond = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ', \"ç½—è°¨æ·±\"]\nthird = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°', 'å»–ç‚¯è‡£']\n\nproduct_tosale_df_new = product_tosale_df[\n    product_tosale_df['æ¯äº§å“æŠ•èµ„ç»ç†'].map(lambda x: manager_in_or_not(x, first + second + third))\n]\ndate_here = zhoubao_date[:4] + '-' + zhoubao_date[4:6] + '-' + zhoubao_date[6:]\nproduct_tosale_df_final = product_tosale_df_new[product_tosale_df_new['æˆç«‹æ—¥'] > date_here]\nproduct_tosale_df_final.drop_duplicates(inplace=True)\nkeep_columns = ['æ¯å­äº§å“æ ‡è¯†', 'äº§å“ç®€ç§°', 'äº§å“å¼€æ”¾å½¢å¼', 'å‹Ÿé›†æœŸ(èµ·)', 'å‹Ÿé›†æœŸ(æ­¢)', 'æˆç«‹æ—¥', 'åˆ°æœŸæ—¥', 'è§„æ¨¡ä¸Šé™(äº¿)', 'é”€å”®å¸ç§']\nproduct_tosale_df_final_v1 = product_tosale_df_final[keep_columns]\nproduct_tosale_df_final_v2 = product_tosale_df_final_v1[\n    product_tosale_df_final_v1.apply(\n        lambda x: False if (x['äº§å“ç®€ç§°'] in product_tosale_df_final_v1['äº§å“ç®€ç§°']) and (x['æ¯å­äº§å“æ ‡è¯†'] == 'æ¯äº§å“') else True,\n        axis=1\n    )\n]\nproduct_tosale_df_final_v2.sort_values(by='æˆç«‹æ—¥', ascending=True, inplace=True)\nproduct_tosale_df_final_v2.to_excel(writer, sheet_name='å¾…å”®äº§å“')\n\n\n# ==============================================================================\n# ç¬¬åéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“ä¸šç»©åˆ†æ\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: ç³»åˆ—äº§å“ä¸šç»©ï¼ˆè´¹åå¹³å‡/åŠ æƒã€è´¹å‰å¹³å‡/åŠ æƒï¼‰\n# ------------------------------------------------------------------------------\nprint(\"\\n[5] ç”ŸæˆæŠ¥è¡¨: ç³»åˆ—äº§å“ä¸šç»©...\")\n\n# è®¡ç®—ä¸šç»©æ•°æ®éœ€è¦ç”¨åˆ°çš„å‡½æ•°\nyear_col = f\"{int(str(zhoubao_date)[:4])}å¹´å¹´åŒ–æ”¶ç›Šç‡\"\n\n\ndef weighted_avg(group):\n    \"\"\"è®¡ç®—è§„æ¨¡åŠ æƒå¹³å‡\"\"\"\n    w_fields = [\n        'ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡',\n        'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡'\n    ]\n    results = {}\n    for field in w_fields:\n        mask = group[field].notna()\n        if mask.any():\n            weight_valid = group.loc[mask, 'å‡€èµ„äº§(äº¿)']\n            total_weight = weight_valid.sum()\n            results[field] = (group.loc[mask, field] * weight_valid).sum() / total_weight\n        else:\n            results[field] = np.nan\n    return pd.Series(results)\n\n\n# ç”Ÿæˆäº§å“ç›‘æ§æ•°æ®\ndata_transposition_here = data_transposition\ndata_transposition_here.apply(performance_calculate_optimize).T.to_excel(Config.get_performance_file(zhoubao_date))\nprint('   æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.index[-1]))\n\n# åŠ è½½è¿ä½œæ¦‚è§ˆæ•°æ®\nyunzuogailan_all = del_Innovation_department(\n    pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)\n)\n\n# ç­›é€‰æŒæœ‰æœŸå’Œå…¶ä»–äº§å“\nto_merge_chiyouqi_code = yunzuogailan_all[\n    yunzuogailan_all.apply(lambda x: (x['ä¸»è¦å±•ç¤º'] == 'æ˜¯') & (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']), axis=1)\n]\nto_merge_other_code = yunzuogailan_all[\n    yunzuogailan_all.apply(lambda x: (x['æ¯å­æ ‡å¿—'] in ['éæ¯å­äº§å“', 'æ¯äº§å“']) & (x['å½¢æ€'] in ['å°é—­', 'å®šå¼€']), axis=1)\n]\nyunzuogailan_now = pd.concat([to_merge_chiyouqi_code, to_merge_other_code])\n\n# åˆå¹¶æ”¶ç›Šç‡å’Œæ³¢åŠ¨ç‡æ•°æ®\nkeep_cols = ['è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']\nyunzuogailan_now_5 = yunzuogailan_now.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\nperf_df = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0)\nkeep_cols = [c for c in keep_cols if c in perf_df.columns]\nyunzuogailan_now_ret = yunzuogailan_now_5.merge(perf_df[keep_cols], left_index=True, right_index=True, how='left')\nyunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'] = yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'].map(\n    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x\n)\n\n# å¯¹è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡ä¸º0æˆ–ç¼ºå¤±çš„äº§å“ï¼Œç”¨æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡æ›¿ä»£\nyunzuogailan_now_ret['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] = yunzuogailan_now_ret.apply(\n    lambda row: row['ç´¯è®¡å¹´åŒ–'] if (pd.isna(row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡']) or row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] == 0) else row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'],\n    axis=1\n)\n\n# 5.1 è´¹åå¹³å‡\nresult_5 = yunzuogailan_now_ret[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + ['ç´¯è®¡å¹´åŒ–'] + keep_cols].groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()[\n    ['ç´¯è®¡å¹´åŒ–'] + keep_cols\n]\nresult_5 = rank_by_sort(result_5, rank_here)\nresult_5.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹åå¹³å‡')\n\n# 5.2 è´¹ååŠ æƒ\nresult_5_weight = yunzuogailan_now_ret.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)\nresult_5_weight = rank_by_sort(result_5_weight, rank_here)\nresult_5_weight.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹ååŠ æƒ')\n\n# 5.3 è´¹å‰æ•°æ®\nyunzuogailan_add_fee = yunzuogailan_now_ret.copy()\nw_field = ['ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']\nyunzuogailan_add_fee[w_field] = yunzuogailan_add_fee[w_field].add(\n    yunzuogailan_add_fee[['é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹']].sum(axis=1), axis=0\n)\n\n# 5.4 è´¹å‰åŠ æƒ\nresult_series_performance = yunzuogailan_add_fee.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)\nresult_series_performance = rank_by_sort(result_series_performance, rank_here)\nresult_series_performance.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰åŠ æƒ')\n\n# 5.5 è´¹å‰å¹³å‡\nresult_series_performance_average = yunzuogailan_add_fee[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + w_field + ['è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']].groupby(\n    ['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']\n).mean()\nresult_series_performance_average = rank_by_sort(result_series_performance_average, rank_here)\nresult_series_performance_average.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰å¹³å‡')\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨5.2: æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°\n# ------------------------------------------------------------------------------\nprint(\"[5.2] ç”ŸæˆæŠ¥è¡¨: 5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°...\")\n\nyunzuogailan_now_ret_chiyouqi = yunzuogailan_now_ret[yunzuogailan_now_ret.apply(\n    lambda x: (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']) and (x['æ¯åˆ†ç±»'] in ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€']),\n    axis=1\n)]\nyunzuogailan_now_ret_chiyouqi.rename(columns={'ç´¯è®¡å¹´åŒ–': 'æˆç«‹ä»¥æ¥å¹´åŒ–', year_col: 'ä»Šå¹´ä»¥æ¥å¹´åŒ–'}, inplace=True)\n\n# æœ±è€å¸ˆçš„æ‚¦åŠ¨ç¨³äº«9M281010å•ç‹¬å¤„ç†\nyunzuogailan_now_ret_chiyouqi.loc[\n    '9M281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']\n] = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0).loc[\n    '9A281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col]\n].values\n\nyunzuogailan_now_ret_chiyouqi['ä»Šå¹´ä»¥æ¥å¹´åŒ–'] = yunzuogailan_now_ret_chiyouqi.apply(\n    lambda x: x['æˆç«‹ä»¥æ¥å¹´åŒ–'] if pd.isnull(x['ä»Šå¹´ä»¥æ¥å¹´åŒ–']) else x['ä»Šå¹´ä»¥æ¥å¹´åŒ–'], axis=1\n)\n\n\ndef get_Scale_weighting_ret(my_df):\n    keep_ret_cols = ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']\n    ret_sum_df = (my_df[keep_ret_cols].multiply(my_df['å‡€èµ„äº§(äº¿)'], axis=\"index\")).sum()\n    scale_sum_df = ((my_df[keep_ret_cols] / my_df[keep_ret_cols]).multiply(my_df['å‡€èµ„äº§(äº¿)'], axis=\"index\")).sum()\n    return ret_sum_df / scale_sum_df\n\n\nresult_df_52 = yunzuogailan_now_ret_chiyouqi.groupby('æ¯åˆ†ç±»').apply(get_Scale_weighting_ret)\nresult_df_52.rename(index={'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€': 'æ‚¦åŠ¨çŸ­æŒ'}, inplace=True)\nrank_chiyouqi = ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ']\nrank_by_sort(result_df_52, rank_chiyouqi).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°1')\n\nyunzuogailan_now_ret_chiyouqi['æŒæœ‰æœŸæ ‡ç­¾'] = yunzuogailan_now_ret_chiyouqi['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale_v2)\nyunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'] = yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'].map(\n    lambda x: 'æ‚¦åŠ¨çŸ­æŒ' if x == 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€' else x\n)\nresult_df_52_3 = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾']).apply(get_Scale_weighting_ret)\nresult_df_52_3['æ•°é‡'] = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾'])['äº§å“ç®€ç§°'].count()\nrank_chiyouqi_v3 = [\n    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '<1M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '1M-3M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '3M-6M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '6M-1Y'),\n    ('æ‚¦åŠ¨çŸ­æŒ', '<1M'), ('æ‚¦åŠ¨çŸ­æŒ', '1M-3M'), ('æ‚¦åŠ¨çŸ­æŒ', '3M-6M'), ('æ‚¦åŠ¨çŸ­æŒ', '6M-1Y'),\n    ('ä¼˜å…ˆè‚¡çŸ­æŒ', '1M-3M')\n]\nrank_by_sort(result_df_52_3, rank_chiyouqi_v3).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°2')\n\n\n# ==============================================================================\n# ç¬¬åä¸€éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æŠ•èµ„ç»ç†åˆ†æ\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡\n# ------------------------------------------------------------------------------\nprint(\"\\n[6] ç”ŸæˆæŠ¥è¡¨: æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡...\")\n\nnow = zhoubao_date\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\nyunzuogailan_lastw = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastw), index_col=0))\nyunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))\nyunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n\nresult_now = get_scaleandnum_by_sort_manager(yunzuogailan_now).groupby('äº§å“ç»ç†').agg({\n    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'\n})\n\nrikai_now = get_scaleandnum_by_sort_manager(yunzuogailan_now)\nrikai_now = rikai_now[rikai_now['å½¢æ€'].map(lambda x: x in ['æ—¥å¼€', 'å®¢æˆ·å‘¨æœŸ', 'æœ€çŸ­æŒæœ‰æœŸ'])].groupby('äº§å“ç»ç†').agg({\n    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'\n})\nrikai_now.rename(columns={'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'}, inplace=True)\n\nresult_df_here = []\ncols_to_append = ['-è¾ƒä¸Šå‘¨', '-è¾ƒä¸Šæœˆæœ«', '-è¾ƒä¸Šå¹´æœ«']\nfor i in range(3):\n    mid_df = [yunzuogailan_lastw, yunzuogailan_lastm, yunzuogailan_lasty][i]\n    result_df_i = result_now - get_scaleandnum_by_sort_manager(mid_df).groupby('äº§å“ç»ç†').agg({\n        'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'\n    })\n    result_df_i.columns = [x + cols_to_append[i] for x in ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°']]\n    result_df_here.append(result_df_i)\n\nresult_df_here = pd.concat([result_now] + result_df_here + [rikai_now], axis=1)\n\ncols_here = [\n    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡',\n    'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'\n]\nindx_here = [\n    'ä¸¥æ³“', 'å¾è¹', 'æ¨æ¼ ', 'é«˜ç¿°æ˜†', 'å§œé”¡å³°', 'ä½™æ´é›…', 'è–›çºªæ™”', 'èƒ¡è‰³å©·', 'æœ±è½¶ä¼¦', 'ä»»é›',\n    'å¼ ç‰æ°', 'å»–ç‚¯è‡£', 'æä½³èˆª', \"è‹æ–‡æ´¥\", \"å¤å‡¡ç››\", \"é»„äº¦å°§\", \"ç½—è°¨æ·±\"\n]\nresult_df_here = result_df_here[cols_here]\nresult_df_here = result_df_here.dropna(axis=0, how='all')\nresult_df_here = rank_by_sort(result_df_here, indx_here)\nresult_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']] = \\\n    result_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']].applymap(\n        lambda x: '{:.2f}'.format(x)\n    )\nresult_df_here.to_excel(writer, sheet_name='æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡')\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡\n# ------------------------------------------------------------------------------\nprint(\"[6.1] ç”ŸæˆæŠ¥è¡¨: ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡...\")\n\nyunzuogailan_now_65 = yunzuogailan_now.copy()\nyunzuogailan_now_65['å½¢æ€'] = yunzuogailan_now_65['å½¢æ€'].map(lambda x: 'æœ€çŸ­æŒæœ‰æœŸ' if x == 'å®¢æˆ·å‘¨æœŸ' else x)\nyunzuogailan_now_65 = yunzuogailan_now_65.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\nresult_df_here_65 = pd.concat([\n    pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€', values=['å‡€èµ„äº§(äº¿)'], aggfunc='count'),\n    pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€', values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)\n], axis=1)\nresult_df_here_65.to_excel(writer, sheet_name='ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡')\n\n\n# ==============================================================================\n# ç¬¬åäºŒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æ‹›å•†äº§å“åˆ†æ\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†\n# ------------------------------------------------------------------------------\nprint(\"\\n[7] ç”ŸæˆæŠ¥è¡¨: æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†...\")\n\nzhaoshang_product_list = list(set(Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'].index))\nzhaoshang_product_df = yunzuogailan_all.loc[zhaoshang_product_list]\nzhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'] = zhaoshang_product_df['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)\nzhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] = zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'].map(\n    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x\n)\nzhaoshangfinal = zhaoshang_product_df[\n    (zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] * 100 - zhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'].map(\n        lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100\n    )) < 0\n]\nzhaoshang_scale = Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸']['ä¿æœ‰è§„æ¨¡'] / 100000000\nzhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] = [zhaoshang_scale[ind] for ind in zhaoshangfinal.index]\nzhaoshangfinal = zhaoshangfinal[zhaoshangfinal['è¿ä½œå¤©'] > 30]\nzhaoshangfinal = zhaoshangfinal[zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] > 0.1]\nzhaoshangfinal.sort_values('å‰©ä½™å¤©', ascending=True, inplace=True)\nzhaoshangfinal.to_excel(writer, sheet_name='æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†')\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸è¾¾ä¸šç»©äº§å“æ¸…å•\n# ------------------------------------------------------------------------------\nprint(\"[7.1] ç”ŸæˆæŠ¥è¡¨: å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸è¾¾ä¸šç»©äº§å“æ¸…å•...\")\n\nyunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'] = yunzuogailan_all['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)\nyunzuogailan_all['æœ¬æœŸå¹´åŒ–'] = yunzuogailan_all['æœ¬æœŸå¹´åŒ–'].map(\n    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x\n)\nyunzuogailan_all = yunzuogailan_all[\n    (yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] * 100 - yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'].map(\n        lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100\n    )) < 0\n]\nbdjz_100 = yunzuogailan_all[(yunzuogailan_all['å½¢æ€'].isin(['å°é—­', 'å®šå¼€'])) & (yunzuogailan_all['å‰©ä½™å¤©'] < 100)]\nbdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = (bdjz_100['æœ¬æœŸå¹´åŒ–'] - (bdjz_100['ä¸šç»©åŸºå‡†ä¸‹é™'].str[:-1]).astype(float) / 100) * 10000\nbdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'].astype(int)\nbdjz_100 = bdjz_100[bdjz_100['æ¯åˆ†ç±»'] != 'å¤–å¸ä½æ³¢']\nbdjz_100.to_excel(writer, sheet_name='å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸å¤§ä¸šç»©äº§å“æ¸…å•')\n\n\n# ==============================================================================\n# ç¬¬åä¸‰éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - èµ„äº§å¤§è¡¨\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨8: èµ„äº§å¤§è¡¨\n# ------------------------------------------------------------------------------\nprint(\"\\n[8] ç”ŸæˆæŠ¥è¡¨: 8.èµ„äº§å¤§è¡¨...\")\n\ndate = zhoubao_date\ndate_lastw = lastw\ndate_lastm = lastm\ndate_lasty = lasty\n\nyunzuogailan_all = pd.read_excel(Config.get_overview_history_file(date), index_col=0)\nChicang_df = data_loader.load_chicang_data(date)\nChicang_df = Chicang_df.merge(yunzuogailan_all['å¸ç§'], left_on='äº§å“ä»£ç ', right_index=True, how='left')\n\n# ç¾å…ƒäº§å“è½¬æ¢æ±‡ç‡\nEXchange_rate = market_data.get_exchange_rate('USDCNY', Config.EXCHANGE_RATE_DATE)\nChicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.apply(\n    lambda x: x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] * EXchange_rate if x['å¸ç§'] == 'ç¾å…ƒ' else x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'],\n    axis=1\n)\n\n# å¤„ç†ç‰¹æ®ŠåŸºé‡‘ç±»å‹\nto_fill_indx = Chicang_df[Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] == 0].index\nChicang_df.loc[to_fill_indx, 'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.loc[to_fill_indx, 'æŒä»“æˆæœ¬(å…ƒ)'] + Chicang_df.loc[to_fill_indx, 'æŒæœ‰æœŸæ”¶ç›Š']\nChicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].fillna(0)\n\n# åŠ è½½èµ„äº§åˆ†ç±»æ•°æ®\nasset_classification_joint_df = data_loader.load_asset_classification()\ninsurance_pdct_df = data_loader.load_insurance_products()\n\n# åŒ¹é…èµ„äº§å°ç±»å’Œå‹¾ç¨½å…³ç³»\nChicang_df = Chicang_df.merge(\n    asset_classification_joint_df[['ç¼–å·', 'ä¸‰çº§åˆ†ç±»']], left_on='æ–°ç‰ˆèµ„äº§å°ç±»', right_index=True, how='left'\n)\n\n# æ ‡è®°ä¿é™©èµ„ç®¡èµ„äº§\nmid_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å°ç±»'] == 'å§”å¤–ç°é‡‘ç®¡ç†æŠ•èµ„']\ninsurance_pdct_name_list = list(insurance_pdct_df.index) + ['è‹±å¤§èµ„äº§-èšé‘«22å·', 'å¤§å®¶èµ„ç®¡ç¨³å¥ç²¾é€‰15å·']\ninsurance_pdct_indx = mid_df[mid_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in insurance_pdct_name_list)].index\nChicang_df.loc[insurance_pdct_indx, 'ç¼–å·'] = '1.2'\nChicang_df.loc[insurance_pdct_indx, 'ä¸‰çº§åˆ†ç±»'] = '1.2 ä¿é™©åè®®å­˜æ¬¾'\n\n# ç»†åŒ–åŸæŠ•å’Œæ°¸ç»­å€ºåˆ†ç±»\nbond_set_df = pd.DataFrame(list(set(Chicang_df[Chicang_df['ç¼–å·'] == '3.4-3.5']['å¤–éƒ¨ä»£ç '])), columns=['å¤–éƒ¨ä»£ç '])\nbond_code_list = list(bond_set_df['å¤–éƒ¨ä»£ç '].values)\nwind_result = market_data.get_bond_attributes(bond_code_list)\nbond_set_df[['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­']] = wind_result.values\n\nto_merge_df = pd.DataFrame([\n    ['æ˜¯', 'å¦', '3.4.1 éæ°¸ç»­åŸæŠ•å€º'], ['æ˜¯', 'æ˜¯', '3.4.2 æ°¸ç»­åŸæŠ•å€º'],\n    ['å¦', 'å¦', '3.5.1 éæ°¸ç»­äº§ä¸šå€º'], ['å¦', 'æ˜¯', '3.5.2 æ°¸ç»­äº§ä¸šå€º']\n], columns=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­', 'ä¸‰çº§åˆ†ç±»'])\nbond_set_df = bond_set_df.merge(to_merge_df, left_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], right_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], how='left')\n\nChicang_df['ä¸‰çº§åˆ†ç±»-new'] = Chicang_df.apply(\n    lambda x: bond_set_df.set_index('å¤–éƒ¨ä»£ç ').loc[x['å¤–éƒ¨ä»£ç '], 'ä¸‰çº§åˆ†ç±»'] if x['ç¼–å·'] == '3.4-3.5' else x['ä¸‰çº§åˆ†ç±»'],\n    axis=1\n)\n\n# åŒ¹é…å¤šèµ„äº§å“ç±»\nyunzuogailan_now = pd.read_excel(Config.get_overview_parent_file(date), index_col=0)\nChicang_df2 = Chicang_df.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»', 'äº§å“ç»ç†']], left_on='äº§å“ä»£ç ', right_index=True, how='left')\nChicang_df2 = Chicang_df2[Chicang_df2.apply(lambda x: not pd.isnull(x['äº§å“ç»ç†']), axis=1)]\nChicang_df2 = del_Innovation_department(Chicang_df2)\nChicang_df2 = Chicang_df2.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n\nresult_df_8_initial = pd.pivot_table(\n    Chicang_df2, index=['ä¸‰çº§åˆ†ç±»-new'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],\n    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n) / 100000000\n\n# ç»†åŒ–å§”å¤–å€ºåˆ¸æŠ•èµ„å­é¡¹\nOutsourced_bond_asset_df = Chicang_df2[Chicang_df2['ä¸‰çº§åˆ†ç±»'] == '7.2 å§”å¤–å€ºåˆ¸æŠ•èµ„']\npublic_account_tag_df = data_loader.load_public_account_tag()\nOutsourced_bond_asset_df_new = Outsourced_bond_asset_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')\n\nOutsourced_bond_tag = {\n    'æ”¶ç›˜ä»·æ³•': '7.2.1 æ”¶ç›˜ä»·ä¸“æˆ·', 'åˆ©ç‡å€ºæ”¶ç›˜ä»·': '7.2.2 åˆ©ç‡å€ºæ”¶ç›˜ä»·ä¸“æˆ·',\n    'æ¨¡å‹æ³•': '7.2.3 æ¨¡å‹æ³•ä¸“æˆ·', 'å¯è½¬å€º': '7.2.4 å¯è½¬å€ºä¸“æˆ·',\n    'æ’å®šä¹…æœŸ': '7.2.5 æ’å®šä¹…æœŸä¸“æˆ·', 'å›ºæ”¶+å§”å¤–': '7.2.6 å›ºæ”¶+å§”å¤–ä¸“æˆ·',\n    'Wä¸“æˆ·': '7.2.7 Wä¸“æˆ·', 'ç»¿è‰²å€º': '7.2.8 ç»¿è‰²å€ºä¸“æˆ·', 'å¤–å¸ä¸“æˆ·': '7.2.9 å¤–å¸ä¸“æˆ·',\n}\nOutsourced_bond_asset_df_new['å››çº§åˆ†ç±»'] = Outsourced_bond_asset_df_new['æ ‡ç­¾'].map(\n    lambda x: Outsourced_bond_tag[x] if x in Outsourced_bond_tag.keys() else '7.2.10 å…¶ä»–'\n)\nOutsourced_bond_asset_result = pd.pivot_table(\n    Outsourced_bond_asset_df_new, index=['å››çº§åˆ†ç±»'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],\n    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n) / 100000000\n\nresult_df_8 = pd.concat([result_df_8_initial.rename_axis(''), Outsourced_bond_asset_result.rename_axis('')])\nresult_df_8.to_excel(Config.get_asset_table_file(date))\n\n# è®¡ç®—åŒæ¯”ç¯æ¯”å˜åŒ–\nresult_df_lastw = pd.read_excel(Config.get_asset_table_file(date_lastw), index_col=0, header=[0, 1, 2])\nresult_df_lastm = pd.read_excel(Config.get_asset_table_file(lastm), index_col=0, header=[0, 1, 2])\nresult_df_lasty = pd.read_excel(Config.get_asset_table_file(lasty), index_col=0, header=[0, 1, 2])\n\nresult_df_8_final = pd.concat([\n    result_df_8, result_df_8.sum(axis=1) - result_df_lastw.sum(axis=1),\n    result_df_8.sum(axis=1) - result_df_lastm.sum(axis=1),\n    result_df_8.sum(axis=1) - result_df_lasty.sum(axis=1)\n], axis=1)\n\n# è¡¥å……æœ¬å¸çš„ç›¸æ¯”å˜åŒ–\nforeign_currency_products_cols = [\n    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),\n    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼')\n]\nall_columns_8 = list(result_df_8.columns)\ndomestic_columns_8 = [col for col in all_columns_8 if col not in foreign_currency_products_cols]\nall_columns_lastw = list(result_df_lastw.columns)\ndomestic_columns_lastw = [col for col in all_columns_lastw if col not in foreign_currency_products_cols]\nall_columns_lastm = list(result_df_lastm.columns)\ndomestic_columns_lastm = [col for col in all_columns_lastm if col not in foreign_currency_products_cols]\nall_columns_lasty = list(result_df_lasty.columns)\ndomestic_columns_lasty = [col for col in all_columns_lasty if col not in foreign_currency_products_cols]\n\nresult_df_8_domestic_currency = result_df_8[domestic_columns_8].sum(axis=1)\nresult_df_lastw_domestic_currency = result_df_lastw[domestic_columns_lastw].sum(axis=1)\nresult_df_lastm_domestic_currency = result_df_lastm[domestic_columns_lastm].sum(axis=1)\nresult_df_lasty_domestic_currency = result_df_lasty[domestic_columns_lasty].sum(axis=1)\n\nresult_df_8_final = pd.concat([\n    result_df_8_final,\n    result_df_8_domestic_currency - result_df_lastw_domestic_currency,\n    result_df_8_domestic_currency - result_df_lastm_domestic_currency,\n    result_df_8_domestic_currency - result_df_lasty_domestic_currency\n], axis=1)\n\nresult_df_8_final.columns = pd.MultiIndex.from_tuples(\n    tuple(result_df_8.columns) + (\n        (\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨'), (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ'), (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´'),\n        (\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨-ä¸å«å¤–å¸äº§å“'), (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ-ä¸å«å¤–å¸äº§å“'), (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´-ä¸å«å¤–å¸äº§å“')\n    )\n)\nresult_df_8_final.to_excel(writer, sheet_name='8.èµ„äº§å¤§è¡¨')\n\n\n# ==============================================================================\n# ç¬¬åå››éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - ä¸­æ”¶ç›‘æ§\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨9: ä¸­æ”¶ç›‘æ§\n# ------------------------------------------------------------------------------\nprint(\"\\n[9] ç”ŸæˆæŠ¥è¡¨: 9.ä¸­æ”¶ç›‘æ§...\")\n\ndate = zhoubao_date\nzhongshou_m, zhongshou_y = data_loader.load_zhongshou_data(date)\n\n\ndef zhongshou_df_processing_v2(df_here, period_here: str):\n    \"\"\"å¤„ç†ä¸­æ”¶æ•°æ®\"\"\"\n    fixed_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'æŠ•èµ„å›¢é˜Ÿ', 'å›¢é˜Ÿåˆ’åˆ†', 'äº§å“çº¿']\n    df_here.columns = fixed_cols + list(df_here.columns[5:])\n    df_here = df_here[df_here['å›¢é˜Ÿåˆ’åˆ†'] == '5.å¤šèµ„äº§æŠ•èµ„éƒ¨']\n    df_here.columns = [''.join(x.split('\\n')) for x in df_here.columns]\n    zhongshou_cols = ['é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']\n    df_here = df_here[fixed_cols + zhongshou_cols]\n    df_here = df_here[df_here['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰'].map(lambda x: x > 0.00001)]\n    df_here = df_here.merge(classification_df[['å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True, how='left')\n    df_here = del_Innovation_department(df_here)\n    df_here = df_here.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n    mid_result = df_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).sum()[\n        ['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']\n    ]\n    mid_cols = [period_here + x for x in ['ä¸­æ”¶', 'é”€å”®ç®¡ç†è´¹', 'æŠ•èµ„ç®¡ç†è´¹(å«è¶…é¢)', 'è¶…é¢ç®¡ç†è´¹', 'å‰ç«¯æ”¶è´¹']]\n    mid_result.columns = mid_cols\n    return mid_result\n\n\nresult_9 = pd.concat([\n    zhongshou_df_processing_v2(zhongshou_m, '-'.join([date[:4], date[4:6]])),\n    zhongshou_df_processing_v2(zhongshou_y, date[:4])\n], axis=1)\nresult_9 = rank_by_sort(result_9, rank_here)\nresult_9.to_excel(writer, sheet_name='9.ä¸­æ”¶ç›‘æ§')\n\n\n# ==============================================================================\n# ç¬¬åäº”éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“åˆ°æœŸ\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨10: äº§å“åˆ°æœŸæƒ…å†µ\n# ------------------------------------------------------------------------------\nprint(\"\\n[10] ç”ŸæˆæŠ¥è¡¨: 10.äº§å“åˆ°æœŸæƒ…å†µ...\")\n\ndate = zhoubao_date\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(date), index_col=0))\nyunzuogailan_now['åˆ°æœŸæœˆä»½'] = yunzuogailan_now['åˆ°æœŸæ—¥'].map(lambda x: x[:-3])\nyunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\nyunzuogailan_here = yunzuogailan_here[yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w]\n\nyunzuogailan_here_fengbi = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å°é—­']\nyunzuogailan_here_dingkai = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å®šå¼€']\noutput_sheetname = ['10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ', '10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ-å®šå¼€']\n\nk = 0\nfor yunzuogailan_here_to_cal in [yunzuogailan_here_fengbi, yunzuogailan_here_dingkai]:\n    result_df_10 = pd.pivot_table(\n        yunzuogailan_here_to_cal, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='åˆ°æœŸæœˆä»½',\n        values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum\n    )\n    result_df_10 = rank_by_sort(full_category_or_not(result_df_10, rank_here), rank_here).T\n    result_df_10.index = result_df_10.loc['å‡€èµ„äº§(äº¿)'].index\n    result_df_10[[float(x[:4]) < 2029 for x in result_df_10.index]].to_excel(writer, sheet_name=output_sheetname[k])\n    k += 1\n\nkeep_cols = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'æ¯åˆ†ç±»', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']\nresult_df_10_2 = yunzuogailan_here[\n    (yunzuogailan_here['åˆ°æœŸæ—¥'] <= closing_date_next_w) & (yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w)\n][keep_cols]\nresult_df_10_2.sort_values(by='åˆ°æœŸæ—¥', ascending=True, inplace=True)\nresult_df_10_2.to_excel(writer, sheet_name='10.ä¸‹å‘¨åˆ°æœŸäº§å“æ¸…å•')\n\nprint('   ä¸‹å‘¨åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2['å‡€èµ„äº§(äº¿)'].sum()))\nprint('   å°é—­åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum()))\nprint('   å®šå¼€åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()))\n\n\n# ==============================================================================\n# ç¬¬åå…­éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æŒä»“åˆ†æ\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨11: æŒä»“æ˜ç»†\n# ------------------------------------------------------------------------------\nprint(\"\\n[11] ç”ŸæˆæŠ¥è¡¨: 11.æŒä»“æ˜ç»†...\")\n\ndate = zhoubao_date\nChicang_df = data_loader.load_chicang_data(date)\nWeiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()\n\n# 11.1 å…´åˆäº§å“æŒä»“æ˜ç»†\nprint(\"[11.1] ç”ŸæˆæŠ¥è¡¨: 11.å…´åˆäº§å“æŒä»“æ˜ç»†...\")\nxinghe_list = Config.XINGHE_PRODUCTS\nconcat_xinghe_series = []\nfor i in range(len(xinghe_list)):\n    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'\n    concat_xinghe_series.append(pd.Series(\n        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n        name=xinghe_list[i] + '-é‡‘é¢'\n    ))\n\nconcat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)\nconcat_xinghe_df = concat_xinghe_df.merge(\n    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n    left_index=True, right_index=True, how='left'\n)\nconcat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)\nconcat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]\nresult_df_11_1 = pd.concat([\n    concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n    concat_xinghe_pct_df\n], axis=1)\nresult_df_11_1.to_excel(writer, sheet_name='11.å…´åˆäº§å“æŒä»“æ˜ç»†')\n\n# 11.1.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†\nprint(\"[11.1.1] ç”ŸæˆæŠ¥è¡¨: 11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†...\")\nconcat_zhuanzhai_series = []\nzhuanzhai_dict = Config.CONVERTIBLE_BOND_ACCOUNTS\nzhuanzhai_list = []\nfor shortname in zhuanzhai_dict.keys():\n    concat_zhuanzhai_series.append(pd.Series(\n        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n        name=shortname + '-é‡‘é¢'\n    ))\n    zhuanzhai_list += [shortname]\n\nETF_bond_list = Config.CONVERTIBLE_BOND_ETF\nconcat_zhuanzhai_series.append(pd.Series(\n    Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n    name='å¯è½¬å€ºETF-é‡‘é¢'\n))\nzhuanzhai_list += ['å¯è½¬å€ºETF']\n\nconcat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)\nconcat_zhuanzhai_df = concat_zhuanzhai_df.merge(\n    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n    left_index=True, right_index=True, how='left'\n)\nconcat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(\n    concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0\n)\nconcat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]\nresult_df_11_1_1 = pd.concat([\n    concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n    concat_zhuanzhai_pct_df\n], axis=1)\nresult_df_11_1_1.to_excel(writer, sheet_name='11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†')\n\n# 11.2 é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†\nprint(\"[11.2] ç”ŸæˆæŠ¥è¡¨: 11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†...\")\npublic_account_tag_df = data_loader.load_public_account_tag()\nWeiwai_df_full = Weiwai_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')\nWeiwai_df_full = Weiwai_df_full.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»']], left_on='äº§å“ä»£ç ', right_index=True, how='left')\nWeiwai_df_full = Weiwai_df_full.merge(Parent_sort[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n\nconcat_quant_series = []\nquant_list = Config.QUANT_STRATEGY_LABELS\nconcat_quant_series.append(pd.Series(\n    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–ä¸­æ€§'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n    name='é‡åŒ–ä¸­æ€§'\n))\nconcat_quant_series.append(pd.Series(\n    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–æŒ‡å¢'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n    name='é‡åŒ–æŒ‡å¢'\n))\nconcat_quant_series.append(pd.Series(\n    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–CTA'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n    name='é‡åŒ–CTA'\n))\nconcat_quant_series.append(pd.Series(\n    Weiwai_df_full[Weiwai_df_full['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-å…´åˆ4å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n    name='å…´åˆ4å·'\n))\nconcat_quant_df = pd.concat(concat_quant_series, axis=1)\nconcat_quant_df = concat_quant_df.merge(\n    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)']],\n    left_index=True, right_index=True, how='left'\n)\nconcat_quant_pct_df = concat_quant_df[quant_list].div(concat_quant_df['å‡€èµ„äº§(äº¿)'], axis=0)\nconcat_quant_pct_df.columns = [x + '-å æ¯”' for x in quant_list]\nresult_df_11_3 = pd.concat([concat_quant_df[quant_list + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†']], concat_quant_pct_df], axis=1)\nresult_df_11_3.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)\nresult_df_11_3.to_excel(writer, sheet_name='11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†')\n\n# 11.2.1-11.2.3 å§”å¤–ä¸“æˆ·é…ç½®æƒ…å†µ\nprint(\"[11.2.1-11.2.3] ç”ŸæˆæŠ¥è¡¨: å§”å¤–ä¸“æˆ·é…ç½®æƒ…å†µ...\")\nresult_df_11_2_amt = pd.pivot_table(\n    Weiwai_df_full, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ ‡ç­¾',\n    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n) / 100000000\nyunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\nresult_df_11_2_pct_2 = result_df_11_2_amt.div(yunzuogailan_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'])['å‡€èµ„äº§(äº¿)'].sum(), axis=0)\n\nWeiwai_df_simplify = pd.pivot_table(\n    Weiwai_df_full, index=['äº§å“ä»£ç '], columns='æ ‡ç­¾',\n    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n) / 100000000\nWeiwai_df_simplify.columns = Weiwai_df_simplify['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].columns\nWeiwai_df_simplify = Weiwai_df_simplify.merge(yunzuogailan_here[['å‡€èµ„äº§(äº¿)']], left_index=True, right_index=True, how='left')\nresult_df_11_2_pct = Weiwai_df_simplify.div(Weiwai_df_simplify['å‡€èµ„äº§(äº¿)'], axis=0).merge(\n    yunzuogailan_here[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_index=True, right_index=True, how='left'\n)\nresult_df_11_2_pct = result_df_11_2_pct.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()\n\nrank_by_sort(full_category_or_not(result_df_11_2_amt, rank_here), rank_here).to_excel(\n    writer, sheet_name='11.2.1å…¶ä»–å§”å¤–ä¸“æˆ·é‡‘é¢é…ç½®æƒ…å†µ'\n)\nrank_by_sort(full_category_or_not(result_df_11_2_pct, rank_here), rank_here).to_excel(\n    writer, sheet_name='11.2.2å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ'\n)\nrank_by_sort(full_category_or_not(result_df_11_2_pct_2, rank_here), rank_here).to_excel(\n    writer, sheet_name='11.2.3å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ-é™¤ä»¥ç³»åˆ—è§„æ¨¡'\n)\n\n# 11.4 å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†\nprint(\"[11.4] ç”ŸæˆæŠ¥è¡¨: 11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†...\")\nxinghe_list = Config.XINGHE_PRODUCTS_2\nconcat_xinghe_series = []\nfor i in range(len(xinghe_list)):\n    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'\n    concat_xinghe_series.append(pd.Series(\n        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n        name=xinghe_list[i] + '-é‡‘é¢'\n    ))\nconcat_xinghe_series.append(pd.Series(\n    Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-è´¢æ™ºäººç”ŸçµåŠ¨1å·å•ä¸€èµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n    name='çµåŠ¨1å·-é‡‘é¢'\n))\nxinghe_list = xinghe_list + ['çµåŠ¨1å·']\n\nconcat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)\nconcat_xinghe_df = concat_xinghe_df.merge(\n    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n    left_index=True, right_index=True, how='left'\n)\nconcat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)\nconcat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]\nresult_df_11_4 = pd.concat([\n    concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n    concat_xinghe_pct_df\n], axis=1)\nresult_df_11_4.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)\nresult_df_11_4.to_excel(writer, sheet_name='11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†')\n\n# 11.5 å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”\nprint(\"[11.5] ç”ŸæˆæŠ¥è¡¨: 11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”...\")\nZhuanhu_label_df = data_loader.load_public_account_tag()\nderivative_zhuanhu_list = list(Zhuanhu_label_df[Zhuanhu_label_df['æ ‡ç­¾'] == 'è¡ç”Ÿå“ä¸“æˆ·'].index)\nderivative_zhuanhu_df = Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in derivative_zhuanhu_list)]\nderivative_zhuanhu_df = pd.pivot_table(\n    derivative_zhuanhu_df, index=['äº§å“ä»£ç '], columns='å€ºåˆ¸ç®€ç§°',\n    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum\n)\nderivative_zhuanhu_df.columns = [x[1][5:-8] for x in derivative_zhuanhu_df.columns]\nderivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'] = derivative_zhuanhu_df.sum(axis=1)\nderivative_zhuanhu_df = derivative_zhuanhu_df.merge(\n    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n    left_index=True, right_index=True, how='left'\n)\nderivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ¯”ä¾‹'] = derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'].div(\n    derivative_zhuanhu_df['å‡€èµ„äº§(äº¿)'], axis=0\n) / 100000000\nderivative_zhuanhu_df.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)\nderivative_zhuanhu_df.to_excel(writer, sheet_name='11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”')\n\n# 11.6 éæ ‡æŒä»“å æ¯”\nprint(\"[11.6] ç”ŸæˆæŠ¥è¡¨: 11.6éæ ‡æŒä»“å æ¯”...\")\nfeibiao_df = Chicang_df[Chicang_df.apply(\n    lambda x: (x['æ–°ç‰ˆèµ„äº§å¤§ç±»'] in ['éæ ‡å‡†åŒ–å€ºæƒç±»èµ„äº§', 'ç†è´¢ç›´æ¥èèµ„å·¥å…·', 'æ–°å¢å¯æŠ•èµ„èµ„äº§']) or\n              (x['æ–°ç‰ˆèµ„äº§å°ç±»'] in ['åŒä¸šå€Ÿæ¬¾']), axis=1\n)]\nfeibiao_pct_df = pd.DataFrame(feibiao_df.groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum())\nfeibiao_pct_df = feibiao_pct_df.merge(\n    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n    left_index=True, right_index=True, how='left'\n)\nfeibiao_pct_df['éæ ‡å æ¯”'] = feibiao_pct_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] / feibiao_pct_df['å‡€èµ„äº§(äº¿)'] / 100000000\nfeibiao_pct_df.to_excel(writer, sheet_name='11.6éæ ‡æŒä»“å æ¯”')\n\n# é»„é‡‘æŒä»“\nprint(\"[11.7] ç”ŸæˆæŠ¥è¡¨: é»„é‡‘æŒä»“...\")\ngold_dict = Config.GOLD_ACCOUNTS\ngold_ETF_bond_list = Config.GOLD_ETF\n\n\ndef get_zhdata(zhuanzhai_dict, ETF_bond_list):\n    \"\"\"è·å–é»„é‡‘æŒä»“æ•°æ®\"\"\"\n    concat_zhuanzhai_series = []\n    zhuanzhai_list = []\n    for shortname in zhuanzhai_dict.keys():\n        concat_zhuanzhai_series.append(pd.Series(\n            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n            name=shortname + '-é‡‘é¢'\n        ))\n        zhuanzhai_list += [shortname]\n    concat_zhuanzhai_series.append(pd.Series(\n        Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n        name='é»„é‡‘ETF-é‡‘é¢'\n    ))\n    zhuanzhai_list += ['é»„é‡‘ETF']\n    concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)\n    concat_zhuanzhai_df = concat_zhuanzhai_df.merge(\n        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n        left_index=True, right_index=True, how='left'\n    )\n    concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(\n        concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0\n    )\n    concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]\n    result_df_11_1_1 = pd.concat([\n        concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n        concat_zhuanzhai_pct_df\n    ], axis=1)\n    return result_df_11_1_1\n\n\nhg_asset = get_zhdata(gold_dict, gold_ETF_bond_list)\nhg_asset[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-é‡‘é¢', 'é»„é‡‘ETF-é‡‘é¢',\n          'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-å æ¯”', 'é»„é‡‘ETF-å æ¯”']].to_excel(writer, sheet_name='é»„é‡‘æŒä»“')\n\n# æƒç›Šä¸“æˆ·æŒä»“\nprint(\"[11.8] ç”ŸæˆæŠ¥è¡¨: æƒç›Šä¸“æˆ·æŒä»“...\")\nequity_dict = Config.EQUITY_ACCOUNTS\n\n\ndef get_equity_data(equity_dict):\n    \"\"\"è·å–æƒç›Šä¸“æˆ·æŒä»“æ•°æ®\"\"\"\n    concat_equity_series = []\n    equity_list = []\n    for shortname in equity_dict.keys():\n        concat_equity_series.append(pd.Series(\n            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == equity_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n            name=shortname + '-é‡‘é¢'\n        ))\n        equity_list += [shortname]\n    concat_equity_df = pd.concat(concat_equity_series, axis=1)\n    concat_equity_df = concat_equity_df.merge(\n        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n        left_index=True, right_index=True, how='left'\n    )\n    concat_equity_pct_df = concat_equity_df[[x + '-é‡‘é¢' for x in equity_list]].div(\n        concat_equity_df['å‡€èµ„äº§(äº¿)'], axis=0\n    )\n    concat_equity_pct_df.columns = [x + '-å æ¯”' for x in equity_list]\n    result_df = pd.concat([\n        concat_equity_df[[x + '-é‡‘é¢' for x in equity_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n        concat_equity_pct_df\n    ], axis=1)\n    return result_df\n\n\nequity_asset = get_equity_data(equity_dict)\noutput_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»'] + \\\n              [x + suffix for x in equity_dict.keys() for suffix in ['-é‡‘é¢', '-å æ¯”']]\nequity_asset[output_cols].to_excel(writer, sheet_name='æƒç›Šä¸“æˆ·æŒä»“')\n\n# å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ\nprint(\"[11.9] ç”ŸæˆæŠ¥è¡¨: å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ...\")\nggcc = data_loader.load_public_strategy()\nwwgl = data_loader.load_weiwai_overview()\nchicangsum = Chicang_df.groupby('å€ºåˆ¸ç®€ç§°')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000\nggcc = pd.merge(ggcc, wwgl, left_on='èµ„äº§åç§°', right_on='å§”å¤–èµ„äº§', how='left')\nggcc = pd.merge(ggcc, chicangsum, left_on='èµ„äº§åç§°', right_index=True, how='left')\nggcc = ggcc.rename(columns={'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼': 'å¤šèµ„äº§æŠ•æŒä»“-äº¿', \"æœ€æ–°è§„æ¨¡\": 'ä¸“æˆ·è§„æ¨¡'})\nggcc['å¤šèµ„äº§æŒä»“å æ¯”'] = ggcc['å¤šèµ„äº§æŠ•æŒä»“-äº¿'] / ggcc['ä¸“æˆ·è§„æ¨¡']\nggcc[['æ‰€å±éƒ¨é—¨', 'ç­–ç•¥æ ‡ç­¾', 'èµ„äº§ä»£ç ', 'èµ„äº§åç§°', 'èµ„äº§ç®€ç§°', 'ä¸“æˆ·è§„æ¨¡',\n      'å¤šèµ„äº§æŠ•æŒä»“-äº¿', 'å¤šèµ„äº§æŒä»“å æ¯”']].to_excel(writer, sheet_name='å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ')\n\n\n# ==============================================================================\n# ç¬¬åä¸ƒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å‡€å€¼æ³¢åŠ¨ä¸ç ´å‡€\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨12: å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•\n# ------------------------------------------------------------------------------\nprint(\"\\n[12] ç”ŸæˆæŠ¥è¡¨: 12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•...\")\n\ndate = zhoubao_date\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(date), index_col=0))\npart_nav_df = data_transposition.loc[:, yunzuogailan_now.index].tail(7 + 1)\nrweek = pd.DataFrame(\n    (part_nav_df.tail(1).values / part_nav_df.head(1).values - 1) * 10000,\n    columns=part_nav_df.columns, index=['å‘¨å‡€å€¼å˜åŒ–bp']\n).T\nrweek_average = ((part_nav_df / part_nav_df.shift(1) - 1) * 10000).mean(axis=0)\nnav_change_df = pd.concat([rweek, rweek_average], axis=1)\nnav_change_df.columns = ['å‘¨å‡€å€¼å˜åŒ–bp', 'å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']\nnav_change_df_keep = nav_change_df[\n    (abs(nav_change_df['å‘¨å‡€å€¼å˜åŒ–bp']) >= 20) | (abs(nav_change_df['å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']) >= 3)\n]\n\nresult_df_12 = nav_change_df_keep.merge(\n    yunzuogailan_now[['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',\n                      'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©',\n                      'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']],\n    left_index=True, right_index=True, how='left'\n)\nresult_df_12.sort_values('å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp', ascending=True, inplace=True)\nresult_df_12.to_excel(writer, sheet_name='12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•')\n\n\n# ==============================================================================\n# ç¬¬åå…«éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å‘¨æœŸåˆ†å¸ƒ\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨13: ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡\n# ------------------------------------------------------------------------------\nprint(\"\\n[13] ç”ŸæˆæŠ¥è¡¨: 13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡...\")\n\nnow = zhoubao_date\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\nyunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))\nyunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n\n\ndef get_zhouqi_scale_df(df_f, name: str):\n    mid_df = df_f.copy()\n    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)\n    result_df = pd.concat([\n        mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].sum(),\n        mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].count()\n    ], axis=1)\n    result_df.columns = [name + x for x in ['è§„æ¨¡(äº¿)', 'æ•°é‡']]\n    return result_df\n\n\nfinal_df = pd.concat([get_zhouqi_scale_df(yunzuogailan_lasty, '2024'), get_zhouqi_scale_df(yunzuogailan_now, 'æœ€æ–°')], axis=1)\nfinal_df['vlookupæ ‡ç­¾'] = [''.join(list(x)) for x in final_df.index]\nkeep_columns = ['vlookupæ ‡ç­¾'] + list(final_df.columns[:-1])\nfinal_df[keep_columns].to_excel(writer, sheet_name='13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡')\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨14: ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª\n# ------------------------------------------------------------------------------\nprint(\"\\n[14] ç”ŸæˆæŠ¥è¡¨: 14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª...\")\n\nnow = zhoubao_date\nmonth7 = '20240731'\nlasty = '20241231'\n\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\nyunzuogailan_month7 = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(month7), index_col=0))\nyunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n\n\ndef match_kehuzhouqi_narrowed(x: str):\n    if x == 'å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“':\n        return 'å®¢æˆ·å‘¨æœŸ'\n    elif x == 'å®¢æˆ·é”å®šæœŸ':\n        return 'æœ€çŸ­æŒæœ‰æœŸ'\n    else:\n        return ''\n\n\ndef get_kehuzhouqi_narrowed_scale(my_df, col_str: str):\n    mid_df = my_df[my_df['äº§å“æ¨¡æ¿ä¸­æ–‡åç§°'].map(lambda x: x in ['å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“', 'å®¢æˆ·é”å®šæœŸ'])]\n    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)\n    result_df = pd.pivot_table(mid_df, index=['å‘¨æœŸåŒºé—´'], columns='äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)\n    result_df.columns = [col_str + match_kehuzhouqi_narrowed(x[1]) for x in list(result_df.columns)]\n    return result_df\n\n\nresult_df_14 = pd.concat([\n    get_kehuzhouqi_narrowed_scale(yunzuogailan_lasty, '2024å¹´åº•'),\n    get_kehuzhouqi_narrowed_scale(yunzuogailan_month7, '2024å¹´7æœˆ'),\n    get_kehuzhouqi_narrowed_scale(yunzuogailan_now, 'æœ€æ–°')\n], axis=1)\nresult_df_14.to_excel(writer, sheet_name='14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª')\n\n\n# ==============================================================================\n# ç¬¬åä¹éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å¸‚åœºæŒ‡æ•°æ”¶ç›Š\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨15: å¸‚åœºæŒ‡æ•°æ”¶ç›Š\n# ------------------------------------------------------------------------------\nprint(\"\\n[15] ç”ŸæˆæŠ¥è¡¨: 15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š...\")\n\nwind_code_list = Config.MARKET_INDEX_CODES\nresult_list = []\n\nfor deltadays in [30, 30 * 3, 30 * 6, 365]:\n    startDate = ''.join(str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=deltadays)).date()).split('-'))\n    returns = market_data.get_index_returns(wind_code_list, startDate, zhoubao_date)\n    result_list.append(np.array(returns) * 365 / deltadays)\n\n# è®¡ç®—ä»Šå¹´ä»¥æ¥å¹´åŒ–æ”¶ç›Š\ndeltadays = (datetime.strptime(zhoubao_date, '%Y%m%d') - datetime.strptime('20251231', '%Y%m%d')).days\nreturns = market_data.get_index_returns(wind_code_list, '20251231', zhoubao_date)\nresult_list.append(np.array(returns) * 365 / deltadays)\n\n# è®¡ç®—è¿‘1æœˆæ³¢åŠ¨ç‡\nstart_1m = ''.join(str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=30)).date()).split('-'))\nvol_1m = market_data.get_index_volatility(wind_code_list, start_1m, zhoubao_date)\nresult_list.append(np.array(vol_1m) if vol_1m else np.array([None] * len(wind_code_list)))\n\n# è®¡ç®—ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡\nvol_ytd = market_data.get_index_volatility(wind_code_list, '20251231', zhoubao_date)\nresult_list.append(np.array(vol_ytd) if vol_ytd else np.array([None] * len(wind_code_list)))\n\nresult_list.append(np.array(market_data.get_index_names(wind_code_list)))\nresult_df = pd.DataFrame(result_list).T\nresult_df.index = wind_code_list\nresult_df.columns = [\n    'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', '2026å¹´å¹´åŒ–æ”¶ç›Šç‡',\n    'è¿‘1æœˆæ³¢åŠ¨ç‡', 'ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡', 'æŒ‡æ•°ç®€ç§°'\n]\nresult_df.to_excel(writer, sheet_name='15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š')\n\n\n# ==============================================================================\n# ç¬¬äºŒåéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - ç ´å‡€ç»“æœ\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: ç ´å‡€ç»“æœ\n# ------------------------------------------------------------------------------\nprint(\"\\n[16] ç”ŸæˆæŠ¥è¡¨: ç ´å‡€ç»“æœ...\")\n\nnav_date = yunzuogailan_date\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(yunzuogailan_date), index_col=0))\nyunzuogailan_now['ç´¯ç§¯å‡€å€¼'] = [data_transposition.loc[nav_date, x] for x in yunzuogailan_now.index]\nyunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] = [\n    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(7), x] for x in yunzuogailan_now.index\n]\nyunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] = [\n    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(int(nav_date[-2:])), x] for x in yunzuogailan_now.index\n]\npojing_df = yunzuogailan_now[yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] < 1].copy()\n\npojing_df['è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] - 1\npojing_df['è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] - 1\npojing_df['æ£€æµ‹æ—¶ç‚¹'] = nav_date\npojing_df['äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰'] = pojing_df['å‡€èµ„äº§(äº¿)'] / pojing_df['å•ä½å‡€å€¼']\npojing_df = pojing_df.reset_index()\npojing_df_final = pojing_df[\n    ['æ£€æµ‹æ—¶ç‚¹', 'äº§å“ç®€ç§°', 'äº§å“ä»£ç ', 'äº§å“ç»ç†', 'äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰', 'åˆ°æœŸæ—¥', 'ç´¯ç§¯å‡€å€¼', 'è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–', 'è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–']\n]\nquant = ['ç‹æµ©', 'å¼ é›…å©•', 'å­™æ–°å']\n\n\ndef manager_in_or_not_count(s: str, y: list):\n    sum_here = 0\n    for mid_y in y:\n        if mid_y in s:\n            sum_here += 1\n    return 1 if sum_here > 0 else 0\n\n\npojing_df_final = pojing_df_final[pojing_df_final['äº§å“ç»ç†'].map(lambda x: manager_in_or_not_count(x, quant)) == 0]\npojing_df_final.to_excel(writer, sheet_name='ç ´å‡€ç»“æœ')\n\n\n# ==============================================================================\n# ç¬¬äºŒåä¸€éƒ¨åˆ†ï¼šç”Ÿæˆæ€»ç»“æ–‡å­—\n# ==============================================================================\n\n# ------------------------------------------------------------------------------\n# æŠ¥è¡¨: æ€»ç»“æ–‡å­—ï¼ˆAIç”Ÿæˆï¼‰\n# ------------------------------------------------------------------------------\nprint(\"\\n[17] ç”ŸæˆæŠ¥è¡¨: æ€»ç»“æ–‡å­—ï¼ˆAIç”Ÿæˆï¼‰...\")\n\n# ä½¿ç”¨configä¸­çš„promptæ¨¡æ¿ç”Ÿæˆæ€»ç»“æ–‡å­—\nprompt_zs = Config.PROMPT_ZHONGSHOU.format(\n    date=yunzuogailan_date,\n    data=round(result_9.sum(axis=0), 2)\n)\n\nprompt_gm = Config.PROMPT_GUIMO.format(\n    date=yunzuogailan_date,\n    channel_data=round(Channel_result1.sum(axis=0), 0),\n    series_data=round(result_3.astype(float).sum(axis=0), 0)\n)\n\ndaoqi_summary = Config.PROMPT_DAOQI.format(\n    total=result_df_10_2['å‡€èµ„äº§(äº¿)'].sum(),\n    fengbi=result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum(),\n    dingkai=result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()\n)\n\nguimo_summary = get_wenzi_result(prompt_gm)\nzhongshou_summary = get_wenzi_result(prompt_zs)\n\nwenzi = {'åˆ°æœŸæ–‡å­—': daoqi_summary, 'ä¸­æ”¶æ–‡å­—': zhongshou_summary, 'è§„æ¨¡æ–‡å­—': guimo_summary}\nwenzidf = pd.DataFrame([wenzi]).T.rename(columns={0: 'æ–‡å­—'})\nwenzidf.to_excel(writer, sheet_name='æ€»ç»“æ–‡å­—')\n\n\n# ==============================================================================\n# ç¬¬äºŒåäºŒéƒ¨åˆ†ï¼šä¿å­˜å¹¶å…³é—­\n# ==============================================================================\n\nwriter.close()\n\nprint(\"\\n\" + \"=\" * 60)\nprint(\"âœ… å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆå®Œæˆï¼\")\nprint(f\"   è¾“å‡ºæ–‡ä»¶: {Config.get_current_output_writer(date)}\")\nprint(\"=\" * 60)\n","structuredPatch":[{"oldStart":1,"oldLines":468,"newStart":1,"newLines":507,"lines":["-# å¯¼å…¥åŒ…","+\"\"\"","+å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆè„šæœ¬","+","+è¯¥è„šæœ¬æ˜¯å‘¨æŠ¥ç”Ÿæˆç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£ï¼š","+1. åŠ è½½äº§å“å‡€å€¼ã€è¿ä½œæ¦‚è§ˆã€æ¸ é“ä¿æœ‰é‡ç­‰æ•°æ®","+2. è®¡ç®—å„ç±»ä¸šç»©æŒ‡æ ‡å’Œç»Ÿè®¡æ•°æ®","+3. ç”Ÿæˆå¤šä¸ªåˆ†ææŠ¥è¡¨åˆ°Excelè¾“å‡ºæ–‡ä»¶","+4. è°ƒç”¨AIç”Ÿæˆæ€»ç»“æ–‡å­—","+","+è¾“å‡ºExcelåŒ…å«ä»¥ä¸‹å·¥ä½œè¡¨ï¼š","+- 1ã€åˆ†æ¸ é“ä½™é¢","+- æ¸ é“æ˜ç»†","+- 2ã€äº§å“è§„æ¨¡","+- 3ã€æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–","+- æœ¬å‘¨æ–°å‘äº§å“","+- å¾…å”®äº§å“","+- ç³»åˆ—äº§å“ä¸šç»©ï¼ˆè´¹åå¹³å‡/åŠ æƒã€è´¹å‰å¹³å‡/åŠ æƒï¼‰","+- 5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°","+- æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡","+- æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†","+- 8.èµ„äº§å¤§è¡¨","+- 9.ä¸­æ”¶ç›‘æ§","+- 10.äº§å“åˆ°æœŸæƒ…å†µ","+- 11.å„ç±»æŒä»“æ˜ç»†","+- 12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•","+- 13-14.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡","+- 15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š","+- ç ´å‡€ç»“æœ","+- æ€»ç»“æ–‡å­—","+\"\"\"","+","+# ==============================================================================","+# ç¬¬ä¸€éƒ¨åˆ†ï¼šå¯¼å…¥ä¾èµ–","+# ==============================================================================","+"," import os"," import pandas as pd"," import numpy as np"," from datetime import datetime, timedelta, date"," import copy","-from utils import *"," import warnings"," warnings.filterwarnings(\"ignore\")","-# å¯¼å…¥ç»Ÿä¸€é…ç½®æ–‡ä»¶ - ä¿æŒæ‰€æœ‰è®¡ç®—é€»è¾‘ä¸å˜","-from config import *","-# å¯¼å…¥æ•°æ®éªŒè¯æ¨¡å— - ç¡®ä¿æŠ•èµ„æ•°æ®å‡†ç¡®æ€§","+","+# å¯¼å…¥é¡¹ç›®æ¨¡å—","+from config import Config","+from config import *  # å‘åå…¼å®¹ï¼Œå¯¼å…¥å¸¸ç”¨å˜é‡","+from utils import *"," from data_validator import DataValidator, safe_read_excel, validate_critical_paths","-from openai import OpenAI","-# å¯¼å…¥å¸‚åœºæ•°æ®æä¾›è€…æ¨¡å—ï¼ˆå°è£…Windè°ƒç”¨ï¼‰"," from market_data_provider import MarketDataProvider","-import glob","+from load_data import (","+    DataLoader,","+    map_product_xingtai,","+    get_zhaoshang_label,","+    get_qudao_label_detail,","+    del_Innovation_department","+)","+from openai import OpenAI"," ","+","+# ==============================================================================","+# ç¬¬äºŒéƒ¨åˆ†ï¼šåˆå§‹åŒ–","+# ==============================================================================","+","+print(\"=\" * 60)","+print(\"ğŸš€ å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆ - åˆå§‹åŒ–\")","+print(\"=\" * 60)","+","+# åˆå§‹åŒ–æ•°æ®åŠ è½½å™¨","+data_loader = DataLoader()","+"," # åˆå§‹åŒ–å¸‚åœºæ•°æ®æä¾›è€…ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰"," market_data = MarketDataProvider.get_instance()"," ","-def get_wenzi_result(prompt):","-    client = OpenAI(api_key=Config.DEEPSEEK_API_KEY, base_url=Config.DEEPSEEK_BASE_URL)","-    response = client.chat.completions.create(","-        model=Config.DEEPSEEK_MODEL,","-        messages=[","-            {\"role\": \"system\", \"content\": \"You are a helpful assistant\"},","-            {\"role\": \"user\", \"content\": prompt},","-        ],","-        stream=False","-    )","-    return response.choices[0].message.content","-"," # åˆå§‹åŒ–æ•°æ®éªŒè¯å™¨"," validator = DataValidator(log_errors=True)"," "," # éªŒè¯å…³é”®è·¯å¾„","-print(\"ğŸ” å¼€å§‹éªŒè¯å…³é”®æ•°æ®è·¯å¾„...\")","+print(\"\\nğŸ” éªŒè¯å…³é”®æ•°æ®è·¯å¾„...\")"," path_validation = validate_critical_paths(Config)"," if not path_validation['is_valid']:","     print(\"âŒ å…³é”®è·¯å¾„éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®ç›®å½•ç»“æ„\")","     for error in path_validation['errors']:","         print(f\"   - {error}\")"," ","-## todo  å‘¨æŠ¥æ–‡å­—éƒ¨åˆ†è‡ªåŠ¨æ›´æ–°äº§å“è®¡åˆ’åŠä¸Šä¸ªæœˆçš„è§„æ¨¡æƒ…å†µ"," ","+# ==============================================================================","+# ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¾…åŠ©å‡½æ•°å®šä¹‰","+# =============================================================================="," ","-# æ³¨æ„ï¼šä»¥ä¸‹å˜é‡å·²åœ¨config.pyä¸­ç»Ÿä¸€é…ç½®ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹","-# æ‰€æœ‰è®¡ç®—é€»è¾‘å’Œæ•°æ®å¤„ç†ä¿æŒå®Œå…¨ä¸å˜","-# Underlying_data_folder_path, yunzuogailan_date, zhoubao_date ç­‰å˜é‡","-# ç°åœ¨éƒ½ä»config.pyè‡ªåŠ¨åŠ è½½ï¼Œç¡®ä¿æ•°æ®è®¡ç®—ç»“æœå®Œå…¨ä¸€è‡´","+def get_wenzi_result(prompt: str) -> str:","+    \"\"\"è°ƒç”¨DeepSeek APIç”Ÿæˆæ–‡å­—\"\"\"","+    client = OpenAI(api_key=Config.DEEPSEEK_API_KEY, base_url=Config.DEEPSEEK_BASE_URL)","+    response = client.chat.completions.create(","+        model=Config.DEEPSEEK_MODEL,","+        messages=[","+            {\"role\": \"system\", \"content\": \"You are a helpful assistant\"},","+            {\"role\": \"user\", \"content\": prompt},","+        ],","+        stream=False","+    )","+    return response.choices[0].message.content"," "," ","-def get_product_data(COOKED_FOLDER, force_rebuild=False):","-    \"\"\"","-    è¯»å–äº§å“å‡€å€¼æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜æœºåˆ¶å¤§å¹…æå‡æ€§èƒ½","+def rank_by_sort(my_df: pd.DataFrame, rank_def: list) -> pd.DataFrame:","+    \"\"\"æŒ‰æŒ‡å®šé¡ºåºå¯¹DataFrameç´¢å¼•æ’åº\"\"\"","+    my_df = my_df.copy()","+    actual = list(my_df.index)","+    new_order = [x for x in rank_def if x in actual] + [x for x in actual if x not in rank_def]","+    order_map = {val: i for i, val in enumerate(new_order)}","+    my_df['__order__'] = my_df.index.map(order_map).fillna(len(new_order))","+    my_df = my_df.sort_values('__order__').drop(columns='__order__')","+    return my_df"," ","-    ç¼“å­˜ç­–ç•¥ï¼š","-    1. é¦–æ¬¡è¿è¡Œï¼šè¯»å–æ‰€æœ‰Excelæ–‡ä»¶ï¼Œä¿å­˜ä¸ºparquetç¼“å­˜","-    2. åç»­è¿è¡Œï¼šåªè¯»å–æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶ï¼Œä¸ç¼“å­˜åˆå¹¶","-    3. ç›¸åŒæ—¥æœŸ+äº§å“ä»£ç çš„æ•°æ®ï¼Œä¿ç•™æœ€æ–°æ–‡ä»¶çš„å€¼"," ","-    å‚æ•°ï¼š","-        COOKED_FOLDER: å‡€å€¼æ•°æ®æ–‡ä»¶å¤¹è·¯å¾„","-        force_rebuild: æ˜¯å¦å¼ºåˆ¶é‡å»ºç¼“å­˜ï¼ˆé»˜è®¤Falseï¼‰","-    \"\"\"","-    import pickle","-    import time","+def full_category_or_not(df_def: pd.DataFrame, rank_def: list) -> pd.DataFrame:","+    \"\"\"åˆ¤æ–­å“ç±»Indexæ˜¯å¦é½å…¨ï¼Œè¡¥å……ç¼ºå¤±çš„å“ç±»\"\"\"","+    df_def = df_def.copy()","+    for x in rank_def:","+        if x not in df_def.index:","+            df_def.loc[x, :] = None","+    return df_def"," ","-    # ç¼“å­˜ç›®å½•å’Œæ–‡ä»¶","-    cache_dir = os.path.join(os.path.dirname(COOKED_FOLDER), '.nav_cache')","-    cache_data_file = os.path.join(cache_dir, 'nav_master_data.parquet')","-    cache_meta_file = os.path.join(cache_dir, 'nav_metadata.pkl')"," ","-    # ç¡®ä¿ç¼“å­˜ç›®å½•å­˜åœ¨","-    os.makedirs(cache_dir, exist_ok=True)","+def manager_in_or_not(s: str, y: list) -> bool:","+    \"\"\"åˆ¤æ–­æŠ•èµ„ç»ç†æ˜¯å¦åœ¨æŒ‡å®šåˆ—è¡¨ä¸­\"\"\"","+    if pd.isnull(s):","+        return False","+    for mid_y in y:","+        if mid_y in s:","+            return True","+    return False"," ","-    # è·å–æ‰€æœ‰Excelæ–‡ä»¶åŠå…¶ä¿®æ”¹æ—¶é—´","-    excel_files = glob.glob(os.path.join(COOKED_FOLDER, '*.xlsx'))","-    excel_files = [f for f in excel_files if not os.path.basename(f).startswith('~$')]  # æ’é™¤ä¸´æ—¶æ–‡ä»¶"," ","-    current_files_info = {}","-    for f in excel_files:","-        mtime = os.path.getmtime(f)","-        current_files_info[f] = mtime","+def clear_manager_name(s: str) -> str:","+    \"\"\"æ¸…ç†æŠ•èµ„ç»ç†åç§°ï¼Œåªä¿ç•™éƒ¨é—¨å†…ç»ç†\"\"\"","+    first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦', 'æä½³èˆª', \"è‹æ–‡æ´¥\", \"å¤å‡¡ç››\", \"é»„äº¦å°§\"]","+    second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ', \"ç½—è°¨æ·±\"]","+    third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°', 'å»–ç‚¯è‡£']","+    merge_s = []","+    for mid_s in s.split(','):","+        if mid_s in first + second + third:","+            merge_s.append(mid_s)","+    return ','.join(merge_s)"," ","-    print(f\"ğŸ“‚ å‡€å€¼æ•°æ®æ–‡ä»¶å¤¹: {COOKED_FOLDER}\")","-    print(f\"ğŸ“Š å‘ç° {len(excel_files)} ä¸ªExcelæ–‡ä»¶\")"," ","-    # åŠ è½½ç¼“å­˜å…ƒæ•°æ®","-    cached_files_info = {}","-    cached_data = None","+def adjust_manager_aum(mid_data: pd.DataFrame) -> pd.DataFrame:","+    \"\"\"è°ƒæ•´å¤šæŠ•èµ„ç»ç†å…±ç®¡äº§å“çš„è§„æ¨¡åˆ†é…\"\"\"","+    final_mid_data = mid_data.copy()","+    final_mid_data['åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data['å‡€èµ„äº§(äº¿)']","+    final_mid_data['åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1"," ","-    if not force_rebuild and os.path.exists(cache_meta_file) and os.path.exists(cache_data_file):","-        try:","-            with open(cache_meta_file, 'rb') as f:","-                cached_files_info = pickle.load(f)","-            cached_data = pd.read_parquet(cache_data_file)","-            print(f\"âœ… å·²åŠ è½½ç¼“å­˜æ•°æ®: {len(cached_data)} æ¡è®°å½•\")","-        except Exception as e:","-            print(f\"âš ï¸ ç¼“å­˜åŠ è½½å¤±è´¥ï¼Œå°†é‡å»ºç¼“å­˜: {e}\")","-            cached_files_info = {}","-            cached_data = None","+    new_rows = []","+    for indx in mid_data.index:","+        mng_list = mid_data.loc[indx, 'äº§å“ç»ç†'].split(',')","+        if len(mng_list) > 1:","+            i = 0","+            for mng in mng_list:","+                if i == 0:","+                    final_mid_data.loc[indx, 'äº§å“ç»ç†'] = mng","+                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] / 2","+                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1 / len(mng_list)","+                    i += 1","+                else:","+                    mid_series = final_mid_data.loc[indx].copy()","+                    mid_series['äº§å“ç»ç†'] = mng","+                    new_rows.append(pd.DataFrame(mid_series).T)"," ","-    # æ‰¾å‡ºéœ€è¦è¯»å–çš„æ–‡ä»¶ï¼ˆæ–°å¢æˆ–ä¿®æ”¹çš„ï¼‰","-    files_to_read = []","-    for f, mtime in current_files_info.items():","-        if f not in cached_files_info or cached_files_info[f] != mtime:","-            files_to_read.append(f)","+    if new_rows:","+        final_mid_data = pd.concat([final_mid_data] + new_rows, ignore_index=False)"," ","-    needed_cols = ['ä¼°å€¼æ—¥', 'äº§å“ä»£ç ', 'ç´¯è®¡å‡€å€¼']","+    return final_mid_data"," ","-    if len(files_to_read) == 0 and cached_data is not None:","-        print(f\"âœ… æ‰€æœ‰æ–‡ä»¶å‡å·²ç¼“å­˜ï¼Œæ— éœ€é‡æ–°è¯»å–\")","-        data = cached_data","-    else:","-        print(f\"ğŸ“– éœ€è¦è¯»å– {len(files_to_read)} ä¸ªæ–‡ä»¶ï¼ˆæ–°å¢æˆ–å·²ä¿®æ”¹ï¼‰\")"," ","-        # è¯»å–æ–°æ–‡ä»¶","-        start_time = time.time()","-        new_dfs = []","+def get_scaleandnum_by_sort_manager(my_df: pd.DataFrame) -> pd.DataFrame:","+    \"\"\"åŒ¹é…å­æ¯åˆ†ç±»å…³ç³»å¹¶è°ƒæ•´æŠ•èµ„ç»ç†\"\"\"","+    Parent_sort = data_loader.load_parent_sort(['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»'])","+    my_df = my_df.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')","+    my_df['äº§å“ç»ç†'] = my_df['äº§å“ç»ç†'].map(clear_manager_name)","+    return adjust_manager_aum(my_df)"," ","-        for i, f in enumerate(files_to_read, 1):","-            if i % 10 == 0 or i == len(files_to_read):","-                print(f\"   è¯»å–è¿›åº¦: {i}/{len(files_to_read)} - {os.path.basename(f)}\")","-            try:","-                df = pd.read_excel(f, usecols=needed_cols)","-                df['_source_file'] = f  # è®°å½•æ¥æºæ–‡ä»¶ç”¨äºè¿½è¸ª","-                new_dfs.append(df)","-            except Exception as e:","-                print(f\"   âš ï¸ è¯»å–å¤±è´¥: {os.path.basename(f)} - {e}\")"," ","-        read_time = time.time() - start_time","-        print(f\"   è¯»å–è€—æ—¶: {read_time:.1f} ç§’\")","-","-        # åˆå¹¶æ–°æ•°æ®ä¸ç¼“å­˜æ•°æ®","-        if new_dfs:","-            new_data = pd.concat(new_dfs, ignore_index=True)","-","-            if cached_data is not None and len(files_to_read) < len(excel_files):","-                # å¢é‡æ›´æ–°ï¼šåˆå¹¶æ–°æ—§æ•°æ®","-                # å¯¹äºä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼Œéœ€è¦å…ˆåˆ é™¤æ—§æ•°æ®","-                modified_files = [f for f in files_to_read if f in cached_files_info]","-                if modified_files and '_source_file' in cached_data.columns:","-                    cached_data = cached_data[~cached_data['_source_file'].isin(modified_files)]","-","-                data = pd.concat([cached_data, new_data], ignore_index=True)","-                print(f\"   å¢é‡åˆå¹¶å®Œæˆ: ç¼“å­˜ {len(cached_data)} + æ–°å¢ {len(new_data)} æ¡\")","-            else:","-                data = new_data","-        else:","-            data = cached_data if cached_data is not None else pd.DataFrame(columns=needed_cols)","-","-    # å»é‡ï¼šç›¸åŒæ—¥æœŸ+äº§å“ä»£ç ä¿ç•™æœ€åå‡ºç°çš„ï¼ˆå³æœ€æ–°æ–‡ä»¶çš„æ•°æ®ï¼‰","-    before_dedup = len(data)","-    data.drop_duplicates(subset=['ä¼°å€¼æ—¥', 'äº§å“ä»£ç '], keep='last', inplace=True)","-    print(f\"   å»é‡: {before_dedup} -> {len(data)} æ¡è®°å½•\")","-","-    # ä¿å­˜æ›´æ–°åçš„ç¼“å­˜","-    if len(files_to_read) > 0 or not os.path.exists(cache_data_file):","+def get_yejijizhunxiaxian(x: str) -> str:","+    \"\"\"è·å–ä¸šç»©åŸºå‡†ä¸‹é™\"\"\"","+    if not pd.isnull(x):","         try:","-            # ç¡®ä¿äº§å“ä»£ç ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œé¿å…parquetä¿å­˜å¤±è´¥ï¼ˆæ··åˆint/strç±»å‹ä¼šæŠ¥é”™ï¼‰","-            if 'äº§å“ä»£ç ' in data.columns:","-                data['äº§å“ä»£ç '] = data['äº§å“ä»£ç '].astype(str)","-            data.to_parquet(cache_data_file, index=False)","-            with open(cache_meta_file, 'wb') as f:","-                pickle.dump(current_files_info, f)","-            print(f\"ğŸ’¾ ç¼“å­˜å·²æ›´æ–°: {cache_data_file}\")","-        except Exception as e:","-            print(f\"âš ï¸ ç¼“å­˜ä¿å­˜å¤±è´¥: {e}\")","+            float(x.split('-')[0][:-1])","+            return x.split('-')[0]","+        except ValueError:","+            return \"\"","+    else:","+        return x"," ","-    # æ„å»ºé€è§†è¡¨","-    print(f\"ğŸ”„ æ„å»ºæ•°æ®é€è§†è¡¨...\")"," ","-    # ç§»é™¤è¾…åŠ©åˆ—å†åšé€è§†","-    pivot_data = data[['ä¼°å€¼æ—¥', 'äº§å“ä»£ç ', 'ç´¯è®¡å‡€å€¼']].copy()","+def get_zhouqi_scale(x: int) -> str:","+    \"\"\"æ ¹æ®å‘¨æœŸå¤©æ•°è¿”å›å‘¨æœŸåŒºé—´æ ‡ç­¾\"\"\"","+    if x < 30 * 7:","+        return '<6M'","+    elif (x >= 30 * 7) and (x < 13 * 30):","+        return '6M-1Y'","+    elif x >= 13 * 30:","+        return '>1Y'","+    else:","+        return 'error'"," ","-    data_transposition = pd.pivot_table(","-        pivot_data,","-        index='ä¼°å€¼æ—¥',","-        columns='äº§å“ä»£ç ',","-        values='ç´¯è®¡å‡€å€¼',","-        aggfunc='median'","-    )"," ","-    # ä¼˜åŒ–æ—¥æœŸè½¬æ¢ - æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼","-    try:","-        data_transposition.index = pd.to_datetime(data_transposition.index, format='%Y/%m/%d')","-    except:","-        data_transposition.index = pd.to_datetime(data_transposition.index, errors='coerce')","+def get_zhouqi_scale_v2(x: int) -> str:","+    \"\"\"æ ¹æ®å‘¨æœŸå¤©æ•°è¿”å›å‘¨æœŸåŒºé—´æ ‡ç­¾ï¼ˆè¯¦ç»†ç‰ˆï¼‰\"\"\"","+    if x == 1:","+        return 'æ—¥ç›ˆ'","+    elif x < 30:","+        return '<1M'","+    elif x < 31 * 3:","+        return '1M-3M'","+    elif x < 31 * 6:","+        return '3M-6M'","+    elif x < 12 * 31:","+        return '6M-1Y'","+    elif x >= 12 * 31:","+        return '>1Y'","+    else:","+        return 'error'"," ","-    data_transposition = data_transposition.sort_index()","-    data_transposition.columns = data_transposition.columns.astype(str)"," ","-    print(f\"âœ… æ•°æ®åŠ è½½å®Œæˆ: {len(data_transposition)} ä¸ªäº¤æ˜“æ—¥, {len(data_transposition.columns)} ä¸ªäº§å“\")","+# ==============================================================================","+# ç¬¬å››éƒ¨åˆ†ï¼šåŠ è½½åŸºç¡€æ•°æ®","+# =============================================================================="," ","-    return data, data_transposition","+print(\"\\n\" + \"=\" * 60)","+print(\"ğŸ“Š åŠ è½½åŸºç¡€æ•°æ®...\")","+print(\"=\" * 60)"," ","+# 4.1 åŠ è½½äº§å“å‡€å€¼æ•°æ®ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰","+print(\"\\n[4.1] åŠ è½½äº§å“å‡€å€¼æ•°æ®...\")","+data, data_transposition = data_loader.load_nav_data()","+data_transposition.replace(0, np.nan, inplace=True)"," ","-print(\"\\n\" + \"=\"*60)","-print(\"ğŸ“Š å¼€å§‹åŠ è½½äº§å“å‡€å€¼æ•°æ®...\")","-print(\"=\"*60)","-data, data_transposition = get_product_data(COOKED_FOLDER)","-print(\"=\"*60 + \"\\n\")","+# 4.2 åŠ è½½DAPäº§å“ä¿¡æ¯è¡¨","+print(\"\\n[4.2] åŠ è½½DAPäº§å“ä¿¡æ¯è¡¨...\")","+Product_information_df_DAP = data_loader.load_product_info_dap()"," ","-# DAPäº§å“ä¿¡æ¯è¡¨","-Product_information_df_DAP = pd.read_excel(Config.get_weekly_data_file('ç†è´¢äº§å“ä¿¡æ¯æŸ¥è¯¢'), index_col=0)","+# 4.3 åŠ è½½å“ç±»åˆ†ç±»æ•°æ®","+print(\"\\n[4.3] åŠ è½½å“ç±»åˆ†ç±»æ•°æ®...\")","+classification_df = data_loader.load_classification_df()","+classification_ye = classification_df['å¤šèµ„äº§å“ç±»']"," ","+# 4.4 åŠ è½½é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»","+print(\"\\n[4.4] åŠ è½½é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»...\")","+Parent_sort = data_loader.load_parent_sort(['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»'])"," ","-# åˆ¤æ–­äº§å“å½¢æ€","-def map_product_xingtai(series_here):","-    if series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å°é—­å¼':","-        return 'å°é—­'","-    elif (series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å¼€æ”¾å¼') and (series_here['å‘¨æœŸå±æ€§'] == 'å®¢æˆ·å‘¨æœŸ'):","-        return 'å®¢æˆ·å‘¨æœŸ'","-    elif (series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å¼€æ”¾å¼') and (series_here['å‘¨æœŸå±æ€§'] == 'äº§å“å‘¨æœŸ') and (","-            series_here['å‘¨æœŸå¤©æ•°'] == 1):","-        return 'æ—¥å¼€'","-    elif (series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å¼€æ”¾å¼') and (series_here['å‘¨æœŸå±æ€§'] == 'äº§å“å‘¨æœŸ'):","-        return 'å®šå¼€'"," ","+# ==============================================================================","+# ç¬¬äº”éƒ¨åˆ†ï¼šç”Ÿæˆäº§å“è¿ä½œæ¦‚è§ˆæ•°æ®","+# =============================================================================="," ","-# è·å–æ‹›å•†æ ‡ç­¾","-def get_zhaoshang_label(set_here):","-    if 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸' in set_here:","-        if len(set_here.difference({'-', 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'})) == 0:","-            return 'æ‹›å•†ç‹¬æœ‰'","-        else:","-            return 'æ‹›å•†å…±æœ‰'","-    else:","-        return 'éæ‹›å•†'","+def get_yunzuogailan(yunzuogailan_date: str) -> None:","+    \"\"\"","+    ç”Ÿæˆå¹¶ä¿å­˜äº§å“è¿ä½œæ¦‚è§ˆæ•°æ®"," ","+    å‚æ•°ï¼š","+        yunzuogailan_date: è¿ä½œæ¦‚è§ˆæ—¥æœŸ (YYYYMMDDæ ¼å¼)","+    \"\"\"","+    print(f\"\\n[5.0] ç”Ÿæˆäº§å“è¿ä½œæ¦‚è§ˆæ•°æ® - {yunzuogailan_date}\")"," ","-# è·å–æ‰€æœ‰çš„æ¸ é“æ ‡ç­¾","-def get_qudao_label_detail(set_here):","-    # æ¸ é“ç®€ç§°åŒ¹é…ï¼ˆä»config.pyè¯»å–é…ç½®ï¼‰","-    qudao_forshort_dict = Config.CHANNEL_SHORT_NAMES","-    qudao_rank_dict = dict(enumerate(qudao_forshort_dict.keys()))","-    qudao_rank_dict = dict([val, key] for key, val in qudao_rank_dict.items())","-    if \"-\" in set_here:","-        set_here.remove(\"-\")","-    to_sort_list = list((x, qudao_rank_dict[x]) for x in set_here)  # æŒ‰ç…§ç”±ä¸»åˆ°æ¬¡å¯¹æ¸ é“å±•ç¤ºé¡ºåºæ’åº","-    to_sort_list.sort(key=lambda y: y[1])","-    return \",\".join([qudao_forshort_dict[x[0]] for x in to_sort_list])","+    # åŠ è½½åŸå§‹æ•°æ®","+    yunzuogailan_before = data_loader.load_yunzuogailan_raw()","+    Baoyou_df = data_loader.load_baoyou_data()"," ","-","-def get_yunzuogailan(yunzuogailan_date):","-    yunzuogailan_before = pd.read_excel(Config.get_weekly_data_file('äº§å“è¿ä½œæ¦‚è§ˆ'), index_col=0)","-    yunzuogailan_before.drop_duplicates(inplace=True)","-    # å¤„ç†paså¯¼å‡ºçš„ä¸šç»©åŸºå‡†ï¼Œxå·è¢«å¯¼å‡ºä¸º&times;","-    yunzuogailan_before['ä¸šç»©åŸºå‡†'] = yunzuogailan_before['ä¸šç»©åŸºå‡†'].map(","-        lambda s: s.replace(\"&times;\", \"*\") if (isinstance(s, str)) and (\"&times;\" in s) else s)","-    Baoyou_df = pd.read_excel(Config.get_weekly_data_file('å„æ¸ é“ä¿æœ‰é‡'), index_col=0)","-    # åˆ é™¤æ¸ é“ä¿æœ‰é‡ä¸­å­äº§å“çš„æ¸ é“ä¸º-çš„ è¿™ä¸ªæ˜¯æ±‡æ€»æ¡ï¼Œä¼šä½¿å¾—è§„æ¨¡è®¡ç®—å‡ºé”™","-    Baoyou_df_sub = Baoyou_df[Baoyou_df['æ¸ é“åç§°'] != '-']","-    Baoyou_df_mom = Baoyou_df[Baoyou_df.apply(lambda x: '(å­' not in x['äº§å“ç®€ç§°'], axis=1)]","-    Baoyou_df = pd.concat([Baoyou_df_mom, Baoyou_df_sub])","-    Baoyou_df.drop_duplicates(inplace=True)","-","     # åŒ¹é…ç†è´¢äº§å“çš„å­—æ¯ä»£ç ","     yunzuogailan_before['æ¯äº§å“ä»£ç '] = yunzuogailan_before['äº§å“ç®€ç§°'].map(","-        lambda x: yunzuogailan_before[yunzuogailan_before['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0])","+        lambda x: yunzuogailan_before[yunzuogailan_before['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]","+    )","     yunzuogailan_before = yunzuogailan_before[~(yunzuogailan_before['å•ä½å‡€å€¼'].isnull())]","+","     # è·å–ç¾å…ƒäº§å“æ¸…å•","     Dollar_product_list = list(","         set(Product_information_df_DAP[Product_information_df_DAP['å¸ç§'] == 'ç¾å…ƒ'].index).intersection(","-            yunzuogailan_before.index))","+            yunzuogailan_before.index","+        )","+    )","     yunzuogailan_before['å‡€èµ„äº§(äº¿)'] = yunzuogailan_before.apply(","-        lambda x: Baoyou_df.loc[x.name]['ä¿æœ‰è§„æ¨¡'].sum() / 100000000 if x.name in Dollar_product_list else x[","-            'å‡€èµ„äº§(äº¿)'], axis=1)","-    yunzuogailan_before = yunzuogailan_before.merge(Product_information_df_DAP[['å¸ç§']], left_index=True,","-                                                    right_index=True, how='left')","-","-    # åŒ¹é…å¶è€å¸ˆçš„å“ç±»","-    classification_df = pd.read_excel(","-        Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),","-        sheet_name='å¤šèµ„äº§å“ç±»æ ‡ç­¾',","-        index_col='æ¯äº§å“ä»£ç '","+        lambda x: Baoyou_df.loc[x.name]['ä¿æœ‰è§„æ¨¡'].sum() / 100000000 if x.name in Dollar_product_list else x['å‡€èµ„äº§(äº¿)'],","+        axis=1","     )","-    # å¤„ç†å¯èƒ½å­˜åœ¨çš„é‡å¤æ¯äº§å“ä»£ç ï¼Œé¿å…æ˜ å°„æ—¶è¿”å›Serieså¯¼è‡´åç»­mergeæŠ¥é”™","-    classification_df = classification_df[~classification_df.index.duplicated(keep='first')]","-    classification_ye = classification_df['å¤šèµ„äº§å“ç±»']","+    yunzuogailan_before = yunzuogailan_before.merge(","+        Product_information_df_DAP[['å¸ç§']], left_index=True, right_index=True, how='left'","+    )","+","+    # åŒ¹é…å“ç±»","     yunzuogailan_before['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(","-        lambda x: classification_ye[x] if x in classification_ye.index else np.nan)","+        lambda x: classification_ye[x] if x in classification_ye.index else np.nan","+    )","     yunzuogailan_before['äº§å“éƒ¨å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(","-        lambda x: classification_df['äº§å“éƒ¨å“ç±»'][x] if x in classification_ye.index else np.nan)","+        lambda x: classification_df['äº§å“éƒ¨å“ç±»'][x] if x in classification_ye.index else np.nan","+    )","+","     # åŒ¹é…äº§å“è¿ä½œå‘¨æœŸ","     patern = pd.Series(Product_information_df_DAP.apply(map_product_xingtai, axis=1), name='å½¢æ€')"," ","-    ###product_code_df=pd.read_excel(Underlying_data_folder_path+'/å­æ¯äº§å“ä»£ç -æ¬¡æ›´.xlsx',index_col=0)","+    # åˆå¹¶ä¿æœ‰é‡æ•°æ®","     Baoyou_df_merge = Baoyou_df.merge(yunzuogailan_before['æ¯äº§å“ä»£ç '], left_index=True, right_index=True, how='left')","     yunzuogailan_before = yunzuogailan_before.merge(patern, left_index=True, right_index=True, how='left')","-    yunzuogailan_before = yunzuogailan_before.merge(Product_information_df_DAP[['å‘¨æœŸå¤©æ•°', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°']],","-                                                    left_index=True, right_index=True, how='left')","+    yunzuogailan_before = yunzuogailan_before.merge(","+        Product_information_df_DAP[['å‘¨æœŸå¤©æ•°', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°']],","+        left_index=True, right_index=True, how='left'","+    )","+","     # åŒ¹é…æ‹›å•†æ ‡ç­¾","     Zhaoshang_label_df = pd.DataFrame(","         Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_zhaoshang_label(set(x['æ¸ é“åç§°']))),","-        columns=['æ˜¯å¦æ‹›å•†'])","-    yunzuogailan_before = yunzuogailan_before.merge(Zhaoshang_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True,","-                                                    how='left')","+        columns=['æ˜¯å¦æ‹›å•†']","+    )","+    yunzuogailan_before = yunzuogailan_before.merge(Zhaoshang_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')","+","+    # åŒ¹é…æ¸ é“æ˜ç»†","     Qudao_label_df = pd.DataFrame(","         Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_qudao_label_detail(set(x['æ¸ é“åç§°']))),","-        columns=['æ¸ é“æ˜ç»†'])","-","+        columns=['æ¸ é“æ˜ç»†']","+    )","     yunzuogailan_before = yunzuogailan_before.merge(Qudao_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')","-    # å¦‚æœæ˜¯2023å¹´12æœˆ31æ—¥çš„è¯ï¼Œæ¶‰åŠéƒ¨åˆ†æ‹†åˆ†äº§å“ç»ç†åˆ‡æ¢","+","+    # ç‰¹æ®Šæ—¥æœŸå¤„ç†","     if yunzuogailan_date in ['20231229', '20231231']:","         yunzuogailan_before['äº§å“ç»ç†'] = yunzuogailan_before.apply(","-            lambda x: Product_information_df_DAP.loc[x.name, 'æ¯äº§å“æŠ•èµ„ç»ç†'], axis=1)","+            lambda x: Product_information_df_DAP.loc[x.name, 'æ¯äº§å“æŠ•èµ„ç»ç†'], axis=1","+        )","+","     yunzuogailan_before.rename(columns={'ç»„åˆä¹…æœŸ(å¤šèµ„äº§)': 'ç»„åˆä¹…æœŸ'}, inplace=True)","     yunzuogailan_before.rename(columns={'ç»„åˆé™æ€(å¤šèµ„äº§)': 'ç»„åˆé™æ€'}, inplace=True)","-    yunzuogailan_before_v2 = yunzuogailan_before.merge(Product_information_df_DAP[['æ¯å­æ ‡å¿—']], left_index=True,","-                                                       right_index=True, how='left')","-    # å¯¹äºéæ¯å­äº§å“å’Œå­1ä»½é¢ï¼Œè´´ä¸Šâ€œä¸»è¦å±•ç¤ºâ€æ ‡ç­¾ 'éæ¯å­äº§å“' 'å­äº§å“' (å­1)","+","+    # åˆå¹¶æ¯å­æ ‡å¿—","+    yunzuogailan_before_v2 = yunzuogailan_before.merge(","+        Product_information_df_DAP[['æ¯å­æ ‡å¿—']], left_index=True, right_index=True, how='left'","+    )","+","+    # æ ‡è®°ä¸»è¦å±•ç¤ºäº§å“","     yunzuogailan_before_v2['ä¸»è¦å±•ç¤º'] = yunzuogailan_before_v2.apply(","-        lambda x: 'æ˜¯' if ((x['æ¯å­æ ‡å¿—'] == 'éæ¯å­äº§å“') or ('(å­1)' in x['äº§å“ç®€ç§°'])) else 'å¦', axis=1)","-    Parent_sort = pd.read_excel(","+        lambda x: 'æ˜¯' if ((x['æ¯å­æ ‡å¿—'] == 'éæ¯å­äº§å“') or ('(å­1)' in x['äº§å“ç®€ç§°'])) else 'å¦', axis=1","+    )","+","+    # åˆå¹¶æ¯åˆ†ç±»","+    Parent_sort_full = pd.read_excel(","         Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),","         sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»',","         index_col=0","     )[['æ¯åˆ†ç±»']]","-    # å»é‡ï¼Œç¡®ä¿ç´¢å¼•ï¼ˆå¤šèµ„äº§å“ç±»ï¼‰å”¯ä¸€","-    Parent_sort = Parent_sort[~Parent_sort.index.duplicated(keep='first')]","-    # é˜²å¾¡æ€§å¤„ç†ï¼šç¡®ä¿ç”¨äºåˆå¹¶çš„é”®åˆ—ä¸ºæ ‡é‡ï¼Œé¿å…å‡ºç° Series/åˆ—è¡¨ å¯¼è‡´ merge æŠ¥é”™","+    Parent_sort_full = Parent_sort_full[~Parent_sort_full.index.duplicated(keep='first')]","+","+    # é˜²å¾¡æ€§å¤„ç†","     if yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(lambda x: isinstance(x, pd.Series)).any():","-        print(\"âš ï¸ æ£€æµ‹åˆ° 'å¤šèµ„äº§å“ç±»' åˆ—ä¸­å­˜åœ¨ Series å€¼ï¼Œå·²è‡ªåŠ¨å–ç¬¬ä¸€ä¸ªéç©ºå…ƒç´ ä»¥ç¡®ä¿åˆå¹¶æ­£å¸¸è¿›è¡Œã€‚\")","+        print(\"âš ï¸ æ£€æµ‹åˆ° 'å¤šèµ„äº§å“ç±»' åˆ—ä¸­å­˜åœ¨ Series å€¼ï¼Œå·²è‡ªåŠ¨ä¿®å¤\")","         yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(","-            lambda s: s.dropna().iloc[0] if isinstance(s, pd.Series) and len(s.dropna()) > 0 else (np.nan if isinstance(s, pd.Series) else s)","+            lambda s: s.dropna().iloc[0] if isinstance(s, pd.Series) and len(s.dropna()) > 0 else (","+                np.nan if isinstance(s, pd.Series) else s","+            )","         )","-    yunzuogailan_before_v2 = yunzuogailan_before_v2.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True,","-                                                          how='left')"," ","-    # è¾“å‡ºåªä¿ç•™æ¯äº§å“ä»£ç çš„å¦åšå¤‡ç”¨","+    yunzuogailan_before_v2 = yunzuogailan_before_v2.merge(","+        Parent_sort_full, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left'","+    )","+","+    # ä¿å­˜æ¯äº§å“ç‰ˆæœ¬","     yunzuogailan_export = yunzuogailan_before_v2[yunzuogailan_before_v2['äº§å“ç®€ç§°'].map(lambda x: '(å­' not in x)]","-    # yunzuogailan_export['20231231å‡€å€¼']=yunzuogailan_export['æ¯äº§å“ä»£ç '].map(lambda x:data_transposition.loc['2023/12/31',x] if x in data_transposition.columns else np.nan)","-    keep_col_here = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',","-                     'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–',","-                     'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥',","-                     'å‘¨æœŸå¤©æ•°', 'æ˜¯å¦æ‹›å•†', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ¯åˆ†ç±»']","+    keep_col_here = [","+        'äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',","+        'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'é”€å”®è´¹',","+        'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å‘¨æœŸå¤©æ•°', 'æ˜¯å¦æ‹›å•†', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ¯åˆ†ç±»'","+    ]","     yunzuogailan_export = yunzuogailan_export[keep_col_here]","     yunzuogailan_export.drop_duplicates().to_excel(Config.get_overview_parent_file(yunzuogailan_date))","-    # yunzuogailan_before_v2.drop_duplicates().to_excel(Underlying_data_folder_path+'/äº§å“è¿ä½œæ¦‚è§ˆä¿¡æ¯è¡¨.xlsx')","+","+    # ç”Ÿæˆå¸¦å˜åŒ–æŒ‡æ ‡çš„ç‰ˆæœ¬","     yzgl = yunzuogailan_before_v2.drop_duplicates().copy()","     yzgl_lastw = pd.read_excel(Config.get_overview_history_file(lastw), index_col=0)","     yzgl_lastm = pd.read_excel(Config.get_overview_history_file(lastm), index_col=0)","+","     yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastw['ç»„åˆä¹…æœŸ']","     yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['æ æ†'] - yzgl_lastw['æ æ†']","     yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastw['æƒç›Šä»“ä½']","     yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastm['ç»„åˆä¹…æœŸ']","     yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['æ æ†'] - yzgl_lastm['æ æ†']","-    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastm['æƒç›Šä»“ä½']  ###è°ƒæ•´é¡ºåº","-    mu_col=['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', '5%æµåŠ¨æ€§å®é™…æŒ‡æ ‡', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ç´¯è®¡å¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'æ æ†',","-       'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'è¡ç”Ÿå“ä»“ä½', 'è¿ä½œå¤©', 'å‰©ä½™å¤©','äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'é”€å”®è´¹',","-       'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'æ¯äº§å“ä»£ç ', 'å¸ç§', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å½¢æ€', 'å‘¨æœŸå¤©æ•°',","-       'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ˜¯å¦æ‹›å•†', 'æ¸ é“æ˜ç»†', 'æ¯å­æ ‡å¿—', 'ä¸»è¦å±•ç¤º', 'æ¯åˆ†ç±»', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨',","-       'æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨', 'æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ', 'æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ', 'æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ']","+    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastm['æƒç›Šä»“ä½']","+","+    mu_col = [","+        'äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', '5%æµåŠ¨æ€§å®é™…æŒ‡æ ‡', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ç´¯è®¡å¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'æ æ†',","+        'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'è¡ç”Ÿå“ä»“ä½', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥',","+        'é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'æ¯äº§å“ä»£ç ', 'å¸ç§', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å½¢æ€', 'å‘¨æœŸå¤©æ•°',","+        'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ˜¯å¦æ‹›å•†', 'æ¸ é“æ˜ç»†', 'æ¯å­æ ‡å¿—', 'ä¸»è¦å±•ç¤º', 'æ¯åˆ†ç±»', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨',","+        'æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨', 'æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ', 'æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ', 'æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'","+    ]","     yzgl[mu_col].to_excel(Config.get_overview_history_file(yunzuogailan_date))","-    print(\"åŸºäºä»…æ¯äº§å“çš„è¡¨ æ›´æ–°å“ç±»æ¸…å•åé‡è·‘\")","+    print(\"   âœ… äº§å“è¿ä½œæ¦‚è§ˆæ•°æ®å·²ä¿å­˜\")","+","+","+# æ‰§è¡Œè¿ä½œæ¦‚è§ˆæ•°æ®ç”Ÿæˆ"," get_yunzuogailan(yunzuogailan_date)"," ","+","+# ==============================================================================","+# ç¬¬å…­éƒ¨åˆ†ï¼šåŠ è½½å¤„ç†åçš„æ•°æ®","+# ==============================================================================","+","+print(\"\\n[6.0] åŠ è½½å¤„ç†åçš„è¿ä½œæ¦‚è§ˆæ•°æ®...\")"," yunzuogailan_all = pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)","-Channel_df = pd.read_excel(Config.get_weekly_data_file('å„æ¸ é“ä¿æœ‰é‡'), index_col=0)","+Channel_df = data_loader.load_channel_data()"," date = zhoubao_date","-# 1.åŒ¹é…å“ç±»","-# åŒ¹é…å¶è€å¸ˆçš„å“ç±»","-classification_df = pd.read_excel(","-    Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),","-    sheet_name='å¤šèµ„äº§å“ç±»æ ‡ç­¾',","-    index_col='æ¯äº§å“ä»£ç '","-)","-# å¤„ç†é‡å¤æ¯äº§å“ä»£ç ï¼Œç¡®ä¿åç»­æ˜ å°„ä¸ºæ ‡é‡","-classification_df = classification_df[~classification_df.index.duplicated(keep='first')]","-classification_ye = classification_df['å¤šèµ„äº§å“ç±»']"," ","+# åˆ›å»ºè¾“å‡ºExcelå†™å…¥å™¨"," writer = pd.ExcelWriter(Config.get_current_output_writer(date))"," ","+# å®šä¹‰å“ç±»æ’åºé¡ºåº","+rank_here = [","+    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³äº«çŸ­æŒ'),","+    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³/çº¯äº«'),","+    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¼˜å…ˆè‚¡çŸ­æŒ'),","+    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¸°åˆ©/å¢ç›ˆ'),","+    ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'è¡Œå¤–éæ ‡é©±åŠ¨å‹å›ºæ”¶+'),","+    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å’Œç‘BOF'),","+    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€'),","+    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'é€¸åŠ¨çŸ­æŒ'),","+    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'çµåŠ¨çŸ­æŒ'),","+    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å…´åŠ¨çŸ­æŒ'),","+    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å«æƒå®šå¼€/å°é—­'),","+    ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'ESGè”å'),","+    ('å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),","+    ('å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼'),","+]"," ","-# Channel_result1.to_excel(writer,sheet_name='1ã€åˆ†æ¸ é“ä½™é¢')","-# Channel_result2.to_excel(writer,sheet_name='æ¸ é“æ˜ç»†')"," ","-# æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“","-def del_Innovation_department(mid_df):","-    mid_df = mid_df[mid_df['å¤šèµ„äº§å“ç±»'].map(","-        lambda x: x not in ['ç»“æ„æ€§ç†è´¢R2+', 'ç»“æ„æ€§ç†è´¢R3', 'ç»“æ„æ€§ç†è´¢R4', 'é‡åŒ–ç³»åˆ—', 'é‡åŒ–ç³»åˆ—(*)'])]","-    mid_df = mid_df[mid_df['äº§å“ç»ç†'].map(","-        lambda x: np.sum([k not in ['ç‹æµ©', 'å¼ é›…å©•', 'å­™æ–°å', ''] for k in x.split(',')]) != 0)]","-    return mid_df","+# ==============================================================================","+# ç¬¬ä¸ƒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æ¸ é“åˆ†æ","+# =============================================================================="," ","+print(\"\\n\" + \"=\" * 60)","+print(\"ğŸ“ˆ ç”ŸæˆæŠ¥è¡¨...\")","+print(\"=\" * 60)"," ","-# åŒ¹é…ç†è´¢äº§å“çš„å­—æ¯ä»£ç ","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨1: åˆ†æ¸ é“ä½™é¢","+# ------------------------------------------------------------------------------","+print(\"\\n[1] ç”ŸæˆæŠ¥è¡¨: 1ã€åˆ†æ¸ é“ä½™é¢...\")","+","+# åŒ¹é…æ¸ é“æ•°æ®çš„å“ç±»å’Œäº§å“ç»ç†"," Channel_df['æ¯äº§å“ä»£ç '] = Channel_df['äº§å“ç®€ç§°'].map(","-    lambda x: Channel_df[Channel_df['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0])","+    lambda x: Channel_df[Channel_df['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]","+)"," Channel_df['å¤šèµ„äº§å“ç±»'] = Channel_df['æ¯äº§å“ä»£ç '].map(","-    lambda x: classification_ye[x] if x in classification_ye.index else np.nan)","+    lambda x: classification_ye[x] if x in classification_ye.index else np.nan","+)"," Channel_df = Channel_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')","-Channel_df = Channel_df[~pd.isnull(Channel_df['äº§å“ç»ç†'])]  # ä»…ä¿ç•™æˆ‘éƒ¨äº§å“(ä¸è¿ä½œæ¦‚è§ˆåŒæ¸…å•)","-# æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“","+Channel_df = Channel_df[~pd.isnull(Channel_df['äº§å“ç»ç†'])]"," Channel_df = del_Innovation_department(Channel_df)","-# 2.ä»…ä¿ç•™å­äº§å“dfï¼ˆæ¸ é“ä¿¡æ¯è¡Œï¼‰","-# éƒ¨åˆ†å­äº§å“çš„æ¸ é“åç§°ä¸º'-â€™ï¼Œæ˜¯å› ä¸ºå…¶ä¸‹è¿˜å¯ä»¥è¿›ä¸€æ­¥å±•å¼€","-# å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ¯äº§å“éƒ½æ˜¯â€˜-â€™ï¼Œå› ä¸ºè¿˜æœ‰æ¯äº§å“ä¸å«å­äº§å“ï¼Œé‚£æ¯äº§å“æœ¬èº«å°±æ˜¯æ¸ é“æ•°æ®ï¼Œæ‰€ä»¥ä¸èƒ½åˆ é™¤æ‰€æœ‰æ¯äº§å“","+","+# å¤„ç†å­äº§å“æ¸ é“æ•°æ®"," Channel_df_subproduct = Channel_df[Channel_df['æ¸ é“åç§°'] != '-']"," Channel_df_subproduct['æ¸ é“-è¡Œå†…å¤–'] = Channel_df_subproduct['æ¸ é“åç§°'].map(","-    lambda x: 'è¡Œå†…' if x == 'å…´ä¸šé“¶è¡Œ' else 'è¡Œå¤–')","-# åŒ¹é…å¶è€å¸ˆçš„å­æ¯åˆ†ç±»å…³ç³»","-Parent_sort = pd.read_excel(","-    Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),","-    sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»',","-    index_col=0","-)[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]","-# å»é‡ï¼Œç¡®ä¿ç´¢å¼•ï¼ˆå¤šèµ„äº§å“ç±»ï¼‰å”¯ä¸€","-Parent_sort = Parent_sort[~Parent_sort.index.duplicated(keep='first')]","+    lambda x: 'è¡Œå†…' if x == 'å…´ä¸šé“¶è¡Œ' else 'è¡Œå¤–'","+)"," Channel_df_subproduct = Channel_df_subproduct.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')"," ","+# ç”Ÿæˆåˆ†æ¸ é“ä½™é¢è¡¨","+Channel_result1 = pd.pivot_table(","+    Channel_df_subproduct,","+    index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],","+    columns='æ¸ é“-è¡Œå†…å¤–',","+    values=['ä¿æœ‰è§„æ¨¡'],","+    aggfunc=np.sum","+) / 100000000","+Channel_result1 = rank_by_sort(Channel_result1, rank_here)"," ","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: æ¸ é“æ˜ç»†","+# ------------------------------------------------------------------------------","+print(\"[1.1] ç”ŸæˆæŠ¥è¡¨: æ¸ é“æ˜ç»†...\")"," ","-def rank_by_sort(my_df, rank_def):","-    my_df = my_df.copy()","-    # å®é™…å‡ºç°çš„ç´¢å¼•é›†åˆ","-    actual = list(my_df.index)","-    # æ„é€ æ–°çš„æ’åºé¡ºåºï¼šå…ˆæ”¾åœ¨ rank_def ä¸­ä¸”å®é™…å‡ºç°çš„ï¼Œå†æ”¾å…¶ä½™å®é™…å‡ºç°ä½†ä¸åœ¨ rank_def çš„","-    new_order = [x for x in rank_def if x in actual] + [x for x in actual if x not in rank_def]","-    # ä¾æ® new_order ç”Ÿæˆæ’åºé”®","-    order_map = {val: i for i, val in enumerate(new_order)}","-    my_df['__order__'] = my_df.index.map(order_map).fillna(len(new_order))","-    my_df = my_df.sort_values('__order__').drop(columns='__order__')","-    return my_df","-","-","-","-# å¯¹indexæ–‡æœ¬æŒ‰ç…§æŒ‡å®šé¡ºåºæ’åº","-rank_here = [('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³äº«çŸ­æŒ'),","-             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³/çº¯äº«'),","-             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¼˜å…ˆè‚¡çŸ­æŒ'),","-             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¸°åˆ©/å¢ç›ˆ'),","-             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'è¡Œå¤–éæ ‡é©±åŠ¨å‹å›ºæ”¶+'),","-             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å’Œç‘BOF'),","-             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€'),","-             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'é€¸åŠ¨çŸ­æŒ'),","-             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'çµåŠ¨çŸ­æŒ'),","-             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å…´åŠ¨çŸ­æŒ'),","-             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å«æƒå®šå¼€/å°é—­'),","-             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'ESGè”å'),","-             ('å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),","-             ('å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼'), ]","-","-# æ”¹æˆæ•°æ®é€è§†è¡¨çš„é‚£ç§æ ¼å¼","-Channel_result1 = pd.pivot_table(Channel_df_subproduct, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ¸ é“-è¡Œå†…å¤–',","-                                 values=['ä¿æœ‰è§„æ¨¡'], aggfunc=np.sum) / 100000000  # æ•°æ®é€è§†","-Channel_result1 = rank_by_sort(Channel_result1, rank_here)","-Channel_result2 = pd.pivot_table(Channel_df_subproduct, index=['æ¸ é“åç§°'], columns='æ€»åˆ†ç±»', values=['ä¿æœ‰è§„æ¨¡'],","-                                 aggfunc=np.sum) / 100000000","+Channel_result2 = pd.pivot_table(","+    Channel_df_subproduct,","+    index=['æ¸ é“åç§°'],","+    columns='æ€»åˆ†ç±»',","+    values=['ä¿æœ‰è§„æ¨¡'],","+    aggfunc=np.sum","+) / 100000000"," Channel_result2['åˆè®¡'] = Channel_result2.sum(axis=1)","-Channel_result2 = Channel_result2.sort_values('åˆè®¡', ascending=False)  # åº•è¡¨æŒ‰ç…§åˆè®¡è§„æ¨¡æ’åº","+Channel_result2 = Channel_result2.sort_values('åˆè®¡', ascending=False)","+","+# è®¡ç®—ç›¸æ¯”ä¸Šæœˆå’Œä¸Šå¹´çš„å˜åŒ–"," Channel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šæœˆ', '')] = Channel_result2[('åˆè®¡', '')] - \\","-                                         pd.read_excel(Config.get_output_result_file(lastm), sheet_name='æ¸ é“æ˜ç»†',","-                                                       index_col=0, skiprows=[1, 2])['åˆè®¡']","+    pd.read_excel(Config.get_output_result_file(lastm), sheet_name='æ¸ é“æ˜ç»†', index_col=0, skiprows=[1, 2])['åˆè®¡']"," Channel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šå¹´', '')] = Channel_result2[('åˆè®¡', '')] - \\","-                                         pd.read_excel(Config.get_output_result_file(lasty), sheet_name='æ¸ é“æ˜ç»†',","-                                                       index_col=0, skiprows=[1, 2])['åˆè®¡']","+    pd.read_excel(Config.get_output_result_file(lasty), sheet_name='æ¸ é“æ˜ç»†', index_col=0, skiprows=[1, 2])['åˆè®¡']","+"," Channel_result1.to_excel(writer, sheet_name='1ã€åˆ†æ¸ é“ä½™é¢')"," Channel_result2.to_excel(writer, sheet_name='æ¸ é“æ˜ç»†')"," ","+","+# ==============================================================================","+# ç¬¬å…«éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“è§„æ¨¡","+# ==============================================================================","+","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨2: äº§å“è§„æ¨¡","+# ------------------------------------------------------------------------------","+print(\"\\n[2] ç”ŸæˆæŠ¥è¡¨: 2ã€äº§å“è§„æ¨¡...\")","+"," now = zhoubao_date","-# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°"," yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))"," yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))"," yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))"]},{"oldStart":470,"oldLines":64,"newStart":509,"newLines":74,"lines":[" lastm_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - get_scaleandnum_by_sort(yunzuogailan_lastm)"," lastm_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«']"," lasty_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - full_category_or_not(","-    get_scaleandnum_by_sort(yunzuogailan_lasty), rank_here).fillna(0)","+    get_scaleandnum_by_sort(yunzuogailan_lasty), rank_here","+).fillna(0)"," lasty_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']"," "," cols = ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']"," result_3 = pd.concat([get_scaleandnum_by_sort(yunzuogailan_now), lastm_delta_df, lasty_delta_df], axis=1)[cols]"," result_3[['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']] = result_3[","-    ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']].applymap(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)","+    ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']","+].applymap(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)"," result_3 = rank_by_sort(result_3, rank_here)"," result_3[cols].to_excel(writer, sheet_name='2ã€äº§å“è§„æ¨¡')"," ","-# ï¼æ³¨ï¼šæˆ˜æŠ¥åº•è¡¨æ—¥æœŸéœ€è¦æ›´æ–°","-# month_now='2024-10'","-data_zhanbao = zhoubao_date  # å¯ä¿®æ”¹æˆ˜æŠ¥æ—¥æœŸ","-zhanbao_df = pd.read_excel(Config.get_weekly_data_file('æˆ˜æŠ¥åº•è¡¨(v2)'), index_col=0)","-zhanbao_df = zhanbao_df[zhanbao_df['è§„æ¨¡ç±»å‹-ç®€åŒ–'] == 'é”€é‡']"," ","-# æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“","+# ==============================================================================","+# ç¬¬ä¹éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - è§„æ¨¡å˜åŒ–ä¸æ–°å‘äº§å“","+# ==============================================================================","+","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨3: æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–","+# ------------------------------------------------------------------------------","+print(\"\\n[3] ç”ŸæˆæŠ¥è¡¨: 3ã€æœ¬æœˆå®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–...\")","+","+data_zhanbao = zhoubao_date","+zhanbao_df = data_loader.load_zhanbao_data()","+"," if 'äº§å“ç»ç†' not in zhanbao_df.columns:","     zhanbao_df = zhanbao_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')"," zhanbao_df.rename(columns={'å“ç±»': 'å¤šèµ„äº§å“ç±»'}, inplace=True)","-# å¯¹äº§å“ç»ç†ä¸æ˜¯ç©ºçš„,åˆ¤æ–­æ˜¯å¦æ˜¯æˆ‘éƒ¨çš„äº§å“","+"," zhanbao_df_1 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: not pd.isnull(x))]"," zhanbao_df_1 = del_Innovation_department(zhanbao_df_1)"," zhanbao_df_2 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: pd.isnull(x))]"," zhanbao_df = pd.concat([zhanbao_df_1, zhanbao_df_2])"," ","-# æ¯äº§å“ä»£ç å’Œç®€ç§°ä¸ºç©ºçš„ï¼Œæ›¿æ¢ä¸ºå­äº§å“ä»£ç å’Œç®€ç§°"," zhanbao_df['æ¯äº§å“ä»£ç '] = zhanbao_df.apply(lambda x: x.name if pd.isnull(x['æ¯äº§å“ä»£ç ']) else x['æ¯äº§å“ä»£ç '], axis=1)","-zhanbao_df['æ¯äº§å“ç®€ç§°'] = zhanbao_df.apply(lambda x: x['äº§å“ç®€ç§°'] if pd.isnull(x['æ¯äº§å“ç®€ç§°']) else x['æ¯äº§å“ç®€ç§°'],","-                                            axis=1)","+zhanbao_df['æ¯äº§å“ç®€ç§°'] = zhanbao_df.apply(","+    lambda x: x['äº§å“ç®€ç§°'] if pd.isnull(x['æ¯äº§å“ç®€ç§°']) else x['æ¯äº§å“ç®€ç§°'], axis=1","+)"," "," kaifang_df = zhanbao_df[","-    (zhanbao_df['å½¢æ€'] == 'å®¢æˆ·å‘¨æœŸ') | (zhanbao_df['å½¢æ€'] == 'æœ€çŸ­æŒæœ‰æœŸ') | (zhanbao_df['å½¢æ€'] == 'å®šå¼€') | (","-                zhanbao_df['å½¢æ€'] == 'æ—¥å¼€')]","-# æŒ‰æ¯äº§å“æ±‡æ€»","-kaifang_df = kaifang_df.groupby('æ¯äº§å“ä»£ç ').agg(","-    {'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first', 'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum',","-     'äº§å“ç»ç†': 'first'})","-# å»æ‰å˜åŠ¨å°äº500wçš„äº§å“-å¯èƒ½æ˜¯å‡€å€¼å˜åŒ–é€ æˆï¼Œä»…çœ‹å¤§çš„","+    (zhanbao_df['å½¢æ€'] == 'å®¢æˆ·å‘¨æœŸ') | (zhanbao_df['å½¢æ€'] == 'æœ€çŸ­æŒæœ‰æœŸ') |","+    (zhanbao_df['å½¢æ€'] == 'å®šå¼€') | (zhanbao_df['å½¢æ€'] == 'æ—¥å¼€')","+]","+kaifang_df = kaifang_df.groupby('æ¯äº§å“ä»£ç ').agg({","+    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',","+    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'äº§å“ç»ç†': 'first'","+})"," kaifang_df = kaifang_df[kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(lambda x: abs(x) >= 0.05)]","-"," kaifang_df.sort_values(by='è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', ascending=False, inplace=True)","-kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'] = kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)","-# kaifang_df['æŠ•èµ„ç»ç†']=[yunzuogailan_all.loc[x,'äº§å“ç»ç†'] for x in kaifang_df.index] #ä»£ç åŠŸèƒ½å†™é‡äº†","-# å»æ‰å°é—­åˆ°æœŸçš„","+kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'] = kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(","+    lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x","+)"," kaifang_df = kaifang_df[kaifang_df['æ¯å“ç±»'] != 'å°é—­åˆ°æœŸ']"," kaifang_df.to_excel(writer, sheet_name='3ã€æœ¬â½‰å®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–')"," ","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: æœ¬å‘¨æ–°å‘äº§å“","+# ------------------------------------------------------------------------------","+print(\"[3.1] ç”ŸæˆæŠ¥è¡¨: æœ¬å‘¨æ–°å‘äº§å“...\")","+"," yunzuogailan_date = zhoubao_date"," xinfa_thisweek_df = zhanbao_df[zhanbao_df['èµ·æ¯æ—¥'] >= week_Mon]","-# å«æœ‰å¾…èµ·æ¯äº§å“çš„è¿ä½œæ¦‚è§ˆ"," yunzuogailan_original = pd.read_excel(Config.get_weekly_data_file('äº§å“è¿ä½œæ¦‚è§ˆ'), index_col=0)","-# åŒ¹é…ç†è´¢äº§å“çš„å­æ¯ä»£ç "," yunzuogailan_original['æ¯äº§å“ä»£ç '] = yunzuogailan_original['äº§å“ç®€ç§°'].map(","-    lambda x: yunzuogailan_original[yunzuogailan_original['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0])","+    lambda x: yunzuogailan_original[yunzuogailan_original['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0]","+)"," yunzuogailan_original = yunzuogailan_original[['äº§å“ç®€ç§°', 'æ¯äº§å“ä»£ç ', 'äº§å“ç»ç†']].drop_duplicates()"," ","-# åŒ¹é…æ–°å‘äº§å“çš„æ¯äº§å“ä»£ç ï¼Œå¦‚æœæ²¡æœ‰ç”¨å­äº§å“ä»£ç æ›¿ä»£"," for mid_ind in xinfa_thisweek_df.index:","     if mid_ind in yunzuogailan_original.index:","         mother_indx = yunzuogailan_original.loc[mid_ind, 'æ¯äº§å“ä»£ç ']"]},{"oldStart":538,"oldLines":30,"newStart":587,"newLines":31,"lines":["         xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mid_ind","         xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç®€ç§°']"," ","-xinfa_thisweek_qudao = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ', 'æ¸ é“-ç®€åŒ–']).agg(","-    {'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first', 'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum',","-     'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'})","-xinfa_thisweek_sum = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ']).agg(","-    {'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first', 'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum',","-     'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'})","+xinfa_thisweek_qudao = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ', 'æ¸ é“-ç®€åŒ–']).agg({","+    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',","+    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'","+})","+xinfa_thisweek_sum = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ']).agg({","+    'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first',","+    'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'","+})"," ","-# å•ç‹¬åˆ—ç¤ºè¡Œå†…è¡Œå¤–çš„è§„æ¨¡å€¼"," for mid_ind in xinfa_thisweek_sum.index:","     if (mid_ind, 'è¡Œå†…') in xinfa_thisweek_qudao.index:","         xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå†…(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå†…'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']","     if (mid_ind, 'è¡Œå¤–') in xinfa_thisweek_qudao.index:","         xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå¤–(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå¤–'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']"," ","-# å½“æœ¬å‘¨æ— æ–°å‘äº§å“æ—¶ï¼Œxinfa_thisweek_sum å¯èƒ½ä¸ºç©ºæˆ–ç¼ºå°‘æŒ‡å®šåˆ—ï¼Œå…ˆåšå®‰å…¨å¤„ç†"," if xinfa_thisweek_sum.empty:","-    # åˆ›å»ºä¸€ä¸ªç©ºè¡¨ä½†ä¿ç•™å¿…è¦åˆ—ï¼Œé˜²æ­¢åç»­æŠ¥é”™","-    result_3_2_df = pd.DataFrame(columns=['æ¯äº§å“ç®€ç§°', 'é”€é‡(äº¿)', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',","-                                          'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'])","+    result_3_2_df = pd.DataFrame(columns=[","+        'æ¯äº§å“ç®€ç§°', 'é”€é‡(äº¿)', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',","+        'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'","+    ])"," else:","-    # ä»…ä¿ç•™å®é™…å­˜åœ¨çš„åˆ—","-    keep_columns_xinfa = ['æ¯äº§å“ç®€ç§°', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»', 'æ¯å“ç±»', 'èµ·æ¯æ—¥',","-                          'æˆ˜æŠ¥åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†']","-    # å–äº¤é›†ï¼Œé¿å… KeyError","+    keep_columns_xinfa = [","+        'æ¯äº§å“ç®€ç§°', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',","+        'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'æˆ˜æŠ¥åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'","+    ]","     cols_available = [c for c in keep_columns_xinfa if c in xinfa_thisweek_sum.columns]","     xinfa_thisweek_sum = xinfa_thisweek_sum[cols_available].copy()","     xinfa_thisweek_sum.rename(columns={'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'é”€é‡(äº¿)', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'åˆ°æœŸæ—¥'}, inplace=True)"]},{"oldStart":569,"oldLines":117,"newStart":619,"newLines":98,"lines":["     result_3_2_df.sort_values(by='èµ·æ¯æ—¥', ascending=True, inplace=True)"," "," result_3_2_df.to_excel(writer, sheet_name='æœ¬å‘¨æ–°å‘äº§å“')","-# xinfa_thisweek_sum[xinfa_thisweek_sum['é”€é‡(äº¿)']!=0].to_excel('test1.xlsx',sheet_name='3ã€æœ¬å‘¨æ–°å‘äº§å“')"," ","-product_tosale_df = pd.read_excel(Config.get_weekly_data_file('ç†è´¢äº§å“åŒºé—´åœ¨å”®å¾…å”®æƒ…å†µè¡¨'), index_col=0, skiprows=1)","-product_tosale_df = product_tosale_df.merge(Product_information_df_DAP['æ¯äº§å“æŠ•èµ„ç»ç†'], left_index=True,","-                                            right_index=True, how='left')","-first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦','æä½³èˆª',\"è‹æ–‡æ´¥\",\"å¤å‡¡ç››\",\"é»„äº¦å°§\"]","-second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ',\"ç½—è°¨æ·±\"]","-third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°','å»–ç‚¯è‡£']","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: å¾…å”®äº§å“","+# ------------------------------------------------------------------------------","+print(\"[3.2] ç”ŸæˆæŠ¥è¡¨: å¾…å”®äº§å“...\")"," ","+product_tosale_df = data_loader.load_product_tosale()","+product_tosale_df = product_tosale_df.merge(","+    Product_information_df_DAP['æ¯äº§å“æŠ•èµ„ç»ç†'], left_index=True, right_index=True, how='left'","+)"," ","-def manager_in_or_not(s: str, y: list):","-    if pd.isnull(s):","-        return False","-    else:","-        for mid_y in y:","-            if mid_y in s:","-                return True","-        return False","+first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦', 'æä½³èˆª', \"è‹æ–‡æ´¥\", \"å¤å‡¡ç››\", \"é»„äº¦å°§\"]","+second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ', \"ç½—è°¨æ·±\"]","+third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°', 'å»–ç‚¯è‡£']"," ","-"," product_tosale_df_new = product_tosale_df[","-    product_tosale_df['æ¯äº§å“æŠ•èµ„ç»ç†'].map(lambda x: manager_in_or_not(x, first + second + third))]","+    product_tosale_df['æ¯äº§å“æŠ•èµ„ç»ç†'].map(lambda x: manager_in_or_not(x, first + second + third))","+]"," date_here = zhoubao_date[:4] + '-' + zhoubao_date[4:6] + '-' + zhoubao_date[6:]"," product_tosale_df_final = product_tosale_df_new[product_tosale_df_new['æˆç«‹æ—¥'] > date_here]"," product_tosale_df_final.drop_duplicates(inplace=True)","-keep_columns = ['æ¯å­äº§å“æ ‡è¯†', 'äº§å“ç®€ç§°', 'äº§å“å¼€æ”¾å½¢å¼', 'å‹Ÿé›†æœŸ(èµ·)', 'å‹Ÿé›†æœŸ(æ­¢)',","-                'æˆç«‹æ—¥', 'åˆ°æœŸæ—¥', 'è§„æ¨¡ä¸Šé™(äº¿)', 'é”€å”®å¸ç§']","-# product_tosale_df_final[keep_columns].to_excel('test.xlsx')","+keep_columns = ['æ¯å­äº§å“æ ‡è¯†', 'äº§å“ç®€ç§°', 'äº§å“å¼€æ”¾å½¢å¼', 'å‹Ÿé›†æœŸ(èµ·)', 'å‹Ÿé›†æœŸ(æ­¢)', 'æˆç«‹æ—¥', 'åˆ°æœŸæ—¥', 'è§„æ¨¡ä¸Šé™(äº¿)', 'é”€å”®å¸ç§']"," product_tosale_df_final_v1 = product_tosale_df_final[keep_columns]","-product_tosale_df_final_v2 = product_tosale_df_final_v1[product_tosale_df_final_v1.apply(lambda x: False if ( \\","-                                                                                                                        x[","-                                                                                                                            'äº§å“ç®€ç§°'] in","-                                                                                                                        product_tosale_df_final_v1[","-                                                                                                                            'äº§å“ç®€ç§°']) and (","-                                                                                                                        x[","-                                                                                                                            'æ¯å­äº§å“æ ‡è¯†'] == 'æ¯äº§å“') else True,","-                                                                                         axis=1)]","+product_tosale_df_final_v2 = product_tosale_df_final_v1[","+    product_tosale_df_final_v1.apply(","+        lambda x: False if (x['äº§å“ç®€ç§°'] in product_tosale_df_final_v1['äº§å“ç®€ç§°']) and (x['æ¯å­äº§å“æ ‡è¯†'] == 'æ¯äº§å“') else True,","+        axis=1","+    )","+]"," product_tosale_df_final_v2.sort_values(by='æˆç«‹æ—¥', ascending=True, inplace=True)"," product_tosale_df_final_v2.to_excel(writer, sheet_name='å¾…å”®äº§å“')"," ","-# å¤šèµ„äº§äº§å“ç›‘æ§","-start_date = ''  # æ•°æ®åŒºé—´å¼€å§‹ï¼Œå¯é€‰â€œâ€æˆ–è€…'2024-10-16'","-end_date = ''  # æ•°æ®æˆªæ­¢æ—¶é—´ï¼Œå¯é€‰â€œâ€æˆ–è€…'2024-04-15'","-# ä½¿ç”¨é…ç½®çš„æ•°æ®ç›®å½•ï¼Œä¸å†ä½¿ç”¨ç¡¬ç¼–ç è·¯å¾„","-# path='/Users/fanshengxia/Desktop/å‘¨æŠ¥/2.å¤šèµ„äº§äº§å“ç›‘æ§'"," ","-data_transposition.replace(0, np.nan, inplace=True)","-if start_date == \"\":","-    data_transposition_here = data_transposition","-else:","-    data_transposition_here = data_transposition.loc[start_date:]","+# ==============================================================================","+# ç¬¬åéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“ä¸šç»©åˆ†æ","+# =============================================================================="," ","-if end_date == \"\":","-    data_transposition_here.apply(performance_calculate_optimize).T.to_excel(Config.get_performance_file(zhoubao_date))","-    print('æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.index[-1]))","-else:","-    data_transposition_here.loc[:end_date].apply(performance_calculate_optimize).T.to_excel(","-        Config.get_performance_file(end_date))","-    print('æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.loc[:end_date].index[-1]))","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: ç³»åˆ—äº§å“ä¸šç»©ï¼ˆè´¹åå¹³å‡/åŠ æƒã€è´¹å‰å¹³å‡/åŠ æƒï¼‰","+# ------------------------------------------------------------------------------","+print(\"\\n[5] ç”ŸæˆæŠ¥è¡¨: ç³»åˆ—äº§å“ä¸šç»©...\")"," ","-# now='20241024'","-Parent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[","-    ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]","+# è®¡ç®—ä¸šç»©æ•°æ®éœ€è¦ç”¨åˆ°çš„å‡½æ•°","+year_col = f\"{int(str(zhoubao_date)[:4])}å¹´å¹´åŒ–æ”¶ç›Šç‡\""," "," ","-# yunzuogailan_now=del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now),index_col=0))","-","-","-# æœ€çŸ­æŒæœ‰æœŸäº§å“ç”¨Aä»½é¢æ›¿ä»£","-year_col = f\"{int(str(zhoubao_date)[:4])}å¹´å¹´åŒ–æ”¶ç›Šç‡\""," def weighted_avg(group):","+    \"\"\"è®¡ç®—è§„æ¨¡åŠ æƒå¹³å‡\"\"\"","     w_fields = [","         'ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡',","         'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡'","     ]","     results = {}","-","     for field in w_fields:","-        # ä»…ä¿ç•™è¯¥å­—æ®µä¸ä¸ºç©ºçš„è¡Œ","         mask = group[field].notna()","-        if mask.any():  # è‡³å°‘æœ‰ä¸€ä¸ªæœ‰æ•ˆæ ·æœ¬","+        if mask.any():","             weight_valid = group.loc[mask, 'å‡€èµ„äº§(äº¿)']","             total_weight = weight_valid.sum()","-            results[field] = (","-                    (group.loc[mask, field] * weight_valid).sum() / total_weight","-            )","-        else:  # å…¨éƒ¨ä¸ºç©ºï¼Œè¿”å› NaN","+            results[field] = (group.loc[mask, field] * weight_valid).sum() / total_weight","+        else:","             results[field] = np.nan","-","     return pd.Series(results)","+","+","+# ç”Ÿæˆäº§å“ç›‘æ§æ•°æ®","+data_transposition_here = data_transposition","+data_transposition_here.apply(performance_calculate_optimize).T.to_excel(Config.get_performance_file(zhoubao_date))","+print('   æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.index[-1]))","+","+# åŠ è½½è¿ä½œæ¦‚è§ˆæ•°æ®"," yunzuogailan_all = del_Innovation_department(","-    pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0))","+    pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)","+)"," "," # ç­›é€‰æŒæœ‰æœŸå’Œå…¶ä»–äº§å“"," to_merge_chiyouqi_code = yunzuogailan_all[","-    yunzuogailan_all.apply(lambda x: (x['ä¸»è¦å±•ç¤º'] == 'æ˜¯') & (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']), axis=1)]","+    yunzuogailan_all.apply(lambda x: (x['ä¸»è¦å±•ç¤º'] == 'æ˜¯') & (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']), axis=1)","+]"," to_merge_other_code = yunzuogailan_all[","-    yunzuogailan_all.apply(lambda x: (x['æ¯å­æ ‡å¿—'] in ['éæ¯å­äº§å“', 'æ¯äº§å“']) & (x['å½¢æ€'] in ['å°é—­', 'å®šå¼€']),","-                           axis=1)]","+    yunzuogailan_all.apply(lambda x: (x['æ¯å­æ ‡å¿—'] in ['éæ¯å­äº§å“', 'æ¯äº§å“']) & (x['å½¢æ€'] in ['å°é—­', 'å®šå¼€']), axis=1)","+]"," yunzuogailan_now = pd.concat([to_merge_chiyouqi_code, to_merge_other_code])"," ","-# è·å–æ”¶ç›Šç‡å’Œæ³¢åŠ¨ç‡æ•°æ®","+# åˆå¹¶æ”¶ç›Šç‡å’Œæ³¢åŠ¨ç‡æ•°æ®"," keep_cols = ['è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']"," yunzuogailan_now_5 = yunzuogailan_now.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')"," perf_df = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0)"," keep_cols = [c for c in keep_cols if c in perf_df.columns]","-yunzuogailan_now_ret = yunzuogailan_now_5.merge(","-    perf_df[keep_cols],","-    left_index=True, right_index=True, how='left')","+yunzuogailan_now_ret = yunzuogailan_now_5.merge(perf_df[keep_cols], left_index=True, right_index=True, how='left')"," yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'] = yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'].map(","-    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x)","+    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x","+)"," "," # å¯¹è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡ä¸º0æˆ–ç¼ºå¤±çš„äº§å“ï¼Œç”¨æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡æ›¿ä»£"," yunzuogailan_now_ret['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] = yunzuogailan_now_ret.apply("]},{"oldStart":687,"oldLines":51,"newStart":718,"newLines":58,"lines":["     axis=1"," )"," ","-# è®¡ç®—è´¹åå¹³å‡","+# 5.1 è´¹åå¹³å‡"," result_5 = yunzuogailan_now_ret[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + ['ç´¯è®¡å¹´åŒ–'] + keep_cols].groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()[","-    ['ç´¯è®¡å¹´åŒ–'] + keep_cols]","+    ['ç´¯è®¡å¹´åŒ–'] + keep_cols","+]"," result_5 = rank_by_sort(result_5, rank_here)"," result_5.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹åå¹³å‡')"," ","-# è®¡ç®—è´¹ååŠ æƒ","+# 5.2 è´¹ååŠ æƒ"," result_5_weight = yunzuogailan_now_ret.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)"," result_5_weight = rank_by_sort(result_5_weight, rank_here)"," result_5_weight.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹ååŠ æƒ')"," ","-# è®¡ç®—è´¹å‰æ•°æ®","+# 5.3 è´¹å‰æ•°æ®"," yunzuogailan_add_fee = yunzuogailan_now_ret.copy()"," w_field = ['ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']"," yunzuogailan_add_fee[w_field] = yunzuogailan_add_fee[w_field].add(","-    yunzuogailan_add_fee[['é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹']].sum(axis=1), axis=0)","+    yunzuogailan_add_fee[['é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹']].sum(axis=1), axis=0","+)"," ","-# è®¡ç®—è´¹å‰åŠ æƒ","+# 5.4 è´¹å‰åŠ æƒ"," result_series_performance = yunzuogailan_add_fee.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)"," result_series_performance = rank_by_sort(result_series_performance, rank_here)"," result_series_performance.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰åŠ æƒ')"," ","-# è®¡ç®—è´¹å‰å¹³å‡","+# 5.5 è´¹å‰å¹³å‡"," result_series_performance_average = yunzuogailan_add_fee[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + w_field + ['è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']].groupby(","-    ['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()","+    ['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']","+).mean()"," result_series_performance_average = rank_by_sort(result_series_performance_average, rank_here)"," result_series_performance_average.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰å¹³å‡')","-# ç­›é€‰æŒæœ‰æœŸäº§å“ï¼Œä¸åŒ…å«å¤–å¸","+","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨5.2: æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°","+# ------------------------------------------------------------------------------","+print(\"[5.2] ç”ŸæˆæŠ¥è¡¨: 5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°...\")","+"," yunzuogailan_now_ret_chiyouqi = yunzuogailan_now_ret[yunzuogailan_now_ret.apply(","     lambda x: (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']) and (x['æ¯åˆ†ç±»'] in ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€']),","-    axis=1)]","-yunzuogailan_now_ret_chiyouqi.rename(columns={'ç´¯è®¡å¹´åŒ–': 'æˆç«‹ä»¥æ¥å¹´åŒ–', year_col: 'ä»Šå¹´ä»¥æ¥å¹´åŒ–'},","-                                     inplace=True)","+    axis=1","+)]","+yunzuogailan_now_ret_chiyouqi.rename(columns={'ç´¯è®¡å¹´åŒ–': 'æˆç«‹ä»¥æ¥å¹´åŒ–', year_col: 'ä»Šå¹´ä»¥æ¥å¹´åŒ–'}, inplace=True)"," ","-# æœ±è€å¸ˆçš„æ‚¦åŠ¨ç¨³äº«9M281010å•ç‹¬å¤„ç†ï¼Œæ¯äº§å“ä¸šç»©æœ‰è¯¯","+# æœ±è€å¸ˆçš„æ‚¦åŠ¨ç¨³äº«9M281010å•ç‹¬å¤„ç†"," yunzuogailan_now_ret_chiyouqi.loc[","-    '9M281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡',","-                 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']] = \\","-    pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0).loc[","-        '9A281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡',","-                     year_col]].values","+    '9M281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']","+] = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0).loc[","+    '9A281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col]","+].values"," ","-# 2024å¹´åæˆç«‹çš„ï¼Œä»Šå¹´ä»¥æ¥å¹´åŒ–ä¸ºç©ºï¼Œç”¨æˆç«‹ä»¥æ¥å¹´åŒ–æ›¿ä»£"," yunzuogailan_now_ret_chiyouqi['ä»Šå¹´ä»¥æ¥å¹´åŒ–'] = yunzuogailan_now_ret_chiyouqi.apply(","-    lambda x: x['æˆç«‹ä»¥æ¥å¹´åŒ–'] if pd.isnull(x['ä»Šå¹´ä»¥æ¥å¹´åŒ–']) else x['ä»Šå¹´ä»¥æ¥å¹´åŒ–'], axis=1)","+    lambda x: x['æˆç«‹ä»¥æ¥å¹´åŒ–'] if pd.isnull(x['ä»Šå¹´ä»¥æ¥å¹´åŒ–']) else x['ä»Šå¹´ä»¥æ¥å¹´åŒ–'], axis=1","+)"," "," "," def get_Scale_weighting_ret(my_df):"]},{"oldStart":746,"oldLines":342,"newStart":784,"newLines":264,"lines":[" rank_chiyouqi = ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ']"," rank_by_sort(result_df_52, rank_chiyouqi).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°1')"," ","-","-# rank_by_sort(result_df_52,rank_chiyouqi).to_excel('test.xlsx',sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°1')","-","-def get_zhouqi_scale_v2(x):","-    if x == 1:","-        return 'æ—¥ç›ˆ'","-    elif x < 30:","-        return '<1M'","-    elif x < 31 * 3:","-        return '1M-3M'","-    elif x < 31 * 6:","-        return '3M-6M'","-    elif x < 12 * 31:","-        return '6M-1Y'","-    elif x >= 12 * 31:","-        return '>1Y'","-    else:","-        return 'error'","-","-"," yunzuogailan_now_ret_chiyouqi['æŒæœ‰æœŸæ ‡ç­¾'] = yunzuogailan_now_ret_chiyouqi['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale_v2)"," yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'] = yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'].map(","-    lambda x: 'æ‚¦åŠ¨çŸ­æŒ' if x == 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€' else x)","+    lambda x: 'æ‚¦åŠ¨çŸ­æŒ' if x == 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€' else x","+)"," result_df_52_3 = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾']).apply(get_Scale_weighting_ret)"," result_df_52_3['æ•°é‡'] = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾'])['äº§å“ç®€ç§°'].count()","-rank_chiyouqi_v3 = [('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '<1M'),","-                    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '1M-3M'),","-                    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '3M-6M'),","-                    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '6M-1Y'),","-                    ('æ‚¦åŠ¨çŸ­æŒ', '<1M'),","-                    ('æ‚¦åŠ¨çŸ­æŒ', '1M-3M'),","-                    ('æ‚¦åŠ¨çŸ­æŒ', '3M-6M'),","-                    ('æ‚¦åŠ¨çŸ­æŒ', '6M-1Y'),","-                    ('ä¼˜å…ˆè‚¡çŸ­æŒ', '1M-3M')]","+rank_chiyouqi_v3 = [","+    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '<1M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '1M-3M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '3M-6M'), ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '6M-1Y'),","+    ('æ‚¦åŠ¨çŸ­æŒ', '<1M'), ('æ‚¦åŠ¨çŸ­æŒ', '1M-3M'), ('æ‚¦åŠ¨çŸ­æŒ', '3M-6M'), ('æ‚¦åŠ¨çŸ­æŒ', '6M-1Y'),","+    ('ä¼˜å…ˆè‚¡çŸ­æŒ', '1M-3M')","+]"," rank_by_sort(result_df_52_3, rank_chiyouqi_v3).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°2')","-# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°","-now = zhoubao_date","-# lastm='20250228'  è·Ÿç€ä¸Šé¢ä¸€èµ·æ”¹äº†","-# lasty='20241231'  è·Ÿç€ä¸Šé¢ä¸€èµ·æ”¹äº†","-yunzuogailan_now = del_Innovation_department(pd.read_excel( \\","-    Config.get_overview_parent_file(now), index_col=0))","-yunzuogailan_lastw = del_Innovation_department(pd.read_excel( \\","-    Config.get_overview_parent_file(lastw), index_col=0))","-yunzuogailan_lastm = del_Innovation_department(pd.read_excel( \\","-    Config.get_overview_parent_file(lastm), index_col=0))","-yunzuogailan_lasty = del_Innovation_department(pd.read_excel( \\","-    Config.get_overview_parent_file(lasty), index_col=0))"," ","-first = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦','æä½³èˆª',\"è‹æ–‡æ´¥\",\"å¤å‡¡ç››\",\"é»„äº¦å°§\"]","-second = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ',\"ç½—è°¨æ·±\"]","-third = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°','å»–ç‚¯è‡£']"," ","-manager_belong_to = {'æŠ•èµ„ç»ç†å§“å': 'å¤„å®¤', }","-team = ['ä¸€å¤„', 'äºŒå¤„', 'å¤–å¸']","-team_list = [first, second, third]","-for i in range(len(team)):","-    for name_here in team_list[i]:","-        manager_belong_to[name_here] = team[i]","+# ==============================================================================","+# ç¬¬åä¸€éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æŠ•èµ„ç»ç†åˆ†æ","+# =============================================================================="," ","-Parent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[","-    ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡","+# ------------------------------------------------------------------------------","+print(\"\\n[6] ç”ŸæˆæŠ¥è¡¨: æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡...\")"," ","+now = zhoubao_date","+yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))","+yunzuogailan_lastw = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastw), index_col=0))","+yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))","+yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))"," ","-# åˆ é™¤éæˆ‘éƒ¨é—¨æŠ•èµ„ç»ç†","-def clear_manager_name(s: str):","-    merge_s = []","-    for mid_s in s.split(','):","-        #         if mid_s in first+second+third+quant:","-        if mid_s in first + second + third:","-            merge_s.append(mid_s)","-    return ','.join(merge_s)","+result_now = get_scaleandnum_by_sort_manager(yunzuogailan_now).groupby('äº§å“ç»ç†').agg({","+    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'","+})"," ","-","-# æœ‰å¤šä¸ªæŠ•èµ„ç»ç†å…±åŒç®¡ç†çš„æ•°æ®ï¼Œè¦å¤åˆ¶ä¸€æ¡æ•°æ®ç»™æ¯ä¸ªæŠ•èµ„ç»ç†ï¼Œè§„æ¨¡å’Œä¸ªæ•°å‡åŠ","-def adjust_manager_aum(mid_data):","-    import pandas as pd  # Ensure pandas is imported","-","-    final_mid_data = mid_data.copy()","-    final_mid_data['åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data['å‡€èµ„äº§(äº¿)']","-    final_mid_data['åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1","-","-    # Create a list to store new rows","-    new_rows = []","-","-    for indx in mid_data.index:","-        mng_list = mid_data.loc[indx, 'äº§å“ç»ç†'].split(',')","-        if len(mng_list) > 1:","-            i = 0","-            for mng in mng_list:","-                if i == 0:","-                    final_mid_data.loc[indx, 'äº§å“ç»ç†'] = mng","-                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] / 2","-                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1 / len(mng_list)","-                    i += 1","-                else:","-                    mid_series = final_mid_data.loc[indx].copy()","-                    mid_series['äº§å“ç»ç†'] = mng","-                    # Instead of append, we'll collect new rows and concat later","-                    new_rows.append(pd.DataFrame(mid_series).T)","-","-    # If we have new rows, concatenate them to the original dataframe","-    if new_rows:","-        final_mid_data = pd.concat([final_mid_data] + new_rows, ignore_index=False)","-","-    return final_mid_data","-","-","-# åŒ¹é…å­æ¯åˆ†ç±»å…³ç³»+å¯¹æŠ•èµ„ç»ç†è¿›è¡Œå¤„ç†","-def get_scaleandnum_by_sort_manager(my_df):","-    Parent_sort = \\","-    pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[","-        ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]","-    my_df = my_df.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')","-    my_df['äº§å“ç»ç†'] = my_df['äº§å“ç»ç†'].map(clear_manager_name)","-","-    return adjust_manager_aum(my_df)","-","-","-result_now = get_scaleandnum_by_sort_manager(yunzuogailan_now).groupby('äº§å“ç»ç†').agg(","-    {'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'})","-"," rikai_now = get_scaleandnum_by_sort_manager(yunzuogailan_now)","-rikai_now = rikai_now[rikai_now['å½¢æ€'].map(lambda x: x in ['æ—¥å¼€', 'å®¢æˆ·å‘¨æœŸ', 'æœ€çŸ­æŒæœ‰æœŸ'])].groupby('äº§å“ç»ç†').agg(","-    {'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'})","+rikai_now = rikai_now[rikai_now['å½¢æ€'].map(lambda x: x in ['æ—¥å¼€', 'å®¢æˆ·å‘¨æœŸ', 'æœ€çŸ­æŒæœ‰æœŸ'])].groupby('äº§å“ç»ç†').agg({","+    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'","+})"," rikai_now.rename(columns={'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'}, inplace=True)","+"," result_df_here = []"," cols_to_append = ['-è¾ƒä¸Šå‘¨', '-è¾ƒä¸Šæœˆæœ«', '-è¾ƒä¸Šå¹´æœ«']"," for i in range(3):","     mid_df = [yunzuogailan_lastw, yunzuogailan_lastm, yunzuogailan_lasty][i]","-    result_df_i = result_now - get_scaleandnum_by_sort_manager(mid_df).groupby('äº§å“ç»ç†').agg(","-        {'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'})","+    result_df_i = result_now - get_scaleandnum_by_sort_manager(mid_df).groupby('äº§å“ç»ç†').agg({","+        'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'","+    })","     result_df_i.columns = [x + cols_to_append[i] for x in ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°']]","     result_df_here.append(result_df_i)"," "," result_df_here = pd.concat([result_now] + result_df_here + [rikai_now], axis=1)"," ","-cols_here = ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«',","-             'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡',","-             'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šæœˆæœ«',","-             'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°']","-indx_here = ['ä¸¥æ³“', 'å¾è¹', 'æ¨æ¼ ', 'é«˜ç¿°æ˜†', 'å§œé”¡å³°', 'ä½™æ´é›…', 'è–›çºªæ™”', 'èƒ¡è‰³å©·', 'æœ±è½¶ä¼¦', 'ä»»é›',","-             'å¼ ç‰æ°','å»–ç‚¯è‡£','æä½³èˆª',\"è‹æ–‡æ´¥\",\"å¤å‡¡ç››\",\"é»„äº¦å°§\",\"ç½—è°¨æ·±\"]","+cols_here = [","+    'åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡',","+    'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'","+]","+indx_here = [","+    'ä¸¥æ³“', 'å¾è¹', 'æ¨æ¼ ', 'é«˜ç¿°æ˜†', 'å§œé”¡å³°', 'ä½™æ´é›…', 'è–›çºªæ™”', 'èƒ¡è‰³å©·', 'æœ±è½¶ä¼¦', 'ä»»é›',","+    'å¼ ç‰æ°', 'å»–ç‚¯è‡£', 'æä½³èˆª', \"è‹æ–‡æ´¥\", \"å¤å‡¡ç››\", \"é»„äº¦å°§\", \"ç½—è°¨æ·±\"","+]"," result_df_here = result_df_here[cols_here]","-result_df_here =result_df_here.dropna(axis=0,how='all')","+result_df_here = result_df_here.dropna(axis=0, how='all')"," result_df_here = rank_by_sort(result_df_here, indx_here)","-result_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«',","-                'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']] = result_df_here[","-    ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«',","-     'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']].applymap(lambda x: '{:.2f}'.format(x))","+result_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']] = \\","+    result_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']].applymap(","+        lambda x: '{:.2f}'.format(x)","+    )"," result_df_here.to_excel(writer, sheet_name='æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡')","-# result_df_here.to_excel('test2.xlsx',sheet_name='æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡')"," ","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡","+# ------------------------------------------------------------------------------","+print(\"[6.1] ç”ŸæˆæŠ¥è¡¨: ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡...\")","+"," yunzuogailan_now_65 = yunzuogailan_now.copy()"," yunzuogailan_now_65['å½¢æ€'] = yunzuogailan_now_65['å½¢æ€'].map(lambda x: 'æœ€çŸ­æŒæœ‰æœŸ' if x == 'å®¢æˆ·å‘¨æœŸ' else x)","-yunzuogailan_now_65 = yunzuogailan_now_65.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True,","-                                                how='left')","-result_df_here_65 = pd.concat([pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€',","-                                              values=['å‡€èµ„äº§(äº¿)'], aggfunc='count'), \\","-                               pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€',","-                                              values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)], axis=1)","+yunzuogailan_now_65 = yunzuogailan_now_65.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')","+result_df_here_65 = pd.concat([","+    pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€', values=['å‡€èµ„äº§(äº¿)'], aggfunc='count'),","+    pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€', values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)","+], axis=1)"," result_df_here_65.to_excel(writer, sheet_name='ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡')"," ","-# æ‹›å•†äº§å“åˆ—è¡¨","-# æ”¹æˆå±•ç¤ºå­äº§å“","-zhaoshang_product_list = list(set(Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'].index))","-zhaoshang_product_df = yunzuogailan_all.loc[zhaoshang_product_list]"," ","+# ==============================================================================","+# ç¬¬åäºŒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æ‹›å•†äº§å“åˆ†æ","+# =============================================================================="," ","-def get_yejijizhunxiaxian(x: str):","-    if not pd.isnull(x):","-        try:","-            float(x.split('-')[0][:-1])","-            return x.split('-')[0]","-        except ValueError:","-            return \"\"","-    else:","-        return x","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†","+# ------------------------------------------------------------------------------","+print(\"\\n[7] ç”ŸæˆæŠ¥è¡¨: æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†...\")"," ","-","+zhaoshang_product_list = list(set(Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'].index))","+zhaoshang_product_df = yunzuogailan_all.loc[zhaoshang_product_list]"," zhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'] = zhaoshang_product_df['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)","-","-# è·å–è¶…é¢ä¸šç»©<0æ¸…å•"," zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] = zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'].map(","-    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x)  # çº¦å®šå¹´åŒ–çš„æ•°æ®ç±»å‹","-zhaoshangfinal = zhaoshang_product_df[(zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] * 100 - zhaoshang_product_df[","-    'ä¸šç»©åŸºå‡†ä¸‹é™'].map(lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100)) < 0]","-# åŒ¹é…æ‹›å•†è§„æ¨¡","+    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x","+)","+zhaoshangfinal = zhaoshang_product_df[","+    (zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] * 100 - zhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'].map(","+        lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100","+    )) < 0","+]"," zhaoshang_scale = Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸']['ä¿æœ‰è§„æ¨¡'] / 100000000"," zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] = [zhaoshang_scale[ind] for ind in zhaoshangfinal.index]","-# ä»…ä¿ç•™æˆç«‹å¤§äºä¸€æœˆçš„"," zhaoshangfinal = zhaoshangfinal[zhaoshangfinal['è¿ä½œå¤©'] > 30]"," zhaoshangfinal = zhaoshangfinal[zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] > 0.1]","-zhaoshangfinal.sort_values('å‰©ä½™å¤©', ascending=True, inplace=True)  # åº•è¡¨æŒ‰ç…§å‰©ä½™å¤©æ’åº","+zhaoshangfinal.sort_values('å‰©ä½™å¤©', ascending=True, inplace=True)"," zhaoshangfinal.to_excel(writer, sheet_name='æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†')","-# zhaoshangfinal.to_excel('test.xlsx',sheet_name='æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†')"," ","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸è¾¾ä¸šç»©äº§å“æ¸…å•","+# ------------------------------------------------------------------------------","+print(\"[7.1] ç”ŸæˆæŠ¥è¡¨: å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸è¾¾ä¸šç»©äº§å“æ¸…å•...\")","+"," yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'] = yunzuogailan_all['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)"," yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] = yunzuogailan_all['æœ¬æœŸå¹´åŒ–'].map(","-    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x)  # çº¦å®šå¹´åŒ–çš„æ•°æ®ç±»å‹","-yunzuogailan_all = yunzuogailan_all[(yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] * 100 - yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'].map(","-    lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100)) < 0]","+    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x","+)","+yunzuogailan_all = yunzuogailan_all[","+    (yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] * 100 - yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'].map(","+        lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100","+    )) < 0","+]"," bdjz_100 = yunzuogailan_all[(yunzuogailan_all['å½¢æ€'].isin(['å°é—­', 'å®šå¼€'])) & (yunzuogailan_all['å‰©ä½™å¤©'] < 100)]","-bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = (bdjz_100['æœ¬æœŸå¹´åŒ–'] - (bdjz_100['ä¸šç»©åŸºå‡†ä¸‹é™'].str[:-1]).astype(","-    float) / 100) * 10000","+bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = (bdjz_100['æœ¬æœŸå¹´åŒ–'] - (bdjz_100['ä¸šç»©åŸºå‡†ä¸‹é™'].str[:-1]).astype(float) / 100) * 10000"," bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'].astype(int)","-bdjz_100 =bdjz_100[bdjz_100['æ¯åˆ†ç±»'] !='å¤–å¸ä½æ³¢']  ##å‰”é™¤å¤–å¸äº§å“ ç³»ç»Ÿæ•°æ®ä¸å‡†ç¡®","+bdjz_100 = bdjz_100[bdjz_100['æ¯åˆ†ç±»'] != 'å¤–å¸ä½æ³¢']"," bdjz_100.to_excel(writer, sheet_name='å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸å¤§ä¸šç»©äº§å“æ¸…å•')"," ","-date = zhoubao_date"," ","+# ==============================================================================","+# ç¬¬åä¸‰éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - èµ„äº§å¤§è¡¨","+# ==============================================================================","+","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨8: èµ„äº§å¤§è¡¨","+# ------------------------------------------------------------------------------","+print(\"\\n[8] ç”ŸæˆæŠ¥è¡¨: 8.èµ„äº§å¤§è¡¨...\")","+","+date = zhoubao_date"," date_lastw = lastw"," date_lastm = lastm"," date_lasty = lasty","-excel_name = 'æŒä»“ç›ˆäºæ˜ç»†åˆ—è¡¨_' + date + '.xlsx'","+"," yunzuogailan_all = pd.read_excel(Config.get_overview_history_file(date), index_col=0)","-Chicang_df = pd.read_excel(os.path.join(Config.WEEKLY_DATA_DIR, excel_name))","-Chicang_df.rename(columns={'èµ„äº§ç®€ç§°': 'å€ºåˆ¸ç®€ç§°'}, inplace=True)  ###æŒ‰ç…§è€çš„ç®€ç§°è®¡ç®—","-Chicang_df.drop_duplicates(inplace=True)","+Chicang_df = data_loader.load_chicang_data(date)"," Chicang_df = Chicang_df.merge(yunzuogailan_all['å¸ç§'], left_on='äº§å“ä»£ç ', right_index=True, how='left')","-# äº§å“è®¡ä»·å•ä½ä¸ºç¾å…ƒçš„ï¼Œéœ€è¦è½¬æ¢æˆäººæ°‘å¸","-# æ³¨ï¼šæˆ‘ä»¬pasç³»ç»Ÿçš„é€»è¾‘æ˜¯å±•ç¤ºæœ¬å¸è§„æ¨¡ï¼Œæœ¬å¸æ˜¯æŒ‡äº§å“çš„é”€å”®å•ä½/è®¡ä»·å•ä½ï¼Œç›®å‰ç¾å…ƒäº§å“åº•å±‚èµ„äº§åªæœ‰ç¾å…ƒèµ„äº§ï¼Œå±•ç¤ºè§„æ¨¡ä¸ºç¾å…ƒï¼›äººæ°‘å¸äº§å“åº•å±‚èµ„äº§ï¼Œç¾å…ƒçš„ä¼šè½¬æˆäººæ°‘å¸ï¼Œäººæ°‘å¸çš„ç›´æ¥å±•ç¤ºäººæ°‘å¸","+","+# ç¾å…ƒäº§å“è½¬æ¢æ±‡ç‡"," EXchange_rate = market_data.get_exchange_rate('USDCNY', Config.EXCHANGE_RATE_DATE)"," Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.apply(","     lambda x: x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] * EXchange_rate if x['å¸ç§'] == 'ç¾å…ƒ' else x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'],","-    axis=1)","+    axis=1","+)"," ","-# æš‚æ—¶ä»£ç â€”â€”æ–°åŸºé‡‘ç±»å‹äº’è®¤åŸºé‡‘å’ŒåŸºå‡†åšå¸‚åŸºé‡‘çš„'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'æ˜¯0ï¼Œä½†æ˜¯æœ‰æŒä»“æˆæœ¬å’ŒæŒæœ‰æœŸæ”¶ç›Šæ•°æ®ï¼Œæ‰€ä»¥æš‚æ—¶ç”¨äºŒè€…è®¡ç®—ä»£æ›¿","+# å¤„ç†ç‰¹æ®ŠåŸºé‡‘ç±»å‹"," to_fill_indx = Chicang_df[Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] == 0].index","-Chicang_df.loc[to_fill_indx, 'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.loc[to_fill_indx, 'æŒä»“æˆæœ¬(å…ƒ)'] + Chicang_df.loc[","-    to_fill_indx, 'æŒæœ‰æœŸæ”¶ç›Š']","+Chicang_df.loc[to_fill_indx, 'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.loc[to_fill_indx, 'æŒä»“æˆæœ¬(å…ƒ)'] + Chicang_df.loc[to_fill_indx, 'æŒæœ‰æœŸæ”¶ç›Š']"," Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].fillna(0)"," ","-# è·å–èµ„äº§å‹¾ç¨½å…³ç³»å’Œä¿é™©èµ„ç®¡äº§å“","-asset_classification_joint_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),","-                                              sheet_name='èµ„äº§åˆ†ç±»å‹¾ç¨½å…³ç³»', index_col=0)","-insurance_pdct_df = pd.read_excel(Config.get_weekly_data_file('ä¿é™©èµ„ç®¡è®¡åˆ’'), index_col=0)  # è¿‘7å¤©å¹´åŒ–æ”¶ç›Š","-# åŒ¹é…èµ„äº§å°ç±»å’Œå‹¾ç¨½å…³ç³»ä¸‹çš„ä¸‰çº§åˆ†ç±»","-Chicang_df = Chicang_df.merge(asset_classification_joint_df[['ç¼–å·', 'ä¸‰çº§åˆ†ç±»']], left_on='æ–°ç‰ˆèµ„äº§å°ç±»',","-                              right_index=True, how='left')","+# åŠ è½½èµ„äº§åˆ†ç±»æ•°æ®","+asset_classification_joint_df = data_loader.load_asset_classification()","+insurance_pdct_df = data_loader.load_insurance_products()","+","+# åŒ¹é…èµ„äº§å°ç±»å’Œå‹¾ç¨½å…³ç³»","+Chicang_df = Chicang_df.merge(","+    asset_classification_joint_df[['ç¼–å·', 'ä¸‰çº§åˆ†ç±»']], left_on='æ–°ç‰ˆèµ„äº§å°ç±»', right_index=True, how='left'","+)","+"," # æ ‡è®°ä¿é™©èµ„ç®¡èµ„äº§"," mid_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å°ç±»'] == 'å§”å¤–ç°é‡‘ç®¡ç†æŠ•èµ„']"," insurance_pdct_name_list = list(insurance_pdct_df.index) + ['è‹±å¤§èµ„äº§-èšé‘«22å·', 'å¤§å®¶èµ„ç®¡ç¨³å¥ç²¾é€‰15å·']"," insurance_pdct_indx = mid_df[mid_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in insurance_pdct_name_list)].index"," Chicang_df.loc[insurance_pdct_indx, 'ç¼–å·'] = '1.2'"," Chicang_df.loc[insurance_pdct_indx, 'ä¸‰çº§åˆ†ç±»'] = '1.2 ä¿é™©åè®®å­˜æ¬¾'","-# ç»†åŒ–3.4-3.5ä¸­çš„åŸæŠ•å’Œæ°¸ç»­","-# å•ç‹¬æå‡ºæ‰€æœ‰çš„å€ºåˆ¸æ•°æ®è·å–åŸæŠ•å’Œæ°¸ç»­ä¿¡æ¯","-bond_set_df = pd.DataFrame(list(set(Chicang_df[Chicang_df['ç¼–å·'] == '3.4-3.5']['å¤–éƒ¨ä»£ç '])), columns=['å¤–éƒ¨ä»£ç '])"," ","-# è·å–Windæ•°æ®â€”â€”æœ€å¥½ä¸è¦é‡å¤è·‘ï¼Œå¯ç”¨æ•°æ®é‡æœ‰é™","+# ç»†åŒ–åŸæŠ•å’Œæ°¸ç»­å€ºåˆ†ç±»","+bond_set_df = pd.DataFrame(list(set(Chicang_df[Chicang_df['ç¼–å·'] == '3.4-3.5']['å¤–éƒ¨ä»£ç '])), columns=['å¤–éƒ¨ä»£ç '])"," bond_code_list = list(bond_set_df['å¤–éƒ¨ä»£ç '].values)"," wind_result = market_data.get_bond_attributes(bond_code_list)"," bond_set_df[['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­']] = wind_result.values","-# é€šè¿‡åŸæŠ•å’Œæ°¸ç»­åŒ¹é…ä¸‰çº§åˆ†ç±»çš„å‹¾ç¨½è¡¨","-to_merge_df = pd.DataFrame(","-    [['æ˜¯', 'å¦', '3.4.1 éæ°¸ç»­åŸæŠ•å€º'], ['æ˜¯', 'æ˜¯', '3.4.2 æ°¸ç»­åŸæŠ•å€º'], ['å¦', 'å¦', '3.5.1 éæ°¸ç»­äº§ä¸šå€º'],","-     ['å¦', 'æ˜¯', '3.5.2 æ°¸ç»­äº§ä¸šå€º']], columns=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­', 'ä¸‰çº§åˆ†ç±»'])","-bond_set_df = bond_set_df.merge(to_merge_df, left_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], right_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'],","-                                how='left')","-# åˆå¹¶åˆ°æŒä»“è¡¨","+","+to_merge_df = pd.DataFrame([","+    ['æ˜¯', 'å¦', '3.4.1 éæ°¸ç»­åŸæŠ•å€º'], ['æ˜¯', 'æ˜¯', '3.4.2 æ°¸ç»­åŸæŠ•å€º'],","+    ['å¦', 'å¦', '3.5.1 éæ°¸ç»­äº§ä¸šå€º'], ['å¦', 'æ˜¯', '3.5.2 æ°¸ç»­äº§ä¸šå€º']","+], columns=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­', 'ä¸‰çº§åˆ†ç±»'])","+bond_set_df = bond_set_df.merge(to_merge_df, left_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], right_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], how='left')","+"," Chicang_df['ä¸‰çº§åˆ†ç±»-new'] = Chicang_df.apply(","-    lambda x: bond_set_df.set_index('å¤–éƒ¨ä»£ç ').loc[x['å¤–éƒ¨ä»£ç '], 'ä¸‰çº§åˆ†ç±»'] if x['ç¼–å·'] == '3.4-3.5' else x[","-        'ä¸‰çº§åˆ†ç±»'], axis=1)","+    lambda x: bond_set_df.set_index('å¤–éƒ¨ä»£ç ').loc[x['å¤–éƒ¨ä»£ç '], 'ä¸‰çº§åˆ†ç±»'] if x['ç¼–å·'] == '3.4-3.5' else x['ä¸‰çº§åˆ†ç±»'],","+    axis=1","+)","+"," # åŒ¹é…å¤šèµ„äº§å“ç±»"," yunzuogailan_now = pd.read_excel(Config.get_overview_parent_file(date), index_col=0)","-Parent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[","-    ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]","-Chicang_df2 = Chicang_df.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»', 'äº§å“ç»ç†']], left_on='äº§å“ä»£ç ', right_index=True,","-                               how='left')","-Chicang_df2 = Chicang_df2[","-    Chicang_df2.apply(lambda x: not pd.isnull(x['äº§å“ç»ç†']), axis=1)]  # åŒ¹é…ä¸åˆ°äº§å“ç»ç†çš„æ˜¯å½“å¤©äº§å“å·²ç»åˆ°æœŸäº†ï¼Œä½†æ˜¯pasæŒä»“ä»æœ‰æ‹‰å–","-Chicang_df2 = del_Innovation_department(Chicang_df2)  # æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“","+Chicang_df2 = Chicang_df.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»', 'äº§å“ç»ç†']], left_on='äº§å“ä»£ç ', right_index=True, how='left')","+Chicang_df2 = Chicang_df2[Chicang_df2.apply(lambda x: not pd.isnull(x['äº§å“ç»ç†']), axis=1)]","+Chicang_df2 = del_Innovation_department(Chicang_df2)"," Chicang_df2 = Chicang_df2.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')"," ","-result_df_8_initial = pd.pivot_table(Chicang_df2, index=['ä¸‰çº§åˆ†ç±»-new'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],","-                                     values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum) / 100000000  # ä¸“æˆ·æŒä»“çš„æ•°æ®é€è§†","+result_df_8_initial = pd.pivot_table(","+    Chicang_df2, index=['ä¸‰çº§åˆ†ç±»-new'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],","+    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum","+) / 100000000"," ","-# ç»†åŒ–7.2 å§”å¤–å€ºåˆ¸æŠ•èµ„çš„å­é¡¹","+# ç»†åŒ–å§”å¤–å€ºåˆ¸æŠ•èµ„å­é¡¹"," Outsourced_bond_asset_df = Chicang_df2[Chicang_df2['ä¸‰çº§åˆ†ç±»'] == '7.2 å§”å¤–å€ºåˆ¸æŠ•èµ„']","-public_account_tag_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å§”å¤–å…¬å…±ç­–ç•¥ä¸“æˆ·æ ‡ç­¾',","-                                      index_col=0)","-Outsourced_bond_asset_df_new = Outsourced_bond_asset_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°',","-                                                              right_index=True, how='left')","-Outsourced_bond_tag = {'æ”¶ç›˜ä»·æ³•': '7.2.1 æ”¶ç›˜ä»·ä¸“æˆ·',","-                       'åˆ©ç‡å€ºæ”¶ç›˜ä»·': '7.2.2 åˆ©ç‡å€ºæ”¶ç›˜ä»·ä¸“æˆ·',","-                       'æ¨¡å‹æ³•': '7.2.3 æ¨¡å‹æ³•ä¸“æˆ·',","-                       'å¯è½¬å€º': '7.2.4 å¯è½¬å€ºä¸“æˆ·',","-                       'æ’å®šä¹…æœŸ': '7.2.5 æ’å®šä¹…æœŸä¸“æˆ·',","-                       'å›ºæ”¶+å§”å¤–': '7.2.6 å›ºæ”¶+å§”å¤–ä¸“æˆ·',","-                       'Wä¸“æˆ·': '7.2.7 Wä¸“æˆ·',","-                       'ç»¿è‰²å€º': '7.2.8 ç»¿è‰²å€ºä¸“æˆ·',","-                       'å¤–å¸ä¸“æˆ·': '7.2.9 å¤–å¸ä¸“æˆ·', }","-# é¢å¤–å®šä¹‰è¡¥å……çš„åˆ†ç±»ï¼Œéç”±æ±‡æ€»çš„pivot_tableè®¡ç®—","+public_account_tag_df = data_loader.load_public_account_tag()","+Outsourced_bond_asset_df_new = Outsourced_bond_asset_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')","+","+Outsourced_bond_tag = {","+    'æ”¶ç›˜ä»·æ³•': '7.2.1 æ”¶ç›˜ä»·ä¸“æˆ·', 'åˆ©ç‡å€ºæ”¶ç›˜ä»·': '7.2.2 åˆ©ç‡å€ºæ”¶ç›˜ä»·ä¸“æˆ·',","+    'æ¨¡å‹æ³•': '7.2.3 æ¨¡å‹æ³•ä¸“æˆ·', 'å¯è½¬å€º': '7.2.4 å¯è½¬å€ºä¸“æˆ·',","+    'æ’å®šä¹…æœŸ': '7.2.5 æ’å®šä¹…æœŸä¸“æˆ·', 'å›ºæ”¶+å§”å¤–': '7.2.6 å›ºæ”¶+å§”å¤–ä¸“æˆ·',","+    'Wä¸“æˆ·': '7.2.7 Wä¸“æˆ·', 'ç»¿è‰²å€º': '7.2.8 ç»¿è‰²å€ºä¸“æˆ·', 'å¤–å¸ä¸“æˆ·': '7.2.9 å¤–å¸ä¸“æˆ·',","+}"," Outsourced_bond_asset_df_new['å››çº§åˆ†ç±»'] = Outsourced_bond_asset_df_new['æ ‡ç­¾'].map(","-    lambda x: Outsourced_bond_tag[x] if x in Outsourced_bond_tag.keys() else '7.2.10 å…¶ä»–')","-Outsourced_bond_asset_result = pd.pivot_table(Outsourced_bond_asset_df_new, index=['å››çº§åˆ†ç±»'],","-                                              columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'],","-                                              aggfunc=np.sum) / 100000000  # ä¸“æˆ·æŒä»“çš„æ•°æ®é€è§†","+    lambda x: Outsourced_bond_tag[x] if x in Outsourced_bond_tag.keys() else '7.2.10 å…¶ä»–'","+)","+Outsourced_bond_asset_result = pd.pivot_table(","+    Outsourced_bond_asset_df_new, index=['å››çº§åˆ†ç±»'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],","+    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum","+) / 100000000","+"," result_df_8 = pd.concat([result_df_8_initial.rename_axis(''), Outsourced_bond_asset_result.rename_axis('')])"," result_df_8.to_excel(Config.get_asset_table_file(date))","+","+# è®¡ç®—åŒæ¯”ç¯æ¯”å˜åŒ–"," result_df_lastw = pd.read_excel(Config.get_asset_table_file(date_lastw), index_col=0, header=[0, 1, 2])"," result_df_lastm = pd.read_excel(Config.get_asset_table_file(lastm), index_col=0, header=[0, 1, 2])"," result_df_lasty = pd.read_excel(Config.get_asset_table_file(lasty), index_col=0, header=[0, 1, 2])","-# åˆå¹¶æœ¬å‘¨æ•°æ®å’Œç›¸æ¯”ä¹‹å‰ï¼Œå¹¶è°ƒèŠ‚å¤šé‡ç´¢å¼•","-result_df_8_final = pd.concat([result_df_8, result_df_8.sum(axis=1) - result_df_lastw.sum(axis=1),","-                               result_df_8.sum(axis=1) - result_df_lastm.sum(axis=1),","-                               result_df_8.sum(axis=1) - result_df_lasty.sum(axis=1)], axis=1)"," ","-# result_df_8_final.to_excel('test.xlsx',sheet_name='8.èµ„äº§å¤§è¡¨')","+result_df_8_final = pd.concat([","+    result_df_8, result_df_8.sum(axis=1) - result_df_lastw.sum(axis=1),","+    result_df_8.sum(axis=1) - result_df_lastm.sum(axis=1),","+    result_df_8.sum(axis=1) - result_df_lasty.sum(axis=1)","+], axis=1)"," ","-# è¡¥å……æœ¬å¸çš„ç›¸æ¯”ä¸Šå‘¨ã€ç›¸æ¯”ä¸Šæœˆã€ç›¸æ¯”ä¸Šå¹´(å»æ‰å¤–å¸äº§å“ï¼‰","+# è¡¥å……æœ¬å¸çš„ç›¸æ¯”å˜åŒ–"," foreign_currency_products_cols = [","     ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),","     ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼')"," ]","-","-# è·å–æ‰€æœ‰éå¤–å¸äº§å“åˆ—"," all_columns_8 = list(result_df_8.columns)"," domestic_columns_8 = [col for col in all_columns_8 if col not in foreign_currency_products_cols]","-"," all_columns_lastw = list(result_df_lastw.columns)"," domestic_columns_lastw = [col for col in all_columns_lastw if col not in foreign_currency_products_cols]","-"," all_columns_lastm = list(result_df_lastm.columns)"," domestic_columns_lastm = [col for col in all_columns_lastm if col not in foreign_currency_products_cols]","-"," all_columns_lasty = list(result_df_lasty.columns)"," domestic_columns_lasty = [col for col in all_columns_lasty if col not in foreign_currency_products_cols]"," ","-# ä½¿ç”¨åˆ—è¡¨è€Œä¸æ˜¯é›†åˆæ¥è®¡ç®—å›½å†…è´§å¸æ•°æ®"," result_df_8_domestic_currency = result_df_8[domestic_columns_8].sum(axis=1)"," result_df_lastw_domestic_currency = result_df_lastw[domestic_columns_lastw].sum(axis=1)"," result_df_lastm_domestic_currency = result_df_lastm[domestic_columns_lastm].sum(axis=1)"," result_df_lasty_domestic_currency = result_df_lasty[domestic_columns_lasty].sum(axis=1)"," ","-# å°†å›½å†…è´§å¸çš„æ¯”è¾ƒæ•°æ®åˆå¹¶åˆ°æœ€ç»ˆç»“æœ"," result_df_8_final = pd.concat([","     result_df_8_final,","     result_df_8_domestic_currency - result_df_lastw_domestic_currency,"]},{"oldStart":1089,"oldLines":454,"newStart":1049,"newLines":468,"lines":["     result_df_8_domestic_currency - result_df_lasty_domestic_currency"," ], axis=1)"," ","-# è®¾ç½®æœ€ç»ˆç»“æœçš„åˆ—å"," result_df_8_final.columns = pd.MultiIndex.from_tuples(","-    tuple(result_df_8.columns) +","-    ((\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨'),","-     (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ'),","-     (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´'),","-     (\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨-ä¸å«å¤–å¸äº§å“'),","-     (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ-ä¸å«å¤–å¸äº§å“'),","-     (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´-ä¸å«å¤–å¸äº§å“'))","+    tuple(result_df_8.columns) + (","+        (\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨'), (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ'), (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´'),","+        (\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨-ä¸å«å¤–å¸äº§å“'), (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ-ä¸å«å¤–å¸äº§å“'), (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´-ä¸å«å¤–å¸äº§å“')","+    )"," )","-","-# å°†ç»“æœå†™å…¥Excel"," result_df_8_final.to_excel(writer, sheet_name='8.èµ„äº§å¤§è¡¨')"," ","-date = zhoubao_date","-zhongshou_m_path = os.path.join(Config.WEEKLY_DATA_DIR, f'ä¸­æ”¶åˆ†ææŠ¥è¡¨-äº§å“æ˜ç»†-{date}-m.xlsx')","-zhongshou_y_path = os.path.join(Config.WEEKLY_DATA_DIR, f'ä¸­æ”¶åˆ†ææŠ¥è¡¨-äº§å“æ˜ç»†-{date}-y.xlsx')","-zhongshou_m = pd.read_excel(zhongshou_m_path, index_col=0, skiprows=1)","-zhongshou_y = pd.read_excel(zhongshou_y_path, index_col=0, skiprows=1)","-# æ³¨ï¼šåˆäº«å’ŒBOFçš„é”€å”®ç®¡ç†è´¹=0.é¢å¤–åŠ ä¸Šæœ¬æœˆæ–°èµ·æ¯åˆäº«çš„ä»½é¢*é”€å”®ç®¡ç†è´¹*è¿ä½œå¤©æ•°/365"," ","-classification_df = pd.read_excel(","-    Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),","-    sheet_name='å¤šèµ„äº§å“ç±»æ ‡ç­¾',","-    index_col='æ¯äº§å“ä»£ç '","-)","-# å»é‡é˜²æ­¢ç´¢å¼•é‡å¤å¯¼è‡´mergeæˆ–æ˜ å°„å¼‚å¸¸","-classification_df = classification_df[~classification_df.index.duplicated(keep='first')]","-classification_ye = classification_df[['å¤šèµ„äº§å“ç±»']]","+# ==============================================================================","+# ç¬¬åå››éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - ä¸­æ”¶ç›‘æ§","+# =============================================================================="," ","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨9: ä¸­æ”¶ç›‘æ§","+# ------------------------------------------------------------------------------","+print(\"\\n[9] ç”ŸæˆæŠ¥è¡¨: 9.ä¸­æ”¶ç›‘æ§...\")"," ","-def zhongshou_df_processing_v2(df_here, period_here: str):  # æ ¹æ®è®¡è´¢éƒ¨æ–°è°ƒæ•´çš„è¡¨æ ¼è®¡ç®—ã€‚å‰ç«¯æ”¶è´¹äº§å“ä¸ç”¨å†æ‰‹åŠ¨è°ƒæ•´ï¼Œ","-    # ä¾‹zhongshou_df_processing(zhongshou_m,'æœ¬æœˆ','2024-03')","+date = zhoubao_date","+zhongshou_m, zhongshou_y = data_loader.load_zhongshou_data(date)","+","+","+def zhongshou_df_processing_v2(df_here, period_here: str):","+    \"\"\"å¤„ç†ä¸­æ”¶æ•°æ®\"\"\"","     fixed_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'æŠ•èµ„å›¢é˜Ÿ', 'å›¢é˜Ÿåˆ’åˆ†', 'äº§å“çº¿']","     df_here.columns = fixed_cols + list(df_here.columns[5:])","     df_here = df_here[df_here['å›¢é˜Ÿåˆ’åˆ†'] == '5.å¤šèµ„äº§æŠ•èµ„éƒ¨']","-    # å•ç‹¬æ‹‰å–é”€å”®ç®¡ç†è´¹å’ŒæŠ•èµ„ç®¡ç†è´¹ï¼Œæ–¹ä¾¿åé¢è°ƒæ•´è®¡ç®—ä¸­æ”¶","     df_here.columns = [''.join(x.split('\\n')) for x in df_here.columns]","-    zhongshou_cols = ['é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰',","-                      'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']  # æ‰£å‡ä»£é”€ä¸­æ”¶","+    zhongshou_cols = ['é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']","     df_here = df_here[fixed_cols + zhongshou_cols]","-    # åˆ é™¤ä¸­æ”¶ä¸º0çš„è¡Œï¼Œæœ‰ä¸€äº›æ˜¯è€äº§å“æˆ–è€…æœªå‘è¡Œäº§å“","     df_here = df_here[df_here['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰'].map(lambda x: x > 0.00001)]","-    # åŒ¹é…å“ç±»","-    df_here = df_here.merge(classification_ye, left_index=True, right_index=True, how='left')","-    df_here = del_Innovation_department(df_here)  # æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“,å…ˆä¸å»ï¼Œç›®å‰ç»Ÿä¸€è€ƒæ ¸","+    df_here = df_here.merge(classification_df[['å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True, how='left')","+    df_here = del_Innovation_department(df_here)","     df_here = df_here.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')","-    # æ±‡æ€»ç³»åˆ—ç»“æœ","     mid_result = df_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).sum()[","-        ['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']]","+        ['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']","+    ]","     mid_cols = [period_here + x for x in ['ä¸­æ”¶', 'é”€å”®ç®¡ç†è´¹', 'æŠ•èµ„ç®¡ç†è´¹(å«è¶…é¢)', 'è¶…é¢ç®¡ç†è´¹', 'å‰ç«¯æ”¶è´¹']]","     mid_result.columns = mid_cols","     return mid_result"," "," ","-result_9 = pd.concat([zhongshou_df_processing_v2(zhongshou_m, '-'.join([date[:4], date[4:6]])),","-                      zhongshou_df_processing_v2(zhongshou_y, date[:4])], axis=1)","+result_9 = pd.concat([","+    zhongshou_df_processing_v2(zhongshou_m, '-'.join([date[:4], date[4:6]])),","+    zhongshou_df_processing_v2(zhongshou_y, date[:4])","+], axis=1)"," result_9 = rank_by_sort(result_9, rank_here)"," result_9.to_excel(writer, sheet_name='9.ä¸­æ”¶ç›‘æ§')"," "," ","-# result_9.to_excel('test.xlsx',sheet_name='9.ä¸­æ”¶ç›‘æ§')","+# ==============================================================================","+# ç¬¬åäº”éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - äº§å“åˆ°æœŸ","+# =============================================================================="," ","-# åˆ¤æ–­å“ç±»Indexæ˜¯å¦é½å…¨","-def full_category_or_not(df_def, rank_def):","-    df_def = df_def.copy()","-    for x in rank_def:","-        if x not in df_def.index:","-            df_def.loc[x, :] = None","-    return df_def","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨10: äº§å“åˆ°æœŸæƒ…å†µ","+# ------------------------------------------------------------------------------","+print(\"\\n[10] ç”ŸæˆæŠ¥è¡¨: 10.äº§å“åˆ°æœŸæƒ…å†µ...\")"," ","-"," date = zhoubao_date","-yunzuogailan_now = del_Innovation_department(pd.read_excel(","-    Config.get_overview_parent_file(date), index_col=0))","+yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(date), index_col=0))"," yunzuogailan_now['åˆ°æœŸæœˆä»½'] = yunzuogailan_now['åˆ°æœŸæ—¥'].map(lambda x: x[:-3])","-Parent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)"," yunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')","-# ä»…çœ‹å‘¨æŠ¥ä¸‹å‘¨åçš„åˆ°æœŸæƒ…å†µ"," yunzuogailan_here = yunzuogailan_here[yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w]","+"," yunzuogailan_here_fengbi = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å°é—­']"," yunzuogailan_here_dingkai = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å®šå¼€']"," output_sheetname = ['10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ', '10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ-å®šå¼€']","+"," k = 0"," for yunzuogailan_here_to_cal in [yunzuogailan_here_fengbi, yunzuogailan_here_dingkai]:","-    result_df_10 = pd.pivot_table(yunzuogailan_here_to_cal, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='åˆ°æœŸæœˆä»½',","-                                  values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)  # æ•°æ®é€è§†","-    result_df_10 = rank_by_sort(full_category_or_not(result_df_10, rank_here), rank_here).T  # å¯¹åˆ†ç±»è¿›è¡Œæ’åº-å±•ç¤ºä¼˜åŒ–","-    result_df_10.index = result_df_10.loc['å‡€èµ„äº§(äº¿)'].index  # å¤šé‡indxç´¢å¼•è½¬æˆå•ç´¢å¼•float","+    result_df_10 = pd.pivot_table(","+        yunzuogailan_here_to_cal, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='åˆ°æœŸæœˆä»½',","+        values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum","+    )","+    result_df_10 = rank_by_sort(full_category_or_not(result_df_10, rank_here), rank_here).T","+    result_df_10.index = result_df_10.loc['å‡€èµ„äº§(äº¿)'].index","     result_df_10[[float(x[:4]) < 2029 for x in result_df_10.index]].to_excel(writer, sheet_name=output_sheetname[k])","     k += 1","-keep_cols = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'æ¯åˆ†ç±»', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©',","-             'å‰©ä½™å¤©', 'äº§å“ç»ç†',","-             'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']","+","+keep_cols = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'æ¯åˆ†ç±»', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']"," result_df_10_2 = yunzuogailan_here[","-    (yunzuogailan_here['åˆ°æœŸæ—¥'] <= closing_date_next_w) & (yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w)][","-    keep_cols]","+    (yunzuogailan_here['åˆ°æœŸæ—¥'] <= closing_date_next_w) & (yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w)","+][keep_cols]"," result_df_10_2.sort_values(by='åˆ°æœŸæ—¥', ascending=True, inplace=True)"," result_df_10_2.to_excel(writer, sheet_name='10.ä¸‹å‘¨åˆ°æœŸäº§å“æ¸…å•')"," ","-print('ä¸‹å‘¨åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2['å‡€èµ„äº§(äº¿)'].sum()))","-print('å°é—­åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum()))","-print('å®šå¼€åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()))","-date = zhoubao_date","-excel_name = 'æŒä»“ç›ˆäºæ˜ç»†åˆ—è¡¨_' + date + '.xlsx'","-Chicang_df = pd.read_excel(os.path.join(Config.WEEKLY_DATA_DIR, excel_name))","-Chicang_df.rename(columns={'èµ„äº§ç®€ç§°': 'å€ºåˆ¸ç®€ç§°'}, inplace=True)  ###æŒ‰ç…§è€çš„ç®€ç§°è®¡ç®—","-Chicang_df.drop_duplicates(inplace=True)","+print('   ä¸‹å‘¨åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2['å‡€èµ„äº§(äº¿)'].sum()))","+print('   å°é—­åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum()))","+print('   å®šå¼€åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()))"," ","-# å…´åˆç³»åˆ—","+","+# ==============================================================================","+# ç¬¬åå…­éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - æŒä»“åˆ†æ","+# ==============================================================================","+","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨11: æŒä»“æ˜ç»†","+# ------------------------------------------------------------------------------","+print(\"\\n[11] ç”ŸæˆæŠ¥è¡¨: 11.æŒä»“æ˜ç»†...\")","+","+date = zhoubao_date","+Chicang_df = data_loader.load_chicang_data(date)"," Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()","-xinghe_list = Config.XINGHE_PRODUCTS  # éœ€è¦å±•ç¤ºçš„å…´åˆæ¸…å•ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰","-concat_xinghe_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢","+","+# 11.1 å…´åˆäº§å“æŒä»“æ˜ç»†","+print(\"[11.1] ç”ŸæˆæŠ¥è¡¨: 11.å…´åˆäº§å“æŒä»“æ˜ç»†...\")","+xinghe_list = Config.XINGHE_PRODUCTS","+concat_xinghe_series = []"," for i in range(len(xinghe_list)):","     ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'","     concat_xinghe_series.append(pd.Series(","         Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","-        name=xinghe_list[i] + '-é‡‘é¢'))","+        name=xinghe_list[i] + '-é‡‘é¢'","+    ))"," "," concat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)","-concat_xinghe_df = concat_xinghe_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","-                                          left_index=True, right_index=True, how='left')","+concat_xinghe_df = concat_xinghe_df.merge(","+    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","+    left_index=True, right_index=True, how='left'","+)"," concat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)"," concat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]","-result_df_11_1 = pd.concat(","-    [concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","-     concat_xinghe_pct_df], axis=1)","+result_df_11_1 = pd.concat([","+    concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","+    concat_xinghe_pct_df","+], axis=1)"," result_df_11_1.to_excel(writer, sheet_name='11.å…´åˆäº§å“æŒä»“æ˜ç»†')"," ","-# å¯è½¬å€ºä¸“æˆ·","-Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()","-concat_zhuanzhai_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢","-zhuanzhai_dict = Config.CONVERTIBLE_BOND_ACCOUNTS  # å¯è½¬å€ºä¸“æˆ·ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰","-# æ‰‹å·¥å¢åŠ å¯è½¬å€ºä¸“æˆ·çš„é…ç½®æƒ…å†µ","+# 11.1.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†","+print(\"[11.1.1] ç”ŸæˆæŠ¥è¡¨: 11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†...\")","+concat_zhuanzhai_series = []","+zhuanzhai_dict = Config.CONVERTIBLE_BOND_ACCOUNTS"," zhuanzhai_list = []"," for shortname in zhuanzhai_dict.keys():","     concat_zhuanzhai_series.append(pd.Series(","-        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')[","-            'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name=shortname + '-é‡‘é¢'))","+        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+        name=shortname + '-é‡‘é¢'","+    ))","     zhuanzhai_list += [shortname]"," ","-# æ‰‹å·¥å¢åŠ å¯è½¬å€ºåŸºé‡‘çš„é…ç½®æƒ…å†µï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰"," ETF_bond_list = Config.CONVERTIBLE_BOND_ETF"," concat_zhuanzhai_series.append(pd.Series(","-    Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')[","-        'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='å¯è½¬å€ºETF-é‡‘é¢'))","+    Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+    name='å¯è½¬å€ºETF-é‡‘é¢'","+))"," zhuanzhai_list += ['å¯è½¬å€ºETF']"," "," concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)","-concat_zhuanzhai_df = concat_zhuanzhai_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","-                                                left_index=True, right_index=True, how='left')","+concat_zhuanzhai_df = concat_zhuanzhai_df.merge(","+    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","+    left_index=True, right_index=True, how='left'","+)"," concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(","-    concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0)","+    concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0","+)"," concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]","-result_df_11_1_1 = pd.concat(","-    [concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","-     concat_zhuanzhai_pct_df], axis=1)","+result_df_11_1_1 = pd.concat([","+    concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","+    concat_zhuanzhai_pct_df","+], axis=1)"," result_df_11_1_1.to_excel(writer, sheet_name='11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†')","-# result_df_11_1_1.to_excel(Underlying_data_folder_path+'test2.xlsx',sheet_name='11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†')"," ","-# è¡¥å……å§”å¤–ä¸“æˆ·çš„æ ‡ç­¾","-public_account_tag_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å§”å¤–å…¬å…±ç­–ç•¥ä¸“æˆ·æ ‡ç­¾',","-                                      index_col=0)","+# 11.2 é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†","+print(\"[11.2] ç”ŸæˆæŠ¥è¡¨: 11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†...\")","+public_account_tag_df = data_loader.load_public_account_tag()"," Weiwai_df_full = Weiwai_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')","-# è¡¥å……äº§å“çš„å“ç±»","-Weiwai_df_full = Weiwai_df_full.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»']], left_on='äº§å“ä»£ç ', right_index=True,","-                                      how='left')","-Weiwai_df_full = Weiwai_df_full.merge(Parent_sort[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True,","-                                      how='left')","+Weiwai_df_full = Weiwai_df_full.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»']], left_on='äº§å“ä»£ç ', right_index=True, how='left')","+Weiwai_df_full = Weiwai_df_full.merge(Parent_sort[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')"," ","-# é‡åŒ–ç­–ç•¥ä¸“æˆ·å’Œå…´åˆ4çš„é…ç½®æƒ…å†µï¼ˆç»†åŒ–æ ‡ç­¾ï¼Œåœ¨config.pyä¸­é…ç½®ï¼‰"," concat_quant_series = []"," quant_list = Config.QUANT_STRATEGY_LABELS","-concat_quant_series.append(pd.Series(Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–ä¸­æ€§'].groupby('äº§å“ä»£ç ')[","-                                         'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é‡åŒ–ä¸­æ€§'))","-concat_quant_series.append(pd.Series(Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–æŒ‡å¢'].groupby('äº§å“ä»£ç ')[","-                                         'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é‡åŒ–æŒ‡å¢'))","-concat_quant_series.append(pd.Series(Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–CTA'].groupby('äº§å“ä»£ç ')[","-                                         'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é‡åŒ–CTA'))"," concat_quant_series.append(pd.Series(","-    Weiwai_df_full[Weiwai_df_full['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-å…´åˆ4å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')[","-        'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='å…´åˆ4å·'))","+    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–ä¸­æ€§'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+    name='é‡åŒ–ä¸­æ€§'","+))","+concat_quant_series.append(pd.Series(","+    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–æŒ‡å¢'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+    name='é‡åŒ–æŒ‡å¢'","+))","+concat_quant_series.append(pd.Series(","+    Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–CTA'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+    name='é‡åŒ–CTA'","+))","+concat_quant_series.append(pd.Series(","+    Weiwai_df_full[Weiwai_df_full['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-å…´åˆ4å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+    name='å…´åˆ4å·'","+))"," concat_quant_df = pd.concat(concat_quant_series, axis=1)","-concat_quant_df = concat_quant_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)']], left_index=True,","-                                        right_index=True, how='left')","+concat_quant_df = concat_quant_df.merge(","+    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)']],","+    left_index=True, right_index=True, how='left'","+)"," concat_quant_pct_df = concat_quant_df[quant_list].div(concat_quant_df['å‡€èµ„äº§(äº¿)'], axis=0)"," concat_quant_pct_df.columns = [x + '-å æ¯”' for x in quant_list]"," result_df_11_3 = pd.concat([concat_quant_df[quant_list + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†']], concat_quant_pct_df], axis=1)"," result_df_11_3.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)"," result_df_11_3.to_excel(writer, sheet_name='11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†')"," ","-","-","-# è®¡ç®—æŒä»“çš„è§„æ¨¡åŠå æ¯”(å•ä¸ªç†è´¢äº§å“æŒä»“å äº§å“è§„æ¨¡çš„æ¯”-çš„å¹³å‡)","-result_df_11_2_amt = pd.pivot_table(Weiwai_df_full, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ ‡ç­¾',","-                                    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum) / 100000000  # æ•°æ®é€è§†","+# 11.2.1-11.2.3 å§”å¤–ä¸“æˆ·é…ç½®æƒ…å†µ","+print(\"[11.2.1-11.2.3] ç”ŸæˆæŠ¥è¡¨: å§”å¤–ä¸“æˆ·é…ç½®æƒ…å†µ...\")","+result_df_11_2_amt = pd.pivot_table(","+    Weiwai_df_full, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ ‡ç­¾',","+    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum","+) / 100000000"," yunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')","-# å æ¯”è®¡ç®—æ–¹å¼1ï¼šé™¤ä»¥ç³»åˆ—è§„æ¨¡","-result_df_11_2_pct_2 = result_df_11_2_amt.div(yunzuogailan_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'])['å‡€èµ„äº§(äº¿)'].sum(),","-                                              axis=0)","-# å æ¯”è®¡ç®—æ–¹å¼2ï¼šä¹‹å‰çš„ç™¾åˆ†æ¯”è®¡ç®—æ–¹å¼ä¸åˆç†ï¼Œä¹‹å‰æ˜¯å…¨éƒ¨ç†è´¢äº§å“æŒä»“/å…¨éƒ¨ç†è´¢äº§å“è§„æ¨¡ï¼Œå¾ˆå¤šç†è´¢äº§å“å¹¶æœªæŒæœ‰ä¸“æˆ·çš„ä¼šæ‘Šè–„æŒä»“æ¯”ä¾‹","-Weiwai_df_simplify = pd.pivot_table(Weiwai_df_full, index=['äº§å“ä»£ç '], columns='æ ‡ç­¾',","-                                    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum) / 100000000  # æ•°æ®é€è§†","+result_df_11_2_pct_2 = result_df_11_2_amt.div(yunzuogailan_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'])['å‡€èµ„äº§(äº¿)'].sum(), axis=0)","+","+Weiwai_df_simplify = pd.pivot_table(","+    Weiwai_df_full, index=['äº§å“ä»£ç '], columns='æ ‡ç­¾',","+    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum","+) / 100000000"," Weiwai_df_simplify.columns = Weiwai_df_simplify['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].columns","-Weiwai_df_simplify = Weiwai_df_simplify.merge(yunzuogailan_here[['å‡€èµ„äº§(äº¿)']], left_index=True, right_index=True,","-                                              how='left')","+Weiwai_df_simplify = Weiwai_df_simplify.merge(yunzuogailan_here[['å‡€èµ„äº§(äº¿)']], left_index=True, right_index=True, how='left')"," result_df_11_2_pct = Weiwai_df_simplify.div(Weiwai_df_simplify['å‡€èµ„äº§(äº¿)'], axis=0).merge(","-    yunzuogailan_here[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_index=True, right_index=True, how='left')","+    yunzuogailan_here[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_index=True, right_index=True, how='left'","+)"," result_df_11_2_pct = result_df_11_2_pct.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()","-rank_by_sort(full_category_or_not(result_df_11_2_amt, rank_here), rank_here).to_excel(writer,","-                                                                                      sheet_name='11.2.1å…¶ä»–å§”å¤–ä¸“æˆ·é‡‘é¢é…ç½®æƒ…å†µ')","-rank_by_sort(full_category_or_not(result_df_11_2_pct, rank_here), rank_here).to_excel(writer,","-                                                                                      sheet_name='11.2.2å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ')","-rank_by_sort(full_category_or_not(result_df_11_2_pct_2, rank_here), rank_here).to_excel(writer,","-                                                                                        sheet_name='11.2.3å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ-é™¤ä»¥ç³»åˆ—è§„æ¨¡')"," ","-# å…¶ä»–è¡ç”Ÿå“æŒä»“æƒ…å†µ","-Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()","-xinghe_list = Config.XINGHE_PRODUCTS_2  # éœ€è¦å±•ç¤ºçš„å…´åˆæ¸…å•ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰","-concat_xinghe_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢","+rank_by_sort(full_category_or_not(result_df_11_2_amt, rank_here), rank_here).to_excel(","+    writer, sheet_name='11.2.1å…¶ä»–å§”å¤–ä¸“æˆ·é‡‘é¢é…ç½®æƒ…å†µ'","+)","+rank_by_sort(full_category_or_not(result_df_11_2_pct, rank_here), rank_here).to_excel(","+    writer, sheet_name='11.2.2å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ'","+)","+rank_by_sort(full_category_or_not(result_df_11_2_pct_2, rank_here), rank_here).to_excel(","+    writer, sheet_name='11.2.3å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ-é™¤ä»¥ç³»åˆ—è§„æ¨¡'","+)","+","+# 11.4 å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†","+print(\"[11.4] ç”ŸæˆæŠ¥è¡¨: 11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†...\")","+xinghe_list = Config.XINGHE_PRODUCTS_2","+concat_xinghe_series = []"," for i in range(len(xinghe_list)):","     ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'","     concat_xinghe_series.append(pd.Series(","         Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","-        name=xinghe_list[i] + '-é‡‘é¢'))","-# æ‰‹å·¥å¢åŠ çµåŠ¨1å·çš„é…ç½®æƒ…å†µ","+        name=xinghe_list[i] + '-é‡‘é¢'","+    ))"," concat_xinghe_series.append(pd.Series(","-    Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-è´¢æ™ºäººç”ŸçµåŠ¨1å·å•ä¸€èµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')[","-        'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='çµåŠ¨1å·-é‡‘é¢'))","-xinghe_list += ['çµåŠ¨1å·']","+    Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-è´¢æ™ºäººç”ŸçµåŠ¨1å·å•ä¸€èµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+    name='çµåŠ¨1å·-é‡‘é¢'","+))","+xinghe_list = xinghe_list + ['çµåŠ¨1å·']","+"," concat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)","-concat_xinghe_df = concat_xinghe_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","-                                          left_index=True, right_index=True, how='left')","+concat_xinghe_df = concat_xinghe_df.merge(","+    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","+    left_index=True, right_index=True, how='left'","+)"," concat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)"," concat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]","-result_df_11_4 = pd.concat(","-    [concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","-     concat_xinghe_pct_df], axis=1)","-result_df_11_4.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)  # å»æ‰åˆ›æ–°éƒ¨äº§å“","+result_df_11_4 = pd.concat([","+    concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","+    concat_xinghe_pct_df","+], axis=1)","+result_df_11_4.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)"," result_df_11_4.to_excel(writer, sheet_name='11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†')","-# result_df_11_4.to_excel(Underlying_data_folder_path+'test1.xlsx',sheet_name='11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†')"," ","-# æ±‡æ€»è¡ç”Ÿå“ä¸“æˆ·çš„é…ç½®æƒ…å†µ","-Zhuanhu_label_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å§”å¤–å…¬å…±ç­–ç•¥ä¸“æˆ·æ ‡ç­¾',","-                                 index_col=0)","+# 11.5 å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”","+print(\"[11.5] ç”ŸæˆæŠ¥è¡¨: 11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”...\")","+Zhuanhu_label_df = data_loader.load_public_account_tag()"," derivative_zhuanhu_list = list(Zhuanhu_label_df[Zhuanhu_label_df['æ ‡ç­¾'] == 'è¡ç”Ÿå“ä¸“æˆ·'].index)"," derivative_zhuanhu_df = Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in derivative_zhuanhu_list)]","-# è·å–è¡ç”Ÿå“æŒä»“æ˜ç»†","-derivative_zhuanhu_df = pd.pivot_table(derivative_zhuanhu_df, index=['äº§å“ä»£ç '], columns='å€ºåˆ¸ç®€ç§°',","-                                       values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum)","+derivative_zhuanhu_df = pd.pivot_table(","+    derivative_zhuanhu_df, index=['äº§å“ä»£ç '], columns='å€ºåˆ¸ç®€ç§°',","+    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum","+)"," derivative_zhuanhu_df.columns = [x[1][5:-8] for x in derivative_zhuanhu_df.columns]","-derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'] = derivative_zhuanhu_df.sum(axis=1)  # æ±‡æ€»è¡ç”Ÿå“æŒä»“é‡‘é¢","+derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'] = derivative_zhuanhu_df.sum(axis=1)"," derivative_zhuanhu_df = derivative_zhuanhu_df.merge(","-    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True,","-    how='left')","+    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","+    left_index=True, right_index=True, how='left'","+)"," derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ¯”ä¾‹'] = derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'].div(","-    derivative_zhuanhu_df['å‡€èµ„äº§(äº¿)'], axis=0) / 100000000","-derivative_zhuanhu_df.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)  # å»æ‰åˆ›æ–°éƒ¨äº§å“","+    derivative_zhuanhu_df['å‡€èµ„äº§(äº¿)'], axis=0","+) / 100000000","+derivative_zhuanhu_df.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)"," derivative_zhuanhu_df.to_excel(writer, sheet_name='11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”')","-# derivative_zhuanhu_df.to_excel(Underlying_data_folder_path+'test2.xlsx',sheet_name='11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”')"," ","-# éæ ‡æŒä»“æ˜ç»†","+# 11.6 éæ ‡æŒä»“å æ¯”","+print(\"[11.6] ç”ŸæˆæŠ¥è¡¨: 11.6éæ ‡æŒä»“å æ¯”...\")"," feibiao_df = Chicang_df[Chicang_df.apply(","-    lambda x: (x['æ–°ç‰ˆèµ„äº§å¤§ç±»'] in ['éæ ‡å‡†åŒ–å€ºæƒç±»èµ„äº§', 'ç†è´¢ç›´æ¥èèµ„å·¥å…·', 'æ–°å¢å¯æŠ•èµ„èµ„äº§']) or (","-                x['æ–°ç‰ˆèµ„äº§å°ç±»'] in ['åŒä¸šå€Ÿæ¬¾']), axis=1)]","+    lambda x: (x['æ–°ç‰ˆèµ„äº§å¤§ç±»'] in ['éæ ‡å‡†åŒ–å€ºæƒç±»èµ„äº§', 'ç†è´¢ç›´æ¥èèµ„å·¥å…·', 'æ–°å¢å¯æŠ•èµ„èµ„äº§']) or","+              (x['æ–°ç‰ˆèµ„äº§å°ç±»'] in ['åŒä¸šå€Ÿæ¬¾']), axis=1","+)]"," feibiao_pct_df = pd.DataFrame(feibiao_df.groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum())","-feibiao_pct_df = feibiao_pct_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","-                                      left_index=True, right_index=True, how='left')","+feibiao_pct_df = feibiao_pct_df.merge(","+    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","+    left_index=True, right_index=True, how='left'","+)"," feibiao_pct_df['éæ ‡å æ¯”'] = feibiao_pct_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] / feibiao_pct_df['å‡€èµ„äº§(äº¿)'] / 100000000"," feibiao_pct_df.to_excel(writer, sheet_name='11.6éæ ‡æŒä»“å æ¯”')","-# feibiao_pct_df.to_excel('test.xlsx',sheet_name='11.6éæ ‡æŒä»“å æ¯”')"," ","-","-# é»„é‡‘ä¸“æˆ·é…ç½®ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰","+# é»„é‡‘æŒä»“","+print(\"[11.7] ç”ŸæˆæŠ¥è¡¨: é»„é‡‘æŒä»“...\")"," gold_dict = Config.GOLD_ACCOUNTS"," gold_ETF_bond_list = Config.GOLD_ETF"," "," ","-","-#['åå®‰æ˜“å¯Œé»„é‡‘äº¤æ˜“å‹å¼€æ”¾å¼è¯åˆ¸æŠ•èµ„åŸºé‡‘']","-","-# æƒç›Šä¸“æˆ·é…ç½®ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰","-equity_dict = Config.EQUITY_ACCOUNTS","-"," def get_zhdata(zhuanzhai_dict, ETF_bond_list):","-    # å¯è½¬å€ºä¸“æˆ·","-    Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()","-    concat_zhuanzhai_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢","-    # æ‰‹å·¥å¢åŠ å¯è½¬å€ºä¸“æˆ·çš„é…ç½®æƒ…å†µ","+    \"\"\"è·å–é»„é‡‘æŒä»“æ•°æ®\"\"\"","+    concat_zhuanzhai_series = []","     zhuanzhai_list = []","     for shortname in zhuanzhai_dict.keys():","         concat_zhuanzhai_series.append(pd.Series(","-            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')[","-                'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name=shortname + '-é‡‘é¢'))","+            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+            name=shortname + '-é‡‘é¢'","+        ))","         zhuanzhai_list += [shortname]","-    # æ‰‹å·¥å¢åŠ å¯è½¬å€ºåŸºé‡‘çš„é…ç½®æƒ…å†µ","     concat_zhuanzhai_series.append(pd.Series(","-        Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')[","-            'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é»„é‡‘ETF-é‡‘é¢'))","+        Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+        name='é»„é‡‘ETF-é‡‘é¢'","+    ))","     zhuanzhai_list += ['é»„é‡‘ETF']","     concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)","     concat_zhuanzhai_df = concat_zhuanzhai_df.merge(","-        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True,","-        how='left')","+        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","+        left_index=True, right_index=True, how='left'","+    )","     concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(","-        concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0)","+        concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0","+    )","     concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]","-    result_df_11_1_1 = pd.concat(","-        [concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","-         concat_zhuanzhai_pct_df], axis=1)","+    result_df_11_1_1 = pd.concat([","+        concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","+        concat_zhuanzhai_pct_df","+    ], axis=1)","     return result_df_11_1_1"," ","+","+hg_asset = get_zhdata(gold_dict, gold_ETF_bond_list)","+hg_asset[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-é‡‘é¢', 'é»„é‡‘ETF-é‡‘é¢',","+          'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-å æ¯”', 'é»„é‡‘ETF-å æ¯”']].to_excel(writer, sheet_name='é»„é‡‘æŒä»“')","+","+# æƒç›Šä¸“æˆ·æŒä»“","+print(\"[11.8] ç”ŸæˆæŠ¥è¡¨: æƒç›Šä¸“æˆ·æŒä»“...\")","+equity_dict = Config.EQUITY_ACCOUNTS","+","+"," def get_equity_data(equity_dict):","-    # æƒç›Šä¸“æˆ·","-    Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()","-    concat_equity_series = []  # åˆå¹¶çš„æƒç›Šä¸“æˆ·æŒä»“é‡‘é¢","+    \"\"\"è·å–æƒç›Šä¸“æˆ·æŒä»“æ•°æ®\"\"\"","+    concat_equity_series = []","     equity_list = []","-    ","-    # æ‰‹å·¥å¢åŠ æƒç›Šä¸“æˆ·çš„é…ç½®æƒ…å†µ","     for shortname in equity_dict.keys():","         concat_equity_series.append(pd.Series(","-            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == equity_dict[shortname]].groupby('äº§å“ä»£ç ')[","-                'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name=shortname + '-é‡‘é¢'))","+            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == equity_dict[shortname]].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,","+            name=shortname + '-é‡‘é¢'","+        ))","         equity_list += [shortname]","-    ","-    # åˆå¹¶æ•°æ®","     concat_equity_df = pd.concat(concat_equity_series, axis=1)","     concat_equity_df = concat_equity_df.merge(","-        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True,","-        how='left')","-    ","-    # è®¡ç®—å æ¯”","+        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],","+        left_index=True, right_index=True, how='left'","+    )","     concat_equity_pct_df = concat_equity_df[[x + '-é‡‘é¢' for x in equity_list]].div(","-        concat_equity_df['å‡€èµ„äº§(äº¿)'], axis=0)","+        concat_equity_df['å‡€èµ„äº§(äº¿)'], axis=0","+    )","     concat_equity_pct_df.columns = [x + '-å æ¯”' for x in equity_list]","-    ","-    # åˆå¹¶ç»“æœ","-    result_df = pd.concat(","-        [concat_equity_df[[x + '-é‡‘é¢' for x in equity_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","-         concat_equity_pct_df], axis=1)","+    result_df = pd.concat([","+        concat_equity_df[[x + '-é‡‘é¢' for x in equity_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],","+        concat_equity_pct_df","+    ], axis=1)","     return result_df","-# ç”Ÿæˆé»„é‡‘æŒä»“æ•°æ®","-hg_asset = get_zhdata(gold_dict, gold_ETF_bond_list)","-hg_asset[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-é‡‘é¢', 'é»„é‡‘ETF-é‡‘é¢', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-å æ¯”',","-          'é»„é‡‘ETF-å æ¯”']].to_excel(writer, sheet_name='é»„é‡‘æŒä»“')"," ","-# ç”Ÿæˆæƒç›Šä¸“æˆ·æŒä»“æ•°æ®","+"," equity_asset = get_equity_data(equity_dict)"," output_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»'] + \\","-             [x + suffix for x in equity_dict.keys() for suffix in ['-é‡‘é¢', '-å æ¯”']]","+              [x + suffix for x in equity_dict.keys() for suffix in ['-é‡‘é¢', '-å æ¯”']]"," equity_asset[output_cols].to_excel(writer, sheet_name='æƒç›Šä¸“æˆ·æŒä»“')"," ","-# ç”Ÿæˆå…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ","-# è¯»å–å…¬å…±ç­–ç•¥æ•°æ®","-ggcc = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å…¬å¸å…¬å…±ç­–ç•¥ä¸“æˆ·')","-wwgl = pd.read_excel(Config.get_weekly_data_file('å§”å¤–äº§å“æ¦‚è§ˆ(å›¢é˜Ÿè§†è§’)'))[['å§”å¤–èµ„äº§','æœ€æ–°è§„æ¨¡']]","-","-# è®¡ç®—æŒä»“æ±‡æ€»","-chicangsum = Chicang_df.groupby('å€ºåˆ¸ç®€ç§°')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum()/100000000","-","-# åˆå¹¶æ•°æ®","+# å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ","+print(\"[11.9] ç”ŸæˆæŠ¥è¡¨: å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ...\")","+ggcc = data_loader.load_public_strategy()","+wwgl = data_loader.load_weiwai_overview()","+chicangsum = Chicang_df.groupby('å€ºåˆ¸ç®€ç§°')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000"," ggcc = pd.merge(ggcc, wwgl, left_on='èµ„äº§åç§°', right_on='å§”å¤–èµ„äº§', how='left')"," ggcc = pd.merge(ggcc, chicangsum, left_on='èµ„äº§åç§°', right_index=True, how='left')","+ggcc = ggcc.rename(columns={'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼': 'å¤šèµ„äº§æŠ•æŒä»“-äº¿', \"æœ€æ–°è§„æ¨¡\": 'ä¸“æˆ·è§„æ¨¡'})","+ggcc['å¤šèµ„äº§æŒä»“å æ¯”'] = ggcc['å¤šèµ„äº§æŠ•æŒä»“-äº¿'] / ggcc['ä¸“æˆ·è§„æ¨¡']","+ggcc[['æ‰€å±éƒ¨é—¨', 'ç­–ç•¥æ ‡ç­¾', 'èµ„äº§ä»£ç ', 'èµ„äº§åç§°', 'èµ„äº§ç®€ç§°', 'ä¸“æˆ·è§„æ¨¡',","+      'å¤šèµ„äº§æŠ•æŒä»“-äº¿', 'å¤šèµ„äº§æŒä»“å æ¯”']].to_excel(writer, sheet_name='å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ')"," ","-# é‡å‘½ååˆ—å¹¶è®¡ç®—å æ¯”","-ggcc = ggcc.rename(columns={'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼':'å¤šèµ„äº§æŠ•æŒä»“-äº¿', \"æœ€æ–°è§„æ¨¡\":'ä¸“æˆ·è§„æ¨¡'})","-ggcc['å¤šèµ„äº§æŒä»“å æ¯”'] = ggcc['å¤šèµ„äº§æŠ•æŒä»“-äº¿']/ggcc['ä¸“æˆ·è§„æ¨¡']"," ","-# è¾“å‡ºç»“æœ","-ggcc[['æ‰€å±éƒ¨é—¨', 'ç­–ç•¥æ ‡ç­¾', 'èµ„äº§ä»£ç ', 'èµ„äº§åç§°', 'èµ„äº§ç®€ç§°', 'ä¸“æˆ·è§„æ¨¡', ","-      'å¤šèµ„äº§æŠ•æŒä»“-äº¿', 'å¤šèµ„äº§æŒä»“å æ¯”']].to_excel(writer, sheet_name='å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ')","+# ==============================================================================","+# ç¬¬åä¸ƒéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å‡€å€¼æ³¢åŠ¨ä¸ç ´å‡€","+# =============================================================================="," ","-          ","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨12: å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•","+# ------------------------------------------------------------------------------","+print(\"\\n[12] ç”ŸæˆæŠ¥è¡¨: 12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•...\")","+"," date = zhoubao_date","-yunzuogailan_now = del_Innovation_department(pd.read_excel(","-    Config.get_overview_parent_file(date), index_col=0))","-part_nav_df = data_transposition.loc[:, yunzuogailan_now.index].tail(7 + 1)  # å‘¨å‡€å€¼å˜åŒ–","-# å‘¨å†…æ—¥å‡€å€¼å˜åŒ–å¹³å‡","-rweek = pd.DataFrame((part_nav_df.tail(1).values / part_nav_df.head(1).values - 1) * 10000, columns=part_nav_df.columns,","-                     index=['å‘¨å‡€å€¼å˜åŒ–bp']).T","+yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(date), index_col=0))","+part_nav_df = data_transposition.loc[:, yunzuogailan_now.index].tail(7 + 1)","+rweek = pd.DataFrame(","+    (part_nav_df.tail(1).values / part_nav_df.head(1).values - 1) * 10000,","+    columns=part_nav_df.columns, index=['å‘¨å‡€å€¼å˜åŒ–bp']","+).T"," rweek_average = ((part_nav_df / part_nav_df.shift(1) - 1) * 10000).mean(axis=0)"," nav_change_df = pd.concat([rweek, rweek_average], axis=1)"," nav_change_df.columns = ['å‘¨å‡€å€¼å˜åŒ–bp', 'å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']"," nav_change_df_keep = nav_change_df[","-    (abs(nav_change_df['å‘¨å‡€å€¼å˜åŒ–bp']) >= 20) | (abs(nav_change_df['å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']) >= 3)]  # ç­›é€‰æ ‡å‡†","-# nav_change_df.iplot()","+    (abs(nav_change_df['å‘¨å‡€å€¼å˜åŒ–bp']) >= 20) | (abs(nav_change_df['å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']) >= 3)","+]"," ","-"," result_df_12 = nav_change_df_keep.merge(","-    yunzuogailan_now[['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†', 'ç»„åˆä¹…æœŸ',","-                      'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥',","-                      'åˆ°æœŸæ—¥']], left_index=True, right_index=True, how='left')","-result_df_12.sort_values('å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp', ascending=True, inplace=True)  # åº•è¡¨æŒ‰ç…§å‡€å€¼æ³¢åŠ¨","+    yunzuogailan_now[['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',","+                      'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©',","+                      'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']],","+    left_index=True, right_index=True, how='left'","+)","+result_df_12.sort_values('å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp', ascending=True, inplace=True)"," result_df_12.to_excel(writer, sheet_name='12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•')","-# result_df_12.to_excel('test.xlsx',sheet_name='12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•')"," ","-now = zhoubao_date","-# lastm='20250228'","-# lasty='20241231'"," ","-# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°","+# ==============================================================================","+# ç¬¬åå…«éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å‘¨æœŸåˆ†å¸ƒ","+# ==============================================================================","+","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨13: ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡","+# ------------------------------------------------------------------------------","+print(\"\\n[13] ç”ŸæˆæŠ¥è¡¨: 13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡...\")","+","+now = zhoubao_date"," yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))"," yunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))"," yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))"," "," ","-def get_zhouqi_scale(x):","-    if x < 30 * 7:","-        return '<6M'","-    elif (x >= 30 * 7) and (x < 13 * 30):","-        return '6M-1Y'","-    elif x >= 13 * 30:","-        return '>1Y'","-    else:","-        return 'error'","-","-"," def get_zhouqi_scale_df(df_f, name: str):","     mid_df = df_f.copy()","     mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)","-    result_df = pd.concat([mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].sum(),","-                           mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].count()], axis=1)","+    result_df = pd.concat([","+        mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].sum(),","+        mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].count()","+    ], axis=1)","     result_df.columns = [name + x for x in ['è§„æ¨¡(äº¿)', 'æ•°é‡']]","     return result_df"," "," ","-final_df = pd.concat([get_zhouqi_scale_df(yunzuogailan_lasty, '2024'), get_zhouqi_scale_df(yunzuogailan_now, 'æœ€æ–°')],","-                     axis=1)","+final_df = pd.concat([get_zhouqi_scale_df(yunzuogailan_lasty, '2024'), get_zhouqi_scale_df(yunzuogailan_now, 'æœ€æ–°')], axis=1)"," final_df['vlookupæ ‡ç­¾'] = [''.join(list(x)) for x in final_df.index]"," keep_columns = ['vlookupæ ‡ç­¾'] + list(final_df.columns[:-1])","-","-# final_df[keep_columns].to_excel('test3.xlsx',sheet_name='13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡')"," final_df[keep_columns].to_excel(writer, sheet_name='13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡')"," ","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨14: ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª","+# ------------------------------------------------------------------------------","+print(\"\\n[14] ç”ŸæˆæŠ¥è¡¨: 14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª...\")","+"," now = zhoubao_date"," month7 = '20240731'"," lasty = '20241231'"," ","-# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°"," yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))"," yunzuogailan_month7 = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(month7), index_col=0))"," yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))"," ","-yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))","-yunzuogailan_month7 = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(month7), index_col=0))","-yunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))"," ","-"," def match_kehuzhouqi_narrowed(x: str):","     if x == 'å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“':","         return 'å®¢æˆ·å‘¨æœŸ'"]},{"oldStart":1547,"oldLines":29,"newStart":1521,"newLines":39,"lines":[" "," "," def get_kehuzhouqi_narrowed_scale(my_df, col_str: str):","-    # col_str='2023å¹´åº•'","     mid_df = my_df[my_df['äº§å“æ¨¡æ¿ä¸­æ–‡åç§°'].map(lambda x: x in ['å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“', 'å®¢æˆ·é”å®šæœŸ'])]","     mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)","-    result_df = pd.pivot_table(mid_df, index=['å‘¨æœŸåŒºé—´'], columns='äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', values=['å‡€èµ„äº§(äº¿)'],","-                               aggfunc=np.sum)  # ä¸€ç»´å˜äºŒç»´","+    result_df = pd.pivot_table(mid_df, index=['å‘¨æœŸåŒºé—´'], columns='äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)","     result_df.columns = [col_str + match_kehuzhouqi_narrowed(x[1]) for x in list(result_df.columns)]","     return result_df"," "," ","-result_df_14 = pd.concat([get_kehuzhouqi_narrowed_scale(yunzuogailan_lasty, '2024å¹´åº•'),","-                          get_kehuzhouqi_narrowed_scale(yunzuogailan_month7, '2024å¹´7æœˆ'),","-                          get_kehuzhouqi_narrowed_scale(yunzuogailan_now, 'æœ€æ–°')], axis=1)","-# result_df_14.to_excel('test.xlsx',sheet_name='14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª')","+result_df_14 = pd.concat([","+    get_kehuzhouqi_narrowed_scale(yunzuogailan_lasty, '2024å¹´åº•'),","+    get_kehuzhouqi_narrowed_scale(yunzuogailan_month7, '2024å¹´7æœˆ'),","+    get_kehuzhouqi_narrowed_scale(yunzuogailan_now, 'æœ€æ–°')","+], axis=1)"," result_df_14.to_excel(writer, sheet_name='14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª')","-wind_code_list = Config.MARKET_INDEX_CODES  # å¸‚åœºæŒ‡æ•°ä»£ç ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰","+","+","+# ==============================================================================","+# ç¬¬åä¹éƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - å¸‚åœºæŒ‡æ•°æ”¶ç›Š","+# ==============================================================================","+","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨15: å¸‚åœºæŒ‡æ•°æ”¶ç›Š","+# ------------------------------------------------------------------------------","+print(\"\\n[15] ç”ŸæˆæŠ¥è¡¨: 15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š...\")","+","+wind_code_list = Config.MARKET_INDEX_CODES"," result_list = []","+"," for deltadays in [30, 30 * 3, 30 * 6, 365]:","-    startDate = ''.join(","-        str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=deltadays)).date()).split(","-            '-'))","+    startDate = ''.join(str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=deltadays)).date()).split('-'))","     returns = market_data.get_index_returns(wind_code_list, startDate, zhoubao_date)","     result_list.append(np.array(returns) * 365 / deltadays)","-# è®¡ç®—2026å¹´å¹´åŒ–æ”¶ç›Šï¼ˆæ¯å¹´éœ€æ›´æ–°å¹´æœ«æ—¥æœŸï¼‰","+","+# è®¡ç®—ä»Šå¹´ä»¥æ¥å¹´åŒ–æ”¶ç›Š"," deltadays = (datetime.strptime(zhoubao_date, '%Y%m%d') - datetime.strptime('20251231', '%Y%m%d')).days"," returns = market_data.get_index_returns(wind_code_list, '20251231', zhoubao_date)"," result_list.append(np.array(returns) * 365 / deltadays)"]},{"oldStart":1586,"oldLines":19,"newStart":1570,"newLines":31,"lines":[" result_list.append(np.array(market_data.get_index_names(wind_code_list)))"," result_df = pd.DataFrame(result_list).T"," result_df.index = wind_code_list","-result_df.columns = ['è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', '2026å¹´å¹´åŒ–æ”¶ç›Šç‡',","-                     'è¿‘1æœˆæ³¢åŠ¨ç‡', 'ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡', 'æŒ‡æ•°ç®€ç§°']","-# result_df.to_excel('test.xlsx',sheet_name='15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š')","+result_df.columns = [","+    'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', '2026å¹´å¹´åŒ–æ”¶ç›Šç‡',","+    'è¿‘1æœˆæ³¢åŠ¨ç‡', 'ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡', 'æŒ‡æ•°ç®€ç§°'","+]"," result_df.to_excel(writer, sheet_name='15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š')"," ","+","+# ==============================================================================","+# ç¬¬äºŒåéƒ¨åˆ†ï¼šç”ŸæˆæŠ¥è¡¨ - ç ´å‡€ç»“æœ","+# ==============================================================================","+","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: ç ´å‡€ç»“æœ","+# ------------------------------------------------------------------------------","+print(\"\\n[16] ç”ŸæˆæŠ¥è¡¨: ç ´å‡€ç»“æœ...\")","+"," nav_date = yunzuogailan_date","-yunzuogailan_now = del_Innovation_department(","-    pd.read_excel(Config.get_overview_parent_file(yunzuogailan_date), index_col=0))","+yunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(yunzuogailan_date), index_col=0))"," yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] = [data_transposition.loc[nav_date, x] for x in yunzuogailan_now.index]","-yunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] = [data_transposition.loc[pd.to_datetime(nav_date) - timedelta(7), x] for x in","-                                     yunzuogailan_now.index]","+yunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] = [","+    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(7), x] for x in yunzuogailan_now.index","+]"," yunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] = [","-    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(int(nav_date[-2:])), x] for x in yunzuogailan_now.index]","+    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(int(nav_date[-2:])), x] for x in yunzuogailan_now.index","+]"," pojing_df = yunzuogailan_now[yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] < 1].copy()"," "," pojing_df['è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] - 1"]},{"oldStart":1607,"oldLines":28,"newStart":1603,"newLines":33,"lines":[" pojing_df['äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰'] = pojing_df['å‡€èµ„äº§(äº¿)'] / pojing_df['å•ä½å‡€å€¼']"," pojing_df = pojing_df.reset_index()"," pojing_df_final = pojing_df[","-    ['æ£€æµ‹æ—¶ç‚¹', 'äº§å“ç®€ç§°', 'äº§å“ä»£ç ', 'äº§å“ç»ç†', 'äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰', 'åˆ°æœŸæ—¥', 'ç´¯ç§¯å‡€å€¼', 'è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–',","-     'è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–']]","+    ['æ£€æµ‹æ—¶ç‚¹', 'äº§å“ç®€ç§°', 'äº§å“ä»£ç ', 'äº§å“ç»ç†', 'äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰', 'åˆ°æœŸæ—¥', 'ç´¯ç§¯å‡€å€¼', 'è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–', 'è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–']","+]"," quant = ['ç‹æµ©', 'å¼ é›…å©•', 'å­™æ–°å']"," "," ","-def manager_in_or_not(s: str, y: list):","+def manager_in_or_not_count(s: str, y: list):","     sum_here = 0","     for mid_y in y:","         if mid_y in s:","             sum_here += 1","-    if sum_here > 0:","-        return 1","-    else:","-        return 0","+    return 1 if sum_here > 0 else 0"," "," ","-pojing_df_final = pojing_df_final[pojing_df_final['äº§å“ç»ç†'].map(lambda x: manager_in_or_not(x, quant)) == 0]","+pojing_df_final = pojing_df_final[pojing_df_final['äº§å“ç»ç†'].map(lambda x: manager_in_or_not_count(x, quant)) == 0]"," pojing_df_final.to_excel(writer, sheet_name='ç ´å‡€ç»“æœ')"," "," ","+# ==============================================================================","+# ç¬¬äºŒåä¸€éƒ¨åˆ†ï¼šç”Ÿæˆæ€»ç»“æ–‡å­—","+# =============================================================================="," ","-# ä½¿ç”¨configä¸­çš„promptæ¨¡æ¿ç”Ÿæˆæ€»ç»“æ–‡å­—ï¼ˆæ¨¡æ¿åœ¨config.pyä¸­é…ç½®ï¼Œæ–¹ä¾¿è°ƒæ•´ï¼‰","+# ------------------------------------------------------------------------------","+# æŠ¥è¡¨: æ€»ç»“æ–‡å­—ï¼ˆAIç”Ÿæˆï¼‰","+# ------------------------------------------------------------------------------","+print(\"\\n[17] ç”ŸæˆæŠ¥è¡¨: æ€»ç»“æ–‡å­—ï¼ˆAIç”Ÿæˆï¼‰...\")","+","+# ä½¿ç”¨configä¸­çš„promptæ¨¡æ¿ç”Ÿæˆæ€»ç»“æ–‡å­—"," prompt_zs = Config.PROMPT_ZHONGSHOU.format(","     date=yunzuogailan_date,","     data=round(result_9.sum(axis=0), 2)"]},{"oldStart":1648,"oldLines":9,"newStart":1649,"newLines":19,"lines":[" "," guimo_summary = get_wenzi_result(prompt_gm)"," zhongshou_summary = get_wenzi_result(prompt_zs)","-chan","-wenzi = {'åˆ°æœŸæ–‡å­—':daoqi_summary,'ä¸­æ”¶æ–‡å­—':zhongshou_summary,'è§„æ¨¡æ–‡å­—':guimo_summary}","-wenzidf = pd.DataFrame([wenzi]).T.rename(columns={0:'æ–‡å­—'})","+","+wenzi = {'åˆ°æœŸæ–‡å­—': daoqi_summary, 'ä¸­æ”¶æ–‡å­—': zhongshou_summary, 'è§„æ¨¡æ–‡å­—': guimo_summary}","+wenzidf = pd.DataFrame([wenzi]).T.rename(columns={0: 'æ–‡å­—'})"," wenzidf.to_excel(writer, sheet_name='æ€»ç»“æ–‡å­—')"," ","+","+# ==============================================================================","+# ç¬¬äºŒåäºŒéƒ¨åˆ†ï¼šä¿å­˜å¹¶å…³é—­","+# ==============================================================================","+"," writer.close()","+","+print(\"\\n\" + \"=\" * 60)","+print(\"âœ… å‘¨æŠ¥ç»“æœè¡¨ç”Ÿæˆå®Œæˆï¼\")","+print(f\"   è¾“å‡ºæ–‡ä»¶: {Config.get_current_output_writer(date)}\")","+print(\"=\" * 60)"]}],"originalFile":"# å¯¼å…¥åŒ…\nimport os\nimport pandas as pd\nimport numpy as np\nfrom datetime import datetime, timedelta, date\nimport copy\nfrom utils import *\nimport warnings\nwarnings.filterwarnings(\"ignore\")\n# å¯¼å…¥ç»Ÿä¸€é…ç½®æ–‡ä»¶ - ä¿æŒæ‰€æœ‰è®¡ç®—é€»è¾‘ä¸å˜\nfrom config import *\n# å¯¼å…¥æ•°æ®éªŒè¯æ¨¡å— - ç¡®ä¿æŠ•èµ„æ•°æ®å‡†ç¡®æ€§\nfrom data_validator import DataValidator, safe_read_excel, validate_critical_paths\nfrom openai import OpenAI\n# å¯¼å…¥å¸‚åœºæ•°æ®æä¾›è€…æ¨¡å—ï¼ˆå°è£…Windè°ƒç”¨ï¼‰\nfrom market_data_provider import MarketDataProvider\nimport glob\n\n# åˆå§‹åŒ–å¸‚åœºæ•°æ®æä¾›è€…ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰\nmarket_data = MarketDataProvider.get_instance()\n\ndef get_wenzi_result(prompt):\n    client = OpenAI(api_key=Config.DEEPSEEK_API_KEY, base_url=Config.DEEPSEEK_BASE_URL)\n    response = client.chat.completions.create(\n        model=Config.DEEPSEEK_MODEL,\n        messages=[\n            {\"role\": \"system\", \"content\": \"You are a helpful assistant\"},\n            {\"role\": \"user\", \"content\": prompt},\n        ],\n        stream=False\n    )\n    return response.choices[0].message.content\n\n# åˆå§‹åŒ–æ•°æ®éªŒè¯å™¨\nvalidator = DataValidator(log_errors=True)\n\n# éªŒè¯å…³é”®è·¯å¾„\nprint(\"ğŸ” å¼€å§‹éªŒè¯å…³é”®æ•°æ®è·¯å¾„...\")\npath_validation = validate_critical_paths(Config)\nif not path_validation['is_valid']:\n    print(\"âŒ å…³é”®è·¯å¾„éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®ç›®å½•ç»“æ„\")\n    for error in path_validation['errors']:\n        print(f\"   - {error}\")\n\n## todo  å‘¨æŠ¥æ–‡å­—éƒ¨åˆ†è‡ªåŠ¨æ›´æ–°äº§å“è®¡åˆ’åŠä¸Šä¸ªæœˆçš„è§„æ¨¡æƒ…å†µ\n\n\n# æ³¨æ„ï¼šä»¥ä¸‹å˜é‡å·²åœ¨config.pyä¸­ç»Ÿä¸€é…ç½®ï¼Œæ­¤å¤„ä¿ç•™æ˜¯ä¸ºäº†å‘åå…¼å®¹\n# æ‰€æœ‰è®¡ç®—é€»è¾‘å’Œæ•°æ®å¤„ç†ä¿æŒå®Œå…¨ä¸å˜\n# Underlying_data_folder_path, yunzuogailan_date, zhoubao_date ç­‰å˜é‡\n# ç°åœ¨éƒ½ä»config.pyè‡ªåŠ¨åŠ è½½ï¼Œç¡®ä¿æ•°æ®è®¡ç®—ç»“æœå®Œå…¨ä¸€è‡´\n\n\ndef get_product_data(COOKED_FOLDER, force_rebuild=False):\n    \"\"\"\n    è¯»å–äº§å“å‡€å€¼æ•°æ®ï¼Œä½¿ç”¨ç¼“å­˜æœºåˆ¶å¤§å¹…æå‡æ€§èƒ½\n\n    ç¼“å­˜ç­–ç•¥ï¼š\n    1. é¦–æ¬¡è¿è¡Œï¼šè¯»å–æ‰€æœ‰Excelæ–‡ä»¶ï¼Œä¿å­˜ä¸ºparquetç¼“å­˜\n    2. åç»­è¿è¡Œï¼šåªè¯»å–æ–°å¢/ä¿®æ”¹çš„æ–‡ä»¶ï¼Œä¸ç¼“å­˜åˆå¹¶\n    3. ç›¸åŒæ—¥æœŸ+äº§å“ä»£ç çš„æ•°æ®ï¼Œä¿ç•™æœ€æ–°æ–‡ä»¶çš„å€¼\n\n    å‚æ•°ï¼š\n        COOKED_FOLDER: å‡€å€¼æ•°æ®æ–‡ä»¶å¤¹è·¯å¾„\n        force_rebuild: æ˜¯å¦å¼ºåˆ¶é‡å»ºç¼“å­˜ï¼ˆé»˜è®¤Falseï¼‰\n    \"\"\"\n    import pickle\n    import time\n\n    # ç¼“å­˜ç›®å½•å’Œæ–‡ä»¶\n    cache_dir = os.path.join(os.path.dirname(COOKED_FOLDER), '.nav_cache')\n    cache_data_file = os.path.join(cache_dir, 'nav_master_data.parquet')\n    cache_meta_file = os.path.join(cache_dir, 'nav_metadata.pkl')\n\n    # ç¡®ä¿ç¼“å­˜ç›®å½•å­˜åœ¨\n    os.makedirs(cache_dir, exist_ok=True)\n\n    # è·å–æ‰€æœ‰Excelæ–‡ä»¶åŠå…¶ä¿®æ”¹æ—¶é—´\n    excel_files = glob.glob(os.path.join(COOKED_FOLDER, '*.xlsx'))\n    excel_files = [f for f in excel_files if not os.path.basename(f).startswith('~$')]  # æ’é™¤ä¸´æ—¶æ–‡ä»¶\n\n    current_files_info = {}\n    for f in excel_files:\n        mtime = os.path.getmtime(f)\n        current_files_info[f] = mtime\n\n    print(f\"ğŸ“‚ å‡€å€¼æ•°æ®æ–‡ä»¶å¤¹: {COOKED_FOLDER}\")\n    print(f\"ğŸ“Š å‘ç° {len(excel_files)} ä¸ªExcelæ–‡ä»¶\")\n\n    # åŠ è½½ç¼“å­˜å…ƒæ•°æ®\n    cached_files_info = {}\n    cached_data = None\n\n    if not force_rebuild and os.path.exists(cache_meta_file) and os.path.exists(cache_data_file):\n        try:\n            with open(cache_meta_file, 'rb') as f:\n                cached_files_info = pickle.load(f)\n            cached_data = pd.read_parquet(cache_data_file)\n            print(f\"âœ… å·²åŠ è½½ç¼“å­˜æ•°æ®: {len(cached_data)} æ¡è®°å½•\")\n        except Exception as e:\n            print(f\"âš ï¸ ç¼“å­˜åŠ è½½å¤±è´¥ï¼Œå°†é‡å»ºç¼“å­˜: {e}\")\n            cached_files_info = {}\n            cached_data = None\n\n    # æ‰¾å‡ºéœ€è¦è¯»å–çš„æ–‡ä»¶ï¼ˆæ–°å¢æˆ–ä¿®æ”¹çš„ï¼‰\n    files_to_read = []\n    for f, mtime in current_files_info.items():\n        if f not in cached_files_info or cached_files_info[f] != mtime:\n            files_to_read.append(f)\n\n    needed_cols = ['ä¼°å€¼æ—¥', 'äº§å“ä»£ç ', 'ç´¯è®¡å‡€å€¼']\n\n    if len(files_to_read) == 0 and cached_data is not None:\n        print(f\"âœ… æ‰€æœ‰æ–‡ä»¶å‡å·²ç¼“å­˜ï¼Œæ— éœ€é‡æ–°è¯»å–\")\n        data = cached_data\n    else:\n        print(f\"ğŸ“– éœ€è¦è¯»å– {len(files_to_read)} ä¸ªæ–‡ä»¶ï¼ˆæ–°å¢æˆ–å·²ä¿®æ”¹ï¼‰\")\n\n        # è¯»å–æ–°æ–‡ä»¶\n        start_time = time.time()\n        new_dfs = []\n\n        for i, f in enumerate(files_to_read, 1):\n            if i % 10 == 0 or i == len(files_to_read):\n                print(f\"   è¯»å–è¿›åº¦: {i}/{len(files_to_read)} - {os.path.basename(f)}\")\n            try:\n                df = pd.read_excel(f, usecols=needed_cols)\n                df['_source_file'] = f  # è®°å½•æ¥æºæ–‡ä»¶ç”¨äºè¿½è¸ª\n                new_dfs.append(df)\n            except Exception as e:\n                print(f\"   âš ï¸ è¯»å–å¤±è´¥: {os.path.basename(f)} - {e}\")\n\n        read_time = time.time() - start_time\n        print(f\"   è¯»å–è€—æ—¶: {read_time:.1f} ç§’\")\n\n        # åˆå¹¶æ–°æ•°æ®ä¸ç¼“å­˜æ•°æ®\n        if new_dfs:\n            new_data = pd.concat(new_dfs, ignore_index=True)\n\n            if cached_data is not None and len(files_to_read) < len(excel_files):\n                # å¢é‡æ›´æ–°ï¼šåˆå¹¶æ–°æ—§æ•°æ®\n                # å¯¹äºä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼Œéœ€è¦å…ˆåˆ é™¤æ—§æ•°æ®\n                modified_files = [f for f in files_to_read if f in cached_files_info]\n                if modified_files and '_source_file' in cached_data.columns:\n                    cached_data = cached_data[~cached_data['_source_file'].isin(modified_files)]\n\n                data = pd.concat([cached_data, new_data], ignore_index=True)\n                print(f\"   å¢é‡åˆå¹¶å®Œæˆ: ç¼“å­˜ {len(cached_data)} + æ–°å¢ {len(new_data)} æ¡\")\n            else:\n                data = new_data\n        else:\n            data = cached_data if cached_data is not None else pd.DataFrame(columns=needed_cols)\n\n    # å»é‡ï¼šç›¸åŒæ—¥æœŸ+äº§å“ä»£ç ä¿ç•™æœ€åå‡ºç°çš„ï¼ˆå³æœ€æ–°æ–‡ä»¶çš„æ•°æ®ï¼‰\n    before_dedup = len(data)\n    data.drop_duplicates(subset=['ä¼°å€¼æ—¥', 'äº§å“ä»£ç '], keep='last', inplace=True)\n    print(f\"   å»é‡: {before_dedup} -> {len(data)} æ¡è®°å½•\")\n\n    # ä¿å­˜æ›´æ–°åçš„ç¼“å­˜\n    if len(files_to_read) > 0 or not os.path.exists(cache_data_file):\n        try:\n            # ç¡®ä¿äº§å“ä»£ç ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼Œé¿å…parquetä¿å­˜å¤±è´¥ï¼ˆæ··åˆint/strç±»å‹ä¼šæŠ¥é”™ï¼‰\n            if 'äº§å“ä»£ç ' in data.columns:\n                data['äº§å“ä»£ç '] = data['äº§å“ä»£ç '].astype(str)\n            data.to_parquet(cache_data_file, index=False)\n            with open(cache_meta_file, 'wb') as f:\n                pickle.dump(current_files_info, f)\n            print(f\"ğŸ’¾ ç¼“å­˜å·²æ›´æ–°: {cache_data_file}\")\n        except Exception as e:\n            print(f\"âš ï¸ ç¼“å­˜ä¿å­˜å¤±è´¥: {e}\")\n\n    # æ„å»ºé€è§†è¡¨\n    print(f\"ğŸ”„ æ„å»ºæ•°æ®é€è§†è¡¨...\")\n\n    # ç§»é™¤è¾…åŠ©åˆ—å†åšé€è§†\n    pivot_data = data[['ä¼°å€¼æ—¥', 'äº§å“ä»£ç ', 'ç´¯è®¡å‡€å€¼']].copy()\n\n    data_transposition = pd.pivot_table(\n        pivot_data,\n        index='ä¼°å€¼æ—¥',\n        columns='äº§å“ä»£ç ',\n        values='ç´¯è®¡å‡€å€¼',\n        aggfunc='median'\n    )\n\n    # ä¼˜åŒ–æ—¥æœŸè½¬æ¢ - æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼\n    try:\n        data_transposition.index = pd.to_datetime(data_transposition.index, format='%Y/%m/%d')\n    except:\n        data_transposition.index = pd.to_datetime(data_transposition.index, errors='coerce')\n\n    data_transposition = data_transposition.sort_index()\n    data_transposition.columns = data_transposition.columns.astype(str)\n\n    print(f\"âœ… æ•°æ®åŠ è½½å®Œæˆ: {len(data_transposition)} ä¸ªäº¤æ˜“æ—¥, {len(data_transposition.columns)} ä¸ªäº§å“\")\n\n    return data, data_transposition\n\n\nprint(\"\\n\" + \"=\"*60)\nprint(\"ğŸ“Š å¼€å§‹åŠ è½½äº§å“å‡€å€¼æ•°æ®...\")\nprint(\"=\"*60)\ndata, data_transposition = get_product_data(COOKED_FOLDER)\nprint(\"=\"*60 + \"\\n\")\n\n# DAPäº§å“ä¿¡æ¯è¡¨\nProduct_information_df_DAP = pd.read_excel(Config.get_weekly_data_file('ç†è´¢äº§å“ä¿¡æ¯æŸ¥è¯¢'), index_col=0)\n\n\n# åˆ¤æ–­äº§å“å½¢æ€\ndef map_product_xingtai(series_here):\n    if series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å°é—­å¼':\n        return 'å°é—­'\n    elif (series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å¼€æ”¾å¼') and (series_here['å‘¨æœŸå±æ€§'] == 'å®¢æˆ·å‘¨æœŸ'):\n        return 'å®¢æˆ·å‘¨æœŸ'\n    elif (series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å¼€æ”¾å¼') and (series_here['å‘¨æœŸå±æ€§'] == 'äº§å“å‘¨æœŸ') and (\n            series_here['å‘¨æœŸå¤©æ•°'] == 1):\n        return 'æ—¥å¼€'\n    elif (series_here['äº§å“å¼€æ”¾å½¢å¼'] == 'å¼€æ”¾å¼') and (series_here['å‘¨æœŸå±æ€§'] == 'äº§å“å‘¨æœŸ'):\n        return 'å®šå¼€'\n\n\n# è·å–æ‹›å•†æ ‡ç­¾\ndef get_zhaoshang_label(set_here):\n    if 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸' in set_here:\n        if len(set_here.difference({'-', 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'})) == 0:\n            return 'æ‹›å•†ç‹¬æœ‰'\n        else:\n            return 'æ‹›å•†å…±æœ‰'\n    else:\n        return 'éæ‹›å•†'\n\n\n# è·å–æ‰€æœ‰çš„æ¸ é“æ ‡ç­¾\ndef get_qudao_label_detail(set_here):\n    # æ¸ é“ç®€ç§°åŒ¹é…ï¼ˆä»config.pyè¯»å–é…ç½®ï¼‰\n    qudao_forshort_dict = Config.CHANNEL_SHORT_NAMES\n    qudao_rank_dict = dict(enumerate(qudao_forshort_dict.keys()))\n    qudao_rank_dict = dict([val, key] for key, val in qudao_rank_dict.items())\n    if \"-\" in set_here:\n        set_here.remove(\"-\")\n    to_sort_list = list((x, qudao_rank_dict[x]) for x in set_here)  # æŒ‰ç…§ç”±ä¸»åˆ°æ¬¡å¯¹æ¸ é“å±•ç¤ºé¡ºåºæ’åº\n    to_sort_list.sort(key=lambda y: y[1])\n    return \",\".join([qudao_forshort_dict[x[0]] for x in to_sort_list])\n\n\ndef get_yunzuogailan(yunzuogailan_date):\n    yunzuogailan_before = pd.read_excel(Config.get_weekly_data_file('äº§å“è¿ä½œæ¦‚è§ˆ'), index_col=0)\n    yunzuogailan_before.drop_duplicates(inplace=True)\n    # å¤„ç†paså¯¼å‡ºçš„ä¸šç»©åŸºå‡†ï¼Œxå·è¢«å¯¼å‡ºä¸º&times;\n    yunzuogailan_before['ä¸šç»©åŸºå‡†'] = yunzuogailan_before['ä¸šç»©åŸºå‡†'].map(\n        lambda s: s.replace(\"&times;\", \"*\") if (isinstance(s, str)) and (\"&times;\" in s) else s)\n    Baoyou_df = pd.read_excel(Config.get_weekly_data_file('å„æ¸ é“ä¿æœ‰é‡'), index_col=0)\n    # åˆ é™¤æ¸ é“ä¿æœ‰é‡ä¸­å­äº§å“çš„æ¸ é“ä¸º-çš„ è¿™ä¸ªæ˜¯æ±‡æ€»æ¡ï¼Œä¼šä½¿å¾—è§„æ¨¡è®¡ç®—å‡ºé”™\n    Baoyou_df_sub = Baoyou_df[Baoyou_df['æ¸ é“åç§°'] != '-']\n    Baoyou_df_mom = Baoyou_df[Baoyou_df.apply(lambda x: '(å­' not in x['äº§å“ç®€ç§°'], axis=1)]\n    Baoyou_df = pd.concat([Baoyou_df_mom, Baoyou_df_sub])\n    Baoyou_df.drop_duplicates(inplace=True)\n\n    # åŒ¹é…ç†è´¢äº§å“çš„å­—æ¯ä»£ç \n    yunzuogailan_before['æ¯äº§å“ä»£ç '] = yunzuogailan_before['äº§å“ç®€ç§°'].map(\n        lambda x: yunzuogailan_before[yunzuogailan_before['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0])\n    yunzuogailan_before = yunzuogailan_before[~(yunzuogailan_before['å•ä½å‡€å€¼'].isnull())]\n    # è·å–ç¾å…ƒäº§å“æ¸…å•\n    Dollar_product_list = list(\n        set(Product_information_df_DAP[Product_information_df_DAP['å¸ç§'] == 'ç¾å…ƒ'].index).intersection(\n            yunzuogailan_before.index))\n    yunzuogailan_before['å‡€èµ„äº§(äº¿)'] = yunzuogailan_before.apply(\n        lambda x: Baoyou_df.loc[x.name]['ä¿æœ‰è§„æ¨¡'].sum() / 100000000 if x.name in Dollar_product_list else x[\n            'å‡€èµ„äº§(äº¿)'], axis=1)\n    yunzuogailan_before = yunzuogailan_before.merge(Product_information_df_DAP[['å¸ç§']], left_index=True,\n                                                    right_index=True, how='left')\n\n    # åŒ¹é…å¶è€å¸ˆçš„å“ç±»\n    classification_df = pd.read_excel(\n        Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),\n        sheet_name='å¤šèµ„äº§å“ç±»æ ‡ç­¾',\n        index_col='æ¯äº§å“ä»£ç '\n    )\n    # å¤„ç†å¯èƒ½å­˜åœ¨çš„é‡å¤æ¯äº§å“ä»£ç ï¼Œé¿å…æ˜ å°„æ—¶è¿”å›Serieså¯¼è‡´åç»­mergeæŠ¥é”™\n    classification_df = classification_df[~classification_df.index.duplicated(keep='first')]\n    classification_ye = classification_df['å¤šèµ„äº§å“ç±»']\n    yunzuogailan_before['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(\n        lambda x: classification_ye[x] if x in classification_ye.index else np.nan)\n    yunzuogailan_before['äº§å“éƒ¨å“ç±»'] = yunzuogailan_before['æ¯äº§å“ä»£ç '].map(\n        lambda x: classification_df['äº§å“éƒ¨å“ç±»'][x] if x in classification_ye.index else np.nan)\n    # åŒ¹é…äº§å“è¿ä½œå‘¨æœŸ\n    patern = pd.Series(Product_information_df_DAP.apply(map_product_xingtai, axis=1), name='å½¢æ€')\n\n    ###product_code_df=pd.read_excel(Underlying_data_folder_path+'/å­æ¯äº§å“ä»£ç -æ¬¡æ›´.xlsx',index_col=0)\n    Baoyou_df_merge = Baoyou_df.merge(yunzuogailan_before['æ¯äº§å“ä»£ç '], left_index=True, right_index=True, how='left')\n    yunzuogailan_before = yunzuogailan_before.merge(patern, left_index=True, right_index=True, how='left')\n    yunzuogailan_before = yunzuogailan_before.merge(Product_information_df_DAP[['å‘¨æœŸå¤©æ•°', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°']],\n                                                    left_index=True, right_index=True, how='left')\n    # åŒ¹é…æ‹›å•†æ ‡ç­¾\n    Zhaoshang_label_df = pd.DataFrame(\n        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_zhaoshang_label(set(x['æ¸ é“åç§°']))),\n        columns=['æ˜¯å¦æ‹›å•†'])\n    yunzuogailan_before = yunzuogailan_before.merge(Zhaoshang_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True,\n                                                    how='left')\n    Qudao_label_df = pd.DataFrame(\n        Baoyou_df_merge.groupby('æ¯äº§å“ä»£ç ').apply(lambda x: get_qudao_label_detail(set(x['æ¸ é“åç§°']))),\n        columns=['æ¸ é“æ˜ç»†'])\n\n    yunzuogailan_before = yunzuogailan_before.merge(Qudao_label_df, left_on='æ¯äº§å“ä»£ç ', right_index=True, how='left')\n    # å¦‚æœæ˜¯2023å¹´12æœˆ31æ—¥çš„è¯ï¼Œæ¶‰åŠéƒ¨åˆ†æ‹†åˆ†äº§å“ç»ç†åˆ‡æ¢\n    if yunzuogailan_date in ['20231229', '20231231']:\n        yunzuogailan_before['äº§å“ç»ç†'] = yunzuogailan_before.apply(\n            lambda x: Product_information_df_DAP.loc[x.name, 'æ¯äº§å“æŠ•èµ„ç»ç†'], axis=1)\n    yunzuogailan_before.rename(columns={'ç»„åˆä¹…æœŸ(å¤šèµ„äº§)': 'ç»„åˆä¹…æœŸ'}, inplace=True)\n    yunzuogailan_before.rename(columns={'ç»„åˆé™æ€(å¤šèµ„äº§)': 'ç»„åˆé™æ€'}, inplace=True)\n    yunzuogailan_before_v2 = yunzuogailan_before.merge(Product_information_df_DAP[['æ¯å­æ ‡å¿—']], left_index=True,\n                                                       right_index=True, how='left')\n    # å¯¹äºéæ¯å­äº§å“å’Œå­1ä»½é¢ï¼Œè´´ä¸Šâ€œä¸»è¦å±•ç¤ºâ€æ ‡ç­¾ 'éæ¯å­äº§å“' 'å­äº§å“' (å­1)\n    yunzuogailan_before_v2['ä¸»è¦å±•ç¤º'] = yunzuogailan_before_v2.apply(\n        lambda x: 'æ˜¯' if ((x['æ¯å­æ ‡å¿—'] == 'éæ¯å­äº§å“') or ('(å­1)' in x['äº§å“ç®€ç§°'])) else 'å¦', axis=1)\n    Parent_sort = pd.read_excel(\n        Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),\n        sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»',\n        index_col=0\n    )[['æ¯åˆ†ç±»']]\n    # å»é‡ï¼Œç¡®ä¿ç´¢å¼•ï¼ˆå¤šèµ„äº§å“ç±»ï¼‰å”¯ä¸€\n    Parent_sort = Parent_sort[~Parent_sort.index.duplicated(keep='first')]\n    # é˜²å¾¡æ€§å¤„ç†ï¼šç¡®ä¿ç”¨äºåˆå¹¶çš„é”®åˆ—ä¸ºæ ‡é‡ï¼Œé¿å…å‡ºç° Series/åˆ—è¡¨ å¯¼è‡´ merge æŠ¥é”™\n    if yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(lambda x: isinstance(x, pd.Series)).any():\n        print(\"âš ï¸ æ£€æµ‹åˆ° 'å¤šèµ„äº§å“ç±»' åˆ—ä¸­å­˜åœ¨ Series å€¼ï¼Œå·²è‡ªåŠ¨å–ç¬¬ä¸€ä¸ªéç©ºå…ƒç´ ä»¥ç¡®ä¿åˆå¹¶æ­£å¸¸è¿›è¡Œã€‚\")\n        yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'] = yunzuogailan_before_v2['å¤šèµ„äº§å“ç±»'].apply(\n            lambda s: s.dropna().iloc[0] if isinstance(s, pd.Series) and len(s.dropna()) > 0 else (np.nan if isinstance(s, pd.Series) else s)\n        )\n    yunzuogailan_before_v2 = yunzuogailan_before_v2.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True,\n                                                          how='left')\n\n    # è¾“å‡ºåªä¿ç•™æ¯äº§å“ä»£ç çš„å¦åšå¤‡ç”¨\n    yunzuogailan_export = yunzuogailan_before_v2[yunzuogailan_before_v2['äº§å“ç®€ç§°'].map(lambda x: '(å­' not in x)]\n    # yunzuogailan_export['20231231å‡€å€¼']=yunzuogailan_export['æ¯äº§å“ä»£ç '].map(lambda x:data_transposition.loc['2023/12/31',x] if x in data_transposition.columns else np.nan)\n    keep_col_here = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†',\n                     'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–',\n                     'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥',\n                     'å‘¨æœŸå¤©æ•°', 'æ˜¯å¦æ‹›å•†', 'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ¯åˆ†ç±»']\n    yunzuogailan_export = yunzuogailan_export[keep_col_here]\n    yunzuogailan_export.drop_duplicates().to_excel(Config.get_overview_parent_file(yunzuogailan_date))\n    # yunzuogailan_before_v2.drop_duplicates().to_excel(Underlying_data_folder_path+'/äº§å“è¿ä½œæ¦‚è§ˆä¿¡æ¯è¡¨.xlsx')\n    yzgl = yunzuogailan_before_v2.drop_duplicates().copy()\n    yzgl_lastw = pd.read_excel(Config.get_overview_history_file(lastw), index_col=0)\n    yzgl_lastm = pd.read_excel(Config.get_overview_history_file(lastm), index_col=0)\n    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastw['ç»„åˆä¹…æœŸ']\n    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨'] = yzgl['æ æ†'] - yzgl_lastw['æ æ†']\n    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastw['æƒç›Šä»“ä½']\n    yzgl['ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['ç»„åˆä¹…æœŸ'] - yzgl_lastm['ç»„åˆä¹…æœŸ']\n    yzgl['æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ'] = yzgl['æ æ†'] - yzgl_lastm['æ æ†']\n    yzgl['æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ'] = yzgl['æƒç›Šä»“ä½'] - yzgl_lastm['æƒç›Šä»“ä½']  ###è°ƒæ•´é¡ºåº\n    mu_col=['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', '5%æµåŠ¨æ€§å®é™…æŒ‡æ ‡', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ç´¯è®¡å¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'æ æ†',\n       'ç»„åˆä¹…æœŸ', 'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'è¡ç”Ÿå“ä»“ä½', 'è¿ä½œå¤©', 'å‰©ä½™å¤©','äº§å“ç»ç†', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'é”€å”®è´¹',\n       'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹', 'æ¯äº§å“ä»£ç ', 'å¸ç§', 'å¤šèµ„äº§å“ç±»', 'äº§å“éƒ¨å“ç±»', 'å½¢æ€', 'å‘¨æœŸå¤©æ•°',\n       'äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', 'æ˜¯å¦æ‹›å•†', 'æ¸ é“æ˜ç»†', 'æ¯å­æ ‡å¿—', 'ä¸»è¦å±•ç¤º', 'æ¯åˆ†ç±»', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šå‘¨',\n       'æ æ†å˜åŒ–-è¾ƒä¸Šå‘¨', 'æƒç›Šä»“ä½-è¾ƒä¸Šå‘¨', 'ä¹…æœŸå˜åŒ–-è¾ƒä¸Šæœˆ', 'æ æ†å˜åŒ–-è¾ƒä¸Šæœˆ', 'æƒç›Šä»“ä½-è¾ƒä¸Šæœˆ']\n    yzgl[mu_col].to_excel(Config.get_overview_history_file(yunzuogailan_date))\n    print(\"åŸºäºä»…æ¯äº§å“çš„è¡¨ æ›´æ–°å“ç±»æ¸…å•åé‡è·‘\")\nget_yunzuogailan(yunzuogailan_date)\n\nyunzuogailan_all = pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0)\nChannel_df = pd.read_excel(Config.get_weekly_data_file('å„æ¸ é“ä¿æœ‰é‡'), index_col=0)\ndate = zhoubao_date\n# 1.åŒ¹é…å“ç±»\n# åŒ¹é…å¶è€å¸ˆçš„å“ç±»\nclassification_df = pd.read_excel(\n    Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),\n    sheet_name='å¤šèµ„äº§å“ç±»æ ‡ç­¾',\n    index_col='æ¯äº§å“ä»£ç '\n)\n# å¤„ç†é‡å¤æ¯äº§å“ä»£ç ï¼Œç¡®ä¿åç»­æ˜ å°„ä¸ºæ ‡é‡\nclassification_df = classification_df[~classification_df.index.duplicated(keep='first')]\nclassification_ye = classification_df['å¤šèµ„äº§å“ç±»']\n\nwriter = pd.ExcelWriter(Config.get_current_output_writer(date))\n\n\n# Channel_result1.to_excel(writer,sheet_name='1ã€åˆ†æ¸ é“ä½™é¢')\n# Channel_result2.to_excel(writer,sheet_name='æ¸ é“æ˜ç»†')\n\n# æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“\ndef del_Innovation_department(mid_df):\n    mid_df = mid_df[mid_df['å¤šèµ„äº§å“ç±»'].map(\n        lambda x: x not in ['ç»“æ„æ€§ç†è´¢R2+', 'ç»“æ„æ€§ç†è´¢R3', 'ç»“æ„æ€§ç†è´¢R4', 'é‡åŒ–ç³»åˆ—', 'é‡åŒ–ç³»åˆ—(*)'])]\n    mid_df = mid_df[mid_df['äº§å“ç»ç†'].map(\n        lambda x: np.sum([k not in ['ç‹æµ©', 'å¼ é›…å©•', 'å­™æ–°å', ''] for k in x.split(',')]) != 0)]\n    return mid_df\n\n\n# åŒ¹é…ç†è´¢äº§å“çš„å­—æ¯ä»£ç \nChannel_df['æ¯äº§å“ä»£ç '] = Channel_df['äº§å“ç®€ç§°'].map(\n    lambda x: Channel_df[Channel_df['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0])\nChannel_df['å¤šèµ„äº§å“ç±»'] = Channel_df['æ¯äº§å“ä»£ç '].map(\n    lambda x: classification_ye[x] if x in classification_ye.index else np.nan)\nChannel_df = Channel_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')\nChannel_df = Channel_df[~pd.isnull(Channel_df['äº§å“ç»ç†'])]  # ä»…ä¿ç•™æˆ‘éƒ¨äº§å“(ä¸è¿ä½œæ¦‚è§ˆåŒæ¸…å•)\n# æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“\nChannel_df = del_Innovation_department(Channel_df)\n# 2.ä»…ä¿ç•™å­äº§å“dfï¼ˆæ¸ é“ä¿¡æ¯è¡Œï¼‰\n# éƒ¨åˆ†å­äº§å“çš„æ¸ é“åç§°ä¸º'-â€™ï¼Œæ˜¯å› ä¸ºå…¶ä¸‹è¿˜å¯ä»¥è¿›ä¸€æ­¥å±•å¼€\n# å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ¯äº§å“éƒ½æ˜¯â€˜-â€™ï¼Œå› ä¸ºè¿˜æœ‰æ¯äº§å“ä¸å«å­äº§å“ï¼Œé‚£æ¯äº§å“æœ¬èº«å°±æ˜¯æ¸ é“æ•°æ®ï¼Œæ‰€ä»¥ä¸èƒ½åˆ é™¤æ‰€æœ‰æ¯äº§å“\nChannel_df_subproduct = Channel_df[Channel_df['æ¸ é“åç§°'] != '-']\nChannel_df_subproduct['æ¸ é“-è¡Œå†…å¤–'] = Channel_df_subproduct['æ¸ é“åç§°'].map(\n    lambda x: 'è¡Œå†…' if x == 'å…´ä¸šé“¶è¡Œ' else 'è¡Œå¤–')\n# åŒ¹é…å¶è€å¸ˆçš„å­æ¯åˆ†ç±»å…³ç³»\nParent_sort = pd.read_excel(\n    Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),\n    sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»',\n    index_col=0\n)[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]\n# å»é‡ï¼Œç¡®ä¿ç´¢å¼•ï¼ˆå¤šèµ„äº§å“ç±»ï¼‰å”¯ä¸€\nParent_sort = Parent_sort[~Parent_sort.index.duplicated(keep='first')]\nChannel_df_subproduct = Channel_df_subproduct.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n\n\n\ndef rank_by_sort(my_df, rank_def):\n    my_df = my_df.copy()\n    # å®é™…å‡ºç°çš„ç´¢å¼•é›†åˆ\n    actual = list(my_df.index)\n    # æ„é€ æ–°çš„æ’åºé¡ºåºï¼šå…ˆæ”¾åœ¨ rank_def ä¸­ä¸”å®é™…å‡ºç°çš„ï¼Œå†æ”¾å…¶ä½™å®é™…å‡ºç°ä½†ä¸åœ¨ rank_def çš„\n    new_order = [x for x in rank_def if x in actual] + [x for x in actual if x not in rank_def]\n    # ä¾æ® new_order ç”Ÿæˆæ’åºé”®\n    order_map = {val: i for i, val in enumerate(new_order)}\n    my_df['__order__'] = my_df.index.map(order_map).fillna(len(new_order))\n    my_df = my_df.sort_values('__order__').drop(columns='__order__')\n    return my_df\n\n\n\n# å¯¹indexæ–‡æœ¬æŒ‰ç…§æŒ‡å®šé¡ºåºæ’åº\nrank_here = [('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³äº«çŸ­æŒ'),\n             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'æ‚¦åŠ¨ç¨³/çº¯äº«'),\n             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¼˜å…ˆè‚¡çŸ­æŒ'),\n             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'ä¸°åˆ©/å¢ç›ˆ'),\n             ('ä¸­ä½æ³¢ç¨³å¥äº§å“', 'è¡Œå¤–éæ ‡é©±åŠ¨å‹å›ºæ”¶+'),\n             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å’Œç‘BOF'),\n             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€'),\n             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'é€¸åŠ¨çŸ­æŒ'),\n             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'çµåŠ¨çŸ­æŒ'),\n             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å…´åŠ¨çŸ­æŒ'),\n             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'å«æƒå®šå¼€/å°é—­'),\n             ('ä¸­é«˜æ³¢å¸‚å€¼äº§å“', 'ESGè”å'),\n             ('å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),\n             ('å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼'), ]\n\n# æ”¹æˆæ•°æ®é€è§†è¡¨çš„é‚£ç§æ ¼å¼\nChannel_result1 = pd.pivot_table(Channel_df_subproduct, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ¸ é“-è¡Œå†…å¤–',\n                                 values=['ä¿æœ‰è§„æ¨¡'], aggfunc=np.sum) / 100000000  # æ•°æ®é€è§†\nChannel_result1 = rank_by_sort(Channel_result1, rank_here)\nChannel_result2 = pd.pivot_table(Channel_df_subproduct, index=['æ¸ é“åç§°'], columns='æ€»åˆ†ç±»', values=['ä¿æœ‰è§„æ¨¡'],\n                                 aggfunc=np.sum) / 100000000\nChannel_result2['åˆè®¡'] = Channel_result2.sum(axis=1)\nChannel_result2 = Channel_result2.sort_values('åˆè®¡', ascending=False)  # åº•è¡¨æŒ‰ç…§åˆè®¡è§„æ¨¡æ’åº\nChannel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šæœˆ', '')] = Channel_result2[('åˆè®¡', '')] - \\\n                                         pd.read_excel(Config.get_output_result_file(lastm), sheet_name='æ¸ é“æ˜ç»†',\n                                                       index_col=0, skiprows=[1, 2])['åˆè®¡']\nChannel_result2[('åˆè®¡-ç›¸æ¯”ä¸Šå¹´', '')] = Channel_result2[('åˆè®¡', '')] - \\\n                                         pd.read_excel(Config.get_output_result_file(lasty), sheet_name='æ¸ é“æ˜ç»†',\n                                                       index_col=0, skiprows=[1, 2])['åˆè®¡']\nChannel_result1.to_excel(writer, sheet_name='1ã€åˆ†æ¸ é“ä½™é¢')\nChannel_result2.to_excel(writer, sheet_name='æ¸ é“æ˜ç»†')\n\nnow = zhoubao_date\n# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\nyunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))\nyunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n\nlastm_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - get_scaleandnum_by_sort(yunzuogailan_lastm)\nlastm_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«']\nlasty_delta_df = get_scaleandnum_by_sort(yunzuogailan_now) - full_category_or_not(\n    get_scaleandnum_by_sort(yunzuogailan_lasty), rank_here).fillna(0)\nlasty_delta_df.columns = ['è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']\n\ncols = ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«', 'æ•°é‡', 'æ•°é‡-è¾ƒä¸Šæœˆæœ«', 'æ•°é‡-è¾ƒä¸Šå¹´æœ«']\nresult_3 = pd.concat([get_scaleandnum_by_sort(yunzuogailan_now), lastm_delta_df, lasty_delta_df], axis=1)[cols]\nresult_3[['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']] = result_3[\n    ['è§„æ¨¡(äº¿)', 'è§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'è§„æ¨¡-è¾ƒä¸Šå¹´æœ«']].applymap(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)\nresult_3 = rank_by_sort(result_3, rank_here)\nresult_3[cols].to_excel(writer, sheet_name='2ã€äº§å“è§„æ¨¡')\n\n# ï¼æ³¨ï¼šæˆ˜æŠ¥åº•è¡¨æ—¥æœŸéœ€è¦æ›´æ–°\n# month_now='2024-10'\ndata_zhanbao = zhoubao_date  # å¯ä¿®æ”¹æˆ˜æŠ¥æ—¥æœŸ\nzhanbao_df = pd.read_excel(Config.get_weekly_data_file('æˆ˜æŠ¥åº•è¡¨(v2)'), index_col=0)\nzhanbao_df = zhanbao_df[zhanbao_df['è§„æ¨¡ç±»å‹-ç®€åŒ–'] == 'é”€é‡']\n\n# æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“\nif 'äº§å“ç»ç†' not in zhanbao_df.columns:\n    zhanbao_df = zhanbao_df.merge(yunzuogailan_all[['äº§å“ç»ç†']], left_index=True, right_index=True, how='left')\nzhanbao_df.rename(columns={'å“ç±»': 'å¤šèµ„äº§å“ç±»'}, inplace=True)\n# å¯¹äº§å“ç»ç†ä¸æ˜¯ç©ºçš„,åˆ¤æ–­æ˜¯å¦æ˜¯æˆ‘éƒ¨çš„äº§å“\nzhanbao_df_1 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: not pd.isnull(x))]\nzhanbao_df_1 = del_Innovation_department(zhanbao_df_1)\nzhanbao_df_2 = zhanbao_df[zhanbao_df['äº§å“ç»ç†'].map(lambda x: pd.isnull(x))]\nzhanbao_df = pd.concat([zhanbao_df_1, zhanbao_df_2])\n\n# æ¯äº§å“ä»£ç å’Œç®€ç§°ä¸ºç©ºçš„ï¼Œæ›¿æ¢ä¸ºå­äº§å“ä»£ç å’Œç®€ç§°\nzhanbao_df['æ¯äº§å“ä»£ç '] = zhanbao_df.apply(lambda x: x.name if pd.isnull(x['æ¯äº§å“ä»£ç ']) else x['æ¯äº§å“ä»£ç '], axis=1)\nzhanbao_df['æ¯äº§å“ç®€ç§°'] = zhanbao_df.apply(lambda x: x['äº§å“ç®€ç§°'] if pd.isnull(x['æ¯äº§å“ç®€ç§°']) else x['æ¯äº§å“ç®€ç§°'],\n                                            axis=1)\n\nkaifang_df = zhanbao_df[\n    (zhanbao_df['å½¢æ€'] == 'å®¢æˆ·å‘¨æœŸ') | (zhanbao_df['å½¢æ€'] == 'æœ€çŸ­æŒæœ‰æœŸ') | (zhanbao_df['å½¢æ€'] == 'å®šå¼€') | (\n                zhanbao_df['å½¢æ€'] == 'æ—¥å¼€')]\n# æŒ‰æ¯äº§å“æ±‡æ€»\nkaifang_df = kaifang_df.groupby('æ¯äº§å“ä»£ç ').agg(\n    {'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first', 'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum',\n     'äº§å“ç»ç†': 'first'})\n# å»æ‰å˜åŠ¨å°äº500wçš„äº§å“-å¯èƒ½æ˜¯å‡€å€¼å˜åŒ–é€ æˆï¼Œä»…çœ‹å¤§çš„\nkaifang_df = kaifang_df[kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(lambda x: abs(x) >= 0.05)]\n\nkaifang_df.sort_values(by='è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', ascending=False, inplace=True)\nkaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'] = kaifang_df['è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰'].map(lambda x: '{:.2f}'.format(x) if not np.isnan(x) else x)\n# kaifang_df['æŠ•èµ„ç»ç†']=[yunzuogailan_all.loc[x,'äº§å“ç»ç†'] for x in kaifang_df.index] #ä»£ç åŠŸèƒ½å†™é‡äº†\n# å»æ‰å°é—­åˆ°æœŸçš„\nkaifang_df = kaifang_df[kaifang_df['æ¯å“ç±»'] != 'å°é—­åˆ°æœŸ']\nkaifang_df.to_excel(writer, sheet_name='3ã€æœ¬â½‰å®šå¼€æˆ–å®¢æˆ·å‘¨æœŸäº§å“è§„æ¨¡å˜åŒ–')\n\nyunzuogailan_date = zhoubao_date\nxinfa_thisweek_df = zhanbao_df[zhanbao_df['èµ·æ¯æ—¥'] >= week_Mon]\n# å«æœ‰å¾…èµ·æ¯äº§å“çš„è¿ä½œæ¦‚è§ˆ\nyunzuogailan_original = pd.read_excel(Config.get_weekly_data_file('äº§å“è¿ä½œæ¦‚è§ˆ'), index_col=0)\n# åŒ¹é…ç†è´¢äº§å“çš„å­æ¯ä»£ç \nyunzuogailan_original['æ¯äº§å“ä»£ç '] = yunzuogailan_original['äº§å“ç®€ç§°'].map(\n    lambda x: yunzuogailan_original[yunzuogailan_original['äº§å“ç®€ç§°'] == x.split('(å­')[0]].index[0])\nyunzuogailan_original = yunzuogailan_original[['äº§å“ç®€ç§°', 'æ¯äº§å“ä»£ç ', 'äº§å“ç»ç†']].drop_duplicates()\n\n# åŒ¹é…æ–°å‘äº§å“çš„æ¯äº§å“ä»£ç ï¼Œå¦‚æœæ²¡æœ‰ç”¨å­äº§å“ä»£ç æ›¿ä»£\nfor mid_ind in xinfa_thisweek_df.index:\n    if mid_ind in yunzuogailan_original.index:\n        mother_indx = yunzuogailan_original.loc[mid_ind, 'æ¯äº§å“ä»£ç ']\n        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mother_indx\n        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç®€ç§°']\n        xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç»ç†'] = yunzuogailan_original.loc[mother_indx, 'äº§å“ç»ç†']\n    else:\n        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ä»£ç '] = mid_ind\n        xinfa_thisweek_df.loc[mid_ind, 'æ¯äº§å“ç®€ç§°'] = xinfa_thisweek_df.loc[mid_ind, 'äº§å“ç®€ç§°']\n\nxinfa_thisweek_qudao = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ', 'æ¸ é“-ç®€åŒ–']).agg(\n    {'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first', 'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum',\n     'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'})\nxinfa_thisweek_sum = xinfa_thisweek_df.reset_index().groupby(['æ¯äº§å“ä»£ç ']).agg(\n    {'æ¯äº§å“ç®€ç§°': 'first', 'å¤šèµ„äº§å“ç±»': 'first', 'æ¯å“ç±»': 'first', 'èµ·æ¯æ—¥': 'first', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'sum',\n     'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'first', 'å½¢æ€': 'first', 'äº§å“ç»ç†': 'first'})\n\n# å•ç‹¬åˆ—ç¤ºè¡Œå†…è¡Œå¤–çš„è§„æ¨¡å€¼\nfor mid_ind in xinfa_thisweek_sum.index:\n    if (mid_ind, 'è¡Œå†…') in xinfa_thisweek_qudao.index:\n        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå†…(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå†…'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']\n    if (mid_ind, 'è¡Œå¤–') in xinfa_thisweek_qudao.index:\n        xinfa_thisweek_sum.loc[mid_ind, 'è¡Œå¤–(äº¿)'] = xinfa_thisweek_qudao.loc[(mid_ind, 'è¡Œå¤–'), 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰']\n\n# å½“æœ¬å‘¨æ— æ–°å‘äº§å“æ—¶ï¼Œxinfa_thisweek_sum å¯èƒ½ä¸ºç©ºæˆ–ç¼ºå°‘æŒ‡å®šåˆ—ï¼Œå…ˆåšå®‰å…¨å¤„ç†\nif xinfa_thisweek_sum.empty:\n    # åˆ›å»ºä¸€ä¸ªç©ºè¡¨ä½†ä¿ç•™å¿…è¦åˆ—ï¼Œé˜²æ­¢åç»­æŠ¥é”™\n    result_3_2_df = pd.DataFrame(columns=['æ¯äº§å“ç®€ç§°', 'é”€é‡(äº¿)', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»',\n                                          'æ¯å“ç±»', 'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†'])\nelse:\n    # ä»…ä¿ç•™å®é™…å­˜åœ¨çš„åˆ—\n    keep_columns_xinfa = ['æ¯äº§å“ç®€ç§°', 'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰', 'è¡Œå†…(äº¿)', 'è¡Œå¤–(äº¿)', 'å¤šèµ„äº§å“ç±»', 'æ¯å“ç±»', 'èµ·æ¯æ—¥',\n                          'æˆ˜æŠ¥åˆ°æœŸæ—¥', 'å½¢æ€', 'äº§å“ç»ç†']\n    # å–äº¤é›†ï¼Œé¿å… KeyError\n    cols_available = [c for c in keep_columns_xinfa if c in xinfa_thisweek_sum.columns]\n    xinfa_thisweek_sum = xinfa_thisweek_sum[cols_available].copy()\n    xinfa_thisweek_sum.rename(columns={'è§„æ¨¡/å˜åŒ–ï¼ˆäº¿ï¼‰': 'é”€é‡(äº¿)', 'æˆ˜æŠ¥åˆ°æœŸæ—¥': 'åˆ°æœŸæ—¥'}, inplace=True)\n    result_3_2_df = xinfa_thisweek_sum[xinfa_thisweek_sum['é”€é‡(äº¿)'] != 0]\n    result_3_2_df.sort_values(by='èµ·æ¯æ—¥', ascending=True, inplace=True)\n\nresult_3_2_df.to_excel(writer, sheet_name='æœ¬å‘¨æ–°å‘äº§å“')\n# xinfa_thisweek_sum[xinfa_thisweek_sum['é”€é‡(äº¿)']!=0].to_excel('test1.xlsx',sheet_name='3ã€æœ¬å‘¨æ–°å‘äº§å“')\n\nproduct_tosale_df = pd.read_excel(Config.get_weekly_data_file('ç†è´¢äº§å“åŒºé—´åœ¨å”®å¾…å”®æƒ…å†µè¡¨'), index_col=0, skiprows=1)\nproduct_tosale_df = product_tosale_df.merge(Product_information_df_DAP['æ¯äº§å“æŠ•èµ„ç»ç†'], left_index=True,\n                                            right_index=True, how='left')\nfirst = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦','æä½³èˆª',\"è‹æ–‡æ´¥\",\"å¤å‡¡ç››\",\"é»„äº¦å°§\"]\nsecond = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ',\"ç½—è°¨æ·±\"]\nthird = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°','å»–ç‚¯è‡£']\n\n\ndef manager_in_or_not(s: str, y: list):\n    if pd.isnull(s):\n        return False\n    else:\n        for mid_y in y:\n            if mid_y in s:\n                return True\n        return False\n\n\nproduct_tosale_df_new = product_tosale_df[\n    product_tosale_df['æ¯äº§å“æŠ•èµ„ç»ç†'].map(lambda x: manager_in_or_not(x, first + second + third))]\ndate_here = zhoubao_date[:4] + '-' + zhoubao_date[4:6] + '-' + zhoubao_date[6:]\nproduct_tosale_df_final = product_tosale_df_new[product_tosale_df_new['æˆç«‹æ—¥'] > date_here]\nproduct_tosale_df_final.drop_duplicates(inplace=True)\nkeep_columns = ['æ¯å­äº§å“æ ‡è¯†', 'äº§å“ç®€ç§°', 'äº§å“å¼€æ”¾å½¢å¼', 'å‹Ÿé›†æœŸ(èµ·)', 'å‹Ÿé›†æœŸ(æ­¢)',\n                'æˆç«‹æ—¥', 'åˆ°æœŸæ—¥', 'è§„æ¨¡ä¸Šé™(äº¿)', 'é”€å”®å¸ç§']\n# product_tosale_df_final[keep_columns].to_excel('test.xlsx')\nproduct_tosale_df_final_v1 = product_tosale_df_final[keep_columns]\nproduct_tosale_df_final_v2 = product_tosale_df_final_v1[product_tosale_df_final_v1.apply(lambda x: False if ( \\\n                                                                                                                        x[\n                                                                                                                            'äº§å“ç®€ç§°'] in\n                                                                                                                        product_tosale_df_final_v1[\n                                                                                                                            'äº§å“ç®€ç§°']) and (\n                                                                                                                        x[\n                                                                                                                            'æ¯å­äº§å“æ ‡è¯†'] == 'æ¯äº§å“') else True,\n                                                                                         axis=1)]\nproduct_tosale_df_final_v2.sort_values(by='æˆç«‹æ—¥', ascending=True, inplace=True)\nproduct_tosale_df_final_v2.to_excel(writer, sheet_name='å¾…å”®äº§å“')\n\n# å¤šèµ„äº§äº§å“ç›‘æ§\nstart_date = ''  # æ•°æ®åŒºé—´å¼€å§‹ï¼Œå¯é€‰â€œâ€æˆ–è€…'2024-10-16'\nend_date = ''  # æ•°æ®æˆªæ­¢æ—¶é—´ï¼Œå¯é€‰â€œâ€æˆ–è€…'2024-04-15'\n# ä½¿ç”¨é…ç½®çš„æ•°æ®ç›®å½•ï¼Œä¸å†ä½¿ç”¨ç¡¬ç¼–ç è·¯å¾„\n# path='/Users/fanshengxia/Desktop/å‘¨æŠ¥/2.å¤šèµ„äº§äº§å“ç›‘æ§'\n\ndata_transposition.replace(0, np.nan, inplace=True)\nif start_date == \"\":\n    data_transposition_here = data_transposition\nelse:\n    data_transposition_here = data_transposition.loc[start_date:]\n\nif end_date == \"\":\n    data_transposition_here.apply(performance_calculate_optimize).T.to_excel(Config.get_performance_file(zhoubao_date))\n    print('æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.index[-1]))\nelse:\n    data_transposition_here.loc[:end_date].apply(performance_calculate_optimize).T.to_excel(\n        Config.get_performance_file(end_date))\n    print('æ•°æ®æˆªæ­¢æ—¶é—´ä¸º' + str(data_transposition_here.loc[:end_date].index[-1]))\n\n# now='20241024'\nParent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[\n    ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]\n\n\n# yunzuogailan_now=del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now),index_col=0))\n\n\n# æœ€çŸ­æŒæœ‰æœŸäº§å“ç”¨Aä»½é¢æ›¿ä»£\nyear_col = f\"{int(str(zhoubao_date)[:4])}å¹´å¹´åŒ–æ”¶ç›Šç‡\"\ndef weighted_avg(group):\n    w_fields = [\n        'ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡',\n        'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡'\n    ]\n    results = {}\n\n    for field in w_fields:\n        # ä»…ä¿ç•™è¯¥å­—æ®µä¸ä¸ºç©ºçš„è¡Œ\n        mask = group[field].notna()\n        if mask.any():  # è‡³å°‘æœ‰ä¸€ä¸ªæœ‰æ•ˆæ ·æœ¬\n            weight_valid = group.loc[mask, 'å‡€èµ„äº§(äº¿)']\n            total_weight = weight_valid.sum()\n            results[field] = (\n                    (group.loc[mask, field] * weight_valid).sum() / total_weight\n            )\n        else:  # å…¨éƒ¨ä¸ºç©ºï¼Œè¿”å› NaN\n            results[field] = np.nan\n\n    return pd.Series(results)\nyunzuogailan_all = del_Innovation_department(\n    pd.read_excel(Config.get_overview_history_file(yunzuogailan_date), index_col=0))\n\n# ç­›é€‰æŒæœ‰æœŸå’Œå…¶ä»–äº§å“\nto_merge_chiyouqi_code = yunzuogailan_all[\n    yunzuogailan_all.apply(lambda x: (x['ä¸»è¦å±•ç¤º'] == 'æ˜¯') & (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']), axis=1)]\nto_merge_other_code = yunzuogailan_all[\n    yunzuogailan_all.apply(lambda x: (x['æ¯å­æ ‡å¿—'] in ['éæ¯å­äº§å“', 'æ¯äº§å“']) & (x['å½¢æ€'] in ['å°é—­', 'å®šå¼€']),\n                           axis=1)]\nyunzuogailan_now = pd.concat([to_merge_chiyouqi_code, to_merge_other_code])\n\n# è·å–æ”¶ç›Šç‡å’Œæ³¢åŠ¨ç‡æ•°æ®\nkeep_cols = ['è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']\nyunzuogailan_now_5 = yunzuogailan_now.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\nperf_df = pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0)\nkeep_cols = [c for c in keep_cols if c in perf_df.columns]\nyunzuogailan_now_ret = yunzuogailan_now_5.merge(\n    perf_df[keep_cols],\n    left_index=True, right_index=True, how='left')\nyunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'] = yunzuogailan_now_ret['ç´¯è®¡å¹´åŒ–'].map(\n    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x)\n\n# å¯¹è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡ä¸º0æˆ–ç¼ºå¤±çš„äº§å“ï¼Œç”¨æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡æ›¿ä»£\nyunzuogailan_now_ret['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] = yunzuogailan_now_ret.apply(\n    lambda row: row['ç´¯è®¡å¹´åŒ–'] if (pd.isna(row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡']) or row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'] == 0) else row['è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡'],\n    axis=1\n)\n\n# è®¡ç®—è´¹åå¹³å‡\nresult_5 = yunzuogailan_now_ret[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + ['ç´¯è®¡å¹´åŒ–'] + keep_cols].groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()[\n    ['ç´¯è®¡å¹´åŒ–'] + keep_cols]\nresult_5 = rank_by_sort(result_5, rank_here)\nresult_5.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹åå¹³å‡')\n\n# è®¡ç®—è´¹ååŠ æƒ\nresult_5_weight = yunzuogailan_now_ret.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)\nresult_5_weight = rank_by_sort(result_5_weight, rank_here)\nresult_5_weight.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹ååŠ æƒ')\n\n# è®¡ç®—è´¹å‰æ•°æ®\nyunzuogailan_add_fee = yunzuogailan_now_ret.copy()\nw_field = ['ç´¯è®¡å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', year_col, 'è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']\nyunzuogailan_add_fee[w_field] = yunzuogailan_add_fee[w_field].add(\n    yunzuogailan_add_fee[['é”€å”®è´¹', 'ç®¡ç†è´¹', 'æ‰˜ç®¡è´¹']].sum(axis=1), axis=0)\n\n# è®¡ç®—è´¹å‰åŠ æƒ\nresult_series_performance = yunzuogailan_add_fee.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).apply(weighted_avg)\nresult_series_performance = rank_by_sort(result_series_performance, rank_here)\nresult_series_performance.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰åŠ æƒ')\n\n# è®¡ç®—è´¹å‰å¹³å‡\nresult_series_performance_average = yunzuogailan_add_fee[['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'] + w_field + ['è¿‘1å¹´å¹´åŒ–æ³¢åŠ¨ç‡']].groupby(\n    ['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()\nresult_series_performance_average = rank_by_sort(result_series_performance_average, rank_here)\nresult_series_performance_average.to_excel(writer, sheet_name='ç³»åˆ—äº§å“ä¸šç»©-è´¹å‰å¹³å‡')\n# ç­›é€‰æŒæœ‰æœŸäº§å“ï¼Œä¸åŒ…å«å¤–å¸\nyunzuogailan_now_ret_chiyouqi = yunzuogailan_now_ret[yunzuogailan_now_ret.apply(\n    lambda x: (x['å½¢æ€'] in ['å®¢æˆ·å‘¨æœŸ', 'æ—¥å¼€']) and (x['æ¯åˆ†ç±»'] in ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€']),\n    axis=1)]\nyunzuogailan_now_ret_chiyouqi.rename(columns={'ç´¯è®¡å¹´åŒ–': 'æˆç«‹ä»¥æ¥å¹´åŒ–', year_col: 'ä»Šå¹´ä»¥æ¥å¹´åŒ–'},\n                                     inplace=True)\n\n# æœ±è€å¸ˆçš„æ‚¦åŠ¨ç¨³äº«9M281010å•ç‹¬å¤„ç†ï¼Œæ¯äº§å“ä¸šç»©æœ‰è¯¯\nyunzuogailan_now_ret_chiyouqi.loc[\n    '9M281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡',\n                 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']] = \\\n    pd.read_excel(Config.get_performance_file(zhoubao_date), index_col=0).loc[\n        '9A281010', ['æˆç«‹ä»¥æ¥å¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡',\n                     year_col]].values\n\n# 2024å¹´åæˆç«‹çš„ï¼Œä»Šå¹´ä»¥æ¥å¹´åŒ–ä¸ºç©ºï¼Œç”¨æˆç«‹ä»¥æ¥å¹´åŒ–æ›¿ä»£\nyunzuogailan_now_ret_chiyouqi['ä»Šå¹´ä»¥æ¥å¹´åŒ–'] = yunzuogailan_now_ret_chiyouqi.apply(\n    lambda x: x['æˆç«‹ä»¥æ¥å¹´åŒ–'] if pd.isnull(x['ä»Šå¹´ä»¥æ¥å¹´åŒ–']) else x['ä»Šå¹´ä»¥æ¥å¹´åŒ–'], axis=1)\n\n\ndef get_Scale_weighting_ret(my_df):\n    keep_ret_cols = ['æˆç«‹ä»¥æ¥å¹´åŒ–', 'ä»Šå¹´ä»¥æ¥å¹´åŒ–']\n    ret_sum_df = (my_df[keep_ret_cols].multiply(my_df['å‡€èµ„äº§(äº¿)'], axis=\"index\")).sum()\n    scale_sum_df = ((my_df[keep_ret_cols] / my_df[keep_ret_cols]).multiply(my_df['å‡€èµ„äº§(äº¿)'], axis=\"index\")).sum()\n    return ret_sum_df / scale_sum_df\n\n\nresult_df_52 = yunzuogailan_now_ret_chiyouqi.groupby('æ¯åˆ†ç±»').apply(get_Scale_weighting_ret)\nresult_df_52.rename(index={'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€': 'æ‚¦åŠ¨çŸ­æŒ'}, inplace=True)\nrank_chiyouqi = ['æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', 'ä¼˜å…ˆè‚¡çŸ­æŒ', 'æ‚¦åŠ¨çŸ­æŒ']\nrank_by_sort(result_df_52, rank_chiyouqi).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°1')\n\n\n# rank_by_sort(result_df_52,rank_chiyouqi).to_excel('test.xlsx',sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°1')\n\ndef get_zhouqi_scale_v2(x):\n    if x == 1:\n        return 'æ—¥ç›ˆ'\n    elif x < 30:\n        return '<1M'\n    elif x < 31 * 3:\n        return '1M-3M'\n    elif x < 31 * 6:\n        return '3M-6M'\n    elif x < 12 * 31:\n        return '6M-1Y'\n    elif x >= 12 * 31:\n        return '>1Y'\n    else:\n        return 'error'\n\n\nyunzuogailan_now_ret_chiyouqi['æŒæœ‰æœŸæ ‡ç­¾'] = yunzuogailan_now_ret_chiyouqi['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale_v2)\nyunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'] = yunzuogailan_now_ret_chiyouqi['æ¯åˆ†ç±»'].map(\n    lambda x: 'æ‚¦åŠ¨çŸ­æŒ' if x == 'æ‚¦åŠ¨çŸ­æŒ/å®šå¼€' else x)\nresult_df_52_3 = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾']).apply(get_Scale_weighting_ret)\nresult_df_52_3['æ•°é‡'] = yunzuogailan_now_ret_chiyouqi.groupby(['æ¯åˆ†ç±»', 'æŒæœ‰æœŸæ ‡ç­¾'])['äº§å“ç®€ç§°'].count()\nrank_chiyouqi_v3 = [('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '<1M'),\n                    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '1M-3M'),\n                    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '3M-6M'),\n                    ('æ‚¦åŠ¨ç¨³äº«çŸ­æŒ', '6M-1Y'),\n                    ('æ‚¦åŠ¨çŸ­æŒ', '<1M'),\n                    ('æ‚¦åŠ¨çŸ­æŒ', '1M-3M'),\n                    ('æ‚¦åŠ¨çŸ­æŒ', '3M-6M'),\n                    ('æ‚¦åŠ¨çŸ­æŒ', '6M-1Y'),\n                    ('ä¼˜å…ˆè‚¡çŸ­æŒ', '1M-3M')]\nrank_by_sort(result_df_52_3, rank_chiyouqi_v3).to_excel(writer, sheet_name='5.2 æœ€çŸ­æŒæœ‰æœŸäº§å“ä¸šç»©è¡¨ç°2')\n# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°\nnow = zhoubao_date\n# lastm='20250228'  è·Ÿç€ä¸Šé¢ä¸€èµ·æ”¹äº†\n# lasty='20241231'  è·Ÿç€ä¸Šé¢ä¸€èµ·æ”¹äº†\nyunzuogailan_now = del_Innovation_department(pd.read_excel( \\\n    Config.get_overview_parent_file(now), index_col=0))\nyunzuogailan_lastw = del_Innovation_department(pd.read_excel( \\\n    Config.get_overview_parent_file(lastw), index_col=0))\nyunzuogailan_lastm = del_Innovation_department(pd.read_excel( \\\n    Config.get_overview_parent_file(lastm), index_col=0))\nyunzuogailan_lasty = del_Innovation_department(pd.read_excel( \\\n    Config.get_overview_parent_file(lasty), index_col=0))\n\nfirst = ['å¾è¹', 'èƒ¡è‰³å©·', 'å§œé”¡å³°', 'æœ±è½¶ä¼¦','æä½³èˆª',\"è‹æ–‡æ´¥\",\"å¤å‡¡ç››\",\"é»„äº¦å°§\"]\nsecond = ['ä¸¥æ³“', 'é«˜ç¿°æ˜†', 'è–›çºªæ™”', 'ä»»é›', 'å‘¨ä»•ç›ˆ',\"ç½—è°¨æ·±\"]\nthird = ['æ¨æ¼ ', 'ä½™æ´é›…', 'å¼ ç‰æ°','å»–ç‚¯è‡£']\n\nmanager_belong_to = {'æŠ•èµ„ç»ç†å§“å': 'å¤„å®¤', }\nteam = ['ä¸€å¤„', 'äºŒå¤„', 'å¤–å¸']\nteam_list = [first, second, third]\nfor i in range(len(team)):\n    for name_here in team_list[i]:\n        manager_belong_to[name_here] = team[i]\n\nParent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[\n    ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]\n\n\n# åˆ é™¤éæˆ‘éƒ¨é—¨æŠ•èµ„ç»ç†\ndef clear_manager_name(s: str):\n    merge_s = []\n    for mid_s in s.split(','):\n        #         if mid_s in first+second+third+quant:\n        if mid_s in first + second + third:\n            merge_s.append(mid_s)\n    return ','.join(merge_s)\n\n\n# æœ‰å¤šä¸ªæŠ•èµ„ç»ç†å…±åŒç®¡ç†çš„æ•°æ®ï¼Œè¦å¤åˆ¶ä¸€æ¡æ•°æ®ç»™æ¯ä¸ªæŠ•èµ„ç»ç†ï¼Œè§„æ¨¡å’Œä¸ªæ•°å‡åŠ\ndef adjust_manager_aum(mid_data):\n    import pandas as pd  # Ensure pandas is imported\n\n    final_mid_data = mid_data.copy()\n    final_mid_data['åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data['å‡€èµ„äº§(äº¿)']\n    final_mid_data['åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1\n\n    # Create a list to store new rows\n    new_rows = []\n\n    for indx in mid_data.index:\n        mng_list = mid_data.loc[indx, 'äº§å“ç»ç†'].split(',')\n        if len(mng_list) > 1:\n            i = 0\n            for mng in mng_list:\n                if i == 0:\n                    final_mid_data.loc[indx, 'äº§å“ç»ç†'] = mng\n                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] = final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡'] / 2\n                    final_mid_data.loc[indx, 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°'] = 1 / len(mng_list)\n                    i += 1\n                else:\n                    mid_series = final_mid_data.loc[indx].copy()\n                    mid_series['äº§å“ç»ç†'] = mng\n                    # Instead of append, we'll collect new rows and concat later\n                    new_rows.append(pd.DataFrame(mid_series).T)\n\n    # If we have new rows, concatenate them to the original dataframe\n    if new_rows:\n        final_mid_data = pd.concat([final_mid_data] + new_rows, ignore_index=False)\n\n    return final_mid_data\n\n\n# åŒ¹é…å­æ¯åˆ†ç±»å…³ç³»+å¯¹æŠ•èµ„ç»ç†è¿›è¡Œå¤„ç†\ndef get_scaleandnum_by_sort_manager(my_df):\n    Parent_sort = \\\n    pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[\n        ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]\n    my_df = my_df.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n    my_df['äº§å“ç»ç†'] = my_df['äº§å“ç»ç†'].map(clear_manager_name)\n\n    return adjust_manager_aum(my_df)\n\n\nresult_now = get_scaleandnum_by_sort_manager(yunzuogailan_now).groupby('äº§å“ç»ç†').agg(\n    {'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'})\n\nrikai_now = get_scaleandnum_by_sort_manager(yunzuogailan_now)\nrikai_now = rikai_now[rikai_now['å½¢æ€'].map(lambda x: x in ['æ—¥å¼€', 'å®¢æˆ·å‘¨æœŸ', 'æœ€çŸ­æŒæœ‰æœŸ'])].groupby('äº§å“ç»ç†').agg(\n    {'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'})\nrikai_now.rename(columns={'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°'}, inplace=True)\nresult_df_here = []\ncols_to_append = ['-è¾ƒä¸Šå‘¨', '-è¾ƒä¸Šæœˆæœ«', '-è¾ƒä¸Šå¹´æœ«']\nfor i in range(3):\n    mid_df = [yunzuogailan_lastw, yunzuogailan_lastm, yunzuogailan_lasty][i]\n    result_df_i = result_now - get_scaleandnum_by_sort_manager(mid_df).groupby('äº§å“ç»ç†').agg(\n        {'åŒæŒ‚è°ƒæ•´åè§„æ¨¡': 'sum', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°': 'sum'})\n    result_df_i.columns = [x + cols_to_append[i] for x in ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°']]\n    result_df_here.append(result_df_i)\n\nresult_df_here = pd.concat([result_now] + result_df_here + [rikai_now], axis=1)\n\ncols_here = ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«',\n             'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡',\n             'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šæœˆæœ«',\n             'åŒæŒ‚è°ƒæ•´åäº§å“åªæ•°-è¾ƒä¸Šå¹´æœ«', 'æœ€çŸ­æŒæœ‰æœŸäº§å“åªæ•°']\nindx_here = ['ä¸¥æ³“', 'å¾è¹', 'æ¨æ¼ ', 'é«˜ç¿°æ˜†', 'å§œé”¡å³°', 'ä½™æ´é›…', 'è–›çºªæ™”', 'èƒ¡è‰³å©·', 'æœ±è½¶ä¼¦', 'ä»»é›',\n             'å¼ ç‰æ°','å»–ç‚¯è‡£','æä½³èˆª',\"è‹æ–‡æ´¥\",\"å¤å‡¡ç››\",\"é»„äº¦å°§\",\"ç½—è°¨æ·±\"]\nresult_df_here = result_df_here[cols_here]\nresult_df_here =result_df_here.dropna(axis=0,how='all')\nresult_df_here = rank_by_sort(result_df_here, indx_here)\nresult_df_here[['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«',\n                'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']] = result_df_here[\n    ['åŒæŒ‚è°ƒæ•´åè§„æ¨¡', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå‘¨', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šæœˆæœ«', 'åŒæŒ‚è°ƒæ•´åè§„æ¨¡-è¾ƒä¸Šå¹´æœ«',\n     'æœ€çŸ­æŒæœ‰æœŸè§„æ¨¡']].applymap(lambda x: '{:.2f}'.format(x))\nresult_df_here.to_excel(writer, sheet_name='æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡')\n# result_df_here.to_excel('test2.xlsx',sheet_name='æŠ•èµ„ç»ç†ç»´åº¦äº§å“è§„æ¨¡å’Œæ•°é‡')\n\nyunzuogailan_now_65 = yunzuogailan_now.copy()\nyunzuogailan_now_65['å½¢æ€'] = yunzuogailan_now_65['å½¢æ€'].map(lambda x: 'æœ€çŸ­æŒæœ‰æœŸ' if x == 'å®¢æˆ·å‘¨æœŸ' else x)\nyunzuogailan_now_65 = yunzuogailan_now_65.merge(Parent_sort['æ€»åˆ†ç±»'], left_on='å¤šèµ„äº§å“ç±»', right_index=True,\n                                                how='left')\nresult_df_here_65 = pd.concat([pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€',\n                                              values=['å‡€èµ„äº§(äº¿)'], aggfunc='count'), \\\n                               pd.pivot_table(yunzuogailan_now_65, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='å½¢æ€',\n                                              values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)], axis=1)\nresult_df_here_65.to_excel(writer, sheet_name='ä¸åŒå½¢æ€äº§å“è§„æ¨¡å’Œæ•°é‡')\n\n# æ‹›å•†äº§å“åˆ—è¡¨\n# æ”¹æˆå±•ç¤ºå­äº§å“\nzhaoshang_product_list = list(set(Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸'].index))\nzhaoshang_product_df = yunzuogailan_all.loc[zhaoshang_product_list]\n\n\ndef get_yejijizhunxiaxian(x: str):\n    if not pd.isnull(x):\n        try:\n            float(x.split('-')[0][:-1])\n            return x.split('-')[0]\n        except ValueError:\n            return \"\"\n    else:\n        return x\n\n\nzhaoshang_product_df['ä¸šç»©åŸºå‡†ä¸‹é™'] = zhaoshang_product_df['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)\n\n# è·å–è¶…é¢ä¸šç»©<0æ¸…å•\nzhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] = zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'].map(\n    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x)  # çº¦å®šå¹´åŒ–çš„æ•°æ®ç±»å‹\nzhaoshangfinal = zhaoshang_product_df[(zhaoshang_product_df['æœ¬æœŸå¹´åŒ–'] * 100 - zhaoshang_product_df[\n    'ä¸šç»©åŸºå‡†ä¸‹é™'].map(lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100)) < 0]\n# åŒ¹é…æ‹›å•†è§„æ¨¡\nzhaoshang_scale = Channel_df[Channel_df['æ¸ é“åç§°'] == 'æ‹›å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸']['ä¿æœ‰è§„æ¨¡'] / 100000000\nzhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] = [zhaoshang_scale[ind] for ind in zhaoshangfinal.index]\n# ä»…ä¿ç•™æˆç«‹å¤§äºä¸€æœˆçš„\nzhaoshangfinal = zhaoshangfinal[zhaoshangfinal['è¿ä½œå¤©'] > 30]\nzhaoshangfinal = zhaoshangfinal[zhaoshangfinal['æ‹›å•†ä»£é”€è§„æ¨¡'] > 0.1]\nzhaoshangfinal.sort_values('å‰©ä½™å¤©', ascending=True, inplace=True)  # åº•è¡¨æŒ‰ç…§å‰©ä½™å¤©æ’åº\nzhaoshangfinal.to_excel(writer, sheet_name='æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†')\n# zhaoshangfinal.to_excel('test.xlsx',sheet_name='æ‹›å•†åœ¨å”®äº§å“ä¸è¾¾åŸºå‡†')\n\nyunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'] = yunzuogailan_all['ä¸šç»©åŸºå‡†'].map(get_yejijizhunxiaxian)\nyunzuogailan_all['æœ¬æœŸå¹´åŒ–'] = yunzuogailan_all['æœ¬æœŸå¹´åŒ–'].map(\n    lambda x: float(x[:-1]) / 100 if isinstance(x, str) else x)  # çº¦å®šå¹´åŒ–çš„æ•°æ®ç±»å‹\nyunzuogailan_all = yunzuogailan_all[(yunzuogailan_all['æœ¬æœŸå¹´åŒ–'] * 100 - yunzuogailan_all['ä¸šç»©åŸºå‡†ä¸‹é™'].map(\n    lambda x: float(x[:-1]) if (x != \"\") & (not pd.isnull(x)) else -100)) < 0]\nbdjz_100 = yunzuogailan_all[(yunzuogailan_all['å½¢æ€'].isin(['å°é—­', 'å®šå¼€'])) & (yunzuogailan_all['å‰©ä½™å¤©'] < 100)]\nbdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = (bdjz_100['æœ¬æœŸå¹´åŒ–'] - (bdjz_100['ä¸šç»©åŸºå‡†ä¸‹é™'].str[:-1]).astype(\n    float) / 100) * 10000\nbdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'] = bdjz_100['æœ¬æœŸå¹´åŒ–-ä¸šç»©åŸºå‡†ä¸‹é™ï¼ˆBPï¼‰'].astype(int)\nbdjz_100 =bdjz_100[bdjz_100['æ¯åˆ†ç±»'] !='å¤–å¸ä½æ³¢']  ##å‰”é™¤å¤–å¸äº§å“ ç³»ç»Ÿæ•°æ®ä¸å‡†ç¡®\nbdjz_100.to_excel(writer, sheet_name='å°é—­åŠå®šå¼€äº§å“100æ—¥å†…ä¸å¤§ä¸šç»©äº§å“æ¸…å•')\n\ndate = zhoubao_date\n\ndate_lastw = lastw\ndate_lastm = lastm\ndate_lasty = lasty\nexcel_name = 'æŒä»“ç›ˆäºæ˜ç»†åˆ—è¡¨_' + date + '.xlsx'\nyunzuogailan_all = pd.read_excel(Config.get_overview_history_file(date), index_col=0)\nChicang_df = pd.read_excel(os.path.join(Config.WEEKLY_DATA_DIR, excel_name))\nChicang_df.rename(columns={'èµ„äº§ç®€ç§°': 'å€ºåˆ¸ç®€ç§°'}, inplace=True)  ###æŒ‰ç…§è€çš„ç®€ç§°è®¡ç®—\nChicang_df.drop_duplicates(inplace=True)\nChicang_df = Chicang_df.merge(yunzuogailan_all['å¸ç§'], left_on='äº§å“ä»£ç ', right_index=True, how='left')\n# äº§å“è®¡ä»·å•ä½ä¸ºç¾å…ƒçš„ï¼Œéœ€è¦è½¬æ¢æˆäººæ°‘å¸\n# æ³¨ï¼šæˆ‘ä»¬pasç³»ç»Ÿçš„é€»è¾‘æ˜¯å±•ç¤ºæœ¬å¸è§„æ¨¡ï¼Œæœ¬å¸æ˜¯æŒ‡äº§å“çš„é”€å”®å•ä½/è®¡ä»·å•ä½ï¼Œç›®å‰ç¾å…ƒäº§å“åº•å±‚èµ„äº§åªæœ‰ç¾å…ƒèµ„äº§ï¼Œå±•ç¤ºè§„æ¨¡ä¸ºç¾å…ƒï¼›äººæ°‘å¸äº§å“åº•å±‚èµ„äº§ï¼Œç¾å…ƒçš„ä¼šè½¬æˆäººæ°‘å¸ï¼Œäººæ°‘å¸çš„ç›´æ¥å±•ç¤ºäººæ°‘å¸\nEXchange_rate = market_data.get_exchange_rate('USDCNY', Config.EXCHANGE_RATE_DATE)\nChicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.apply(\n    lambda x: x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] * EXchange_rate if x['å¸ç§'] == 'ç¾å…ƒ' else x['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'],\n    axis=1)\n\n# æš‚æ—¶ä»£ç â€”â€”æ–°åŸºé‡‘ç±»å‹äº’è®¤åŸºé‡‘å’ŒåŸºå‡†åšå¸‚åŸºé‡‘çš„'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'æ˜¯0ï¼Œä½†æ˜¯æœ‰æŒä»“æˆæœ¬å’ŒæŒæœ‰æœŸæ”¶ç›Šæ•°æ®ï¼Œæ‰€ä»¥æš‚æ—¶ç”¨äºŒè€…è®¡ç®—ä»£æ›¿\nto_fill_indx = Chicang_df[Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] == 0].index\nChicang_df.loc[to_fill_indx, 'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df.loc[to_fill_indx, 'æŒä»“æˆæœ¬(å…ƒ)'] + Chicang_df.loc[\n    to_fill_indx, 'æŒæœ‰æœŸæ”¶ç›Š']\nChicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] = Chicang_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].fillna(0)\n\n# è·å–èµ„äº§å‹¾ç¨½å…³ç³»å’Œä¿é™©èµ„ç®¡äº§å“\nasset_classification_joint_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),\n                                              sheet_name='èµ„äº§åˆ†ç±»å‹¾ç¨½å…³ç³»', index_col=0)\ninsurance_pdct_df = pd.read_excel(Config.get_weekly_data_file('ä¿é™©èµ„ç®¡è®¡åˆ’'), index_col=0)  # è¿‘7å¤©å¹´åŒ–æ”¶ç›Š\n# åŒ¹é…èµ„äº§å°ç±»å’Œå‹¾ç¨½å…³ç³»ä¸‹çš„ä¸‰çº§åˆ†ç±»\nChicang_df = Chicang_df.merge(asset_classification_joint_df[['ç¼–å·', 'ä¸‰çº§åˆ†ç±»']], left_on='æ–°ç‰ˆèµ„äº§å°ç±»',\n                              right_index=True, how='left')\n# æ ‡è®°ä¿é™©èµ„ç®¡èµ„äº§\nmid_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å°ç±»'] == 'å§”å¤–ç°é‡‘ç®¡ç†æŠ•èµ„']\ninsurance_pdct_name_list = list(insurance_pdct_df.index) + ['è‹±å¤§èµ„äº§-èšé‘«22å·', 'å¤§å®¶èµ„ç®¡ç¨³å¥ç²¾é€‰15å·']\ninsurance_pdct_indx = mid_df[mid_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in insurance_pdct_name_list)].index\nChicang_df.loc[insurance_pdct_indx, 'ç¼–å·'] = '1.2'\nChicang_df.loc[insurance_pdct_indx, 'ä¸‰çº§åˆ†ç±»'] = '1.2 ä¿é™©åè®®å­˜æ¬¾'\n# ç»†åŒ–3.4-3.5ä¸­çš„åŸæŠ•å’Œæ°¸ç»­\n# å•ç‹¬æå‡ºæ‰€æœ‰çš„å€ºåˆ¸æ•°æ®è·å–åŸæŠ•å’Œæ°¸ç»­ä¿¡æ¯\nbond_set_df = pd.DataFrame(list(set(Chicang_df[Chicang_df['ç¼–å·'] == '3.4-3.5']['å¤–éƒ¨ä»£ç '])), columns=['å¤–éƒ¨ä»£ç '])\n\n# è·å–Windæ•°æ®â€”â€”æœ€å¥½ä¸è¦é‡å¤è·‘ï¼Œå¯ç”¨æ•°æ®é‡æœ‰é™\nbond_code_list = list(bond_set_df['å¤–éƒ¨ä»£ç '].values)\nwind_result = market_data.get_bond_attributes(bond_code_list)\nbond_set_df[['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­']] = wind_result.values\n# é€šè¿‡åŸæŠ•å’Œæ°¸ç»­åŒ¹é…ä¸‰çº§åˆ†ç±»çš„å‹¾ç¨½è¡¨\nto_merge_df = pd.DataFrame(\n    [['æ˜¯', 'å¦', '3.4.1 éæ°¸ç»­åŸæŠ•å€º'], ['æ˜¯', 'æ˜¯', '3.4.2 æ°¸ç»­åŸæŠ•å€º'], ['å¦', 'å¦', '3.5.1 éæ°¸ç»­äº§ä¸šå€º'],\n     ['å¦', 'æ˜¯', '3.5.2 æ°¸ç»­äº§ä¸šå€º']], columns=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­', 'ä¸‰çº§åˆ†ç±»'])\nbond_set_df = bond_set_df.merge(to_merge_df, left_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'], right_on=['æ˜¯å¦åŸæŠ•', 'æ˜¯å¦æ°¸ç»­'],\n                                how='left')\n# åˆå¹¶åˆ°æŒä»“è¡¨\nChicang_df['ä¸‰çº§åˆ†ç±»-new'] = Chicang_df.apply(\n    lambda x: bond_set_df.set_index('å¤–éƒ¨ä»£ç ').loc[x['å¤–éƒ¨ä»£ç '], 'ä¸‰çº§åˆ†ç±»'] if x['ç¼–å·'] == '3.4-3.5' else x[\n        'ä¸‰çº§åˆ†ç±»'], axis=1)\n# åŒ¹é…å¤šèµ„äº§å“ç±»\nyunzuogailan_now = pd.read_excel(Config.get_overview_parent_file(date), index_col=0)\nParent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)[\n    ['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']]\nChicang_df2 = Chicang_df.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»', 'äº§å“ç»ç†']], left_on='äº§å“ä»£ç ', right_index=True,\n                               how='left')\nChicang_df2 = Chicang_df2[\n    Chicang_df2.apply(lambda x: not pd.isnull(x['äº§å“ç»ç†']), axis=1)]  # åŒ¹é…ä¸åˆ°äº§å“ç»ç†çš„æ˜¯å½“å¤©äº§å“å·²ç»åˆ°æœŸäº†ï¼Œä½†æ˜¯pasæŒä»“ä»æœ‰æ‹‰å–\nChicang_df2 = del_Innovation_department(Chicang_df2)  # æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“\nChicang_df2 = Chicang_df2.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n\nresult_df_8_initial = pd.pivot_table(Chicang_df2, index=['ä¸‰çº§åˆ†ç±»-new'], columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'],\n                                     values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum) / 100000000  # ä¸“æˆ·æŒä»“çš„æ•°æ®é€è§†\n\n# ç»†åŒ–7.2 å§”å¤–å€ºåˆ¸æŠ•èµ„çš„å­é¡¹\nOutsourced_bond_asset_df = Chicang_df2[Chicang_df2['ä¸‰çº§åˆ†ç±»'] == '7.2 å§”å¤–å€ºåˆ¸æŠ•èµ„']\npublic_account_tag_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å§”å¤–å…¬å…±ç­–ç•¥ä¸“æˆ·æ ‡ç­¾',\n                                      index_col=0)\nOutsourced_bond_asset_df_new = Outsourced_bond_asset_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°',\n                                                              right_index=True, how='left')\nOutsourced_bond_tag = {'æ”¶ç›˜ä»·æ³•': '7.2.1 æ”¶ç›˜ä»·ä¸“æˆ·',\n                       'åˆ©ç‡å€ºæ”¶ç›˜ä»·': '7.2.2 åˆ©ç‡å€ºæ”¶ç›˜ä»·ä¸“æˆ·',\n                       'æ¨¡å‹æ³•': '7.2.3 æ¨¡å‹æ³•ä¸“æˆ·',\n                       'å¯è½¬å€º': '7.2.4 å¯è½¬å€ºä¸“æˆ·',\n                       'æ’å®šä¹…æœŸ': '7.2.5 æ’å®šä¹…æœŸä¸“æˆ·',\n                       'å›ºæ”¶+å§”å¤–': '7.2.6 å›ºæ”¶+å§”å¤–ä¸“æˆ·',\n                       'Wä¸“æˆ·': '7.2.7 Wä¸“æˆ·',\n                       'ç»¿è‰²å€º': '7.2.8 ç»¿è‰²å€ºä¸“æˆ·',\n                       'å¤–å¸ä¸“æˆ·': '7.2.9 å¤–å¸ä¸“æˆ·', }\n# é¢å¤–å®šä¹‰è¡¥å……çš„åˆ†ç±»ï¼Œéç”±æ±‡æ€»çš„pivot_tableè®¡ç®—\nOutsourced_bond_asset_df_new['å››çº§åˆ†ç±»'] = Outsourced_bond_asset_df_new['æ ‡ç­¾'].map(\n    lambda x: Outsourced_bond_tag[x] if x in Outsourced_bond_tag.keys() else '7.2.10 å…¶ä»–')\nOutsourced_bond_asset_result = pd.pivot_table(Outsourced_bond_asset_df_new, index=['å››çº§åˆ†ç±»'],\n                                              columns=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'],\n                                              aggfunc=np.sum) / 100000000  # ä¸“æˆ·æŒä»“çš„æ•°æ®é€è§†\nresult_df_8 = pd.concat([result_df_8_initial.rename_axis(''), Outsourced_bond_asset_result.rename_axis('')])\nresult_df_8.to_excel(Config.get_asset_table_file(date))\nresult_df_lastw = pd.read_excel(Config.get_asset_table_file(date_lastw), index_col=0, header=[0, 1, 2])\nresult_df_lastm = pd.read_excel(Config.get_asset_table_file(lastm), index_col=0, header=[0, 1, 2])\nresult_df_lasty = pd.read_excel(Config.get_asset_table_file(lasty), index_col=0, header=[0, 1, 2])\n# åˆå¹¶æœ¬å‘¨æ•°æ®å’Œç›¸æ¯”ä¹‹å‰ï¼Œå¹¶è°ƒèŠ‚å¤šé‡ç´¢å¼•\nresult_df_8_final = pd.concat([result_df_8, result_df_8.sum(axis=1) - result_df_lastw.sum(axis=1),\n                               result_df_8.sum(axis=1) - result_df_lastm.sum(axis=1),\n                               result_df_8.sum(axis=1) - result_df_lasty.sum(axis=1)], axis=1)\n\n# result_df_8_final.to_excel('test.xlsx',sheet_name='8.èµ„äº§å¤§è¡¨')\n\n# è¡¥å……æœ¬å¸çš„ç›¸æ¯”ä¸Šå‘¨ã€ç›¸æ¯”ä¸Šæœˆã€ç›¸æ¯”ä¸Šå¹´(å»æ‰å¤–å¸äº§å“ï¼‰\nforeign_currency_products_cols = [\n    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸ä½æ³¢'),\n    ('æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼', 'å¤–å¸äº§å“', 'å¤–å¸å¸‚å€¼')\n]\n\n# è·å–æ‰€æœ‰éå¤–å¸äº§å“åˆ—\nall_columns_8 = list(result_df_8.columns)\ndomestic_columns_8 = [col for col in all_columns_8 if col not in foreign_currency_products_cols]\n\nall_columns_lastw = list(result_df_lastw.columns)\ndomestic_columns_lastw = [col for col in all_columns_lastw if col not in foreign_currency_products_cols]\n\nall_columns_lastm = list(result_df_lastm.columns)\ndomestic_columns_lastm = [col for col in all_columns_lastm if col not in foreign_currency_products_cols]\n\nall_columns_lasty = list(result_df_lasty.columns)\ndomestic_columns_lasty = [col for col in all_columns_lasty if col not in foreign_currency_products_cols]\n\n# ä½¿ç”¨åˆ—è¡¨è€Œä¸æ˜¯é›†åˆæ¥è®¡ç®—å›½å†…è´§å¸æ•°æ®\nresult_df_8_domestic_currency = result_df_8[domestic_columns_8].sum(axis=1)\nresult_df_lastw_domestic_currency = result_df_lastw[domestic_columns_lastw].sum(axis=1)\nresult_df_lastm_domestic_currency = result_df_lastm[domestic_columns_lastm].sum(axis=1)\nresult_df_lasty_domestic_currency = result_df_lasty[domestic_columns_lasty].sum(axis=1)\n\n# å°†å›½å†…è´§å¸çš„æ¯”è¾ƒæ•°æ®åˆå¹¶åˆ°æœ€ç»ˆç»“æœ\nresult_df_8_final = pd.concat([\n    result_df_8_final,\n    result_df_8_domestic_currency - result_df_lastw_domestic_currency,\n    result_df_8_domestic_currency - result_df_lastm_domestic_currency,\n    result_df_8_domestic_currency - result_df_lasty_domestic_currency\n], axis=1)\n\n# è®¾ç½®æœ€ç»ˆç»“æœçš„åˆ—å\nresult_df_8_final.columns = pd.MultiIndex.from_tuples(\n    tuple(result_df_8.columns) +\n    ((\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨'),\n     (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ'),\n     (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´'),\n     (\"\", \"\", 'ç›¸æ¯”ä¸Šå‘¨-ä¸å«å¤–å¸äº§å“'),\n     (\"\", \"\", 'ç›¸æ¯”ä¸Šæœˆ-ä¸å«å¤–å¸äº§å“'),\n     (\"\", \"\", 'ç›¸æ¯”ä¸Šå¹´-ä¸å«å¤–å¸äº§å“'))\n)\n\n# å°†ç»“æœå†™å…¥Excel\nresult_df_8_final.to_excel(writer, sheet_name='8.èµ„äº§å¤§è¡¨')\n\ndate = zhoubao_date\nzhongshou_m_path = os.path.join(Config.WEEKLY_DATA_DIR, f'ä¸­æ”¶åˆ†ææŠ¥è¡¨-äº§å“æ˜ç»†-{date}-m.xlsx')\nzhongshou_y_path = os.path.join(Config.WEEKLY_DATA_DIR, f'ä¸­æ”¶åˆ†ææŠ¥è¡¨-äº§å“æ˜ç»†-{date}-y.xlsx')\nzhongshou_m = pd.read_excel(zhongshou_m_path, index_col=0, skiprows=1)\nzhongshou_y = pd.read_excel(zhongshou_y_path, index_col=0, skiprows=1)\n# æ³¨ï¼šåˆäº«å’ŒBOFçš„é”€å”®ç®¡ç†è´¹=0.é¢å¤–åŠ ä¸Šæœ¬æœˆæ–°èµ·æ¯åˆäº«çš„ä»½é¢*é”€å”®ç®¡ç†è´¹*è¿ä½œå¤©æ•°/365\n\nclassification_df = pd.read_excel(\n    Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'),\n    sheet_name='å¤šèµ„äº§å“ç±»æ ‡ç­¾',\n    index_col='æ¯äº§å“ä»£ç '\n)\n# å»é‡é˜²æ­¢ç´¢å¼•é‡å¤å¯¼è‡´mergeæˆ–æ˜ å°„å¼‚å¸¸\nclassification_df = classification_df[~classification_df.index.duplicated(keep='first')]\nclassification_ye = classification_df[['å¤šèµ„äº§å“ç±»']]\n\n\ndef zhongshou_df_processing_v2(df_here, period_here: str):  # æ ¹æ®è®¡è´¢éƒ¨æ–°è°ƒæ•´çš„è¡¨æ ¼è®¡ç®—ã€‚å‰ç«¯æ”¶è´¹äº§å“ä¸ç”¨å†æ‰‹åŠ¨è°ƒæ•´ï¼Œ\n    # ä¾‹zhongshou_df_processing(zhongshou_m,'æœ¬æœˆ','2024-03')\n    fixed_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'æŠ•èµ„å›¢é˜Ÿ', 'å›¢é˜Ÿåˆ’åˆ†', 'äº§å“çº¿']\n    df_here.columns = fixed_cols + list(df_here.columns[5:])\n    df_here = df_here[df_here['å›¢é˜Ÿåˆ’åˆ†'] == '5.å¤šèµ„äº§æŠ•èµ„éƒ¨']\n    # å•ç‹¬æ‹‰å–é”€å”®ç®¡ç†è´¹å’ŒæŠ•èµ„ç®¡ç†è´¹ï¼Œæ–¹ä¾¿åé¢è°ƒæ•´è®¡ç®—ä¸­æ”¶\n    df_here.columns = [''.join(x.split('\\n')) for x in df_here.columns]\n    zhongshou_cols = ['é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰',\n                      'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']  # æ‰£å‡ä»£é”€ä¸­æ”¶\n    df_here = df_here[fixed_cols + zhongshou_cols]\n    # åˆ é™¤ä¸­æ”¶ä¸º0çš„è¡Œï¼Œæœ‰ä¸€äº›æ˜¯è€äº§å“æˆ–è€…æœªå‘è¡Œäº§å“\n    df_here = df_here[df_here['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰'].map(lambda x: x > 0.00001)]\n    # åŒ¹é…å“ç±»\n    df_here = df_here.merge(classification_ye, left_index=True, right_index=True, how='left')\n    df_here = del_Innovation_department(df_here)  # æ’å…¥.å»æ‰é‡åŒ–å’Œç»“æ„æ€§äº§å“ï¼Œå»æ‰åˆ›æ–°éƒ¨ç»ç†äº§å“,å…ˆä¸å»ï¼Œç›®å‰ç»Ÿä¸€è€ƒæ ¸\n    df_here = df_here.merge(Parent_sort, left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n    # æ±‡æ€»ç³»åˆ—ç»“æœ\n    mid_result = df_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).sum()[\n        ['ä¸­æ”¶ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'é”€å”®ç®¡ç†è´¹ï¼ˆæ‰£å‡ä»£é”€ï¼‰', 'æŠ•èµ„ç®¡ç†è´¹', 'è¶…é¢ç®¡ç†è´¹ï¼ˆä»£å®¢ç³»ç»Ÿï¼‰', 'å½“å¹´è¡Œå†…å‰ç«¯é”€å”®ç®¡ç†è´¹']]\n    mid_cols = [period_here + x for x in ['ä¸­æ”¶', 'é”€å”®ç®¡ç†è´¹', 'æŠ•èµ„ç®¡ç†è´¹(å«è¶…é¢)', 'è¶…é¢ç®¡ç†è´¹', 'å‰ç«¯æ”¶è´¹']]\n    mid_result.columns = mid_cols\n    return mid_result\n\n\nresult_9 = pd.concat([zhongshou_df_processing_v2(zhongshou_m, '-'.join([date[:4], date[4:6]])),\n                      zhongshou_df_processing_v2(zhongshou_y, date[:4])], axis=1)\nresult_9 = rank_by_sort(result_9, rank_here)\nresult_9.to_excel(writer, sheet_name='9.ä¸­æ”¶ç›‘æ§')\n\n\n# result_9.to_excel('test.xlsx',sheet_name='9.ä¸­æ”¶ç›‘æ§')\n\n# åˆ¤æ–­å“ç±»Indexæ˜¯å¦é½å…¨\ndef full_category_or_not(df_def, rank_def):\n    df_def = df_def.copy()\n    for x in rank_def:\n        if x not in df_def.index:\n            df_def.loc[x, :] = None\n    return df_def\n\n\ndate = zhoubao_date\nyunzuogailan_now = del_Innovation_department(pd.read_excel(\n    Config.get_overview_parent_file(date), index_col=0))\nyunzuogailan_now['åˆ°æœŸæœˆä»½'] = yunzuogailan_now['åˆ°æœŸæ—¥'].map(lambda x: x[:-3])\nParent_sort = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='é”€å”®æˆ˜æŠ¥ç³»åˆ—åˆ†ç±»', index_col=0)\nyunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n# ä»…çœ‹å‘¨æŠ¥ä¸‹å‘¨åçš„åˆ°æœŸæƒ…å†µ\nyunzuogailan_here = yunzuogailan_here[yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w]\nyunzuogailan_here_fengbi = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å°é—­']\nyunzuogailan_here_dingkai = yunzuogailan_here[yunzuogailan_here['å½¢æ€'] == 'å®šå¼€']\noutput_sheetname = ['10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ', '10.æœªæ¥å…¨å¹´äº§å“åˆ°æœŸæƒ…å†µ-å®šå¼€']\nk = 0\nfor yunzuogailan_here_to_cal in [yunzuogailan_here_fengbi, yunzuogailan_here_dingkai]:\n    result_df_10 = pd.pivot_table(yunzuogailan_here_to_cal, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='åˆ°æœŸæœˆä»½',\n                                  values=['å‡€èµ„äº§(äº¿)'], aggfunc=np.sum)  # æ•°æ®é€è§†\n    result_df_10 = rank_by_sort(full_category_or_not(result_df_10, rank_here), rank_here).T  # å¯¹åˆ†ç±»è¿›è¡Œæ’åº-å±•ç¤ºä¼˜åŒ–\n    result_df_10.index = result_df_10.loc['å‡€èµ„äº§(äº¿)'].index  # å¤šé‡indxç´¢å¼•è½¬æˆå•ç´¢å¼•float\n    result_df_10[[float(x[:4]) < 2029 for x in result_df_10.index]].to_excel(writer, sheet_name=output_sheetname[k])\n    k += 1\nkeep_cols = ['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'æ¯åˆ†ç±»', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©',\n             'å‰©ä½™å¤©', 'äº§å“ç»ç†',\n             'èµ·æ¯æ—¥', 'åˆ°æœŸæ—¥']\nresult_df_10_2 = yunzuogailan_here[\n    (yunzuogailan_here['åˆ°æœŸæ—¥'] <= closing_date_next_w) & (yunzuogailan_here['åˆ°æœŸæ—¥'] >= begin_date_next_w)][\n    keep_cols]\nresult_df_10_2.sort_values(by='åˆ°æœŸæ—¥', ascending=True, inplace=True)\nresult_df_10_2.to_excel(writer, sheet_name='10.ä¸‹å‘¨åˆ°æœŸäº§å“æ¸…å•')\n\nprint('ä¸‹å‘¨åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2['å‡€èµ„äº§(äº¿)'].sum()))\nprint('å°é—­åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum()))\nprint('å®šå¼€åˆè®¡åˆ°æœŸè§„æ¨¡{:.2f}äº¿å…ƒ'.format(result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()))\ndate = zhoubao_date\nexcel_name = 'æŒä»“ç›ˆäºæ˜ç»†åˆ—è¡¨_' + date + '.xlsx'\nChicang_df = pd.read_excel(os.path.join(Config.WEEKLY_DATA_DIR, excel_name))\nChicang_df.rename(columns={'èµ„äº§ç®€ç§°': 'å€ºåˆ¸ç®€ç§°'}, inplace=True)  ###æŒ‰ç…§è€çš„ç®€ç§°è®¡ç®—\nChicang_df.drop_duplicates(inplace=True)\n\n# å…´åˆç³»åˆ—\nWeiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()\nxinghe_list = Config.XINGHE_PRODUCTS  # éœ€è¦å±•ç¤ºçš„å…´åˆæ¸…å•ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰\nconcat_xinghe_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢\nfor i in range(len(xinghe_list)):\n    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'\n    concat_xinghe_series.append(pd.Series(\n        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n        name=xinghe_list[i] + '-é‡‘é¢'))\n\nconcat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)\nconcat_xinghe_df = concat_xinghe_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n                                          left_index=True, right_index=True, how='left')\nconcat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)\nconcat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]\nresult_df_11_1 = pd.concat(\n    [concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n     concat_xinghe_pct_df], axis=1)\nresult_df_11_1.to_excel(writer, sheet_name='11.å…´åˆäº§å“æŒä»“æ˜ç»†')\n\n# å¯è½¬å€ºä¸“æˆ·\nWeiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()\nconcat_zhuanzhai_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢\nzhuanzhai_dict = Config.CONVERTIBLE_BOND_ACCOUNTS  # å¯è½¬å€ºä¸“æˆ·ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰\n# æ‰‹å·¥å¢åŠ å¯è½¬å€ºä¸“æˆ·çš„é…ç½®æƒ…å†µ\nzhuanzhai_list = []\nfor shortname in zhuanzhai_dict.keys():\n    concat_zhuanzhai_series.append(pd.Series(\n        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')[\n            'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name=shortname + '-é‡‘é¢'))\n    zhuanzhai_list += [shortname]\n\n# æ‰‹å·¥å¢åŠ å¯è½¬å€ºåŸºé‡‘çš„é…ç½®æƒ…å†µï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰\nETF_bond_list = Config.CONVERTIBLE_BOND_ETF\nconcat_zhuanzhai_series.append(pd.Series(\n    Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')[\n        'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='å¯è½¬å€ºETF-é‡‘é¢'))\nzhuanzhai_list += ['å¯è½¬å€ºETF']\n\nconcat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)\nconcat_zhuanzhai_df = concat_zhuanzhai_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n                                                left_index=True, right_index=True, how='left')\nconcat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(\n    concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0)\nconcat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]\nresult_df_11_1_1 = pd.concat(\n    [concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n     concat_zhuanzhai_pct_df], axis=1)\nresult_df_11_1_1.to_excel(writer, sheet_name='11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†')\n# result_df_11_1_1.to_excel(Underlying_data_folder_path+'test2.xlsx',sheet_name='11.1 å¯è½¬å€ºä¸“æˆ·æŒä»“æ˜ç»†')\n\n# è¡¥å……å§”å¤–ä¸“æˆ·çš„æ ‡ç­¾\npublic_account_tag_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å§”å¤–å…¬å…±ç­–ç•¥ä¸“æˆ·æ ‡ç­¾',\n                                      index_col=0)\nWeiwai_df_full = Weiwai_df.merge(public_account_tag_df, left_on='å€ºåˆ¸ç®€ç§°', right_index=True, how='left')\n# è¡¥å……äº§å“çš„å“ç±»\nWeiwai_df_full = Weiwai_df_full.merge(yunzuogailan_now[['å¤šèµ„äº§å“ç±»']], left_on='äº§å“ä»£ç ', right_index=True,\n                                      how='left')\nWeiwai_df_full = Weiwai_df_full.merge(Parent_sort[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True,\n                                      how='left')\n\n# é‡åŒ–ç­–ç•¥ä¸“æˆ·å’Œå…´åˆ4çš„é…ç½®æƒ…å†µï¼ˆç»†åŒ–æ ‡ç­¾ï¼Œåœ¨config.pyä¸­é…ç½®ï¼‰\nconcat_quant_series = []\nquant_list = Config.QUANT_STRATEGY_LABELS\nconcat_quant_series.append(pd.Series(Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–ä¸­æ€§'].groupby('äº§å“ä»£ç ')[\n                                         'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é‡åŒ–ä¸­æ€§'))\nconcat_quant_series.append(pd.Series(Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–æŒ‡å¢'].groupby('äº§å“ä»£ç ')[\n                                         'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é‡åŒ–æŒ‡å¢'))\nconcat_quant_series.append(pd.Series(Weiwai_df_full[Weiwai_df_full['æ ‡ç­¾'] == 'é‡åŒ–CTA'].groupby('äº§å“ä»£ç ')[\n                                         'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é‡åŒ–CTA'))\nconcat_quant_series.append(pd.Series(\n    Weiwai_df_full[Weiwai_df_full['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-å…´åˆ4å·é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')[\n        'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='å…´åˆ4å·'))\nconcat_quant_df = pd.concat(concat_quant_series, axis=1)\nconcat_quant_df = concat_quant_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)']], left_index=True,\n                                        right_index=True, how='left')\nconcat_quant_pct_df = concat_quant_df[quant_list].div(concat_quant_df['å‡€èµ„äº§(äº¿)'], axis=0)\nconcat_quant_pct_df.columns = [x + '-å æ¯”' for x in quant_list]\nresult_df_11_3 = pd.concat([concat_quant_df[quant_list + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†']], concat_quant_pct_df], axis=1)\nresult_df_11_3.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)\nresult_df_11_3.to_excel(writer, sheet_name='11.2é‡åŒ–å’Œå¯è½¬å€ºæŒä»“æ˜ç»†')\n\n\n\n# è®¡ç®—æŒä»“çš„è§„æ¨¡åŠå æ¯”(å•ä¸ªç†è´¢äº§å“æŒä»“å äº§å“è§„æ¨¡çš„æ¯”-çš„å¹³å‡)\nresult_df_11_2_amt = pd.pivot_table(Weiwai_df_full, index=['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'], columns='æ ‡ç­¾',\n                                    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum) / 100000000  # æ•°æ®é€è§†\nyunzuogailan_here = yunzuogailan_now.merge(Parent_sort[['æ€»åˆ†ç±»']], left_on='å¤šèµ„äº§å“ç±»', right_index=True, how='left')\n# å æ¯”è®¡ç®—æ–¹å¼1ï¼šé™¤ä»¥ç³»åˆ—è§„æ¨¡\nresult_df_11_2_pct_2 = result_df_11_2_amt.div(yunzuogailan_here.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»'])['å‡€èµ„äº§(äº¿)'].sum(),\n                                              axis=0)\n# å æ¯”è®¡ç®—æ–¹å¼2ï¼šä¹‹å‰çš„ç™¾åˆ†æ¯”è®¡ç®—æ–¹å¼ä¸åˆç†ï¼Œä¹‹å‰æ˜¯å…¨éƒ¨ç†è´¢äº§å“æŒä»“/å…¨éƒ¨ç†è´¢äº§å“è§„æ¨¡ï¼Œå¾ˆå¤šç†è´¢äº§å“å¹¶æœªæŒæœ‰ä¸“æˆ·çš„ä¼šæ‘Šè–„æŒä»“æ¯”ä¾‹\nWeiwai_df_simplify = pd.pivot_table(Weiwai_df_full, index=['äº§å“ä»£ç '], columns='æ ‡ç­¾',\n                                    values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum) / 100000000  # æ•°æ®é€è§†\nWeiwai_df_simplify.columns = Weiwai_df_simplify['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].columns\nWeiwai_df_simplify = Weiwai_df_simplify.merge(yunzuogailan_here[['å‡€èµ„äº§(äº¿)']], left_index=True, right_index=True,\n                                              how='left')\nresult_df_11_2_pct = Weiwai_df_simplify.div(Weiwai_df_simplify['å‡€èµ„äº§(äº¿)'], axis=0).merge(\n    yunzuogailan_here[['æ¯åˆ†ç±»', 'æ€»åˆ†ç±»']], left_index=True, right_index=True, how='left')\nresult_df_11_2_pct = result_df_11_2_pct.groupby(['æ€»åˆ†ç±»', 'æ¯åˆ†ç±»']).mean()\nrank_by_sort(full_category_or_not(result_df_11_2_amt, rank_here), rank_here).to_excel(writer,\n                                                                                      sheet_name='11.2.1å…¶ä»–å§”å¤–ä¸“æˆ·é‡‘é¢é…ç½®æƒ…å†µ')\nrank_by_sort(full_category_or_not(result_df_11_2_pct, rank_here), rank_here).to_excel(writer,\n                                                                                      sheet_name='11.2.2å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ')\nrank_by_sort(full_category_or_not(result_df_11_2_pct_2, rank_here), rank_here).to_excel(writer,\n                                                                                        sheet_name='11.2.3å…¶ä»–å§”å¤–ä¸“æˆ·é…ç½®å æ¯”æƒ…å†µ-é™¤ä»¥ç³»åˆ—è§„æ¨¡')\n\n# å…¶ä»–è¡ç”Ÿå“æŒä»“æƒ…å†µ\nWeiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()\nxinghe_list = Config.XINGHE_PRODUCTS_2  # éœ€è¦å±•ç¤ºçš„å…´åˆæ¸…å•ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰\nconcat_xinghe_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢\nfor i in range(len(xinghe_list)):\n    ww_asset = 'å…´ä¸šæœŸè´§-' + xinghe_list[i] + 'é›†åˆèµ„äº§ç®¡ç†è®¡åˆ’'\n    concat_xinghe_series.append(pd.Series(\n        Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == ww_asset].groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000,\n        name=xinghe_list[i] + '-é‡‘é¢'))\n# æ‰‹å·¥å¢åŠ çµåŠ¨1å·çš„é…ç½®æƒ…å†µ\nconcat_xinghe_series.append(pd.Series(\n    Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == 'å…´ä¸šæœŸè´§-è´¢æ™ºäººç”ŸçµåŠ¨1å·å•ä¸€èµ„äº§ç®¡ç†è®¡åˆ’'].groupby('äº§å“ä»£ç ')[\n        'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='çµåŠ¨1å·-é‡‘é¢'))\nxinghe_list += ['çµåŠ¨1å·']\nconcat_xinghe_df = pd.concat(concat_xinghe_series, axis=1)\nconcat_xinghe_df = concat_xinghe_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n                                          left_index=True, right_index=True, how='left')\nconcat_xinghe_pct_df = concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list]].div(concat_xinghe_df['å‡€èµ„äº§(äº¿)'], axis=0)\nconcat_xinghe_pct_df.columns = [x + '-å æ¯”' for x in xinghe_list]\nresult_df_11_4 = pd.concat(\n    [concat_xinghe_df[[x + '-é‡‘é¢' for x in xinghe_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n     concat_xinghe_pct_df], axis=1)\nresult_df_11_4.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)  # å»æ‰åˆ›æ–°éƒ¨äº§å“\nresult_df_11_4.to_excel(writer, sheet_name='11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†')\n# result_df_11_4.to_excel(Underlying_data_folder_path+'test1.xlsx',sheet_name='11.4å…¶ä»–è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ˜ç»†')\n\n# æ±‡æ€»è¡ç”Ÿå“ä¸“æˆ·çš„é…ç½®æƒ…å†µ\nZhuanhu_label_df = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å§”å¤–å…¬å…±ç­–ç•¥ä¸“æˆ·æ ‡ç­¾',\n                                 index_col=0)\nderivative_zhuanhu_list = list(Zhuanhu_label_df[Zhuanhu_label_df['æ ‡ç­¾'] == 'è¡ç”Ÿå“ä¸“æˆ·'].index)\nderivative_zhuanhu_df = Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'].map(lambda x: x in derivative_zhuanhu_list)]\n# è·å–è¡ç”Ÿå“æŒä»“æ˜ç»†\nderivative_zhuanhu_df = pd.pivot_table(derivative_zhuanhu_df, index=['äº§å“ä»£ç '], columns='å€ºåˆ¸ç®€ç§°',\n                                       values=['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'], aggfunc=np.sum)\nderivative_zhuanhu_df.columns = [x[1][5:-8] for x in derivative_zhuanhu_df.columns]\nderivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'] = derivative_zhuanhu_df.sum(axis=1)  # æ±‡æ€»è¡ç”Ÿå“æŒä»“é‡‘é¢\nderivative_zhuanhu_df = derivative_zhuanhu_df.merge(\n    yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True,\n    how='left')\nderivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“æ¯”ä¾‹'] = derivative_zhuanhu_df['è¡ç”Ÿå“ä¸“æˆ·æŒä»“'].div(\n    derivative_zhuanhu_df['å‡€èµ„äº§(äº¿)'], axis=0) / 100000000\nderivative_zhuanhu_df.dropna(subset=['äº§å“ç®€ç§°', 'äº§å“ç»ç†'], inplace=True)  # å»æ‰åˆ›æ–°éƒ¨äº§å“\nderivative_zhuanhu_df.to_excel(writer, sheet_name='11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”')\n# derivative_zhuanhu_df.to_excel(Underlying_data_folder_path+'test2.xlsx',sheet_name='11.5å…¨éƒ¨è¡ç”Ÿå“ä¸“æˆ·æŒä»“å æ¯”')\n\n# éæ ‡æŒä»“æ˜ç»†\nfeibiao_df = Chicang_df[Chicang_df.apply(\n    lambda x: (x['æ–°ç‰ˆèµ„äº§å¤§ç±»'] in ['éæ ‡å‡†åŒ–å€ºæƒç±»èµ„äº§', 'ç†è´¢ç›´æ¥èèµ„å·¥å…·', 'æ–°å¢å¯æŠ•èµ„èµ„äº§']) or (\n                x['æ–°ç‰ˆèµ„äº§å°ç±»'] in ['åŒä¸šå€Ÿæ¬¾']), axis=1)]\nfeibiao_pct_df = pd.DataFrame(feibiao_df.groupby('äº§å“ä»£ç ')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum())\nfeibiao_pct_df = feibiao_pct_df.merge(yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']],\n                                      left_index=True, right_index=True, how='left')\nfeibiao_pct_df['éæ ‡å æ¯”'] = feibiao_pct_df['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'] / feibiao_pct_df['å‡€èµ„äº§(äº¿)'] / 100000000\nfeibiao_pct_df.to_excel(writer, sheet_name='11.6éæ ‡æŒä»“å æ¯”')\n# feibiao_pct_df.to_excel('test.xlsx',sheet_name='11.6éæ ‡æŒä»“å æ¯”')\n\n\n# é»„é‡‘ä¸“æˆ·é…ç½®ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰\ngold_dict = Config.GOLD_ACCOUNTS\ngold_ETF_bond_list = Config.GOLD_ETF\n\n\n\n#['åå®‰æ˜“å¯Œé»„é‡‘äº¤æ˜“å‹å¼€æ”¾å¼è¯åˆ¸æŠ•èµ„åŸºé‡‘']\n\n# æƒç›Šä¸“æˆ·é…ç½®ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰\nequity_dict = Config.EQUITY_ACCOUNTS\n\ndef get_zhdata(zhuanzhai_dict, ETF_bond_list):\n    # å¯è½¬å€ºä¸“æˆ·\n    Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()\n    concat_zhuanzhai_series = []  # åˆå¹¶çš„å…´åˆæŒä»“é‡‘é¢\n    # æ‰‹å·¥å¢åŠ å¯è½¬å€ºä¸“æˆ·çš„é…ç½®æƒ…å†µ\n    zhuanzhai_list = []\n    for shortname in zhuanzhai_dict.keys():\n        concat_zhuanzhai_series.append(pd.Series(\n            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == zhuanzhai_dict[shortname]].groupby('äº§å“ä»£ç ')[\n                'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name=shortname + '-é‡‘é¢'))\n        zhuanzhai_list += [shortname]\n    # æ‰‹å·¥å¢åŠ å¯è½¬å€ºåŸºé‡‘çš„é…ç½®æƒ…å†µ\n    concat_zhuanzhai_series.append(pd.Series(\n        Chicang_df[Chicang_df['å€ºåˆ¸ç®€ç§°'].apply(lambda x: x in ETF_bond_list)].groupby('äº§å“ä»£ç ')[\n            'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name='é»„é‡‘ETF-é‡‘é¢'))\n    zhuanzhai_list += ['é»„é‡‘ETF']\n    concat_zhuanzhai_df = pd.concat(concat_zhuanzhai_series, axis=1)\n    concat_zhuanzhai_df = concat_zhuanzhai_df.merge(\n        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True,\n        how='left')\n    concat_zhuanzhai_pct_df = concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list]].div(\n        concat_zhuanzhai_df['å‡€èµ„äº§(äº¿)'], axis=0)\n    concat_zhuanzhai_pct_df.columns = [x + '-å æ¯”' for x in zhuanzhai_list]\n    result_df_11_1_1 = pd.concat(\n        [concat_zhuanzhai_df[[x + '-é‡‘é¢' for x in zhuanzhai_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n         concat_zhuanzhai_pct_df], axis=1)\n    return result_df_11_1_1\n\ndef get_equity_data(equity_dict):\n    # æƒç›Šä¸“æˆ·\n    Weiwai_df = Chicang_df[Chicang_df['æ–°ç‰ˆèµ„äº§å¤§ç±»'] == 'å§”å¤–æŠ•èµ„'].copy()\n    concat_equity_series = []  # åˆå¹¶çš„æƒç›Šä¸“æˆ·æŒä»“é‡‘é¢\n    equity_list = []\n    \n    # æ‰‹å·¥å¢åŠ æƒç›Šä¸“æˆ·çš„é…ç½®æƒ…å†µ\n    for shortname in equity_dict.keys():\n        concat_equity_series.append(pd.Series(\n            Weiwai_df[Weiwai_df['å€ºåˆ¸ç®€ç§°'] == equity_dict[shortname]].groupby('äº§å“ä»£ç ')[\n                'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum() / 100000000, name=shortname + '-é‡‘é¢'))\n        equity_list += [shortname]\n    \n    # åˆå¹¶æ•°æ®\n    concat_equity_df = pd.concat(concat_equity_series, axis=1)\n    concat_equity_df = concat_equity_df.merge(\n        yunzuogailan_now[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å‡€èµ„äº§(äº¿)', 'å¤šèµ„äº§å“ç±»']], left_index=True, right_index=True,\n        how='left')\n    \n    # è®¡ç®—å æ¯”\n    concat_equity_pct_df = concat_equity_df[[x + '-é‡‘é¢' for x in equity_list]].div(\n        concat_equity_df['å‡€èµ„äº§(äº¿)'], axis=0)\n    concat_equity_pct_df.columns = [x + '-å æ¯”' for x in equity_list]\n    \n    # åˆå¹¶ç»“æœ\n    result_df = pd.concat(\n        [concat_equity_df[[x + '-é‡‘é¢' for x in equity_list] + ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»']],\n         concat_equity_pct_df], axis=1)\n    return result_df\n# ç”Ÿæˆé»„é‡‘æŒä»“æ•°æ®\nhg_asset = get_zhdata(gold_dict, gold_ETF_bond_list)\nhg_asset[['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-é‡‘é¢', 'é»„é‡‘ETF-é‡‘é¢', 'å…´ä¸šæœŸè´§é»„é‡‘å¢å¼º1å·-å æ¯”',\n          'é»„é‡‘ETF-å æ¯”']].to_excel(writer, sheet_name='é»„é‡‘æŒä»“')\n\n# ç”Ÿæˆæƒç›Šä¸“æˆ·æŒä»“æ•°æ®\nequity_asset = get_equity_data(equity_dict)\noutput_cols = ['äº§å“ç®€ç§°', 'äº§å“ç»ç†', 'å¤šèµ„äº§å“ç±»'] + \\\n             [x + suffix for x in equity_dict.keys() for suffix in ['-é‡‘é¢', '-å æ¯”']]\nequity_asset[output_cols].to_excel(writer, sheet_name='æƒç›Šä¸“æˆ·æŒä»“')\n\n# ç”Ÿæˆå…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ\n# è¯»å–å…¬å…±ç­–ç•¥æ•°æ®\nggcc = pd.read_excel(Config.get_base_data_file('åº•å±‚æ•°æ®æ±‡æ€».xlsx'), sheet_name='å…¬å¸å…¬å…±ç­–ç•¥ä¸“æˆ·')\nwwgl = pd.read_excel(Config.get_weekly_data_file('å§”å¤–äº§å“æ¦‚è§ˆ(å›¢é˜Ÿè§†è§’)'))[['å§”å¤–èµ„äº§','æœ€æ–°è§„æ¨¡']]\n\n# è®¡ç®—æŒä»“æ±‡æ€»\nchicangsum = Chicang_df.groupby('å€ºåˆ¸ç®€ç§°')['æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼'].sum()/100000000\n\n# åˆå¹¶æ•°æ®\nggcc = pd.merge(ggcc, wwgl, left_on='èµ„äº§åç§°', right_on='å§”å¤–èµ„äº§', how='left')\nggcc = pd.merge(ggcc, chicangsum, left_on='èµ„äº§åç§°', right_index=True, how='left')\n\n# é‡å‘½ååˆ—å¹¶è®¡ç®—å æ¯”\nggcc = ggcc.rename(columns={'æ—¥ç»ˆå¸‚å€¼(å…ƒ)-äº§å“æ³•ä¼°å€¼':'å¤šèµ„äº§æŠ•æŒä»“-äº¿', \"æœ€æ–°è§„æ¨¡\":'ä¸“æˆ·è§„æ¨¡'})\nggcc['å¤šèµ„äº§æŒä»“å æ¯”'] = ggcc['å¤šèµ„äº§æŠ•æŒä»“-äº¿']/ggcc['ä¸“æˆ·è§„æ¨¡']\n\n# è¾“å‡ºç»“æœ\nggcc[['æ‰€å±éƒ¨é—¨', 'ç­–ç•¥æ ‡ç­¾', 'èµ„äº§ä»£ç ', 'èµ„äº§åç§°', 'èµ„äº§ç®€ç§°', 'ä¸“æˆ·è§„æ¨¡', \n      'å¤šèµ„äº§æŠ•æŒä»“-äº¿', 'å¤šèµ„äº§æŒä»“å æ¯”']].to_excel(writer, sheet_name='å…¬å…±ç­–ç•¥æŒä»“æ¦‚å†µ')\n\n          \ndate = zhoubao_date\nyunzuogailan_now = del_Innovation_department(pd.read_excel(\n    Config.get_overview_parent_file(date), index_col=0))\npart_nav_df = data_transposition.loc[:, yunzuogailan_now.index].tail(7 + 1)  # å‘¨å‡€å€¼å˜åŒ–\n# å‘¨å†…æ—¥å‡€å€¼å˜åŒ–å¹³å‡\nrweek = pd.DataFrame((part_nav_df.tail(1).values / part_nav_df.head(1).values - 1) * 10000, columns=part_nav_df.columns,\n                     index=['å‘¨å‡€å€¼å˜åŒ–bp']).T\nrweek_average = ((part_nav_df / part_nav_df.shift(1) - 1) * 10000).mean(axis=0)\nnav_change_df = pd.concat([rweek, rweek_average], axis=1)\nnav_change_df.columns = ['å‘¨å‡€å€¼å˜åŒ–bp', 'å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']\nnav_change_df_keep = nav_change_df[\n    (abs(nav_change_df['å‘¨å‡€å€¼å˜åŒ–bp']) >= 20) | (abs(nav_change_df['å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp']) >= 3)]  # ç­›é€‰æ ‡å‡†\n# nav_change_df.iplot()\n\n\nresult_df_12 = nav_change_df_keep.merge(\n    yunzuogailan_now[['äº§å“ç®€ç§°', 'å‡€èµ„äº§(äº¿)', 'å½¢æ€', 'å¤šèµ„äº§å“ç±»', 'å•ä½å‡€å€¼', 'ç´¯è®¡å¹´åŒ–', 'æ æ†', 'ç»„åˆä¹…æœŸ',\n                      'ç»„åˆé™æ€', 'æƒç›Šä»“ä½', 'æœ¬æœŸå¹´åŒ–', 'ä¸šç»©åŸºå‡†', 'è¿ä½œå¤©', 'å‰©ä½™å¤©', 'äº§å“ç»ç†', 'èµ·æ¯æ—¥',\n                      'åˆ°æœŸæ—¥']], left_index=True, right_index=True, how='left')\nresult_df_12.sort_values('å‘¨å†…æ—¥å‡å‡€å€¼å˜åŒ–bp', ascending=True, inplace=True)  # åº•è¡¨æŒ‰ç…§å‡€å€¼æ³¢åŠ¨\nresult_df_12.to_excel(writer, sheet_name='12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•')\n# result_df_12.to_excel('test.xlsx',sheet_name='12.å‘¨å‡€å€¼é«˜æ³¢åŠ¨äº§å“æ¸…å•')\n\nnow = zhoubao_date\n# lastm='20250228'\n# lasty='20241231'\n\n# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\nyunzuogailan_lastm = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lastm), index_col=0))\nyunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n\n\ndef get_zhouqi_scale(x):\n    if x < 30 * 7:\n        return '<6M'\n    elif (x >= 30 * 7) and (x < 13 * 30):\n        return '6M-1Y'\n    elif x >= 13 * 30:\n        return '>1Y'\n    else:\n        return 'error'\n\n\ndef get_zhouqi_scale_df(df_f, name: str):\n    mid_df = df_f.copy()\n    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)\n    result_df = pd.concat([mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].sum(),\n                           mid_df.groupby(['å‘¨æœŸåŒºé—´', 'å½¢æ€'])['å‡€èµ„äº§(äº¿)'].count()], axis=1)\n    result_df.columns = [name + x for x in ['è§„æ¨¡(äº¿)', 'æ•°é‡']]\n    return result_df\n\n\nfinal_df = pd.concat([get_zhouqi_scale_df(yunzuogailan_lasty, '2024'), get_zhouqi_scale_df(yunzuogailan_now, 'æœ€æ–°')],\n                     axis=1)\nfinal_df['vlookupæ ‡ç­¾'] = [''.join(list(x)) for x in final_df.index]\nkeep_columns = ['vlookupæ ‡ç­¾'] + list(final_df.columns[:-1])\n\n# final_df[keep_columns].to_excel('test3.xlsx',sheet_name='13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡')\nfinal_df[keep_columns].to_excel(writer, sheet_name='13.ä¸åŒå‘¨æœŸäº§å“è§„æ¨¡')\n\nnow = zhoubao_date\nmonth7 = '20240731'\nlasty = '20241231'\n\n# è·å–å„åˆ†ç±»çš„äº§å“è§„æ¨¡å’Œæ¬¾æ•°\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\nyunzuogailan_month7 = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(month7), index_col=0))\nyunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n\nyunzuogailan_now = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(now), index_col=0))\nyunzuogailan_month7 = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(month7), index_col=0))\nyunzuogailan_lasty = del_Innovation_department(pd.read_excel(Config.get_overview_parent_file(lasty), index_col=0))\n\n\ndef match_kehuzhouqi_narrowed(x: str):\n    if x == 'å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“':\n        return 'å®¢æˆ·å‘¨æœŸ'\n    elif x == 'å®¢æˆ·é”å®šæœŸ':\n        return 'æœ€çŸ­æŒæœ‰æœŸ'\n    else:\n        return ''\n\n\ndef get_kehuzhouqi_narrowed_scale(my_df, col_str: str):\n    # col_str='2023å¹´åº•'\n    mid_df = my_df[my_df['äº§å“æ¨¡æ¿ä¸­æ–‡åç§°'].map(lambda x: x in ['å®¢æˆ·å¤šå‘¨æœŸå€ºåŸºå‡€å€¼å‹äº§å“', 'å®¢æˆ·é”å®šæœŸ'])]\n    mid_df['å‘¨æœŸåŒºé—´'] = mid_df['å‘¨æœŸå¤©æ•°'].map(get_zhouqi_scale)\n    result_df = pd.pivot_table(mid_df, index=['å‘¨æœŸåŒºé—´'], columns='äº§å“æ¨¡æ¿ä¸­æ–‡åç§°', values=['å‡€èµ„äº§(äº¿)'],\n                               aggfunc=np.sum)  # ä¸€ç»´å˜äºŒç»´\n    result_df.columns = [col_str + match_kehuzhouqi_narrowed(x[1]) for x in list(result_df.columns)]\n    return result_df\n\n\nresult_df_14 = pd.concat([get_kehuzhouqi_narrowed_scale(yunzuogailan_lasty, '2024å¹´åº•'),\n                          get_kehuzhouqi_narrowed_scale(yunzuogailan_month7, '2024å¹´7æœˆ'),\n                          get_kehuzhouqi_narrowed_scale(yunzuogailan_now, 'æœ€æ–°')], axis=1)\n# result_df_14.to_excel('test.xlsx',sheet_name='14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª')\nresult_df_14.to_excel(writer, sheet_name='14.ç‹­ä¹‰å®¢æˆ·å‘¨æœŸå’Œæœ€çŸ­æŒæœ‰æœŸçš„äº§å“è§„æ¨¡è·Ÿè¸ª')\nwind_code_list = Config.MARKET_INDEX_CODES  # å¸‚åœºæŒ‡æ•°ä»£ç ï¼ˆåœ¨config.pyä¸­é…ç½®ï¼‰\nresult_list = []\nfor deltadays in [30, 30 * 3, 30 * 6, 365]:\n    startDate = ''.join(\n        str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=deltadays)).date()).split(\n            '-'))\n    returns = market_data.get_index_returns(wind_code_list, startDate, zhoubao_date)\n    result_list.append(np.array(returns) * 365 / deltadays)\n# è®¡ç®—2026å¹´å¹´åŒ–æ”¶ç›Šï¼ˆæ¯å¹´éœ€æ›´æ–°å¹´æœ«æ—¥æœŸï¼‰\ndeltadays = (datetime.strptime(zhoubao_date, '%Y%m%d') - datetime.strptime('20251231', '%Y%m%d')).days\nreturns = market_data.get_index_returns(wind_code_list, '20251231', zhoubao_date)\nresult_list.append(np.array(returns) * 365 / deltadays)\n\n# è®¡ç®—è¿‘1æœˆæ³¢åŠ¨ç‡\nstart_1m = ''.join(str((datetime.strptime(zhoubao_date, '%Y%m%d') - timedelta(days=30)).date()).split('-'))\nvol_1m = market_data.get_index_volatility(wind_code_list, start_1m, zhoubao_date)\nresult_list.append(np.array(vol_1m) if vol_1m else np.array([None] * len(wind_code_list)))\n\n# è®¡ç®—ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡\nvol_ytd = market_data.get_index_volatility(wind_code_list, '20251231', zhoubao_date)\nresult_list.append(np.array(vol_ytd) if vol_ytd else np.array([None] * len(wind_code_list)))\n\nresult_list.append(np.array(market_data.get_index_names(wind_code_list)))\nresult_df = pd.DataFrame(result_list).T\nresult_df.index = wind_code_list\nresult_df.columns = ['è¿‘1æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘3æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘6æœˆå¹´åŒ–æ”¶ç›Šç‡', 'è¿‘1å¹´å¹´åŒ–æ”¶ç›Šç‡', '2026å¹´å¹´åŒ–æ”¶ç›Šç‡',\n                     'è¿‘1æœˆæ³¢åŠ¨ç‡', 'ä»Šå¹´ä»¥æ¥æ³¢åŠ¨ç‡', 'æŒ‡æ•°ç®€ç§°']\n# result_df.to_excel('test.xlsx',sheet_name='15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š')\nresult_df.to_excel(writer, sheet_name='15.å¸‚åœºæŒ‡æ•°æ”¶ç›Š')\n\nnav_date = yunzuogailan_date\nyunzuogailan_now = del_Innovation_department(\n    pd.read_excel(Config.get_overview_parent_file(yunzuogailan_date), index_col=0))\nyunzuogailan_now['ç´¯ç§¯å‡€å€¼'] = [data_transposition.loc[nav_date, x] for x in yunzuogailan_now.index]\nyunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] = [data_transposition.loc[pd.to_datetime(nav_date) - timedelta(7), x] for x in\n                                     yunzuogailan_now.index]\nyunzuogailan_now['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] = [\n    data_transposition.loc[pd.to_datetime(nav_date) - timedelta(int(nav_date[-2:])), x] for x in yunzuogailan_now.index]\npojing_df = yunzuogailan_now[yunzuogailan_now['ç´¯ç§¯å‡€å€¼'] < 1].copy()\n\npojing_df['è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šå‘¨'] - 1\npojing_df['è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–'] = pojing_df['ç´¯ç§¯å‡€å€¼'] / pojing_df['ç´¯ç§¯å‡€å€¼-ä¸Šæœˆæœ«'] - 1\npojing_df['æ£€æµ‹æ—¶ç‚¹'] = nav_date\npojing_df['äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰'] = pojing_df['å‡€èµ„äº§(äº¿)'] / pojing_df['å•ä½å‡€å€¼']\npojing_df = pojing_df.reset_index()\npojing_df_final = pojing_df[\n    ['æ£€æµ‹æ—¶ç‚¹', 'äº§å“ç®€ç§°', 'äº§å“ä»£ç ', 'äº§å“ç»ç†', 'äº§å“ä»½é¢ï¼ˆäº¿ä»½ï¼‰', 'åˆ°æœŸæ—¥', 'ç´¯ç§¯å‡€å€¼', 'è¾ƒä¸Šå‘¨å‡€å€¼å˜åŒ–',\n     'è¾ƒä¸Šæœˆæœ«å‡€å€¼å˜åŒ–']]\nquant = ['ç‹æµ©', 'å¼ é›…å©•', 'å­™æ–°å']\n\n\ndef manager_in_or_not(s: str, y: list):\n    sum_here = 0\n    for mid_y in y:\n        if mid_y in s:\n            sum_here += 1\n    if sum_here > 0:\n        return 1\n    else:\n        return 0\n\n\npojing_df_final = pojing_df_final[pojing_df_final['äº§å“ç»ç†'].map(lambda x: manager_in_or_not(x, quant)) == 0]\npojing_df_final.to_excel(writer, sheet_name='ç ´å‡€ç»“æœ')\n\n\n\n# ä½¿ç”¨configä¸­çš„promptæ¨¡æ¿ç”Ÿæˆæ€»ç»“æ–‡å­—ï¼ˆæ¨¡æ¿åœ¨config.pyä¸­é…ç½®ï¼Œæ–¹ä¾¿è°ƒæ•´ï¼‰\nprompt_zs = Config.PROMPT_ZHONGSHOU.format(\n    date=yunzuogailan_date,\n    data=round(result_9.sum(axis=0), 2)\n)\n\nprompt_gm = Config.PROMPT_GUIMO.format(\n    date=yunzuogailan_date,\n    channel_data=round(Channel_result1.sum(axis=0), 0),\n    series_data=round(result_3.astype(float).sum(axis=0), 0)\n)\n\ndaoqi_summary = Config.PROMPT_DAOQI.format(\n    total=result_df_10_2['å‡€èµ„äº§(äº¿)'].sum(),\n    fengbi=result_df_10_2[result_df_10_2['å½¢æ€'] == 'å°é—­']['å‡€èµ„äº§(äº¿)'].sum(),\n    dingkai=result_df_10_2[result_df_10_2['å½¢æ€'] == 'å®šå¼€']['å‡€èµ„äº§(äº¿)'].sum()\n)\n\nguimo_summary = get_wenzi_result(prompt_gm)\nzhongshou_summary = get_wenzi_result(prompt_zs)\nchan\nwenzi = {'åˆ°æœŸæ–‡å­—':daoqi_summary,'ä¸­æ”¶æ–‡å­—':zhongshou_summary,'è§„æ¨¡æ–‡å­—':guimo_summary}\nwenzidf = pd.DataFrame([wenzi]).T.rename(columns={0:'æ–‡å­—'})\nwenzidf.to_excel(writer, sheet_name='æ€»ç»“æ–‡å­—')\n\nwriter.close()\n"},"sourceToolAssistantUUID":"27564b51-d7ec-4f54-8fdf-41a88f95635a"}
{"parentUuid":"00b512bd-3d2f-4596-85c7-54a38782f8e6","isSidechain":true,"userType":"external","cwd":"/Users/fanshengxia/Desktop/å‘¨æŠ¥V2","sessionId":"a96899d2-c486-4098-b83a-860801cf2206","version":"2.1.31","gitBranch":"main","agentId":"acompact-6ace98","slug":"sprightly-roaming-patterson","type":"user","message":{"role":"user","content":"Your task is to create a detailed summary of the conversation so far, paying close attention to the user's explicit requests and your previous actions.\nThis summary should be thorough in capturing technical details, code patterns, and architectural decisions that would be essential for continuing development work without losing context.\n\nBefore providing your final summary, wrap your analysis in <analysis> tags to organize your thoughts and ensure you've covered all necessary points. In your analysis process:\n\n1. Chronologically analyze each message and section of the conversation. For each section thoroughly identify:\n   - The user's explicit requests and intents\n   - Your approach to addressing the user's requests\n   - Key decisions, technical concepts and code patterns\n   - Specific details like:\n     - file names\n     - full code snippets\n     - function signatures\n     - file edits\n  - Errors that you ran into and how you fixed them\n  - Pay special attention to specific user feedback that you received, especially if the user told you to do something differently.\n2. Double-check for technical accuracy and completeness, addressing each required element thoroughly.\n\nYour summary should include the following sections:\n\n1. Primary Request and Intent: Capture all of the user's explicit requests and intents in detail\n2. Key Technical Concepts: List all important technical concepts, technologies, and frameworks discussed.\n3. Files and Code Sections: Enumerate specific files and code sections examined, modified, or created. Pay special attention to the most recent messages and include full code snippets where applicable and include a summary of why this file read or edit is important.\n4. Errors and fixes: List all errors that you ran into, and how you fixed them. Pay special attention to specific user feedback that you received, especially if the user told you to do something differently.\n5. Problem Solving: Document problems solved and any ongoing troubleshooting efforts.\n6. All user messages: List ALL user messages that are not tool results. These are critical for understanding the users' feedback and changing intent.\n6. Pending Tasks: Outline any pending tasks that you have explicitly been asked to work on.\n7. Current Work: Describe in detail precisely what was being worked on immediately before this summary request, paying special attention to the most recent messages from both user and assistant. Include file names and code snippets where applicable.\n8. Optional Next Step: List the next step that you will take that is related to the most recent work you were doing. IMPORTANT: ensure that this step is DIRECTLY in line with the user's most recent explicit requests, and the task you were working on immediately before this summary request. If your last task was concluded, then only list next steps if they are explicitly in line with the users request. Do not start on tangential requests or really old requests that were already completed without confirming with the user first.\n                       If there is a next step, include direct quotes from the most recent conversation showing exactly what task you were working on and where you left off. This should be verbatim to ensure there's no drift in task interpretation.\n\nHere's an example of how your output should be structured:\n\n<example>\n<analysis>\n[Your thought process, ensuring all points are covered thoroughly and accurately]\n</analysis>\n\n<summary>\n1. Primary Request and Intent:\n   [Detailed description]\n\n2. Key Technical Concepts:\n   - [Concept 1]\n   - [Concept 2]\n   - [...]\n\n3. Files and Code Sections:\n   - [File Name 1]\n      - [Summary of why this file is important]\n      - [Summary of the changes made to this file, if any]\n      - [Important Code Snippet]\n   - [File Name 2]\n      - [Important Code Snippet]\n   - [...]\n\n4. Errors and fixes:\n    - [Detailed description of error 1]:\n      - [How you fixed the error]\n      - [User feedback on the error if any]\n    - [...]\n\n5. Problem Solving:\n   [Description of solved problems and ongoing troubleshooting]\n\n6. All user messages: \n    - [Detailed non tool use user message]\n    - [...]\n\n7. Pending Tasks:\n   - [Task 1]\n   - [Task 2]\n   - [...]\n\n8. Current Work:\n   [Precise description of current work]\n\n9. Optional Next Step:\n   [Optional Next step to take]\n\n</summary>\n</example>\n\nPlease provide your summary based on the conversation so far, following this structure and ensuring precision and thoroughness in your response. \n\nThere may be additional summarization instructions provided in the included context. If so, remember to follow these instructions when creating the above summary. Examples of instructions include:\n<example>\n## Compact Instructions\nWhen summarizing the conversation focus on typescript code changes and also remember the mistakes you made and how you fixed them.\n</example>\n\n<example>\n# Summary instructions\nWhen you are using compact - please focus on test output and code changes. Include file reads verbatim.\n</example>\n\n\nIMPORTANT: Do NOT use any tools. You MUST respond with ONLY the <summary>...</summary> block as your text output."},"uuid":"f5bbb763-1962-45f1-9b00-5f446b537f18","timestamp":"2026-02-04T09:50:28.954Z"}
{"parentUuid":"f5bbb763-1962-45f1-9b00-5f446b537f18","isSidechain":true,"userType":"external","cwd":"/Users/fanshengxia/Desktop/å‘¨æŠ¥V2","sessionId":"a96899d2-c486-4098-b83a-860801cf2206","version":"2.1.31","gitBranch":"main","agentId":"acompact-6ace98","slug":"sprightly-roaming-patterson","type":"assistant","uuid":"936cd691-2dcd-4e27-8d43-9157673d2349","timestamp":"2026-02-04T09:50:39.339Z","message":{"id":"9e77dccb-6c2c-448a-8a24-a05a257fd359","container":null,"model":"<synthetic>","role":"assistant","stop_reason":"stop_sequence","stop_sequence":"","type":"message","usage":{"input_tokens":0,"output_tokens":0,"cache_creation_input_tokens":0,"cache_read_input_tokens":0,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":null,"cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":0}},"content":[{"type":"text","text":"Prompt is too long"}],"context_management":null},"error":"invalid_request","isApiErrorMessage":true}
